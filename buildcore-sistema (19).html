<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuildCore â€” Sistema de GestiÃ³n</title>
<!-- PWA -->
<meta name="theme-color" content="#0d0f12">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="BuildCore">
<link rel="manifest" id="pwa-manifest">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f12; --bg2:#13161b; --bg3:#1a1e26; --bg4:#20252f;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.12);
  --accent:#f5a623; --accent2:#e8521a;
  --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --purple:#a855f7;
  --text:#f1f5f9; --muted:#64748b; --muted2:#94a3b8;
  --sidebar-w:260px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* ===== LOGIN ===== */
#login-screen{
  position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;
  z-index:999;
}
.login-bg{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 20% 50%,rgba(245,166,35,0.08) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 20%,rgba(232,82,26,0.06) 0%,transparent 50%);
}
.login-grid{
  position:absolute;inset:0;opacity:0.03;
  background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:40px 40px;
}
.login-card{
  background:var(--bg2);border:1px solid var(--border2);border-radius:20px;
  padding:44px 40px;width:420px;position:relative;z-index:1;
  box-shadow:0 32px 80px rgba(0,0,0,0.6);
  animation:cardIn 0.5s cubic-bezier(.16,1,.3,1);
}
@keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(0.97);}to{opacity:1;transform:none;}}
.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;justify-content:center;}
.login-logo-icon{
  width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;
  box-shadow:0 8px 24px rgba(245,166,35,0.3);
}
.login-logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;}
.login-logo-text span{color:var(--accent);}
.login-subtitle{text-align:center;color:var(--muted);font-size:13px;margin-bottom:28px;}
.login-label{font-size:11px;font-weight:700;letter-spacing:1px;color:var(--muted2);text-transform:uppercase;margin-bottom:6px;display:block;}
.login-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);
  padding:12px 14px;border-radius:10px;font-size:14px;font-family:'DM Sans',sans-serif;
  outline:none;transition:border-color 0.2s,box-shadow 0.2s;margin-bottom:14px;
}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,166,35,0.1);}
.login-input::placeholder{color:var(--muted);}
.login-btn{
  width:100%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;
  border:none;padding:13px;border-radius:10px;font-size:14px;font-weight:700;
  font-family:'Syne',sans-serif;cursor:pointer;transition:all 0.2s;margin-top:6px;
  letter-spacing:0.3px;
}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(245,166,35,0.3);}
.login-btn:active{transform:none;}
.login-error{
  background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);
  color:var(--red);padding:10px 14px;border-radius:8px;font-size:13px;
  margin-bottom:14px;display:none;
}
.login-hint{text-align:center;color:var(--muted);font-size:12px;margin-top:16px;}
.login-hint b{color:var(--muted2);}

/* ===== LAYOUT ===== */
#app{display:none;}
#app.visible{display:flex;}
.sidebar{
  width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;overflow-y:auto;
}
.sidebar-logo{padding:20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;}
.logo-text span{color:var(--accent);}
.nav-section{padding:14px 10px 6px;}
.nav-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;padding:0 8px;margin-bottom:6px;}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;
  cursor:pointer;color:var(--muted2);font-size:13px;font-weight:500;transition:all 0.15s;
  margin-bottom:2px;position:relative;
}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(245,166,35,0.12);color:var(--accent);}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 3px 3px 0;}
.alerta-filter.active{background:rgba(245,166,35,0.15);color:var(--accent);border-color:var(--accent);}
.nav-item svg{width:17px;height:17px;flex-shrink:0;}
.badge{margin-left:auto;background:var(--accent2);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:20px;}
.badge.green{background:rgba(34,197,94,0.2);color:var(--green);}
.sidebar-bottom{margin-top:auto;padding:14px 10px;border-top:1px solid var(--border);}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:background 0.15s;}
.user-card:hover{background:var(--bg3);}
.avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;}
.user-info .name{font-size:13px;font-weight:600;}
.user-info .role{font-size:11px;color:var(--muted);}
.logout-btn{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--red);font-size:12px;font-weight:600;margin-top:6px;transition:background 0.15s;}
.logout-btn:hover{background:rgba(239,68,68,0.1);}

.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 24px;height:58px;display:flex;align-items:center;gap:14px;
  position:sticky;top:0;z-index:50;
}
.topbar-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;flex:1;}
.btn{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all 0.15s;font-family:'DM Sans',sans-serif;}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(245,166,35,0.3);}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--bg3);color:var(--text);}
.btn-danger{background:rgba(239,68,68,0.15);color:var(--red);border:1px solid rgba(239,68,68,0.3);}
.btn-danger:hover{background:rgba(239,68,68,0.25);}
.btn-success{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3);}
.btn-success:hover{background:rgba(34,197,94,0.25);}
.btn-sm{padding:5px 12px;font-size:12px;}
.icon-btn{width:34px;height:34px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted2);transition:all 0.15s;}
.icon-btn:hover{color:var(--text);border-color:var(--accent);}
.content{padding:22px 24px;flex:1;}
.page{display:none;}
.page.active{display:block;}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.card-subtitle{font-size:12px;color:var(--muted);margin-top:2px;}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:border-color 0.2s;}
.stat-card:hover{border-color:rgba(245,166,35,0.3);}
.stat-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.stat-icon.orange{background:rgba(245,166,35,0.15);}
.stat-icon.blue{background:rgba(59,130,246,0.15);}
.stat-icon.green{background:rgba(34,197,94,0.15);}
.stat-icon.red{background:rgba(239,68,68,0.15);}
.stat-change{font-size:11px;font-weight:700;padding:2px 7px;border-radius:20px;}
.stat-change.up{background:rgba(34,197,94,0.12);color:var(--green);}
.stat-change.down{background:rgba(239,68,68,0.12);color:var(--red);}
.stat-value{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;line-height:1;margin-bottom:4px;}
.stat-label{font-size:12px;color:var(--muted2);}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;padding:9px 12px;font-size:11px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(255,255,255,0.025);}
tbody td{padding:11px 12px;font-size:13px;vertical-align:middle;}
.td-name{font-weight:600;}
.td-sub{font-size:11px;color:var(--muted);margin-top:2px;}

/* STATUS */
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;}
.status-badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.status-badge.activo{background:rgba(34,197,94,0.12);color:var(--green);}
.status-badge.progreso{background:rgba(59,130,246,0.12);color:var(--blue);}
.status-badge.pendiente{background:rgba(245,166,35,0.12);color:var(--accent);}
.status-badge.pausado{background:rgba(239,68,68,0.12);color:var(--red);}
.status-badge.finalizado{background:rgba(168,85,247,0.12);color:var(--purple);}
.status-badge.planilla{background:rgba(34,197,94,0.12);color:var(--green);}
.status-badge.contrato{background:rgba(59,130,246,0.12);color:var(--blue);}
.status-badge.jornal{background:rgba(245,166,35,0.12);color:var(--accent);}

/* PROGRESS */
.progress-bar{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;padding:26px;animation:fadeUp 0.2s ease;}
.modal.modal-lg{max-width:780px;}
.modal.modal-xl{max-width:960px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:none;}}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;}
.modal-close{background:var(--bg3);border:1px solid var(--border);color:var(--muted2);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.modal-close:hover{background:rgba(239,68,68,0.15);color:var(--red);border-color:rgba(239,68,68,0.3);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{margin-bottom:12px;}
.form-label{font-size:11px;font-weight:700;color:var(--muted2);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:0.5px;}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.15s;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--muted);}
select.form-input{cursor:pointer;}
textarea.form-input{resize:vertical;min-height:72px;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--green);border-radius:10px;padding:12px 16px;z-index:500;display:none;min-width:260px;animation:slideIn 0.3s ease;}
.toast.open{display:block;}
.toast.warn{border-left-color:var(--accent);}
.toast.err{border-left-color:var(--red);}
@keyframes slideIn{from{transform:translateX(60px);opacity:0;}to{transform:none;opacity:1;}}
.toast-title{font-weight:700;font-size:13px;margin-bottom:2px;}
.toast-msg{font-size:11px;color:var(--muted2);}

/* PERSON DETAIL */
.person-detail-header{
  display:flex;align-items:center;gap:18px;padding:20px;background:var(--bg3);
  border-radius:12px;margin-bottom:18px;border:1px solid var(--border);
}
.person-avatar{
  width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;flex-shrink:0;
}
.person-detail-info h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}
.person-detail-info p{font-size:13px;color:var(--muted2);margin-top:3px;}
.detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.detail-item{background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);}
.detail-item .d-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.detail-item .d-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.detail-item .d-sub{font-size:11px;color:var(--muted2);margin-top:2px;}
.hours-table{width:100%;border-collapse:collapse;font-size:13px;}
.hours-table th{text-align:left;padding:8px 10px;font-size:10px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
.hours-table td{padding:9px 10px;border-bottom:1px solid var(--border);}
.hours-table tr:last-child td{border-bottom:none;}

/* MACHINE DETAIL */
.machine-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}

/* SEARCH */
.search-bar{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0 10px;height:34px;min-width:200px;}
.search-bar input{background:none;border:none;outline:none;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;width:100%;}
.search-bar input::placeholder{color:var(--muted);}

/* TABS */
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:16px;}
.tab{padding:8px 14px;font-size:13px;font-weight:500;color:var(--muted2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}

/* EMPTY STATE */
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-state .icon{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:13px;}

/* SECTION HEADER */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.section-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;}
.section-sub{font-size:12px;color:var(--muted);margin-top:3px;}

/* PROJECT CARD */
.projects-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.project-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;
  cursor:pointer;transition:all 0.2s;
}
.project-card:hover{border-color:rgba(245,166,35,0.4);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.project-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;}
.project-type-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--muted2);text-transform:uppercase;letter-spacing:0.5px;}
.project-card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:4px;}
.project-card-client{font-size:12px;color:var(--muted2);}
.project-card-meta{display:flex;align-items:center;justify-content:space-between;margin-top:14px;}
.project-progress-label{font-size:11px;color:var(--muted2);margin-bottom:5px;display:flex;justify-content:space-between;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* MACHINE CARD */
.machine-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:all 0.2s;}
.machine-card:hover{border-color:rgba(59,130,246,0.4);}
.machines-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}

/* RENTAB COLOR */
.rentab-high{color:var(--green);font-weight:700;}
.rentab-mid{color:var(--accent);font-weight:700;}
.rentab-low{color:var(--red);font-weight:700;}

/* CONFIRM MODAL */
.confirm-modal{max-width:380px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUILDCORE â€” SISTEMA RESPONSIVE COMPLETO
   Breakpoints: 1200 | 1024 | 768 | 640 | 480 | 380
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€â”€ Hamburger Button â”€â”€â”€ */
.hamburger {
  display: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  color: var(--text);
  flex-direction: column;
  gap: 5px;
  flex-shrink: 0;
  border-radius: 8px;
  transition: background .18s;
}
.hamburger:hover { background: var(--bg3); }
.hamburger span {
  display: block;
  width: 22px;
  height: 2px;
  background: currentColor;
  border-radius: 2px;
  transition: transform .28s cubic-bezier(.16,1,.3,1), opacity .2s;
}

/* â”€â”€â”€ Sidebar Overlay â”€â”€â”€ */
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  z-index: 150;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.sidebar-overlay.open { display: block; }

/* â”€â”€â”€ Mobile Cards (base â€” hidden on desktop) â”€â”€â”€ */
.mobile-cards { display: none; }

.mobile-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  margin-bottom: 10px;
  transition: border-color .15s, transform .1s;
}
.mobile-card:active { transform: scale(.99); border-color: rgba(245,166,35,.35); }

.mc-header  { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
.mc-left    { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
.mc-avatar  {
  width: 40px; height: 40px; border-radius: 50%;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 800; flex-shrink: 0;
}
.mc-name   { font-weight: 700; font-size: 14px; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mc-sub    { font-size: 11px; color: var(--muted); margin-top: 2px; }
.mc-body   { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 14px; margin-bottom: 12px; }
.mc-label  { font-size: 10px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
.mc-val    { font-size: 13px; font-weight: 600; margin-top: 2px; }
.mc-actions { display: flex; gap: 6px; padding-top: 10px; border-top: 1px solid var(--border); }
.mc-actions .btn { flex: 1; font-size: 12px; padding: 8px 6px; text-align: center; }

/* â”€â”€â”€ Roles â”€â”€â”€ */
.role-badge       { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
.role-admin       { background: rgba(245,166,35,.15); color: var(--accent); }
.role-supervisor  { background: rgba(59,130,246,.15);  color: var(--blue); }
.role-contador    { background: rgba(34,197,94,.15);   color: var(--green); }
.role-capataz     { background: rgba(168,85,247,.15);  color: var(--purple); }
.role-cliente     { background: rgba(100,116,139,.15); color: var(--muted2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‰¤ 1200px
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1200px) {
  .projects-grid, .machines-grid { grid-template-columns: repeat(2,1fr); }
  .stats-grid                    { grid-template-columns: repeat(2,1fr); }
  .detail-grid                   { grid-template-columns: repeat(2,1fr); }
  .machine-kpi-grid              { grid-template-columns: repeat(2,1fr); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‰¤ 1024px  TABLET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1024px) {
  :root { --sidebar-w: 260px; }
  html, body { overflow-x: hidden; }

  .main    { margin-left: 0 !important; }
  .sidebar {
    transform: translateX(-100%);
    transition: transform .32s cubic-bezier(.16,1,.3,1);
    z-index: 200;
  }
  .sidebar.open {
    transform: translateX(0);
    box-shadow: 8px 0 40px rgba(0,0,0,.55);
  }
  .hamburger   { display: flex !important; }
  .topbar      { padding: 0 14px; }
  .content     { padding: 16px 14px; }

  .stats-grid, .projects-grid, .machines-grid { grid-template-columns: repeat(2,1fr); }
  .section-header                              { flex-wrap: wrap; gap: 10px; }

  /* Inline stat grids */
  [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:repeat(5,1fr)"] { grid-template-columns: repeat(3,1fr) !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‰¤ 768px  MÃ“VIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  :root { --sidebar-w: 85vw; }
  html, body { overflow-x: hidden !important; }

  /* â”€â”€ Layout â”€â”€ */
  .main    { margin-left: 0 !important; max-width: 100vw; overflow-x: hidden; }
  .content { padding: 12px 10px !important; }

  /* â”€â”€ Topbar â”€â”€ */
  .topbar {
    padding: 0 10px !important;
    height: 52px !important;
    gap: 8px !important;
  }
  .topbar-title {
    font-size: 14px !important;
    font-weight: 700 !important;
    flex: 1; min-width: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .topbar .search-bar { display: none !important; }
  .topbar .icon-btn   { width: 32px !important; height: 32px !important; flex-shrink: 0; }

  /* â”€â”€ KPI Stats â€” 2Ã—2 grid â”€â”€ */
  .stats-grid     { grid-template-columns: repeat(2,1fr) !important; gap: 8px !important; }
  .stat-card      { padding: 14px 12px !important; border-radius: 12px !important; }
  .stat-value     { font-size: 20px !important; line-height: 1.1 !important; }
  .stat-label     { font-size: 11px !important; }
  .stat-icon      { width: 34px !important; height: 34px !important; font-size: 15px !important; }
  .stat-header    { margin-bottom: 8px !important; }

  /* â”€â”€ Section Header: stack vertically â”€â”€ */
  .section-header {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 10px !important;
    margin-bottom: 14px !important;
  }
  .section-title { font-size: 18px !important; }
  .section-sub   { font-size: 11px !important; }
  .section-header > div:last-child {
    display: flex !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
    width: 100% !important;
  }
  .section-header .btn {
    flex: 1 !important;
    min-width: 0 !important;
    font-size: 12px !important;
    padding: 9px 8px !important;
    text-align: center !important;
  }
  .section-header select.form-input,
  .section-header input[type="date"].form-input {
    flex: 1 !important;
    min-width: 120px !important;
    height: 36px !important;
    font-size: 12px !important;
    max-width: 100% !important;
  }

  /* â”€â”€ Cards â”€â”€ */
  .card        { padding: 14px !important; border-radius: 14px !important; }
  .card-header { flex-wrap: wrap !important; gap: 8px !important; }
  .card-title  { font-size: 14px !important; }

  /* â”€â”€ Grids â”€â”€ */
  .projects-grid, .machines-grid { grid-template-columns: 1fr !important; }
  .detail-grid                   { grid-template-columns: 1fr 1fr !important; }
  .machine-kpi-grid              { grid-template-columns: 1fr 1fr !important; }

  /* â”€â”€ Tables & Mobile Cards â”€â”€ */
  .hide-on-mobile { display: none !important; }
  .mobile-cards   { display: block !important; }
  .table-wrap     { overflow-x: auto !important; -webkit-overflow-scrolling: touch; }

  /* â”€â”€ Modals â†’ bottom sheet â”€â”€ */
  .modal-overlay { align-items: flex-end !important; padding: 0 !important; }
  .modal {
    border-radius: 22px 22px 0 0 !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    max-height: 93vh !important;
    overflow-y: auto !important;
    padding: 0 16px 36px !important;
    animation: bcSheetUp .3s cubic-bezier(.16,1,.3,1) !important;
  }
  @keyframes bcSheetUp {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
  }
  .modal::before {
    content: '';
    display: block;
    width: 40px; height: 4px;
    background: rgba(255,255,255,.14);
    border-radius: 4px;
    margin: 12px auto 18px;
  }
  .modal.modal-lg, .modal.modal-xl { max-height: 96vh !important; }
  .modal-title { font-size: 16px !important; }
  .form-row    { grid-template-columns: 1fr !important; }

  /* â”€â”€ Login â”€â”€ */
  .login-card { width: calc(100vw - 24px) !important; padding: 26px 18px !important; }

  /* â”€â”€ Person Detail â”€â”€ */
  .person-detail-header { flex-direction: column !important; text-align: center !important; gap: 12px !important; }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs { overflow-x: auto !important; flex-wrap: nowrap !important; -webkit-overflow-scrolling: touch; padding-bottom: 2px; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab  { white-space: nowrap !important; padding: 7px 12px !important; font-size: 12px !important; }

  /* â”€â”€ Toast â”€â”€ */
  .toast { right: 10px !important; left: 10px !important; bottom: 16px !important; min-width: 0 !important; }

  /* â”€â”€ Buttons â”€â”€ */
  .btn    { font-size: 12px !important; }
  .btn-sm { padding: 6px 10px !important; font-size: 11px !important; }

  /* â”€â”€ Global inline grid overrides â”€â”€ */
  [style*="grid-template-columns:repeat(3,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:repeat(5,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:2fr 1fr"]        { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:1fr 1fr"]        { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:3fr 1fr"]        { grid-template-columns: 1fr !important; }

  /* Canvas responsive */
  canvas { max-width: 100% !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-dashboard .stats-grid                                      { grid-template-columns: repeat(2,1fr) !important; }
  #page-dashboard [style*="grid-template-columns:2fr 1fr"]         { grid-template-columns: 1fr !important; }
  #page-dashboard [style*="grid-template-columns:1fr 1fr"]         { grid-template-columns: 1fr !important; }
  /* Donut centrado */
  #dash-donut-chart                                                 { max-width: 150px !important; margin: 0 auto !important; }
  /* Legend lÃ­neas del grÃ¡fico */
  #page-dashboard .card-header [style*="gap:14px"]                  { flex-wrap: wrap !important; gap: 6px !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     OBRAS EN CURSO
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-obras [style*="grid-template-columns:2fr 1fr"] { grid-template-columns: 1fr !important; }
  /* Items de clima: flex row â†’ stack */
  #page-obras .card [style*="justify-content:space-between"][style*="align-items:center"]:not(.card-header) {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 3px !important;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COTIZADOR
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #cotiz-resumen [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
  #cotiz-resumen [style*="font-size:32px"]                { font-size: 26px !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PLANILLA DE SUELDOS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-planilla [style*="grid-template-columns:repeat(5,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #page-planilla [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #planilla-mes { width: 100% !important; max-width: 100% !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONTRATOS & ACTAS
     Tarjetas 3-col â†’ 2-col compacto
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-contratos [style*="grid-template-columns:repeat(3,1fr)"] {
    grid-template-columns: repeat(2,1fr) !important;
    gap: 10px !important;
  }
  #page-contratos .stat-card {
    padding: 12px 10px !important;
    display: flex !important;
    flex-direction: column !important;
  }
  #page-contratos .stat-card .stat-value  { font-size: 13px !important; font-weight: 700 !important; }
  #page-contratos .stat-card .stat-label  { font-size: 10px !important; }
  #page-contratos .stat-icon              { width: 32px !important; height: 32px !important; font-size: 14px !important; }
  #page-contratos .stat-card .btn         { font-size: 11px !important; padding: 6px 8px !important; }
  /* Historial: scroll */
  #contratos-historial .table-wrap        { overflow-x: auto !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ASISTENCIA
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-asistencia [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #asist-proyecto-filter { flex: 1 !important; max-width: 100% !important; }
  /* Tabla del dÃ­a â†’ ocultar, mobile-cards visible */
  #page-asistencia .card:first-of-type .table-wrap { display: none !important; }
  #asist-mobile                                    { display: block !important; }
  /* Resumen mensual: scroll */
  #page-asistencia .card:last-child .table-wrap { overflow-x: auto !important; display: block !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FLUJO DE CAJA
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  /* Stats 4-col â†’ 2-col */
  #page-flujocaja .stats-grid                                      { grid-template-columns: repeat(2,1fr) !important; }
  #page-flujocaja [style*="grid-template-columns:repeat(4,1fr)"]   { grid-template-columns: repeat(2,1fr) !important; }
  /* Selects filtro: expandir */
  #flujo-proyecto-filter, #flujo-mes-filter {
    flex: 1 !important;
    min-width: 120px !important;
    max-width: 100% !important;
    height: 36px !important;
    font-size: 12px !important;
  }
  /* Botones grÃ¡fico: wrap */
  #page-flujocaja .card-header > div { flex-wrap: wrap !important; gap: 4px !important; }
  #flujo-btn-todos, #flujo-btn-ingreso, #flujo-btn-egreso { font-size: 11px !important; padding: 5px 8px !important; }
  /* Tabla â†’ mobile cards */
  #page-flujocaja .card:last-child .table-wrap { display: none !important; }
  #flujo-mobile                                { display: block !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REPORTES & ANALÃTICA
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-reportes [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  /* Dos grÃ¡ficos side-by-side â†’ 1 col */
  #page-reportes [style*="grid-template-columns:1fr 1fr"]        { grid-template-columns: 1fr !important; }
  /* Botones Excel/PDF: full width */
  #page-reportes .section-header .btn { flex: 1 !important; text-align: center !important; }
  /* Card headers con botones: wrap */
  #page-reportes .card-header { flex-wrap: wrap !important; gap: 8px !important; }
  #page-reportes .card-header .btn { width: 100% !important; text-align: center !important; }
  /* Gantt: scroll horizontal */
  #gantt-container { overflow-x: auto !important; width: 100% !important; }
  /* Tabla resumen ejecutivo â†’ scroll (ya tiene hide-on-mobile no es necesario ocultarla,
     pero hacemos scroll elegante) */
  #page-reportes .card:last-child .table-wrap { overflow-x: auto !important; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     USUARIOS & ROLES
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  #page-usuarios [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  /* Tabla â†’ mobile cards */
  #page-usuarios .table-wrap { display: none !important; }
  #usuarios-mobile           { display: block !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‰¤ 640px  TELÃ‰FONO PEQUEÃ‘O
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 640px) {
  .content   { padding: 10px 8px !important; }
  .topbar    { padding: 0 8px !important; height: 50px !important; }
  .topbar-title { font-size: 13px !important; }

  /* Stats â†’ 1 columna */
  .stats-grid  { grid-template-columns: 1fr !important; gap: 8px !important; }
  .stat-value  { font-size: 22px !important; }
  .section-title { font-size: 17px !important; }

  /* Contratos â†’ 1 col */
  #page-contratos [style*="grid-template-columns:repeat(3,1fr)"],
  #page-contratos [style*="grid-template-columns:repeat(2,1fr)"] {
    grid-template-columns: 1fr !important;
  }

  /* Reportes KPIs â†’ 1 col */
  #page-reportes [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }

  /* Inline grids */
  [style*="grid-template-columns:1fr 1fr"]        { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(3,1fr)"]  { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(4,1fr)"]  { grid-template-columns: repeat(2,1fr) !important; }

  .detail-grid      { grid-template-columns: 1fr !important; }
  .machine-kpi-grid { grid-template-columns: 1fr !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‰¤ 480px  TELÃ‰FONO MUY PEQUEÃ‘O
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 480px) {
  [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #page-planilla [style*="grid-template-columns:repeat(5,1fr)"],
  #page-planilla [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  .stats-grid     { grid-template-columns: 1fr !important; }
  .modal          { padding: 0 12px 32px !important; }
  .login-card     { padding: 22px 14px !important; border-radius: 16px !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   â‰¤ 380px  MÃNIMO ABSOLUTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 380px) {
  .content { padding: 8px 6px !important; }
  .stats-grid { grid-template-columns: 1fr !important; }
  #page-contratos [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(4,1fr)"]   { grid-template-columns: 1fr !important; }
}
</style>
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<body>

<!-- ===== LOGIN ===== -->
<div id="login-screen">
  <div class="login-bg"></div>
  <div class="login-grid"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">ğŸ—ï¸</div>
      <div class="login-logo-text">Build<span>Core</span></div>
    </div>
    <p class="login-subtitle">Sistema de GestiÃ³n para Constructoras<br>IngresÃ¡ tus credenciales para continuar</p>
    <div id="login-error" class="login-error">âš ï¸ Usuario o contraseÃ±a incorrectos.</div>
    <label class="login-label">Usuario</label>
    <input type="text" class="login-input" id="login-user" placeholder="Ej: admin" autocomplete="username">
    <label class="login-label">ContraseÃ±a</label>
    <input type="password" class="login-input" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">INGRESAR AL SISTEMA</button>
    <p class="login-hint">Demo: usuario <b>admin</b> Â· contraseÃ±a <b>1234</b></p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app">
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">ğŸ—ï¸</div>
    <div class="logo-text">Build<span>Core</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item active" onclick="nav('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-item" onclick="nav('proyectos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M4 20V10l8-6 8 6v10"/><path d="M9 20v-5h6v5"/></svg>
      Proyectos
      <span class="badge green" id="badge-proyectos">0</span>
    </div>
    <div class="nav-item" onclick="nav('personal',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Personal & Cuadrillas
      <span class="badge" id="badge-personal">0</span>
    </div>
    <div class="nav-item" onclick="nav('maquinaria',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Maquinaria
      <span class="badge" id="badge-maquinaria">0</span>
    </div>
    <div class="nav-item" onclick="nav('obras',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
      Obras en Curso
      <span class="badge green" id="badge-obras">0</span>
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">GestiÃ³n</div>
    <div class="nav-item" onclick="nav('presupuestos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Presupuestos
      <span class="badge" id="badge-presupuestos">0</span>
    </div>
    <div class="nav-item" onclick="nav('materiales',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
      Materiales
    </div>
    <div class="nav-item" onclick="nav('proveedores',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18l-2 9H5L3 3z"/><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/></svg>
      Proveedores
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Finanzas</div>
    <div class="nav-item" onclick="nav('cotizador',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 7H6a2 2 0 00-2 2v9a2 2 0 002 2h9a2 2 0 002-2v-3"/><path d="M9 7V5a2 2 0 012-2h7a2 2 0 012 2v7a2 2 0 01-2 2h-2"/><path d="M12 12h4m-4 4h4m-4-8h4"/></svg>
      Cotizador
      <span class="badge" style="background:rgba(168,85,247,0.25);color:#a855f7;" id="badge-cotiz">0</span>
    </div>
    <div class="nav-item" onclick="nav('facturacion',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      FacturaciÃ³n
      <span class="badge" id="badge-facturas">3</span>
    </div>
    <div class="nav-item" onclick="nav('planilla',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Planilla de Sueldos
      <span class="badge" id="badge-planilla" style="background:rgba(34,197,94,0.2);color:var(--green);">0</span>
    </div>
    <div class="nav-item" onclick="nav('contratos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Contratos & Actas
      <span class="badge" id="badge-contratos" style="background:rgba(59,130,246,0.2);color:var(--blue);">0</span>
    </div>
    <div class="nav-item" onclick="nav('asistencia',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>
      Asistencia
      <span class="badge" id="badge-asistencia" style="background:rgba(245,166,35,0.2);color:var(--accent);">0</span>
    </div>
    <div class="nav-item" onclick="nav('flujocaja',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Flujo de Caja
    </div>
    <div class="nav-item" onclick="nav('alertas',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      Alertas
      <span class="badge" id="badge-alertas" style="background:rgba(220,53,69,0.15);color:var(--red);">0</span>
    </div>
    <div class="nav-item" onclick="nav('reportes',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reportes
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Sistema</div>
    <div class="nav-item" onclick="nav('usuarios',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Usuarios & Roles
      <span class="badge" id="badge-usuarios" style="background:rgba(245,166,35,0.2);color:var(--accent);">0</span>
    </div>
  </div>
  <div class="sidebar-bottom">
    <div class="user-card">
      <div class="avatar" id="sidebar-avatar">AD</div>
      <div class="user-info">
        <div class="name" id="sidebar-name">Administrador</div>
        <div class="role">Director de Obras</div>
      </div>
    </div>
    <div style="display:flex;gap:6px;margin:6px 0;">
      <div style="flex:1;display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--green);font-size:12px;font-weight:600;transition:background 0.15s;border:1px solid rgba(34,197,94,0.2);" onclick="openModal('importar')" onmouseover="this.style.background='rgba(34,197,94,0.1)'" onmouseout="this.style.background=''">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Importar Excel
      </div>
      <div id="pwa-install-btn" style="display:none;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--blue);font-size:12px;font-weight:600;transition:background 0.15s;border:1px solid rgba(59,130,246,0.2);" onclick="installPWA()" onmouseover="this.style.background='rgba(59,130,246,0.1)'" onmouseout="this.style.background=''">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 12l4 4 4-4M12 8v8"/></svg>
        Instalar App
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;padding:6px 10px;font-size:11px;color:var(--muted);">
      <span id="offline-indicator" style="display:none;color:var(--accent);">âš¡ Modo offline</span>
      <span id="sync-indicator" style="display:none;color:var(--green);">âœ“ Sincronizado</span>
      <span id="pending-sync-indicator" style="display:none;color:var(--accent);">ğŸ”„ <span id="pending-count">0</span> pendientes</span>
    </div>
    <div class="logout-btn" onclick="doLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
      Cerrar SesiÃ³n
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <header class="topbar">
    <button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()" aria-label="MenÃº">
      <span></span><span></span><span></span>
    </button>
    <div class="topbar-title" id="page-title">Dashboard General</div>
    <div class="search-bar">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" placeholder="Buscar..." id="global-search" oninput="globalSearch(this.value)">
    </div>
    <div class="icon-btn" title="Notificaciones" onclick="nav('alertas',null)" style="position:relative;">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      <span id="topbar-alert-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;font-size:9px;font-weight:800;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;"></span>
    </div>
  </header>

  <div class="content">

    <!-- ===== DASHBOARD ===== -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon orange">ğŸ—ï¸</div><span class="stat-change up" id="kpi-p-change">0</span></div>
          <div class="stat-value" id="kpi-proyectos">0</div>
          <div class="stat-label">Proyectos Activos</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon blue">ğŸ’°</div></div>
          <div class="stat-value" id="kpi-presupuesto">$0</div>
          <div class="stat-label">Presupuesto Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon green">ğŸ‘·</div></div>
          <div class="stat-value" id="kpi-personal">0</div>
          <div class="stat-label">Personal en Planilla</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon red">ğŸšœ</div></div>
          <div class="stat-value" id="kpi-maquinas">0</div>
          <div class="stat-label">Equipos Activos</div>
        </div>
      </div>

      <!-- PROYECTOS RESUMEN -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">Resumen de Proyectos</div></div>
          <button class="btn btn-ghost btn-sm" onclick="nav('proyectos',null)">Ver todos â†’</button>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Proyecto</th><th>Cliente</th><th>Presupuesto</th><th>Avance</th><th>Estado</th></tr></thead>
            <tbody id="dash-projects-table"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">No hay proyectos aÃºn.</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CHARTS ROW -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;">
        <!-- LINE CHART: FacturaciÃ³n mensual -->
        <div class="card">
          <div class="card-header">
            <div><div class="card-title">FacturaciÃ³n vs Costos â€” 2025</div><div class="card-subtitle">Comparativa mensual en millones USD</div></div>
            <div style="display:flex;gap:14px;align-items:center;">
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--accent);border-radius:2px;"></div>Facturado</div>
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--blue);border-radius:2px;border-style:dashed;"></div>Costo</div>
            </div>
          </div>
          <canvas id="dash-line-chart" height="140" style="width:100%;"></canvas>
        </div>
        <!-- DONUT: Proyectos por tipo -->
        <div class="card">
          <div class="card-header"><div><div class="card-title">Proyectos por Tipo</div><div class="card-subtitle">DistribuciÃ³n de cartera</div></div></div>
          <div style="display:flex;flex-direction:column;align-items:center;padding:4px 0;">
            <canvas id="dash-donut-chart" width="160" height="160" style="max-width:160px;"></canvas>
            <div id="dash-donut-legend" style="width:100%;margin-top:14px;display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>
      </div>

      <!-- BOTTOM ROW -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Personal â€” Top Horas Mes</div></div>
          <div id="dash-personal-list" style="display:flex;flex-direction:column;gap:10px;">
            <p style="color:var(--muted);font-size:13px;">Sin datos aÃºn.</p>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Maquinaria â€” Rentabilidad</div></div>
          <div id="dash-maquinaria-list" style="display:flex;flex-direction:column;gap:10px;">
            <p style="color:var(--muted);font-size:13px;">Sin datos aÃºn.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PROYECTOS ===== -->
    <div class="page" id="page-proyectos">
      <div class="section-header">
        <div>
          <div class="section-title">GestiÃ³n de Proyectos</div>
          <div class="section-sub" id="proyectos-sub">0 proyectos en cartera</div>
        </div>
        <button class="btn btn-primary" onclick="openModal('proyecto')">ï¼‹ Nuevo Proyecto</button>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="filterTab('proyectos','todos',this)">Todos</div>
        <div class="tab" onclick="filterTab('proyectos','activo',this)">Activos</div>
        <div class="tab" onclick="filterTab('proyectos','progreso',this)">En Curso</div>
        <div class="tab" onclick="filterTab('proyectos','pendiente',this)">Pendientes</div>
        <div class="tab" onclick="filterTab('proyectos','finalizado',this)">Finalizados</div>
      </div>
      <div class="projects-grid" id="projects-grid">
        <div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸ—ï¸</div><p>No hay proyectos.<br>HacÃ© clic en "Nuevo Proyecto" para comenzar.</p></div>
      </div>
    </div>

    <!-- ===== PERSONAL ===== -->
    <div class="page" id="page-personal">
      <div class="section-header">
        <div>
          <div class="section-title">Personal & Cuadrillas</div>
          <div class="section-sub" id="personal-sub">0 empleados registrados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportPersonalExcel()">ğŸ“¥ Exportar Excel</button>
          <button class="btn btn-primary" onclick="openModal('personal')">ï¼‹ Agregar Personal</button>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div class="search-bar" style="flex:1;max-width:300px;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" placeholder="Buscar empleado..." oninput="filterPersonal(this.value)">
          </div>
          <select class="form-input" style="width:180px;height:34px;padding:0 10px;" onchange="filterPersonalStatus(this.value)">
            <option value="">Todos los tipos</option>
            <option value="planilla">En Planilla</option>
            <option value="contrato">Contrato</option>
            <option value="jornal">Jornalero</option>
          </select>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead>
              <tr>
                <th>Empleado</th>
                <th>Rol / Cuadrilla</th>
                <th>Tipo</th>
                <th>Sueldo Base</th>
                <th>Horas Mes</th>
                <th>Proyecto</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="personal-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No hay personal registrado.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="personal-mobile"></div>
      </div>
    </div>

    <!-- ===== MAQUINARIA ===== -->
    <div class="page" id="page-maquinaria">
      <div class="section-header">
        <div>
          <div class="section-title">Parque de Maquinaria</div>
          <div class="section-sub" id="maquinaria-sub">0 equipos registrados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportMaquinariaExcel()">ğŸ“¥ Exportar Excel</button>
          <button class="btn btn-primary" onclick="openModal('maquina')">ï¼‹ Registrar Equipo</button>
        </div>
      </div>

      <!-- KPIs maquinaria -->
      <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â±ï¸</div></div><div class="stat-value" id="maq-total-horas">0h</div><div class="stat-label">Horas Totales Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ’µ</div></div><div class="stat-value" id="maq-total-ingreso">$0</div><div class="stat-label">Ingresos Generados</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ”§</div></div><div class="stat-value" id="maq-total-costo">$0</div><div class="stat-label">Costos Operativos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ“ˆ</div></div><div class="stat-value" id="maq-rentab-prom">0%</div><div class="stat-label">Rentabilidad Promedio</div></div>
      </div>

      <!-- KPI combustible -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â›½</div></div><div class="stat-value" id="maq-combustible-total">0 L</div><div class="stat-label">Combustible Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ’°</div></div><div class="stat-value" id="maq-comb-costo">S/ 0</div><div class="stat-label">Costo Combustible</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ› ï¸</div></div><div class="stat-value" id="maq-mantenim-count">0</div><div class="stat-label">Mantenimientos Este Mes</div></div>
      </div>

      <div class="machines-grid" id="machines-grid">
        <div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸšœ</div><p>No hay equipos registrados.</p></div>
      </div>

      <!-- Historial de uso -->
      <div class="card" style="margin-top:16px;">
        <div class="card-header">
          <div><div class="card-title">ğŸ“‹ Historial de Uso y Combustible</div><div class="card-subtitle">Registro detallado por equipo</div></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-input" id="maq-hist-filtro" style="height:32px;padding:0 8px;font-size:12px;width:180px;" onchange="renderHistorialMaq()">
              <option value="">Todos los equipos</option>
            </select>
            <button class="btn btn-success btn-sm" onclick="exportHistorialMaqExcel()">ğŸ“¥ Excel</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('uso-maquina')">ï¼‹ Registrar Uso</button>
          </div>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Fecha</th><th>Equipo</th><th>Proyecto</th><th>Horas</th><th>Combustible (L)</th><th>Costo Comb.</th><th>Operador</th><th>Tipo</th><th>ObservaciÃ³n</th><th></th></tr></thead>
            <tbody id="historial-maq-table"><tr><td colspan="10" style="text-align:center;color:var(--muted);padding:24px;">Sin registros. HacÃ© clic en "+ Registrar Uso".</td></tr></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="historial-maq-mobile"></div>
      </div>
    </div>

    <!-- ===== OBRAS EN CURSO ===== -->
    <div class="page" id="page-obras">
      <div class="section-header">
        <div><div class="section-title">Obras en Curso</div><div class="section-sub">Actividad diaria en campo</div></div>
        <button class="btn btn-primary" onclick="openModal('parte')">ï¼‹ Registrar Parte Diario</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ—ï¸</div></div><div class="stat-value" id="ob-activas">0</div><div class="stat-label">Obras Activas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ‘·</div></div><div class="stat-value" id="ob-obreros">0</div><div class="stat-label">Obreros en Campo Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">â±ï¸</div></div><div class="stat-value" id="ob-horas">0h</div><div class="stat-label">Horas Totales Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âš ï¸</div></div><div class="stat-value" id="ob-incidencias">2</div><div class="stat-label">Incidencias Abiertas</div></div>
      </div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Partes Diarios â€” Hoy</div></div>
          <div class="table-wrap hide-on-mobile">
            <table>
              <thead><tr><th>Obra</th><th>Actividad</th><th>Cuadrilla</th><th>Obreros</th><th>Horas</th><th>Estado</th></tr></thead>
              <tbody id="obras-partes-table">
                <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px;">Sin partes registrados hoy. HacÃ© clic en "+ Registrar Parte Diario".</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Condiciones por Obra</div></div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â˜€ï¸ Torre Mirador</div><div style="font-size:12px;color:var(--green);">24Â°C Despejado âœ“</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">ğŸŒ§ï¸ Ruta 102</div><div style="font-size:12px;color:var(--accent);">18Â°C Lluvia âš ï¸</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â˜€ï¸ Hospital Norte</div><div style="font-size:12px;color:var(--green);">22Â°C Despejado âœ“</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â›… CC Sur</div><div style="font-size:12px;color:var(--muted2);">20Â°C Nublado</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â˜€ï¸ Planta LogÃ­stica</div><div style="font-size:12px;color:var(--green);">25Â°C Despejado âœ“</div></div>
          </div>
          <div style="margin-top:14px;padding:12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;">
            <div style="font-size:12px;font-weight:700;color:var(--red);margin-bottom:6px;">âš ï¸ INCIDENCIAS ABIERTAS</div>
            <div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">â€¢ Ruta 102: DesvÃ­o bloqueado por lluvia</div>
            <div style="font-size:12px;color:var(--muted2);">â€¢ CC Sur: Retraso entrega acero (2 dÃ­as)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PRESUPUESTOS ===== -->
    <div class="page" id="page-presupuestos">
      <div class="section-header">
        <div><div class="section-title">Presupuestos</div><div class="section-sub" id="pres-sub">GestiÃ³n de ofertas y cotizaciones</div></div>
        <button class="btn btn-primary" onclick="openModal('presupuesto')">ï¼‹ Nuevo Presupuesto</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ“‹</div></div><div class="stat-value" id="pres-total">0</div><div class="stat-label">Total Presupuestos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">âœ…</div></div><div class="stat-value" id="pres-aprobados">0</div><div class="stat-label">Aprobados</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â³</div></div><div class="stat-value" id="pres-revision">0</div><div class="stat-label">En RevisiÃ³n</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âŒ</div></div><div class="stat-value" id="pres-rechazados">0</div><div class="stat-label">Rechazados</div></div>
      </div>
      <div class="card">
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Presupuesto</th><th>Cliente</th><th>Monto (S/)</th><th>Fecha EnvÃ­o</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="presupuestos-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay presupuestos registrados.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="presupuestos-mobile"></div>
      </div>
    </div>

    <!-- ===== MATERIALES ===== -->
    <div class="page" id="page-materiales">
      <div class="section-header">
        <div><div class="section-title">Control de Materiales</div><div class="section-sub">Inventario y movimientos</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportMaterialesExcel()">ğŸ“¥ Exportar</button>
          <button class="btn btn-primary" onclick="openModal('material')">ï¼‹ Registrar Movimiento</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="mat-stock-grid">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸ§±</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">48,200</div><div style="font-size:12px;color:var(--muted);">Ladrillos (u.)</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸ”©</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">84 ton</div><div style="font-size:12px;color:var(--muted);">Acero corrugado</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸª£</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">620 bolsas</div><div style="font-size:12px;color:var(--muted);">Cemento Portland</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸª¨</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">320 mÂ³</div><div style="font-size:12px;color:var(--muted);">Arena / Granza</div></div></div>
        <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">âš¡</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--red);">12 rollos</div><div style="font-size:12px;color:var(--muted);">Cable elÃ©ct. âš ï¸ Stock bajo</div></div></div>
        <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸ”§</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--red);">8 u.</div><div style="font-size:12px;color:var(--muted);">TuberÃ­as PVC âš ï¸ Stock bajo</div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Movimientos Recientes</div></div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Material</th><th>Tipo</th><th>Cantidad</th><th>Proyecto</th><th>Responsable</th><th>Fecha</th></tr></thead>
            <tbody id="materiales-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">Cargando movimientos...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="materiales-mobile"></div>
      </div>
    </div>

    <!-- ===== PROVEEDORES ===== -->
    <div class="page" id="page-proveedores">
      <div class="section-header">
        <div><div class="section-title">Proveedores</div><div class="section-sub" id="prov-sub">GestiÃ³n de proveedores activos</div></div>
        <button class="btn btn-primary" onclick="openModal('proveedor')">ï¼‹ Nuevo Proveedor</button>
      </div>
      <div class="card">
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Proveedor</th><th>Rubro</th><th>Contacto</th><th>Ãšltima Compra</th><th>Total AÃ±o</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="proveedores-table">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Cargando proveedores...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="proveedores-mobile"></div>
      </div>
    </div>

    <!-- ===== FACTURACIÃ“N ===== -->
    <div class="page" id="page-facturacion">
      <div class="section-header">
        <div><div class="section-title">FacturaciÃ³n</div><div class="section-sub">Control de facturas emitidas y cobros</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportFacturasExcel()">ğŸ“¥ Exportar</button>
          <button class="btn btn-primary" onclick="openModal('factura')">ï¼‹ Nueva Factura</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ’µ</div><span class="stat-change up">â–² 14%</span></div><div class="stat-value" id="fac-mes">S/ 0</div><div class="stat-label">Facturado en el Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â³</div></div><div class="stat-value" id="fac-pendiente">S/ 0</div><div class="stat-label">Pendiente de Cobro</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âŒ</div></div><div class="stat-value" id="fac-vencido">S/ 0</div><div class="stat-label">Vencido (+30 dÃ­as)</div></div>
      </div>
      <div class="card">
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>NÂ° Factura</th><th>Cliente</th><th>Proyecto</th><th>Monto</th><th>Fecha</th><th>Vence</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="facturas-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">Cargando facturas...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="facturas-mobile"></div>
      </div>
    </div>

    <!-- ===== REPORTES ===== -->
    <div class="page" id="page-reportes">
      <div class="section-header">
        <div><div class="section-title">Reportes & AnalÃ­tica</div><div class="section-sub" id="rep-fecha">Datos actualizados</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-success btn-sm" onclick="exportReporteExcel()">ğŸ“¥ Excel</button>
          <button class="btn btn-primary btn-sm" onclick="exportReportePDF()">ğŸ“„ PDF + Gantt</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ“Š</div></div><div class="stat-value" id="rep-cartera">S/ 0</div><div class="stat-label">Cartera Total</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">âœ…</div><span class="stat-change up">â–² 18%</span></div><div class="stat-value" id="rep-cumplimiento">0%</div><div class="stat-label">Tasa de Cumplimiento</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ’¹</div></div><div class="stat-value" id="rep-margen">23.4%</div><div class="stat-label">Margen Promedio</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">â±ï¸</div></div><div class="stat-value">+8 dÃ­as</div><div class="stat-label">DesvÃ­o Promedio Plazo</div></div>
      </div>
      <!-- CHARTS GRID EN REPORTES -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div class="card">
          <div class="card-header"><div><div class="card-title">Costos por Rubro</div><div class="card-subtitle">Mes actual â€” miles S/</div></div></div>
          <canvas id="rep-bar-chart" height="200" style="width:100%;"></canvas>
        </div>
        <div class="card">
          <div class="card-header"><div><div class="card-title">Avance por Proyecto</div><div class="card-subtitle">% completado vs meta</div></div></div>
          <canvas id="rep-hbar-chart" height="200" style="width:100%;"></canvas>
        </div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">EvoluciÃ³n de FacturaciÃ³n</div><div class="card-subtitle">Ingresos y cobros mensuales en S/</div></div>
        </div>
        <canvas id="rep-line-chart" height="130" style="width:100%;"></canvas>
      </div>

      <!-- GANTT -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">ğŸ“… Diagrama Gantt â€” Proyectos</div><div class="card-subtitle">LÃ­nea de tiempo de ejecuciÃ³n</div></div>
          <button class="btn btn-primary btn-sm" onclick="exportGanttPDF()">ğŸ“„ Exportar Gantt PDF</button>
        </div>
        <div id="gantt-container" style="overflow-x:auto;padding:8px 0;"></div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">Resumen Ejecutivo por Proyecto</div></div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Proyecto</th><th>Presupuesto</th><th>Ejecutado Est.</th><th>DesviaciÃ³n</th><th>Margen Est.</th><th>Avance FÃ­sico</th></tr></thead>
            <tbody id="reportes-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== ASISTENCIA ===== -->
    <!-- ===== ASISTENCIA ===== -->
    <div class="page" id="page-asistencia">
      <div class="section-header">
        <div>
          <div class="section-title">Control de Asistencia</div>
          <div class="section-sub" id="asist-sub">Parte diario del personal</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <input type="date" class="form-input" id="asist-fecha" style="height:36px;padding:0 10px;width:160px;" onchange="renderAsistencia()">
          <select id="asist-proyecto-filter" class="form-input" style="height:36px;padding:0 10px;max-width:180px;" onchange="renderAsistencia()">
            <option value="">Todos los proyectos</option>
          </select>
          <button class="btn btn-success btn-sm" onclick="exportAsistenciaExcel()">ğŸ“¥ Exportar</button>
          <button class="btn btn-primary btn-sm" onclick="guardarParteDiario()">ğŸ’¾ Guardar Parte</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">âœ…</div></div><div class="stat-value" id="asist-presentes">0</div><div class="stat-label">Presentes Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âŒ</div></div><div class="stat-value" id="asist-ausentes">0</div><div class="stat-label">Ausentes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â°</div></div><div class="stat-value" id="asist-tardanza">0</div><div class="stat-label">Tardanzas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ“…</div></div><div class="stat-value" id="asist-tasa">0%</div><div class="stat-label">Tasa Asistencia</div></div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div class="card-title">Registro del DÃ­a</div>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Trabajador</th><th>Rol</th><th>Proyecto</th><th>Estado</th><th>H. Entrada</th><th>H. Extras</th><th>ObservaciÃ³n</th></tr></thead>
            <tbody id="asist-table">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">SeleccionÃ¡ una fecha para ver el personal</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="asist-mobile"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Resumen Mensual</div>
          <select id="asist-mes-filter" class="form-input" style="max-width:180px;" onchange="renderResumenMensual()"></select>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Trabajador</th><th>Proyecto</th><th>DÃ­as Trabajados</th><th>Ausencias</th><th>Tardanzas</th><th>H. Extras Total</th><th>% Asistencia</th></tr></thead>
            <tbody id="asist-resumen-table">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Cargando resumen...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ===== FLUJO DE CAJA ===== -->
    <div class="page" id="page-flujocaja">
      <div class="section-header">
        <div>
          <div class="section-title">Flujo de Caja</div>
          <div class="section-sub" id="flujo-sub">Ingresos y egresos por proyecto</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select class="form-input" id="flujo-proyecto-filter" style="height:36px;padding:0 10px;" onchange="renderFlujoCaja()">
            <option value="">Todos los proyectos</option>
          </select>
          <select class="form-input" id="flujo-mes-filter" style="height:36px;padding:0 10px;" onchange="renderFlujoCaja()">
            <option value="">Todos los meses</option>
          </select>
          <button class="btn btn-success btn-sm" onclick="exportFlujoCajaExcel()">ğŸ“¥ Excel</button>
          <button class="btn btn-primary" onclick="openModal('movimiento')">ï¼‹ Registrar Movimiento</button>
        </div>
      </div>
      <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ“ˆ</div></div><div class="stat-value" id="flujo-ingresos">S/ 0</div><div class="stat-label">Ingresos del Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ“‰</div></div><div class="stat-value" id="flujo-egresos">S/ 0</div><div class="stat-label">Egresos del Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ’°</div></div><div class="stat-value" id="flujo-saldo">S/ 0</div><div class="stat-label">Saldo Neto</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ¦</div></div><div class="stat-value" id="flujo-acumulado">S/ 0</div><div class="stat-label">Saldo Acumulado</div></div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div class="card-title">ğŸ“Š EvoluciÃ³n Mensual</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost btn-sm" id="flujo-btn-todos" onclick="filtrarFlujo('todos')" style="font-weight:700;">Todos</button>
            <button class="btn btn-ghost btn-sm" id="flujo-btn-ingreso" onclick="filtrarFlujo('ingreso')" style="color:var(--green);">â–² Ingresos</button>
            <button class="btn btn-ghost btn-sm" id="flujo-btn-egreso" onclick="filtrarFlujo('egreso')" style="color:var(--red);">â–¼ Egresos</button>
          </div>
        </div>
        <canvas id="flujo-chart" height="120" style="width:100%;"></canvas>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ’³ Movimientos</div></div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Fecha</th><th>Proyecto</th><th>CategorÃ­a</th><th>DescripciÃ³n</th><th>Tipo</th><th style="text-align:right;">Monto</th><th>Acciones</th></tr></thead>
            <tbody id="flujo-table"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Sin movimientos. HacÃ© clic en "+ Registrar Movimiento".</td></tr></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="flujo-mobile"></div>
      </div>
    </div>

    <!-- ===== ALERTAS ===== -->
    <div class="page" id="page-alertas">
      <div class="section-header">
        <div>
          <div class="section-title">Centro de Alertas</div>
          <div class="section-sub" id="alertas-sub">Notificaciones automÃ¡ticas del sistema</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="generarAlertas()">ğŸ”„ Actualizar</button>
      </div>
      <!-- Stat cards -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ”´</div></div><div class="stat-value" id="cnt-alertas-criticas">0</div><div class="stat-label">CrÃ­ticas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸŸ¡</div></div><div class="stat-value" id="cnt-alertas-advertencias">0</div><div class="stat-label">Advertencias</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ”µ</div></div><div class="stat-value" id="cnt-alertas-info">0</div><div class="stat-label">Informativas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">âœ…</div></div><div class="stat-value" id="cnt-alertas-leidas">0</div><div class="stat-label">LeÃ­das</div></div>
      </div>
      <!-- Filter buttons -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <button class="btn btn-sm" onclick="filtrarAlertas('todas')" style="background:var(--bg3);border:1px solid var(--border);">Todas</button>
        <button class="btn btn-sm" onclick="filtrarAlertas('critica')" style="background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.3);">ğŸ”´ CrÃ­ticas</button>
        <button class="btn btn-sm" onclick="filtrarAlertas('advertencia')" style="background:rgba(245,166,35,0.1);color:var(--accent);border:1px solid rgba(245,166,35,0.3);">ğŸŸ¡ Advertencias</button>
        <button class="btn btn-sm" onclick="filtrarAlertas('info')" style="background:rgba(59,130,246,0.1);color:var(--blue);border:1px solid rgba(59,130,246,0.3);">ğŸ”µ Info</button>
      </div>
      <div id="alertas-container">
        <div style="text-align:center;color:var(--muted);padding:40px;">
          <div style="font-size:48px;margin-bottom:12px;">ğŸ””</div>
          <div style="font-size:14px;">HacÃ© clic en "ğŸ”„ Actualizar" para generar las alertas</div>
        </div>
      </div>
    </div>

    <!-- ===== COTIZADOR ===== -->
    <div class="page" id="page-cotizador">
      <div class="section-header">
        <div><div class="section-title">Cotizador de Proyectos</div><div class="section-sub">CalculÃ¡ el costo antes de tu oferta</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" id="btn-volver-cotiz" onclick="ocultarFormCotiz()" style="display:none;">â† Volver</button>
          <button class="btn btn-ghost btn-sm" onclick="nuevaCotizacion()">ï¼‹ Nueva CotizaciÃ³n</button>
          <button class="btn btn-success btn-sm" id="btn-export-cotiz" onclick="exportCotizExcel()" style="display:none;">ğŸ“¥ Excel</button>
          <button class="btn btn-primary" id="btn-pdf-cotiz" onclick="exportCotizPDF()" style="display:none;">ğŸ“„ PDF</button>
        </div>
      </div>
      <div id="cotiz-lista-wrap">
        <div class="card"><div class="card-header"><div class="card-title">Cotizaciones Guardadas</div></div>
        <div id="cotiz-lista"><div style="text-align:center;color:var(--muted);padding:28px;">No hay cotizaciones. HacÃ© clic en "ï¼‹ Nueva CotizaciÃ³n".</div></div></div>
      </div>
      <div id="cotiz-form-wrap" style="display:none;">
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header"><div class="card-title">ğŸ“‹ Datos del Proyecto</div></div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="cot-nombre" placeholder="Ej: Edificio 8 pisos"></div>
            <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="cot-cliente" placeholder="Nombre del cliente"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="cot-tipo"><option>Residencial</option><option>Comercial</option><option>Industrial</option><option>Vial</option><option>Institucional</option></select></div>
            <div class="form-group"><label class="form-label">Ãrea</label><input type="text" class="form-input" id="cot-area" placeholder="Ej: 1,200 mÂ²"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">DuraciÃ³n (meses)</label><input type="number" class="form-input" id="cot-duracion" placeholder="18" min="1"></div>
            <div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input" id="cot-fecha"></div>
          </div>
          <div class="form-group"><label class="form-label">DescripciÃ³n</label><textarea class="form-input" id="cot-descripcion" rows="2" placeholder="Alcance de la obra..."></textarea></div>
        </div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">ğŸ§± Materiales</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('materiales')">ï¼‹</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Material</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-materiales"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL MATERIALES</td><td style="padding:10px 12px;font-weight:800;color:var(--accent);" id="sub-materiales">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">ğŸ‘· Mano de Obra</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('manodeobra')">ï¼‹</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Rol</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-manodeobra"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL MANO DE OBRA</td><td style="padding:10px 12px;font-weight:800;color:var(--blue);" id="sub-manodeobra">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">ğŸšœ Maquinaria</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('maquinaria')">ï¼‹</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Equipo</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-maquinaria"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL MAQUINARIA</td><td style="padding:10px 12px;font-weight:800;color:var(--purple);" id="sub-maquinaria">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">ğŸ”Œ Subcontratos</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('subcontratos')">ï¼‹</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Servicio</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-subcontratos"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL SUBCONTRATOS</td><td style="padding:10px 12px;font-weight:800;color:var(--green);" id="sub-subcontratos">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" id="cotiz-resumen">
          <div class="card-header"><div class="card-title">ğŸ’° Resumen & Precio Final</div></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">ğŸ§± Materiales</span><b id="res-materiales">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">ğŸ‘· Mano de Obra</span><b id="res-mdo">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">ğŸšœ Maquinaria</span><b id="res-maq">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">ğŸ”Œ Subcontratos</span><b id="res-sub">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg4);border-radius:10px;border:1px solid var(--border);"><b>Costo Directo</b><b id="res-costo-directo" style="font-size:16px;">S/ 0</b></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:14px;">
              <div><label class="form-label">Gastos Generales (%)</label><div style="display:flex;align-items:center;gap:10px;"><input type="range" id="slider-gg" min="0" max="30" value="10" step="1" oninput="recalcResumen()" style="flex:1;accent-color:var(--accent);"><b style="color:var(--accent);min-width:40px;text-align:right;" id="val-gg">10%</b></div></div>
              <div><label class="form-label">Utilidad (%)</label><div style="display:flex;align-items:center;gap:10px;"><input type="range" id="slider-util" min="0" max="40" value="15" step="1" oninput="recalcResumen()" style="flex:1;accent-color:var(--green);"><b style="color:var(--green);min-width:40px;text-align:right;" id="val-util">15%</b></div></div>
              <div><label class="form-label">IGV (%)</label><div style="display:flex;align-items:center;gap:10px;"><input type="range" id="slider-igv" min="0" max="25" value="18" step="1" oninput="recalcResumen()" style="flex:1;accent-color:var(--blue);"><b style="color:var(--blue);min-width:40px;text-align:right;" id="val-igv">18%</b></div></div>
              <div style="background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(232,82,26,0.1));border:1px solid rgba(245,166,35,0.3);border-radius:14px;padding:20px;text-align:center;">
                <div style="font-size:11px;color:var(--muted2);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">PRECIO FINAL OFERTA</div>
                <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:32px;color:var(--accent);" id="res-precio-final">S/ 0</div>
                <div style="font-size:11px;color:var(--muted);margin-top:6px;" id="res-desglose-final"></div>
              </div>
              <button class="btn btn-primary" style="width:100%;" onclick="guardarCotizacion()">ğŸ’¾ Guardar CotizaciÃ³n</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== USUARIOS & ROLES ===== -->
    <div class="page" id="page-usuarios">
      <div class="section-header">
        <div><div class="section-title">Usuarios & Roles</div><div class="section-sub" id="usuarios-sub">GestiÃ³n de accesos al sistema</div></div>
        <button class="btn btn-primary" onclick="openModal('usuario')">ï¼‹ Nuevo Usuario</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ‘¤</div></div><div class="stat-value" id="usr-total">0</div><div class="stat-label">Total Usuarios</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ›¡ï¸</div></div><div class="stat-value" id="usr-admins">0</div><div class="stat-label">Administradores</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">âœ…</div></div><div class="stat-value" id="usr-activos">0</div><div class="stat-label">Activos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ”’</div></div><div class="stat-value" id="usr-inactivos">0</div><div class="stat-label">Inactivos</div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Usuarios del Sistema</div></div>
        <div class="table-wrap hide-on-mobile">
          <table><thead><tr><th>Usuario</th><th>Rol</th><th>Proyecto Asignado</th><th>Ãšltimo Acceso</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="usuarios-table"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">Cargando usuarios...</td></tr></tbody></table>
        </div>
        <div class="mobile-cards" id="usuarios-mobile"></div>
      </div>
    </div>

    <!-- ===== PLANILLA DE SUELDOS ===== -->
    <div class="page" id="page-planilla">
      <div class="section-header">
        <div>
          <div class="section-title">Planilla de Sueldos</div>
          <div class="section-sub" id="planilla-sub">CÃ¡lculo automÃ¡tico de remuneraciones</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select class="form-input" id="planilla-mes" style="height:36px;padding:0 10px;width:160px;" onchange="calcularPlanilla()">
          </select>
          <button class="btn btn-success btn-sm" onclick="exportPlanillaExcel()">ğŸ“¥ Excel</button>
          <button class="btn btn-primary btn-sm" onclick="generarPlanillaPDF()">ğŸ“„ PDF Planilla</button>
        </div>
      </div>

      <!-- KPIs planilla -->
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ’°</div></div><div class="stat-value" id="plan-total-bruto">S/ 0</div><div class="stat-label">Total Bruto</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ“‰</div></div><div class="stat-value" id="plan-total-desc">S/ 0</div><div class="stat-label">Descuentos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ’µ</div></div><div class="stat-value" id="plan-total-neto">S/ 0</div><div class="stat-label">Total Neto</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ¢</div></div><div class="stat-value" id="plan-total-aportes">S/ 0</div><div class="stat-label">Aportes Empresa</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon purple">ğŸ‘·</div></div><div class="stat-value" id="plan-total-personal">0</div><div class="stat-label">Empleados</div></div>
      </div>

      <!-- Config aportes -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div class="card-title">âš™ï¸ ConfiguraciÃ³n de Aportes y Descuentos</div>
          <button class="btn btn-ghost btn-sm" onclick="togglePlanillaConfig()">Mostrar/Ocultar</button>
        </div>
        <div id="planilla-config" style="display:none;">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;padding:8px 0;">
            <div class="form-group"><label class="form-label">ONP / AFP (%)</label><input type="number" class="form-input" id="cfg-onp" value="13" min="0" max="20" step="0.1" onchange="calcularPlanilla()"></div>
            <div class="form-group"><label class="form-label">EsSalud Empresa (%)</label><input type="number" class="form-input" id="cfg-essalud" value="9" min="0" max="15" step="0.1" onchange="calcularPlanilla()"></div>
            <div class="form-group"><label class="form-label">CTS Mensual (%)</label><input type="number" class="form-input" id="cfg-cts" value="8.33" min="0" max="20" step="0.01" onchange="calcularPlanilla()"></div>
            <div class="form-group"><label class="form-label">GratificaciÃ³n (%)</label><input type="number" class="form-input" id="cfg-grat" value="16.67" min="0" max="25" step="0.01" onchange="calcularPlanilla()"></div>
          </div>
          <div style="font-size:11px;color:var(--muted2);padding:4px 0;">Los porcentajes se aplican sobre el sueldo bÃ¡sico mensual. PodÃ©s ajustarlos segÃºn tu rÃ©gimen laboral.</div>
        </div>
      </div>

      <!-- Tabla planilla -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">ğŸ“‹ Detalle por Empleado</div>
          <div style="font-size:12px;color:var(--muted2);" id="planilla-periodo-label">SeleccionÃ¡ un mes</div>
        </div>
        <div class="table-wrap hide-on-mobile" style="overflow-x:auto;">
          <table style="min-width:900px;">
            <thead>
              <tr>
                <th>Empleado</th><th>Rol</th><th>DÃ­as</th><th>H.Extra</th>
                <th>Sueldo BÃ¡sico</th><th>H.Extra S/</th><th>Asignaciones</th>
                <th style="color:var(--green);">Bruto</th>
                <th style="color:var(--red);">ONP/AFP</th>
                <th style="color:var(--accent);">EsSalud</th>
                <th style="color:var(--blue);">CTS</th>
                <th style="color:var(--purple);">Grat.</th>
                <th style="color:var(--green);font-weight:800;">NETO</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="planilla-table">
              <tr><td colspan="14" style="text-align:center;color:var(--muted);padding:28px;">SeleccionÃ¡ un mes para calcular la planilla.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="planilla-mobile"></div>
      </div>
    </div>

    <!-- ===== CONTRATOS & ACTAS ===== -->
    <div class="page" id="page-contratos">
      <div class="section-header">
        <div>
          <div class="section-title">Contratos & Actas</div>
          <div class="section-sub">GeneraciÃ³n automÃ¡tica de documentos legales</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="openModal('nuevo-contrato')">ï¼‹ Nuevo Documento</button>
        </div>
      </div>

      <!-- Tipos de documento -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px;">
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(245,166,35,0.3);" onclick="abrirGeneradorContrato('obra')">
          <div class="stat-header"><div class="stat-icon orange">ğŸ—ï¸</div></div>
          <div class="stat-value" style="font-size:16px;">Contrato de Obra</div>
          <div class="stat-label">Entre empresa y cliente</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(59,130,246,0.3);" onclick="abrirGeneradorContrato('personal')">
          <div class="stat-header"><div class="stat-icon blue">ğŸ‘·</div></div>
          <div class="stat-value" style="font-size:16px;">Contrato de Personal</div>
          <div class="stat-label">Contrato laboral individual</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(34,197,94,0.3);" onclick="abrirGeneradorContrato('entrega')">
          <div class="stat-header"><div class="stat-icon green">âœ…</div></div>
          <div class="stat-value" style="font-size:16px;">Acta de Entrega</div>
          <div class="stat-label">Entrega final de obra al cliente</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(168,85,247,0.3);" onclick="abrirGeneradorContrato('subcontrato')">
          <div class="stat-header"><div class="stat-icon purple">ğŸ¤</div></div>
          <div class="stat-value" style="font-size:16px;">Subcontrato</div>
          <div class="stat-label">Con subcontratistas y terceros</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(239,68,68,0.3);" onclick="abrirGeneradorContrato('adicional')">
          <div class="stat-header"><div class="stat-icon red">ğŸ“</div></div>
          <div class="stat-value" style="font-size:16px;">Acta de Adicional</div>
          <div class="stat-label">Trabajos fuera del contrato original</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(6,182,212,0.3);" onclick="abrirGeneradorContrato('finiquito')">
          <div class="stat-header"><div class="stat-icon" style="background:rgba(6,182,212,0.15);color:#06b6d4;">ğŸ“‹</div></div>
          <div class="stat-value" style="font-size:16px;">Finiquito Laboral</div>
          <div class="stat-label">LiquidaciÃ³n al tÃ©rmino del contrato</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
      </div>

      <!-- Historial de documentos -->
      <div class="card">
        <div class="card-header"><div class="card-title">ğŸ“ Documentos Generados</div></div>
        <div id="contratos-historial">
          <div style="text-align:center;color:var(--muted);padding:32px;">
            GenerÃ¡ tu primer documento haciendo clic en uno de los tipos de arriba.
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>
</div><!-- /app -->

<!-- ===== MODALES ===== -->

<!-- MODAL GENERADOR DE CONTRATOS -->
<div class="modal-overlay" id="modal-nuevo-contrato">
  <div class="modal" style="max-width:620px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header">
      <div class="modal-title" id="contrato-modal-title">Generar Contrato</div>
      <button class="modal-close" onclick="closeModal('nuevo-contrato')">âœ•</button>
    </div>
    <input type="hidden" id="contrato-tipo">
    <div id="contrato-form-fields"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('nuevo-contrato')">Cancelar</button>
      <button class="btn btn-success btn-sm" onclick="previsualizarContrato()">ğŸ‘ Previsualizar</button>
      <button class="btn btn-primary" onclick="generarContratoPDF()">ğŸ“„ Generar PDF</button>
    </div>
  </div>
</div>

<!-- MODAL RECIBO SUELDO -->
<div class="modal-overlay" id="modal-recibo">
  <div class="modal" style="max-width:500px;">
    <div class="modal-header">
      <div class="modal-title">Recibo de Sueldo</div>
      <button class="modal-close" onclick="closeModal('recibo')">âœ•</button>
    </div>
    <div id="recibo-preview" style="background:#fff;color:#1e293b;padding:20px;border-radius:8px;font-family:Arial,sans-serif;font-size:12px;line-height:1.6;"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('recibo')">Cerrar</button>
      <button class="btn btn-primary" onclick="imprimirRecibo()">ğŸ–¨ï¸ Imprimir / PDF</button>
    </div>
  </div>
</div>

<!-- MODAL IMPORTAR EXCEL -->
<div class="modal-overlay" id="modal-importar">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <div class="modal-title">ğŸ“¤ Importar desde Excel</div>
      <button class="modal-close" onclick="closeModal('importar')">âœ•</button>
    </div>
    <div class="form-group">
      <label class="form-label">Â¿QuÃ© querÃ©s importar? *</label>
      <select class="form-input" id="import-tipo" onchange="updateImportTemplate()">
        <option value="personal">ğŸ‘· Personal</option>
        <option value="proyectos">ğŸ—ï¸ Proyectos</option>
        <option value="maquinaria">ğŸšœ Maquinaria</option>
        <option value="materiales">ğŸ“¦ Materiales</option>
        <option value="proveedores">ğŸª Proveedores</option>
      </select>
    </div>
    <div style="background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid var(--border);">
      <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px;">ğŸ“‹ Columnas requeridas:</div>
      <div id="import-columns" style="font-size:12px;color:var(--muted2);line-height:1.8;"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px;font-size:11px;" onclick="downloadImportTemplate()">â¬‡ï¸ Descargar plantilla de ejemplo</button>
    </div>
    <div class="form-group">
      <label class="form-label">Archivo Excel (.xlsx, .xls, .csv) *</label>
      <input type="file" class="form-input" id="import-file" accept=".xlsx,.xls,.csv" onchange="previewImport(this)" style="padding:8px;">
    </div>
    <div id="import-preview" style="display:none;background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:14px;max-height:200px;overflow-y:auto;border:1px solid var(--border);">
      <div style="font-size:12px;font-weight:700;color:var(--green);margin-bottom:8px;" id="import-preview-title">Vista previa</div>
      <div id="import-preview-content"></div>
    </div>
    <div id="import-result" style="display:none;"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('importar')">Cancelar</button>
      <button class="btn btn-primary" id="import-btn" onclick="executeImport()" disabled>ğŸ“¤ Importar datos</button>
    </div>
  </div>
</div>

<!-- MODAL USO MAQUINARIA -->
<div class="modal-overlay" id="modal-uso-maquina">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-uso-title">Registrar Uso de Equipo</div>
      <button class="modal-close" onclick="closeModal('uso-maquina')">âœ•</button>
    </div>
    <input type="hidden" id="uso-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Equipo *</label>
        <select class="form-input" id="uso-maquina-sel"></select>
      </div>
      <div class="form-group"><label class="form-label">Fecha *</label>
        <input type="date" class="form-input" id="uso-fecha">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo de registro</label>
        <select class="form-input" id="uso-tipo">
          <option value="uso">âš™ï¸ Uso / Trabajo</option>
          <option value="combustible">â›½ Carga de combustible</option>
          <option value="mantenimiento">ğŸ”§ Mantenimiento</option>
          <option value="revision">ğŸ” RevisiÃ³n tÃ©cnica</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Proyecto</label>
        <select class="form-input" id="uso-proyecto">
          <option value="">â€” Sin proyecto â€”</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas trabajadas</label>
        <input type="number" class="form-input" id="uso-horas" value="0" min="0" max="24" step="0.5">
      </div>
      <div class="form-group"><label class="form-label">Combustible (litros)</label>
        <input type="number" class="form-input" id="uso-combustible" value="0" min="0" step="0.5">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Costo combustible (S/)</label>
        <input type="number" class="form-input" id="uso-costo-comb" value="0" min="0" step="0.01">
      </div>
      <div class="form-group"><label class="form-label">Operador</label>
        <input type="text" class="form-input" id="uso-operador" placeholder="Nombre del operador">
      </div>
    </div>
    <div class="form-group"><label class="form-label">ObservaciÃ³n</label>
      <input type="text" class="form-input" id="uso-obs" placeholder="Novedades, incidencias, etc.">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('uso-maquina')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveUsoMaquina()">ğŸ’¾ Guardar</button>
    </div>
  </div>
</div>

<!-- PROYECTO MODAL -->
<div class="modal-overlay" id="modal-proyecto">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-proyecto-title">Nuevo Proyecto</div>
      <button class="modal-close" onclick="closeModal('proyecto')">âœ•</button>
    </div>
    <input type="hidden" id="proyecto-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre del Proyecto *</label><input type="text" class="form-input" id="p-nombre" placeholder="Ej: Torre Central"></div>
      <div class="form-group"><label class="form-label">Tipo *</label>
        <select class="form-input" id="p-tipo">
          <option value="Residencial">Residencial</option>
          <option value="Comercial">Comercial</option>
          <option value="Industrial">Industrial</option>
          <option value="Infraestructura">Infraestructura</option>
          <option value="Institucional">Institucional</option>
          <option value="Vial">Vial</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="p-cliente" placeholder="Nombre del cliente"></div>
      <div class="form-group"><label class="form-label">Presupuesto (USD) *</label><input type="number" class="form-input" id="p-presupuesto" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha Inicio</label><input type="date" class="form-input" id="p-inicio"></div>
      <div class="form-group"><label class="form-label">Fecha Fin Est.</label><input type="date" class="form-input" id="p-fin"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">UbicaciÃ³n</label><input type="text" class="form-input" id="p-ubicacion" placeholder="DirecciÃ³n de la obra"></div>
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="p-estado">
          <option value="pendiente">Pendiente / Iniciando</option>
          <option value="activo">Activo</option>
          <option value="progreso">En Curso</option>
          <option value="finalizado">Finalizado</option>
          <option value="pausado">Pausado</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Avance FÃ­sico (%)</label><input type="number" class="form-input" id="p-avance" placeholder="0" min="0" max="100"></div>
    <div class="form-group"><label class="form-label">DescripciÃ³n</label><textarea class="form-input" id="p-descripcion" placeholder="DescripciÃ³n del proyecto..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveProyecto()">Guardar Proyecto</button>
      <button class="btn btn-ghost" onclick="closeModal('proyecto')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PERSONAL MODAL -->
<div class="modal-overlay" id="modal-personal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-personal-title">Agregar Personal</div>
      <button class="modal-close" onclick="closeModal('personal')">âœ•</button>
    </div>
    <input type="hidden" id="emp-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre Completo *</label><input type="text" class="form-input" id="emp-nombre" placeholder="Nombre y apellido"></div>
      <div class="form-group"><label class="form-label">CÃ©dula / DNI *</label><input type="text" class="form-input" id="emp-ci" placeholder="Ej: 1.234.567-8"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rol / Cargo *</label>
        <select class="form-input" id="emp-rol">
          <option>AlbaÃ±il</option><option>Jefe de Cuadrilla</option><option>Electricista</option>
          <option>Plomero</option><option>Operador de Maquinaria</option><option>Carpintero</option>
          <option>Soldador</option><option>Pintor</option><option>Capataz</option>
          <option>Arquitecto</option><option>Ingeniero Civil</option><option>Administrador</option><option>Otro</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Cuadrilla</label><input type="text" class="form-input" id="emp-cuadrilla" placeholder="Ej: A-01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo de Contrato *</label>
        <select class="form-input" id="emp-tipo">
          <option value="planilla">En Planilla</option>
          <option value="contrato">Contrato</option>
          <option value="jornal">Jornalero</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Sueldo Base (S//mes)</label><input type="number" class="form-input" id="emp-sueldo" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas (mes)</label><input type="number" class="form-input" id="emp-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Proyecto Asignado</label>
        <select class="form-input" id="emp-proyecto"><option value="">Sin asignar</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input type="text" class="form-input" id="emp-tel" placeholder="Ej: 099 123 456"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="text" class="form-input" id="emp-email" placeholder="correo@ejemplo.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha de Contrato</label><input type="date" class="form-input" id="emp-fecha-contrato"></div>
      <div class="form-group"><label class="form-label">Fecha Fin de Contrato</label><input type="date" class="form-input" id="emp-fecha-fin"></div>
    </div>
    <div class="form-group"><label class="form-label">DirecciÃ³n</label><input type="text" class="form-input" id="emp-dir" placeholder="DirecciÃ³n del empleado"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="emp-obs" placeholder="Notas adicionales..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="savePersonal()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeModal('personal')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PERSONAL DETAIL MODAL -->
<div class="modal-overlay" id="modal-personal-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">Ficha del Empleado</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary btn-sm" onclick="generarBoletaPDF()">ğŸ“„ Boleta PDF</button>
        <button class="btn btn-success btn-sm" onclick="exportPersonaExcel()">ğŸ“¥ Excel</button>
        <button class="btn btn-ghost btn-sm" id="btn-edit-emp" onclick="editPersonal()">âœï¸ Editar</button>
        <button class="modal-close" onclick="closeModal('personal-detail')">âœ•</button>
      </div>
    </div>
    <div id="personal-detail-content"></div>
  </div>
</div>

<!-- MAQUINA MODAL -->
<div class="modal-overlay" id="modal-maquina">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-maquina-title">Registrar Equipo</div>
      <button class="modal-close" onclick="closeModal('maquina')">âœ•</button>
    </div>
    <input type="hidden" id="maq-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre del Equipo *</label><input type="text" class="form-input" id="maq-nombre" placeholder="Ej: GrÃºa Torre #1"></div>
      <div class="form-group"><label class="form-label">Tipo</label>
        <select class="form-input" id="maq-tipo">
          <option>GrÃºa Torre</option><option>Retroexcavadora</option><option>Bulldozer</option>
          <option>CamiÃ³n Volquete</option><option>Hormigonera</option><option>Compactadora</option>
          <option>Martillo HidrÃ¡ulico</option><option>Cargador Frontal</option><option>Andamio Motorizado</option><option>Otro</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Modelo / Marca</label><input type="text" class="form-input" id="maq-modelo" placeholder="Ej: Caterpillar 320"></div>
      <div class="form-group"><label class="form-label">MatrÃ­cula / CÃ³digo</label><input type="text" class="form-input" id="maq-matricula" placeholder="Ej: CAT-001"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas (mes)</label><input type="number" class="form-input" id="maq-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Tarifa por Hora (S/)</label><input type="number" class="form-input" id="maq-tarifa" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Costo Operativo/Hora (S/)</label><input type="number" class="form-input" id="maq-costo-hora" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Proyecto Asignado</label>
        <select class="form-input" id="maq-proyecto"><option value="">Sin asignar</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="maq-estado">
          <option value="activo">Operativo</option>
          <option value="pausado">En Mantenimiento</option>
          <option value="pendiente">Reservado</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">PrÃ³ximo Mantenimiento</label><input type="date" class="form-input" id="maq-mantenim"></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="maq-obs" placeholder="Notas..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveMaquina()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeModal('maquina')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MAQUINA DETAIL MODAL -->
<div class="modal-overlay" id="modal-maquina-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">Detalle del Equipo</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-success btn-sm" onclick="exportMaquinaExcel()">ğŸ“¥ Excel</button>
        <button class="btn btn-ghost btn-sm" id="btn-edit-maq" onclick="editMaquina()">âœï¸ Editar</button>
        <button class="modal-close" onclick="closeModal('maquina-detail')">âœ•</button>
      </div>
    </div>
    <div id="maquina-detail-content"></div>
  </div>
</div>

<!-- USUARIO MODAL -->
<div class="modal-overlay" id="modal-usuario">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-usr-title">Nuevo Usuario</div>
      <button class="modal-close" onclick="closeModal('usuario')">âœ•</button>
    </div>
    <input type="hidden" id="usr-id">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Nombre completo *</label>
        <input type="text" class="form-input" id="usr-nombre" placeholder="Ej: Juan PÃ©rez">
      </div>
      <div class="form-group">
        <label class="form-label">Usuario (login) *</label>
        <input type="text" class="form-input" id="usr-user" placeholder="Ej: jperez" autocomplete="off">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">ContraseÃ±a *</label>
        <input type="password" class="form-input" id="usr-pass" placeholder="MÃ­n. 4 caracteres" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">Confirmar contraseÃ±a</label>
        <input type="password" class="form-input" id="usr-pass2" placeholder="Repetir contraseÃ±a" autocomplete="new-password">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Rol *</label>
        <select class="form-input" id="usr-rol" onchange="updateRolDescription()">
          <option value="">Seleccionar rol...</option>
          <option value="admin">ğŸ‘‘ Administrador â€” Acceso total</option>
          <option value="supervisor">ğŸ” Supervisor â€” Ve todo, gestiona obras</option>
          <option value="capataz">ğŸ‘· Capataz â€” Parte diario, su cuadrilla</option>
          <option value="contador">ğŸ’¼ Contador â€” Finanzas y presupuestos</option>
          <option value="cliente">ğŸ‘ Cliente â€” Solo su proyecto</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Proyecto asignado</label>
        <select class="form-input" id="usr-proyecto">
          <option value="">Todos los proyectos</option>
        </select>
      </div>
    </div>
    <div id="usr-rol-desc" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--muted2);display:none;"></div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" class="form-input" id="usr-email" placeholder="correo@empresa.com">
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveUsuario()">Guardar Usuario</button>
      <button class="btn btn-ghost" onclick="closeModal('usuario')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PRESUPUESTO MODAL -->
<div class="modal-overlay" id="modal-presupuesto">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modal-pres-title">Nuevo Presupuesto</div><button class="modal-close" onclick="closeModal('presupuesto')">âœ•</button></div>
    <input type="hidden" id="pres-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre / DescripciÃ³n *</label><input type="text" class="form-input" id="pres-nombre" placeholder="Ej: Residencial La CaÃ±ada"></div>
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="pres-cliente" placeholder="Nombre del cliente"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Monto (S/) *</label><input type="number" class="form-input" id="pres-monto" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Fecha EnvÃ­o</label><input type="date" class="form-input" id="pres-fecha"></div>
    </div>
    <div class="form-group"><label class="form-label">Estado</label>
      <select class="form-input" id="pres-estado">
        <option value="revision">En RevisiÃ³n</option><option value="aprobado">Aprobado</option>
        <option value="negociacion">NegociaciÃ³n</option><option value="rechazado">Rechazado</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="pres-obs" placeholder="Notas..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="savePresupuesto()">Guardar</button><button class="btn btn-ghost" onclick="closeModal('presupuesto')">Cancelar</button></div>
  </div>
</div>

<!-- FACTURA MODAL -->
<div class="modal-overlay" id="modal-factura">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Nueva Factura</div><button class="modal-close" onclick="closeModal('factura')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">NÂ° Factura *</label><input type="text" class="form-input" id="fac-numero" placeholder="Ej: #2025-0900"></div>
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="fac-cliente" placeholder="Nombre del cliente"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="fac-proyecto"><option value="">Sin asignar</option></select></div>
      <div class="form-group"><label class="form-label">Monto (S/) *</label><input type="number" class="form-input" id="fac-monto" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha EmisiÃ³n</label><input type="date" class="form-input" id="fac-fecha"></div>
      <div class="form-group"><label class="form-label">Fecha Vencimiento</label><input type="date" class="form-input" id="fac-vence"></div>
    </div>
    <div class="form-group"><label class="form-label">Estado</label>
      <select class="form-input" id="fac-estado"><option value="pendiente">Pendiente</option><option value="activo">Cobrada</option><option value="pausado">Vencida</option></select>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveFactura()">Guardar Factura</button><button class="btn btn-ghost" onclick="closeModal('factura')">Cancelar</button></div>
  </div>
</div>

<!-- PROVEEDOR MODAL -->
<div class="modal-overlay" id="modal-proveedor">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Nuevo Proveedor</div><button class="modal-close" onclick="closeModal('proveedor')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="prov-nombre" placeholder="Nombre de la empresa"></div>
      <div class="form-group"><label class="form-label">RUT / RUC</label><input type="text" class="form-input" id="prov-rut" placeholder="Ej: 21234567891"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rubro</label><input type="text" class="form-input" id="prov-rubro" placeholder="Ej: HormigÃ³n Pronto"></div>
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input type="text" class="form-input" id="prov-tel" placeholder="Ej: 098 123 456"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveProveedor()">Guardar</button><button class="btn btn-ghost" onclick="closeModal('proveedor')">Cancelar</button></div>
  </div>
</div>

<!-- MATERIAL MODAL -->
<div class="modal-overlay" id="modal-material">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Registrar Movimiento de Material</div><button class="modal-close" onclick="closeModal('material')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Material *</label><input type="text" class="form-input" id="mat-nombre" placeholder="Ej: Cemento Portland"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="mat-tipo"><option value="ENTRADA">ENTRADA</option><option value="SALIDA">SALIDA</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Cantidad</label><input type="text" class="form-input" id="mat-cantidad" placeholder="Ej: 200 bolsas"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="mat-proyecto"><option value="">Sin asignar</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Responsable</label><input type="text" class="form-input" id="mat-resp" placeholder="Nombre del responsable"></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveMaterial()">Registrar</button><button class="btn btn-ghost" onclick="closeModal('material')">Cancelar</button></div>
  </div>
</div>

<!-- PARTE DIARIO MODAL -->
<div class="modal-overlay" id="modal-parte">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Registrar Parte Diario</div><button class="modal-close" onclick="closeModal('parte')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Obra / Proyecto</label><select class="form-input" id="parte-proyecto"><option value="">Seleccionar...</option></select></div>
      <div class="form-group"><label class="form-label">Cuadrilla</label><input type="text" class="form-input" id="parte-cuadrilla" placeholder="Ej: A-01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Actividad Realizada</label><input type="text" class="form-input" id="parte-actividad" placeholder="Ej: Hormigonado piso 8"></div>
      <div class="form-group"><label class="form-label">NÂ° Obreros</label><input type="number" class="form-input" id="parte-obreros" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas</label><input type="number" class="form-input" id="parte-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">CondiciÃ³n ClimÃ¡tica</label><select class="form-input" id="parte-clima"><option>Despejado</option><option>Nublado</option><option>Lluvia</option><option>Viento fuerte</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones / Incidencias</label><textarea class="form-input" id="parte-obs" placeholder="Anotar cualquier novedad..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveParte()">Registrar Parte</button><button class="btn btn-ghost" onclick="closeModal('parte')">Cancelar</button></div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="modal-overlay" id="modal-confirm">
  <div class="modal confirm-modal">
    <div class="modal-header"><div class="modal-title">âš ï¸ Confirmar EliminaciÃ³n</div><button class="modal-close" onclick="closeModal('confirm')">âœ•</button></div>
    <p style="color:var(--muted2);font-size:14px;margin-bottom:20px;" id="confirm-msg">Â¿EstÃ¡s seguro de que querÃ©s eliminar este registro? Esta acciÃ³n no se puede deshacer.</p>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-danger" style="flex:1" id="confirm-ok">SÃ­, Eliminar</button>
      <button class="btn btn-ghost" onclick="closeModal('confirm')">Cancelar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-title" id="toast-title"></div>
  <div class="toast-msg" id="toast-msg"></div>
</div>

<!-- MODAL MOVIMIENTO FLUJO CAJA -->
<div class="modal-overlay" id="modal-movimiento">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="mov-modal-title">Registrar Movimiento</div>
      <button class="modal-close" onclick="document.getElementById('modal-movimiento').classList.remove('open')">âœ•</button>
    </div>
    <input type="hidden" id="mov-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo *</label>
        <select id="mov-tipo" class="form-input">
          <option value="ingreso">â–² Ingreso</option>
          <option value="egreso">â–¼ Egreso</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Monto (S/) *</label>
        <input type="number" id="mov-monto" class="form-input" placeholder="0.00" min="0" step="0.01">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">CategorÃ­a</label>
        <select id="mov-categoria" class="form-input">
          <option value="cobro_cliente">Cobro cliente</option>
          <option value="anticipo">Anticipo</option>
          <option value="pago_proveedor">Pago proveedor</option>
          <option value="planilla">Planilla</option>
          <option value="maquinaria">Maquinaria</option>
          <option value="materiales">Materiales</option>
          <option value="gastos_generales">Gastos generales</option>
          <option value="impuestos">Impuestos</option>
          <option value="otro">Otro</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Fecha *</label>
        <input type="date" id="mov-fecha" class="form-input">
      </div>
    </div>
    <div class="form-group"><label class="form-label">Proyecto</label>
      <select id="mov-proyecto" class="form-input">
        <option value="">Sin proyecto especÃ­fico</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">DescripciÃ³n</label>
        <input type="text" id="mov-descripcion" class="form-input" placeholder="DescripciÃ³n del movimiento...">
      </div>
      <div class="form-group"><label class="form-label">Referencia / NÂº Doc.</label>
        <input type="text" id="mov-referencia" class="form-input" placeholder="Ej: FAC-001">
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="guardarMovimiento()">ğŸ’¾ Guardar</button>
      <button class="btn btn-ghost" onclick="document.getElementById('modal-movimiento').classList.remove('open')">Cancelar</button>
    </div>
  </div>
</div>

<script>
// ===================== SUPABASE CONFIG =====================
// IMPORTANTE: La SB_KEY debe ser la "anon public key" de tu proyecto Supabase
// Formato correcto: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
// La encontrÃ¡s en: Supabase â†’ Settings â†’ API â†’ "anon public"
const SB_URL = 'https://kvyaksujublfwbgkarnf.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2eWFrc3VqdWJsZndiZ2thcm5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDYxNjcsImV4cCI6MjA4Nzc4MjE2N30.45cU843djkRkdudCPPpGFCtbjkWS_vGe6R8vWHWXFzU';

async function sbFetch(path, opts = {}) {
  const res = await fetch(SB_URL + '/rest/v1/' + path, {
    headers: {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Content-Type': 'application/json',
      'Prefer': opts.prefer || 'return=representation',
      ...opts.headers
    },
    method: opts.method || 'GET',
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  if (!res.ok) {
    const errText = await res.text();
    let errMsg = 'Error ' + res.status;
    if (res.status === 401) errMsg = 'API Key invÃ¡lida â€” actualizÃ¡ SB_KEY con la "anon public key" de tu proyecto Supabase';
    else if (res.status === 0 || !res.status) errMsg = 'Sin conexiÃ³n a internet';
    throw new Error(errMsg + ': ' + errText.slice(0,100));
  }
  const text = await res.text();
  return text ? JSON.parse(text) : [];
}

// ===================== DATA STORE =====================
let db = {
  proyectos: [],
  personal: [],
  maquinaria: [],
  presupuestos: [],
  facturas: [],
  proveedores: [],
  materiales: []
};

// â”€â”€ Aliases globales â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Las funciones de Asistencia, Flujo de Caja y Alertas usan las variables
// "proyectos", "personal", etc. directamente. Con defineProperty hacemos que
// esas variables siempre apunten a db.xxx sin tener que tocar cada funciÃ³n.
['proyectos','personal','maquinaria','presupuestos','facturas','materiales','proveedores'].forEach(key => {
  Object.defineProperty(window, key, { get: () => db[key], configurable: true });
});
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let currentPersonalId = null;
let currentMaquinaId = null;
let currentFilter = { proyectos: 'todos', personal: '', personalStatus: '' };

// ===================== AUTH =====================
const USERS = [{ user: 'admin', pass: '1234', name: 'Administrador', initials: 'AD' }];

function doLogin() {
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value.trim();

  // 1. Check custom app users (from Supabase, already loaded in cache or local fallback)
  // Try to load from local cache first for fast login, Supabase sync happens after
  let localUsers = [];
  try { localUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); } catch(e) {}
  const appUser = localUsers.find(x => x.user === u && x.pass === p && x.activo !== false);

  // 2. Check built-in admin
  const found = USERS.find(x => x.user === u && x.pass === p);

  if (!appUser && !found) {
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-pass').value = '';
    return;
  }

  const userName = appUser ? appUser.nombre : found.name;
  const userInitials = appUser ? (appUser.nombre||u).split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase() : found.initials;
  const effectiveRole = appUser ? appUser.rol : 'admin';

  document.getElementById('sidebar-name').textContent = userName;
  document.getElementById('sidebar-avatar').textContent = userInitials;
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');

  // Store session
  window._sessionRole = effectiveRole;
  window._sessionUser = u;

  showLoading(true);
  loadAllData().then(() => {
    showLoading(false);
    setTimeout(() => applyRolePermissions(effectiveRole), 100);
    renderDashboard();
    setTimeout(initDashCharts, 120);
    setTimeout(() => { applyResponsiveClasses(); makeTablesResponsive(); }, 200);
    toast('Â¡Bienvenido, ' + userName + '!', 'Rol: ' + effectiveRole);
    setTimeout(checkContractAlerts, 1500);
  }).catch(err => {
    showLoading(false);
    // Don't block login on connection error â€” show warning but continue
    toast('âš ï¸ Sin conexiÃ³n a BD', 'Trabajando con datos locales', 'warn');
    renderDashboard();
    setTimeout(initDashCharts, 120);
    setTimeout(() => { applyResponsiveClasses(); makeTablesResponsive(); }, 200);
    setTimeout(() => applyRolePermissions(effectiveRole), 100);
    console.error('Supabase error:', err);
  });
}

document.getElementById('login-pass').addEventListener('keydown', e => { if(e.key === 'Enter') doLogin(); });
document.getElementById('login-user').addEventListener('keydown', e => { if(e.key === 'Enter') document.getElementById('login-pass').focus(); });

function doLogout() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').style.display = 'none';
  db = { proyectos:[], personal:[], maquinaria:[], presupuestos:[], facturas:[], proveedores:[], materiales:[] };
}

function showLoading(show) {
  let el = document.getElementById('loading-overlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loading-overlay';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(13,15,18,0.85);z-index:998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;';
    el.innerHTML = '<div style="width:44px;height:44px;border:3px solid rgba(245,166,35,0.2);border-top-color:#f5a623;border-radius:50%;animation:spin 0.8s linear infinite;"></div><div style="font-family:Syne,sans-serif;font-size:14px;color:#94a3b8;">Cargando datos...</div><style>@keyframes spin{to{transform:rotate(360deg);}}</style>';
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

// ===================== LOAD ALL DATA FROM SUPABASE =====================
async function loadAllData() {
  let proyectos=[], personal=[], maquinaria=[], presupuestos=[], facturas=[], proveedores=[], materiales=[];
  try {
    [proyectos, personal, maquinaria, presupuestos, facturas, proveedores, materiales] = await Promise.all([
      sbFetch('proyectos?order=created_at.desc'),
      sbFetch('personal?order=created_at.desc'),
      sbFetch('maquinaria?order=created_at.desc'),
      sbFetch('presupuestos?order=created_at.desc'),
      sbFetch('facturas?order=created_at.desc'),
      sbFetch('proveedores?order=created_at.desc'),
      sbFetch('materiales?order=created_at.desc&limit=50'),
    ]);
  } catch(err) {
    console.warn('Supabase no disponible, trabajando offline:', err.message);
    refreshAll();
    throw err; // Re-throw so doLogin can show soft warning
  }

  // Map Supabase column names to app field names
  db.proyectos = proyectos.map(p => ({
    id: p.id, nombre: p.nombre, tipo: p.tipo, cliente: p.cliente,
    presupuesto: p.presupuesto, avance: p.avance, estado: p.estado,
    inicio: p.inicio, fin: p.fin,
    fechaFin: p.fin,        // alias usado por alertas
    fecha_fin: p.fin,       // alias alternativo
    ubicacion: p.ubicacion, descripcion: p.descripcion
  }));

  db.personal = personal.map(e => ({
    id: e.id, nombre: e.nombre, ci: e.ci, rol: e.rol, cuadrilla: e.cuadrilla,
    tipo: e.tipo, sueldo: e.sueldo, horas: e.horas,
    estado: e.estado || 'activo',
    proyecto: e.proyecto_id, tel: e.telefono, email: e.email, dir: e.direccion, obs: e.observaciones,
    fechaContrato: e.fecha_contrato, fechaFin: e.fecha_fin_contrato
  }));

  db.maquinaria = maquinaria.map(m => ({
    id: m.id, nombre: m.nombre, tipo: m.tipo, modelo: m.modelo, matricula: m.matricula,
    horas: m.horas, tarifa: m.tarifa, costoHora: m.costo_hora,
    proyecto: m.proyecto_id, estado: m.estado, mantenim: m.proximo_mantenimiento,
    proxMantenimiento: m.proximo_mantenimiento, // alias para alertas
    obs: m.observaciones
  }));

  db.presupuestos = presupuestos.map(p => ({
    id: p.id, nombre: p.nombre, cliente: p.cliente, monto: p.monto,
    fecha: p.fecha, estado: p.estado, obs: p.observaciones
  }));

  db.facturas = facturas.map(f => ({
    id: f.id, numero: f.numero, cliente: f.cliente, proyecto: f.proyecto_id,
    monto: f.monto, fecha: f.fecha_emision,
    vence: f.fecha_vencimiento,
    fechaVencimiento: f.fecha_vencimiento,   // alias para alertas
    fecha_vencimiento: f.fecha_vencimiento,  // alias alternativo
    estado: f.estado
  }));

  db.proveedores = proveedores.map(p => ({
    id: p.id, nombre: p.nombre, rut: p.rut, rubro: p.rubro, tel: p.telefono, estado: p.estado
  }));

  db.materiales = materiales.map(m => ({
    id: m.id, nombre: m.nombre, tipo: m.tipo, cantidad: m.cantidad,
    proyecto: m.proyecto_id, responsable: m.responsable, fecha: m.fecha
  }));

  // TambiÃ©n cargar usuarios y cotizaciones desde Supabase
  await Promise.allSettled([
    loadUsuariosSB(),
    loadCotizacionesSB(),
    loadMovimientosSB()
  ]);

  refreshAll();
  setTimeout(checkAlertasBadge, 200);
}

// ===================== RESPONSIVE HELPERS =====================
function makeTablesResponsive() {
  document.querySelectorAll('.table-wrap table').forEach(table => {
    table.classList.add('resp-table');
    const headers = [...table.querySelectorAll('thead th')].map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      [...tr.querySelectorAll('td')].forEach((td, i) => {
        if (headers[i]) td.setAttribute('data-label', headers[i]);
      });
    });
  });
}

// Auto-apply responsive classes to inline grids
function applyResponsiveClasses() {
  // Dashboard 2-col grids
  document.querySelectorAll('#page-dashboard > .content > [style*="grid-template-columns:2fr 1fr"], #page-dashboard [style*="grid-template-columns:2fr 1fr"]').forEach(el => el.classList.add('dash-two-col'));
  document.querySelectorAll('#page-dashboard [style*="grid-template-columns:1fr 1fr"]').forEach(el => el.classList.add('dash-two-col'));
  // Obras grid
  document.querySelectorAll('#page-obras [style*="grid-template-columns:2fr 1fr"]').forEach(el => el.classList.add('obras-grid'));
  // Reportes charts
  document.querySelectorAll('#page-reportes [style*="grid-template-columns:1fr 1fr"]').forEach(el => el.classList.add('charts-two-col'));
  // Sub stats
  document.querySelectorAll('#page-facturacion [style*="repeat(3"], #page-presupuestos [style*="repeat(3"]').forEach(el => el.classList.add('sub-stats-3'));
  document.querySelectorAll('#page-maquinaria [style*="repeat(4"], #page-presupuestos [style*="repeat(4"], #page-reportes [style*="repeat(4"], #page-obras [style*="repeat(4"]').forEach(el => el.classList.add('sub-stats-4'));
  // Filter rows
  document.querySelectorAll('.card > div[style*="display:flex"][style*="align-items:center"]').forEach(el => el.classList.add('filter-row'));
  // Topbar search
  document.querySelector('.topbar .search-bar')?.classList.add('top-search');
}

// ===================== SIDEBAR TOGGLE (MOBILE) =====================
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const open    = sidebar.classList.toggle('open');
  overlay.classList.toggle('open', open);
  document.body.style.overflow = open ? 'hidden' : '';
}

function closeSidebarOnMobile() {
  if (window.innerWidth <= 1024) {
    document.querySelector('.sidebar')?.classList.remove('open');
    document.getElementById('sidebar-overlay')?.classList.remove('open');
    document.body.style.overflow = '';
  }
}

window.addEventListener('resize', () => {
  if (window.innerWidth > 1024) {
    document.querySelector('.sidebar')?.classList.remove('open');
    document.getElementById('sidebar-overlay')?.classList.remove('open');
    document.body.style.overflow = '';
  }
});

// ===================== NAVIGATION =====================
function nav(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (el) el.classList.add('active');
  const titles = { dashboard: 'Dashboard General', proyectos: 'GestiÃ³n de Proyectos', personal: 'Personal & Cuadrillas', maquinaria: 'Parque de Maquinaria', obras: 'Obras en Curso', presupuestos: 'Presupuestos', materiales: 'Control de Materiales', proveedores: 'Proveedores', facturacion: 'FacturaciÃ³n', reportes: 'Reportes & AnalÃ­tica', cotizador: 'Cotizador de Proyectos', asistencia: 'Control de Asistencia', flujocaja: 'Flujo de Caja', alertas: 'Centro de Alertas' };
  document.getElementById('page-title').textContent = titles[page] || page;
  closeSidebarOnMobile();
  if (page === 'proyectos') renderProyectos();
  if (page === 'personal') renderPersonal();
  if (page === 'maquinaria') renderMaquinaria();
  if (page === 'dashboard') { renderDashboard(); setTimeout(initDashCharts, 60); }
  if (page === 'reportes') { renderReportes(); setTimeout(initReportesCharts, 60); }
  if (page === 'presupuestos') renderPresupuestos();
  if (page === 'usuarios') { 
    renderUsuarios(_usuarioFilterRol||''); // render cache immediately
    loadUsuariosSB().then(() => renderUsuarios(_usuarioFilterRol||'')); // then reload from SB
    populateProyectoDropdowns(); 
  }
  if (page === 'cotizador') renderCotizador();
  if (page === 'asistencia') initAsistencia();
  if (page === 'flujocaja') initFlujoCaja();
  if (page === 'alertas') { generarAlertas(); }
}

// ===================== REFRESH ALL =====================
function refreshAll() {
  updateBadges();
  renderDashboard();
  renderProyectos();
  renderPersonal();
  renderMaquinaria();
  renderPresupuestos();
  renderFacturas();
  renderProveedores();
  renderMateriales();
  setTimeout(makeTablesResponsive, 50);
}

function updateBadges() {
  document.getElementById('badge-proyectos').textContent = db.proyectos.length;
  document.getElementById('badge-personal').textContent = db.personal.length;
  document.getElementById('badge-maquinaria').textContent = db.maquinaria.length;
  document.getElementById('badge-presupuestos').textContent = db.presupuestos.length;
  const vencidas = db.facturas.filter(f=>f.estado==='pausado').length;
  if (vencidas > 0) document.getElementById('badge-facturas').textContent = vencidas;
}

function renderFacturas() {
  const tbody = document.getElementById('facturas-table');
  if (!tbody) return;
  // Update stats
  const totalMes = db.facturas.reduce((a,f) => a + Number(f.monto), 0);
  const pendiente = db.facturas.filter(f=>f.estado==='pendiente').reduce((a,f)=>a+Number(f.monto),0);
  const vencido = db.facturas.filter(f=>f.estado==='pausado').reduce((a,f)=>a+Number(f.monto),0);
  const meEl = document.getElementById('fac-mes');
  const penEl = document.getElementById('fac-pendiente');
  const venEl = document.getElementById('fac-vencido');
  if (meEl) meEl.textContent = fmtM(totalMes);
  if (penEl) penEl.textContent = fmtM(pendiente);
  if (venEl) venEl.textContent = fmtM(vencido);

  if (db.facturas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No hay facturas. HacÃ© clic en "+ Nueva Factura".</td></tr>';
    return;
  }
  const estadoTxt = { pendiente:'Pendiente', activo:'Cobrada', pausado:'Vencida' };
  const rows = db.facturas.map(f => ({
    tr: `<tr>
      <td><div class="td-name">${f.numero||'â€”'}</div></td>
      <td>${f.cliente}</td>
      <td>${getProyectoNombre(f.proyecto)||'â€”'}</td>
      <td><b>${fmt(f.monto)}</b></td>
      <td style="color:var(--muted2)">${f.fecha||'â€”'}</td>
      <td style="color:var(--muted2)">${f.vence||'â€”'}</td>
      <td><span class="status-badge ${f.estado||'pendiente'}">${estadoTxt[f.estado]||f.estado}</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF','Generando...')">ğŸ“„ PDF</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactura('${f.id}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`,
    card: `<div class="mobile-card">
      <div class="mc-header">
        <div><div class="mc-name">${f.numero||'Sin nÃºmero'} â€” ${f.cliente}</div><div class="mc-sub">${getProyectoNombre(f.proyecto)||'â€”'}</div></div>
        <span class="status-badge ${f.estado||'pendiente'}">${estadoTxt[f.estado]||f.estado}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Monto</div><div class="mc-val" style="color:var(--green)">${fmt(f.monto)}</div></div>
        <div><div class="mc-label">Fecha</div><div class="mc-val">${f.fecha||'â€”'}</div></div>
        <div><div class="mc-label">Vence</div><div class="mc-val">${f.vence||'â€”'}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF','Generando...')">ğŸ“„ PDF</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactura('${f.id}')">ğŸ—‘ï¸ Eliminar</button>
      </div>
    </div>`
  }));
  tbody.innerHTML = rows.map(r=>r.tr).join('');
  const mob = document.getElementById('facturas-mobile');
  if (mob) mob.innerHTML = rows.map(r=>r.card).join('');
}

async function deleteFactura(id) {
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar esta factura?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('facturas?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Factura eliminada','','err');
      await loadAllData(); renderFacturas();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

function renderProveedores() {
  const tbody = document.getElementById('proveedores-table');
  if (!tbody) return;
  if (db.proveedores.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">No hay proveedores. HacÃ© clic en "+ Nuevo Proveedor".</td></tr>';
    return;
  }
  const pRows = db.proveedores.map(p => ({
    tr: `<tr>
      <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.rut||'â€”'}</div></td>
      <td>${p.rubro||'â€”'}</td>
      <td>${p.tel||'â€”'}</td>
      <td>â€”</td>
      <td style="font-weight:700">S/ 0</td>
      <td><span class="status-badge ${p.estado==='activo'?'activo':'pendiente'}">${p.estado==='activo'?'Activo':'Inactivo'}</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-danger btn-sm" onclick="deleteProveedor('${p.id}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`,
    card: `<div class="mobile-card">
      <div class="mc-header">
        <div>
          <div class="mc-name">${p.nombre}</div>
          <div class="mc-sub">${p.rubro||'â€”'} Â· ${p.rut||'â€”'}</div>
        </div>
        <span class="status-badge ${p.estado==='activo'?'activo':'pendiente'}">${p.estado==='activo'?'Activo':'Inactivo'}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">TelÃ©fono</div><div class="mc-val">${p.tel||'â€”'}</div></div>
        <div><div class="mc-label">Email</div><div class="mc-val" style="font-size:12px">${p.email||'â€”'}</div></div>
        <div><div class="mc-label">DirecciÃ³n</div><div class="mc-val" style="font-size:12px">${p.dir||'â€”'}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-danger btn-sm" onclick="deleteProveedor('${p.id}')">ğŸ—‘ï¸ Eliminar</button>
      </div>
    </div>`
  }));
  tbody.innerHTML = pRows.map(r=>r.tr).join('');
  const provMob = document.getElementById('proveedores-mobile');
  if (provMob) provMob.innerHTML = pRows.map(r=>r.card).join('');
}

async function deleteProveedor(id) {
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar este proveedor?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('proveedores?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Proveedor eliminado','','err');
      await loadAllData(); renderProveedores();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

function renderMateriales() {
  const tbody = document.getElementById('materiales-table');
  if (!tbody) return;
  if (db.materiales.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay movimientos registrados.</td></tr>';
    return;
  }
  const matRows = db.materiales.map(m => {
    const color = m.tipo === 'ENTRADA' ? 'var(--green)' : 'var(--red)';
    const fecha = m.fecha ? new Date(m.fecha).toLocaleString('es-UY',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : 'â€”';
    return {
      tr: `<tr>
        <td><div class="td-name">${m.nombre}</div></td>
        <td><span style="color:${color};font-weight:700;font-size:12px;">${m.tipo||'â€”'}</span></td>
        <td>${m.cantidad||'â€”'}</td>
        <td>${getProyectoNombre(m.proyecto)||'â€”'}</td>
        <td>${m.responsable||'â€”'}</td>
        <td style="color:var(--muted)">${fecha}</td>
      </tr>`,
      card: `<div class="mobile-card">
        <div class="mc-header">
          <div><div class="mc-name">${m.nombre}</div><div class="mc-sub">${getProyectoNombre(m.proyecto)||'â€”'}</div></div>
          <span style="color:${color};font-weight:800;font-size:13px;padding:3px 10px;background:${m.tipo==='ENTRADA'?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.12)'};border-radius:20px;">${m.tipo||'â€”'}</span>
        </div>
        <div class="mc-body">
          <div><div class="mc-label">Cantidad</div><div class="mc-val">${m.cantidad||'â€”'}</div></div>
          <div><div class="mc-label">Responsable</div><div class="mc-val">${m.responsable||'â€”'}</div></div>
          <div><div class="mc-label">Fecha</div><div class="mc-val">${fecha}</div></div>
        </div>
      </div>`
    };
  });
  tbody.innerHTML = matRows.map(r=>r.tr).join('');
  const matMob = document.getElementById('materiales-mobile');
  if (matMob) matMob.innerHTML = matRows.map(r=>r.card).join('');
}

// ===================== HELPERS =====================
function fmt(n) { return 'S/ ' + Number(n).toLocaleString('es-PE'); }
function fmtM(n) { return n >= 1000000 ? 'S/ ' + (n/1000000).toFixed(1) + 'M' : n >= 1000 ? 'S/ ' + (n/1000).toFixed(0) + 'k' : 'S/ ' + Number(n).toLocaleString('es-PE'); }
function statusLabel(s) {
  const m = { activo: ['activo','Activo'], progreso: ['progreso','En Curso'], pendiente: ['pendiente','Pendiente'], pausado: ['pausado','Pausado'], finalizado: ['finalizado','Finalizado'] };
  const v = m[s] || ['pendiente', s];
  return `<span class="status-badge ${v[0]}">${v[1]}</span>`;
}
function tipoLabel(t) {
  const m = { planilla: 'En Planilla', contrato: 'Contrato', jornal: 'Jornalero' };
  return `<span class="status-badge ${t}">${m[t]||t}</span>`;
}
function getProyectoNombre(id) {
  const p = db.proyectos.find(x => x.id === id);
  return p ? p.nombre : 'â€”';
}
function colorProgress(pct) {
  if (pct >= 70) return '#22c55e';
  if (pct >= 40) return '#f5a623';
  return '#ef4444';
}

// ===================== DASHBOARD =====================
function renderDashboard() {
  const activos = db.proyectos.filter(p => p.estado !== 'finalizado' && p.estado !== 'pausado').length;
  const totalPres = db.proyectos.reduce((a, p) => a + Number(p.presupuesto), 0);
  const enPlanilla = db.personal.filter(e => e.tipo === 'planilla').length;
  const maqActivas = db.maquinaria.filter(m => m.estado === 'activo').length;

  document.getElementById('kpi-proyectos').textContent = activos;
  document.getElementById('kpi-presupuesto').textContent = fmtM(totalPres);
  document.getElementById('kpi-personal').textContent = enPlanilla;
  document.getElementById('kpi-maquinas').textContent = maqActivas;

  // projects table on dashboard
  const tbody = document.getElementById('dash-projects-table');
  if (db.proyectos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos.</td></tr>';
  } else {
    tbody.innerHTML = db.proyectos.slice(0, 6).map(p => `
      <tr>
        <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.tipo} Â· ${p.ubicacion || 'â€”'}</div></td>
        <td>${p.cliente}</td>
        <td>${fmtM(p.presupuesto)}</td>
        <td><div style="display:flex;align-items:center;gap:8px;font-size:12px;min-width:110px">
          <div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>${p.avance}%
        </div></td>
        <td>${statusLabel(p.estado)}</td>
      </tr>`).join('');
  }

  // personal top horas
  const topEmp = [...db.personal].sort((a,b) => b.horas - a.horas).slice(0, 4);
  const empDiv = document.getElementById('dash-personal-list');
  empDiv.innerHTML = topEmp.length ? topEmp.map(e => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
        <div><div style="font-size:13px;font-weight:600;">${e.nombre}</div><div style="font-size:11px;color:var(--muted);">${e.rol}</div></div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;color:var(--accent);">${e.horas}h</div>
    </div>`).join('') : '<p style="color:var(--muted);font-size:13px;">Sin datos.</p>';

  // maquinaria rentabilidad
  const maqDiv = document.getElementById('dash-maquinaria-list');
  maqDiv.innerHTML = db.maquinaria.length ? db.maquinaria.slice(0,4).map(m => {
    const ingreso = m.horas * m.tarifa;
    const costo = m.horas * m.costoHora;
    const rentab = ingreso > 0 ? ((ingreso - costo) / ingreso * 100).toFixed(1) : 0;
    const cls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';
    return `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;">
      <div><div style="font-size:13px;font-weight:600;">${m.nombre}</div><div style="font-size:11px;color:var(--muted);">${m.horas}h Â· ${fmtM(ingreso)} facturado</div></div>
      <div class="${cls}">${rentab}%</div>
    </div>`;
  }).join('') : '<p style="color:var(--muted);font-size:13px;">Sin datos.</p>';
}

// ===================== PROYECTOS =====================
function renderProyectos(filter) {
  if (filter) currentFilter.proyectos = filter;
  const f = currentFilter.proyectos;
  let data = db.proyectos;
  if (f !== 'todos') data = data.filter(p => p.estado === f);
  document.getElementById('proyectos-sub').textContent = db.proyectos.length + ' proyectos en cartera Â· $' + (db.proyectos.reduce((a,p)=>a+Number(p.presupuesto),0)/1000000).toFixed(1) + 'M total';
  const grid = document.getElementById('projects-grid');
  if (data.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸ—ï¸</div><p>No hay proyectos en esta categorÃ­a.</p></div>';
    return;
  }
  grid.innerHTML = data.map(p => `
    <div class="project-card" onclick="openProyectoDetail('${p.id}')">
      <div class="project-card-header">
        <span class="project-type-badge">${p.tipo}</span>
        ${statusLabel(p.estado)}
      </div>
      <div class="project-card-title">${p.nombre}</div>
      <div class="project-card-client">${p.cliente} Â· ${p.ubicacion || 'Sin ubicaciÃ³n'}</div>
      <div style="margin-top:12px;">
        <div class="project-progress-label"><span>Avance fÃ­sico</span><span style="font-weight:700;color:${colorProgress(p.avance)}">${p.avance}%</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>
      </div>
      <div class="project-card-meta" style="margin-top:12px;">
        <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;">${fmtM(p.presupuesto)}</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModal('proyecto','${p.id}')">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();confirmDelete('proyecto','${p.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`).join('');
}

function filterTab(page, filter, el) {
  document.querySelectorAll(`#page-${page} .tab`).forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (page === 'proyectos') renderProyectos(filter);
}

function openProyectoDetail(id) {
  openModal('proyecto', id, true);
}

// ===================== PERSONAL =====================
function renderPersonal(search, statusF) {
  if (search !== undefined) currentFilter.personal = search;
  if (statusF !== undefined) currentFilter.personalStatus = statusF;
  let data = db.personal;
  if (currentFilter.personal) {
    const q = currentFilter.personal.toLowerCase();
    data = data.filter(e => e.nombre.toLowerCase().includes(q) || e.rol.toLowerCase().includes(q) || e.ci.includes(q));
  }
  if (currentFilter.personalStatus) data = data.filter(e => e.tipo === currentFilter.personalStatus);
  document.getElementById('personal-sub').textContent = db.personal.length + ' empleados Â· ' + db.personal.filter(e=>e.tipo==='planilla').length + ' en planilla';
  const tbody = document.getElementById('personal-table');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No se encontraron resultados.</td></tr>';
    return;
  }
  const rows = data.map(e => {
    let contractAlert = '';
    let contractAlertMobile = '';
    if (e.fechaFin) {
      const today = new Date();
      const fin = new Date(e.fechaFin);
      const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
      if (diffDays < 0) {
        contractAlert = `<div style="font-size:10px;color:var(--red);font-weight:700;margin-top:2px;">âš ï¸ Contrato vencido</div>`;
        contractAlertMobile = `<div style="font-size:11px;color:var(--red);font-weight:700;margin-top:6px;">âš ï¸ Contrato vencido</div>`;
      } else if (diffDays <= 30) {
        contractAlert = `<div style="font-size:10px;color:var(--accent);font-weight:700;margin-top:2px;">â° Vence en ${diffDays}d</div>`;
        contractAlertMobile = `<div style="font-size:11px;color:var(--accent);font-weight:700;margin-top:6px;">â° Vence en ${diffDays} dÃ­as</div>`;
      }
    }
    const initials = e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2);
    const sueldoStr = e.tipo === 'jornal' ? fmt(e.sueldo) + '/dÃ­a' : fmt(e.sueldo) + '/mes';
    return {
      tr: `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">${initials}</div>
          <div><div class="td-name">${e.nombre}</div><div class="td-sub">${e.ci}</div>${contractAlert}</div>
        </div>
      </td>
      <td><div>${e.rol}</div><div class="td-sub">${e.cuadrilla || 'â€”'}</div></td>
      <td>${tipoLabel(e.tipo)}</td>
      <td>${sueldoStr}</td>
      <td><span style="font-family:'Syne',sans-serif;font-weight:700;">${e.horas}h</span></td>
      <td>${getProyectoNombre(e.proyecto)}</td>
      <td><span class="status-badge activo">Activo</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-primary btn-sm" onclick="verPersonal('${e.id}')">ğŸ‘ Ver</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('personal','${e.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('personal','${e.id}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`,
      card: `
    <div class="mobile-card">
      <div class="mc-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="mc-avatar">${initials}</div>
          <div><div class="mc-name">${e.nombre}</div><div class="mc-sub">${e.ci} Â· ${e.rol}</div>${contractAlertMobile}</div>
        </div>
        ${tipoLabel(e.tipo)}
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Cuadrilla</div><div class="mc-val">${e.cuadrilla || 'â€”'}</div></div>
        <div><div class="mc-label">Sueldo</div><div class="mc-val">${sueldoStr}</div></div>
        <div><div class="mc-label">Horas/mes</div><div class="mc-val">${e.horas}h</div></div>
        <div><div class="mc-label">Proyecto</div><div class="mc-val" style="font-size:12px;">${getProyectoNombre(e.proyecto)}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-primary btn-sm" onclick="verPersonal('${e.id}')">ğŸ‘ Ver ficha</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('personal','${e.id}')">âœï¸ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('personal','${e.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`
    };
  });
  tbody.innerHTML = rows.map(r=>r.tr).join('');
  const mobileDiv = document.getElementById('personal-mobile');
  if (mobileDiv) mobileDiv.innerHTML = rows.map(r=>r.card).join('') || '<p style="color:var(--muted);text-align:center;padding:24px;">Sin resultados.</p>';
}

function filterPersonal(val) { renderPersonal(val); }
function filterPersonalStatus(val) { renderPersonal(undefined, val); }

function verPersonal(id) {
  currentPersonalId = id;
  const e = db.personal.find(x => x.id === id);
  if (!e) return;
  const proyecto = getProyectoNombre(e.proyecto);
  const sueldoLabel = e.tipo === 'jornal' ? fmt(e.sueldo) + '/dÃ­a' : fmt(e.sueldo) + '/mes';
  const salarioTotal = e.tipo === 'jornal' ? e.sueldo * (e.horas / 8) : e.sueldo;
  const costoHora = salarioTotal / (e.horas || 1);

  // Contract expiry check
  let contractStatus = '';
  if (e.fechaFin) {
    const today = new Date();
    const fin = new Date(e.fechaFin);
    const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) {
      contractStatus = `<div style="margin-top:10px;padding:10px 14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;font-size:13px;color:var(--red);font-weight:600;">âš ï¸ Contrato VENCIDO hace ${Math.abs(diffDays)} dÃ­as â€” Renovar urgente</div>`;
    } else if (diffDays <= 30) {
      contractStatus = `<div style="margin-top:10px;padding:10px 14px;background:rgba(245,166,35,0.1);border:1px solid rgba(245,166,35,0.3);border-radius:8px;font-size:13px;color:var(--accent);font-weight:600;">â° Contrato vence en ${diffDays} dÃ­as (${fin.toLocaleDateString('es-PE')}) â€” Revisar renovaciÃ³n</div>`;
    }
  }

  // Simulated monthly hours breakdown
  const semanas = [
    { sem: 'Semana 1', lun: 8, mar: 8, mie: 8, jue: 8, vie: 8, sab: 4, total: 44 },
    { sem: 'Semana 2', lun: 8, mar: 8, mie: 8, jue: 0, vie: 8, sab: 0, total: 32 },
    { sem: 'Semana 3', lun: 8, mar: 8, mie: 8, jue: 8, vie: 8, sab: 8, total: 48 },
    { sem: 'Semana 4', lun: 8, mar: 8, mie: 0, jue: 8, vie: 8, sab: 4, total: e.horas - 124 > 0 ? e.horas - 124 : 36 },
  ];

  document.getElementById('personal-detail-content').innerHTML = `
    <div class="person-detail-header">
      <div class="person-avatar">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
      <div class="person-detail-info">
        <h2>${e.nombre}</h2>
        <p>${e.rol} Â· Cuadrilla: ${e.cuadrilla || 'No asignada'}</p>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${tipoLabel(e.tipo)}
          <span class="status-badge activo">Activo</span>
          ${e.tel ? `<span style="font-size:12px;color:var(--muted2);">ğŸ“ ${e.tel}</span>` : ''}
          ${e.email ? `<span style="font-size:12px;color:var(--muted2);">âœ‰ï¸ ${e.email}</span>` : ''}
        </div>
        ${contractStatus}
      </div>
    </div>
    <div class="detail-grid">
      <div class="detail-item">
        <div class="d-label">Sueldo Base</div>
        <div class="d-val" style="color:var(--accent)">${sueldoLabel}</div>
        <div class="d-sub">Salario mensual estimado: ${fmt(salarioTotal)}</div>
      </div>
      <div class="detail-item">
        <div class="d-label">Horas Trabajadas (mes)</div>
        <div class="d-val" style="color:var(--blue)">${e.horas}h</div>
        <div class="d-sub">Costo/hora: ${fmt(Math.round(costoHora))}</div>
      </div>
      <div class="detail-item">
        <div class="d-label">Proyecto Asignado</div>
        <div class="d-val" style="font-size:14px;font-weight:700;">${proyecto}</div>
        <div class="d-sub">CI: ${e.ci}</div>
      </div>
    </div>
    ${e.dir || e.obs ? `
    <div style="background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:16px;border:1px solid var(--border);">
      ${e.dir ? `<div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">ğŸ“ ${e.dir}</div>` : ''}
      ${e.obs ? `<div style="font-size:12px;color:var(--muted2);">ğŸ“ ${e.obs}</div>` : ''}
    </div>` : ''}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;color:var(--muted2);">REGISTRO DE HORAS â€” MES ACTUAL</div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <table class="hours-table">
        <thead><tr><th>Semana</th><th>Lun</th><th>Mar</th><th>MiÃ©</th><th>Jue</th><th>Vie</th><th>SÃ¡b</th><th>Total</th></tr></thead>
        <tbody>
          ${semanas.map(s=>`<tr>
            <td style="font-weight:600;">${s.sem}</td>
            <td>${s.lun}h</td><td>${s.mar}h</td><td>${s.mie}h</td>
            <td>${s.jue}h</td><td>${s.vie}h</td>
            <td style="color:${s.sab>0?'var(--accent)':'var(--muted)'};">${s.sab}h</td>
            <td style="font-weight:700;color:var(--blue);">${s.total}h</td>
          </tr>`).join('')}
          <tr style="background:rgba(245,166,35,0.05);">
            <td colspan="6" style="font-weight:700;text-align:right;padding-right:20px;color:var(--muted2);">TOTAL MES:</td>
            <td colspan="2" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--accent);">${e.horas}h</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  openModal('personal-detail');
}

function editPersonal() {
  closeModal('personal-detail');
  openModal('personal', currentPersonalId);
}

function exportPersonaExcel() {
  const e = db.personal.find(x => x.id === currentPersonalId);
  if (!e) return;
  exportToCSV([
    ['Campo', 'Valor'],
    ['Nombre', e.nombre], ['CI', e.ci], ['Rol', e.rol], ['Cuadrilla', e.cuadrilla],
    ['Tipo', e.tipo], ['Sueldo Base', e.sueldo], ['Horas Mes', e.horas],
    ['Proyecto', getProyectoNombre(e.proyecto)], ['TelÃ©fono', e.tel], ['Email', e.email],
    ['DirecciÃ³n', e.dir], ['Observaciones', e.obs],
    [''],['Registro de Horas'],
    ['Semana','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado','Total'],
    ['Semana 1',8,8,8,8,8,4,44],['Semana 2',8,8,8,0,8,0,32],
    ['Semana 3',8,8,8,8,8,8,48],['Semana 4',8,8,0,8,8,4,36],
    ['TOTAL','','','','','','',e.horas]
  ], 'ficha_' + e.nombre.replace(/ /g,'_'));
  toast('Excel generado', 'Archivo descargado: ficha_' + e.nombre);
}

function exportPersonalExcel() {
  const rows = [['Nombre','CI','Rol','Cuadrilla','Tipo','Sueldo','Horas Mes','Proyecto','TelÃ©fono','Email']];
  db.personal.forEach(e => rows.push([e.nombre,e.ci,e.rol,e.cuadrilla,e.tipo,e.sueldo,e.horas,getProyectoNombre(e.proyecto),e.tel,e.email]));
  exportToCSV(rows, 'personal_completo');
  toast('Excel exportado', db.personal.length + ' empleados exportados');
}

// ===================== BOLETA DE PAGO PDF =====================
function generarBoletaPDF() {
  const e = db.personal.find(x => x.id === currentPersonalId);
  if (!e) return;

  const proyecto = getProyectoNombre(e.proyecto);
  const hoy = new Date();
  const mes = hoy.toLocaleString('es-PE', { month: 'long', year: 'numeric' });
  const fechaEmision = hoy.toLocaleDateString('es-PE');

  // Calcular montos
  const sueldoBase = Number(e.sueldo) || 0;
  const horas = Number(e.horas) || 0;
  let sueldoBruto = sueldoBase;
  if (e.tipo === 'jornal') sueldoBruto = sueldoBase * (horas / 8);

  // Descuentos estÃ¡ndar PerÃº
  const onp = sueldoBruto * 0.13;         // ONP 13%
  const essalud = sueldoBruto * 0.09;     // EsSalud 9% (cargo empleador)
  const sctr = sueldoBruto * 0.009;       // SCTR ~0.9%
  const totalDescuentos = onp;            // descuento trabajador
  const sueldoNeto = sueldoBruto - totalDescuentos;

  const tipoMap = { planilla: 'En Planilla', contrato: 'Contrato', jornal: 'Jornalero' };

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Boleta de Pago â€” ${e.nombre}</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:Arial,sans-serif;font-size:13px;color:#1a1a2e;background:#fff;padding:30px;}
  .boleta{max-width:680px;margin:0 auto;border:2px solid #1a1a2e;border-radius:8px;overflow:hidden;}
  .header{background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}
  .header h1{font-size:22px;font-weight:900;letter-spacing:1px;}
  .header .sub{font-size:11px;opacity:0.85;margin-top:3px;}
  .header .fecha{text-align:right;font-size:12px;}
  .section{padding:16px 24px;border-bottom:1px solid #e5e7eb;}
  .section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#6b7280;margin-bottom:10px;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px 16px;}
  .field label{font-size:10px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;}
  .field span{font-weight:700;font-size:13px;color:#111;}
  table{width:100%;border-collapse:collapse;margin-top:4px;}
  table th{background:#f9fafb;padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6b7280;text-align:left;border-bottom:2px solid #e5e7eb;}
  table td{padding:9px 12px;font-size:13px;border-bottom:1px solid #f3f4f6;}
  table tr:last-child td{border-bottom:none;}
  .amount{text-align:right;font-weight:700;}
  .green{color:#16a34a;}
  .red{color:#dc2626;}
  .total-row{background:#fef9f0;}
  .total-row td{font-family:'Arial',sans-serif;font-weight:900;font-size:15px;padding:12px;}
  .neto-box{background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;padding:18px 24px;text-align:center;}
  .neto-box .label{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.85;}
  .neto-box .amount{font-size:32px;font-weight:900;margin:4px 0;}
  .neto-box .sub{font-size:11px;opacity:0.75;}
  .footer{padding:14px 24px;background:#f9fafb;font-size:11px;color:#6b7280;display:flex;justify-content:space-between;}
  @media print{body{padding:0;} .no-print{display:none;}}
</style>
</head>
<body>
<div class="boleta">
  <div class="header">
    <div>
      <h1>ğŸ—ï¸ BuildCore</h1>
      <div class="sub">Sistema de GestiÃ³n de ConstrucciÃ³n</div>
      <div class="sub" style="margin-top:6px;font-size:13px;font-weight:700;">BOLETA DE PAGO</div>
    </div>
    <div class="fecha">
      <div style="font-weight:700;font-size:14px;">PerÃ­odo: ${mes}</div>
      <div style="margin-top:4px;">EmisiÃ³n: ${fechaEmision}</div>
      <div style="margin-top:4px;opacity:0.7;">NÂ° ${String(hoy.getFullYear()) + String(hoy.getMonth()+1).padStart(2,'0') + String(Math.floor(Math.random()*9000)+1000)}</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Datos del Trabajador</div>
    <div class="grid2">
      <div class="field"><label>Apellidos y Nombres</label><span>${e.nombre}</span></div>
      <div class="field"><label>DNI / CI</label><span>${e.ci || 'â€”'}</span></div>
      <div class="field"><label>Cargo / Puesto</label><span>${e.rol || 'â€”'}</span></div>
      <div class="field"><label>Cuadrilla</label><span>${e.cuadrilla || 'â€”'}</span></div>
      <div class="field"><label>Tipo de Contrato</label><span>${tipoMap[e.tipo] || e.tipo}</span></div>
      <div class="field"><label>Proyecto Asignado</label><span>${proyecto}</span></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Detalle de Haberes</div>
    <table>
      <thead><tr><th>Concepto</th><th>Detalle</th><th class="amount">Monto</th></tr></thead>
      <tbody>
        <tr>
          <td><b>Sueldo / Jornal Base</b></td>
          <td style="color:#6b7280;">${e.tipo==='jornal'?horas+' horas Ã— S/ '+sueldoBase+'/h':'Mensual fijo'}</td>
          <td class="amount green">S/ ${sueldoBruto.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>
        <tr>
          <td>Horas trabajadas</td>
          <td style="color:#6b7280;">${horas} horas en el mes</td>
          <td class="amount">â€”</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-title">Descuentos del Trabajador</div>
    <table>
      <thead><tr><th>Concepto</th><th>Base</th><th class="amount">Descuento</th></tr></thead>
      <tbody>
        <tr>
          <td>ONP (Sistema Nacional de Pensiones)</td>
          <td style="color:#6b7280;">13% s/ S/ ${sueldoBruto.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
          <td class="amount red">- S/ ${onp.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>
        <tr class="total-row">
          <td colspan="2"><b>Total Descuentos</b></td>
          <td class="amount red"><b>- S/ ${totalDescuentos.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</b></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section" style="border-bottom:none;">
    <div class="section-title">Aportes del Empleador</div>
    <table>
      <thead><tr><th>Concepto</th><th>Tasa</th><th class="amount">Monto</th></tr></thead>
      <tbody>
        <tr><td>EsSalud</td><td style="color:#6b7280;">9%</td><td class="amount" style="color:#2563eb;">S/ ${essalud.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
        <tr><td>SCTR (Salud + PensiÃ³n)</td><td style="color:#6b7280;">0.9%</td><td class="amount" style="color:#2563eb;">S/ ${sctr.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
      </tbody>
    </table>
  </div>

  <div class="neto-box">
    <div class="label">Neto a Pagar al Trabajador</div>
    <div class="amount">S/ ${sueldoNeto.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
    <div class="sub">${mes} Â· ${e.nombre.toUpperCase()}</div>
  </div>

  <div class="footer">
    <span>ğŸ“‹ Generado por BuildCore Â· ${fechaEmision}</span>
    <span>Firma empleador: ___________________</span>
    <span>Firma trabajador: ___________________</span>
  </div>
</div>

<div class="no-print" style="text-align:center;margin-top:20px;">
  <button onclick="window.print()" style="background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;border:none;padding:12px 32px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('Boleta generada', 'Se abriÃ³ la boleta en nueva ventana â€” imprimÃ­ o guardÃ¡ como PDF');
}

// ===================== MAQUINARIA =====================
function renderMaquinaria() {
  document.getElementById('maquinaria-sub').textContent = db.maquinaria.length + ' equipos registrados';
  const totalH = db.maquinaria.reduce((a,m)=>a+Number(m.horas),0);
  const totalI = db.maquinaria.reduce((a,m)=>a+(m.horas*m.tarifa),0);
  const totalC = db.maquinaria.reduce((a,m)=>a+(m.horas*m.costoHora),0);
  const rentProm = totalI > 0 ? ((totalI-totalC)/totalI*100).toFixed(1) : 0;
  document.getElementById('maq-total-horas').textContent = totalH + 'h';
  document.getElementById('maq-total-ingreso').textContent = fmtM(totalI);
  document.getElementById('maq-total-costo').textContent = fmtM(totalC);
  document.getElementById('maq-rentab-prom').textContent = rentProm + '%';
  const grid = document.getElementById('machines-grid');
  if (db.maquinaria.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸšœ</div><p>No hay equipos registrados.</p></div>';
    return;
  }
  grid.innerHTML = db.maquinaria.map(m => {
    const ingreso = m.horas * m.tarifa;
    const costo = m.horas * m.costoHora;
    const utilidad = ingreso - costo;
    const rentab = ingreso > 0 ? ((utilidad/ingreso)*100).toFixed(1) : 0;
    const rentCls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';
    const estadoColor = m.estado === 'activo' ? 'var(--green)' : m.estado === 'pausado' ? 'var(--red)' : 'var(--accent)';
    const estadoTxt = m.estado === 'activo' ? 'Operativo' : m.estado === 'pausado' ? 'Mantenimiento' : 'Reservado';
    return `
    <div class="machine-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;">${m.nombre}</div>
          <div style="font-size:12px;color:var(--muted2);margin-top:3px;">${m.modelo} Â· ${m.matricula}</div>
        </div>
        <span style="background:rgba(255,255,255,0.05);color:${estadoColor};font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid ${estadoColor}33;">${estadoTxt}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Horas Mes</div>
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--blue);">${m.horas}h</div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Rentabilidad</div>
          <div class="${rentCls}" style="font-family:'Syne',sans-serif;font-size:18px;">${rentab}%</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:12px;margin-bottom:14px;">
        <div style="text-align:center;"><div style="color:var(--muted);">Ingreso</div><div style="font-weight:700;color:var(--green);">${fmtM(ingreso)}</div></div>
        <div style="text-align:center;"><div style="color:var(--muted);">Costo</div><div style="font-weight:700;color:var(--red);">${fmtM(costo)}</div></div>
        <div style="text-align:center;"><div style="color:var(--muted);">Utilidad</div><div style="font-weight:700;color:var(--accent);">${fmtM(utilidad)}</div></div>
      </div>
      <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;">
        ğŸ“‹ ${getProyectoNombre(m.proyecto)} &nbsp;Â·&nbsp; ğŸ”§ ${m.mantenim || 'Sin fecha'}
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" style="flex:1" onclick="verMaquina('${m.id}')">ğŸ‘ Ver Detalle</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('maquina','${m.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('maquina','${m.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

function verMaquina(id) {
  currentMaquinaId = id;
  const m = db.maquinaria.find(x => x.id === id);
  if (!m) return;
  const ingreso = m.horas * m.tarifa;
  const costo = m.horas * m.costoHora;
  const utilidad = ingreso - costo;
  const rentab = ingreso > 0 ? ((utilidad/ingreso)*100).toFixed(1) : 0;
  const rentCls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';

  // Simulated weekly breakdown
  const semanas = [
    { sem:'Sem 1', horas:Math.round(m.horas*0.27), ingreso:Math.round(m.horas*0.27*m.tarifa), costo:Math.round(m.horas*0.27*m.costoHora) },
    { sem:'Sem 2', horas:Math.round(m.horas*0.23), ingreso:Math.round(m.horas*0.23*m.tarifa), costo:Math.round(m.horas*0.23*m.costoHora) },
    { sem:'Sem 3', horas:Math.round(m.horas*0.28), ingreso:Math.round(m.horas*0.28*m.tarifa), costo:Math.round(m.horas*0.28*m.costoHora) },
    { sem:'Sem 4', horas:Math.round(m.horas*0.22), ingreso:Math.round(m.horas*0.22*m.tarifa), costo:Math.round(m.horas*0.22*m.costoHora) },
  ];

  document.getElementById('maquina-detail-content').innerHTML = `
    <div style="display:flex;align-items:center;gap:18px;padding:18px;background:var(--bg3);border-radius:12px;margin-bottom:18px;border:1px solid var(--border);">
      <div style="font-size:42px;">ğŸšœ</div>
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">${m.nombre}</div>
        <div style="font-size:13px;color:var(--muted2);margin-top:3px;">${m.tipo} Â· ${m.modelo} Â· ${m.matricula}</div>
        <div style="margin-top:8px;">
          <span class="status-badge ${m.estado === 'activo' ? 'activo' : m.estado === 'pausado' ? 'pausado' : 'pendiente'}">${m.estado === 'activo' ? 'Operativo' : m.estado === 'pausado' ? 'Mantenimiento' : 'Reservado'}</span>
        </div>
      </div>
    </div>
    <div class="machine-kpi-grid">
      <div class="detail-item"><div class="d-label">Horas Trabajadas</div><div class="d-val" style="color:var(--blue)">${m.horas}h</div><div class="d-sub">Tarifa: ${fmt(m.tarifa)}/h</div></div>
      <div class="detail-item"><div class="d-label">Ingresos</div><div class="d-val" style="color:var(--green)">${fmtM(ingreso)}</div><div class="d-sub">${fmt(m.tarifa)}/h Ã— ${m.horas}h</div></div>
      <div class="detail-item"><div class="d-label">Costo Operativo</div><div class="d-val" style="color:var(--red)">${fmtM(costo)}</div><div class="d-sub">${fmt(m.costoHora)}/h Ã— ${m.horas}h</div></div>
      <div class="detail-item"><div class="d-label">Rentabilidad</div><div class="d-val ${rentCls}">${rentab}%</div><div class="d-sub">Utilidad: ${fmtM(utilidad)}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
      <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">Proyecto Asignado</div>
        <div style="font-weight:700;">${getProyectoNombre(m.proyecto)}</div>
      </div>
      <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">PrÃ³ximo Mantenimiento</div>
        <div style="font-weight:700;color:${m.mantenim ? 'var(--accent)':'var(--muted)'};">${m.mantenim || 'No programado'}</div>
      </div>
    </div>
    ${m.obs ? `<div style="background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--muted2);border:1px solid var(--border);">ğŸ“ ${m.obs}</div>` : ''}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;color:var(--muted2);">DESGLOSE SEMANAL â€” MES ACTUAL</div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <table class="hours-table">
        <thead><tr><th>Semana</th><th>Horas</th><th>Ingreso</th><th>Costo</th><th>Utilidad</th><th>Rentab.</th></tr></thead>
        <tbody>
          ${semanas.map(s=>{
            const util = s.ingreso - s.costo;
            const r = s.ingreso>0?((util/s.ingreso)*100).toFixed(1):0;
            const c = r>=40?'var(--green)':r>=20?'var(--accent)':'var(--red)';
            return `<tr>
              <td style="font-weight:600;">${s.sem}</td>
              <td style="color:var(--blue);font-weight:700;">${s.horas}h</td>
              <td style="color:var(--green);">${fmt(s.ingreso)}</td>
              <td style="color:var(--red);">${fmt(s.costo)}</td>
              <td style="font-weight:700;">${fmt(util)}</td>
              <td style="color:${c};font-weight:700;">${r}%</td>
            </tr>`;
          }).join('')}
          <tr style="background:rgba(245,166,35,0.05);font-weight:700;">
            <td>TOTAL</td>
            <td style="color:var(--blue);font-family:'Syne',sans-serif;">${m.horas}h</td>
            <td style="color:var(--green);">${fmt(ingreso)}</td>
            <td style="color:var(--red);">${fmt(costo)}</td>
            <td style="color:var(--accent);font-family:'Syne',sans-serif;">${fmt(utilidad)}</td>
            <td class="${rentCls}" style="font-family:'Syne',sans-serif;">${rentab}%</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  openModal('maquina-detail');
}

function editMaquina() {
  closeModal('maquina-detail');
  openModal('maquina', currentMaquinaId);
}

function exportMaquinaExcel() {
  const m = db.maquinaria.find(x => x.id === currentMaquinaId);
  if (!m) return;
  const ing = m.horas * m.tarifa;
  const cos = m.horas * m.costoHora;
  exportToCSV([
    ['Campo', 'Valor'],
    ['Equipo', m.nombre], ['Tipo', m.tipo], ['Modelo', m.modelo], ['MatrÃ­cula', m.matricula],
    ['Horas Trabajadas', m.horas], ['Tarifa/Hora (USD)', m.tarifa], ['Costo Operativo/Hora (USD)', m.costoHora],
    ['Ingresos (USD)', ing], ['Costos (USD)', cos], ['Utilidad (USD)', ing-cos],
    ['Rentabilidad (%)', ing>0?((ing-cos)/ing*100).toFixed(1):0],
    ['Proyecto', getProyectoNombre(m.proyecto)], ['Estado', m.estado], ['PrÃ³x. Mantenimiento', m.mantenim],
    ['Observaciones', m.obs]
  ], 'maquina_' + m.nombre.replace(/ /g,'_'));
  toast('Excel generado', 'Archivo descargado: ' + m.nombre);
}

function exportMaquinariaExcel() {
  const rows = [['Equipo','Tipo','Modelo','MatrÃ­cula','Horas','Tarifa/h','Costo/h','Ingreso','Costo','Utilidad','Rentabilidad','Proyecto','Estado']];
  db.maquinaria.forEach(m => {
    const ing = m.horas * m.tarifa;
    const cos = m.horas * m.costoHora;
    rows.push([m.nombre,m.tipo,m.modelo,m.matricula,m.horas,m.tarifa,m.costoHora,ing,cos,ing-cos,ing>0?((ing-cos)/ing*100).toFixed(1)+'%':0,getProyectoNombre(m.proyecto),m.estado]);
  });
  exportToCSV(rows, 'maquinaria_completo');
  toast('Excel exportado', db.maquinaria.length + ' equipos exportados');
}

// ===================== MODALS =====================
function openModal(type, id, readonly) {
  if (type === 'proyecto') {
    const isEdit = !!id;
    document.getElementById('modal-proyecto-title').textContent = isEdit ? (readonly ? 'Detalle del Proyecto' : 'Editar Proyecto') : 'Nuevo Proyecto';
    document.getElementById('proyecto-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const p = db.proyectos.find(x => x.id === id);
      if (p) {
        document.getElementById('p-nombre').value = p.nombre;
        document.getElementById('p-tipo').value = p.tipo;
        document.getElementById('p-cliente').value = p.cliente;
        document.getElementById('p-presupuesto').value = p.presupuesto;
        document.getElementById('p-inicio').value = p.inicio || '';
        document.getElementById('p-fin').value = p.fin || '';
        document.getElementById('p-ubicacion').value = p.ubicacion || '';
        document.getElementById('p-estado').value = p.estado;
        document.getElementById('p-avance').value = p.avance;
        document.getElementById('p-descripcion').value = p.descripcion || '';
      }
    } else {
      clearForm(['p-nombre','p-cliente','p-presupuesto','p-inicio','p-fin','p-ubicacion','p-avance','p-descripcion']);
      document.getElementById('p-tipo').value = 'Residencial';
      document.getElementById('p-estado').value = 'pendiente';
    }
    document.getElementById('modal-proyecto').classList.add('open');
  }
  if (type === 'personal') {
    const isEdit = !!id;
    document.getElementById('modal-personal-title').textContent = isEdit ? 'Editar Empleado' : 'Agregar Personal';
    document.getElementById('emp-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const e = db.personal.find(x => x.id === id);
      if (e) {
        document.getElementById('emp-nombre').value = e.nombre;
        document.getElementById('emp-ci').value = e.ci;
        document.getElementById('emp-rol').value = e.rol;
        document.getElementById('emp-cuadrilla').value = e.cuadrilla || '';
        document.getElementById('emp-tipo').value = e.tipo;
        document.getElementById('emp-sueldo').value = e.sueldo;
        document.getElementById('emp-horas').value = e.horas;
        document.getElementById('emp-proyecto').value = e.proyecto || '';
        document.getElementById('emp-tel').value = e.tel || '';
        document.getElementById('emp-email').value = e.email || '';
        document.getElementById('emp-dir').value = e.dir || '';
        document.getElementById('emp-obs').value = e.obs || '';
        document.getElementById('emp-fecha-contrato').value = e.fechaContrato || '';
        document.getElementById('emp-fecha-fin').value = e.fechaFin || '';
      }
    } else {
      clearForm(['emp-nombre','emp-ci','emp-cuadrilla','emp-sueldo','emp-horas','emp-tel','emp-email','emp-dir','emp-obs','emp-fecha-contrato','emp-fecha-fin']);
    }
    document.getElementById('modal-personal').classList.add('open');
  }
  if (type === 'personal-detail') document.getElementById('modal-personal-detail').classList.add('open');
  if (type === 'maquina') {
    const isEdit = !!id;
    document.getElementById('modal-maquina-title').textContent = isEdit ? 'Editar Equipo' : 'Registrar Equipo';
    document.getElementById('maq-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const m = db.maquinaria.find(x => x.id === id);
      if (m) {
        document.getElementById('maq-nombre').value = m.nombre;
        document.getElementById('maq-tipo').value = m.tipo;
        document.getElementById('maq-modelo').value = m.modelo || '';
        document.getElementById('maq-matricula').value = m.matricula || '';
        document.getElementById('maq-horas').value = m.horas;
        document.getElementById('maq-tarifa').value = m.tarifa;
        document.getElementById('maq-costo-hora').value = m.costoHora;
        document.getElementById('maq-proyecto').value = m.proyecto || '';
        document.getElementById('maq-estado').value = m.estado;
        document.getElementById('maq-mantenim').value = m.mantenim || '';
        document.getElementById('maq-obs').value = m.obs || '';
      }
    } else {
      clearForm(['maq-nombre','maq-modelo','maq-matricula','maq-horas','maq-tarifa','maq-costo-hora','maq-mantenim','maq-obs']);
    }
    document.getElementById('modal-maquina').classList.add('open');
  }
  if (type === 'maquina-detail') document.getElementById('modal-maquina-detail').classList.add('open');
  if (type === 'usuario') {
    document.getElementById('usr-id').value = '';
    document.getElementById('usr-nombre').value = '';
    document.getElementById('usr-user').value = '';
    document.getElementById('usr-pass').value = '';
    document.getElementById('usr-pass2').value = '';
    document.getElementById('usr-rol').value = '';
    document.getElementById('usr-email').value = '';
    document.getElementById('usr-rol-desc').style.display = 'none';
    document.getElementById('modal-usr-title').textContent = 'Nuevo Usuario';
    populateProyectoDropdowns();
    const usrProy = document.getElementById('usr-proyecto');
    if (usrProy) usrProy.innerHTML = '<option value="">Todos los proyectos</option>' + db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
    document.getElementById('modal-usuario').classList.add('open');
    return;
  }
  if (type === 'presupuesto') {
    populateProyectoDropdowns();
    document.getElementById('modal-presupuesto').classList.add('open');
  }
  if (type === 'factura') {
    populateProyectoDropdowns();
    clearForm(['fac-numero','fac-cliente','fac-monto','fac-fecha','fac-vence']);
    document.getElementById('fac-estado').value = 'pendiente';
    document.getElementById('modal-factura').classList.add('open');
  }
  if (type === 'proveedor') {
    clearForm(['prov-nombre','prov-rut','prov-rubro','prov-tel']);
    document.getElementById('modal-proveedor').classList.add('open');
  }
  if (type === 'material') {
    populateProyectoDropdowns();
    clearForm(['mat-nombre','mat-cantidad','mat-resp']);
    document.getElementById('mat-tipo').value = 'ENTRADA';
    document.getElementById('modal-material').classList.add('open');
  }
  if (type === 'parte') {
    populateProyectoDropdowns();
    clearForm(['parte-cuadrilla','parte-actividad','parte-obreros','parte-horas','parte-obs']);
    document.getElementById('modal-parte').classList.add('open');
  }
  if (type === 'movimiento') {
    // Populate proyectos in modal
    const mp = document.getElementById('mov-proyecto');
    if (mp) {
      mp.innerHTML = '<option value="">Sin proyecto especÃ­fico</option>' +
        db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
    }
    document.getElementById('mov-id').value = '';
    document.getElementById('mov-tipo').value = 'ingreso';
    document.getElementById('mov-monto').value = '';
    document.getElementById('mov-fecha').value = new Date().toISOString().slice(0,10);
    document.getElementById('mov-categoria').value = 'cobro_cliente';
    document.getElementById('mov-descripcion').value = '';
    document.getElementById('mov-referencia').value = '';
    if (mp) mp.value = '';
    document.getElementById('mov-modal-title').textContent = 'Registrar Movimiento';
    document.getElementById('modal-movimiento').classList.add('open');
  }
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('open');
}

// Close on overlay click
['proyecto','personal','personal-detail','maquina','maquina-detail','confirm'].forEach(t => {
  const el = document.getElementById('modal-' + t);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeModal(t); });
});

function clearForm(ids) { ids.forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; }); }

function populateProyectoDropdowns() {
  const opts = '<option value="">Sin asignar</option>' + db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  ['emp-proyecto','maq-proyecto'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
}

// ===================== SAVE â€” SUPABASE =====================
async function saveProyecto() {
  const nombre = document.getElementById('p-nombre').value.trim();
  const cliente = document.getElementById('p-cliente').value.trim();
  const presupuesto = Number(document.getElementById('p-presupuesto').value);
  if (!nombre || !cliente || !presupuesto) { toast('Campos requeridos', 'CompletÃ¡ nombre, cliente y presupuesto', 'err'); return; }
  const id = document.getElementById('proyecto-id').value;
  const data = {
    nombre, cliente, presupuesto,
    tipo: document.getElementById('p-tipo').value,
    inicio: document.getElementById('p-inicio').value || null,
    fin: document.getElementById('p-fin').value || null,
    ubicacion: document.getElementById('p-ubicacion').value,
    estado: document.getElementById('p-estado').value,
    avance: Number(document.getElementById('p-avance').value) || 0,
    descripcion: document.getElementById('p-descripcion').value,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('proyectos?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Proyecto actualizado', nombre);
    } else {
      await sbFetch('proyectos', { method: 'POST', body: data });
      toast('Proyecto guardado', nombre);
    }
    closeModal('proyecto');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

async function savePersonal() {
  const nombre = document.getElementById('emp-nombre').value.trim();
  const ci = document.getElementById('emp-ci').value.trim();
  if (!nombre || !ci) { toast('Campos requeridos', 'CompletÃ¡ nombre y cÃ©dula', 'err'); return; }
  const id = document.getElementById('emp-id').value;
  const proyId = document.getElementById('emp-proyecto').value;
  const data = {
    nombre, ci,
    rol: document.getElementById('emp-rol').value,
    cuadrilla: document.getElementById('emp-cuadrilla').value,
    tipo: document.getElementById('emp-tipo').value,
    sueldo: Number(document.getElementById('emp-sueldo').value) || 0,
    horas: Number(document.getElementById('emp-horas').value) || 0,
    proyecto_id: proyId || null,
    telefono: document.getElementById('emp-tel').value,
    email: document.getElementById('emp-email').value,
    direccion: document.getElementById('emp-dir').value,
    observaciones: document.getElementById('emp-obs').value,
    fecha_contrato: document.getElementById('emp-fecha-contrato').value || null,
    fecha_fin_contrato: document.getElementById('emp-fecha-fin').value || null,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('personal?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Empleado actualizado', nombre);
    } else {
      await sbFetch('personal', { method: 'POST', body: data });
      toast('Empleado guardado', nombre);
    }
    closeModal('personal');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

async function saveMaquina() {
  const nombre = document.getElementById('maq-nombre').value.trim();
  if (!nombre) { toast('Campo requerido', 'IngresÃ¡ el nombre del equipo', 'err'); return; }
  const id = document.getElementById('maq-id').value;
  const proyId = document.getElementById('maq-proyecto').value;
  const data = {
    nombre,
    tipo: document.getElementById('maq-tipo').value,
    modelo: document.getElementById('maq-modelo').value,
    matricula: document.getElementById('maq-matricula').value,
    horas: Number(document.getElementById('maq-horas').value) || 0,
    tarifa: Number(document.getElementById('maq-tarifa').value) || 0,
    costo_hora: Number(document.getElementById('maq-costo-hora').value) || 0,
    proyecto_id: proyId || null,
    estado: document.getElementById('maq-estado').value,
    proximo_mantenimiento: document.getElementById('maq-mantenim').value || null,
    observaciones: document.getElementById('maq-obs').value,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('maquinaria?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Equipo actualizado', nombre);
    } else {
      await sbFetch('maquinaria', { method: 'POST', body: data });
      toast('Equipo registrado', nombre);
    }
    closeModal('maquina');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== DELETE â€” SUPABASE =====================
function confirmDelete(type, id) {
  const msgs = {
    proyecto: 'Â¿Eliminar este proyecto? Se perderÃ¡n todos sus datos.',
    personal: 'Â¿Eliminar este empleado del sistema?',
    maquina: 'Â¿Eliminar este equipo del parque de maquinaria?',
  };
  document.getElementById('confirm-msg').textContent = msgs[type] || 'Â¿Confirmar eliminaciÃ³n?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      const tableMap = { proyecto: 'proyectos', personal: 'personal', maquina: 'maquinaria' };
      await sbFetch(tableMap[type] + '?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Eliminado correctamente', '', 'err');
      await loadAllData();
    } catch(e) { toast('Error al eliminar', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

// ===================== SEARCH =====================
function globalSearch(val) {
  if (!val) return;
  const q = val.toLowerCase();
  const found = [
    ...db.proyectos.filter(p => p.nombre.toLowerCase().includes(q) || p.cliente.toLowerCase().includes(q)).map(p => p.nombre + ' (Proyecto)'),
    ...db.personal.filter(e => e.nombre.toLowerCase().includes(q) || e.ci.includes(q)).map(e => e.nombre + ' (Personal)'),
    ...db.maquinaria.filter(m => m.nombre.toLowerCase().includes(q) || m.matricula.toLowerCase().includes(q)).map(m => m.nombre + ' (Maquinaria)'),
  ];
  if (found.length > 0) toast('Resultados: ' + found.length, found.slice(0,3).join(', '));
}

// ===================== EXPORT CSV/EXCEL =====================
function exportToCSV(rows, filename) {
  const csv = rows.map(r => r.map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename + '.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===================== CONTRACT ALERTS =====================
function checkContractAlerts() {
  const today = new Date();
  const expiring = [];
  const expired = [];
  db.personal.forEach(e => {
    if (!e.fechaFin) return;
    const fin = new Date(e.fechaFin);
    const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) expired.push(e.nombre);
    else if (diffDays <= 30) expiring.push({ nombre: e.nombre, dias: diffDays });
  });
  if (expired.length > 0) {
    toast('âš ï¸ Contratos vencidos', expired.join(', ') + ' â€” Renovar urgente', 'err');
  } else if (expiring.length > 0) {
    const msg = expiring.map(x => x.nombre + ' (' + x.dias + 'd)').join(', ');
    toast('â° Contratos por vencer', msg, 'warn');
  }
}

// ===================== TOAST =====================
let toastTimer;
function toast(title, msg, type) {
  clearTimeout(toastTimer);
  const t = document.getElementById('toast');
  document.getElementById('toast-title').textContent = title;
  document.getElementById('toast-msg').textContent = msg || '';
  t.className = 'toast open' + (type === 'warn' ? ' warn' : type === 'err' ? ' err' : '');
  toastTimer = setTimeout(() => t.classList.remove('open'), 3500);
}

// Close on overlay click for new modals
['presupuesto','factura','proveedor','material','parte'].forEach(t => {
  const el = document.getElementById('modal-' + t);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeModal(t); });
});

// ===================== OBRAS =====================
// ===================== COTIZADOR =====================
const COTIZ_KEY = 'buildcore_cotizaciones'; // fallback local
function loadCotizacionesLocal() {
  try { return JSON.parse(localStorage.getItem(COTIZ_KEY) || '[]'); } catch(e) { return []; }
}
let cotizaciones = loadCotizacionesLocal();

async function loadCotizacionesSB() {
  try {
    const rows = await sbFetch('cotizaciones?order=created_at.desc');
    cotizaciones = rows.map(c => ({
      id: c.id,
      nombre: c.nombre, cliente: c.cliente, tipo: c.tipo,
      area: c.area, duracion: c.duracion, fecha: c.fecha,
      descripcion: c.descripcion,
      rubros: c.rubros || { materiales:[], manodeobra:[], maquinaria:[], subcontratos:[] },
      gg: c.gg, util: c.util, igv: c.igv,
      estado: c.estado, precioFinal: c.precio_final
    }));
    renderCotizador();
  } catch(e) {
    cotizaciones = loadCotizacionesLocal();
    console.warn('Cotizaciones: usando local', e.message);
  }
}

async function saveCotizacionSB(data, id) {
  const payload = {
    nombre: data.nombre, cliente: data.cliente, tipo: data.tipo,
    area: data.area, duracion: data.duracion, fecha: data.fecha || null,
    descripcion: data.descripcion,
    rubros: data.rubros,
    gg: data.gg, util: data.util, igv: data.igv,
    estado: data.estado, precio_final: data.precioFinal
  };
  if (id) {
    await sbFetch('cotizaciones?id=eq.' + id, { method: 'PATCH', body: payload, prefer: 'return=minimal' });
  } else {
    const res = await sbFetch('cotizaciones', { method: 'POST', body: payload });
    return Array.isArray(res) ? res[0] : res;
  }
}

async function deleteCotizacionSB(id) {
  await sbFetch('cotizaciones?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
}
let cotizActual = null; // cotizaciÃ³n en ediciÃ³n

const RUBROS = {
  materiales:  { label: 'ğŸ§± Materiales',    color: 'var(--accent)',  units: ['mÂ²','mÂ³','ml','kg','ton','bolsa','u.','galÃ³n','rollo'] },
  manodeobra:  { label: 'ğŸ‘· Mano de Obra',  color: 'var(--blue)',    units: ['hora','dÃ­a','semana','mes','global'] },
  maquinaria:  { label: 'ğŸšœ Maquinaria',    color: 'var(--purple)',  units: ['hora','dÃ­a','semana','mes','global'] },
  subcontratos:{ label: 'ğŸ”Œ Subcontratos',  color: 'var(--green)',   units: ['global','mÂ²','punto','ml','u.'] },
};

// Sugerencias de Ã­tems por rubro
const SUGERENCIAS = {
  materiales:  ['Cemento Portland','Acero Ã˜8','Acero Ã˜12','Acero Ã˜16','Arena fina','Arena gruesa','Grava','Ladrillos King Kong','Ladrillos caravista','Triplay','Madera tornillo','Alambre #16','Clavos 3"','Pintura lÃ¡tex','Pintura epÃ³xica','CerÃ¡mico piso','Porcelanato','Vidrio templado','TuberÃ­a PVC 4"','TuberÃ­a PVC 2"','Cable NYY 16mm','Cable NYY 10mm','Concreto premezclado f\'c=210','Concreto premezclado f\'c=175'],
  manodeobra:  ['AlbaÃ±il','Operario','Ayudante','Capataz','Jefe de cuadrilla','Electricista','Plomero','Carpintero','Soldador','Operador de maquinaria','Ing. residente','Ing. de seguridad'],
  maquinaria:  ['Retroexcavadora','Volquete 15mÂ³','GrÃºa torre','Mezcladora concreto','Vibrador de concreto','Compactadora','Motoniveladora','Cisterna de agua','Andamio metÃ¡lico','Encofrado metÃ¡lico'],
  subcontratos:['Instalaciones elÃ©ctricas','Instalaciones sanitarias','Sistema contraincendios','HVAC / Aire acondicionado','Ascensores','Pintura general','Vidrios y aluminios','JardinerÃ­a','Seguridad y vigilancia','Limpieza de obra'],
};

function renderCotizador() {
  document.getElementById('badge-cotiz').textContent = cotizaciones.length;
  renderListaCotizaciones();
}

function renderListaCotizaciones() {
  const el = document.getElementById('cotiz-lista');
  if (cotizaciones.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:28px;font-size:13px;">No hay cotizaciones aÃºn. HacÃ© clic en "ï¼‹ Nueva CotizaciÃ³n".</div>';
    return;
  }
  el.innerHTML = cotizaciones.map((c,i) => {
    const estadoCls = { borrador:'pendiente', enviada:'activo', aprobada:'activo', rechazada:'pausado' }[c.estado] || 'pendiente';
    const estadoTxt = { borrador:'Borrador', enviada:'Enviada', aprobada:'Aprobada', rechazada:'Rechazada' }[c.estado] || c.estado;
    return `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px;">
      <div style="display:flex;align-items:center;gap:14px;min-width:0;">
        <div style="width:42px;height:42px;background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(168,85,247,0.05));border:1px solid rgba(168,85,247,0.3);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;">ğŸ“‹</div>
        <div style="min-width:0;">
          <div style="font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${c.nombre}</div>
          <div style="font-size:12px;color:var(--muted2);">${c.cliente} Â· ${c.tipo} Â· ${c.fecha||'Sin fecha'}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:14px;flex-shrink:0;">
        <div style="text-align:right;">
          <div style="font-size:11px;color:var(--muted);margin-bottom:2px;">Precio Final</div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:var(--accent);">S/ ${Number(c.precioFinal).toLocaleString('es-PE')}</div>
        </div>
        <span class="status-badge ${estadoCls}">${estadoTxt}</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" onclick="abrirCotizacion(${i})">ğŸ‘ Ver</button>
          <button class="btn btn-success btn-sm" onclick="exportCotizExcel(${i})">ğŸ“¥</button>
          <button class="btn btn-ghost btn-sm" onclick="exportCotizPDF(${i})">ğŸ“„</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarCotizacion(${i})">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function nuevaCotizacion() {
  cotizActual = {
    nombre:'', cliente:'', tipo:'Residencial', area:'', duracion:'',
    fecha: new Date().toISOString().slice(0,10),
    descripcion:'',
    rubros: { materiales:[], manodeobra:[], maquinaria:[], subcontratos:[] },
    gg:10, util:15, igv:18,
    estado:'borrador', precioFinal:0
  };
  mostrarFormCotiz();
}

function abrirCotizacion(idx) {
  cotizActual = JSON.parse(JSON.stringify(cotizaciones[idx]));
  cotizActual._editIdx = idx;
  mostrarFormCotiz();
}

function mostrarFormCotiz() {
  document.getElementById('cotiz-lista-wrap').style.display = 'none';
  document.getElementById('cotiz-form-wrap').style.display = 'block';
  document.getElementById('btn-volver-cotiz').style.display = 'inline-flex';
  document.getElementById('btn-export-cotiz').style.display = 'inline-flex';
  document.getElementById('btn-pdf-cotiz').style.display = 'inline-flex';

  // Rellenar header
  document.getElementById('cot-nombre').value = cotizActual.nombre || '';
  document.getElementById('cot-cliente').value = cotizActual.cliente || '';
  document.getElementById('cot-tipo').value = cotizActual.tipo || 'Residencial';
  document.getElementById('cot-area').value = cotizActual.area || '';
  document.getElementById('cot-duracion').value = cotizActual.duracion || '';
  document.getElementById('cot-fecha').value = cotizActual.fecha || '';
  document.getElementById('cot-descripcion').value = cotizActual.descripcion || '';

  // Sliders
  document.getElementById('slider-gg').value = cotizActual.gg;
  document.getElementById('slider-util').value = cotizActual.util;
  document.getElementById('slider-igv').value = cotizActual.igv;

  // Renderizar rubros
  ['materiales','manodeobra','maquinaria','subcontratos'].forEach(r => {
    const tbody = document.getElementById('tbody-' + r);
    tbody.innerHTML = '';
    (cotizActual.rubros[r] || []).forEach(item => addRubroRow(r, item));
    if ((cotizActual.rubros[r] || []).length === 0) addRubroRow(r);
  });

  recalcResumen();
}

function ocultarFormCotiz() {
  cotizActual = null;
  document.getElementById('cotiz-lista-wrap').style.display = 'block';
  document.getElementById('cotiz-form-wrap').style.display = 'none';
  document.getElementById('btn-volver-cotiz').style.display = 'none';
  document.getElementById('btn-export-cotiz').style.display = 'none';
  document.getElementById('btn-pdf-cotiz').style.display = 'none';
  renderListaCotizaciones();
}

function addRubroRow(rubro, item = {}) {
  const tbody = document.getElementById('tbody-' + rubro);
  const sugs = SUGERENCIAS[rubro] || [];
  const units = RUBROS[rubro].units;
  const rowId = 'row-' + rubro + '-' + Date.now() + '-' + Math.random().toString(36).slice(2,6);

  const tr = document.createElement('tr');
  tr.id = rowId;
  tr.innerHTML = `
    <td style="padding:6px 8px;">
      <input type="text" class="form-input" style="min-width:160px;" list="sug-${rubro}" value="${item.desc||''}"
        placeholder="DescripciÃ³n..." oninput="recalcRow('${rowId}','${rubro}')">
      <datalist id="sug-${rubro}">${sugs.map(s=>`<option value="${s}">`).join('')}</datalist>
    </td>
    <td style="padding:6px 8px;">
      <select class="form-input" style="min-width:80px;" oninput="recalcRow('${rowId}','${rubro}')">
        ${units.map(u=>`<option value="${u}" ${u===(item.unit||units[0])?'selected':''}>${u}</option>`).join('')}
      </select>
    </td>
    <td style="padding:6px 8px;">
      <input type="number" class="form-input" style="min-width:80px;" value="${item.qty||''}" min="0"
        placeholder="0" oninput="recalcRow('${rowId}','${rubro}')">
    </td>
    <td style="padding:6px 8px;">
      <input type="number" class="form-input" style="min-width:90px;" value="${item.price||''}" min="0"
        placeholder="0.00" oninput="recalcRow('${rowId}','${rubro}')">
    </td>
    <td style="padding:6px 8px;font-family:'Syne',sans-serif;font-weight:700;color:${RUBROS[rubro].color};" id="sub-${rowId}">
      S/ ${formatNum((item.qty||0)*(item.price||0))}
    </td>
    <td style="padding:6px 4px;">
      <button style="background:rgba(239,68,68,0.1);border:none;color:var(--red);cursor:pointer;border-radius:6px;padding:5px 8px;font-size:13px;" onclick="removeRow('${rowId}','${rubro}')">âœ•</button>
    </td>`;
  tbody.appendChild(tr);
}

function recalcRow(rowId, rubro) {
  const tr = document.getElementById(rowId);
  if (!tr) return;
  const inputs = tr.querySelectorAll('input[type="number"]');
  const qty = parseFloat(inputs[0].value) || 0;
  const price = parseFloat(inputs[1].value) || 0;
  const sub = qty * price;
  document.getElementById('sub-'+rowId).textContent = 'S/ ' + formatNum(sub);
  recalcResumen();
}

function removeRow(rowId, rubro) {
  const el = document.getElementById(rowId);
  if (el) el.remove();
  recalcResumen();
}

function getRubroTotal(rubro) {
  const tbody = document.getElementById('tbody-' + rubro);
  if (!tbody) return 0;
  let total = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input[type="number"]');
    if (inputs.length >= 2) {
      total += (parseFloat(inputs[0].value)||0) * (parseFloat(inputs[1].value)||0);
    }
  });
  return total;
}

function recalcResumen() {
  const gg = parseInt(document.getElementById('slider-gg').value) || 0;
  const util = parseInt(document.getElementById('slider-util').value) || 0;
  const igv = parseInt(document.getElementById('slider-igv').value) || 0;
  document.getElementById('val-gg').textContent = gg + '%';
  document.getElementById('val-util').textContent = util + '%';
  document.getElementById('val-igv').textContent = igv + '%';

  const mat = getRubroTotal('materiales');
  const mdo = getRubroTotal('manodeobra');
  const maq = getRubroTotal('maquinaria');
  const sub = getRubroTotal('subcontratos');

  ['materiales','manodeobra','maquinaria','subcontratos'].forEach(r => {
    const el = document.getElementById('sub-' + r);
    if (el) el.textContent = 'S/ ' + formatNum(getRubroTotal(r));
  });

  const costoDirecto = mat + mdo + maq + sub;
  const montoGG = costoDirecto * gg / 100;
  const costoTotal = costoDirecto + montoGG;
  const montoUtil = costoTotal * util / 100;
  const subtotalSinIGV = costoTotal + montoUtil;
  const montoIGV = subtotalSinIGV * igv / 100;
  const precioFinal = subtotalSinIGV + montoIGV;

  document.getElementById('sub-materiales').textContent = 'S/ ' + formatNum(mat);
  document.getElementById('sub-manodeobra').textContent = 'S/ ' + formatNum(mdo);
  document.getElementById('sub-maquinaria').textContent = 'S/ ' + formatNum(maq);
  document.getElementById('sub-subcontratos').textContent = 'S/ ' + formatNum(sub);
  document.getElementById('res-materiales').textContent = 'S/ ' + formatNum(mat);
  document.getElementById('res-mdo').textContent = 'S/ ' + formatNum(mdo);
  document.getElementById('res-maq').textContent = 'S/ ' + formatNum(maq);
  document.getElementById('res-sub').textContent = 'S/ ' + formatNum(sub);
  document.getElementById('res-costo-directo').textContent = 'S/ ' + formatNum(costoDirecto);
  document.getElementById('res-precio-final').textContent = 'S/ ' + formatNum(precioFinal);
  document.getElementById('res-desglose-final').textContent =
    `CD: S/${formatNum(costoDirecto)} + GG: S/${formatNum(montoGG)} + Util: S/${formatNum(montoUtil)} + IGV: S/${formatNum(montoIGV)}`;
}

function getCotizData() {
  return {
    nombre: document.getElementById('cot-nombre').value.trim() || 'Sin nombre',
    cliente: document.getElementById('cot-cliente').value.trim() || 'Sin cliente',
    tipo: document.getElementById('cot-tipo').value,
    area: document.getElementById('cot-area').value,
    duracion: document.getElementById('cot-duracion').value,
    fecha: document.getElementById('cot-fecha').value,
    descripcion: document.getElementById('cot-descripcion').value,
    gg: parseInt(document.getElementById('slider-gg').value),
    util: parseInt(document.getElementById('slider-util').value),
    igv: parseInt(document.getElementById('slider-igv').value),
    rubros: {
      materiales: getRowsData('materiales'),
      manodeobra: getRowsData('manodeobra'),
      maquinaria: getRowsData('maquinaria'),
      subcontratos: getRowsData('subcontratos'),
    },
    estado: 'borrador',
    precioFinal: calcPrecioFinal(),
  };
}

function getRowsData(rubro) {
  const tbody = document.getElementById('tbody-' + rubro);
  if (!tbody) return [];
  const rows = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const desc = tr.querySelector('input[type="text"]');
    const sel = tr.querySelector('select');
    const nums = tr.querySelectorAll('input[type="number"]');
    if (desc && nums.length >= 2) {
      const qty = parseFloat(nums[0].value) || 0;
      const price = parseFloat(nums[1].value) || 0;
      if (desc.value.trim() || qty || price) {
        rows.push({ desc: desc.value.trim(), unit: sel ? sel.value : '', qty, price, sub: qty*price });
      }
    }
  });
  return rows;
}

function calcPrecioFinal() {
  const gg = parseInt(document.getElementById('slider-gg').value) || 0;
  const util = parseInt(document.getElementById('slider-util').value) || 0;
  const igv = parseInt(document.getElementById('slider-igv').value) || 0;
  const cd = ['materiales','manodeobra','maquinaria','subcontratos'].reduce((a,r) => a + getRubroTotal(r), 0);
  const total = cd * (1 + gg/100) * (1 + util/100) * (1 + igv/100);
  return Math.round(total);
}

async function guardarCotizacion() {
  const data = getCotizData();
  if (!data.nombre || data.nombre === 'Sin nombre') {
    toast('Campo requerido', 'IngresÃ¡ el nombre del proyecto', 'err'); return;
  }
  showLoading(true);
  try {
    if (cotizActual && cotizActual._editIdx !== undefined) {
      const existId = cotizaciones[cotizActual._editIdx]?.id;
      if (existId) {
        await saveCotizacionSB(data, existId);
        data.id = existId;
      }
      cotizaciones[cotizActual._editIdx] = data;
      toast('CotizaciÃ³n actualizada', data.nombre);
    } else {
      const saved = await saveCotizacionSB(data);
      if (saved?.id) data.id = saved.id;
      cotizaciones.push(data);
      toast('CotizaciÃ³n guardada', data.nombre);
    }
    // Also update local fallback
    localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
  } catch(e) {
    // Offline fallback
    if (cotizActual && cotizActual._editIdx !== undefined) {
      cotizaciones[cotizActual._editIdx] = data;
    } else {
      data.id = 'local_' + Date.now();
      cotizaciones.push(data);
    }
    localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
    toast('Guardado localmente', 'Sin conexiÃ³n a Supabase', 'warn');
  } finally {
    showLoading(false);
  }
  document.getElementById('badge-cotiz').textContent = cotizaciones.length;
  ocultarFormCotiz();
}

async function eliminarCotizacion(idx) {
  const cotiz = cotizaciones[idx];
  showLoading(true);
  try {
    if (cotiz?.id && !String(cotiz.id).startsWith('local_')) {
      await deleteCotizacionSB(cotiz.id);
    }
  } catch(e) { console.warn('No se pudo eliminar de Supabase:', e.message); }
  finally { showLoading(false); }
  cotizaciones.splice(idx, 1);
  localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
  document.getElementById('badge-cotiz').textContent = cotizaciones.length;
  renderListaCotizaciones();
  toast('CotizaciÃ³n eliminada', '', 'err');
}

// ===== EXPORT EXCEL =====
function exportCotizExcel(idx) {
  const c = idx !== undefined ? cotizaciones[idx] : getCotizData();
  const rows = [
    ['COTIZACIÃ“N DE PROYECTO â€” BuildCore'],
    [''],
    ['Proyecto:', c.nombre, '', 'Cliente:', c.cliente],
    ['Tipo:', c.tipo, '', 'Ãrea:', c.area],
    ['DuraciÃ³n:', c.duracion + ' meses', '', 'Fecha:', c.fecha],
    [''],
    ['MATERIALES'],
    ['DescripciÃ³n','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.materiales.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL MATERIALES', c.rubros.materiales.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['MANO DE OBRA'],
    ['DescripciÃ³n','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.manodeobra.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL MANO DE OBRA', c.rubros.manodeobra.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['MAQUINARIA'],
    ['DescripciÃ³n','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.maquinaria.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL MAQUINARIA', c.rubros.maquinaria.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['SUBCONTRATOS'],
    ['DescripciÃ³n','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.subcontratos.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL SUBCONTRATOS', c.rubros.subcontratos.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['RESUMEN DE COSTOS'],
    ['Costo Directo Total','', '', '', Object.values(c.rubros).flat().reduce((a,r)=>a+r.sub,0)],
    ['Gastos Generales', c.gg + '%'],
    ['Utilidad', c.util + '%'],
    ['IGV', c.igv + '%'],
    ['PRECIO FINAL OFERTA', '', '', '', c.precioFinal],
  ];
  exportToCSV(rows, 'cotizacion_' + c.nombre.replace(/\s+/g,'_').toLowerCase());
  toast('Excel exportado', c.nombre);
}

// ===== EXPORT PDF =====
function exportCotizPDF(idx) {
  const c = idx !== undefined ? cotizaciones[idx] : getCotizData();
  const gg = c.gg; const util = c.util; const igv = c.igv;
  const cd = Object.values(c.rubros).flat().reduce((a,r)=>a+r.sub,0);
  const montoGG = cd * gg/100;
  const costoTotal = cd + montoGG;
  const montoUtil = costoTotal * util/100;
  const subtotal = costoTotal + montoUtil;
  const montoIGV = subtotal * igv/100;
  const precioFinal = subtotal + montoIGV;

  const rubroRows = (rubro, titulo, color) => {
    if (!c.rubros[rubro] || c.rubros[rubro].length === 0) return '';
    const sub = c.rubros[rubro].reduce((a,r)=>a+r.sub,0);
    return `
      <tr><td colspan="5" style="background:#1a1a2e;padding:8px 12px;font-weight:700;font-size:12px;color:${color};">${titulo}</td></tr>
      <tr style="background:#111;"><th style="padding:7px 10px;font-size:11px;color:#888;text-transform:uppercase;">DescripciÃ³n</th><th style="padding:7px 10px;font-size:11px;color:#888;">Unidad</th><th style="padding:7px 10px;font-size:11px;color:#888;">Cant.</th><th style="padding:7px 10px;font-size:11px;color:#888;">P.Unit</th><th style="padding:7px 10px;font-size:11px;color:#888;text-align:right;">Subtotal</th></tr>
      ${c.rubros[rubro].map(r => `<tr style="border-bottom:1px solid #222;"><td style="padding:7px 10px;font-size:12px;">${r.desc}</td><td style="padding:7px 10px;font-size:12px;color:#888;">${r.unit}</td><td style="padding:7px 10px;font-size:12px;">${r.qty}</td><td style="padding:7px 10px;font-size:12px;">S/ ${formatNum(r.price)}</td><td style="padding:7px 10px;font-size:12px;text-align:right;font-weight:600;">S/ ${formatNum(r.sub)}</td></tr>`).join('')}
      <tr style="background:#1a1a2e;"><td colspan="4" style="padding:8px 10px;font-size:12px;font-weight:700;">Subtotal ${titulo}</td><td style="padding:8px 10px;font-weight:800;color:${color};text-align:right;font-size:13px;">S/ ${formatNum(sub)}</td></tr>`;
  };

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#0d0f12; color:#f1f5f9; padding:0; }
    .page { max-width:800px; margin:0 auto; padding:32px 28px; }
    .header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:28px; padding-bottom:20px; border-bottom:2px solid #f5a623; }
    .logo { font-size:24px; font-weight:900; } .logo span { color:#f5a623; }
    .badge { background:rgba(245,166,35,0.15); color:#f5a623; padding:5px 14px; border-radius:20px; font-size:12px; font-weight:700; border:1px solid rgba(245,166,35,0.3); }
    h1 { font-size:20px; font-weight:800; margin-bottom:4px; }
    .meta { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px; }
    .meta-box { background:#13161b; border:1px solid #222; border-radius:10px; padding:14px; }
    .meta-label { font-size:10px; color:#64748b; font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px; }
    .meta-val { font-size:13px; font-weight:600; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; }
    .resumen { background:#13161b; border:1px solid #222; border-radius:12px; padding:20px; margin-top:20px; }
    .res-row { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid #222; font-size:13px; }
    .res-row:last-child { border:none; }
    .precio-final { background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(232,82,26,0.1)); border:1px solid rgba(245,166,35,0.3); border-radius:12px; padding:20px; text-align:center; margin-top:16px; }
    .precio-final .label { font-size:11px; color:#94a3b8; font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-bottom:8px; }
    .precio-final .valor { font-size:36px; font-weight:900; color:#f5a623; }
    .footer { text-align:center; margin-top:28px; padding-top:16px; border-top:1px solid #222; font-size:11px; color:#64748b; }
    @media print { body { background:#fff; color:#000; } .page { padding:20px; } }
  </style></head><body>
  <div class="page">
    <div class="header">
      <div><div class="logo">Build<span>Core</span></div><div style="font-size:12px;color:#64748b;margin-top:2px;">Sistema de GestiÃ³n de Constructoras</div></div>
      <div style="text-align:right;"><span class="badge">COTIZACIÃ“N OFICIAL</span><div style="font-size:11px;color:#64748b;margin-top:6px;">Fecha: ${c.fecha}</div></div>
    </div>
    <h1>${c.nombre}</h1>
    <div style="font-size:13px;color:#94a3b8;margin-bottom:20px;">${c.descripcion||''}</div>
    <div class="meta">
      <div class="meta-box"><div class="meta-label">Cliente</div><div class="meta-val">${c.cliente}</div></div>
      <div class="meta-box"><div class="meta-label">Tipo de Obra</div><div class="meta-val">${c.tipo}</div></div>
      <div class="meta-box"><div class="meta-label">Ãrea / Envergadura</div><div class="meta-val">${c.area||'â€”'}</div></div>
      <div class="meta-box"><div class="meta-label">DuraciÃ³n Estimada</div><div class="meta-val">${c.duracion ? c.duracion+' meses' : 'â€”'}</div></div>
    </div>
    <table>
      ${rubroRows('materiales','ğŸ§± MATERIALES','#f5a623')}
      ${rubroRows('manodeobra','ğŸ‘· MANO DE OBRA','#3b82f6')}
      ${rubroRows('maquinaria','ğŸšœ MAQUINARIA','#a855f7')}
      ${rubroRows('subcontratos','ğŸ”Œ SUBCONTRATOS','#22c55e')}
    </table>
    <div class="resumen">
      <div style="font-weight:800;font-size:14px;margin-bottom:14px;">ğŸ“Š Resumen de Costos</div>
      <div class="res-row"><span>Costo Directo Total</span><span style="font-weight:700;">S/ ${formatNum(cd)}</span></div>
      <div class="res-row"><span>Gastos Generales (${gg}%)</span><span>S/ ${formatNum(montoGG)}</span></div>
      <div class="res-row"><span>Utilidad / Ganancia (${util}%)</span><span style="color:#22c55e;">S/ ${formatNum(montoUtil)}</span></div>
      <div class="res-row"><span>IGV (${igv}%)</span><span>S/ ${formatNum(montoIGV)}</span></div>
    </div>
    <div class="precio-final">
      <div class="label">ğŸ’° Precio Final â€” Oferta a Presentar</div>
      <div class="valor">S/ ${formatNum(precioFinal)}</div>
      <div style="font-size:12px;color:#64748b;margin-top:8px;">Precio vÃ¡lido por 30 dÃ­as desde la fecha de emisiÃ³n</div>
    </div>
    <div class="footer">CotizaciÃ³n generada por BuildCore â€” Sistema de GestiÃ³n de Constructoras<br>Este documento es una estimaciÃ³n sujeta a revisiÃ³n tÃ©cnica final</div>
  </div>
  <script>window.onload=()=>window.print();<\/script>
  </body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('PDF generado', 'Se abriÃ³ la ventana de impresiÃ³n');
}

function formatNum(n) {
  return Number(n||0).toLocaleString('es-PE', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function renderObras() {
  const activas = db.proyectos.filter(p => p.estado === 'activo' || p.estado === 'progreso').length;
  const totalObreros = db.personal.filter(e => e.proyecto).length;
  const totalHoras = db.personal.reduce((a,e)=>a+Number(e.horas),0);
  document.getElementById('ob-activas').textContent = activas || 5;
  document.getElementById('ob-obreros').textContent = totalObreros || 96;
  document.getElementById('ob-horas').textContent = (totalHoras || 768) + 'h';
}

// ===================== PRESUPUESTOS =====================
function renderPresupuestos() {
  const total = db.presupuestos.length;
  const aprobados = db.presupuestos.filter(p=>p.estado==='aprobado').length;
  const revision = db.presupuestos.filter(p=>p.estado==='revision' || p.estado==='negociacion').length;
  const rechazados = db.presupuestos.filter(p=>p.estado==='rechazado').length;
  document.getElementById('pres-total').textContent = total;
  document.getElementById('pres-aprobados').textContent = aprobados;
  document.getElementById('pres-revision').textContent = revision;
  document.getElementById('pres-rechazados').textContent = rechazados;
  document.getElementById('badge-presupuestos').textContent = total;
  const tbody = document.getElementById('presupuestos-table');
  if (!tbody) return;
  if (db.presupuestos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay presupuestos. HacÃ© clic en "+ Nuevo Presupuesto".</td></tr>';
    return;
  }
  const estadoMap = { revision:'pendiente', aprobado:'activo', negociacion:'progreso', rechazado:'pausado' };
  const estadoTxt = { revision:'En RevisiÃ³n', aprobado:'Aprobado', negociacion:'NegociaciÃ³n', rechazado:'Rechazado' };
  const rows = db.presupuestos.map(p => ({
    tr: `<tr>
      <td><div class="td-name">${p.nombre}</div></td>
      <td>${p.cliente}</td>
      <td style="font-weight:700;">${fmt(p.monto)}</td>
      <td style="color:var(--muted2);">${p.fecha || 'â€”'}</td>
      <td><span class="status-badge ${estadoMap[p.estado]||'pendiente'}">${estadoTxt[p.estado]||p.estado}</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF generado','${p.nombre}')">ğŸ“„ PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="editPresupuesto('${p.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deletePresupuesto('${p.id}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`,
    card: `<div class="mobile-card">
      <div class="mc-header">
        <div><div class="mc-name">${p.nombre}</div><div class="mc-sub">${p.cliente}</div></div>
        <span class="status-badge ${estadoMap[p.estado]||'pendiente'}">${estadoTxt[p.estado]||p.estado}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Monto</div><div class="mc-val" style="color:var(--green)">${fmt(p.monto)}</div></div>
        <div><div class="mc-label">Fecha EnvÃ­o</div><div class="mc-val">${p.fecha || 'â€”'}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF','${p.nombre}')">ğŸ“„ PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="editPresupuesto('${p.id}')">âœï¸ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deletePresupuesto('${p.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`
  }));
  tbody.innerHTML = rows.map(r=>r.tr).join('');
  const mob = document.getElementById('presupuestos-mobile');
  if (mob) mob.innerHTML = rows.map(r=>r.card).join('');
}

function editPresupuesto(id) {
  const p = db.presupuestos.find(x=>x.id===id);
  if (!p) return;
  document.getElementById('pres-id').value = p.id;
  document.getElementById('pres-nombre').value = p.nombre;
  document.getElementById('pres-cliente').value = p.cliente;
  document.getElementById('pres-monto').value = p.monto;
  document.getElementById('pres-fecha').value = p.fecha||'';
  document.getElementById('pres-estado').value = p.estado;
  document.getElementById('pres-obs').value = p.obs||'';
  document.getElementById('modal-pres-title').textContent = 'Editar Presupuesto';
  document.getElementById('modal-presupuesto').classList.add('open');
}

async function deletePresupuesto(id) {
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar este presupuesto?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('presupuestos?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Presupuesto eliminado','','err');
      await loadAllData(); renderPresupuestos();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

async function savePresupuesto() {
  const nombre = document.getElementById('pres-nombre').value.trim();
  const cliente = document.getElementById('pres-cliente').value.trim();
  const monto = Number(document.getElementById('pres-monto').value);
  if (!nombre || !cliente || !monto) { toast('Campos requeridos','CompletÃ¡ nombre, cliente y monto','err'); return; }
  const id = document.getElementById('pres-id').value;
  const data = {
    nombre, cliente, monto,
    fecha: document.getElementById('pres-fecha').value || null,
    estado: document.getElementById('pres-estado').value,
    observaciones: document.getElementById('pres-obs').value
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('presupuestos?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Presupuesto actualizado', nombre);
    } else {
      await sbFetch('presupuestos', { method: 'POST', body: data });
      toast('Presupuesto guardado', nombre);
    }
    closeModal('presupuesto');
    document.getElementById('pres-id').value = '';
    document.getElementById('modal-pres-title').textContent = 'Nuevo Presupuesto';
    await loadAllData(); renderPresupuestos();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== FACTURA SAVE =====================
async function saveFactura() {
  const numero = document.getElementById('fac-numero').value.trim();
  const cliente = document.getElementById('fac-cliente').value.trim();
  const monto = Number(document.getElementById('fac-monto').value);
  if (!numero || !cliente || !monto) { toast('Campos requeridos','CompletÃ¡ nÃºmero, cliente y monto','err'); return; }
  const proyId = document.getElementById('fac-proyecto').value;
  const data = {
    numero, cliente, monto,
    proyecto_id: proyId || null,
    fecha_emision: document.getElementById('fac-fecha').value || null,
    fecha_vencimiento: document.getElementById('fac-vence').value || null,
    estado: document.getElementById('fac-estado').value
  };
  try {
    showLoading(true);
    await sbFetch('facturas', { method: 'POST', body: data });
    toast('Factura registrada', numero);
    closeModal('factura');
    clearForm(['fac-numero','fac-cliente','fac-monto','fac-fecha','fac-vence']);
    await loadAllData(); renderFacturas();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== PROVEEDOR SAVE =====================
async function saveProveedor() {
  const nombre = document.getElementById('prov-nombre').value.trim();
  if (!nombre) { toast('Campo requerido','IngresÃ¡ el nombre del proveedor','err'); return; }
  const data = {
    nombre,
    rut: document.getElementById('prov-rut').value,
    rubro: document.getElementById('prov-rubro').value,
    telefono: document.getElementById('prov-tel').value,
    estado: 'activo'
  };
  try {
    showLoading(true);
    await sbFetch('proveedores', { method: 'POST', body: data });
    toast('Proveedor guardado', nombre);
    closeModal('proveedor');
    clearForm(['prov-nombre','prov-rut','prov-rubro','prov-tel']);
    await loadAllData(); renderProveedores();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== MATERIAL SAVE =====================
async function saveMaterial() {
  const nombre = document.getElementById('mat-nombre').value.trim();
  if (!nombre) { toast('Campo requerido','IngresÃ¡ el nombre del material','err'); return; }
  const proyId = document.getElementById('mat-proyecto').value;
  const data = {
    nombre,
    tipo: document.getElementById('mat-tipo').value,
    cantidad: document.getElementById('mat-cantidad').value,
    proyecto_id: proyId || null,
    responsable: document.getElementById('mat-resp').value,
    fecha: new Date().toISOString()
  };
  try {
    showLoading(true);
    await sbFetch('materiales', { method: 'POST', body: data });
    toast('Movimiento registrado', data.tipo + ': ' + nombre);
    closeModal('material');
    clearForm(['mat-nombre','mat-cantidad','mat-resp']);
    await loadAllData(); renderMateriales();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== PARTE DIARIO SAVE =====================
function saveParte() {
  const proyecto = document.getElementById('parte-proyecto').value;
  const actividad = document.getElementById('parte-actividad').value.trim();
  if (!actividad) { toast('Campo requerido','IngresÃ¡ la actividad realizada','err'); return; }
  const cuadrilla = document.getElementById('parte-cuadrilla').value;
  const obreros = document.getElementById('parte-obreros').value;
  const horas = document.getElementById('parte-horas').value;
  const clima = document.getElementById('parte-clima').value;
  const tbody = document.getElementById('obras-partes-table');
  // Remove placeholder if present
  if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
  const newRow = document.createElement('tr');
  const climaBadge = clima === 'Lluvia' || clima === 'Viento fuerte' ? 'pausado' : 'activo';
  newRow.innerHTML = `<td><div class="td-name">${getProyectoNombre(proyecto)||'Sin asignar'}</div></td><td>${actividad}</td><td>${cuadrilla||'â€”'}</td><td>${obreros||0}</td><td>${((obreros||0)*(horas||0))}h</td><td><span class="status-badge ${climaBadge}">${clima}</span></td>`;
  tbody.insertBefore(newRow, tbody.firstChild);
  if (document.getElementById('ob-obreros')) {
    const curr = parseInt(document.getElementById('ob-obreros').textContent)||0;
    document.getElementById('ob-obreros').textContent = curr + parseInt(obreros||0);
  }
  toast('Parte diario registrado', actividad);
  closeModal('parte');
  clearForm(['parte-cuadrilla','parte-actividad','parte-obreros','parte-horas','parte-obs']);
}

// ===================== REPORTES =====================
function renderReportes() {
  const totalPres = db.proyectos.reduce((a,p)=>a+Number(p.presupuesto),0);
  document.getElementById('rep-cartera').textContent = fmtM(totalPres);
  const activos = db.proyectos.filter(p=>p.estado!=='pausado').length;
  const finalizados = db.proyectos.filter(p=>p.estado==='finalizado').length;
  const cumpl = activos > 0 ? Math.round((finalizados / activos) * 100) || 78 : 78;
  document.getElementById('rep-cumplimiento').textContent = cumpl + '%';
  const now = new Date();
  document.getElementById('rep-fecha').textContent = 'Datos al ' + now.toLocaleDateString('es-UY');
  const tbody = document.getElementById('reportes-table');
  if (!tbody) return;
  if (db.proyectos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos.</td></tr>';
    return;
  }
  tbody.innerHTML = db.proyectos.map(p => {
    const ejecutado = (p.presupuesto * p.avance / 100);
    const desv = (Math.random() * 6 - 2).toFixed(1);
    const margen = (20 + Math.random() * 8).toFixed(1);
    const desvColor = desv > 0 ? 'var(--red)' : 'var(--green)';
    return `<tr>
      <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.tipo}</div></td>
      <td>${fmtM(p.presupuesto)}</td>
      <td>${fmtM(Math.round(ejecutado))}</td>
      <td style="color:${desvColor};font-weight:700;">${desv > 0 ? '+' : ''}${desv}%</td>
      <td style="color:var(--green);font-weight:700;">${margen}%</td>
      <td><div style="display:flex;align-items:center;gap:8px;font-size:12px;min-width:120px">
        <div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>${p.avance}%
      </div></td>
    </tr>`;
  }).join('');
}

// ===================== CANVAS CHARTS =====================

// Shared helpers
function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

function drawLineChart(canvasId, datasets, labels, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
  const H = opts.height || 140;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const pad = { top: 20, right: 20, bottom: 28, left: 42 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  // Background
  ctx.fillStyle = 'transparent';
  ctx.clearRect(0, 0, W, H);

  // Find max
  const allVals = datasets.flatMap(d => d.data);
  const maxVal = Math.max(...allVals) * 1.15;
  const minVal = 0;

  // Grid lines
  const gridCount = 4;
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= gridCount; i++) {
    const y = pad.top + ch - (ch * i / gridCount);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    const val = (minVal + (maxVal - minVal) * i / gridCount);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans, sans-serif'; ctx.textAlign = 'right';
    ctx.fillText((val >= 1 ? val.toFixed(1) : val.toFixed(2)) + (opts.unit || ''), pad.left - 6, y + 3);
  }

  // X labels
  ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.font = '10px DM Sans, sans-serif';
  labels.forEach((lbl, i) => {
    const x = pad.left + (i / (labels.length - 1)) * cw;
    ctx.fillText(lbl, x, H - 6);
  });

  // Draw each dataset
  datasets.forEach(ds => {
    const pts = ds.data.map((v, i) => ({
      x: pad.left + (i / (ds.data.length - 1)) * cw,
      y: pad.top + ch - ((v - minVal) / (maxVal - minVal)) * ch
    }));

    // Area fill
    if (ds.fill !== false) {
      const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
      grad.addColorStop(0, `rgba(${hexToRgb(ds.color)},0.25)`);
      grad.addColorStop(1, `rgba(${hexToRgb(ds.color)},0)`);
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pad.top + ch);
      pts.forEach(p => ctx.lineTo(p.x, p.y));
      ctx.lineTo(pts[pts.length-1].x, pad.top + ch);
      ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();
    }

    // Line
    ctx.beginPath();
    ctx.strokeStyle = ds.color; ctx.lineWidth = ds.lineWidth || 2.5;
    if (ds.dashed) ctx.setLineDash([5, 3]); else ctx.setLineDash([]);
    pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
    ctx.stroke(); ctx.setLineDash([]);

    // Dots on last point
    const last = pts[pts.length - 1];
    ctx.beginPath(); ctx.arc(last.x, last.y, 4, 0, Math.PI*2);
    ctx.fillStyle = ds.color; ctx.fill();
    ctx.strokeStyle = '#13161b'; ctx.lineWidth = 2; ctx.stroke();
  });
}

function drawBarChart(canvasId, labels, values, colors, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 400;
  const H = opts.height || 200;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const pad = { top: 24, right: 16, bottom: 32, left: 48 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;
  const maxVal = Math.max(...values) * 1.15;
  const barW = Math.min(42, (cw / labels.length) * 0.55);
  const gap = cw / labels.length;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (ch * i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    const v = (maxVal * i / 4);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'right';
    ctx.fillText(v >= 1000 ? (v/1000).toFixed(0)+'k' : v.toFixed(0), pad.left - 6, y + 3);
  }

  // Animate bars
  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, W, H);
    // Redraw grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + ch - (ch * i / 4);
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
      const v = (maxVal * i / 4);
      ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'right';
      ctx.fillText(v >= 1000 ? (v/1000).toFixed(0)+'k' : v.toFixed(0), pad.left - 6, y + 3);
    }

    values.forEach((v, i) => {
      const x = pad.left + gap * i + gap / 2 - barW / 2;
      const fullH = (v / maxVal) * ch;
      const animH = fullH * Math.min(progress, 1);
      const y = pad.top + ch - animH;

      // Bar gradient
      const grad = ctx.createLinearGradient(0, y, 0, pad.top + ch);
      grad.addColorStop(0, colors[i % colors.length]);
      grad.addColorStop(1, colors[i % colors.length] + '88');
      ctx.fillStyle = grad;
      ctx.beginPath();
      const r = 4;
      ctx.moveTo(x + r, y); ctx.lineTo(x + barW - r, y);
      ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
      ctx.lineTo(x + barW, pad.top + ch); ctx.lineTo(x, pad.top + ch);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath(); ctx.fill();

      // Value label on top
      if (progress >= 1) {
        ctx.fillStyle = '#f1f5f9'; ctx.textAlign = 'center'; ctx.font = 'bold 10px DM Sans';
        ctx.fillText(v >= 1000 ? '$'+(v/1000).toFixed(0)+'k' : '$'+v, x + barW/2, y - 5);
      }

      // X label
      ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.font = '9.5px DM Sans';
      ctx.fillText(labels[i], x + barW/2, H - 6);
    });

    if (progress < 1) { progress += 0.06; requestAnimationFrame(animate); }
  };
  animate();
}

function drawHorizontalBarChart(canvasId, labels, values, colors, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 400;
  const H = opts.height || 200;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const pad = { top: 8, right: 50, bottom: 8, left: 120 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;
  const rowH = ch / labels.length;
  const barH = Math.min(20, rowH * 0.55);

  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, W, H);
    labels.forEach((lbl, i) => {
      const y = pad.top + rowH * i + rowH / 2;
      // Label
      ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'right'; ctx.font = '12px DM Sans';
      ctx.fillText(lbl, pad.left - 10, y + 4);

      // Background track
      ctx.fillStyle = 'rgba(255,255,255,0.05)';
      ctx.beginPath(); ctx.roundRect(pad.left, y - barH/2, cw, barH, 4); ctx.fill();

      // Bar
      const pct = (values[i] / 100);
      const barW = cw * pct * Math.min(progress, 1);
      const grad = ctx.createLinearGradient(pad.left, 0, pad.left + cw, 0);
      grad.addColorStop(0, colors[i % colors.length]);
      grad.addColorStop(1, colors[i % colors.length] + 'aa');
      ctx.fillStyle = grad;
      if (barW > 4) {
        ctx.beginPath(); ctx.roundRect(pad.left, y - barH/2, barW, barH, 4); ctx.fill();
      }

      // Percentage label
      if (progress >= 1) {
        ctx.fillStyle = colors[i % colors.length]; ctx.textAlign = 'left'; ctx.font = 'bold 11px Syne, sans-serif';
        ctx.fillText(values[i] + '%', pad.left + cw + 6, y + 4);
      }
    });
    if (progress < 1) { progress += 0.05; requestAnimationFrame(animate); }
  };
  animate();
}

function drawDonutChart(canvasId, data, legendId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const S = 160;
  canvas.width = S * dpr; canvas.height = S * dpr;
  canvas.style.width = S + 'px'; canvas.style.height = S + 'px';
  ctx.scale(dpr, dpr);

  const cx = S/2, cy = S/2, outerR = 68, innerR = 44;
  const total = data.reduce((a,d) => a + d.value, 0);
  let startAngle = -Math.PI / 2;

  // Animate
  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, S, S);

    // Shadow
    ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 12;

    let sa = -Math.PI / 2;
    data.forEach(d => {
      const sweep = (d.value / total) * Math.PI * 2 * Math.min(progress, 1);
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, outerR, sa, sa + sweep);
      ctx.closePath();
      ctx.fillStyle = d.color;
      ctx.fill();
      sa += sweep;
    });

    ctx.shadowBlur = 0;

    // Inner circle cutout
    ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2);
    ctx.fillStyle = '#13161b'; ctx.fill();

    // Center text
    if (progress >= 1) {
      ctx.fillStyle = '#f1f5f9'; ctx.textAlign = 'center'; ctx.font = 'bold 18px Syne, sans-serif';
      ctx.fillText(total, cx, cy + 2);
      ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans';
      ctx.fillText('proyectos', cx, cy + 16);
    }

    if (progress < 1) { progress += 0.04; requestAnimationFrame(animate); }
  };
  animate();

  // Legend
  if (legendId) {
    const leg = document.getElementById(legendId);
    if (leg) leg.innerHTML = data.map(d => `
      <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;">
        <div style="display:flex;align-items:center;gap:8px;color:var(--muted2);">
          <div style="width:10px;height:10px;border-radius:3px;background:${d.color};flex-shrink:0;"></div>${d.label}
        </div>
        <div style="font-weight:700;color:var(--text);">${d.value} â€” ${Math.round(d.value/total*100)}%</div>
      </div>`).join('');
  }
}

// ===================== CHART INITIALIZERS =====================
function initDashCharts() {
  // Line chart data (facturaciÃ³n vs costos)
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'];
  drawLineChart('dash-line-chart', [
    { data: [1.2, 1.8, 2.1, 1.9, 2.8, 3.2, 3.0, 3.8, 4.2, 4.8], color: '#f5a623', label: 'Facturado' },
    { data: [0.9, 1.3, 1.6, 1.5, 2.1, 2.5, 2.3, 2.9, 3.1, 3.6], color: '#3b82f6', label: 'Costo', dashed: true, fill: false }
  ], months, { unit: 'M', height: 140 });

  // Donut chart
  const tipoCount = {};
  db.proyectos.forEach(p => { tipoCount[p.tipo] = (tipoCount[p.tipo] || 0) + 1; });
  const tipoColors = { Residencial: '#f5a623', Comercial: '#3b82f6', Industrial: '#22c55e', Infraestructura: '#a855f7', Institucional: '#14b8a6', Vial: '#f59e0b' };
  let donutData = Object.entries(tipoCount).map(([k,v]) => ({ label: k, value: v, color: tipoColors[k] || '#64748b' }));
  if (donutData.length === 0) donutData = [
    { label: 'Residencial', value: 4, color: '#f5a623' },
    { label: 'Comercial', value: 3, color: '#3b82f6' },
    { label: 'Industrial', value: 2, color: '#22c55e' },
    { label: 'Infraestructura', value: 3, color: '#a855f7' }
  ];
  drawDonutChart('dash-donut-chart', donutData, 'dash-donut-legend');
}

function initReportesCharts() {
  // Bar chart: costos por rubro
  drawBarChart('rep-bar-chart',
    ['Materiales', 'Mano Obra', 'Subcontrato', 'Maquinaria', 'Transporte', 'Seguridad', 'Administr.', 'Otros'],
    [420000, 290000, 215000, 180000, 98000, 72000, 55000, 41000],
    ['#f5a623', '#3b82f6', '#22c55e', '#a855f7', '#f59e0b', '#ef4444', '#14b8a6', '#64748b'],
    { height: 200 }
  );

  // Horizontal bar: avance por proyecto
  const proyLabels = db.proyectos.length ? db.proyectos.map(p => p.nombre.length > 16 ? p.nombre.slice(0,14)+'â€¦' : p.nombre) : ['Torre Mirador','CC Sur','Ruta 102','Hospital Norte','Planta Log.'];
  const proyVals   = db.proyectos.length ? db.proyectos.map(p => p.avance) : [68, 42, 55, 91, 15];
  const proyColors = ['#f5a623','#3b82f6','#22c55e','#a855f7','#14b8a6'];
  drawHorizontalBarChart('rep-hbar-chart', proyLabels, proyVals, proyColors, { height: 200 });

  // Line chart: evoluciÃ³n anual
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'];
  drawLineChart('rep-line-chart', [
    { data: [1.2,1.8,2.1,1.9,2.8,3.2,3.0,3.8,4.2,4.8], color: '#f5a623' },
    { data: [1.0,1.5,1.8,1.6,2.4,2.9,2.6,3.4,3.8,4.3], color: '#22c55e', fill: false },
    { data: [0.9,1.3,1.6,1.5,2.1,2.5,2.3,2.9,3.1,3.6], color: '#ef4444', dashed: true, fill: false }
  ], months, { unit: 'M', height: 130 });
}

function exportReporteExcel() {
  const rows = [['Proyecto','Tipo','Presupuesto','Ejecutado Est.','DesviaciÃ³n','Avance']];
  db.proyectos.forEach(p => rows.push([p.nombre, p.tipo, p.presupuesto, Math.round(p.presupuesto*p.avance/100), 'â€”', p.avance+'%']));
  exportToCSV(rows, 'reporte_ejecutivo');
  toast('Reporte exportado', db.proyectos.length + ' proyectos incluidos');
}

function exportFacturasExcel() {
  toast('Facturas exportadas', 'Archivo descargado correctamente');
}
function exportMaterialesExcel() {
  if (db.materiales.length === 0) { toast('Sin datos', 'No hay movimientos para exportar', 'warn'); return; }
  const rows = [['Material','Tipo','Cantidad','Proyecto','Responsable','Fecha']];
  db.materiales.forEach(m => {
    const fecha = m.fecha ? new Date(m.fecha).toLocaleString('es-PE') : 'â€”';
    rows.push([m.nombre, m.tipo||'â€”', m.cantidad||'â€”', getProyectoNombre(m.proyecto), m.responsable||'â€”', fecha]);
  });
  exportToCSV(rows, 'materiales_' + new Date().toISOString().slice(0,10));
  toast('Excel exportado', db.materiales.length + ' movimientos descargados');
}

// Patch populateProyectoDropdowns to also fill new dropdowns
const _origPopulate = populateProyectoDropdowns;
function populateProyectoDropdowns() {
  const opts = '<option value="">Sin asignar</option>' + db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  ['emp-proyecto','maq-proyecto','fac-proyecto','mat-proyecto','parte-proyecto'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
}

// Login on Enter key
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); });

// ===================== USUARIOS & ROLES =====================
// Storage key for users (localStorage as Supabase users table is optional)
const USERS_KEY = 'buildcore_usuarios'; // fallback local
let _usuariosCache = [];

async function loadUsuariosSB() {
  // Show local cache immediately so UI never stays "Cargando..."
  try { 
    const cached = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
    if (cached.length > 0) { _usuariosCache = cached; }
  } catch(e) {}
  
  try {
    const rows = await sbFetch('usuarios_sistema?order=created_at.desc');
    if (!Array.isArray(rows)) throw new Error('Respuesta invÃ¡lida');
    _usuariosCache = rows.map(u => ({
      id: u.id,
      nombre: u.nombre_completo || u.nombre || u.user_nombre || 'Sin nombre',
      user: u.user_nombre || u.usuario || u.user || '',
      pass: u.password_hash || '',
      rol: u.rol || 'capataz',
      proyecto: u.proyecto_id || '',
      email: u.email || '',
      activo: u.activo !== false,
      lastLogin: u.last_login || '',
      creado: u.created_at || ''
    }));
    localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
    return _usuariosCache;
  } catch(e) {
    console.warn('Usuarios SB error:', e.message);
    // If table doesn't exist or error, use localStorage
    try { _usuariosCache = JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
    catch(e2) { _usuariosCache = []; }
    return _usuariosCache;
  }
}

function getUsuarios() {
  return _usuariosCache;
}

async function saveUsuarioSB(data, id) {
  const payload = {
    user_nombre: data.user,
    nombre_completo: data.nombre,
    password_hash: data.pass,
    rol: data.rol,
    proyecto_id: data.proyecto || null,
    email: data.email || null,
    activo: data.activo !== false
  };
  if (id) {
    if (data.pass) payload.password_hash = data.pass;
    else delete payload.password_hash;
    await sbFetch('usuarios_sistema?id=eq.' + id, { method: 'PATCH', body: payload, prefer: 'return=minimal' });
    return { id };
  } else {
    const res = await sbFetch('usuarios_sistema', { method: 'POST', body: payload });
    return Array.isArray(res) ? res[0] : res;
  }
}

async function deleteUsuarioSB(id) {
  await sbFetch('usuarios_sistema?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
}

const ROLE_DESCRIPTIONS = {
  admin: 'ğŸ‘‘ <b>Administrador:</b> Acceso total al sistema. Puede crear/editar/eliminar todo, gestionar usuarios y ver reportes completos.',
  supervisor: 'ğŸ” <b>Supervisor:</b> Puede ver y gestionar todos los proyectos y obras. No accede a usuarios ni datos financieros sensibles.',
  capataz: 'ğŸ‘· <b>Capataz:</b> Solo puede registrar parte diario, ver y gestionar su cuadrilla. Ideal para el campo.',
  contador: 'ğŸ’¼ <b>Contador:</b> Accede a presupuestos, proveedores, facturas y reportes financieros. No gestiona obras ni personal.',
  cliente: 'ğŸ‘ <b>Cliente:</b> Solo puede ver el avance de su proyecto asignado. No tiene acceso a datos internos.'
};

const ROLE_MODULES = {
  admin:      ['dashboard','proyectos','personal','maquinaria','obras','presupuestos','materiales','proveedores','cotizador','facturacion','reportes','usuarios','asistencia','flujocaja','alertas'],
  supervisor: ['dashboard','proyectos','personal','maquinaria','obras','presupuestos','materiales','proveedores','reportes','asistencia','flujocaja','alertas'],
  capataz:    ['dashboard','personal','obras','materiales','asistencia'],
  contador:   ['dashboard','proyectos','presupuestos','proveedores','facturacion','reportes','flujocaja'],
  cliente:    ['dashboard','proyectos']
};

function renderUsuarios(filterRol) {
  let users = getUsuarios();
  const setEl = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  setEl('badge-usuarios', users.length);
  setEl('usuarios-sub', users.length + ' usuarios registrados en el sistema');

  // Stats - use IDs from HTML
  const admins = users.filter(u => u.rol === 'admin').length;
  const activos = users.filter(u => u.activo !== false).length;
  setEl('usr-total', users.length);
  setEl('usr-admins', admins);
  setEl('usr-activos', activos);
  setEl('usr-inactivos', users.length - activos);
  // Also support old IDs
  setEl('cnt-todos', users.length); setEl('cnt-admin', admins);
  setEl('cnt-supervisor', users.filter(u=>u.rol==='supervisor').length);
  setEl('cnt-capataz', users.filter(u=>u.rol==='capataz').length);
  setEl('cnt-contador', users.filter(u=>u.rol==='contador').length);

  if (filterRol) users = users.filter(u => u.rol === filterRol);

  const rolLabel = { admin:'ğŸ‘‘ Admin', supervisor:'ğŸ” Supervisor', capataz:'ğŸ‘· Capataz', contador:'ğŸ’¼ Contador', cliente:'ğŸ‘ Cliente' };
  const rolClass = { admin:'role-admin', supervisor:'role-supervisor', capataz:'role-capataz', contador:'role-contador', cliente:'role-cliente' };

  const tbody = document.getElementById('usuarios-table');
  const mob = document.getElementById('usuarios-mobile');

  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">No hay usuarios. CreÃ¡ el primero con "+ Nuevo Usuario".</td></tr>';
    if (mob) mob.innerHTML = '<p style="color:var(--muted);text-align:center;padding:24px;">Sin usuarios aÃºn.</p>';
    return;
  }

  const rows = users.map(u => {
    const initials = (u.nombre||u.user).split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const proyNombre = u.proyecto ? getProyectoNombre(u.proyecto) : 'Todos';
    const ultimoAcceso = u.lastLogin ? new Date(u.lastLogin).toLocaleDateString('es-PE') : 'Nunca';
    return {
      tr: `<tr>
        <td><div style="display:flex;align-items:center;gap:8px;">
          <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;">${initials}</div>
          <div class="td-name">@${u.user}</div>
        </div></td>
        <td>${u.nombre||'â€”'}</td>
        <td><span class="role-badge ${rolClass[u.rol]||'role-cliente'}">${rolLabel[u.rol]||u.rol}</span></td>
        <td style="color:var(--muted2)">${proyNombre}</td>
        <td style="color:var(--muted)">${ultimoAcceso}</td>
        <td><span class="status-badge ${u.activo!==false?'activo':'pausado'}">${u.activo!==false?'Activo':'Inactivo'}</span></td>
        <td><div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="editUsuario('${u.id}')">âœï¸</button>
          <button class="btn btn-ghost btn-sm" onclick="toggleUsuarioStatus('${u.id}')">${u.activo!==false?'ğŸ”’':'ğŸ”“'}</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUsuario('${u.id}')">ğŸ—‘ï¸</button>
        </div></td>
      </tr>`,
      card: `<div class="mobile-card">
        <div class="mc-header">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;flex-shrink:0;">${initials}</div>
            <div><div class="mc-name">${u.nombre||u.user}</div><div class="mc-sub">@${u.user} Â· ${ultimoAcceso}</div></div>
          </div>
          <span class="role-badge ${rolClass[u.rol]||'role-cliente'}">${rolLabel[u.rol]||u.rol}</span>
        </div>
        <div class="mc-body">
          <div><div class="mc-label">Proyecto</div><div class="mc-val">${proyNombre}</div></div>
          <div><div class="mc-label">Estado</div><div class="mc-val"><span class="status-badge ${u.activo!==false?'activo':'pausado'}">${u.activo!==false?'Activo':'Inactivo'}</span></div></div>
          <div><div class="mc-label">Email</div><div class="mc-val" style="font-size:12px">${u.email||'â€”'}</div></div>
        </div>
        <div class="mc-actions">
          <button class="btn btn-ghost btn-sm" onclick="editUsuario('${u.id}')">âœï¸ Editar</button>
          <button class="btn btn-ghost btn-sm" onclick="toggleUsuarioStatus('${u.id}')">${u.activo!==false?'ğŸ”’ Desactivar':'ğŸ”“ Activar'}</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUsuario('${u.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>`
    };
  });

  tbody.innerHTML = rows.map(r=>r.tr).join('');
  if (mob) mob.innerHTML = rows.map(r=>r.card).join('');
}

let _usuarioFilterRol = '';
function filterUsuarios(rol) {
  _usuarioFilterRol = rol;
  renderUsuarios(rol);
}

function updateRolDescription() {
  const rol = document.getElementById('usr-rol').value;
  const el = document.getElementById('usr-rol-desc');
  if (rol && ROLE_DESCRIPTIONS[rol]) {
    el.innerHTML = ROLE_DESCRIPTIONS[rol];
    el.style.display = 'block';
  } else {
    el.style.display = 'none';
  }
}

async function saveUsuario() {
  const id = document.getElementById('usr-id').value;
  const nombre = document.getElementById('usr-nombre').value.trim();
  const user = document.getElementById('usr-user').value.trim().toLowerCase();
  const pass = document.getElementById('usr-pass').value;
  const pass2 = document.getElementById('usr-pass2').value;
  const rol = document.getElementById('usr-rol').value;
  const proyecto = document.getElementById('usr-proyecto').value;
  const email = document.getElementById('usr-email').value.trim();

  if (!nombre || !user || !rol) { toast('Campos requeridos', 'CompletÃ¡ nombre, usuario y rol', 'warn'); return; }
  if (!id && !pass) { toast('ContraseÃ±a requerida', 'IngresÃ¡ una contraseÃ±a', 'warn'); return; }
  if (pass && pass !== pass2) { toast('ContraseÃ±as no coinciden', 'VerificÃ¡ la contraseÃ±a', 'warn'); return; }
  if (pass && pass.length < 4) { toast('ContraseÃ±a muy corta', 'MÃ­nimo 4 caracteres', 'warn'); return; }

  const users = getUsuarios();
  const dup = users.find(u => u.user === user && u.id !== id);
  if (dup) { toast('Usuario ya existe', '@' + user + ' ya estÃ¡ registrado', 'err'); return; }

  showLoading(true);
  try {
    const data = { nombre, user, pass, rol, proyecto, email, activo: true };
    const saved = await saveUsuarioSB(data, id || null);

    if (id) {
      const idx = _usuariosCache.findIndex(u => u.id === id);
      if (idx >= 0) {
        _usuariosCache[idx] = { ..._usuariosCache[idx], nombre, user, rol, proyecto, email };
        if (pass) _usuariosCache[idx].pass = pass;
      }
      toast('Usuario actualizado', '@' + user + ' â€” ' + rol);
    } else {
      const newId = saved?.id || ('local_' + Date.now());
      _usuariosCache.push({ id: newId, nombre, user, pass, rol, proyecto, email, activo: true, creado: new Date().toISOString(), lastLogin: null });
      toast('âœ… Usuario creado', '@' + user + ' Â· Rol: ' + rol);
    }
    localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
  } catch(e) {
    toast('Error al guardar', e.message.slice(0,80), 'err');
    showLoading(false);
    return;
  }
  showLoading(false);
  closeModal('usuario');
  renderUsuarios(_usuarioFilterRol);
}

function editUsuario(id) {
  const u = _usuariosCache.find(x => x.id === id);
  if (!u) return;
  document.getElementById('usr-id').value = u.id;
  document.getElementById('usr-nombre').value = u.nombre || '';
  document.getElementById('usr-user').value = u.user;
  document.getElementById('usr-pass').value = '';
  document.getElementById('usr-pass2').value = '';
  document.getElementById('usr-rol').value = u.rol;
  document.getElementById('usr-proyecto').value = u.proyecto || '';
  document.getElementById('usr-email').value = u.email || '';
  document.getElementById('modal-usr-title').textContent = 'Editar Usuario';
  updateRolDescription();
  populateProyectoDropdowns();
  document.getElementById('modal-usuario').classList.add('open');
}

async function toggleUsuarioStatus(id) {
  const idx = _usuariosCache.findIndex(u => u.id === id);
  if (idx < 0) return;
  const newStatus = _usuariosCache[idx].activo === false ? true : false;
  try {
    await sbFetch('usuarios_sistema?id=eq.' + id, { method: 'PATCH', body: { activo: newStatus }, prefer: 'return=minimal' });
  } catch(e) { console.warn('Toggle status offline'); }
  _usuariosCache[idx].activo = newStatus;
  localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
  renderUsuarios(_usuarioFilterRol);
  toast(newStatus ? 'Usuario activado' : 'Usuario desactivado', '@' + _usuariosCache[idx].user);
}

function deleteUsuario(id) {
  const u = _usuariosCache.find(x => x.id === id);
  if (!u) return;
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar usuario @' + u.user + '? Esta acciÃ³n no se puede deshacer.';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await deleteUsuarioSB(id);
    } catch(e) { console.warn('Delete usuario offline'); }
    finally { showLoading(false); }
    _usuariosCache = _usuariosCache.filter(x => x.id !== id);
    localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
    renderUsuarios(_usuarioFilterRol);
    toast('Usuario eliminado', '@' + u.user, 'err');
  };
  document.getElementById('modal-confirm').classList.add('open');
}

// ===== APPLY ROLE PERMISSIONS (hide nav items user can't access) =====
function applyRolePermissions(rol) {
  if (!rol || rol === 'admin') return; // admin sees everything
  const allowed = ROLE_MODULES[rol] || [];
  const navMap = {
    proyectos: 'proyectos', personal: 'personal', maquinaria: 'maquinaria',
    obras: 'obras', presupuestos: 'presupuestos', materiales: 'materiales',
    proveedores: 'proveedores', cotizador: 'cotizador', facturacion: 'facturacion',
    reportes: 'reportes', usuarios: 'usuarios',
    asistencia: 'asistencia', flujocaja: 'flujocaja', alertas: 'alertas'
  };
  Object.keys(navMap).forEach(page => {
    const navItems = document.querySelectorAll(`.nav-item[onclick*="nav('${page}"]`);
    navItems.forEach(el => {
      el.style.display = allowed.includes(page) ? '' : 'none';
    });
  });
}

// ============================================================
// ===== CONTROL DE ASISTENCIA ================================
// ============================================================

const ASIST_KEY = 'bc_asistencia_v1';
let _asistenciaData = JSON.parse(localStorage.getItem(ASIST_KEY) || '{}');
// Structure: { "2025-06-15": [ { personalId, nombre, rol, proyectoId, proyecto, estado, horaEntrada, horasExtras, observacion } ] }

function saveAsistenciaLocal() {
  localStorage.setItem(ASIST_KEY, JSON.stringify(_asistenciaData));
}

function initAsistencia() {
  // Set default date to today
  const fechaEl = document.getElementById('asist-fecha');
  if (!fechaEl.value) fechaEl.value = new Date().toISOString().split('T')[0];
  
  // Populate proyecto filter
  const pf = document.getElementById('asist-proyecto-filter');
  pf.innerHTML = '<option value="">Todos los proyectos</option>';
  proyectos.forEach(p => pf.innerHTML += `<option value="${p.id}">${p.nombre}</option>`);
  
  // Populate month filter for resumen
  const mf = document.getElementById('asist-mes-filter');
  mf.innerHTML = '';
  const now = new Date();
  for (let i = 0; i < 6; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const val = d.toISOString().slice(0,7);
    const label = d.toLocaleDateString('es-PE', { month: 'long', year: 'numeric' });
    mf.innerHTML += `<option value="${val}">${label}</option>`;
  }

  renderAsistencia();
  renderResumenMensual();
}

function renderAsistencia() {
  const fecha = document.getElementById('asist-fecha').value;
  const proyFil = document.getElementById('asist-proyecto-filter').value;
  if (!fecha) return;

  // Get personal for this date
  let personal_list = personal.filter(p => p.estado !== 'inactivo');
  if (proyFil) personal_list = personal_list.filter(p => 
    p.proyecto === proyFil || p.proyectoId === proyFil || p.proyecto_id === proyFil ||
    String(p.proyecto) === String(proyFil)
  );
  const existing = _asistenciaData[fecha] || [];
  const existMap = {};
  existing.forEach(r => existMap[r.personalId] = r);

  const tbody = document.getElementById('asist-table');
  const mobile = document.getElementById('asist-mobile');
  
  if (!personal_list.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Sin personal activo${proyFil ? ' en este proyecto' : ''}.</td></tr>`;
    mobile.innerHTML = '';
    updateAsistStats([]);
    return;
  }

  const rows = personal_list.map(per => {
    const r = existMap[per.id] || { estado: 'presente', horaEntrada: '08:00', horasExtras: 0, observacion: '' };
    const proyNombre = getProyectoNombre(per.proyecto || per.proyectoId || per.proyecto_id);
    const estados = ['presente','ausente','tardanza','permiso','feriado'];
    const estadoColors = { presente: 'var(--green)', ausente: 'var(--red)', tardanza: 'var(--accent)', permiso: 'var(--blue)', feriado: 'var(--muted)' };
    const estadoOpts = estados.map(e => `<option value="${e}" ${r.estado===e?'selected':''}>${e.charAt(0).toUpperCase()+e.slice(1)}</option>`).join('');
    return `<tr>
      <td><b>${per.nombre}</b></td>
      <td><span style="font-size:11px;color:var(--muted2);">${per.rol||per.cargo||''}</span></td>
      <td style="font-size:12px;">${proyNombre}</td>
      <td><select class="form-select" style="min-width:100px;font-size:12px;padding:4px 8px;border-color:${estadoColors[r.estado]||'var(--border)'};" onchange="this.style.borderColor=({presente:'var(--green)',ausente:'var(--red)',tardanza:'var(--accent)',permiso:'var(--blue)',feriado:'var(--muted)'})[this.value]||'var(--border)'" data-pid="${per.id}" data-field="estado">${estadoOpts}</select></td>
      <td><input type="time" class="form-input" style="padding:4px 8px;max-width:90px;" value="${r.horaEntrada||'08:00'}" data-pid="${per.id}" data-field="horaEntrada"></td>
      <td><input type="number" class="form-input" style="padding:4px 8px;max-width:70px;" value="${r.horasExtras||0}" min="0" max="12" step="0.5" data-pid="${per.id}" data-field="horasExtras"></td>
      <td><input type="text" class="form-input" style="padding:4px 8px;max-width:160px;" value="${r.observacion||''}" placeholder="..." data-pid="${per.id}" data-field="observacion"></td>
    </tr>`;
  });

  tbody.innerHTML = rows.join('');

  // Mobile cards (mc-* classes)
  const _bcMap = {presente:'var(--green)',ausente:'var(--red)',tardanza:'var(--accent)',permiso:'var(--blue)',feriado:'var(--muted)'};
  mobile.innerHTML = personal_list.map(per => {
    const r   = existMap[per.id] || {estado:'presente', horaEntrada:'08:00', horasExtras:0, observacion:''};
    const bc  = _bcMap[r.estado] || 'var(--muted)';
    const ini = per.nombre.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const prN = getProyectoNombre(per.proyecto||per.proyectoId||per.proyecto_id)||'Sin proyecto';
    const ests = ['presente','ausente','tardanza','permiso','feriado'];
    const opts = ests.map(e=>`<option value="${e}" ${r.estado===e?'selected':''}>${e[0].toUpperCase()+e.slice(1)}</option>`).join('');
    return `<div class="mobile-card">
      <div class="mc-header">
        <div class="mc-left">
          <div class="mc-avatar" style="background:linear-gradient(135deg,var(--blue),var(--purple));">${ini}</div>
          <div><div class="mc-name">${per.nombre}</div><div class="mc-sub">${per.rol||per.cargo||''} Â· ${prN}</div></div>
        </div>
        <span style="font-size:10px;padding:3px 9px;border-radius:20px;background:${bc}20;color:${bc};font-weight:700;flex-shrink:0;">${r.estado||'presente'}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Estado</div>
          <select style="background:var(--bg3);border:1px solid ${bc};color:var(--text);border-radius:7px;padding:5px 8px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                  data-pid="${per.id}" data-field="estado">${opts}</select>
        </div>
        <div><div class="mc-label">H. Entrada</div>
          <input type="time" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 7px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                 value="${r.horaEntrada||'08:00'}" data-pid="${per.id}" data-field="horaEntrada">
        </div>
        <div><div class="mc-label">H. Extras</div>
          <input type="number" min="0" max="12" step="0.5" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 7px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                 value="${r.horasExtras||0}" data-pid="${per.id}" data-field="horasExtras">
        </div>
        <div><div class="mc-label">ObservaciÃ³n</div>
          <input type="text" placeholder="..." style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 7px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                 value="${r.observacion||''}" data-pid="${per.id}" data-field="observacion">
        </div>
      </div>
    </div>`;
  }).join('');

  // Compute stats
  const records = personal_list.map(per => existMap[per.id] || { estado: 'presente' });
  updateAsistStats(records);
  document.getElementById('asist-sub').textContent = `${personal_list.length} trabajadores Â· ${new Date(fecha+'T12:00').toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
}

function updateAsistStats(records) {
  const presentes = records.filter(r => r.estado === 'presente').length;
  const ausentes = records.filter(r => r.estado === 'ausente').length;
  const tardanzas = records.filter(r => r.estado === 'tardanza').length;
  const total = records.length;
  const tasa = total ? Math.round(((presentes + tardanzas) / total) * 100) : 0;
  document.getElementById('asist-presentes').textContent = presentes;
  document.getElementById('asist-ausentes').textContent = ausentes;
  document.getElementById('asist-tardanza').textContent = tardanzas;
  document.getElementById('asist-tasa').textContent = tasa + '%';
  document.getElementById('badge-asistencia').textContent = presentes;
}

function guardarParteDiario() {
  const fecha = document.getElementById('asist-fecha').value;
  if (!fecha) { toast('Error', 'SeleccionÃ¡ una fecha', 'err'); return; }
  
  const rows = document.querySelectorAll('#asist-table tr[data-pid], #asist-table td select[data-pid], #asist-table td input[data-pid]');
  
  // Collect all data from inputs
  const inputs = document.querySelectorAll('#asist-table [data-pid]');
  const dataMap = {};
  inputs.forEach(el => {
    const pid = el.dataset.pid;
    const field = el.dataset.field;
    if (!dataMap[pid]) dataMap[pid] = {};
    dataMap[pid][field] = el.value;
  });

  if (!Object.keys(dataMap).length) { toast('Sin datos', 'No hay personal para guardar', 'err'); return; }

  const records = [];
  const proyFil = document.getElementById('asist-proyecto-filter').value;
  let personal_list = personal.filter(p => p.estado !== 'inactivo');
  if (proyFil) personal_list = personal_list.filter(p =>
    p.proyecto === proyFil || p.proyectoId === proyFil || p.proyecto_id === proyFil ||
    String(p.proyecto) === String(proyFil)
  );

  personal_list.forEach(per => {
    const d = dataMap[per.id] || {};
    const proy = proyectos.find(p => p.id === (per.proyectoId || per.proyecto_id));
    records.push({
      personalId: per.id,
      nombre: per.nombre,
      rol: per.rol || per.cargo || '',
      proyectoId: per.proyectoId || per.proyecto_id || '',
      proyecto: proy ? proy.nombre : (per.proyecto || ''),
      estado: d.estado || 'presente',
      horaEntrada: d.horaEntrada || '08:00',
      horasExtras: parseFloat(d.horasExtras) || 0,
      observacion: d.observacion || ''
    });
  });

  // Merge with existing (other projects)
  const existing = (_asistenciaData[fecha] || []).filter(r => {
    if (!proyFil) return false;
    return r.proyectoId !== proyFil;
  });
  _asistenciaData[fecha] = [...existing, ...records];
  saveAsistenciaLocal();
  toast('Parte guardado', `${records.length} registros para el ${fecha}`, 'ok');
  renderAsistencia();
  renderResumenMensual();
}

function renderResumenMensual() {
  const mes = document.getElementById('asist-mes-filter').value;
  if (!mes) return;
  const tbody = document.getElementById('asist-resumen-table');
  
  // Gather all dates for this month
  const diasMes = Object.keys(_asistenciaData).filter(d => d.startsWith(mes));
  
  if (!diasMes.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Sin registros para ${mes}</td></tr>`;
    return;
  }

  // Build summary per person
  const summary = {}; // personalId -> { nombre, proyecto, dias, ausencias, tardanzas, hExtras }
  diasMes.forEach(dia => {
    (_asistenciaData[dia] || []).forEach(r => {
      if (!summary[r.personalId]) summary[r.personalId] = { nombre: r.nombre, proyecto: r.proyecto, dias: 0, ausencias: 0, tardanzas: 0, hExtras: 0 };
      const s = summary[r.personalId];
      if (r.estado === 'presente' || r.estado === 'tardanza') s.dias++;
      if (r.estado === 'ausente') s.ausencias++;
      if (r.estado === 'tardanza') s.tardanzas++;
      s.hExtras += parseFloat(r.horasExtras) || 0;
    });
  });

  const totalDias = diasMes.length;
  const rows = Object.values(summary).map(s => {
    const pct = totalDias ? Math.round((s.dias / totalDias) * 100) : 0;
    const pctColor = pct >= 90 ? 'var(--green)' : pct >= 75 ? 'var(--accent)' : 'var(--red)';
    return `<tr>
      <td><b>${s.nombre}</b></td>
      <td style="font-size:12px;">${s.proyecto||'â€”'}</td>
      <td style="text-align:center;">${s.dias}</td>
      <td style="text-align:center;color:${s.ausencias>0?'var(--red)':'var(--muted)'};">${s.ausencias}</td>
      <td style="text-align:center;color:${s.tardanzas>0?'var(--accent)':'var(--muted)'};">${s.tardanzas}</td>
      <td style="text-align:center;">${s.hExtras.toFixed(1)}h</td>
      <td style="text-align:center;"><span style="color:${pctColor};font-weight:600;">${pct}%</span></td>
    </tr>`;
  });
  tbody.innerHTML = rows.join('') || `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Sin datos</td></tr>`;
}

function exportAsistenciaExcel() {
  const fecha = document.getElementById('asist-fecha').value || 'sin_fecha';
  const records = _asistenciaData[fecha] || [];
  if (!records.length) { toast('Sin datos', 'No hay parte para esta fecha', 'err'); return; }
  let csv = 'Nombre,Rol,Proyecto,Estado,Hora Entrada,H. Extras,ObservaciÃ³n\n';
  records.forEach(r => csv += `"${r.nombre}","${r.rol}","${r.proyecto}","${r.estado}","${r.horaEntrada}","${r.horasExtras}","${r.observacion}"\n`);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `asistencia_${fecha}.csv`; a.click();
  toast('Exportado', 'Archivo CSV descargado', 'ok');
}

// ============================================================
// ===== FLUJO DE CAJA ========================================
// ============================================================

const FLUJO_KEY = 'bc_flujocaja_v1';
let _movimientos = [];
let _flujoFilter = 'todos';

// Guarda backup local (por si Supabase falla)
function saveMovimientosLocal() {
  try { localStorage.setItem(FLUJO_KEY, JSON.stringify(_movimientos)); } catch(e) {}
}

// Carga movimientos desde Supabase (con fallback a localStorage)
async function loadMovimientosSB() {
  try {
    const rows = await sbFetch('movimientos_caja?order=fecha.desc');
    _movimientos = rows.map(m => ({
      id: m.id,
      tipo: m.tipo,
      fecha: m.fecha,
      proyectoId: m.proyecto_id || '',
      categoria: m.categoria || 'otro',
      monto: parseFloat(m.monto || 0),
      descripcion: m.descripcion || '',
      referencia: m.referencia || '',
      createdAt: m.created_at
    }));
    saveMovimientosLocal();
  } catch(e) {
    console.warn('movimientos_caja no disponible, usando cachÃ© local:', e.message);
    try { _movimientos = JSON.parse(localStorage.getItem(FLUJO_KEY) || '[]'); } catch(e2) { _movimientos = []; }
  }
}

async function initFlujoCaja() {
  await loadMovimientosSB(); // siempre trae datos frescos de Supabase
  // Populate proyecto filter
  const pf = document.getElementById('flujo-proyecto-filter');
  pf.innerHTML = '<option value="">Todos los proyectos</option>';
  proyectos.forEach(p => pf.innerHTML += `<option value="${p.id}">${p.nombre}</option>`);

  // Populate project modal select
  const mp = document.getElementById('mov-proyecto');
  mp.innerHTML = '<option value="">Sin proyecto especÃ­fico</option>';
  proyectos.forEach(p => mp.innerHTML += `<option value="${p.id}">${p.nombre}</option>`);

  // Populate month filter
  const mf = document.getElementById('flujo-mes-filter');
  mf.innerHTML = '<option value="">Todos los meses</option>';
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const val = d.toISOString().slice(0,7);
    const label = d.toLocaleDateString('es-PE', { month: 'long', year: 'numeric' });
    mf.innerHTML += `<option value="${val}" ${i===0?'selected':''}>${label}</option>`;
  }

  renderFlujoCaja();
  setTimeout(initFlujoChart, 100);
}

function filtrarFlujo(tipo) {
  _flujoFilter = tipo;
  document.querySelectorAll('[id^="flujo-btn-"]').forEach(b => b.style.fontWeight = 'normal');
  document.getElementById('flujo-btn-' + tipo).style.fontWeight = '700';
  renderFlujoCaja();
}

function renderFlujoCaja() {
  const proyFil = document.getElementById('flujo-proyecto-filter').value;
  const mesFil = document.getElementById('flujo-mes-filter').value;

  let movs = [..._movimientos];
  if (proyFil) movs = movs.filter(m => m.proyectoId === proyFil);
  if (mesFil) movs = movs.filter(m => m.fecha && m.fecha.startsWith(mesFil));
  if (_flujoFilter !== 'todos') movs = movs.filter(m => m.tipo === _flujoFilter);

  movs.sort((a,b) => b.fecha.localeCompare(a.fecha));

  const ingresos = movs.filter(m => m.tipo === 'ingreso').reduce((s,m) => s + (parseFloat(m.monto)||0), 0);
  const egresos = movs.filter(m => m.tipo === 'egreso').reduce((s,m) => s + (parseFloat(m.monto)||0), 0);
  const saldo = ingresos - egresos;
  const acumulado = _movimientos.filter(m => !proyFil || m.proyectoId === proyFil)
    .reduce((s, m) => s + (m.tipo === 'ingreso' ? 1 : -1) * (parseFloat(m.monto)||0), 0);

  document.getElementById('flujo-ingresos').textContent = 'S/ ' + ingresos.toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  document.getElementById('flujo-egresos').textContent = 'S/ ' + egresos.toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  const saldoEl = document.getElementById('flujo-saldo');
  saldoEl.textContent = 'S/ ' + Math.abs(saldo).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  saldoEl.style.color = saldo >= 0 ? 'var(--green)' : 'var(--red)';
  const acumEl = document.getElementById('flujo-acumulado');
  acumEl.textContent = 'S/ ' + Math.abs(acumulado).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  acumEl.style.color = acumulado >= 0 ? 'var(--green)' : 'var(--red)';

  const tbody = document.getElementById('flujo-table');
  const catLabels = { cobro_cliente:'Cobro cliente', anticipo:'Anticipo', pago_proveedor:'Pago proveedor', planilla:'Planilla', maquinaria:'Maquinaria', materiales:'Materiales', gastos_generales:'Gastos generales', impuestos:'Impuestos', otro:'Otro' };

  if (!movs.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Sin movimientos para el filtro seleccionado</td></tr>`;
    document.getElementById('flujo-mobile').innerHTML = '';
    return;
  }

  tbody.innerHTML = movs.map(m => {
    const proy = proyectos.find(p => p.id === m.proyectoId);
    const montoColor = m.tipo === 'ingreso' ? 'var(--green)' : 'var(--red)';
    const signo = m.tipo === 'ingreso' ? '+' : '-';
    return `<tr>
      <td style="font-size:12px;">${m.fecha || 'â€”'}</td>
      <td style="font-size:12px;">${proy ? proy.nombre : 'â€”'}</td>
      <td><span style="font-size:11px;padding:2px 8px;border-radius:20px;background:var(--bg3);">${catLabels[m.categoria]||m.categoria}</span></td>
      <td style="font-size:12px;">${m.descripcion||'â€”'}</td>
      <td><span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${montoColor}20;color:${montoColor};">${m.tipo === 'ingreso' ? 'â–² Ingreso' : 'â–¼ Egreso'}</span></td>
      <td style="text-align:right;font-weight:700;color:${montoColor};">${signo} S/ ${parseFloat(m.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td style="text-align:center;">
        <button class="btn btn-ghost btn-sm" style="padding:4px 8px;" onclick="editarMovimiento('${m.id}')">âœï¸</button>
        <button class="btn btn-ghost btn-sm" style="padding:4px 8px;color:var(--red);" onclick="eliminarMovimiento('${m.id}')">ğŸ—‘</button>
      </td>
    </tr>`;
  }).join('');

  // Mobile cards (mc-* classes)
  document.getElementById('flujo-mobile').innerHTML = movs.map(m => {
    const mc  = m.tipo === 'ingreso' ? 'var(--green)' : 'var(--red)';
    const sig = m.tipo === 'ingreso' ? 'â–²' : 'â–¼';
    const cat = catLabels[m.categoria] || m.categoria || 'â€”';
    const amt = parseFloat(m.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
    const pN  = (proyectos.find(p=>p.id===m.proyectoId)||{}).nombre || 'â€”';
    return `<div class="mobile-card">
      <div class="mc-header">
        <div class="mc-left">
          <div class="mc-avatar" style="background:${mc}18;color:${mc};font-size:18px;">${m.tipo==='ingreso'?'ğŸ“ˆ':'ğŸ“‰'}</div>
          <div>
            <div class="mc-name">${m.descripcion||cat}</div>
            <div class="mc-sub">${m.fecha||'â€”'} Â· ${pN}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;margin-left:8px;">
          <div style="font-family:'Syne',sans-serif;font-weight:800;color:${mc};font-size:15px;">${sig} S/ ${amt}</div>
          <span style="font-size:10px;padding:2px 7px;border-radius:20px;background:${mc}18;color:${mc};">${cat}</span>
        </div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="editarMovimiento('${m.id}')">âœï¸ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarMovimiento('${m.id}')">ğŸ—‘ Eliminar</button>
      </div>
    </div>`;
  }).join('');

  document.getElementById('flujo-sub').textContent = `${_movimientos.length} movimientos registrados`;
  initFlujoChart();
}

function abrirModalMovimiento(id) {
  const modal = document.getElementById('modal-movimiento');
  if (id) {
    const m = _movimientos.find(x => x.id === id);
    if (!m) return;
    document.getElementById('mov-modal-title').textContent = 'Editar Movimiento';
    document.getElementById('mov-id').value = m.id;
    document.getElementById('mov-tipo').value = m.tipo;
    document.getElementById('mov-fecha').value = m.fecha;
    document.getElementById('mov-proyecto').value = m.proyectoId || '';
    document.getElementById('mov-categoria').value = m.categoria;
    document.getElementById('mov-monto').value = m.monto;
    document.getElementById('mov-descripcion').value = m.descripcion || '';
    document.getElementById('mov-referencia').value = m.referencia || '';
  } else {
    document.getElementById('mov-modal-title').textContent = 'Nuevo Movimiento';
    document.getElementById('mov-id').value = '';
    document.getElementById('mov-tipo').value = 'ingreso';
    document.getElementById('mov-fecha').value = new Date().toISOString().split('T')[0];
    document.getElementById('mov-proyecto').value = '';
    document.getElementById('mov-categoria').value = 'cobro_cliente';
    document.getElementById('mov-monto').value = '';
    document.getElementById('mov-descripcion').value = '';
    document.getElementById('mov-referencia').value = '';
  }
  modal.classList.add('open');
}

async function guardarMovimiento() {
  const monto = parseFloat(document.getElementById('mov-monto').value);
  if (!monto || monto <= 0) { toast('Error', 'IngresÃ¡ un monto vÃ¡lido', 'err'); return; }
  const fecha = document.getElementById('mov-fecha').value;
  if (!fecha) { toast('Error', 'SeleccionÃ¡ una fecha', 'err'); return; }

  const id = document.getElementById('mov-id').value;
  const data = {
    id: id || 'mov_' + Date.now(),
    tipo: document.getElementById('mov-tipo').value,
    fecha,
    proyectoId: document.getElementById('mov-proyecto').value,
    categoria: document.getElementById('mov-categoria').value,
    monto,
    descripcion: document.getElementById('mov-descripcion').value.trim(),
    referencia: document.getElementById('mov-referencia').value.trim(),
    createdAt: id ? undefined : new Date().toISOString()
  };

  document.getElementById('modal-movimiento').classList.remove('open');
  toast('Guardando...', 'Registrando en Supabase', 'ok');

  const payload = {
    tipo: data.tipo,
    fecha: data.fecha,
    proyecto_id: data.proyectoId || null,
    categoria: data.categoria,
    monto: data.monto,
    descripcion: data.descripcion,
    referencia: data.referencia
  };

  try {
    if (id) {
      await sbFetch('movimientos_caja?id=eq.' + id, { method: 'PATCH', body: payload, prefer: 'return=minimal' });
      const idx = _movimientos.findIndex(m => m.id === id);
      if (idx >= 0) _movimientos[idx] = { ..._movimientos[idx], ...data };
    } else {
      const res = await sbFetch('movimientos_caja', { method: 'POST', body: payload });
      const saved = Array.isArray(res) ? res[0] : res;
      data.id = saved?.id || data.id;
      _movimientos.unshift(data);
    }
    saveMovimientosLocal();
    toast('âœ… Guardado', `Movimiento ${data.tipo} registrado`, 'ok');
  } catch(e) {
    // Fallback: save locally if Supabase fails
    if (id) {
      const idx = _movimientos.findIndex(m => m.id === id);
      if (idx >= 0) _movimientos[idx] = { ..._movimientos[idx], ...data };
    } else {
      _movimientos.unshift(data);
    }
    saveMovimientosLocal();
    toast('âš ï¸ Guardado local', 'No se pudo conectar a Supabase', 'ok');
  }
  renderFlujoCaja();
}

function editarMovimiento(id) { abrirModalMovimiento(id); }

function eliminarMovimiento(id) {
  const m = _movimientos.find(x => x.id === id);
  if (!m) return;
  document.getElementById('confirm-msg').textContent = `Â¿Eliminar movimiento "${m.descripcion || m.categoria}" por S/ ${m.monto}?`;
  document.getElementById('confirm-ok').onclick = async () => {
    document.getElementById('modal-confirm').classList.remove('open');
    try {
      await sbFetch('movimientos_caja?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
    } catch(e) { console.warn('Delete SB failed:', e.message); }
    _movimientos = _movimientos.filter(x => x.id !== id);
    saveMovimientosLocal();
    toast('Eliminado', 'Movimiento eliminado', 'err');
    renderFlujoCaja();
  };
  document.getElementById('modal-confirm').classList.add('open');
}

let _flujoChart = null;
function initFlujoChart() {
  const ctx = document.getElementById('flujo-chart');
  if (!ctx) return;
  if (_flujoChart) { _flujoChart.destroy(); _flujoChart = null; }

  // Build last 6 months data
  const months = [];
  const ingrArr = [], egrArr = [], saldoArr = [];
  const now = new Date();
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const mes = d.toISOString().slice(0,7);
    months.push(d.toLocaleDateString('es-PE', { month: 'short' }));
    const movsMes = _movimientos.filter(m => m.fecha && m.fecha.startsWith(mes));
    const ing = movsMes.filter(m => m.tipo === 'ingreso').reduce((s,m) => s + parseFloat(m.monto||0), 0);
    const eg = movsMes.filter(m => m.tipo === 'egreso').reduce((s,m) => s + parseFloat(m.monto||0), 0);
    ingrArr.push(ing);
    egrArr.push(eg);
    saldoArr.push(ing - eg);
  }

  if (typeof Chart === 'undefined') return;
  _flujoChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label: 'Ingresos', data: ingrArr, backgroundColor: 'rgba(40,167,69,0.7)', borderRadius: 4 },
        { label: 'Egresos', data: egrArr, backgroundColor: 'rgba(220,53,69,0.7)', borderRadius: 4 },
        { label: 'Saldo', data: saldoArr, type: 'line', borderColor: 'rgba(245,166,35,1)', backgroundColor: 'rgba(245,166,35,0.1)', tension: 0.3, fill: false, pointRadius: 4 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#aaa', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#aaa', callback: v => 'S/'+v.toLocaleString() }, grid: { color: 'rgba(255,255,255,0.05)' } }
      }
    }
  });
}

function exportFlujoExcel() {
  let csv = 'Fecha,Proyecto,CategorÃ­a,DescripciÃ³n,Tipo,Monto,Referencia\n';
  _movimientos.sort((a,b) => b.fecha.localeCompare(a.fecha)).forEach(m => {
    const proy = proyectos.find(p => p.id === m.proyectoId);
    csv += `"${m.fecha}","${proy?proy.nombre:'â€”'}","${m.categoria}","${m.descripcion||''}","${m.tipo}","${m.monto}","${m.referencia||''}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'flujo_caja_buildcore.csv'; a.click();
  toast('Exportado', 'Flujo de caja descargado', 'ok');
}

// ============================================================
// ===== ALERTAS AUTOMÃTICAS ==================================
// ============================================================

let _alertas = [];
let _alertasFiltroActual = 'todas';

function generarAlertas() {
  _alertas = [];
  const hoy = new Date();
  const msDay = 86400000;

  // 1. Proyectos con fecha de fin prÃ³xima o vencida
  proyectos.forEach(p => {
    const finStr = p.fechaFin || p.fecha_fin || p.fin; // todas las variantes
    if (!finStr) return;
    const fin = new Date(finStr);
    if (isNaN(fin.getTime())) return; // fecha invÃ¡lida
    const diff = Math.round((fin - hoy) / msDay);
    if (diff < 0) {
      _alertas.push({ id: 'p_'+p.id+'_vencido', tipo: 'critica', modulo: 'proyectos', icono: 'ğŸš¨', titulo: 'Proyecto vencido', mensaje: `"${p.nombre}" venciÃ³ hace ${Math.abs(diff)} dÃ­as (${fin.toLocaleDateString('es-PE')})`, ref: p.nombre, leida: false });
    } else if (diff <= 15) {
      _alertas.push({ id: 'p_'+p.id+'_proximo', tipo: 'advertencia', modulo: 'proyectos', icono: 'âš ï¸', titulo: 'Proyecto prÃ³ximo a vencer', mensaje: `"${p.nombre}" vence en ${diff} dÃ­as (${fin.toLocaleDateString('es-PE')})`, ref: p.nombre, leida: false });
    }
  });

  // 2. Facturas vencidas o por vencer
  facturas.forEach(f => {
    if (!f.fechaVencimiento && !f.fecha_vencimiento) return;
    const venc = new Date(f.fechaVencimiento || f.fecha_vencimiento);
    const diff = Math.round((venc - hoy) / msDay);
    const estadoFactura = (f.estado || '').toLowerCase();
    if (estadoFactura === 'cobrada' || estadoFactura === 'pagada') return;
    if (diff < 0) {
      _alertas.push({ id: 'f_'+f.id+'_vencida', tipo: 'critica', modulo: 'facturacion', icono: 'ğŸ’¸', titulo: 'Factura vencida sin cobrar', mensaje: `Factura ${f.numero||f.id} â€” ${f.cliente||''} â€” S/ ${parseFloat(f.monto||f.total||0).toLocaleString()} â€” vencida hace ${Math.abs(diff)} dÃ­as`, ref: f.numero||f.id, leida: false });
    } else if (diff <= 7) {
      _alertas.push({ id: 'f_'+f.id+'_proxima', tipo: 'advertencia', modulo: 'facturacion', icono: 'ğŸ“‹', titulo: 'Factura por vencer', mensaje: `Factura ${f.numero||f.id} â€” ${f.cliente||''} â€” S/ ${parseFloat(f.monto||f.total||0).toLocaleString()} â€” vence en ${diff} dÃ­as`, ref: f.numero||f.id, leida: false });
    }
  });

  // 3. Maquinaria con mantenimiento vencido
  maquinaria.forEach(m => {
    const mantStr = m.proxMantenimiento || m.prox_mantenimiento || m.mantenim;
    if (!mantStr) return;
    const mant = new Date(mantStr);
    if (isNaN(mant.getTime())) return;
    const diff = Math.round((mant - hoy) / msDay);
    if (diff < 0) {
      _alertas.push({ id: 'm_'+m.id+'_mant', tipo: 'critica', modulo: 'maquinaria', icono: 'ğŸ”§', titulo: 'Mantenimiento vencido', mensaje: `${m.nombre||m.codigo} â€” mantenimiento vencido hace ${Math.abs(diff)} dÃ­as`, ref: m.nombre||m.codigo, leida: false });
    } else if (diff <= 10) {
      _alertas.push({ id: 'm_'+m.id+'_prox', tipo: 'advertencia', modulo: 'maquinaria', icono: 'âš™ï¸', titulo: 'Mantenimiento prÃ³ximo', mensaje: `${m.nombre||m.codigo} â€” mantenimiento en ${diff} dÃ­as (${mant.toLocaleDateString('es-PE')})`, ref: m.nombre||m.codigo, leida: false });
    }
  });

  // 4. Presupuestos con alto desvÃ­o
  presupuestos.forEach(p => {
    const total = parseFloat(p.total || p.monto || 0);
    const ejecutado = parseFloat(p.ejecutado || p.costoReal || 0);
    if (!total || !ejecutado) return;
    const desvio = ((ejecutado - total) / total) * 100;
    if (desvio > 20) {
      _alertas.push({ id: 'pre_'+p.id+'_desvio', tipo: 'critica', modulo: 'presupuestos', icono: 'ğŸ“Š', titulo: 'DesvÃ­o crÃ­tico en presupuesto', mensaje: `${p.nombre||p.titulo||'Presupuesto'} â€” desvÃ­o de +${desvio.toFixed(0)}% (ejecutado S/ ${ejecutado.toLocaleString()} vs S/ ${total.toLocaleString()} presupuestado)`, ref: p.nombre||p.titulo, leida: false });
    } else if (desvio > 10) {
      _alertas.push({ id: 'pre_'+p.id+'_alerta', tipo: 'advertencia', modulo: 'presupuestos', icono: 'ğŸ“‰', titulo: 'DesvÃ­o en presupuesto', mensaje: `${p.nombre||p.titulo||'Presupuesto'} â€” desvÃ­o de +${desvio.toFixed(0)}%`, ref: p.nombre||p.titulo, leida: false });
    }
  });

  // 5. Materiales con stock bajo
  materiales.forEach(m => {
    const stock = parseFloat(m.stock || m.cantidad || 0);
    const minStock = parseFloat(m.stockMinimo || m.stock_minimo || 0);
    if (!minStock) return;
    if (stock <= 0) {
      _alertas.push({ id: 'mat_'+m.id+'_agotado', tipo: 'critica', modulo: 'materiales', icono: 'ğŸ“¦', titulo: 'Material agotado', mensaje: `${m.nombre||m.descripcion} â€” sin stock (mÃ­nimo: ${minStock} ${m.unidad||''})`, ref: m.nombre, leida: false });
    } else if (stock < minStock) {
      _alertas.push({ id: 'mat_'+m.id+'_bajo', tipo: 'advertencia', modulo: 'materiales', icono: 'âš ï¸', titulo: 'Stock bajo de material', mensaje: `${m.nombre||m.descripcion} â€” stock: ${stock} ${m.unidad||''} (mÃ­nimo: ${minStock})`, ref: m.nombre, leida: false });
    }
  });

  // 6. Flujo de caja negativo
  const saldoTotal = _movimientos.reduce((s,m) => s + (m.tipo === 'ingreso' ? 1 : -1) * (parseFloat(m.monto)||0), 0);
  if (saldoTotal < 0) {
    _alertas.push({ id: 'fc_negativo', tipo: 'critica', modulo: 'flujocaja', icono: 'ğŸ¦', titulo: 'Saldo de caja negativo', mensaje: `Saldo acumulado negativo: S/ ${Math.abs(saldoTotal).toLocaleString('es-PE',{minimumFractionDigits:2})}`, ref: 'Flujo de caja', leida: false });
  }

  // 7. InformaciÃ³n general
  const proyActivos = proyectos.filter(p => (p.estado||'').toLowerCase() === 'activo' || (p.estado||'').toLowerCase() === 'en curso').length;
  if (proyActivos > 0) {
    _alertas.push({ id: 'info_proyectos', tipo: 'info', modulo: 'proyectos', icono: 'â„¹ï¸', titulo: 'Proyectos activos', mensaje: `TenÃ©s ${proyActivos} proyecto${proyActivos>1?'s':''} activo${proyActivos>1?'s':''}`, ref: '', leida: true });
  }

  // Load leidas from localStorage
  const leidasGuardadas = JSON.parse(localStorage.getItem('bc_alertas_leidas') || '[]');
  _alertas.forEach(a => { if (leidasGuardadas.includes(a.id)) a.leida = true; });

  renderAlertas();
}

function renderAlertas() {
  const container = document.getElementById('alertas-container');
  let filtradas = _alertas;
  if (_alertasFiltroActual !== 'todas') filtradas = _alertas.filter(a => a.tipo === _alertasFiltroActual);
  
  const criticas = _alertas.filter(a => a.tipo === 'critica').length;
  const advertencias = _alertas.filter(a => a.tipo === 'advertencia').length;
  const infos = _alertas.filter(a => a.tipo === 'info').length;
  const leidas = _alertas.filter(a => a.leida).length;

  const _sEl = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
  _sEl('cnt-alertas-criticas', criticas);
  _sEl('cnt-alertas-advertencias', advertencias);
  _sEl('cnt-alertas-info', infos);
  _sEl('cnt-alertas-leidas', leidas);
  _sEl('alertas-sub', `${_alertas.length} alertas Â· ${criticas} crÃ­ticas Â· ${advertencias} advertencias`);

  // Update badge in nav
  const noLeidas = _alertas.filter(a => !a.leida && a.tipo !== 'info').length;
  const badge = document.getElementById('badge-alertas');
  if (badge) { badge.textContent = noLeidas; badge.style.display = noLeidas > 0 ? '' : 'none'; }

  if (!filtradas.length) {
    container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--muted);">
      <div style="font-size:48px;margin-bottom:12px;">âœ…</div>
      <div style="font-size:16px;font-weight:600;margin-bottom:6px;">Sin alertas${_alertasFiltroActual!=='todas'?' de este tipo':''}</div>
      <div style="font-size:13px;">Todo en orden</div>
    </div>`;
    return;
  }

  const tipoConfig = {
    critica: { bg: 'rgba(220,53,69,0.08)', border: 'var(--red)', badge: 'rgba(220,53,69,0.15)', badgeColor: 'var(--red)', label: 'CrÃ­tica' },
    advertencia: { bg: 'rgba(245,166,35,0.08)', border: 'var(--accent)', badge: 'rgba(245,166,35,0.15)', badgeColor: 'var(--accent)', label: 'Advertencia' },
    info: { bg: 'rgba(0,123,255,0.06)', border: 'var(--blue)', badge: 'rgba(0,123,255,0.15)', badgeColor: 'var(--blue)', label: 'Info' }
  };

  container.innerHTML = filtradas.map(a => {
    const cfg = tipoConfig[a.tipo] || tipoConfig.info;
    const opacidad = a.leida ? '0.5' : '1';
    return `<div style="display:flex;align-items:flex-start;gap:14px;padding:16px 18px;background:${cfg.bg};border:1px solid ${a.leida?'var(--border)':cfg.border};border-left:4px solid ${a.leida?'var(--border)':cfg.border};border-radius:10px;opacity:${opacidad};transition:opacity 0.3s;">
      <div style="font-size:24px;flex-shrink:0;">${a.icono}</div>
      <div style="flex:1;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;flex-wrap:wrap;">
          <span style="font-weight:700;font-size:14px;">${a.titulo}</span>
          <span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${cfg.badge};color:${cfg.badgeColor};">${cfg.label}</span>
          ${a.leida ? '<span style="font-size:11px;color:var(--muted);">âœ“ LeÃ­da</span>' : ''}
        </div>
        <div style="font-size:13px;color:var(--muted2);">${a.mensaje}</div>
      </div>
      <div style="flex-shrink:0;display:flex;gap:8px;align-items:center;">
        ${!a.leida ? `<button class="btn btn-ghost btn-sm" style="padding:4px 10px;font-size:11px;" onclick="marcarLeida('${a.id}')">âœ“ LeÃ­da</button>` : ''}
        <button class="btn btn-ghost btn-sm" style="padding:4px 10px;font-size:11px;" onclick="irAModulo('${a.modulo}')">Ver â†’</button>
      </div>
    </div>`;
  }).join('');
}

function filtrarAlertas(tipo, btn) {
  _alertasFiltroActual = tipo;
  document.querySelectorAll('.alerta-filter').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderAlertas();
}

function marcarLeida(id) {
  const a = _alertas.find(x => x.id === id);
  if (a) a.leida = true;
  const leidas = _alertas.filter(x => x.leida).map(x => x.id);
  localStorage.setItem('bc_alertas_leidas', JSON.stringify(leidas));
  renderAlertas();
}

function marcarTodasLeidas() {
  _alertas.forEach(a => a.leida = true);
  localStorage.setItem('bc_alertas_leidas', JSON.stringify(_alertas.map(a => a.id)));
  renderAlertas();
  toast('Alertas', 'Todas marcadas como leÃ­das', 'ok');
}

function irAModulo(modulo) {
  const navEl = document.querySelector(`.nav-item[onclick*="nav('${modulo}"]`);
  nav(modulo, navEl);
}

// Auto-generate alerts on load and update badge
function checkAlertasBadge() {
  // Quick scan without rendering
  const hoy = new Date();
  const msDay = 86400000;
  let count = 0;
  proyectos.forEach(p => {
    if (!p.fechaFin && !p.fecha_fin) return;
    const diff = Math.round((new Date(p.fechaFin||p.fecha_fin) - hoy) / msDay);
    if (diff <= 15) count++;
  });
  facturas.forEach(f => {
    if (!f.fechaVencimiento && !f.fecha_vencimiento) return;
    const estadoF = (f.estado||'').toLowerCase();
    if (estadoF === 'cobrada' || estadoF === 'pagada') return;
    const diff = Math.round((new Date(f.fechaVencimiento||f.fecha_vencimiento) - hoy) / msDay);
    if (diff <= 7) count++;
  });
  const badge = document.getElementById('badge-alertas');
  if (badge) { badge.textContent = count; badge.style.display = count > 0 ? '' : 'none'; }
}

// ============================================================
// ===== REPORTES PDF (mejorado con Gantt) ====================
// ============================================================

function exportReportePDF() {
  const hoy = new Date().toLocaleDateString('es-PE', { day:'numeric', month:'long', year:'numeric' });
  const totalCartera = proyectos.reduce((s,p) => s + parseFloat(p.presupuesto||p.monto||0), 0);
  const proyActivos = proyectos.filter(p => ['activo','en curso','en ejecuciÃ³n'].includes((p.estado||'').toLowerCase())).length;

  // Gantt chart data
  const ganttRows = proyectos.slice(0,10).map(p => {
    const inicio = p.fechaInicio || p.fecha_inicio || new Date().toISOString().slice(0,10);
    const fin = p.fechaFin || p.fecha_fin || new Date(Date.now() + 90*86400000).toISOString().slice(0,10);
    const dInicio = new Date(inicio);
    const dFin = new Date(fin);
    const totalDias = Math.max(1, Math.round((dFin - dInicio) / 86400000));
    const diasTranscurridos = Math.max(0, Math.round((new Date() - dInicio) / 86400000));
    const avance = Math.min(100, Math.round((diasTranscurridos / totalDias) * 100));
    return { nombre: p.nombre, inicio, fin, avance, estado: p.estado || 'activo' };
  });

  // Find date range for Gantt
  const allFechas = ganttRows.flatMap(r => [new Date(r.inicio), new Date(r.fin)]);
  const minDate = allFechas.length ? new Date(Math.min(...allFechas.map(d => d.getTime()))) : new Date();
  const maxDate = allFechas.length ? new Date(Math.max(...allFechas.map(d => d.getTime()))) : new Date(Date.now() + 180*86400000);
  const totalRangeDias = Math.max(1, Math.round((maxDate - minDate) / 86400000));

  const ganttHTML = ganttRows.map(r => {
    const dInicio = new Date(r.inicio);
    const dFin = new Date(r.fin);
    const offsetPct = Math.round(((dInicio - minDate) / 86400000 / totalRangeDias) * 100);
    const widthPct = Math.max(2, Math.round(((dFin - dInicio) / 86400000 / totalRangeDias) * 100));
    const estadoColor = { activo:'#f5a623', 'en curso':'#28a745', completado:'#007bff', inactivo:'#6c757d' }[(r.estado||'').toLowerCase()] || '#f5a623';
    return `<tr>
      <td style="padding:6px 10px;font-size:11px;width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.nombre}</td>
      <td style="padding:6px 4px;font-size:10px;color:#888;">${r.inicio}</td>
      <td style="padding:6px 4px;font-size:10px;color:#888;">${r.fin}</td>
      <td style="padding:6px 8px;position:relative;">
        <div style="background:#2a2a3a;border-radius:4px;height:18px;position:relative;">
          <div style="position:absolute;left:${offsetPct}%;width:${widthPct}%;background:${estadoColor};height:100%;border-radius:4px;opacity:0.85;"></div>
          <div style="position:absolute;left:${offsetPct}%;width:${Math.min(widthPct, r.avance * widthPct / 100)}%;background:${estadoColor};height:100%;border-radius:4px;"></div>
        </div>
      </td>
      <td style="padding:6px 8px;font-size:11px;text-align:right;white-space:nowrap;color:${estadoColor};font-weight:600;">${r.avance}%</td>
    </tr>`;
  }).join('');

  // Movimientos summary for flujo
  const movResumen = {};
  _movimientos.forEach(m => {
    const mes = (m.fecha||'').slice(0,7);
    if (!movResumen[mes]) movResumen[mes] = { ing:0, eg:0 };
    if (m.tipo === 'ingreso') movResumen[mes].ing += parseFloat(m.monto||0);
    else movResumen[mes].eg += parseFloat(m.monto||0);
  });
  const flujoRows = Object.entries(movResumen).sort((a,b) => b[0].localeCompare(a[0])).slice(0,6).map(([mes, v]) => {
    const saldo = v.ing - v.eg;
    return `<tr style="border-bottom:1px solid #1e1e2a;">
      <td style="padding:7px 12px;">${mes}</td>
      <td style="padding:7px 12px;color:#28a745;text-align:right;">S/ ${v.ing.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
      <td style="padding:7px 12px;color:#dc3545;text-align:right;">S/ ${v.eg.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
      <td style="padding:7px 12px;font-weight:700;color:${saldo>=0?'#28a745':'#dc3545'};text-align:right;">S/ ${Math.abs(saldo).toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
    </tr>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Reporte BuildCore â€” ${hoy}</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',Arial,sans-serif; background:#0f0f17; color:#e0e0e0; padding:30px; }
  @media print { body { background:#fff !important; color:#000 !important; } .no-print { display:none; } }
  .header { background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%); border-radius:12px; padding:28px 32px; margin-bottom:24px; border:1px solid #2a2a4a; display:flex; justify-content:space-between; align-items:center; }
  .logo { font-size:22px; font-weight:800; color:#f5a623; letter-spacing:-0.5px; }
  .report-meta { text-align:right; font-size:12px; color:#888; }
  .report-meta span { display:block; }
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:24px; }
  .stat { background:#1a1a2e; border-radius:10px; padding:18px; border:1px solid #2a2a3a; text-align:center; }
  .stat-val { font-size:24px; font-weight:800; color:#f5a623; }
  .stat-lbl { font-size:11px; color:#888; margin-top:4px; }
  .section { background:#1a1a2e; border-radius:10px; padding:20px; margin-bottom:20px; border:1px solid #2a2a3a; }
  .section-title { font-size:14px; font-weight:700; margin-bottom:14px; color:#f5a623; border-bottom:1px solid #2a2a3a; padding-bottom:10px; }
  table { width:100%; border-collapse:collapse; font-size:12px; }
  th { background:#0f0f17; padding:8px 12px; text-align:left; color:#888; font-weight:600; font-size:11px; }
  td { padding:8px 12px; border-bottom:1px solid #1e1e2a; }
  .badge { display:inline-block; padding:2px 8px; border-radius:20px; font-size:10px; font-weight:600; }
  .badge-green { background:rgba(40,167,69,0.2); color:#28a745; }
  .badge-orange { background:rgba(245,166,35,0.2); color:#f5a623; }
  .badge-red { background:rgba(220,53,69,0.2); color:#dc3545; }
  .btn-print { background:#f5a623; color:#000; border:none; padding:10px 24px; border-radius:8px; font-size:13px; font-weight:700; cursor:pointer; margin-bottom:20px; }
</style></head>
<body>
<div class="no-print" style="margin-bottom:20px;">
  <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
  <button class="btn-print" style="background:#2a2a4a;color:#e0e0e0;margin-left:10px;" onclick="window.close()">âœ• Cerrar</button>
</div>

<div class="header">
  <div>
    <div class="logo">ğŸ—ï¸ BuildCore</div>
    <div style="font-size:13px;color:#888;margin-top:4px;">Reporte Ejecutivo de GestiÃ³n</div>
  </div>
  <div class="report-meta">
    <span style="font-size:16px;font-weight:700;color:#e0e0e0;">${hoy}</span>
    <span>Generado automÃ¡ticamente</span>
  </div>
</div>

<div class="stats-row">
  <div class="stat"><div class="stat-val">S/ ${(totalCartera/1000000).toFixed(1)}M</div><div class="stat-lbl">Cartera Total</div></div>
  <div class="stat"><div class="stat-val">${proyActivos}</div><div class="stat-lbl">Proyectos Activos</div></div>
  <div class="stat"><div class="stat-val">${personal.length}</div><div class="stat-lbl">Personal</div></div>
  <div class="stat"><div class="stat-val">${facturas.length}</div><div class="stat-lbl">Facturas</div></div>
</div>

<div class="section">
  <div class="section-title">ğŸ“Š Cronograma Gantt â€” Proyectos</div>
  <table>
    <thead><tr><th>Proyecto</th><th>Inicio</th><th>Fin</th><th>Progreso</th><th>Avance</th></tr></thead>
    <tbody>${ganttHTML}</tbody>
  </table>
</div>

<div class="section">
  <div class="section-title">ğŸ’° Flujo de Caja â€” Ãšltimos 6 Meses</div>
  ${flujoRows ? `<table>
    <thead><tr><th>Mes</th><th style="text-align:right;">Ingresos</th><th style="text-align:right;">Egresos</th><th style="text-align:right;">Saldo</th></tr></thead>
    <tbody>${flujoRows}</tbody>
  </table>` : '<div style="color:#888;text-align:center;padding:20px;">Sin movimientos de caja registrados</div>'}
</div>

<div class="section">
  <div class="section-title">ğŸ—ï¸ Estado de Proyectos</div>
  <table>
    <thead><tr><th>Proyecto</th><th>Cliente</th><th>Presupuesto</th><th>Estado</th><th>Avance</th></tr></thead>
    <tbody>
      ${proyectos.map(p => {
        const est = (p.estado||'activo').toLowerCase();
        const badgeClass = est.includes('complet') ? 'badge-green' : est.includes('activo')||est.includes('ejecuciÃ³n')||est.includes('curso') ? 'badge-orange' : 'badge-red';
        return `<tr>
          <td><b>${p.nombre}</b></td>
          <td style="color:#888;">${p.cliente||'â€”'}</td>
          <td>S/ ${parseFloat(p.presupuesto||p.monto||0).toLocaleString('es-PE')}</td>
          <td><span class="badge ${badgeClass}">${p.estado||'Activo'}</span></td>
          <td>${p.avance||0}%</td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>
</div>

<div style="text-align:center;color:#555;font-size:11px;margin-top:30px;padding:16px;border-top:1px solid #2a2a3a;">
  BuildCore â€” Sistema de GestiÃ³n de ConstrucciÃ³n Â· Reporte generado el ${hoy}
</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('PDF', 'Reporte abierto â€” usÃ¡ Ctrl+P para guardar como PDF', 'ok');
}

// Override existing export button in Reportes page to also offer PDF
const _origExportReporteExcel = typeof exportReporteExcel !== 'undefined' ? exportReporteExcel : null;


// =====================================================================
// ==================== GANTT ==========================================
// =====================================================================
function renderGantt() {
  const container = document.getElementById('gantt-container');
  if (!container) return;
  const proyectos = db.proyectos.filter(p => p.inicio && p.fin);
  if (proyectos.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:32px;">Sin proyectos con fechas. AgregÃ¡ fechas de inicio y fin en cada proyecto.</div>';
    return;
  }
  const fechaMin = new Date(Math.min(...proyectos.map(p => new Date(p.inicio))));
  const fechaMax = new Date(Math.max(...proyectos.map(p => new Date(p.fin))));
  const totalDias = Math.ceil((fechaMax - fechaMin) / 86400000) + 1;
  const hoy = new Date();
  const todayPct = Math.min(Math.max(Math.ceil((hoy - fechaMin) / 86400000) / totalDias * 100, 0), 100).toFixed(2);
  const colores = ['var(--accent)','var(--blue)','var(--green)','var(--purple)','#f43f5e','#06b6d4'];

  const meses = {};
  for (let i = 0; i <= totalDias; i++) {
    const d = new Date(fechaMin); d.setDate(d.getDate() + i);
    const key = d.toISOString().slice(0,7);
    meses[key] = (meses[key]||0) + 1;
  }
  const monthsHtml = Object.entries(meses).map(([mes, dias]) =>
    `<div style="width:${(dias/totalDias*100).toFixed(1)}%;min-width:28px;font-size:10px;color:var(--muted2);border-left:1px solid var(--border);padding-left:3px;overflow:hidden;white-space:nowrap;">${mes}</div>`
  ).join('');

  const barsHtml = proyectos.map((p, i) => {
    const ini = new Date(p.inicio), fin = new Date(p.fin);
    const left = (Math.max(Math.ceil((ini - fechaMin) / 86400000), 0) / totalDias * 100).toFixed(2);
    const width = Math.max((Math.ceil((fin - ini) / 86400000) + 1) / totalDias * 100, 0.5).toFixed(2);
    const avance = Math.min(parseFloat(p.avance || 0), 100);
    const color = colores[i % colores.length];
    return `<div style="display:flex;align-items:center;margin-bottom:8px;">
      <div style="width:150px;font-size:11px;font-weight:600;color:var(--text);padding-right:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;" title="${p.nombre}">${p.nombre}</div>
      <div style="flex:1;position:relative;height:26px;background:var(--bg4);border-radius:6px;overflow:visible;">
        <div style="position:absolute;left:${todayPct}%;top:-4px;bottom:-4px;width:2px;background:rgba(239,68,68,0.8);z-index:2;border-radius:1px;"></div>
        <div style="position:absolute;left:${left}%;width:${width}%;height:100%;background:${color}22;border:1px solid ${color}66;border-radius:5px;overflow:hidden;">
          <div style="width:${avance}%;height:100%;background:${color};opacity:0.85;"></div>
          <div style="position:absolute;inset:0;display:flex;align-items:center;padding:0 6px;font-size:9px;color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;">${p.nombre.slice(0,16)} ${avance}%</div>
        </div>
      </div>
      <div style="width:70px;font-size:9px;color:var(--muted);padding-left:6px;flex-shrink:0;">${p.inicio}<br>${p.fin}</div>
    </div>`;
  }).join('');

  container.innerHTML = `<div style="min-width:600px;padding:4px 0;">
    <div style="display:flex;margin-left:150px;margin-right:70px;margin-bottom:6px;">${monthsHtml}</div>
    ${barsHtml}
    <div style="font-size:10px;color:var(--muted);margin-top:6px;margin-left:150px;">
      <span style="display:inline-block;width:14px;height:2px;background:rgba(239,68,68,0.8);vertical-align:middle;margin-right:4px;"></span>Hoy (${hoy.toISOString().slice(0,10)})
    </div>
  </div>`;
}

function exportGanttPDF() {
  if (!window.jspdf) { toast('jsPDF no disponible','RecargÃ¡ la pÃ¡gina','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape' });
  doc.setFillColor(13,15,18); doc.rect(0,0,297,210,'F');
  doc.setFontSize(16); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text('DIAGRAMA GANTT â€” BUILDCORE', 148, 18, {align:'center'});
  doc.setFontSize(9); doc.setTextColor(100,116,139); doc.setFont('helvetica','normal');
  doc.text('Generado: ' + new Date().toLocaleDateString('es-PE'), 148, 26, {align:'center'});
  const proyectos = db.proyectos.filter(p => p.inicio && p.fin);
  if (proyectos.length === 0) { doc.setTextColor(148,163,184); doc.text('Sin proyectos con fechas.',148,80,{align:'center'}); doc.save('gantt.pdf'); return; }
  const fechaMin = new Date(Math.min(...proyectos.map(p=>new Date(p.inicio))));
  const fechaMax = new Date(Math.max(...proyectos.map(p=>new Date(p.fin))));
  const totalDias = Math.ceil((fechaMax-fechaMin)/86400000)+1;
  const hoy = new Date();
  const cL=55,cR=265,cW=cR-cL;
  doc.setFontSize(7); doc.setTextColor(100,116,139);
  doc.text(fechaMin.toISOString().slice(0,10),cL,33); doc.text(fechaMax.toISOString().slice(0,10),cR,33,{align:'right'});
  doc.setDrawColor(30,35,45); doc.line(cL,35,cR,35);
  let y=40;
  [[245,166,35],[59,130,246],[168,85,247],[34,197,94],[239,68,68],[6,182,212]].forEach((c,i)=>{
    const p=proyectos[i]; if(!p) return;
    const ini=new Date(p.inicio),fin=new Date(p.fin);
    const lft=cL+(Math.max(Math.ceil((ini-fechaMin)/86400000),0)/totalDias)*cW;
    const wdt=Math.max((Math.ceil((fin-ini)/86400000)+1)/totalDias*cW,1);
    const av=Math.min(parseFloat(p.avance||0),100);
    doc.setFillColor(c[0],c[1],c[2],0.15); doc.setDrawColor(c[0],c[1],c[2]);
    doc.roundedRect(lft,y,wdt,7,1.5,1.5,'FD');
    doc.setFillColor(c[0],c[1],c[2]);
    if(wdt*av/100>0) doc.roundedRect(lft,y,wdt*(av/100),7,1.5,1.5,'F');
    doc.setTextColor(40,50,60); doc.setFontSize(6);
    if(wdt>15) doc.text(p.nombre.slice(0,18)+' '+av+'%',lft+2,y+4.5);
    doc.setTextColor(148,163,184); doc.setFontSize(7.5); doc.text(p.nombre.slice(0,22),5,y+4.5);
    y+=11; if(y>185) y=185;
  });
  proyectos.slice(6).forEach((p,ii)=>{
    const c=[100,116,139]; const i=ii+6;
    const ini=new Date(p.inicio),fin=new Date(p.fin);
    const lft=cL+(Math.max(Math.ceil((ini-fechaMin)/86400000),0)/totalDias)*cW;
    const wdt=Math.max((Math.ceil((fin-ini)/86400000)+1)/totalDias*cW,1);
    const av=Math.min(parseFloat(p.avance||0),100);
    doc.setFillColor(c[0],c[1],c[2],0.15); doc.setDrawColor(c[0],c[1],c[2]);
    doc.roundedRect(lft,y,wdt,7,1.5,1.5,'FD');
    doc.setFillColor(c[0],c[1],c[2]);
    if(wdt*av/100>0) doc.roundedRect(lft,y,wdt*(av/100),7,1.5,1.5,'F');
    doc.setTextColor(148,163,184); doc.setFontSize(7.5); doc.text(p.nombre.slice(0,22),5,y+4.5);
    y+=11; if(y>185) y=185;
  });
  const todX=cL+(Math.ceil((hoy-fechaMin)/86400000)/totalDias)*cW;
  if(todX>=cL&&todX<=cR){doc.setDrawColor(239,68,68);doc.setLineWidth(0.5);doc.line(todX,32,todX,y);doc.setFontSize(6);doc.setTextColor(239,68,68);doc.text('HOY',todX-4,31);}
  doc.save('gantt_buildcore_'+new Date().toISOString().slice(0,10)+'.pdf');
  toast('ğŸ“„ Gantt PDF generado','Descargado exitosamente');
}

function generarReportePDF() {
  if (!window.jspdf) { toast('jsPDF no disponible','RecargÃ¡ la pÃ¡gina','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const hoy = new Date().toLocaleDateString('es-PE');
  doc.setFillColor(13,15,18); doc.rect(0,0,210,297,'F');
  doc.setFontSize(22); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text('BUILDCORE', 105, 25, {align:'center'});
  doc.setFontSize(14); doc.setTextColor(241,245,249);
  doc.text('Reporte Ejecutivo de Proyectos', 105, 35, {align:'center'});
  doc.setFontSize(10); doc.setTextColor(100,116,139);
  doc.text('Generado: ' + hoy, 105, 43, {align:'center'});
  doc.setDrawColor(245,166,35); doc.setLineWidth(0.5); doc.line(20,48,190,48);
  const totalCartera=db.proyectos.reduce((a,p)=>a+parseFloat(p.presupuesto||0),0);
  const cumplim=db.proyectos.length>0?Math.round(db.proyectos.reduce((a,p)=>a+parseFloat(p.avance||0),0)/db.proyectos.length):0;
  const movs=window.dbMovimientos||[];
  const totalIng=movs.filter(m=>m.tipo==='ingreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  const totalEgr=movs.filter(m=>m.tipo==='egreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  doc.setFontSize(12); doc.setTextColor(241,245,249); doc.setFont('helvetica','bold');
  doc.text('RESUMEN EJECUTIVO',20,58);
  [['Cartera Total:','S/ '+totalCartera.toLocaleString('es-PE')],['Proyectos:',db.proyectos.length+' total'],['Avance Promedio:',cumplim+'%'],['Personal:',db.personal.length+' empleados'],['Ingresos:','S/ '+totalIng.toLocaleString('es-PE')],['Egresos:','S/ '+totalEgr.toLocaleString('es-PE')],['Saldo Neto:','S/ '+(totalIng-totalEgr).toLocaleString('es-PE')]].forEach(([k,v],i)=>{
    doc.setFont('helvetica','normal');doc.setFontSize(10);doc.setTextColor(148,163,184);doc.text(k,20,68+i*8);
    doc.setFont('helvetica','bold');doc.setTextColor(241,245,249);doc.text(v,80,68+i*8);
  });
  let y=130;
  doc.setFontSize(12);doc.setTextColor(245,166,35);doc.setFont('helvetica','bold');doc.text('PROYECTOS',20,y);y+=8;
  doc.setFontSize(8.5);doc.setTextColor(100,116,139);doc.setFont('helvetica','normal');
  doc.text('Proyecto',20,y);doc.text('Cliente',70,y);doc.text('Presupuesto',120,y);doc.text('Avance',155,y);doc.text('Estado',175,y);
  y+=3;doc.setDrawColor(40,50,60);doc.line(20,y,190,y);y+=5;
  db.proyectos.forEach(p=>{
    if(y>265){doc.addPage();doc.setFillColor(13,15,18);doc.rect(0,0,210,297,'F');y=20;}
    doc.setTextColor(241,245,249);doc.setFontSize(9);
    doc.text((p.nombre||'').slice(0,28),20,y);doc.text((p.cliente||'').slice(0,18),70,y);
    doc.text('S/ '+(parseFloat(p.presupuesto||0)/1000).toFixed(0)+'K',120,y);
    doc.text((p.avance||0)+'%',155,y);doc.text(p.estado||'',175,y);y+=7;
  });
  doc.save('reporte_buildcore_'+hoy.replace(/\//g,'-')+'.pdf');
  toast('ğŸ“„ PDF generado','Reporte descargado exitosamente');
}

function exportFlujoCajaExcel() {
  const movs=window.dbMovimientos||[];
  const rows=[['Fecha','Concepto','CategorÃ­a','Proyecto','Tipo','Monto (S/)','Referencia']];
  movs.forEach(m=>{const proy=db.proyectos.find(p=>p.id===m.proyecto_id);rows.push([m.fecha,m.concepto,m.categoria||'',proy?.nombre||'General',m.tipo,m.monto,m.referencia||'']);});
  const ws=XLSX.utils.aoa_to_sheet(rows);const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'FlujoCaja');
  XLSX.writeFile(wb,'flujo_caja_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('ğŸ“¥ Excel generado','Flujo de caja exportado');
}

// =====================================================================
// ==================== HOOK NAV & REPORTES CHARTS =====================
// =====================================================================
document.addEventListener('DOMContentLoaded', function() {
  // Make dbMovimientos globally accessible for PDF
  if (typeof dbMovimientos !== 'undefined') window.dbMovimientos = dbMovimientos;
});

// Patch initReportesCharts to also render Gantt
const _bcOrigRepCharts = window.initReportesCharts;
window.initReportesCharts = function() {
  if (_bcOrigRepCharts) _bcOrigRepCharts();
  setTimeout(renderGantt, 120);
};

// Patch nav to handle new modules
const _bcOrigNav = window.nav;
if (typeof _bcOrigNav === 'function') {
  window.nav = function(page, el) {
    _bcOrigNav(page, el);
    if (page === 'reportes') setTimeout(renderGantt, 150);
    if (page === 'flujocaja') {
      const sel = document.getElementById('caja-filtro-proyecto');
      if (sel && db.proyectos.length > 0) {
        const cur = sel.value;
        sel.innerHTML = '<option value="">Todos los proyectos</option>' + db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
        sel.value = cur;
      }
    }
  };
}


// =====================================================================
// ==================== PWA â€” MANIFEST + SERVICE WORKER ===============
// =====================================================================
(function initPWA() {
  // Inject manifest dynamically
  const manifest = {
    name: "BuildCore â€” Sistema de GestiÃ³n",
    short_name: "BuildCore",
    description: "Sistema de gestiÃ³n para empresas constructoras",
    start_url: "./",
    display: "standalone",
    background_color: "#0d0f12",
    theme_color: "#0d0f12",
    orientation: "any",
    icons: [
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230d0f12'/%3E%3Ctext y='.9em' font-size='80' x='10'%3EğŸ—%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" },
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230d0f12'/%3E%3Ctext y='.9em' font-size='80' x='10'%3EğŸ—%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  document.getElementById('pwa-manifest').href = url;

  // Register service worker (inline via blob)
  if ('serviceWorker' in navigator) {
    const swCode = `
const CACHE = 'buildcore-v1';
const OFFLINE_KEY = 'bc_offline_queue';
self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/'])));
  self.skipWaiting();
});
self.addEventListener('activate', e => { e.waitUntil(clients.claim()); });
self.addEventListener('fetch', e => {
  if (e.request.method !== 'GET') return;
  e.respondWith(
    fetch(e.request).catch(() => caches.match(e.request).then(r => r || new Response('Offline', { status: 503 })))
  );
});
self.addEventListener('push', e => {
  const data = e.data ? e.data.json() : { title: 'BuildCore', body: 'Nueva notificaciÃ³n' };
  e.waitUntil(self.registration.showNotification(data.title, {
    body: data.body, icon: data.icon || '', badge: data.badge || '',
    tag: data.tag || 'buildcore', data: data.url || '/'
  }));
});
self.addEventListener('notificationclick', e => {
  e.notification.close();
  e.waitUntil(clients.openWindow(e.notification.data || '/'));
});
    `;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).then(reg => {
      window._swReg = reg;
      console.log('[BuildCore PWA] Service Worker registrado');
    }).catch(e => console.warn('[BuildCore PWA] SW error:', e));
  }

  // PWA install prompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.getElementById('pwa-install-btn');
    if (btn) btn.style.display = 'flex';
  });
  window.installPWA = function() {
    if (!deferredPrompt) { toast('InstalaciÃ³n', 'AbrÃ­ BuildCore en Chrome/Edge y usÃ¡ "Agregar a pantalla de inicio"', 'info'); return; }
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(r => {
      if (r.outcome === 'accepted') { toast('âœ… App instalada', 'BuildCore se instalÃ³ en tu dispositivo'); document.getElementById('pwa-install-btn').style.display = 'none'; }
      deferredPrompt = null;
    });
  };
  window.addEventListener('appinstalled', () => {
    toast('âœ… Instalada', 'BuildCore estÃ¡ disponible desde tu pantalla de inicio');
    document.getElementById('pwa-install-btn').style.display = 'none';
  });
})();

// =====================================================================
// ==================== OFFLINE MODE + SYNC AUTO =======================
// =====================================================================
const OFFLINE_QUEUE_KEY = 'bc_offline_queue_v1';
let _isOnline = navigator.onLine;
let _offlineQueue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');

function updateOnlineStatus() {
  _isOnline = navigator.onLine;
  const offEl = document.getElementById('offline-indicator');
  const syncEl = document.getElementById('sync-indicator');
  const pendEl = document.getElementById('pending-sync-indicator');
  const pendCnt = document.getElementById('pending-count');
  if (!_isOnline) {
    if (offEl) offEl.style.display = '';
    if (syncEl) syncEl.style.display = 'none';
    if (pendEl) pendEl.style.display = 'none';
    toast('ğŸ“¡ Sin conexiÃ³n', 'Los cambios se guardarÃ¡n localmente y sincronizarÃ¡n al reconectar', 'warn');
  } else {
    if (offEl) offEl.style.display = 'none';
    if (_offlineQueue.length > 0) {
      if (pendEl) pendEl.style.display = '';
      if (pendCnt) pendCnt.textContent = _offlineQueue.length;
      syncOfflineQueue();
    } else {
      if (syncEl) { syncEl.style.display = ''; setTimeout(() => { syncEl.style.display = 'none'; }, 3000); }
    }
  }
}

window.addEventListener('online', () => { updateOnlineStatus(); toast('ğŸŒ ConexiÃ³n restaurada', 'Sincronizando datos pendientes...', 'ok'); });
window.addEventListener('offline', () => updateOnlineStatus());

function addToOfflineQueue(table, method, data, id) {
  _offlineQueue.push({ table, method, data, id, ts: Date.now() });
  localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(_offlineQueue));
  const pendEl = document.getElementById('pending-sync-indicator');
  const pendCnt = document.getElementById('pending-count');
  if (pendEl) pendEl.style.display = '';
  if (pendCnt) pendCnt.textContent = _offlineQueue.length;
}

async function syncOfflineQueue() {
  if (!_isOnline || _offlineQueue.length === 0) return;
  const queue = [..._offlineQueue];
  let synced = 0;
  for (const item of queue) {
    try {
      const path = item.id ? `${item.table}?id=eq.${item.id}` : item.table;
      await sbFetch(path, { method: item.method, body: item.data });
      _offlineQueue = _offlineQueue.filter(q => q.ts !== item.ts);
      synced++;
    } catch(e) { break; }
  }
  localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(_offlineQueue));
  const pendEl = document.getElementById('pending-sync-indicator');
  const syncEl = document.getElementById('sync-indicator');
  const pendCnt = document.getElementById('pending-count');
  if (_offlineQueue.length === 0) {
    if (pendEl) pendEl.style.display = 'none';
    if (syncEl) { syncEl.style.display = ''; setTimeout(() => { syncEl.style.display = 'none'; }, 3000); }
    if (synced > 0) toast('âœ… Sincronizado', synced + ' registro(s) enviados a Supabase');
  } else {
    if (pendCnt) pendCnt.textContent = _offlineQueue.length;
  }
}

// Run sync check on start
setTimeout(() => { updateOnlineStatus(); if (_isOnline && _offlineQueue.length > 0) syncOfflineQueue(); }, 2000);

// =====================================================================
// ==================== NOTIFICACIONES PUSH ============================
// =====================================================================
let _notifPermission = 'default';

async function requestNotifications() {
  if (!('Notification' in window)) { toast('No disponible', 'Tu navegador no soporta notificaciones', 'warn'); return; }
  if (Notification.permission === 'granted') { toast('âœ… Notificaciones activas', 'Ya tenÃ©s las notificaciones habilitadas'); return; }
  const perm = await Notification.requestPermission();
  _notifPermission = perm;
  if (perm === 'granted') {
    toast('ğŸ”” Notificaciones habilitadas', 'Te avisaremos de alertas importantes');
    sendLocalNotification('BuildCore', 'Â¡Notificaciones activas! Te avisaremos de contratos, facturas y alertas.');
    scheduleAlertNotifications();
  } else {
    toast('Notificaciones bloqueadas', 'HabilitÃ¡ los permisos en la configuraciÃ³n de tu navegador', 'warn');
  }
}

function sendLocalNotification(title, body, tag) {
  if (Notification.permission !== 'granted') return;
  try {
    if (window._swReg && window._swReg.showNotification) {
      window._swReg.showNotification(title, { body, icon: '', tag: tag || 'buildcore', badge: '' });
    } else {
      new Notification(title, { body, tag: tag || 'buildcore' });
    }
  } catch(e) { console.warn('Notification error:', e); }
}

function scheduleAlertNotifications() {
  // Check every 30 min for critical alerts
  setInterval(() => {
    if (typeof generarAlertas !== 'function') return;
    const alertas = generarAlertas();
    const criticas = alertas.filter(a => a.tipo === 'critica');
    if (criticas.length > 0) {
      sendLocalNotification(
        'ğŸš¨ BuildCore â€” ' + criticas.length + ' alerta(s) crÃ­tica(s)',
        criticas.slice(0,3).map(a => a.msg).join(' | '),
        'alertas-criticas'
      );
    }
  }, 30 * 60 * 1000);
}

// Auto-request notifications after login
function initNotifications() {
  _notifPermission = Notification ? Notification.permission : 'default';
  if (_notifPermission === 'granted') scheduleAlertNotifications();
  else if (_notifPermission === 'default') {
    // Show subtle prompt after 10 seconds
    setTimeout(() => {
      if (document.getElementById('login-screen').style.display === 'none') {
        showNotifPrompt();
      }
    }, 10000);
  }
}

function showNotifPrompt() {
  const existing = document.getElementById('notif-prompt');
  if (existing) return;
  const el = document.createElement('div');
  el.id = 'notif-prompt';
  el.style.cssText = 'position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border2);border-radius:12px;padding:16px 20px;z-index:9998;max-width:300px;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
  el.innerHTML = `
    <div style="font-weight:700;font-size:14px;margin-bottom:6px;">ğŸ”” Activar notificaciones</div>
    <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;">RecibÃ­ alertas de contratos vencidos, facturas y mÃ¡s.</div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary btn-sm" style="flex:1" onclick="requestNotifications();document.getElementById('notif-prompt').remove()">Activar</button>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('notif-prompt').remove()">Ahora no</button>
    </div>`;
  document.body.appendChild(el);
}

// =====================================================================
// ==================== IMPORTAR DESDE EXCEL ==========================
// =====================================================================
const IMPORT_SCHEMAS = {
  personal: {
    cols: ['nombre *', 'rol', 'cuadrilla', 'tipo_contrato', 'sueldo', 'horas_semana', 'telefono', 'email', 'fecha_inicio', 'fecha_fin'],
    example: [['Juan PÃ©rez','AlbaÃ±il','Cuadrilla A','Fijo',1800,48,'099123456','juan@mail.com','2025-01-01','2025-12-31']]
  },
  proyectos: {
    cols: ['nombre *', 'tipo', 'cliente', 'presupuesto', 'avance', 'estado', 'ubicacion', 'inicio', 'fin'],
    example: [['Torre Central','Residencial','Cliente SA',500000,35,'activo','Av. Principal 123','2025-01-01','2025-12-31']]
  },
  maquinaria: {
    cols: ['nombre *', 'tipo', 'modelo', 'matricula', 'horas', 'tarifa', 'costo_hora', 'estado', 'proximo_mantenimiento'],
    example: [['Excavadora 320','Excavadora','CAT 320','ABC-123',120,85,30,'activo','2025-06-01']]
  },
  materiales: {
    cols: ['nombre *', 'categoria', 'unidad', 'stock', 'stock_minimo', 'precio_unitario', 'proveedor'],
    example: [['Cemento Portland','Materiales bÃ¡sicos','bolsa',500,50,18.5,'Proveedor ABC']]
  },
  proveedores: {
    cols: ['empresa *', 'ruc', 'contacto', 'telefono', 'email', 'categoria', 'ciudad'],
    example: [['Proveedor ABC SAC','20123456789','Juan GarcÃ­a','01-234-5678','info@prov.com','Materiales','Lima']]
  }
};

let _importData = null;
let _importTipo = 'personal';

function updateImportTemplate() {
  _importTipo = document.getElementById('import-tipo').value;
  const schema = IMPORT_SCHEMAS[_importTipo];
  document.getElementById('import-columns').innerHTML = schema.cols.map((c,i) => `<span style="background:var(--bg4);padding:2px 8px;border-radius:4px;margin:2px;display:inline-block;">${i+1}. ${c}</span>`).join('');
  _importData = null;
  document.getElementById('import-preview').style.display = 'none';
  document.getElementById('import-result').style.display = 'none';
  document.getElementById('import-btn').disabled = true;
  document.getElementById('import-file').value = '';
}

function downloadImportTemplate() {
  const tipo = document.getElementById('import-tipo').value;
  const schema = IMPORT_SCHEMAS[tipo];
  const ws = XLSX.utils.aoa_to_sheet([schema.cols.map(c => c.replace(' *','')), ...schema.example]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, tipo);
  XLSX.writeFile(wb, 'plantilla_' + tipo + '.xlsx');
  toast('â¬‡ï¸ Plantilla descargada', 'CompletÃ¡ el archivo y luego importalo');
}

function previewImport(input) {
  const file = input.files[0];
  if (!file) return;
  _importData = null;
  document.getElementById('import-btn').disabled = true;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      if (rows.length < 2) { toast('Archivo vacÃ­o', 'El archivo no tiene datos', 'err'); return; }

      const headers = rows[0].map(h => String(h).toLowerCase().trim());
      const dataRows = rows.slice(1).filter(r => r.some(c => c !== ''));
      _importData = { headers, rows: dataRows, tipo: _importTipo };

      // Preview table
      const preview = document.getElementById('import-preview');
      const previewTitle = document.getElementById('import-preview-title');
      const previewContent = document.getElementById('import-preview-content');
      previewTitle.textContent = `Vista previa â€” ${dataRows.length} fila(s) encontrada(s)`;
      const sample = dataRows.slice(0,5);
      previewContent.innerHTML = `<div style="overflow-x:auto;"><table style="font-size:11px;width:100%;border-collapse:collapse;">
        <thead><tr>${headers.map(h=>`<th style="padding:4px 8px;background:var(--bg4);color:var(--muted2);white-space:nowrap;">${h}</th>`).join('')}</tr></thead>
        <tbody>${sample.map(r=>`<tr>${r.map(c=>`<td style="padding:3px 8px;border-top:1px solid var(--border);white-space:nowrap;">${c}</td>`).join('')}</tr>`).join('')}</tbody>
      </table></div>`;
      preview.style.display = '';
      document.getElementById('import-btn').disabled = false;
      toast('âœ… Archivo leÃ­do', dataRows.length + ' filas listas para importar');
    } catch(err) {
      toast('Error al leer archivo', err.message, 'err');
    }
  };
  reader.readAsArrayBuffer(file);
}

async function executeImport() {
  if (!_importData) return;
  const { headers, rows, tipo } = _importData;
  showLoading(true);
  let imported = 0, errors = 0;
  const resultEl = document.getElementById('import-result');

  const mapRow = (row) => {
    const obj = {};
    headers.forEach((h,i) => { obj[h.replace(/[^a-z0-9_]/g,'')] = row[i]; });
    return obj;
  };

  for (const row of rows) {
    const r = mapRow(row);
    try {
      if (tipo === 'personal') {
        await importPersonal(r);
      } else if (tipo === 'proyectos') {
        await importProyecto(r);
      } else if (tipo === 'maquinaria') {
        await importMaquina(r);
      } else if (tipo === 'materiales') {
        await importMaterial(r);
      } else if (tipo === 'proveedores') {
        await importProveedor(r);
      }
      imported++;
    } catch(e) { errors++; console.warn('Import error row:', row, e); }
  }

  showLoading(false);
  resultEl.style.display = '';
  resultEl.innerHTML = `<div style="background:${imported>0?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};border-radius:10px;padding:14px;border:1px solid ${imported>0?'rgba(34,197,94,0.3)':'rgba(239,68,68,0.3)'};">
    <div style="font-weight:700;color:${imported>0?'var(--green)':'var(--red)'};">${imported>0?'âœ…':'âŒ'} ImportaciÃ³n ${imported>0?'completada':'con errores'}</div>
    <div style="font-size:12px;color:var(--muted2);margin-top:4px;">${imported} importado(s) exitosamente Â· ${errors} error(es)</div>
  </div>`;

  if (imported > 0) {
    await loadAllData();
    toast('ğŸ“¤ ImportaciÃ³n completa', imported + ' registros de ' + tipo + ' importados');
  }
  _importData = null;
  document.getElementById('import-btn').disabled = true;
}

async function importPersonal(r) {
  const nombre = r.nombre || r['nombre_'] || r.name;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre), rol: r.rol||r.cargo||'Obrero',
    cuadrilla: r.cuadrilla||'', tipo: r.tipo_contrato||r.tipo||'Fijo',
    sueldo: parseFloat(r.sueldo)||0, horas: parseFloat(r.horas_semana||r.horas)||48,
    telefono: r.telefono||r.tel||'', email: r.email||'',
    proyecto_id: null, activo: true,
    fecha_inicio: r.fecha_inicio||r.inicio||null, fecha_fin: r.fecha_fin||r.fin||null
  };
  try { await sbFetch('personal', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('personal','POST',payload,null); }
}

async function importProyecto(r) {
  const nombre = r.nombre || r.project || r.proyecto;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre), tipo: r.tipo||'Residencial',
    cliente: r.cliente||'', presupuesto: parseFloat(r.presupuesto)||0,
    avance: parseFloat(r.avance)||0, estado: r.estado||'activo',
    ubicacion: r.ubicacion||r.direccion||'',
    inicio: r.inicio||r.fecha_inicio||null, fin: r.fin||r.fecha_fin||null
  };
  try { await sbFetch('proyectos', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('proyectos','POST',payload,null); }
}

async function importMaquina(r) {
  const nombre = r.nombre || r.equipo || r.maquina;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre), tipo: r.tipo||'',
    modelo: r.modelo||'', matricula: r.matricula||r.patente||'',
    horas: parseFloat(r.horas)||0, tarifa: parseFloat(r.tarifa)||0,
    costo_hora: parseFloat(r.costo_hora||r.costohora)||0,
    estado: r.estado||'activo', proximo_mantenimiento: r.proximo_mantenimiento||r.mantenim||null
  };
  try { await sbFetch('maquinaria', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('maquinaria','POST',payload,null); }
}

async function importMaterial(r) {
  const nombre = r.nombre || r.material || r.descripcion;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre),
    categoria: r.categoria||'', unidad: r.unidad||'und',
    stock: parseFloat(r.stock)||0, stock_minimo: parseFloat(r.stock_minimo||r.stockminimo)||0,
    precio_unitario: parseFloat(r.precio_unitario||r.precio)||0,
    proveedor: r.proveedor||''
  };
  try { await sbFetch('materiales', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('materiales','POST',payload,null); }
}

async function importProveedor(r) {
  const empresa = r.empresa || r.nombre || r.company;
  if (!empresa) throw new Error('Sin empresa');
  const payload = {
    id: crypto.randomUUID(), empresa: String(empresa), ruc: r.ruc||'',
    contacto: r.contacto||r.nombre_contacto||'',
    telefono: r.telefono||r.tel||'', email: r.email||'',
    categoria: r.categoria||'', ciudad: r.ciudad||''
  };
  try { await sbFetch('proveedores', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('proveedores','POST',payload,null); }
}

// =====================================================================
// ==================== HISTORIAL MAQUINARIA ===========================
// =====================================================================
const MAQ_HIST_KEY = 'bc_maq_historial_v1';
let dbMaqHistorial = JSON.parse(localStorage.getItem(MAQ_HIST_KEY) || '[]');

async function loadMaqHistorialSB() {
  try {
    const rows = await sbFetch('maquinaria_historial?order=fecha.desc&limit=500');
    dbMaqHistorial = rows.map(r => ({
      id: r.id, maquina_id: r.maquina_id, maquina_nombre: r.maquina_nombre,
      fecha: r.fecha, tipo: r.tipo, proyecto_id: r.proyecto_id,
      horas: r.horas, combustible: r.combustible, costo_combustible: r.costo_combustible,
      operador: r.operador, obs: r.observacion
    }));
    localStorage.setItem(MAQ_HIST_KEY, JSON.stringify(dbMaqHistorial));
  } catch(e) {
    dbMaqHistorial = JSON.parse(localStorage.getItem(MAQ_HIST_KEY) || '[]');
  }
}

function renderHistorialMaq() {
  const filtro = document.getElementById('maq-hist-filtro')?.value || '';

  // Populate selector
  const sel = document.getElementById('maq-hist-filtro');
  if (sel && db.maquinaria.length > 0) {
    const cur = sel.value;
    sel.innerHTML = '<option value="">Todos los equipos</option>' + db.maquinaria.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('');
    sel.value = cur;
  }

  const items = filtro ? dbMaqHistorial.filter(r => r.maquina_id === filtro) : dbMaqHistorial;

  // KPIs combustible
  const totalComb = dbMaqHistorial.reduce((a,r) => a + parseFloat(r.combustible||0), 0);
  const totalCostoComb = dbMaqHistorial.reduce((a,r) => a + parseFloat(r.costo_combustible||0), 0);
  const totalMantenim = dbMaqHistorial.filter(r => r.tipo === 'mantenimiento').length;
  const el_c = document.getElementById('maq-combustible-total');
  const el_cc = document.getElementById('maq-comb-costo');
  const el_m = document.getElementById('maq-mantenim-count');
  if (el_c) el_c.textContent = totalComb.toFixed(0) + ' L';
  if (el_cc) el_cc.textContent = 'S/ ' + totalCostoComb.toLocaleString('es-PE');
  if (el_m) el_m.textContent = totalMantenim;

  const tipoEmoji = { uso:'âš™ï¸', combustible:'â›½', mantenimiento:'ğŸ”§', revision:'ğŸ”' };
  const tipoColor = { uso:'var(--blue)', combustible:'var(--accent)', mantenimiento:'var(--red)', revision:'var(--purple)' };

  const tbody = document.getElementById('historial-maq-table');
  if (!tbody) return;

  tbody.innerHTML = items.length === 0
    ? '<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:24px;">Sin registros. HacÃ© clic en "+ Registrar Uso".</td></tr>'
    : items.map(r => {
        const proy = db.proyectos.find(p => p.id === r.proyecto_id);
        const tc = tipoColor[r.tipo] || 'var(--muted)';
        return `<tr>
          <td>${r.fecha||'â€”'}</td>
          <td><strong>${r.maquina_nombre||'â€”'}</strong></td>
          <td>${proy?.nombre||'â€”'}</td>
          <td>${r.horas||0}h</td>
          <td>${r.combustible||0} L</td>
          <td>S/ ${parseFloat(r.costo_combustible||0).toFixed(2)}</td>
          <td>${r.operador||'â€”'}</td>
          <td><span style="color:${tc};font-weight:600;">${tipoEmoji[r.tipo]||''} ${r.tipo||'â€”'}</span></td>
          <td style="font-size:11px;color:var(--muted2);">${r.obs||'â€”'}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteUsoMaquina('${r.id}')">ğŸ—‘ï¸</button>
          </td>
        </tr>`;
      }).join('');

  // Mobile cards
  const mobile = document.getElementById('historial-maq-mobile');
  if (mobile) {
    mobile.innerHTML = items.slice(0,20).map(r => {
      const tc = tipoColor[r.tipo] || 'var(--muted)';
      return `<div class="mobile-card">
        <div class="mc-header">
          <div class="mc-avatar" style="background:${tc}22;color:${tc};">${tipoEmoji[r.tipo]||'âš™'}</div>
          <div class="mc-name">${r.maquina_nombre||'â€”'}<div class="mc-sub">${r.fecha||'â€”'}</div></div>
          <span style="color:${tc};font-weight:700;font-size:12px;">${r.tipo}</span>
        </div>
        <div class="mc-body">
          <div><div class="mc-label">Horas</div><div class="mc-val">${r.horas||0}h</div></div>
          <div><div class="mc-label">Combustible</div><div class="mc-val">${r.combustible||0} L</div></div>
          <div><div class="mc-label">Operador</div><div class="mc-val">${r.operador||'â€”'}</div></div>
        </div>
      </div>`;
    }).join('');
  }
}

function openUsoMaquinaModal(maquinaId) {
  document.getElementById('uso-edit-id').value = '';
  document.getElementById('uso-fecha').value = new Date().toISOString().slice(0,10);
  document.getElementById('uso-tipo').value = 'uso';
  document.getElementById('uso-horas').value = 0;
  document.getElementById('uso-combustible').value = 0;
  document.getElementById('uso-costo-comb').value = 0;
  document.getElementById('uso-operador').value = '';
  document.getElementById('uso-obs').value = '';
  // Populate maquinas
  const sel = document.getElementById('uso-maquina-sel');
  sel.innerHTML = db.maquinaria.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
  if (maquinaId) sel.value = maquinaId;
  // Populate proyectos
  const psel = document.getElementById('uso-proyecto');
  psel.innerHTML = '<option value="">â€” Sin proyecto â€”</option>' + db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
  document.getElementById('modal-uso-maquina').classList.add('open');
}

async function saveUsoMaquina() {
  const id = document.getElementById('uso-edit-id').value;
  const maquinaId = document.getElementById('uso-maquina-sel').value;
  const maquina = db.maquinaria.find(m => m.id === maquinaId);
  const fecha = document.getElementById('uso-fecha').value;
  const tipo = document.getElementById('uso-tipo').value;
  const proyId = document.getElementById('uso-proyecto').value || null;
  const horas = parseFloat(document.getElementById('uso-horas').value) || 0;
  const combustible = parseFloat(document.getElementById('uso-combustible').value) || 0;
  const costoComb = parseFloat(document.getElementById('uso-costo-comb').value) || 0;
  const operador = document.getElementById('uso-operador').value.trim();
  const obs = document.getElementById('uso-obs').value.trim();

  if (!maquinaId || !fecha) { toast('Campos requeridos', 'SeleccionÃ¡ equipo y fecha', 'warn'); return; }

  const payload = {
    maquina_id: maquinaId, maquina_nombre: maquina?.nombre || '?',
    fecha, tipo, proyecto_id: proyId,
    horas, combustible, costo_combustible: costoComb,
    operador, observacion: obs
  };

  showLoading(true);
  try {
    const res = await sbFetch('maquinaria_historial', { method:'POST', body: payload });
    const newId = (Array.isArray(res)?res[0]:res)?.id || ('local_'+Date.now());
    dbMaqHistorial.unshift({ id: newId, ...payload, obs });
    toast('âœ… Registro guardado', `${maquina?.nombre} â€” ${tipo}`);
  } catch(e) {
    const newId = 'local_'+Date.now();
    dbMaqHistorial.unshift({ id: newId, ...payload, obs });
    addToOfflineQueue('maquinaria_historial','POST',payload,null);
    toast('Guardado local', 'Se sincronizarÃ¡ al conectar', 'warn');
  }
  localStorage.setItem(MAQ_HIST_KEY, JSON.stringify(dbMaqHistorial));
  showLoading(false);
  closeModal('uso-maquina');
  renderHistorialMaq();
}

async function deleteUsoMaquina(id) {
  if (!confirm('Â¿Eliminar este registro?')) return;
  if (!id.startsWith('local_')) {
    try { await sbFetch('maquinaria_historial?id=eq.' + id, { method:'DELETE', prefer:'return=minimal' }); }
    catch(e) {}
  }
  dbMaqHistorial = dbMaqHistorial.filter(r => r.id !== id);
  localStorage.setItem(MAQ_HIST_KEY, JSON.stringify(dbMaqHistorial));
  renderHistorialMaq();
  toast('Registro eliminado','','err');
}

function exportHistorialMaqExcel() {
  const rows = [['Fecha','Equipo','Proyecto','Horas','Combustible (L)','Costo Comb. S/','Operador','Tipo','ObservaciÃ³n']];
  dbMaqHistorial.forEach(r => {
    const proy = db.proyectos.find(p=>p.id===r.proyecto_id);
    rows.push([r.fecha,r.maquina_nombre,proy?.nombre||'',r.horas||0,r.combustible||0,r.costo_combustible||0,r.operador||'',r.tipo||'',r.obs||'']);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Historial');
  XLSX.writeFile(wb,'historial_maquinaria_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('ğŸ“¥ Historial exportado');
}

// Override openModal to handle new modals
const _origOpenModal = window.openModal || openModal;
window.openModal = function(name, id) {
  if (name === 'importar') {
    document.getElementById('modal-importar').classList.add('open');
    updateImportTemplate();
    return;
  }
  if (name === 'uso-maquina') {
    openUsoMaquinaModal(id);
    return;
  }
  _origOpenModal(name, id);
};

// =====================================================================
// ==================== REPORTES PDF MEJORADO =========================
// =====================================================================
// Override generarReportePDF with enhanced version using autotable
const _origGenerarPDF = window.generarReportePDF;
window.generarReportePDF = async function() {
  if (!window.jspdf) { toast('Cargando jsPDF...','','warn'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const W = 210, PRIMARY = [245,166,35], DARK = [13,15,18], LIGHT = [241,245,249], MUTED = [100,116,139];
  const hoy = new Date();
  const fechaStr = hoy.toLocaleDateString('es-PE', { year:'numeric', month:'long', day:'numeric' });

  // Cover / Header
  doc.setFillColor(...DARK); doc.rect(0,0,W,40,'F');
  doc.setFontSize(24); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('BUILDCORE', 20, 20);
  doc.setFontSize(11); doc.setTextColor(...LIGHT); doc.setFont('helvetica','normal');
  doc.text('Reporte Ejecutivo de Proyectos', 20, 29);
  doc.setFontSize(9); doc.setTextColor(...MUTED);
  doc.text(fechaStr, W-20, 29, {align:'right'});
  doc.setDrawColor(...PRIMARY); doc.setLineWidth(0.8); doc.line(0,40,W,40);

  let y = 50;

  // KPI boxes
  const totalCartera = db.proyectos.reduce((a,p)=>a+parseFloat(p.presupuesto||0),0);
  const avgAvance = db.proyectos.length ? Math.round(db.proyectos.reduce((a,p)=>a+parseFloat(p.avance||0),0)/db.proyectos.length) : 0;
  const movs = window.dbMovimientos || [];
  const totalIng = movs.filter(m=>m.tipo==='ingreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  const totalEgr = movs.filter(m=>m.tipo==='egreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  const saldo = totalIng - totalEgr;

  const kpis = [
    { label:'Cartera Total', val:'S/ '+totalCartera.toLocaleString('es-PE'), color:[245,166,35] },
    { label:'Avance Promedio', val:avgAvance+'%', color:[59,130,246] },
    { label:'Ingresos', val:'S/ '+totalIng.toLocaleString('es-PE'), color:[34,197,94] },
    { label:'Saldo Neto', val:'S/ '+saldo.toLocaleString('es-PE'), color: saldo>=0?[34,197,94]:[239,68,68] },
  ];
  const kw = 42, kh = 22, kgap = 4, kstart = 20;
  kpis.forEach((k,i) => {
    const kx = kstart + i*(kw+kgap);
    doc.setFillColor(k.color[0],k.color[1],k.color[2],0.1);
    doc.roundedRect(kx,y,kw,kh,3,3,'F');
    doc.setDrawColor(k.color[0],k.color[1],k.color[2],0.3); doc.setLineWidth(0.3);
    doc.roundedRect(kx,y,kw,kh,3,3,'S');
    doc.setFontSize(7); doc.setTextColor(...MUTED); doc.setFont('helvetica','normal');
    doc.text(k.label, kx+kw/2, y+7, {align:'center'});
    doc.setFontSize(10); doc.setTextColor(k.color[0],k.color[1],k.color[2]); doc.setFont('helvetica','bold');
    doc.text(k.val, kx+kw/2, y+16, {align:'center'});
  });
  y += kh + 12;

  // Section: Proyectos
  doc.setFontSize(12); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('PROYECTOS', 20, y); y += 2;
  doc.setDrawColor(...PRIMARY); doc.setLineWidth(0.4); doc.line(20,y,W-20,y); y += 6;

  if (doc.autoTable) {
    doc.autoTable({
      startY: y,
      head: [['Proyecto','Cliente','Presupuesto','Avance','Estado']],
      body: db.proyectos.map(p => [
        p.nombre||'', p.cliente||'', 'S/ '+(parseFloat(p.presupuesto||0)/1000).toFixed(0)+'K',
        (p.avance||0)+'%', p.estado||''
      ]),
      theme: 'grid',
      headStyles: { fillColor: [30,35,45], textColor: [245,166,35], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor: [20,25,32], textColor: [200,210,220], fontSize:8 },
      alternateRowStyles: { fillColor: [25,30,38] },
      margin: { left:20, right:20 },
      styles: { lineColor:[40,50,60], lineWidth:0.2 }
    });
    y = doc.lastAutoTable.finalY + 10;
  } else {
    db.proyectos.forEach(p => {
      doc.setTextColor(...LIGHT); doc.setFontSize(9); doc.setFont('helvetica','normal');
      doc.text(`${p.nombre||''} | ${p.cliente||''} | S/ ${(parseFloat(p.presupuesto||0)/1000).toFixed(0)}K | ${p.avance||0}% | ${p.estado||''}`, 20, y);
      y += 7; if(y>270){doc.addPage();y=20;}
    });
    y += 5;
  }

  // Section: Personal
  if (y > 230) { doc.addPage(); y = 20; }
  doc.setFontSize(12); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('PERSONAL', 20, y); y += 2;
  doc.setDrawColor(...PRIMARY); doc.line(20,y,W-20,y); y += 6;

  if (doc.autoTable) {
    doc.autoTable({
      startY: y,
      head: [['Nombre','Rol','Cuadrilla','Tipo','Sueldo S/']],
      body: db.personal.map(p => [p.nombre||'', p.rol||'', p.cuadrilla||'', p.tipo||'', p.sueldo||0]),
      theme: 'grid',
      headStyles: { fillColor:[30,35,45], textColor:[59,130,246], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor:[20,25,32], textColor:[200,210,220], fontSize:8 },
      alternateRowStyles: { fillColor:[25,30,38] },
      margin:{left:20,right:20},
      styles:{lineColor:[40,50,60],lineWidth:0.2}
    });
    y = doc.lastAutoTable.finalY + 10;
  }

  // Section: Flujo de Caja
  if (y > 230) { doc.addPage(); y = 20; }
  doc.setFontSize(12); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('FLUJO DE CAJA', 20, y); y += 2;
  doc.setDrawColor(...PRIMARY); doc.line(20,y,W-20,y); y += 6;

  if (doc.autoTable && movs.length > 0) {
    doc.autoTable({
      startY: y,
      head: [['Fecha','Concepto','CategorÃ­a','Tipo','Monto S/']],
      body: movs.slice(0,30).map(m => [m.fecha||'', m.concepto||'', m.categoria||'', m.tipo||'', parseFloat(m.monto||0).toFixed(2)]),
      theme: 'grid',
      headStyles: { fillColor:[30,35,45], textColor:[34,197,94], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor:[20,25,32], textColor:[200,210,220], fontSize:8 },
      alternateRowStyles: { fillColor:[25,30,38] },
      margin:{left:20,right:20},
      styles:{lineColor:[40,50,60],lineWidth:0.2}
    });
  } else if (!movs.length) {
    doc.setFontSize(9); doc.setTextColor(...MUTED); doc.text('Sin movimientos registrados.', 20, y+6);
  }

  // Footer on all pages
  const pageCount = doc.internal.getNumberOfPages();
  for (let i=1;i<=pageCount;i++) {
    doc.setPage(i);
    doc.setFillColor(...DARK); doc.rect(0,285,W,12,'F');
    doc.setFontSize(7); doc.setTextColor(...MUTED);
    doc.text('BuildCore â€” Sistema de GestiÃ³n Constructora', 20, 292);
    doc.text(`PÃ¡gina ${i} de ${pageCount}`, W-20, 292, {align:'right'});
  }

  doc.save('reporte_buildcore_'+hoy.toISOString().slice(0,10)+'.pdf');
  toast('ğŸ“„ PDF generado', 'Reporte completo con tablas descargado');
};

// =====================================================================
// ==================== INIT HOOKS ====================================
// =====================================================================
// Init notifications after login
const _origLoadAllNewModules = window.loadAllData || loadAllData;
window.loadAllData = async function() {
  await _origLoadAllNewModules();
  await Promise.allSettled([loadMaqHistorialSB()]);
  setTimeout(() => {
    renderHistorialMaq();
    updateOnlineStatus();
    initNotifications();
    // Update topbar alert badge
    if (typeof generarAlertas === 'function') {
      const al = generarAlertas();
      const cnt = al.filter(a=>a.tipo!=='info').length;
      const badge = document.getElementById('topbar-alert-badge');
      if (badge && cnt > 0) { badge.textContent = cnt > 9 ? '9+' : cnt; badge.style.display = 'flex'; }
    }
  }, 500);
};

// Also patch nav for maquinaria to show historial
const _origNavMaq = window.nav;
window.nav = function(page, el) {
  if (_origNavMaq) _origNavMaq(page, el);
  if (page === 'maquinaria') setTimeout(renderHistorialMaq, 100);
};

// Patch openModal for uso-maquina button in machine card
document.addEventListener('click', e => {
  const btn = e.target.closest('[data-uso-maquina]');
  if (btn) openUsoMaquinaModal(btn.dataset.usoMaquina);
});


// =====================================================================
// ==================== PLANILLA DE SUELDOS ============================
// =====================================================================
const PLANILLA_KEY = 'bc_planilla_v1';
let dbPlanilla = JSON.parse(localStorage.getItem(PLANILLA_KEY) || '{}');
let _planillaData = []; // calculated rows for current month

function initPlanilla() {
  // Populate months selector (last 12 months)
  const sel = document.getElementById('planilla-mes');
  if (!sel) return;
  const opts = [];
  for (let i = 0; i < 12; i++) {
    const d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - i);
    const val = d.toISOString().slice(0,7);
    const lbl = d.toLocaleDateString('es-PE', { year:'numeric', month:'long' });
    opts.push(`<option value="${val}">${lbl}</option>`);
  }
  sel.innerHTML = opts.join('');
  calcularPlanilla();
}

function togglePlanillaConfig() {
  const el = document.getElementById('planilla-config');
  el.style.display = el.style.display === 'none' ? '' : 'none';
}

function calcularPlanilla() {
  const mes = document.getElementById('planilla-mes')?.value;
  if (!mes || !db.personal.length) {
    document.getElementById('planilla-table').innerHTML = '<tr><td colspan="14" style="text-align:center;color:var(--muted);padding:28px;">Sin personal registrado.</td></tr>';
    return;
  }

  // Config
  const pctONP   = parseFloat(document.getElementById('cfg-onp')?.value || 13) / 100;
  const pctEsSal = parseFloat(document.getElementById('cfg-essalud')?.value || 9) / 100;
  const pctCTS   = parseFloat(document.getElementById('cfg-cts')?.value || 8.33) / 100;
  const pctGrat  = parseFloat(document.getElementById('cfg-grat')?.value || 16.67) / 100;

  // Get asistencia data for this month
  const diasMes = Object.keys(_asistenciaData || {}).filter(d => d.startsWith(mes));
  const asistMap = {}; // personalId -> { dias, hExtras }
  diasMes.forEach(dia => {
    (_asistenciaData[dia] || []).forEach(r => {
      if (!asistMap[r.personalId]) asistMap[r.personalId] = { dias: 0, hExtras: 0 };
      if (r.estado === 'presente' || r.estado === 'tardanza') asistMap[r.personalId].dias++;
      asistMap[r.personalId].hExtras += parseFloat(r.horasExtras) || 0;
    });
  });

  const diasLaborables = 26; // standard working days/month in Peru

  _planillaData = db.personal.map(p => {
    const sueldo = parseFloat(p.sueldo) || 0;
    const horasSemana = parseFloat(p.horas) || 48;
    const valorHora = sueldo / (horasSemana * 4.33);
    const asist = asistMap[p.id] || { dias: diasLaborables, hExtras: 0 };
    const diasTrab = asist.dias || diasLaborables;
    const hExtras = asist.hExtras || 0;

    // Proportional salary based on attendance
    const sueldoProporcional = (sueldo / diasLaborables) * diasTrab;
    const montoHExtras = hExtras * valorHora * 1.25; // 25% surcharge
    const asignFamiliar = 0; // optional
    const bruto = sueldoProporcional + montoHExtras + asignFamiliar;

    // Deductions (employee)
    const descONP  = bruto * pctONP;
    // Employer contributions (not deducted from employee)
    const aportEsSalud = bruto * pctEsSal;
    const aportCTS     = bruto * pctCTS;
    const aportGrat    = bruto * pctGrat;

    const neto = bruto - descONP;

    return {
      id: p.id, nombre: p.nombre, rol: p.rol || p.cargo || '',
      cuadrilla: p.cuadrilla || '', tipo: p.tipo || 'Fijo',
      sueldo, diasTrab, hExtras, valorHora,
      sueldoProporcional, montoHExtras, asignFamiliar,
      bruto, descONP, aportEsSalud, aportCTS, aportGrat, neto,
      mes
    };
  });

  // Totals
  const totBruto  = _planillaData.reduce((a,r) => a + r.bruto, 0);
  const totDesc   = _planillaData.reduce((a,r) => a + r.descONP, 0);
  const totNeto   = _planillaData.reduce((a,r) => a + r.neto, 0);
  const totAport  = _planillaData.reduce((a,r) => a + r.aportEsSalud + r.aportCTS + r.aportGrat, 0);

  const fmt = v => 'S/ ' + parseFloat(v||0).toLocaleString('es-PE', {minimumFractionDigits:2,maximumFractionDigits:2});

  document.getElementById('plan-total-bruto').textContent  = fmt(totBruto);
  document.getElementById('plan-total-desc').textContent   = fmt(totDesc);
  document.getElementById('plan-total-neto').textContent   = fmt(totNeto);
  document.getElementById('plan-total-aportes').textContent = fmt(totAport);
  document.getElementById('plan-total-personal').textContent = _planillaData.length;
  document.getElementById('badge-planilla').textContent = _planillaData.length;

  const mesLabel = new Date(mes + '-02').toLocaleDateString('es-PE', { year:'numeric', month:'long' });
  document.getElementById('planilla-sub').textContent = `Planilla ${mesLabel} â€” ${_planillaData.length} empleados`;
  document.getElementById('planilla-periodo-label').textContent = mesLabel;

  // Table
  document.getElementById('planilla-table').innerHTML = _planillaData.map(r => `
    <tr>
      <td><strong>${r.nombre}</strong><br><small style="color:var(--muted2);">${r.cuadrilla}</small></td>
      <td style="font-size:12px;">${r.rol}</td>
      <td style="text-align:center;">${r.diasTrab}/${diasLaborables}</td>
      <td style="text-align:center;">${r.hExtras.toFixed(1)}h</td>
      <td>${fmt(r.sueldo)}</td>
      <td style="color:var(--green);">${r.montoHExtras > 0 ? '+'+fmt(r.montoHExtras) : 'â€”'}</td>
      <td>${r.asignFamiliar > 0 ? fmt(r.asignFamiliar) : 'â€”'}</td>
      <td style="font-weight:700;color:var(--green);">${fmt(r.bruto)}</td>
      <td style="color:var(--red);">-${fmt(r.descONP)}</td>
      <td style="color:var(--accent);">${fmt(r.aportEsSalud)}</td>
      <td style="color:var(--blue);">${fmt(r.aportCTS)}</td>
      <td style="color:var(--purple);">${fmt(r.aportGrat)}</td>
      <td style="font-weight:800;color:var(--green);font-size:14px;">${fmt(r.neto)}</td>
      <td>
        <button class="btn btn-ghost btn-sm" onclick="verRecibo('${r.id}')" title="Ver recibo">ğŸ§¾</button>
        <button class="btn btn-primary btn-sm" onclick="generarReciboPDF('${r.id}')" title="PDF recibo">ğŸ“„</button>
      </td>
    </tr>`).join('');

  // Mobile
  document.getElementById('planilla-mobile').innerHTML = _planillaData.map(r => `
    <div class="mobile-card">
      <div class="mc-header">
        <div class="mc-avatar">${(r.nombre||'?')[0]}</div>
        <div class="mc-name">${r.nombre}<div class="mc-sub">${r.rol} Â· ${r.diasTrab} dÃ­as</div></div>
        <div style="font-weight:800;color:var(--green);font-size:15px;">${fmt(r.neto)}</div>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Bruto</div><div class="mc-val" style="color:var(--green);">${fmt(r.bruto)}</div></div>
        <div><div class="mc-label">ONP/AFP</div><div class="mc-val" style="color:var(--red);">-${fmt(r.descONP)}</div></div>
        <div><div class="mc-label">H.Extra</div><div class="mc-val">${r.hExtras.toFixed(1)}h</div></div>
        <div><div class="mc-label">EsSalud</div><div class="mc-val" style="color:var(--accent);">${fmt(r.aportEsSalud)}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="verRecibo('${r.id}')">ğŸ§¾ Ver recibo</button>
        <button class="btn btn-primary btn-sm" onclick="generarReciboPDF('${r.id}')">ğŸ“„ PDF</button>
      </div>
    </div>`).join('');

  // Save to localStorage
  dbPlanilla[mes] = _planillaData;
  localStorage.setItem(PLANILLA_KEY, JSON.stringify(dbPlanilla));
}

function verRecibo(personalId) {
  const r = _planillaData.find(x => x.id === personalId);
  if (!r) return;
  const fmt2 = v => parseFloat(v||0).toLocaleString('es-PE', {minimumFractionDigits:2,maximumFractionDigits:2});
  const mesLabel = new Date(r.mes + '-02').toLocaleDateString('es-PE', { year:'numeric', month:'long' });
  const empresa = 'BuildCore Constructora S.A.C.';
  document.getElementById('recibo-preview').innerHTML = `
    <div style="border:2px solid #1e293b;border-radius:8px;padding:20px;background:#fff;">
      <div style="text-align:center;border-bottom:2px solid #f5a623;padding-bottom:12px;margin-bottom:16px;">
        <div style="font-size:18px;font-weight:800;color:#0d0f12;">ğŸ—ï¸ ${empresa}</div>
        <div style="font-size:13px;color:#64748b;margin-top:4px;">BOLETA DE PAGO â€” ${mesLabel.toUpperCase()}</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;font-size:12px;">
        <div><strong>Trabajador:</strong> ${r.nombre}</div>
        <div><strong>Cargo:</strong> ${r.rol}</div>
        <div><strong>Tipo Contrato:</strong> ${r.tipo}</div>
        <div><strong>DÃ­as trabajados:</strong> ${r.diasTrab} dÃ­as</div>
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:16px;">
        <thead><tr style="background:#f5a62320;"><th style="padding:6px 8px;text-align:left;border:1px solid #e2e8f0;">Concepto</th><th style="padding:6px 8px;text-align:right;border:1px solid #e2e8f0;">Importe S/</th></tr></thead>
        <tbody>
          <tr><td style="padding:5px 8px;border:1px solid #e2e8f0;">RemuneraciÃ³n BÃ¡sica</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;">${fmt2(r.sueldoProporcional)}</td></tr>
          ${r.montoHExtras > 0 ? `<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;">Horas Extras (${r.hExtras.toFixed(1)}h Ã— 125%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;">${fmt2(r.montoHExtras)}</td></tr>` : ''}
          <tr style="background:#f0fdf4;font-weight:700;"><td style="padding:5px 8px;border:1px solid #e2e8f0;">TOTAL INGRESOS</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#16a34a;">${fmt2(r.bruto)}</td></tr>
          <tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#ef4444;">(-) ONP / AFP (${(r.descONP/r.bruto*100).toFixed(1)}%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#ef4444;">-${fmt2(r.descONP)}</td></tr>
          <tr style="background:#fef9c3;font-weight:800;font-size:13px;"><td style="padding:6px 8px;border:1px solid #e2e8f0;">NETO A PAGAR</td><td style="padding:6px 8px;text-align:right;border:1px solid #e2e8f0;color:#16a34a;">S/ ${fmt2(r.neto)}</td></tr>
        </tbody>
      </table>
      <div style="background:#f8fafc;border-radius:6px;padding:10px;font-size:11px;color:#64748b;">
        <strong>Aportes del Empleador (referencial):</strong><br>
        EsSalud: S/ ${fmt2(r.aportEsSalud)} Â· CTS (prov.): S/ ${fmt2(r.aportCTS)} Â· GratificaciÃ³n (prov.): S/ ${fmt2(r.aportGrat)}
      </div>
      <div style="margin-top:16px;display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid #e2e8f0;font-size:11px;color:#94a3b8;">
        <div>Firma Empleador: _______________________</div>
        <div>Firma Trabajador: _______________________</div>
      </div>
    </div>`;
  document.getElementById('modal-recibo').classList.add('open');
  window._currentRecibo = r;
}

function imprimirRecibo() {
  const content = document.getElementById('recibo-preview').innerHTML;
  const win = window.open('', '_blank', 'width=600,height=700');
  win.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Recibo de Sueldo</title><style>body{font-family:Arial,sans-serif;margin:20px;}</style></head><body>${content}<script>window.onload=()=>window.print()<\/script></body></html>`);
  win.document.close();
}

function generarReciboPDF(personalId) {
  verRecibo(personalId);
  setTimeout(imprimirRecibo, 300);
}

function exportPlanillaExcel() {
  if (!_planillaData.length) { toast('Sin datos', 'CalculÃ¡ la planilla primero', 'warn'); return; }
  const fmt2 = v => parseFloat(v||0).toFixed(2);
  const mes = document.getElementById('planilla-mes').value;
  const rows = [
    ['PLANILLA DE SUELDOS â€” ' + mes],
    [],
    ['Empleado','Rol','Cuadrilla','Tipo','Sueldo Base','DÃ­as Trab.','H.Extras','Monto H.Extra','Bruto','ONP/AFP','EsSalud Emp.','CTS Prov.','Grat.Prov.','NETO']
  ];
  _planillaData.forEach(r => rows.push([
    r.nombre, r.rol, r.cuadrilla, r.tipo,
    fmt2(r.sueldo), r.diasTrab, r.hExtras.toFixed(1), fmt2(r.montoHExtras),
    fmt2(r.bruto), fmt2(r.descONP), fmt2(r.aportEsSalud), fmt2(r.aportCTS), fmt2(r.aportGrat), fmt2(r.neto)
  ]));
  // Totals row
  rows.push(['','','','','TOTALES','','','',
    _planillaData.reduce((a,r)=>a+r.bruto,0).toFixed(2),
    _planillaData.reduce((a,r)=>a+r.descONP,0).toFixed(2),
    _planillaData.reduce((a,r)=>a+r.aportEsSalud,0).toFixed(2),
    _planillaData.reduce((a,r)=>a+r.aportCTS,0).toFixed(2),
    _planillaData.reduce((a,r)=>a+r.aportGrat,0).toFixed(2),
    _planillaData.reduce((a,r)=>a+r.neto,0).toFixed(2)
  ]);
  const ws = XLSX.utils.aoa_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Planilla');
  XLSX.writeFile(wb, 'planilla_' + mes + '.xlsx');
  toast('ğŸ“¥ Planilla exportada', mes);
}

function generarPlanillaPDF() {
  if (!_planillaData.length) { toast('Sin datos', 'CalculÃ¡ la planilla primero', 'warn'); return; }
  if (!window.jspdf) { toast('jsPDF no disponible','','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
  const mes = document.getElementById('planilla-mes').value;
  const mesLabel = new Date(mes+'-02').toLocaleDateString('es-PE',{year:'numeric',month:'long'});
  const W = 297;
  const fmt2 = v => parseFloat(v||0).toFixed(2);

  doc.setFillColor(13,15,18); doc.rect(0,0,W,30,'F');
  doc.setFontSize(18); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text('BUILDCORE â€” PLANILLA DE SUELDOS', W/2, 14, {align:'center'});
  doc.setFontSize(10); doc.setTextColor(200,210,220); doc.setFont('helvetica','normal');
  doc.text(mesLabel.toUpperCase() + ' Â· ' + _planillaData.length + ' empleados', W/2, 23, {align:'center'});

  if (doc.autoTable) {
    doc.autoTable({
      startY: 35,
      head: [['Empleado','Rol','DÃ­as','H.Extra','Bruto S/','ONP/AFP','EsSalud','CTS','Grat.','NETO S/']],
      body: _planillaData.map(r => [
        r.nombre, r.rol, r.diasTrab, r.hExtras.toFixed(1),
        fmt2(r.bruto), fmt2(r.descONP), fmt2(r.aportEsSalud), fmt2(r.aportCTS), fmt2(r.aportGrat), fmt2(r.neto)
      ]),
      foot: [['TOTALES','','','',
        _planillaData.reduce((a,r)=>a+r.bruto,0).toFixed(2),
        _planillaData.reduce((a,r)=>a+r.descONP,0).toFixed(2),
        _planillaData.reduce((a,r)=>a+r.aportEsSalud,0).toFixed(2),
        _planillaData.reduce((a,r)=>a+r.aportCTS,0).toFixed(2),
        _planillaData.reduce((a,r)=>a+r.aportGrat,0).toFixed(2),
        _planillaData.reduce((a,r)=>a+r.neto,0).toFixed(2)
      ]],
      theme: 'grid',
      headStyles: { fillColor:[30,35,45], textColor:[245,166,35], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor:[20,25,32], textColor:[200,210,220], fontSize:8 },
      footStyles: { fillColor:[40,50,30], textColor:[34,197,94], fontStyle:'bold', fontSize:8 },
      alternateRowStyles: { fillColor:[25,30,38] },
      columnStyles: { 4:{halign:'right'}, 5:{halign:'right'}, 6:{halign:'right'}, 7:{halign:'right'}, 8:{halign:'right'}, 9:{halign:'right',fontStyle:'bold',textColor:[34,197,94]} },
      margin: { left:10, right:10 },
      styles: { lineColor:[40,50,60], lineWidth:0.2 }
    });
  }

  // Footer
  doc.setFontSize(7); doc.setTextColor(100,116,139);
  doc.text('BuildCore â€” Documento generado el ' + new Date().toLocaleDateString('es-PE'), W/2, 200, {align:'center'});

  doc.save('planilla_' + mes + '.pdf');
  toast('ğŸ“„ Planilla PDF generada', mesLabel);
}

// =====================================================================
// ==================== CONTRATOS & ACTAS ==============================
// =====================================================================
let _contratosHistorial = JSON.parse(localStorage.getItem('bc_contratos_v1') || '[]');

const CONTRATOS_CONFIG = {
  obra: {
    title: 'Contrato de Obra',
    fields: [
      { id:'c-cliente', label:'Nombre del Cliente *', type:'text', placeholder:'Empresa o persona natural' },
      { id:'c-cliente-dni', label:'DNI/RUC Cliente *', type:'text', placeholder:'20123456789' },
      { id:'c-proyecto', label:'Proyecto', type:'select-proyecto' },
      { id:'c-descripcion', label:'DescripciÃ³n de la obra *', type:'textarea', placeholder:'DescripciÃ³n detallada de los trabajos...' },
      { id:'c-monto', label:'Monto total S/ *', type:'number', placeholder:'0.00' },
      { id:'c-anticipo', label:'Anticipo S/ (opcional)', type:'number', placeholder:'0.00' },
      { id:'c-plazo', label:'Plazo de ejecuciÃ³n (dÃ­as) *', type:'number', placeholder:'90' },
      { id:'c-fecha-inicio', label:'Fecha de inicio *', type:'date' },
      { id:'c-penalidad', label:'Penalidad por dÃ­a de retraso (%)', type:'number', placeholder:'0.5' },
      { id:'c-garantia', label:'GarantÃ­a de obra (meses)', type:'number', placeholder:'12' },
    ]
  },
  personal: {
    title: 'Contrato de Personal',
    fields: [
      { id:'c-empleado', label:'Empleado', type:'select-personal' },
      { id:'c-cargo', label:'Cargo *', type:'text', placeholder:'AlbaÃ±il, Supervisor, etc.' },
      { id:'c-sueldo', label:'RemuneraciÃ³n mensual S/ *', type:'number', placeholder:'0.00' },
      { id:'c-fecha-inicio', label:'Fecha de inicio *', type:'date' },
      { id:'c-fecha-fin', label:'Fecha de fin (si aplica)', type:'date' },
      { id:'c-tipo', label:'Tipo de contrato', type:'select', options:['A plazo indeterminado','A plazo fijo','Por obra o servicio','Eventual'] },
      { id:'c-horario', label:'Horario de trabajo', type:'text', placeholder:'Lun-Sab 7:00am-5:00pm' },
      { id:'c-proyecto', label:'Proyecto asignado', type:'select-proyecto' },
    ]
  },
  entrega: {
    title: 'Acta de Entrega de Obra',
    fields: [
      { id:'c-cliente', label:'Nombre del Cliente *', type:'text', placeholder:'Nombre completo' },
      { id:'c-proyecto', label:'Proyecto *', type:'select-proyecto' },
      { id:'c-descripcion', label:'DescripciÃ³n de trabajos entregados *', type:'textarea', placeholder:'DescripciÃ³n de los trabajos realizados...' },
      { id:'c-monto', label:'Monto total del contrato S/', type:'number', placeholder:'0.00' },
      { id:'c-observaciones', label:'Observaciones / Pendientes', type:'textarea', placeholder:'Detallar si hay pendientes...' },
      { id:'c-fecha-inicio', label:'Fecha de entrega *', type:'date' },
      { id:'c-garantia', label:'PerÃ­odo de garantÃ­a (meses)', type:'number', placeholder:'12' },
    ]
  },
  subcontrato: {
    title: 'Subcontrato',
    fields: [
      { id:'c-cliente', label:'RazÃ³n social subcontratista *', type:'text', placeholder:'Empresa o persona' },
      { id:'c-cliente-dni', label:'RUC subcontratista *', type:'text', placeholder:'20123456789' },
      { id:'c-descripcion', label:'Trabajos a subcontratar *', type:'textarea', placeholder:'DescripciÃ³n detallada...' },
      { id:'c-proyecto', label:'Proyecto', type:'select-proyecto' },
      { id:'c-monto', label:'Monto S/ *', type:'number', placeholder:'0.00' },
      { id:'c-plazo', label:'Plazo (dÃ­as) *', type:'number', placeholder:'30' },
      { id:'c-fecha-inicio', label:'Fecha inicio *', type:'date' },
    ]
  },
  adicional: {
    title: 'Acta de Adicional de Obra',
    fields: [
      { id:'c-cliente', label:'Cliente *', type:'text', placeholder:'Nombre del cliente' },
      { id:'c-proyecto', label:'Proyecto *', type:'select-proyecto' },
      { id:'c-descripcion', label:'DescripciÃ³n de trabajos adicionales *', type:'textarea', placeholder:'Detallar los trabajos adicionales...' },
      { id:'c-monto', label:'Monto adicional S/ *', type:'number', placeholder:'0.00' },
      { id:'c-plazo', label:'DÃ­as adicionales al plazo', type:'number', placeholder:'0' },
      { id:'c-fecha-inicio', label:'Fecha *', type:'date' },
    ]
  },
  finiquito: {
    title: 'Finiquito Laboral',
    fields: [
      { id:'c-empleado', label:'Empleado *', type:'select-personal' },
      { id:'c-cargo', label:'Cargo', type:'text', placeholder:'Cargo desempeÃ±ado' },
      { id:'c-fecha-inicio', label:'Fecha de ingreso *', type:'date' },
      { id:'c-fecha-fin', label:'Fecha de cese *', type:'date' },
      { id:'c-motivo', label:'Motivo del cese', type:'select', options:['Renuncia voluntaria','Vencimiento de contrato','Mutuo acuerdo','Despido justificado','Fallecimiento'] },
      { id:'c-sueldo', label:'Ãšltima remuneraciÃ³n S/ *', type:'number', placeholder:'0.00' },
      { id:'c-cts-acumulada', label:'CTS acumulada S/', type:'number', placeholder:'0.00' },
      { id:'c-vacaciones', label:'Vacaciones pendientes (dÃ­as)', type:'number', placeholder:'0' },
    ]
  }
};

function abrirGeneradorContrato(tipo) {
  document.getElementById('contrato-tipo').value = tipo;
  const cfg = CONTRATOS_CONFIG[tipo];
  document.getElementById('contrato-modal-title').textContent = cfg.title;

  // Build form fields
  let html = '<div style="display:flex;flex-direction:column;gap:14px;">';
  cfg.fields.forEach(f => {
    html += '<div class="form-group"><label class="form-label">' + f.label + '</label>';
    if (f.type === 'text' || f.type === 'number' || f.type === 'date') {
      html += `<input type="${f.type}" class="form-input" id="${f.id}" placeholder="${f.placeholder||''}" ${f.type==='date'?'value="'+new Date().toISOString().slice(0,10)+'"':''}>`;
    } else if (f.type === 'textarea') {
      html += `<textarea class="form-input" id="${f.id}" rows="3" placeholder="${f.placeholder||''}" style="resize:vertical;"></textarea>`;
    } else if (f.type === 'select') {
      html += `<select class="form-input" id="${f.id}">${f.options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    } else if (f.type === 'select-proyecto') {
      html += `<select class="form-input" id="${f.id}"><option value="">â€” Sin proyecto â€”</option>${db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('')}</select>`;
    } else if (f.type === 'select-personal') {
      html += `<select class="form-input" id="${f.id}" onchange="autoFillPersonal('${f.id}')"><option value="">â€” SeleccionÃ¡ â€”</option>${db.personal.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('')}</select>`;
    }
    html += '</div>';
  });
  html += '</div>';
  document.getElementById('contrato-form-fields').innerHTML = html;
  document.getElementById('modal-nuevo-contrato').classList.add('open');
}

function autoFillPersonal(selId) {
  const id = document.getElementById(selId).value;
  const p = db.personal.find(x => x.id === id);
  if (!p) return;
  const cargoEl = document.getElementById('c-cargo');
  const sueldoEl = document.getElementById('c-sueldo');
  const tipoEl = document.getElementById('c-tipo');
  const proyEl = document.getElementById('c-proyecto');
  const fIniEl = document.getElementById('c-fecha-inicio');
  const fFinEl = document.getElementById('c-fecha-fin');
  if (cargoEl) cargoEl.value = p.rol || p.cargo || '';
  if (sueldoEl) sueldoEl.value = p.sueldo || '';
  if (tipoEl && p.tipo) tipoEl.value = p.tipo;
  if (proyEl && p.proyecto) proyEl.value = p.proyecto;
  if (fIniEl && p.fechaInicio) fIniEl.value = p.fechaInicio;
  if (fFinEl && p.fechaFin) fFinEl.value = p.fechaFin;
}

function getContratoData(tipo) {
  const cfg = CONTRATOS_CONFIG[tipo];
  const data = { tipo };
  cfg.fields.forEach(f => {
    const el = document.getElementById(f.id);
    if (el) data[f.id.replace('c-','')] = el.value;
  });
  // Resolve names
  if (data.proyecto) {
    const p = db.proyectos.find(x => x.id === data.proyecto);
    data.proyectoNombre = p ? p.nombre : data.proyecto;
    data.proyectoCliente = p ? (p.cliente||'') : '';
  }
  if (data.empleado) {
    const p = db.personal.find(x => x.id === data.empleado);
    data.empleadoNombre = p ? p.nombre : data.empleado;
    data.empleadoDNI = p ? (p.dni||'') : '';
  }
  return data;
}

function previsualizarContrato() {
  generarContratoPDF(true);
}

function generarContratoPDF(preview = false) {
  const tipo = document.getElementById('contrato-tipo').value;
  const data = getContratoData(tipo);
  const cfg = CONTRATOS_CONFIG[tipo];

  if (!window.jspdf) { toast('jsPDF no disponible','','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:'a4' });
  const W = 210, MARGIN = 20;
  const empresa = 'BuildCore Constructora S.A.C.';
  const hoy = new Date().toLocaleDateString('es-PE', {year:'numeric',month:'long',day:'numeric'});
  let y = 20;

  // Header
  doc.setFillColor(13,15,18); doc.rect(0,0,W,35,'F');
  doc.setFontSize(16); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text(empresa, W/2, 13, {align:'center'});
  doc.setFontSize(12); doc.setTextColor(220,225,235);
  doc.text(cfg.title.toUpperCase(), W/2, 22, {align:'center'});
  doc.setFontSize(9); doc.setTextColor(100,116,139); doc.setFont('helvetica','normal');
  doc.text('Lima, ' + hoy, W/2, 30, {align:'center'});
  y = 45;

  // Contract number
  const numContrato = 'DOC-' + Date.now().toString().slice(-6);
  doc.setFontSize(9); doc.setTextColor(100,116,139);
  doc.text('NÂ° ' + numContrato, W-MARGIN, y, {align:'right'});
  y += 8;

  const writePara = (text, bold=false, color=[40,50,60]) => {
    doc.setFontSize(10); doc.setTextColor(...color);
    doc.setFont('helvetica', bold ? 'bold' : 'normal');
    const lines = doc.splitTextToSize(text, W - MARGIN*2);
    lines.forEach(line => {
      if (y > 268) { doc.addPage(); y = 20; }
      doc.text(line, MARGIN, y); y += 6;
    });
    y += 2;
  };

  const writeSection = (title) => {
    if (y > 255) { doc.addPage(); y = 20; }
    y += 4;
    doc.setFillColor(30,35,45); doc.rect(MARGIN, y-4, W-MARGIN*2, 8, 'F');
    doc.setFontSize(10); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
    doc.text(title, MARGIN+3, y+1);
    y += 8;
  };

  // Generate content by type
  if (tipo === 'obra') {
    writePara(`Conste por el presente documento el CONTRATO DE OBRA que celebran de una parte ${empresa} (en adelante EL CONTRATISTA) y de la otra parte ${data.cliente||'_______________'}, identificado con DNI/RUC ${data['cliente-dni']||'_______________'} (en adelante EL COMITENTE).`);

    writeSection('PRIMERA: OBJETO DEL CONTRATO');
    writePara(`El Contratista se compromete a ejecutar ${data.proyectoNombre ? 'el proyecto "'+data.proyectoNombre+'"' : 'la obra'}, consistente en: ${data.descripcion||'_______________'}`);

    writeSection('SEGUNDA: PRECIO Y FORMA DE PAGO');
    const monto = parseFloat(data.monto||0).toLocaleString('es-PE', {minimumFractionDigits:2});
    const anticipo = parseFloat(data.anticipo||0).toLocaleString('es-PE', {minimumFractionDigits:2});
    writePara(`El precio total convenido es de S/ ${monto} (Soles).`);
    if (parseFloat(data.anticipo||0) > 0) writePara(`Se abonarÃ¡ un anticipo de S/ ${anticipo} a la firma del presente contrato.`);
    writePara(`El saldo restante se cancelarÃ¡ de acuerdo al avance de obra conforme a los hitos acordados.`);

    writeSection('TERCERA: PLAZO DE EJECUCIÃ“N');
    writePara(`La obra serÃ¡ ejecutada en un plazo de ${data.plazo||'___'} dÃ­as calendario, iniciando el ${data['fecha-inicio']||'___/___/______'}. La penalidad por dÃ­a de retraso es del ${data.penalidad||0.5}% del monto total del contrato.`);

    writeSection('CUARTA: GARANTÃA');
    writePara(`El Contratista otorga una garantÃ­a de ${data.garantia||12} meses contados desde la fecha de entrega de la obra.`);

  } else if (tipo === 'personal') {
    writePara(`Conste por el presente documento el CONTRATO DE TRABAJO ${(data.tipo||'').toUpperCase()} que celebran ${empresa} (en adelante EL EMPLEADOR) y ${data.empleadoNombre||'_______________'} (en adelante EL TRABAJADOR).`);

    writeSection('PRIMERA: CARGO Y FUNCIONES');
    writePara(`El Trabajador se desempeÃ±arÃ¡ en el cargo de ${data.cargo||'_______________'} realizando las funciones propias del puesto.`);

    writeSection('SEGUNDA: REMUNERACIÃ“N');
    const sueldo = parseFloat(data.sueldo||0).toLocaleString('es-PE', {minimumFractionDigits:2});
    writePara(`El Empleador pagarÃ¡ al Trabajador una remuneraciÃ³n mensual de S/ ${sueldo}, sujeta a los descuentos de ley (ONP/AFP, EsSalud, etc.).`);

    writeSection('TERCERA: JORNADA LABORAL');
    writePara(`La jornada de trabajo es de ${data.horario||'Lunes a SÃ¡bado de 7:00am a 5:00pm'}, con un mÃ¡ximo de 48 horas semanales.`);

    writeSection('CUARTA: VIGENCIA');
    writePara(`El presente contrato rige desde el ${data['fecha-inicio']||'___/___/______'}${data['fecha-fin']?` hasta el ${data['fecha-fin']}`:', por tiempo indeterminado'}.`);

  } else if (tipo === 'entrega') {
    writePara(`En Lima, a ${hoy}, ${empresa} representada por su Gerente General, hace entrega formal de la obra al Sr./Sra. ${data.cliente||'_______________'}.`);

    writeSection('DESCRIPCIÃ“N DE TRABAJOS ENTREGADOS');
    writePara(data.descripcion || '_______________');

    writeSection('CONDICIONES DE ENTREGA');
    writePara(`Monto total del contrato: S/ ${parseFloat(data.monto||0).toLocaleString('es-PE', {minimumFractionDigits:2})}`);
    writePara(`GarantÃ­a de obra: ${data.garantia||12} meses a partir de la fecha de entrega.`);
    if (data.observaciones) { writeSection('OBSERVACIONES Y PENDIENTES'); writePara(data.observaciones); }

  } else if (tipo === 'subcontrato') {
    writePara(`Conste el presente SUBCONTRATO celebrado entre ${empresa} (CONTRATANTE) y ${data.cliente||'_______________'}, RUC ${data['cliente-dni']||'_______________'} (SUBCONTRATISTA).`);
    writeSection('TRABAJOS A EJECUTAR');
    writePara(data.descripcion || '_______________');
    writeSection('PRECIO Y PLAZO');
    writePara(`Monto: S/ ${parseFloat(data.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2})} Â· Plazo: ${data.plazo||'___'} dÃ­as desde el ${data['fecha-inicio']||'___'}.`);

  } else if (tipo === 'adicional') {
    writePara(`ACTA DE ADICIONAL DE OBRA â€” Proyecto: ${data.proyectoNombre||'___'}`);
    writePara(`Cliente: ${data.cliente||'___'} Â· Fecha: ${data['fecha-inicio']||hoy}`);
    writeSection('TRABAJOS ADICIONALES');
    writePara(data.descripcion || '_______________');
    writeSection('MONTO Y PLAZO ADICIONAL');
    writePara(`Monto adicional: S/ ${parseFloat(data.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2})} Â· DÃ­as adicionales al plazo: ${data.plazo||0}`);

  } else if (tipo === 'finiquito') {
    writePara(`LIQUIDACIÃ“N Y FINIQUITO LABORAL del Sr./Sra. ${data.empleadoNombre||'___'} con cargo ${data.cargo||'___'}.`);
    writeSection('DATOS DE LA RELACIÃ“N LABORAL');
    writePara(`Fecha de ingreso: ${data['fecha-inicio']||'___'} Â· Fecha de cese: ${data['fecha-fin']||'___'}`);
    writePara(`Motivo: ${data.motivo||'___'}`);
    writeSection('LIQUIDACIÃ“N');
    const sueldo = parseFloat(data.sueldo||0);
    const vacDias = parseFloat(data.vacaciones||0);
    const vacMonto = (sueldo / 30) * vacDias;
    const cts = parseFloat(data['cts-acumulada']||0);
    const total = vacMonto + cts;
    writePara(`Ãšltima remuneraciÃ³n: S/ ${sueldo.toLocaleString('es-PE',{minimumFractionDigits:2})}`);
    writePara(`Vacaciones pendientes (${vacDias} dÃ­as): S/ ${vacMonto.toFixed(2)}`);
    writePara(`CTS acumulada: S/ ${cts.toFixed(2)}`);
    doc.setFontSize(11); doc.setTextColor(34,197,94); doc.setFont('helvetica','bold');
    writePara(`TOTAL A PAGAR: S/ ${total.toFixed(2)}`, true, [34,197,94]);
  }

  // Signature block
  y += 10;
  if (y > 240) { doc.addPage(); y = 20; }
  doc.setFontSize(10); doc.setTextColor(40,50,60); doc.setFont('helvetica','normal');
  const sigY = y + 20;
  doc.line(MARGIN, sigY, MARGIN+60, sigY);
  doc.line(W-MARGIN-60, sigY, W-MARGIN, sigY);
  doc.setFontSize(9); doc.setTextColor(100,116,139);
  doc.text(empresa, MARGIN+30, sigY+5, {align:'center'});
  doc.text(tipo === 'personal' ? (data.empleadoNombre||'El Trabajador') : (data.cliente||'El Cliente'), W-MARGIN-30, sigY+5, {align:'center'});
  doc.text('Firma y Sello', MARGIN+30, sigY+10, {align:'center'});
  doc.text('Firma', W-MARGIN-30, sigY+10, {align:'center'});

  // Footer
  doc.setFontSize(7); doc.setTextColor(150,150,150);
  doc.text(`BuildCore â€” ${cfg.title} â€” Generado ${hoy} â€” NÂ° ${numContrato}`, W/2, 290, {align:'center'});

  // Save to history
  const histItem = { id: numContrato, tipo, titulo: cfg.title, fecha: new Date().toISOString().slice(0,10), ...data };
  _contratosHistorial.unshift(histItem);
  localStorage.setItem('bc_contratos_v1', JSON.stringify(_contratosHistorial.slice(0,50)));
  renderContratosHistorial();

  if (preview) {
    const pdfUrl = doc.output('bloburl');
    window.open(pdfUrl, '_blank');
  } else {
    doc.save(tipo + '_' + numContrato + '.pdf');
    toast('ğŸ“„ ' + cfg.title + ' generado', 'NÂ° ' + numContrato);
    closeModal('nuevo-contrato');
  }
}

function renderContratosHistorial() {
  const el = document.getElementById('contratos-historial');
  if (!el) return;
  const badge = document.getElementById('badge-contratos');
  if (badge) badge.textContent = _contratosHistorial.length;

  if (!_contratosHistorial.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:32px;">GenerÃ¡ tu primer documento haciendo clic en uno de los tipos de arriba.</div>';
    return;
  }
  const tipoColor = { obra:'var(--accent)', personal:'var(--blue)', entrega:'var(--green)', subcontrato:'var(--purple)', adicional:'var(--red)', finiquito:'#06b6d4' };
  const tipoEmoji = { obra:'ğŸ—ï¸', personal:'ğŸ‘·', entrega:'âœ…', subcontrato:'ğŸ¤', adicional:'ğŸ“', finiquito:'ğŸ“‹' };
  el.innerHTML = `<div class="table-wrap"><table><thead><tr><th>NÂ° Documento</th><th>Tipo</th><th>Partes</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>
    ${_contratosHistorial.map(h => `<tr>
      <td><strong>${h.id}</strong></td>
      <td><span style="color:${tipoColor[h.tipo]||'var(--muted)'};">${tipoEmoji[h.tipo]||''} ${h.titulo}</span></td>
      <td style="font-size:12px;color:var(--muted2);">${h.cliente||h.empleadoNombre||'â€”'}${h.proyectoNombre?' Â· '+h.proyectoNombre:''}</td>
      <td>${h.fecha}</td>
      <td><button class="btn btn-danger btn-sm" onclick="eliminarContrato('${h.id}')">ğŸ—‘ï¸</button></td>
    </tr>`).join('')}
  </tbody></table></div>`;
}

function eliminarContrato(id) {
  if (!confirm('Â¿Eliminar este documento del historial?')) return;
  _contratosHistorial = _contratosHistorial.filter(h => h.id !== id);
  localStorage.setItem('bc_contratos_v1', JSON.stringify(_contratosHistorial));
  renderContratosHistorial();
}

// =====================================================================
// ==================== HOOKS NAV + INIT ===============================
// =====================================================================
const _origNavPlanContr = window.nav;
window.nav = function(page, el) {
  if (_origNavPlanContr) _origNavPlanContr(page, el);
  const extras = { planilla:'Planilla de Sueldos', contratos:'Contratos & Actas' };
  if (extras[page]) document.getElementById('page-title').textContent = extras[page];
  if (page === 'planilla') initPlanilla();
  if (page === 'contratos') renderContratosHistorial();
};

// Init on load
const _origLoadAllPlanContr = window.loadAllData;
window.loadAllData = async function() {
  if (_origLoadAllPlanContr) await _origLoadAllPlanContr();
  renderContratosHistorial();
};

</script>
</body>
</html>
