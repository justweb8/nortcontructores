<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NorConstructores — Sistema de Gestión</title>
<!-- PWA -->
<meta name="theme-color" content="#0d0f12">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="NorConstructores">
<link rel="manifest" id="pwa-manifest">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f12; --bg2:#13161b; --bg3:#1a1e26; --bg4:#20252f;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.12);
  --accent:#f5a623; --accent2:#e8521a;
  --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --purple:#a855f7;
  --text:#f1f5f9; --muted:#64748b; --muted2:#94a3b8;
  --sidebar-w:285px;
}
/* ── MODO CLARO ── */
body.light-mode {
  --bg:#f0f2f5; --bg2:#ffffff; --bg3:#f8fafc; --bg4:#e8edf3;
  --border:rgba(0,0,0,0.08); --border2:rgba(0,0,0,0.14);
  --text:#0f172a; --muted:#64748b; --muted2:#475569;
}
body.light-mode .sidebar { box-shadow: 2px 0 12px rgba(0,0,0,0.08); }
body.light-mode .topbar  { box-shadow: 0 1px 8px rgba(0,0,0,0.08); }
body.light-mode .card    { box-shadow: 0 1px 6px rgba(0,0,0,0.06); }
body.light-mode .stat-card { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
body.light-mode .modal   { box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
body.light-mode table thead tr { background: #eef1f5; }
body.light-mode table tbody tr:hover { background: rgba(0,0,0,0.03); }
body.light-mode .form-input { background: #fff; border-color: rgba(0,0,0,0.15); color: var(--text); }
body.light-mode .form-input:focus { border-color: var(--accent); }
body.light-mode .nav-item:hover { background: rgba(0,0,0,0.05); }
body.light-mode .nav-item.active { background: rgba(245,166,35,0.12); }
body.light-mode .btn-ghost { background: rgba(0,0,0,0.06); color: var(--text); }
body.light-mode .btn-ghost:hover { background: rgba(0,0,0,0.1); }
body.light-mode .mobile-card { box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
body.light-mode .login-card { box-shadow: 0 24px 60px rgba(0,0,0,0.15); }
body.light-mode #login-screen { background: #e8edf3; }
body.light-mode .status-badge { opacity: 0.9; }
body.light-mode .search-bar { background: rgba(0,0,0,0.06); }
body.light-mode .topbar { background: var(--bg2); border-bottom: 1px solid var(--border); }
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* ===== LOGIN ===== */
#login-screen{
  position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;
  z-index:999;
}
.login-bg{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 20% 50%,rgba(245,166,35,0.08) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 20%,rgba(232,82,26,0.06) 0%,transparent 50%);
}
.login-grid{
  position:absolute;inset:0;opacity:0.03;
  background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:40px 40px;
}
.login-card{
  background:var(--bg2);border:1px solid var(--border2);border-radius:20px;
  padding:44px 40px;width:420px;position:relative;z-index:1;
  box-shadow:0 32px 80px rgba(0,0,0,0.6);
  animation:cardIn 0.5s cubic-bezier(.16,1,.3,1);
}
@keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(0.97);}to{opacity:1;transform:none;}}
.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;justify-content:center;}
.login-logo-icon{
  width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;
  box-shadow:0 8px 24px rgba(245,166,35,0.3);
}
.login-logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;}
.login-logo-text span{color:var(--accent);}
.login-subtitle{text-align:center;color:var(--muted);font-size:13px;margin-bottom:28px;}
.login-label{font-size:11px;font-weight:700;letter-spacing:1px;color:var(--muted2);text-transform:uppercase;margin-bottom:6px;display:block;}
.login-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);
  padding:12px 14px;border-radius:10px;font-size:14px;font-family:'DM Sans',sans-serif;
  outline:none;transition:border-color 0.2s,box-shadow 0.2s;margin-bottom:14px;
}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,166,35,0.1);}
.login-input::placeholder{color:var(--muted);}
.login-btn{
  width:100%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;
  border:none;padding:13px;border-radius:10px;font-size:14px;font-weight:700;
  font-family:'Syne',sans-serif;cursor:pointer;transition:all 0.2s;margin-top:6px;
  letter-spacing:0.3px;
}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(245,166,35,0.3);}
.login-btn:active{transform:none;}
.login-error{
  background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);
  color:var(--red);padding:10px 14px;border-radius:8px;font-size:13px;
  margin-bottom:14px;display:none;
}
.login-hint{text-align:center;color:var(--muted);font-size:12px;margin-top:16px;}
.login-hint b{color:var(--muted2);}

/* ===== LAYOUT ===== */
#app{display:none;}
#app.visible{display:flex;}
.sidebar{
  width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;overflow-y:auto;
}
.sidebar-logo{padding:20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;}
.logo-text span{color:var(--accent);}
.nav-section{padding:14px 10px 6px;}
.nav-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;padding:0 8px;margin-bottom:6px;}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;
  cursor:pointer;color:var(--muted2);font-size:13px;font-weight:500;transition:all 0.15s;
  margin-bottom:2px;position:relative;
}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(245,166,35,0.12);color:var(--accent);}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 3px 3px 0;}
.alerta-filter.active{background:rgba(245,166,35,0.15);color:var(--accent);border-color:var(--accent);}
.nav-item svg{width:17px;height:17px;flex-shrink:0;}
.badge{margin-left:auto;background:var(--accent2);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:20px;}
.badge.green{background:rgba(34,197,94,0.2);color:var(--green);}
.sidebar-bottom{margin-top:auto;padding:14px 10px;border-top:1px solid var(--border);}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:background 0.15s;}
.user-card:hover{background:var(--bg3);}
.avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;}
.user-info .name{font-size:13px;font-weight:600;}
.user-info .role{font-size:11px;color:var(--muted);}
.logout-btn{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--red);font-size:12px;font-weight:600;margin-top:6px;transition:background 0.15s;}
.logout-btn:hover{background:rgba(239,68,68,0.1);}

.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 24px;height:58px;display:flex;align-items:center;gap:14px;
  position:sticky;top:0;z-index:50;
}
.topbar-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;flex:1;}
.btn{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all 0.15s;font-family:'DM Sans',sans-serif;}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(245,166,35,0.3);}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--bg3);color:var(--text);}
.btn-danger{background:rgba(239,68,68,0.15);color:var(--red);border:1px solid rgba(239,68,68,0.3);}
.btn-danger:hover{background:rgba(239,68,68,0.25);}
.btn-success{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3);}
.btn-success:hover{background:rgba(34,197,94,0.25);}
.btn-sm{padding:5px 12px;font-size:12px;}
.icon-btn{width:34px;height:34px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted2);transition:all 0.15s;}
.icon-btn:hover{color:var(--text);border-color:var(--accent);}
.content{padding:22px 24px;flex:1;}
.page{display:none;}
.page.active{display:block;}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.card-subtitle{font-size:12px;color:var(--muted);margin-top:2px;}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:border-color 0.2s;}
.stat-card:hover{border-color:rgba(245,166,35,0.3);}
.stat-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.stat-icon.orange{background:rgba(245,166,35,0.15);}
.stat-icon.blue{background:rgba(59,130,246,0.15);}
.stat-icon.green{background:rgba(34,197,94,0.15);}
.stat-icon.red{background:rgba(239,68,68,0.15);}
.stat-change{font-size:11px;font-weight:700;padding:2px 7px;border-radius:20px;}
.stat-change.up{background:rgba(34,197,94,0.12);color:var(--green);}
.stat-change.down{background:rgba(239,68,68,0.12);color:var(--red);}
.stat-value{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;line-height:1;margin-bottom:4px;}
.stat-label{font-size:12px;color:var(--muted2);}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;padding:9px 12px;font-size:11px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(255,255,255,0.025);}
tbody td{padding:11px 12px;font-size:13px;vertical-align:middle;}
.td-name{font-weight:600;}
.td-sub{font-size:11px;color:var(--muted);margin-top:2px;}

/* STATUS */
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;}
.status-badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.status-badge.activo{background:rgba(34,197,94,0.12);color:var(--green);}
.status-badge.progreso{background:rgba(59,130,246,0.12);color:var(--blue);}
.status-badge.pendiente{background:rgba(245,166,35,0.12);color:var(--accent);}
.status-badge.pausado{background:rgba(239,68,68,0.12);color:var(--red);}
.status-badge.finalizado{background:rgba(168,85,247,0.12);color:var(--purple);}
.status-badge.planilla{background:rgba(34,197,94,0.12);color:var(--green);}
.status-badge.contrato{background:rgba(59,130,246,0.12);color:var(--blue);}
.status-badge.jornal{background:rgba(245,166,35,0.12);color:var(--accent);}

/* PROGRESS */
.progress-bar{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;padding:26px;animation:fadeUp 0.2s ease;}
.modal.modal-lg{max-width:780px;}
.modal.modal-xl{max-width:960px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:none;}}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;}
.modal-close{background:var(--bg3);border:1px solid var(--border);color:var(--muted2);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.modal-close:hover{background:rgba(239,68,68,0.15);color:var(--red);border-color:rgba(239,68,68,0.3);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{margin-bottom:12px;}
.form-label{font-size:11px;font-weight:700;color:var(--muted2);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:0.5px;}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.15s;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--muted);}
select.form-input{cursor:pointer;}
textarea.form-input{resize:vertical;min-height:72px;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--green);border-radius:10px;padding:12px 16px;z-index:500;display:none;min-width:260px;animation:slideIn 0.3s ease;}
.toast.open{display:block;}
.toast.warn{border-left-color:var(--accent);}
.toast.err{border-left-color:var(--red);}
@keyframes slideIn{from{transform:translateX(60px);opacity:0;}to{transform:none;opacity:1;}}
.toast-title{font-weight:700;font-size:13px;margin-bottom:2px;}
.toast-msg{font-size:11px;color:var(--muted2);}

/* PERSON DETAIL */
.person-detail-header{
  display:flex;align-items:center;gap:18px;padding:20px;background:var(--bg3);
  border-radius:12px;margin-bottom:18px;border:1px solid var(--border);
}
.person-avatar{
  width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;flex-shrink:0;
}
.person-detail-info h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}
.person-detail-info p{font-size:13px;color:var(--muted2);margin-top:3px;}
.detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.detail-item{background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);}
.detail-item .d-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.detail-item .d-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.detail-item .d-sub{font-size:11px;color:var(--muted2);margin-top:2px;}
.hours-table{width:100%;border-collapse:collapse;font-size:13px;}
.hours-table th{text-align:left;padding:8px 10px;font-size:10px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
.hours-table td{padding:9px 10px;border-bottom:1px solid var(--border);}
.hours-table tr:last-child td{border-bottom:none;}

/* MACHINE DETAIL */
.machine-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}

/* SEARCH */
.search-bar{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0 10px;height:34px;min-width:200px;}
.search-bar input{background:none;border:none;outline:none;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;width:100%;}
.search-bar input::placeholder{color:var(--muted);}

/* TABS */
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:16px;}
.tab{padding:8px 14px;font-size:13px;font-weight:500;color:var(--muted2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}

/* EMPTY STATE */
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-state .icon{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:13px;}

/* SECTION HEADER */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.section-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;}
.section-sub{font-size:12px;color:var(--muted);margin-top:3px;}

/* PROJECT CARD */
.projects-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.project-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;
  cursor:pointer;transition:all 0.2s;
}
.project-card:hover{border-color:rgba(245,166,35,0.4);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.project-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;}
.project-type-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--muted2);text-transform:uppercase;letter-spacing:0.5px;}
.project-card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:4px;}
.project-card-client{font-size:12px;color:var(--muted2);}
.project-card-meta{display:flex;align-items:center;justify-content:space-between;margin-top:14px;}
.project-progress-label{font-size:11px;color:var(--muted2);margin-bottom:5px;display:flex;justify-content:space-between;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* MACHINE CARD */
.machine-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:all 0.2s;}
.machine-card:hover{border-color:rgba(59,130,246,0.4);}
.machines-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}

/* RENTAB COLOR */
.rentab-high{color:var(--green);font-weight:700;}
.rentab-mid{color:var(--accent);font-weight:700;}
.rentab-low{color:var(--red);font-weight:700;}

/* CONFIRM MODAL */
.confirm-modal{max-width:380px;}

/* ══════════════════════════════════════════════════════════════
   NorConstructores — SISTEMA RESPONSIVE COMPLETO
   Breakpoints: 1200 | 1024 | 768 | 640 | 480 | 380
   ══════════════════════════════════════════════════════════════ */

/* ─── Hamburger Button ─── */
.hamburger {
  display: none;
  background: none;
  border: none;
  cursor: pointer;
  padding: 8px;
  color: var(--text);
  flex-direction: column;
  gap: 5px;
  flex-shrink: 0;
  border-radius: 8px;
  transition: background .18s;
}
.hamburger:hover { background: var(--bg3); }
.hamburger span {
  display: block;
  width: 22px;
  height: 2px;
  background: currentColor;
  border-radius: 2px;
  transition: transform .28s cubic-bezier(.16,1,.3,1), opacity .2s;
}

/* ─── Sidebar Overlay ─── */
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.75);
  z-index: 150;
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
}
.sidebar-overlay.open { display: block; }

/* ─── Mobile Cards (base — hidden on desktop) ─── */
.mobile-cards { display: none; }

.mobile-card {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 16px;
  margin-bottom: 10px;
  transition: border-color .15s, transform .1s;
}
.mobile-card:active { transform: scale(.99); border-color: rgba(245,166,35,.35); }

.mc-header  { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 12px; }
.mc-left    { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
.mc-avatar  {
  width: 40px; height: 40px; border-radius: 50%;
  background: linear-gradient(135deg, var(--blue), var(--purple));
  display: flex; align-items: center; justify-content: center;
  font-size: 14px; font-weight: 800; flex-shrink: 0;
}
.mc-name   { font-weight: 700; font-size: 14px; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.mc-sub    { font-size: 11px; color: var(--muted); margin-top: 2px; }
.mc-body   { display: grid; grid-template-columns: 1fr 1fr; gap: 8px 14px; margin-bottom: 12px; }
.mc-label  { font-size: 10px; color: var(--muted); font-weight: 700; text-transform: uppercase; letter-spacing: .5px; }
.mc-val    { font-size: 13px; font-weight: 600; margin-top: 2px; }
.mc-actions { display: flex; gap: 6px; padding-top: 10px; border-top: 1px solid var(--border); }
.mc-actions .btn { flex: 1; font-size: 12px; padding: 8px 6px; text-align: center; }

/* ─── Roles ─── */
.role-badge       { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
.role-admin       { background: rgba(245,166,35,.15); color: var(--accent); }
.role-supervisor  { background: rgba(59,130,246,.15);  color: var(--blue); }
.role-contador    { background: rgba(34,197,94,.15);   color: var(--green); }
.role-capataz     { background: rgba(168,85,247,.15);  color: var(--purple); }
.role-cliente     { background: rgba(100,116,139,.15); color: var(--muted2); }

/* ══════════════════════════════
   ≤ 1200px
══════════════════════════════ */
@media (max-width: 1200px) {
  .projects-grid, .machines-grid { grid-template-columns: repeat(2,1fr); }
  .stats-grid                    { grid-template-columns: repeat(2,1fr); }
  .detail-grid                   { grid-template-columns: repeat(2,1fr); }
  .machine-kpi-grid              { grid-template-columns: repeat(2,1fr); }
}

/* ══════════════════════════════
   ≤ 1024px  TABLET
══════════════════════════════ */
@media (max-width: 1024px) {
  :root { --sidebar-w: 285px; }
  html, body { overflow-x: hidden; }

  .main    { margin-left: 0 !important; }
  .sidebar {
    transform: translateX(-100%);
    transition: transform .32s cubic-bezier(.16,1,.3,1);
    z-index: 200;
  }
  .sidebar.open {
    transform: translateX(0);
    box-shadow: 8px 0 40px rgba(0,0,0,.55);
  }
  .hamburger   { display: flex !important; }
  .topbar      { padding: 0 14px; }
  .content     { padding: 16px 14px; }

  .stats-grid, .projects-grid, .machines-grid { grid-template-columns: repeat(2,1fr); }
  .section-header                              { flex-wrap: wrap; gap: 10px; }

  /* Inline stat grids */
  [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:repeat(5,1fr)"] { grid-template-columns: repeat(3,1fr) !important; }
}

/* ══════════════════════════════
   ≤ 768px  MÓVIL
══════════════════════════════ */
@media (max-width: 768px) {
  :root { --sidebar-w: 85vw; }
  html, body { overflow-x: hidden !important; }

  /* ── Layout ── */
  .main    { margin-left: 0 !important; max-width: 100vw; overflow-x: hidden; }
  .content { padding: 12px 10px !important; }

  /* ── Topbar ── */
  .topbar {
    padding: 0 10px !important;
    height: 52px !important;
    gap: 8px !important;
  }
  .topbar-title {
    font-size: 14px !important;
    font-weight: 700 !important;
    flex: 1; min-width: 0;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .topbar .search-bar { display: none !important; }
  .topbar .icon-btn   { width: 32px !important; height: 32px !important; flex-shrink: 0; }

  /* ── KPI Stats — 2×2 grid ── */
  .stats-grid     { grid-template-columns: repeat(2,1fr) !important; gap: 8px !important; }
  .stat-card      { padding: 14px 12px !important; border-radius: 12px !important; }
  .stat-value     { font-size: 20px !important; line-height: 1.1 !important; }
  .stat-label     { font-size: 11px !important; }
  .stat-icon      { width: 34px !important; height: 34px !important; font-size: 15px !important; }
  .stat-header    { margin-bottom: 8px !important; }

  /* ── Section Header: stack vertically ── */
  .section-header {
    flex-direction: column !important;
    align-items: stretch !important;
    gap: 10px !important;
    margin-bottom: 14px !important;
  }
  .section-title { font-size: 18px !important; }
  .section-sub   { font-size: 11px !important; }
  .section-header > div:last-child {
    display: flex !important;
    gap: 6px !important;
    flex-wrap: wrap !important;
    width: 100% !important;
  }
  .section-header .btn {
    flex: 1 !important;
    min-width: 0 !important;
    font-size: 12px !important;
    padding: 9px 8px !important;
    text-align: center !important;
  }
  .section-header select.form-input,
  .section-header input[type="date"].form-input {
    flex: 1 !important;
    min-width: 120px !important;
    height: 36px !important;
    font-size: 12px !important;
    max-width: 100% !important;
  }

  /* ── Cards ── */
  .card        { padding: 14px !important; border-radius: 14px !important; }
  .card-header { flex-wrap: wrap !important; gap: 8px !important; }
  .card-title  { font-size: 14px !important; }

  /* ── Grids ── */
  .projects-grid, .machines-grid { grid-template-columns: 1fr !important; }
  .detail-grid                   { grid-template-columns: 1fr 1fr !important; }
  .machine-kpi-grid              { grid-template-columns: 1fr 1fr !important; }

  /* ── Tables & Mobile Cards ── */
  .hide-on-mobile { display: none !important; }
  .mobile-cards   { display: block !important; }
  .table-wrap     { overflow-x: auto !important; -webkit-overflow-scrolling: touch; }

  /* ── Modals → bottom sheet ── */
  .modal-overlay { align-items: flex-end !important; padding: 0 !important; }
  .modal {
    border-radius: 22px 22px 0 0 !important;
    margin: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    max-height: 93vh !important;
    overflow-y: auto !important;
    padding: 0 16px 36px !important;
    animation: bcSheetUp .3s cubic-bezier(.16,1,.3,1) !important;
  }
  @keyframes bcSheetUp {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
  }
  .modal::before {
    content: '';
    display: block;
    width: 40px; height: 4px;
    background: rgba(255,255,255,.14);
    border-radius: 4px;
    margin: 12px auto 18px;
  }
  .modal.modal-lg, .modal.modal-xl { max-height: 96vh !important; }
  .modal-title { font-size: 16px !important; }
  .form-row    { grid-template-columns: 1fr !important; }

  /* ── Login ── */
  .login-card { width: calc(100vw - 24px) !important; padding: 26px 18px !important; }

  /* ── Person Detail ── */
  .person-detail-header { flex-direction: column !important; text-align: center !important; gap: 12px !important; }

  /* ── Tabs ── */
  .tabs { overflow-x: auto !important; flex-wrap: nowrap !important; -webkit-overflow-scrolling: touch; padding-bottom: 2px; scrollbar-width: none; }
  .tabs::-webkit-scrollbar { display: none; }
  .tab  { white-space: nowrap !important; padding: 7px 12px !important; font-size: 12px !important; }

  /* ── Toast ── */
  .toast { right: 10px !important; left: 10px !important; bottom: 16px !important; min-width: 0 !important; }

  /* ── Buttons ── */
  .btn    { font-size: 12px !important; }
  .btn-sm { padding: 6px 10px !important; font-size: 11px !important; }

  /* ── Global inline grid overrides ── */
  [style*="grid-template-columns:repeat(3,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:repeat(5,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  [style*="grid-template-columns:2fr 1fr"]        { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:1fr 1fr"]        { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:3fr 1fr"]        { grid-template-columns: 1fr !important; }

  /* Canvas responsive */
  canvas { max-width: 100% !important; }

  /* ════════════════════════════════
     DASHBOARD
  ════════════════════════════════ */
  #page-dashboard .stats-grid                                      { grid-template-columns: repeat(2,1fr) !important; }
  #page-dashboard [style*="grid-template-columns:2fr 1fr"]         { grid-template-columns: 1fr !important; }
  #page-dashboard [style*="grid-template-columns:1fr 1fr"]         { grid-template-columns: 1fr !important; }
  /* Donut centrado */
  #dash-donut-chart                                                 { max-width: 150px !important; margin: 0 auto !important; }
  /* Legend líneas del gráfico */
  #page-dashboard .card-header [style*="gap:14px"]                  { flex-wrap: wrap !important; gap: 6px !important; }

  /* ════════════════════════════════
     OBRAS EN CURSO
  ════════════════════════════════ */
  #page-obras [style*="grid-template-columns:2fr 1fr"] { grid-template-columns: 1fr !important; }
  /* Items de clima: flex row → stack */
  #page-obras .card [style*="justify-content:space-between"][style*="align-items:center"]:not(.card-header) {
    flex-direction: column !important;
    align-items: flex-start !important;
    gap: 3px !important;
  }

  /* ════════════════════════════════
     COTIZADOR
  ════════════════════════════════ */
  #cotiz-resumen [style*="grid-template-columns:1fr 1fr"] { grid-template-columns: 1fr !important; }
  #cotiz-resumen [style*="font-size:32px"]                { font-size: 26px !important; }

  /* ════════════════════════════════
     PLANILLA DE SUELDOS
  ════════════════════════════════ */
  #page-planilla [style*="grid-template-columns:repeat(5,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #page-planilla [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #planilla-mes { width: 100% !important; max-width: 100% !important; }

  /* ════════════════════════════════
     CONTRATOS & ACTAS
     Tarjetas 3-col → 2-col compacto
  ════════════════════════════════ */
  #page-contratos [style*="grid-template-columns:repeat(3,1fr)"] {
    grid-template-columns: repeat(2,1fr) !important;
    gap: 10px !important;
  }
  #page-contratos .stat-card {
    padding: 12px 10px !important;
    display: flex !important;
    flex-direction: column !important;
  }
  #page-contratos .stat-card .stat-value  { font-size: 13px !important; font-weight: 700 !important; }
  #page-contratos .stat-card .stat-label  { font-size: 10px !important; }
  #page-contratos .stat-icon              { width: 32px !important; height: 32px !important; font-size: 14px !important; }
  #page-contratos .stat-card .btn         { font-size: 11px !important; padding: 6px 8px !important; }
  /* Historial: scroll */
  #contratos-historial .table-wrap        { overflow-x: auto !important; }

  /* ════════════════════════════════
     ASISTENCIA
  ════════════════════════════════ */
  #page-asistencia [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #asist-proyecto-filter { flex: 1 !important; max-width: 100% !important; }
  /* Tabla del día → ocultar, mobile-cards visible */
  #page-asistencia .card:first-of-type .table-wrap { display: none !important; }
  #asist-mobile                                    { display: block !important; }
  /* Resumen mensual: scroll */
  #page-asistencia .card:last-child .table-wrap { overflow-x: auto !important; display: block !important; }

  /* ════════════════════════════════
     FLUJO DE CAJA
  ════════════════════════════════ */
  /* Stats 4-col → 2-col */
  #page-flujocaja .stats-grid                                      { grid-template-columns: repeat(2,1fr) !important; }
  #page-flujocaja [style*="grid-template-columns:repeat(4,1fr)"]   { grid-template-columns: repeat(2,1fr) !important; }
  /* Selects filtro: expandir */
  #flujo-proyecto-filter, #flujo-mes-filter {
    flex: 1 !important;
    min-width: 120px !important;
    max-width: 100% !important;
    height: 36px !important;
    font-size: 12px !important;
  }
  /* Botones gráfico: wrap */
  #page-flujocaja .card-header > div { flex-wrap: wrap !important; gap: 4px !important; }
  #flujo-btn-todos, #flujo-btn-ingreso, #flujo-btn-egreso { font-size: 11px !important; padding: 5px 8px !important; }
  /* Tabla → mobile cards */
  #page-flujocaja .card:last-child .table-wrap { display: none !important; }
  #flujo-mobile                                { display: block !important; }

  /* ════════════════════════════════
     REPORTES & ANALÍTICA
  ════════════════════════════════ */
  #page-reportes [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  /* Dos gráficos side-by-side → 1 col */
  #page-reportes [style*="grid-template-columns:1fr 1fr"]        { grid-template-columns: 1fr !important; }
  /* Botones Excel/PDF: full width */
  #page-reportes .section-header .btn { flex: 1 !important; text-align: center !important; }
  /* Card headers con botones: wrap */
  #page-reportes .card-header { flex-wrap: wrap !important; gap: 8px !important; }
  #page-reportes .card-header .btn { width: 100% !important; text-align: center !important; }
  /* Gantt: scroll horizontal */
  #gantt-container { overflow-x: auto !important; width: 100% !important; }
  /* Tabla resumen ejecutivo → scroll (ya tiene hide-on-mobile no es necesario ocultarla,
     pero hacemos scroll elegante) */
  #page-reportes .card:last-child .table-wrap { overflow-x: auto !important; }

  /* ════════════════════════════════
     USUARIOS & ROLES
  ════════════════════════════════ */
  #page-usuarios [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  /* Tabla → mobile cards */
  #page-usuarios .table-wrap { display: none !important; }
  #usuarios-mobile           { display: block !important; }
}

/* ══════════════════════════════
   ≤ 640px  TELÉFONO PEQUEÑO
══════════════════════════════ */
@media (max-width: 640px) {
  .content   { padding: 10px 8px !important; }
  .topbar    { padding: 0 8px !important; height: 50px !important; }
  .topbar-title { font-size: 13px !important; }

  /* Stats → 1 columna */
  .stats-grid  { grid-template-columns: 1fr !important; gap: 8px !important; }
  .stat-value  { font-size: 22px !important; }
  .section-title { font-size: 17px !important; }

  /* Contratos → 1 col */
  #page-contratos [style*="grid-template-columns:repeat(3,1fr)"],
  #page-contratos [style*="grid-template-columns:repeat(2,1fr)"] {
    grid-template-columns: 1fr !important;
  }

  /* Reportes KPIs → 1 col */
  #page-reportes [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }

  /* Inline grids */
  [style*="grid-template-columns:1fr 1fr"]        { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(3,1fr)"]  { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(4,1fr)"]  { grid-template-columns: repeat(2,1fr) !important; }

  .detail-grid      { grid-template-columns: 1fr !important; }
  .machine-kpi-grid { grid-template-columns: 1fr !important; }
}

/* ══════════════════════════════
   ≤ 480px  TELÉFONO MUY PEQUEÑO
══════════════════════════════ */
@media (max-width: 480px) {
  [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  #page-planilla [style*="grid-template-columns:repeat(5,1fr)"],
  #page-planilla [style*="grid-template-columns:repeat(4,1fr)"] { grid-template-columns: repeat(2,1fr) !important; }
  .stats-grid     { grid-template-columns: 1fr !important; }
  .modal          { padding: 0 12px 32px !important; }
  .login-card     { padding: 22px 14px !important; border-radius: 16px !important; }
}

/* ══════════════════════════════
   ≤ 380px  MÍNIMO ABSOLUTO
══════════════════════════════ */
@media (max-width: 380px) {
  .content { padding: 8px 6px !important; }
  .stats-grid { grid-template-columns: 1fr !important; }
  #page-contratos [style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
  [style*="grid-template-columns:repeat(4,1fr)"]   { grid-template-columns: 1fr !important; }
}

/* ── Proveedores KPI grid ── */
.prov-kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}
@media (max-width: 768px) {
  .prov-kpi-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
}
@media (max-width: 480px) {
  .prov-kpi-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 6px !important; }
}

/* ── Proveedores table responsive ── */
@media (max-width: 768px) {
  #page-proveedores .hide-on-mobile { display: none !important; }
  #proveedores-mobile { display: block !important; }
  #page-proveedores .section-header .btn { flex: 1 !important; }
  #prov-search { font-size: 13px !important; }
}
/* Desktop: tabla con scroll si pantalla chica */
@media (min-width: 769px) {
  #page-proveedores .table-wrap { overflow-x: auto; }
  #page-proveedores table { min-width: 750px; }
  #proveedores-mobile { display: none !important; }
}
</style>
</head>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
<body>

<!-- ===== LOGIN ===== -->
<div id="login-screen">
  <div class="login-bg"></div>
  <div class="login-grid"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-text">Nor<span>Constructores</span></div>
    </div>
    <p class="login-subtitle">Sistema de Gestión para Constructoras<br>Ingresá tus credenciales para continuar</p>
    <div id="login-error" class="login-error">⚠️ Usuario o contraseña incorrectos.</div>
    <label class="login-label">Usuario</label>
    <input type="text" class="login-input" id="login-user" placeholder="Ej: admin" autocomplete="username">
    <label class="login-label">Contraseña</label>
    <input type="password" class="login-input" id="login-pass" placeholder="••••••••" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">INGRESAR AL SISTEMA</button>
    <p class="login-hint">Demo: usuario <b>admin</b> · contraseña <b>1234</b></p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app">
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-text">Nor<span>Constructores</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item active" onclick="nav('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-item" onclick="nav('proyectos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M4 20V10l8-6 8 6v10"/><path d="M9 20v-5h6v5"/></svg>
      Proyectos
      <span class="badge green" id="badge-proyectos">0</span>
    </div>
    <div class="nav-item" onclick="nav('personal',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Personal & Cuadrillas
      <span class="badge" id="badge-personal">0</span>
    </div>
    <div class="nav-item" onclick="nav('maquinaria',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Maquinaria
      <span class="badge" id="badge-maquinaria">0</span>
    </div>
    <div class="nav-item" onclick="nav('obras',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
      Obras en Curso
      <span class="badge green" id="badge-obras">0</span>
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Gestión</div>
    <div class="nav-item" onclick="nav('presupuestos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Presupuestos
      <span class="badge" id="badge-presupuestos">0</span>
    </div>
    <div class="nav-item" onclick="nav('materiales',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
      Materiales
    </div>
    <div class="nav-item" onclick="nav('proveedores',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18l-2 9H5L3 3z"/><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/></svg>
      Proveedores
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Finanzas</div>
    <div class="nav-item" onclick="nav('cotizador',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 7H6a2 2 0 00-2 2v9a2 2 0 002 2h9a2 2 0 002-2v-3"/><path d="M9 7V5a2 2 0 012-2h7a2 2 0 012 2v7a2 2 0 01-2 2h-2"/><path d="M12 12h4m-4 4h4m-4-8h4"/></svg>
      Cotizador
      <span class="badge" style="background:rgba(168,85,247,0.25);color:#a855f7;" id="badge-cotiz">0</span>
    </div>
    <div class="nav-item" onclick="nav('facturacion',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      Facturación
      <span class="badge" id="badge-facturas">3</span>
    </div>
    <div class="nav-item" onclick="nav('planilla',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Planilla de Sueldos
      <span class="badge" id="badge-planilla" style="background:rgba(34,197,94,0.2);color:var(--green);">0</span>
    </div>
    <div class="nav-item" onclick="nav('contratos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Contratos & Actas
      <span class="badge" id="badge-contratos" style="background:rgba(59,130,246,0.2);color:var(--blue);">0</span>
    </div>
    <div class="nav-item" onclick="nav('asistencia',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><polyline points="16 11 18 13 22 9"/></svg>
      Asistencia
      <span class="badge" id="badge-asistencia" style="background:rgba(245,166,35,0.2);color:var(--accent);">0</span>
    </div>
    <div class="nav-item" onclick="nav('flujocaja',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1v22M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/></svg>
      Flujo de Caja
    </div>
    <div class="nav-item" onclick="nav('alertas',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      Alertas
      <span class="badge" id="badge-alertas" style="background:rgba(220,53,69,0.15);color:var(--red);">0</span>
    </div>
    <div class="nav-item" onclick="nav('reportes',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reportes
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Sistema</div>
    <div class="nav-item" onclick="nav('usuarios',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      Usuarios & Roles
      <span class="badge" id="badge-usuarios" style="background:rgba(245,166,35,0.2);color:var(--accent);">0</span>
    </div>
  </div>
  <div class="sidebar-bottom">
    <div class="user-card">
      <div class="avatar" id="sidebar-avatar">AD</div>
      <div class="user-info">
        <div class="name" id="sidebar-name">Administrador</div>
        <div class="role">Director de Obras</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin:6px 0;">
      <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--green);font-size:11px;font-weight:600;transition:background 0.15s;border:1px solid rgba(34,197,94,0.2);" onclick="openModal('importar')" onmouseover="this.style.background='rgba(34,197,94,0.1)'" onmouseout="this.style.background=''">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        Importar
      </div>
      <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--accent);font-size:11px;font-weight:600;transition:background 0.15s;border:1px solid rgba(245,166,35,0.2);" onclick="exportarTodo()" onmouseover="this.style.background='rgba(245,166,35,0.08)'" onmouseout="this.style.background=''">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        Exportar
      </div>
      <div style="display:flex;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;cursor:pointer;font-size:11px;font-weight:600;transition:background 0.15s;border:1px solid var(--border2);" id="theme-toggle-btn" onclick="toggleTheme()" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background=''">
        <span id="theme-icon">🌙</span>
        <span id="theme-label">Modo Claro</span>
      </div>
      <div id="pwa-install-btn" style="display:none;align-items:center;gap:6px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--blue);font-size:11px;font-weight:600;transition:background 0.15s;border:1px solid rgba(59,130,246,0.2);" onclick="installPWA()" onmouseover="this.style.background='rgba(59,130,246,0.1)'" onmouseout="this.style.background=''">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/><path d="M8 12l4 4 4-4M12 8v8"/></svg>
        Instalar
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center;padding:6px 10px;font-size:11px;color:var(--muted);">
      <span id="offline-indicator" style="display:none;color:var(--accent);">⚡ Modo offline</span>
      <span id="sync-indicator" style="display:none;color:var(--green);">✓ Sincronizado</span>
      <span id="pending-sync-indicator" style="display:none;color:var(--accent);">🔄 <span id="pending-count">0</span> pendientes</span>
    </div>
    <div class="logout-btn" onclick="doLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
      Cerrar Sesión
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <header class="topbar">
    <button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()" aria-label="Menú">
      <span></span><span></span><span></span>
    </button>
    <div class="topbar-title" id="page-title">Dashboard General</div>
    <div class="search-bar">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" placeholder="Buscar..." id="global-search" oninput="globalSearch(this.value)">
    </div>
    <div class="icon-btn" title="Notificaciones" onclick="nav('alertas',null)" style="position:relative;">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
      <span id="topbar-alert-badge" style="display:none;position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;font-size:9px;font-weight:800;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;"></span>
    </div>
  </header>

  <div class="content">

    <!-- ===== DASHBOARD ===== -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon orange">🏗️</div><span class="stat-change up" id="kpi-p-change">0</span></div>
          <div class="stat-value" id="kpi-proyectos">0</div>
          <div class="stat-label">Proyectos Activos</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon blue">💰</div></div>
          <div class="stat-value" id="kpi-presupuesto">$0</div>
          <div class="stat-label">Presupuesto Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon green">👷</div></div>
          <div class="stat-value" id="kpi-personal">0</div>
          <div class="stat-label">Personal en Planilla</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon red">🚜</div></div>
          <div class="stat-value" id="kpi-maquinas">0</div>
          <div class="stat-label">Equipos Activos</div>
        </div>
      </div>

      <!-- PROYECTOS RESUMEN -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">Resumen de Proyectos</div></div>
          <button class="btn btn-ghost btn-sm" onclick="nav('proyectos',null)">Ver todos →</button>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Proyecto</th><th>Cliente</th><th>Presupuesto</th><th>Avance</th><th>Estado</th></tr></thead>
            <tbody id="dash-projects-table"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">No hay proyectos aún.</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CHARTS ROW -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;">
        <!-- LINE CHART: Facturación mensual -->
        <div class="card">
          <div class="card-header">
            <div><div class="card-title">Facturación vs Costos — 2025</div><div class="card-subtitle">Comparativa mensual en millones USD</div></div>
            <div style="display:flex;gap:14px;align-items:center;">
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--accent);border-radius:2px;"></div>Facturado</div>
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--blue);border-radius:2px;border-style:dashed;"></div>Costo</div>
            </div>
          </div>
          <canvas id="dash-line-chart" height="140" style="width:100%;"></canvas>
        </div>
        <!-- DONUT: Proyectos por tipo -->
        <div class="card">
          <div class="card-header"><div><div class="card-title">Proyectos por Tipo</div><div class="card-subtitle">Distribución de cartera</div></div></div>
          <div style="display:flex;flex-direction:column;align-items:center;padding:4px 0;">
            <canvas id="dash-donut-chart" width="160" height="160" style="max-width:160px;"></canvas>
            <div id="dash-donut-legend" style="width:100%;margin-top:14px;display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>
      </div>

      <!-- BOTTOM ROW -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Personal — Top Horas Mes</div></div>
          <div id="dash-personal-list" style="display:flex;flex-direction:column;gap:10px;">
            <p style="color:var(--muted);font-size:13px;">Sin datos aún.</p>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Maquinaria — Rentabilidad</div></div>
          <div id="dash-maquinaria-list" style="display:flex;flex-direction:column;gap:10px;">
            <p style="color:var(--muted);font-size:13px;">Sin datos aún.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PROYECTOS ===== -->
    <div class="page" id="page-proyectos">
      <div class="section-header">
        <div>
          <div class="section-title">Gestión de Proyectos</div>
          <div class="section-sub" id="proyectos-sub">0 proyectos en cartera</div>
        </div>
        <button class="btn btn-primary" onclick="openModal('proyecto')">＋ Nuevo Proyecto</button>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="filterTab('proyectos','todos',this)">Todos</div>
        <div class="tab" onclick="filterTab('proyectos','activo',this)">Activos</div>
        <div class="tab" onclick="filterTab('proyectos','progreso',this)">En Curso</div>
        <div class="tab" onclick="filterTab('proyectos','pendiente',this)">Pendientes</div>
        <div class="tab" onclick="filterTab('proyectos','finalizado',this)">Finalizados</div>
      </div>
      <div class="projects-grid" id="projects-grid">
        <div class="empty-state" style="grid-column:1/-1;"><div class="icon">🏗️</div><p>No hay proyectos.<br>Hacé clic en "Nuevo Proyecto" para comenzar.</p></div>
      </div>
    </div>

    <!-- ===== PERSONAL ===== -->
    <div class="page" id="page-personal">
      <div class="section-header">
        <div>
          <div class="section-title">Personal & Cuadrillas</div>
          <div class="section-sub" id="personal-sub">0 empleados registrados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportPersonalExcel()">📥 Exportar Excel</button>
          <button class="btn btn-primary" onclick="openModal('personal')">＋ Agregar Personal</button>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div class="search-bar" style="flex:1;max-width:300px;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" placeholder="Buscar empleado..." oninput="filterPersonal(this.value)">
          </div>
          <select class="form-input" style="width:180px;height:34px;padding:0 10px;" onchange="filterPersonalStatus(this.value)">
            <option value="">Todos los tipos</option>
            <option value="planilla">En Planilla</option>
            <option value="contrato">Contrato</option>
            <option value="jornal">Jornalero</option>
          </select>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead>
              <tr>
                <th>Empleado</th>
                <th>Rol / Cuadrilla</th>
                <th>Tipo</th>
                <th>Sueldo Base</th>
                <th>Horas Mes</th>
                <th>Proyecto</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="personal-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No hay personal registrado.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="personal-mobile"></div>
      </div>
    </div>

    <!-- ===== MAQUINARIA ===== -->
    <div class="page" id="page-maquinaria">
      <div class="section-header">
        <div>
          <div class="section-title">Parque de Maquinaria</div>
          <div class="section-sub" id="maquinaria-sub">0 equipos registrados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportMaquinariaExcel()">📥 Exportar Excel</button>
          <button class="btn btn-primary" onclick="openModal('maquina')">＋ Registrar Equipo</button>
        </div>
      </div>

      <!-- KPIs maquinaria -->
      <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">⏱️</div></div><div class="stat-value" id="maq-total-horas">0h</div><div class="stat-label">Horas Totales Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">💵</div></div><div class="stat-value" id="maq-total-ingreso">$0</div><div class="stat-label">Ingresos Generados</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">🔧</div></div><div class="stat-value" id="maq-total-costo">$0</div><div class="stat-label">Costos Operativos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">📈</div></div><div class="stat-value" id="maq-rentab-prom">0%</div><div class="stat-label">Rentabilidad Promedio</div></div>
      </div>

      <!-- KPI combustible -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">⛽</div></div><div class="stat-value" id="maq-combustible-total">0 Gal</div><div class="stat-label">Combustible Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">💰</div></div><div class="stat-value" id="maq-comb-costo">S/ 0</div><div class="stat-label">Costo Combustible</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">🛠️</div></div><div class="stat-value" id="maq-mantenim-count">0</div><div class="stat-label">Mantenimientos Este Mes</div></div>
      </div>

      <div class="machines-grid" id="machines-grid">
        <div class="empty-state" style="grid-column:1/-1;"><div class="icon">🚜</div><p>No hay equipos registrados.</p></div>
      </div>

      <!-- Historial de uso -->
      <div class="card" style="margin-top:16px;">
        <div class="card-header">
          <div><div class="card-title">📋 Historial de Uso y Combustible</div><div class="card-subtitle">Registro detallado por equipo</div></div>
          <div style="display:flex;gap:8px;align-items:center;">
            <select class="form-input" id="maq-hist-filtro" style="height:32px;padding:0 8px;font-size:12px;width:180px;" onchange="renderHistorialMaq()">
              <option value="">Todos los equipos</option>
            </select>
            <button class="btn btn-success btn-sm" onclick="exportHistorialMaqExcel()">📥 Excel</button>
            <button class="btn btn-primary btn-sm" onclick="openModal('uso-maquina')">＋ Registrar Uso</button>
          </div>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Fecha</th><th>Equipo</th><th>Proyecto</th><th>Horas</th><th>Combustible (Gal)</th><th>Costo Comb.</th><th>Operador</th><th>Tipo</th><th>Observación</th><th></th></tr></thead>
            <tbody id="historial-maq-table"><tr><td colspan="10" style="text-align:center;color:var(--muted);padding:24px;">Sin registros. Hacé clic en "+ Registrar Uso".</td></tr></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="historial-maq-mobile"></div>
      </div>
    </div>

    <!-- ===== OBRAS EN CURSO ===== -->
    <div class="page" id="page-obras">
      <div class="section-header">
        <div><div class="section-title">Parte Diario de Obra</div><div class="section-sub" id="obras-sub">Registro de actividad diaria en campo</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <input type="date" id="obras-fecha-filter" class="form-input" style="height:36px;padding:0 10px;width:150px;" onchange="renderObras()">
          <select id="obras-proyecto-filter" class="form-input" style="height:36px;padding:0 10px;" onchange="renderObras()">
            <option value="">Todos los proyectos</option>
          </select>
          <button class="btn btn-success btn-sm" onclick="exportPartesExcel()">📥 Excel</button>
          <button class="btn btn-primary" onclick="openModal('parte')">＋ Registrar Parte Diario</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:16px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">🏗️</div></div><div class="stat-value" id="ob-activas">0</div><div class="stat-label">Obras Activas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">👷</div></div><div class="stat-value" id="ob-obreros">0</div><div class="stat-label">Obreros Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">⏱️</div></div><div class="stat-value" id="ob-horas">0h</div><div class="stat-label">Horas Totales</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon purple">📋</div></div><div class="stat-value" id="ob-partes-hoy">0</div><div class="stat-label">Partes Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">⚠️</div></div><div class="stat-value" id="ob-incidencias">0</div><div class="stat-label">Incidencias</div></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div><div class="card-title">📋 Partes Diarios</div><div style="font-size:11px;color:var(--muted2);" id="obras-fecha-label">Hoy</div></div>
          <div style="font-size:12px;color:var(--muted2);" id="obras-total-label"></div>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Fecha</th><th>Proyecto</th><th>Cuadrilla / Capataz</th><th>Actividad</th><th>Obreros</th><th>Horas</th><th>Clima</th><th>Incidencia</th><th></th></tr></thead>
            <tbody id="obras-partes-table">
              <tr><td colspan="9" style="text-align:center;color:var(--muted);padding:28px;">Sin partes. Hacé clic en "＋ Registrar Parte Diario".</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="obras-partes-mobile"></div>
      </div>
    </div>

    <!-- ===== PRESUPUESTOS ===== -->
    <div class="page" id="page-presupuestos">
      <div class="section-header">
        <div><div class="section-title">Presupuestos</div><div class="section-sub" id="pres-sub">Gestión de ofertas y cotizaciones</div></div>
        <button class="btn btn-primary" onclick="openModal('presupuesto')">＋ Nuevo Presupuesto</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">📋</div></div><div class="stat-value" id="pres-total">0</div><div class="stat-label">Total Presupuestos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">✅</div></div><div class="stat-value" id="pres-aprobados">0</div><div class="stat-label">Aprobados</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">⏳</div></div><div class="stat-value" id="pres-revision">0</div><div class="stat-label">En Revisión</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">❌</div></div><div class="stat-value" id="pres-rechazados">0</div><div class="stat-label">Rechazados</div></div>
      </div>
      <div class="card">
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Presupuesto</th><th>Cliente</th><th>Monto (S/)</th><th>Fecha Envío</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="presupuestos-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay presupuestos registrados.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="presupuestos-mobile"></div>
      </div>
    </div>

    <!-- ===== MATERIALES ===== -->
    <div class="page" id="page-materiales">
      <div class="section-header">
        <div><div class="section-title">Control de Materiales</div><div class="section-sub">Inventario y movimientos</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportMaterialesExcel()">📥 Exportar</button>
          <button class="btn btn-primary" onclick="openModal('material')">＋ Registrar Movimiento</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="mat-stock-grid">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">🧱</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">48,200</div><div style="font-size:12px;color:var(--muted);">Ladrillos (u.)</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">🔩</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">84 ton</div><div style="font-size:12px;color:var(--muted);">Acero corrugado</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">🪣</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">620 bolsas</div><div style="font-size:12px;color:var(--muted);">Cemento Portland</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">🪨</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">320 m³</div><div style="font-size:12px;color:var(--muted);">Arena / Granza</div></div></div>
        <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">⚡</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--red);">12 rollos</div><div style="font-size:12px;color:var(--muted);">Cable eléct. ⚠️ Stock bajo</div></div></div>
        <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">🔧</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--red);">8 u.</div><div style="font-size:12px;color:var(--muted);">Tuberías PVC ⚠️ Stock bajo</div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Movimientos Recientes</div></div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Material</th><th>Tipo</th><th>Cantidad</th><th>Proyecto</th><th>Responsable</th><th>Fecha</th></tr></thead>
            <tbody id="materiales-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">Cargando movimientos...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="materiales-mobile"></div>
      </div>
    </div>

    <!-- ===== PROVEEDORES ===== -->
    <div class="page" id="page-proveedores">
      <div class="section-header">
        <div><div class="section-title">Proveedores</div><div class="section-sub" id="prov-sub">Gestión de proveedores activos</div></div>
        <button class="btn btn-primary" onclick="openModal('proveedor')">＋ Nuevo Proveedor</button>
      </div>

      <!-- KPIs proveedores -->
      <div class="prov-kpi-grid">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">🏪</div></div><div class="stat-value" id="prov-kpi-total">0</div><div class="stat-label">Total Proveedores</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">✅</div></div><div class="stat-value" id="prov-kpi-activos">0</div><div class="stat-label">Activos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">💰</div></div><div class="stat-value" id="prov-kpi-gasto">S/ 0</div><div class="stat-label">Gasto Total Año</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon purple">🔄</div></div><div class="stat-value" id="prov-kpi-transac">0</div><div class="stat-label">Transacciones Año</div></div>
      </div>

      <!-- Buscador -->
      <div class="card" style="margin-bottom:14px;padding:12px 14px;">
        <input type="text" class="form-input" id="prov-search" placeholder="🔍 Buscar proveedor por nombre o rubro..." oninput="filtrarProveedores()" style="width:100%;height:38px;">
      </div>

      <!-- Tabla desktop -->
      <div class="card">
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead>
              <tr>
                <th>Proveedor</th>
                <th>Rubro</th>
                <th>Contacto</th>
                <th>Última Compra</th>
                <th>Total Año</th>
                <th>Transacciones</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="proveedores-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">Cargando proveedores...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="proveedores-mobile"></div>
      </div>
    </div>

    <!-- ===== FACTURACIÓN ===== -->
    <div class="page" id="page-facturacion">
      <div class="section-header">
        <div><div class="section-title">Facturación</div><div class="section-sub">Control de facturas emitidas y cobros</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportFacturasExcel()">📥 Exportar</button>
          <button class="btn btn-primary" onclick="openModal('factura')">＋ Nueva Factura</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">💵</div><span class="stat-change up">▲ 14%</span></div><div class="stat-value" id="fac-mes">S/ 0</div><div class="stat-label">Facturado en el Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">⏳</div></div><div class="stat-value" id="fac-pendiente">S/ 0</div><div class="stat-label">Pendiente de Cobro</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">❌</div></div><div class="stat-value" id="fac-vencido">S/ 0</div><div class="stat-label">Vencido (+30 días)</div></div>
      </div>
      <div class="card">
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>N° Factura</th><th>Cliente</th><th>Proyecto</th><th>Monto</th><th>Fecha</th><th>Vence</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="facturas-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">Cargando facturas...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="facturas-mobile"></div>
      </div>
    </div>

    <!-- ===== REPORTES ===== -->
    <div class="page" id="page-reportes">
      <div class="section-header">
        <div><div class="section-title">Reportes & Analítica</div><div class="section-sub" id="rep-fecha">Datos actualizados</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-success btn-sm" onclick="exportReporteExcel()">📥 Excel</button>
          <button class="btn btn-primary btn-sm" onclick="exportReportePDF()">📄 PDF + Gantt</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">📊</div></div><div class="stat-value" id="rep-cartera">S/ 0</div><div class="stat-label">Cartera Total</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">✅</div><span class="stat-change up">▲ 18%</span></div><div class="stat-value" id="rep-cumplimiento">0%</div><div class="stat-label">Tasa de Cumplimiento</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">💹</div></div><div class="stat-value" id="rep-margen">23.4%</div><div class="stat-label">Margen Promedio</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">⏱️</div></div><div class="stat-value">+8 días</div><div class="stat-label">Desvío Promedio Plazo</div></div>
      </div>
      <!-- CHARTS GRID EN REPORTES -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <div class="card">
          <div class="card-header"><div><div class="card-title">Costos por Rubro</div><div class="card-subtitle">Mes actual — miles S/</div></div></div>
          <canvas id="rep-bar-chart" height="200" style="width:100%;"></canvas>
        </div>
        <div class="card">
          <div class="card-header"><div><div class="card-title">Avance por Proyecto</div><div class="card-subtitle">% completado vs meta</div></div></div>
          <canvas id="rep-hbar-chart" height="200" style="width:100%;"></canvas>
        </div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">Evolución de Facturación</div><div class="card-subtitle">Ingresos y cobros mensuales en S/</div></div>
        </div>
        <canvas id="rep-line-chart" height="130" style="width:100%;"></canvas>
      </div>

      <!-- GANTT -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">📅 Diagrama Gantt — Proyectos</div><div class="card-subtitle">Línea de tiempo de ejecución</div></div>
          <button class="btn btn-primary btn-sm" onclick="exportGanttPDF()">📄 Exportar Gantt PDF</button>
        </div>
        <div id="gantt-container" style="overflow-x:auto;padding:8px 0;"></div>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">Resumen Ejecutivo por Proyecto</div></div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Proyecto</th><th>Presupuesto</th><th>Ejecutado Est.</th><th>Desviación</th><th>Margen Est.</th><th>Avance Físico</th></tr></thead>
            <tbody id="reportes-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== ASISTENCIA ===== -->
    <!-- ===== ASISTENCIA ===== -->
    <div class="page" id="page-asistencia">
      <div class="section-header">
        <div>
          <div class="section-title">Control de Asistencia</div>
          <div class="section-sub" id="asist-sub">Parte diario del personal</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <input type="date" class="form-input" id="asist-fecha" style="height:36px;padding:0 10px;width:160px;" onchange="renderAsistencia()">
          <select id="asist-proyecto-filter" class="form-input" style="height:36px;padding:0 10px;max-width:180px;" onchange="renderAsistencia()">
            <option value="">Todos los proyectos</option>
          </select>
          <button class="btn btn-success btn-sm" onclick="exportAsistenciaExcel()">📥 Exportar</button>
          <button class="btn btn-primary btn-sm" onclick="guardarParteDiario()">💾 Guardar Parte</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">✅</div></div><div class="stat-value" id="asist-presentes">0</div><div class="stat-label">Presentes Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">❌</div></div><div class="stat-value" id="asist-ausentes">0</div><div class="stat-label">Ausentes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">⏰</div></div><div class="stat-value" id="asist-tardanza">0</div><div class="stat-label">Tardanzas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">📅</div></div><div class="stat-value" id="asist-tasa">0%</div><div class="stat-label">Tasa Asistencia</div></div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div class="card-title">Registro del Día</div>
        </div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Trabajador</th><th>Rol</th><th>Proyecto</th><th>Estado</th><th>H. Entrada</th><th>H. Extras</th><th>Observación</th></tr></thead>
            <tbody id="asist-table">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Seleccioná una fecha para ver el personal</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="asist-mobile"></div>
      </div>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Resumen Mensual</div>
          <select id="asist-mes-filter" class="form-input" style="max-width:180px;" onchange="renderResumenMensual()"></select>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Trabajador</th><th>Proyecto</th><th>Días Trabajados</th><th>Ausencias</th><th>Tardanzas</th><th>H. Extras Total</th><th>% Asistencia</th></tr></thead>
            <tbody id="asist-resumen-table">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Cargando resumen...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- ===== FLUJO DE CAJA ===== -->
    <div class="page" id="page-flujocaja">
      <div class="section-header">
        <div>
          <div class="section-title">Flujo de Caja</div>
          <div class="section-sub" id="flujo-sub">Ingresos y egresos por proyecto</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select class="form-input" id="flujo-proyecto-filter" style="height:36px;padding:0 10px;" onchange="renderFlujoCaja()">
            <option value="">Todos los proyectos</option>
          </select>
          <select class="form-input" id="flujo-mes-filter" style="height:36px;padding:0 10px;" onchange="renderFlujoCaja()">
            <option value="">Todos los meses</option>
          </select>
          <button class="btn btn-success btn-sm" onclick="exportFlujoCajaExcel()">📥 Excel</button>
          <button class="btn btn-primary" onclick="openModal('movimiento')">＋ Registrar Movimiento</button>
        </div>
      </div>
      <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">📈</div></div><div class="stat-value" id="flujo-ingresos">S/ 0</div><div class="stat-label">Ingresos del Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">📉</div></div><div class="stat-value" id="flujo-egresos">S/ 0</div><div class="stat-label">Egresos del Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">💰</div></div><div class="stat-value" id="flujo-saldo">S/ 0</div><div class="stat-label">Saldo Neto</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">🏦</div></div><div class="stat-value" id="flujo-acumulado">S/ 0</div><div class="stat-label">Saldo Acumulado</div></div>
      </div>
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div class="card-title">📊 Evolución Mensual</div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-ghost btn-sm" id="flujo-btn-todos" onclick="filtrarFlujo('todos')" style="font-weight:700;">Todos</button>
            <button class="btn btn-ghost btn-sm" id="flujo-btn-ingreso" onclick="filtrarFlujo('ingreso')" style="color:var(--green);">▲ Ingresos</button>
            <button class="btn btn-ghost btn-sm" id="flujo-btn-egreso" onclick="filtrarFlujo('egreso')" style="color:var(--red);">▼ Egresos</button>
          </div>
        </div>
        <canvas id="flujo-chart" height="120" style="width:100%;"></canvas>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">💳 Movimientos</div></div>
        <div class="table-wrap hide-on-mobile">
          <table>
            <thead><tr><th>Fecha</th><th>Proyecto</th><th>Categoría</th><th>Descripción</th><th>Tipo</th><th style="text-align:right;">Monto</th><th>Acciones</th></tr></thead>
            <tbody id="flujo-table"><tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Sin movimientos. Hacé clic en "+ Registrar Movimiento".</td></tr></tbody>
          </table>
        </div>
        <div class="mobile-cards" id="flujo-mobile"></div>
      </div>
    </div>

    <!-- ===== ALERTAS ===== -->
    <div class="page" id="page-alertas">
      <div class="section-header">
        <div>
          <div class="section-title">Centro de Alertas</div>
          <div class="section-sub" id="alertas-sub">Notificaciones automáticas del sistema</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="generarAlertas()">🔄 Actualizar</button>
      </div>
      <!-- Stat cards -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">🔴</div></div><div class="stat-value" id="cnt-alertas-criticas">0</div><div class="stat-label">Críticas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">🟡</div></div><div class="stat-value" id="cnt-alertas-advertencias">0</div><div class="stat-label">Advertencias</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">🔵</div></div><div class="stat-value" id="cnt-alertas-info">0</div><div class="stat-label">Informativas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">✅</div></div><div class="stat-value" id="cnt-alertas-leidas">0</div><div class="stat-label">Leídas</div></div>
      </div>
      <!-- Filter buttons -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
        <button class="btn btn-sm" onclick="filtrarAlertas('todas')" style="background:var(--bg3);border:1px solid var(--border);">Todas</button>
        <button class="btn btn-sm" onclick="filtrarAlertas('critica')" style="background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.3);">🔴 Críticas</button>
        <button class="btn btn-sm" onclick="filtrarAlertas('advertencia')" style="background:rgba(245,166,35,0.1);color:var(--accent);border:1px solid rgba(245,166,35,0.3);">🟡 Advertencias</button>
        <button class="btn btn-sm" onclick="filtrarAlertas('info')" style="background:rgba(59,130,246,0.1);color:var(--blue);border:1px solid rgba(59,130,246,0.3);">🔵 Info</button>
      </div>
      <div id="alertas-container">
        <div style="text-align:center;color:var(--muted);padding:40px;">
          <div style="font-size:48px;margin-bottom:12px;">🔔</div>
          <div style="font-size:14px;">Hacé clic en "🔄 Actualizar" para generar las alertas</div>
        </div>
      </div>
    </div>

    <!-- ===== COTIZADOR ===== -->
    <div class="page" id="page-cotizador">
      <div class="section-header">
        <div><div class="section-title">Cotizador de Proyectos</div><div class="section-sub">Calculá el costo antes de tu oferta</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" id="btn-volver-cotiz" onclick="ocultarFormCotiz()" style="display:none;">← Volver</button>
          <button class="btn btn-ghost btn-sm" onclick="nuevaCotizacion()">＋ Nueva Cotización</button>
          <button class="btn btn-success btn-sm" id="btn-export-cotiz" onclick="exportCotizExcel()" style="display:none;">📥 Excel</button>
          <button class="btn btn-primary" id="btn-pdf-cotiz" onclick="exportCotizPDF()" style="display:none;">📄 PDF</button>
        </div>
      </div>
      <div id="cotiz-lista-wrap">
        <div class="card"><div class="card-header"><div class="card-title">Cotizaciones Guardadas</div></div>
        <div id="cotiz-lista"><div style="text-align:center;color:var(--muted);padding:28px;">No hay cotizaciones. Hacé clic en "＋ Nueva Cotización".</div></div></div>
      </div>
      <div id="cotiz-form-wrap" style="display:none;">
        <div class="card" style="margin-bottom:16px;">
          <div class="card-header"><div class="card-title">📋 Datos del Proyecto</div></div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="cot-nombre" placeholder="Ej: Edificio 8 pisos"></div>
            <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="cot-cliente" placeholder="Nombre del cliente"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="cot-tipo"><option>Residencial</option><option>Comercial</option><option>Industrial</option><option>Vial</option><option>Institucional</option></select></div>
            <div class="form-group"><label class="form-label">Área</label><input type="text" class="form-input" id="cot-area" placeholder="Ej: 1,200 m²"></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label class="form-label">Duración (meses)</label><input type="number" class="form-input" id="cot-duracion" placeholder="18" min="1"></div>
            <div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input" id="cot-fecha"></div>
          </div>
          <div class="form-group"><label class="form-label">Descripción</label><textarea class="form-input" id="cot-descripcion" rows="2" placeholder="Alcance de la obra..."></textarea></div>
        </div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">🧱 Materiales</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('materiales')">＋</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Material</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-materiales"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL MATERIALES</td><td style="padding:10px 12px;font-weight:800;color:var(--accent);" id="sub-materiales">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">👷 Mano de Obra</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('manodeobra')">＋</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Rol</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-manodeobra"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL MANO DE OBRA</td><td style="padding:10px 12px;font-weight:800;color:var(--blue);" id="sub-manodeobra">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">🚜 Maquinaria</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('maquinaria')">＋</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Equipo</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-maquinaria"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL MAQUINARIA</td><td style="padding:10px 12px;font-weight:800;color:var(--purple);" id="sub-maquinaria">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" style="margin-bottom:16px;"><div class="card-header"><div><div class="card-title">🔌 Subcontratos</div></div><button class="btn btn-ghost btn-sm" onclick="addRubroRow('subcontratos')">＋</button></div>
          <div class="table-wrap"><table style="width:100%;"><thead><tr><th>Servicio</th><th>Unidad</th><th>Cant.</th><th>P.Unit</th><th>Subtotal</th><th></th></tr></thead><tbody id="tbody-subcontratos"></tbody>
          <tfoot><tr style="background:var(--bg3);"><td colspan="4" style="padding:10px 12px;font-weight:700;">SUBTOTAL SUBCONTRATOS</td><td style="padding:10px 12px;font-weight:800;color:var(--green);" id="sub-subcontratos">S/ 0</td><td></td></tr></tfoot></table></div></div>
        <div class="card" id="cotiz-resumen">
          <div class="card-header"><div class="card-title">💰 Resumen & Precio Final</div></div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">🧱 Materiales</span><b id="res-materiales">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">👷 Mano de Obra</span><b id="res-mdo">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">🚜 Maquinaria</span><b id="res-maq">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg3);border-radius:10px;"><span style="color:var(--muted2);">🔌 Subcontratos</span><b id="res-sub">S/ 0</b></div>
              <div style="display:flex;justify-content:space-between;padding:12px;background:var(--bg4);border-radius:10px;border:1px solid var(--border);"><b>Costo Directo</b><b id="res-costo-directo" style="font-size:16px;">S/ 0</b></div>
            </div>
            <div style="display:flex;flex-direction:column;gap:14px;">
              <div><label class="form-label">Gastos Generales (%)</label><div style="display:flex;align-items:center;gap:10px;"><input type="range" id="slider-gg" min="0" max="30" value="10" step="1" oninput="recalcResumen()" style="flex:1;accent-color:var(--accent);"><b style="color:var(--accent);min-width:40px;text-align:right;" id="val-gg">10%</b></div></div>
              <div><label class="form-label">Utilidad (%)</label><div style="display:flex;align-items:center;gap:10px;"><input type="range" id="slider-util" min="0" max="40" value="15" step="1" oninput="recalcResumen()" style="flex:1;accent-color:var(--green);"><b style="color:var(--green);min-width:40px;text-align:right;" id="val-util">15%</b></div></div>
              <div><label class="form-label">IGV (%)</label><div style="display:flex;align-items:center;gap:10px;"><input type="range" id="slider-igv" min="0" max="25" value="18" step="1" oninput="recalcResumen()" style="flex:1;accent-color:var(--blue);"><b style="color:var(--blue);min-width:40px;text-align:right;" id="val-igv">18%</b></div></div>
              <div style="background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(232,82,26,0.1));border:1px solid rgba(245,166,35,0.3);border-radius:14px;padding:20px;text-align:center;">
                <div style="font-size:11px;color:var(--muted2);font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;">PRECIO FINAL OFERTA</div>
                <div style="font-family:'Syne',sans-serif;font-weight:900;font-size:32px;color:var(--accent);" id="res-precio-final">S/ 0</div>
                <div style="font-size:11px;color:var(--muted);margin-top:6px;" id="res-desglose-final"></div>
              </div>
              <button class="btn btn-primary" style="width:100%;" onclick="guardarCotizacion()">💾 Guardar Cotización</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== USUARIOS & ROLES ===== -->
    <div class="page" id="page-usuarios">
      <div class="section-header">
        <div><div class="section-title">Usuarios & Roles</div><div class="section-sub" id="usuarios-sub">Gestión de accesos al sistema</div></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-ghost" onclick="abrirModalActividad()" style="border-color:rgba(59,130,246,0.4);color:var(--blue);">📋 Ver Actividad</button>
          <button class="btn btn-primary" onclick="openModal('usuario')">＋ Nuevo Usuario</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">👤</div></div><div class="stat-value" id="usr-total">0</div><div class="stat-label">Total Usuarios</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">🛡️</div></div><div class="stat-value" id="usr-admins">0</div><div class="stat-label">Administradores</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">✅</div></div><div class="stat-value" id="usr-activos">0</div><div class="stat-label">Activos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">🔒</div></div><div class="stat-value" id="usr-inactivos">0</div><div class="stat-label">Inactivos</div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Usuarios del Sistema</div></div>
        <div class="table-wrap hide-on-mobile">
          <table><thead><tr><th>Usuario</th><th>Rol</th><th>Proyecto Asignado</th><th>Último Acceso</th><th>Estado</th><th>Acciones</th></tr></thead>
          <tbody id="usuarios-table"><tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">Cargando usuarios...</td></tr></tbody></table>
        </div>
        <div class="mobile-cards" id="usuarios-mobile"></div>
      </div>
    </div>

    <!-- ===== PLANILLA DE SUELDOS ===== -->
    <div class="page" id="page-planilla">
      <div class="section-header">
        <div>
          <div class="section-title">Planilla de Sueldos</div>
          <div class="section-sub" id="planilla-sub">Cálculo automático según leyes peruanas</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
          <select class="form-input" id="planilla-mes" style="height:36px;padding:0 10px;width:160px;" onchange="calcularPlanilla()"></select>
          <button class="btn btn-success btn-sm" onclick="exportPlanillaExcel()">📥 Excel</button>
          <button class="btn btn-primary btn-sm" onclick="generarPlanillaPDF()">📄 PDF</button>
        </div>
      </div>

      <!-- Selector de período -->
      <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;align-items:center;">
        <span style="font-size:12px;color:var(--muted2);font-weight:600;">Período:</span>
        <button id="btn-periodo-mensual"   class="btn btn-primary btn-sm btn-periodo"   onclick="setPeriodo('mensual')">📅 Mensual</button>
        <button id="btn-periodo-quincenal" class="btn btn-ghost btn-sm btn-periodo"     onclick="setPeriodo('quincenal')">📅 Quincenal</button>
        <button id="btn-periodo-semanal"   class="btn btn-ghost btn-sm btn-periodo"     onclick="setPeriodo('semanal')">📅 Semanal</button>
        <span style="font-size:11px;color:var(--muted);margin-left:8px;">Las horas extras y descuentos se calculan en proporción al período</span>
      </div>

      <!-- KPIs -->
      <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:12px;margin-bottom:16px;" class="sub-stats-4">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">💰</div></div><div class="stat-value" id="plan-total-bruto">S/ 0</div><div class="stat-label">Total Bruto</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">📉</div></div><div class="stat-value" id="plan-total-desc">S/ 0</div><div class="stat-label">Descuentos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">💵</div></div><div class="stat-value" id="plan-total-neto">S/ 0</div><div class="stat-label">Total Neto</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">🏢</div></div><div class="stat-value" id="plan-total-aportes">S/ 0</div><div class="stat-label">Aportes Empresa</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">💸</div></div><div class="stat-value" id="plan-costo-total">S/ 0</div><div class="stat-label">Costo Total Empresa</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon purple">👷</div></div><div class="stat-value" id="plan-total-personal">0</div><div class="stat-label">Empleados</div></div>
      </div>

      <!-- Config -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div class="card-title">⚙️ Configuración de Empresa y Tasas</div>
          <button class="btn btn-ghost btn-sm" onclick="togglePlanillaConfig()">Mostrar/Ocultar</button>
        </div>
        <div id="planilla-config" style="display:none;">
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:8px 0;">
            <div class="form-group"><label class="form-label">Razón Social</label><input type="text" class="form-input" id="cfg-empresa" value="NorConstructores S.A.C." placeholder="Razón social"></div>
            <div class="form-group"><label class="form-label">RUC</label><input type="text" class="form-input" id="cfg-ruc" placeholder="20XXXXXXXXX"></div>
            <div class="form-group"><label class="form-label">EsSalud Empresa (%)</label><input type="number" class="form-input" id="cfg-essalud" value="9" min="0" max="15" step="0.1"></div>
          </div>
          <div style="font-size:11px;color:var(--muted2);background:var(--bg3);padding:10px;border-radius:8px;margin-top:4px;line-height:1.7;">
            <strong>Tasas aplicadas automáticamente (Perú 2024):</strong><br>
            ONP: 13% · AFP Aporte: 10% + Comisión ~1.5% + Seguro ~1.37% · EsSalud (empleador): 9%<br>
            CTS: 1/12 del sueldo mensual · Gratificación: 2 sueldos/año (1/6 mensual) · Horas extras: +25% primeras 2h, +35% adicionales<br>
            Recibo Honorarios: Retención 4ta categoría 8% si el monto supera S/ 1,500 en el período
          </div>
        </div>
      </div>

      <!-- Tabla -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">📋 Detalle por Empleado</div>
          <div style="font-size:12px;color:var(--muted2);" id="planilla-periodo-label">—</div>
        </div>
        <div class="table-wrap hide-on-mobile" style="overflow-x:auto;">
          <table style="min-width:1100px;">
            <thead><tr>
              <th>Empleado</th><th>Rol / AFP-ONP</th><th>Días</th><th>H.Extra</th>
              <th>Básico</th><th>H.Extra S/</th><th>Asig.Fam</th>
              <th style="color:var(--green);">BRUTO</th>
              <th style="color:var(--red);">Descuento</th>
              <th style="color:var(--accent);">EsSalud</th>
              <th style="color:var(--blue);">CTS</th>
              <th style="color:var(--purple);">Grat.</th>
              <th style="color:var(--green);font-weight:800;">NETO</th>
              <th style="color:var(--muted2);">Costo Emp.</th>
              <th>Boleta</th>
            </tr></thead>
            <tbody id="planilla-table">
              <tr><td colspan="15" style="text-align:center;color:var(--muted);padding:28px;">Seleccioná un mes para calcular la planilla.</td></tr>
            </tbody>
          </table>
        </div>
        <div class="mobile-cards" id="planilla-mobile"></div>
      </div>
    </div>

    <!-- ===== CONTRATOS & ACTAS ===== -->
    <div class="page" id="page-contratos">
      <div class="section-header">
        <div>
          <div class="section-title">Contratos & Actas</div>
          <div class="section-sub">Generación automática de documentos legales</div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-primary" onclick="openModal('nuevo-contrato')">＋ Nuevo Documento</button>
        </div>
      </div>

      <!-- Tipos de documento -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:24px;">
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(245,166,35,0.3);" onclick="abrirGeneradorContrato('obra')">
          <div class="stat-header"><div class="stat-icon orange">🏗️</div></div>
          <div class="stat-value" style="font-size:16px;">Contrato de Obra</div>
          <div class="stat-label">Entre empresa y cliente</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(59,130,246,0.3);" onclick="abrirGeneradorContrato('personal')">
          <div class="stat-header"><div class="stat-icon blue">👷</div></div>
          <div class="stat-value" style="font-size:16px;">Contrato de Personal</div>
          <div class="stat-label">Contrato laboral individual</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(34,197,94,0.3);" onclick="abrirGeneradorContrato('entrega')">
          <div class="stat-header"><div class="stat-icon green">✅</div></div>
          <div class="stat-value" style="font-size:16px;">Acta de Entrega</div>
          <div class="stat-label">Entrega final de obra al cliente</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(168,85,247,0.3);" onclick="abrirGeneradorContrato('subcontrato')">
          <div class="stat-header"><div class="stat-icon purple">🤝</div></div>
          <div class="stat-value" style="font-size:16px;">Subcontrato</div>
          <div class="stat-label">Con subcontratistas y terceros</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(239,68,68,0.3);" onclick="abrirGeneradorContrato('adicional')">
          <div class="stat-header"><div class="stat-icon red">📝</div></div>
          <div class="stat-value" style="font-size:16px;">Acta de Adicional</div>
          <div class="stat-label">Trabajos fuera del contrato original</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
        <div class="stat-card" style="cursor:pointer;border:1px solid rgba(6,182,212,0.3);" onclick="abrirGeneradorContrato('finiquito')">
          <div class="stat-header"><div class="stat-icon" style="background:rgba(6,182,212,0.15);color:#06b6d4;">📋</div></div>
          <div class="stat-value" style="font-size:16px;">Finiquito Laboral</div>
          <div class="stat-label">Liquidación al término del contrato</div>
          <div style="margin-top:10px;"><button class="btn btn-primary btn-sm" style="width:100%;">Generar PDF</button></div>
        </div>
      </div>

      <!-- Historial de documentos -->
      <div class="card">
        <div class="card-header"><div class="card-title">📁 Documentos Generados</div></div>
        <div id="contratos-historial">
          <div style="text-align:center;color:var(--muted);padding:32px;">
            Generá tu primer documento haciendo clic en uno de los tipos de arriba.
          </div>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>
</div><!-- /app -->

<!-- ===== MODALES ===== -->

<!-- MODAL GENERADOR DE CONTRATOS -->
<div class="modal-overlay" id="modal-nuevo-contrato">
  <div class="modal" style="max-width:620px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header">
      <div class="modal-title" id="contrato-modal-title">Generar Contrato</div>
      <button class="modal-close" onclick="closeModal('nuevo-contrato')">✕</button>
    </div>
    <input type="hidden" id="contrato-tipo">
    <div id="contrato-form-fields"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('nuevo-contrato')">Cancelar</button>
      <button class="btn btn-success btn-sm" onclick="previsualizarContrato()">👁 Previsualizar</button>
      <button class="btn btn-primary" onclick="generarContratoPDF()">📄 Generar PDF</button>
    </div>
  </div>
</div>

<!-- MODAL RECIBO SUELDO -->
<div class="modal-overlay" id="modal-recibo">
  <div class="modal" style="max-width:500px;">
    <div class="modal-header">
      <div class="modal-title">Recibo de Sueldo</div>
      <button class="modal-close" onclick="closeModal('recibo')">✕</button>
    </div>
    <div id="recibo-preview" style="background:#fff;color:#1e293b;padding:20px;border-radius:8px;font-family:Arial,sans-serif;font-size:12px;line-height:1.6;"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('recibo')">Cerrar</button>
      <button class="btn btn-primary" onclick="imprimirRecibo()">🖨️ Imprimir / PDF</button>
    </div>
  </div>
</div>

<!-- MODAL IMPORTAR EXCEL -->
<div class="modal-overlay" id="modal-importar">
  <div class="modal" style="max-width:560px;">
    <div class="modal-header">
      <div class="modal-title">📤 Importar desde Excel</div>
      <button class="modal-close" onclick="closeModal('importar')">✕</button>
    </div>
    <div class="form-group">
      <label class="form-label">¿Qué querés importar? *</label>
      <select class="form-input" id="import-tipo" onchange="updateImportTemplate()">
        <option value="personal">👷 Personal</option>
        <option value="proyectos">🏗️ Proyectos</option>
        <option value="maquinaria">🚜 Maquinaria</option>
        <option value="materiales">📦 Materiales</option>
        <option value="proveedores">🏪 Proveedores</option>
      </select>
    </div>
    <div style="background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:14px;border:1px solid var(--border);">
      <div style="font-size:12px;font-weight:700;color:var(--accent);margin-bottom:8px;">📋 Columnas requeridas:</div>
      <div id="import-columns" style="font-size:12px;color:var(--muted2);line-height:1.8;"></div>
      <button class="btn btn-ghost btn-sm" style="margin-top:10px;font-size:11px;" onclick="downloadImportTemplate()">⬇️ Descargar plantilla de ejemplo</button>
    </div>
    <div class="form-group">
      <label class="form-label">Archivo Excel (.xlsx, .xls, .csv) *</label>
      <input type="file" class="form-input" id="import-file" accept=".xlsx,.xls,.csv" onchange="previewImport(this)" style="padding:8px;">
    </div>
    <div id="import-preview" style="display:none;background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:14px;max-height:200px;overflow-y:auto;border:1px solid var(--border);">
      <div style="font-size:12px;font-weight:700;color:var(--green);margin-bottom:8px;" id="import-preview-title">Vista previa</div>
      <div id="import-preview-content"></div>
    </div>
    <div id="import-result" style="display:none;"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('importar')">Cancelar</button>
      <button class="btn btn-primary" id="import-btn" onclick="executeImport()" disabled>📤 Importar datos</button>
    </div>
  </div>
</div>

<!-- MODAL USO MAQUINARIA -->
<div class="modal-overlay" id="modal-uso-maquina">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-uso-title">Registrar Uso de Equipo</div>
      <button class="modal-close" onclick="closeModal('uso-maquina')">✕</button>
    </div>
    <input type="hidden" id="uso-edit-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Equipo *</label>
        <select class="form-input" id="uso-maquina-sel"></select>
      </div>
      <div class="form-group"><label class="form-label">Fecha *</label>
        <input type="date" class="form-input" id="uso-fecha">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo de registro</label>
        <select class="form-input" id="uso-tipo">
          <option value="uso">⚙️ Uso / Trabajo</option>
          <option value="combustible">⛽ Carga de combustible</option>
          <option value="mantenimiento">🔧 Mantenimiento</option>
          <option value="revision">🔍 Revisión técnica</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Proyecto</label>
        <select class="form-input" id="uso-proyecto">
          <option value="">— Sin proyecto —</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas trabajadas</label>
        <input type="number" class="form-input" id="uso-horas" value="0" min="0" max="24" step="0.5">
      </div>
      <div class="form-group"><label class="form-label">Combustible (galones)</label>
        <input type="number" class="form-input" id="uso-combustible" value="0" min="0" step="0.5">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Costo combustible (S/)</label>
        <input type="number" class="form-input" id="uso-costo-comb" value="0" min="0" step="0.01">
      </div>
      <div class="form-group"><label class="form-label">Operador</label>
        <input type="text" class="form-input" id="uso-operador" placeholder="Nombre del operador">
      </div>
    </div>
    <div class="form-group"><label class="form-label">Observación</label>
      <input type="text" class="form-input" id="uso-obs" placeholder="Novedades, incidencias, etc.">
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('uso-maquina')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveUsoMaquina()">💾 Guardar</button>
    </div>
  </div>
</div>

<!-- PROYECTO MODAL -->
<div class="modal-overlay" id="modal-proyecto">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-proyecto-title">Nuevo Proyecto</div>
      <button class="modal-close" onclick="closeModal('proyecto')">✕</button>
    </div>
    <input type="hidden" id="proyecto-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre del Proyecto *</label><input type="text" class="form-input" id="p-nombre" placeholder="Ej: Torre Central"></div>
      <div class="form-group"><label class="form-label">Tipo *</label>
        <select class="form-input" id="p-tipo">
          <option value="Residencial">Residencial</option>
          <option value="Comercial">Comercial</option>
          <option value="Industrial">Industrial</option>
          <option value="Infraestructura">Infraestructura</option>
          <option value="Institucional">Institucional</option>
          <option value="Vial">Vial</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="p-cliente" placeholder="Nombre del cliente"></div>
      <div class="form-group"><label class="form-label">Presupuesto (USD) *</label><input type="number" class="form-input" id="p-presupuesto" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha Inicio</label><input type="date" class="form-input" id="p-inicio"></div>
      <div class="form-group"><label class="form-label">Fecha Fin Est.</label><input type="date" class="form-input" id="p-fin"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Ubicación</label><input type="text" class="form-input" id="p-ubicacion" placeholder="Dirección de la obra"></div>
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="p-estado">
          <option value="pendiente">Pendiente / Iniciando</option>
          <option value="activo">Activo</option>
          <option value="progreso">En Curso</option>
          <option value="finalizado">Finalizado</option>
          <option value="pausado">Pausado</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Avance Físico (%)</label><input type="number" class="form-input" id="p-avance" placeholder="0" min="0" max="100"></div>
    <div class="form-group"><label class="form-label">Descripción</label><textarea class="form-input" id="p-descripcion" placeholder="Descripción del proyecto..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveProyecto()">Guardar Proyecto</button>
      <button class="btn btn-ghost" onclick="closeModal('proyecto')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PERSONAL MODAL -->
<div class="modal-overlay" id="modal-personal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-personal-title">Agregar Personal</div>
      <button class="modal-close" onclick="closeModal('personal')">✕</button>
    </div>
    <input type="hidden" id="emp-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre Completo *</label><input type="text" class="form-input" id="emp-nombre" placeholder="Nombre y apellido"></div>
      <div class="form-group"><label class="form-label">Cédula / DNI *</label><input type="text" class="form-input" id="emp-ci" placeholder="Ej: 1.234.567-8"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rol / Cargo *</label>
        <select class="form-input" id="emp-rol">
          <option>Albañil</option><option>Jefe de Cuadrilla</option><option>Electricista</option>
          <option>Plomero</option><option>Operador de Maquinaria</option><option>Carpintero</option>
          <option>Soldador</option><option>Pintor</option><option>Capataz</option>
          <option>Arquitecto</option><option>Ingeniero Civil</option><option>Administrador</option><option>Otro</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Cuadrilla</label><input type="text" class="form-input" id="emp-cuadrilla" placeholder="Ej: A-01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo de Contrato *</label>
        <select class="form-input" id="emp-tipo">
          <option value="planilla">En Planilla</option>
          <option value="contrato">Contrato</option>
          <option value="jornal">Jornalero</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Sueldo Base (S//mes)</label><input type="number" class="form-input" id="emp-sueldo" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas (mes)</label><input type="number" class="form-input" id="emp-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Proyecto Asignado</label>
        <select class="form-input" id="emp-proyecto"><option value="">Sin asignar</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Teléfono</label><input type="text" class="form-input" id="emp-tel" placeholder="Ej: 099 123 456"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="text" class="form-input" id="emp-email" placeholder="correo@ejemplo.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha de Contrato</label><input type="date" class="form-input" id="emp-fecha-contrato"></div>
      <div class="form-group"><label class="form-label">Fecha Fin de Contrato</label><input type="date" class="form-input" id="emp-fecha-fin"></div>
    </div>
    <!-- Planilla fields -->
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="form-group">
        <label class="form-label">Sistema de Pensión</label>
        <select class="form-input" id="emp-pension">
          <option value="ONP">ONP (13%)</option>
          <option value="Integra">AFP Integra</option>
          <option value="Prima">AFP Prima</option>
          <option value="Profuturo">AFP Profuturo</option>
          <option value="Habitat">AFP Habitat</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Asignación Familiar</label>
        <select class="form-input" id="emp-asig-familiar">
          <option value="no">No</option>
          <option value="si">Sí (S/ 102.50)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">N° Cuenta Banco</label>
        <input type="text" class="form-input" id="emp-cuenta" placeholder="CCI o N° cuenta">
      </div>
    </div>
    <div class="form-group"><label class="form-label">Dirección</label><input type="text" class="form-input" id="emp-dir" placeholder="Dirección del empleado"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="emp-obs" placeholder="Notas adicionales..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="savePersonal()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeModal('personal')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PERSONAL DETAIL MODAL -->
<div class="modal-overlay" id="modal-personal-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">Ficha del Empleado</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary btn-sm" onclick="generarBoletaPDF()">📄 Boleta PDF</button>
        <button class="btn btn-success btn-sm" onclick="exportPersonaExcel()">📥 Excel</button>
        <button class="btn btn-ghost btn-sm" id="btn-edit-emp" onclick="editPersonal()">✏️ Editar</button>
        <button class="modal-close" onclick="closeModal('personal-detail')">✕</button>
      </div>
    </div>
    <div id="personal-detail-content"></div>
  </div>
</div>

<!-- MAQUINA MODAL -->
<div class="modal-overlay" id="modal-maquina">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-maquina-title">Registrar Equipo</div>
      <button class="modal-close" onclick="closeModal('maquina')">✕</button>
    </div>
    <input type="hidden" id="maq-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre del Equipo *</label><input type="text" class="form-input" id="maq-nombre" placeholder="Ej: Grúa Torre #1"></div>
      <div class="form-group"><label class="form-label">Tipo</label>
        <select class="form-input" id="maq-tipo">
          <option>Grúa Torre</option><option>Retroexcavadora</option><option>Bulldozer</option>
          <option>Camión Volquete</option><option>Hormigonera</option><option>Compactadora</option>
          <option>Martillo Hidráulico</option><option>Cargador Frontal</option><option>Andamio Motorizado</option><option>Otro</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Modelo / Marca</label><input type="text" class="form-input" id="maq-modelo" placeholder="Ej: Caterpillar 320"></div>
      <div class="form-group"><label class="form-label">Matrícula / Código</label><input type="text" class="form-input" id="maq-matricula" placeholder="Ej: CAT-001"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas (mes)</label><input type="number" class="form-input" id="maq-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Tarifa por Hora (S/)</label><input type="number" class="form-input" id="maq-tarifa" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Costo Operativo/Hora (S/)</label><input type="number" class="form-input" id="maq-costo-hora" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Proyecto Asignado</label>
        <select class="form-input" id="maq-proyecto"><option value="">Sin asignar</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="maq-estado">
          <option value="activo">Operativo</option>
          <option value="pausado">En Mantenimiento</option>
          <option value="pendiente">Reservado</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Próximo Mantenimiento</label><input type="date" class="form-input" id="maq-mantenim"></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="maq-obs" placeholder="Notas..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveMaquina()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeModal('maquina')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MAQUINA DETAIL MODAL -->
<div class="modal-overlay" id="modal-maquina-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">Detalle del Equipo</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-success btn-sm" onclick="exportMaquinaExcel()">📥 Excel</button>
        <button class="btn btn-ghost btn-sm" id="btn-edit-maq" onclick="editMaquina()">✏️ Editar</button>
        <button class="modal-close" onclick="closeModal('maquina-detail')">✕</button>
      </div>
    </div>
    <div id="maquina-detail-content"></div>
  </div>
</div>

<!-- USUARIO MODAL -->
<div class="modal-overlay" id="modal-usuario">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-usr-title">Nuevo Usuario</div>
      <button class="modal-close" onclick="closeModal('usuario')">✕</button>
    </div>
    <input type="hidden" id="usr-id">
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Nombre completo *</label>
        <input type="text" class="form-input" id="usr-nombre" placeholder="Ej: Juan Pérez">
      </div>
      <div class="form-group">
        <label class="form-label">Usuario (login) *</label>
        <input type="text" class="form-input" id="usr-user" placeholder="Ej: jperez" autocomplete="off">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Contraseña *</label>
        <input type="password" class="form-input" id="usr-pass" placeholder="Mín. 4 caracteres" autocomplete="new-password">
      </div>
      <div class="form-group">
        <label class="form-label">Confirmar contraseña</label>
        <input type="password" class="form-input" id="usr-pass2" placeholder="Repetir contraseña" autocomplete="new-password">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Rol *</label>
        <select class="form-input" id="usr-rol" onchange="updateRolDescription()">
          <option value="">Seleccionar rol...</option>
          <option value="admin">👑 Administrador — Acceso total</option>
          <option value="supervisor">🔍 Supervisor — Ve todo, gestiona obras</option>
          <option value="capataz">👷 Capataz — Parte diario, su cuadrilla</option>
          <option value="contador">💼 Contador — Finanzas y presupuestos</option>
          <option value="cliente">👁 Cliente — Solo su proyecto</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Proyecto asignado</label>
        <select class="form-input" id="usr-proyecto">
          <option value="">Todos los proyectos</option>
        </select>
      </div>
    </div>
    <div id="usr-rol-desc" style="background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--muted2);display:none;"></div>
    <div class="form-group">
      <label class="form-label">Email</label>
      <input type="email" class="form-input" id="usr-email" placeholder="correo@empresa.com">
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveUsuario()">Guardar Usuario</button>
      <button class="btn btn-ghost" onclick="closeModal('usuario')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PRESUPUESTO MODAL -->
<div class="modal-overlay" id="modal-presupuesto">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modal-pres-title">Nuevo Presupuesto</div><button class="modal-close" onclick="closeModal('presupuesto')">✕</button></div>
    <input type="hidden" id="pres-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre / Descripción *</label><input type="text" class="form-input" id="pres-nombre" placeholder="Ej: Residencial La Cañada"></div>
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="pres-cliente" placeholder="Nombre del cliente"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Monto (S/) *</label><input type="number" class="form-input" id="pres-monto" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Fecha Envío</label><input type="date" class="form-input" id="pres-fecha"></div>
    </div>
    <div class="form-group"><label class="form-label">Estado</label>
      <select class="form-input" id="pres-estado">
        <option value="revision">En Revisión</option><option value="aprobado">Aprobado</option>
        <option value="negociacion">Negociación</option><option value="rechazado">Rechazado</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="pres-obs" placeholder="Notas..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="savePresupuesto()">Guardar</button><button class="btn btn-ghost" onclick="closeModal('presupuesto')">Cancelar</button></div>
  </div>
</div>

<!-- FACTURA MODAL -->
<div class="modal-overlay" id="modal-factura">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Nueva Factura</div><button class="modal-close" onclick="closeModal('factura')">✕</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">N° Factura *</label><input type="text" class="form-input" id="fac-numero" placeholder="Ej: #2025-0900"></div>
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="fac-cliente" placeholder="Nombre del cliente"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="fac-proyecto"><option value="">Sin asignar</option></select></div>
      <div class="form-group"><label class="form-label">Monto (S/) *</label><input type="number" class="form-input" id="fac-monto" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha Emisión</label><input type="date" class="form-input" id="fac-fecha"></div>
      <div class="form-group"><label class="form-label">Fecha Vencimiento</label><input type="date" class="form-input" id="fac-vence"></div>
    </div>
    <div class="form-group"><label class="form-label">Estado</label>
      <select class="form-input" id="fac-estado"><option value="pendiente">Pendiente</option><option value="activo">Cobrada</option><option value="pausado">Vencida</option></select>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveFactura()">Guardar Factura</button><button class="btn btn-ghost" onclick="closeModal('factura')">Cancelar</button></div>
  </div>
</div>

<!-- PROVEEDOR MODAL -->
<div class="modal-overlay" id="modal-proveedor">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Nuevo Proveedor</div><button class="modal-close" onclick="closeModal('proveedor')">✕</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="prov-nombre" placeholder="Nombre de la empresa"></div>
      <div class="form-group"><label class="form-label">RUT / RUC</label><input type="text" class="form-input" id="prov-rut" placeholder="Ej: 21234567891"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rubro</label><input type="text" class="form-input" id="prov-rubro" placeholder="Ej: Hormigón Pronto"></div>
      <div class="form-group"><label class="form-label">Teléfono</label><input type="text" class="form-input" id="prov-tel" placeholder="Ej: 098 123 456"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveProveedor()">Guardar</button><button class="btn btn-ghost" onclick="closeModal('proveedor')">Cancelar</button></div>
  </div>
</div>

<!-- MATERIAL MODAL -->
<div class="modal-overlay" id="modal-material">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Registrar Movimiento de Material</div><button class="modal-close" onclick="closeModal('material')">✕</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Material *</label><input type="text" class="form-input" id="mat-nombre" placeholder="Ej: Cemento Portland"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="mat-tipo"><option value="ENTRADA">ENTRADA</option><option value="SALIDA">SALIDA</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Cantidad</label><input type="text" class="form-input" id="mat-cantidad" placeholder="Ej: 200 bolsas"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="mat-proyecto"><option value="">Sin asignar</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Responsable</label><input type="text" class="form-input" id="mat-resp" placeholder="Nombre del responsable"></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveMaterial()">Registrar</button><button class="btn btn-ghost" onclick="closeModal('material')">Cancelar</button></div>
  </div>
</div>

<!-- PARTE DIARIO MODAL -->
<div class="modal-overlay" id="modal-parte">
  <div class="modal" style="max-width:600px;">
    <div class="modal-header">
      <div class="modal-title">📋 Registrar Parte Diario</div>
      <button class="modal-close" onclick="closeModal('parte')">✕</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="form-group"><label class="form-label">Proyecto *</label>
        <select class="form-input" id="parte-proyecto"><option value="">Seleccionar...</option></select></div>
      <div class="form-group"><label class="form-label">Fecha *</label>
        <input type="date" class="form-input" id="parte-fecha"></div>
      <div class="form-group"><label class="form-label">Cuadrilla</label>
        <input type="text" class="form-input" id="parte-cuadrilla" placeholder="Ej: Cuadrilla A"></div>
      <div class="form-group"><label class="form-label">Capataz Responsable</label>
        <input type="text" class="form-input" id="parte-capataz" placeholder="Nombre del capataz"></div>
    </div>
    <div class="form-group"><label class="form-label">Actividad Realizada *</label>
      <input type="text" class="form-input" id="parte-actividad" placeholder="Ej: Vaciado de losa piso 3, encofrado columnas..."></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
      <div class="form-group"><label class="form-label">N° Obreros</label>
        <input type="number" class="form-input" id="parte-obreros" placeholder="0" min="0"></div>
      <div class="form-group"><label class="form-label">Horas Trabajadas</label>
        <input type="number" class="form-input" id="parte-horas" placeholder="8" min="0" step="0.5"></div>
      <div class="form-group"><label class="form-label">Clima</label>
        <select class="form-input" id="parte-clima">
          <option>☀️ Despejado</option><option>⛅ Nublado</option>
          <option>🌧️ Lluvia</option><option>💨 Viento fuerte</option><option>🌩️ Tormenta</option>
        </select></div>
    </div>
    <div class="form-group"><label class="form-label">Materiales Utilizados</label>
      <input type="text" class="form-input" id="parte-materiales" placeholder="Ej: 2m³ concreto, 50kg acero..."></div>
    <div class="form-group"><label class="form-label">Maquinaria Utilizada</label>
      <input type="text" class="form-input" id="parte-maquinaria" placeholder="Ej: Mezcladora, andamios..."></div>
    <div class="form-group">
      <label class="form-label">Incidencia / Novedad</label>
      <div style="display:flex;gap:8px;margin-bottom:6px;">
        <button type="button" id="btn-inc-no" class="btn btn-ghost btn-sm" style="background:var(--bg4);" onclick="toggleIncidencia(false)">✅ Sin incidencia</button>
        <button type="button" id="btn-inc-si" class="btn btn-ghost btn-sm" onclick="toggleIncidencia(true)">⚠️ Registrar incidencia</button>
      </div>
      <textarea class="form-input" id="parte-incidencia" style="display:none;height:56px;" placeholder="Describí la incidencia, accidente o novedad..."></textarea>
    </div>
    <div class="form-group"><label class="form-label">Observaciones Generales</label>
      <textarea class="form-input" id="parte-obs" style="height:56px;" placeholder="Notas adicionales, avance del día..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveParte()">💾 Guardar Parte</button>
      <button class="btn btn-ghost" onclick="closeModal('parte')">Cancelar</button>
    </div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<!-- ===== MODAL DETALLE PROVEEDOR ===== -->
<div class="modal-overlay" id="modal-detalle-proveedor">
  <div class="modal modal-lg" style="max-width:700px;">
    <div class="modal-header">
      <div style="display:flex;align-items:center;gap:12px;">
        <div id="dprov-avatar" style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,rgba(245,166,35,0.3),rgba(232,82,26,0.2));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:16px;color:var(--accent);flex-shrink:0;">NC</div>
        <div>
          <div class="modal-title" id="dprov-nombre">Proveedor</div>
          <div style="font-size:12px;color:var(--muted2);" id="dprov-sub">Rubro · RUC</div>
        </div>
      </div>
      <button class="modal-close" onclick="document.getElementById('modal-detalle-proveedor').classList.remove('open')">✕</button>
    </div>

    <!-- KPIs -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;">
      <div style="background:var(--bg3);border-radius:12px;padding:14px;text-align:center;">
        <div style="font-size:11px;color:var(--muted2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;">Total Pagado</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:var(--accent);" id="dprov-total">S/ 0</div>
      </div>
      <div style="background:var(--bg3);border-radius:12px;padding:14px;text-align:center;">
        <div style="font-size:11px;color:var(--muted2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;">Transacciones</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:var(--blue);" id="dprov-transac">0</div>
      </div>
      <div style="background:var(--bg3);border-radius:12px;padding:14px;text-align:center;">
        <div style="font-size:11px;color:var(--muted2);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;">Promedio/Operación</div>
        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:20px;color:var(--green);" id="dprov-promedio">S/ 0</div>
      </div>
    </div>

    <!-- Gráfico barras por mes -->
    <div style="background:var(--bg3);border-radius:12px;padding:14px;margin-bottom:16px;">
      <div style="font-size:12px;font-weight:700;color:var(--muted2);margin-bottom:10px;">📈 Gastos por mes — <span id="dprov-anio">2026</span></div>
      <canvas id="dprov-chart" height="80"></canvas>
    </div>

    <!-- Historial de movimientos -->
    <div style="background:var(--bg3);border-radius:12px;padding:14px;">
      <div style="font-size:13px;font-weight:700;margin-bottom:12px;">📋 Historial de Movimientos</div>
      <div style="overflow-x:auto;max-height:260px;overflow-y:auto;">
        <table style="width:100%;min-width:480px;">
          <thead>
            <tr style="background:var(--bg4);">
              <th style="padding:8px 10px;font-size:11px;color:var(--muted2);text-align:left;font-weight:600;">Fecha</th>
              <th style="padding:8px 10px;font-size:11px;color:var(--muted2);text-align:left;font-weight:600;">Tipo</th>
              <th style="padding:8px 10px;font-size:11px;color:var(--muted2);text-align:left;font-weight:600;">Categoría</th>
              <th style="padding:8px 10px;font-size:11px;color:var(--muted2);text-align:left;font-weight:600;">Descripción</th>
              <th style="padding:8px 10px;font-size:11px;color:var(--muted2);text-align:right;font-weight:600;">Monto</th>
            </tr>
          </thead>
          <tbody id="dprov-historial"></tbody>
        </table>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:10px;text-align:right;" id="dprov-historial-sub"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-confirm">
  <div class="modal confirm-modal">
    <div class="modal-header"><div class="modal-title">⚠️ Confirmar Eliminación</div><button class="modal-close" onclick="closeModal('confirm')">✕</button></div>
    <p style="color:var(--muted2);font-size:14px;margin-bottom:20px;" id="confirm-msg">¿Estás seguro de que querés eliminar este registro? Esta acción no se puede deshacer.</p>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-danger" style="flex:1" id="confirm-ok">Sí, Eliminar</button>
      <button class="btn btn-ghost" onclick="closeModal('confirm')">Cancelar</button>
    </div>
  </div>
</div>


<!-- ═══ MODAL PARTIDAS DE PROYECTO ═══ -->
<div class="modal-overlay" id="modal-partidas">
  <div class="modal" style="max-width:580px;max-height:90vh;overflow-y:auto;">
    <div class="modal-header">
      <div class="modal-title" id="modal-partidas-title">📋 Partidas del Proyecto</div>
      <button class="modal-close" onclick="document.getElementById('modal-partidas').classList.remove('open')">✕</button>
    </div>

    <!-- Avance preview -->
    <div id="partidas-avance-preview" style="margin-bottom:16px;"></div>

    <!-- Plantillas rápidas -->
    <div style="margin-bottom:14px;">
      <div style="font-size:11px;color:var(--muted2);margin-bottom:6px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Cargar plantilla estándar</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="cargarPlantilla('Residencial')">🏠 Residencial</button>
        <button class="btn btn-ghost btn-sm" onclick="cargarPlantilla('Comercial')">🏢 Comercial</button>
        <button class="btn btn-ghost btn-sm" onclick="cargarPlantilla('Vial')">🛣️ Vial</button>
        <button class="btn btn-ghost btn-sm" onclick="cargarPlantilla('Industrial')">🏭 Industrial</button>
      </div>
    </div>

    <!-- Lista partidas -->
    <div id="partidas-lista" style="margin-bottom:16px;"></div>

    <!-- Agregar nueva -->
    <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
      <div style="font-size:12px;font-weight:700;margin-bottom:10px;color:var(--muted2);">➕ NUEVA PARTIDA</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <input type="text" id="nueva-partida-nombre" class="form-input" placeholder="Nombre (ej: Cimentación)" style="flex:2;min-width:160px;">
        <div style="display:flex;align-items:center;gap:6px;flex:1;min-width:100px;">
          <input type="number" id="nueva-partida-peso" class="form-input" placeholder="Peso%" value="10" min="1" max="100" style="width:70px;">
          <span style="font-size:12px;color:var(--muted2);">% peso</span>
        </div>
        <button class="btn btn-primary btn-sm" onclick="agregarPartidaUI()">Agregar</button>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:6px;">El peso indica cuánto representa esta partida del total (ej: Estructura = 30%)</div>
    </div>
  </div>
</div>

<!-- MODAL ACTIVIDAD -->
<div class="modal-overlay" id="modal-actividad" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div>
        <div class="modal-title">📋 Registro de Actividad</div>
        <div style="font-size:12px;color:var(--muted);margin-top:3px;">Historial de ingresos y cierres de sesión</div>
      </div>
      <button class="modal-close" onclick="document.getElementById('modal-actividad').classList.remove('open')">✕</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
      <select id="act-filtro-usuario" class="form-input" style="flex:1;min-width:140px;height:36px;" onchange="renderModalActividad()">
        <option value="">Todos los usuarios</option>
      </select>
      <select id="act-filtro-tipo" class="form-input" style="flex:1;min-width:140px;height:36px;" onchange="renderModalActividad()">
        <option value="">Todos los eventos</option>
        <option value="login">Ingresos</option>
        <option value="logout">Cierres de sesión</option>
        <option value="acceso_denegado">Acceso denegado</option>
      </select>
      <button class="btn btn-danger btn-sm" onclick="limpiarRegistroActividad()" style="height:36px;">🗑 Limpiar</button>
    </div>
    <div id="act-lista" style="display:flex;flex-direction:column;gap:8px;max-height:420px;overflow-y:auto;padding-right:4px;">
      <p style="color:var(--muted);text-align:center;padding:32px;font-size:13px;">Sin actividad registrada aún.</p>
    </div>
    <div style="margin-top:14px;padding-top:14px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;">
      <span id="act-total" style="font-size:12px;color:var(--muted);">0 eventos</span>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('modal-actividad').classList.remove('open')">Cerrar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-title" id="toast-title"></div>
  <div class="toast-msg" id="toast-msg"></div>
</div>

<!-- MODAL MOVIMIENTO FLUJO CAJA -->
<div class="modal-overlay" id="modal-movimiento">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="mov-modal-title">Registrar Movimiento</div>
      <button class="modal-close" onclick="document.getElementById('modal-movimiento').classList.remove('open')">✕</button>
    </div>
    <input type="hidden" id="mov-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo *</label>
        <select id="mov-tipo" class="form-input">
          <option value="ingreso">▲ Ingreso</option>
          <option value="egreso">▼ Egreso</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Monto (S/) *</label>
        <input type="number" id="mov-monto" class="form-input" placeholder="0.00" min="0" step="0.01">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Categoría</label>
        <select id="mov-categoria" class="form-input" onchange="toggleProveedorField(this.value)">
          <option value="cobro_cliente">Cobro cliente</option>
          <option value="anticipo">Anticipo</option>
          <option value="pago_proveedor">Pago proveedor</option>
          <option value="planilla">Planilla</option>
          <option value="maquinaria">Maquinaria</option>
          <option value="materiales">Materiales</option>
          <option value="gastos_generales">Gastos generales</option>
          <option value="impuestos">Impuestos</option>
          <option value="otro">Otro</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Fecha *</label>
        <input type="date" id="mov-fecha" class="form-input">
      </div>
    </div>
    <div class="form-group"><label class="form-label">Proyecto</label>
      <select id="mov-proyecto" class="form-input">
        <option value="">Sin proyecto específico</option>
      </select>
    </div>
    <div class="form-group" id="mov-proveedor-wrap" style="display:none;">
      <label class="form-label">Proveedor</label>
      <select id="mov-proveedor" class="form-input">
        <option value="">— Seleccionar proveedor —</option>
      </select>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Descripción</label>
        <input type="text" id="mov-descripcion" class="form-input" placeholder="Descripción del movimiento...">
      </div>
      <div class="form-group"><label class="form-label">Referencia / Nº Doc.</label>
        <input type="text" id="mov-referencia" class="form-input" placeholder="Ej: FAC-001">
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="guardarMovimiento()">💾 Guardar</button>
      <button class="btn btn-ghost" onclick="document.getElementById('modal-movimiento').classList.remove('open')">Cancelar</button>
    </div>
  </div>
</div>

<script>
// ===================== SUPABASE CONFIG =====================
// IMPORTANTE: La SB_KEY debe ser la "anon public key" de tu proyecto Supabase
// Formato correcto: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
// La encontrás en: Supabase → Settings → API → "anon public"
const SB_URL = 'https://kvyaksujublfwbgkarnf.supabase.co';
const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2eWFrc3VqdWJsZndiZ2thcm5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMDYxNjcsImV4cCI6MjA4Nzc4MjE2N30.45cU843djkRkdudCPPpGFCtbjkWS_vGe6R8vWHWXFzU';

async function sbFetch(path, opts = {}) {
  const res = await fetch(SB_URL + '/rest/v1/' + path, {
    headers: {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Content-Type': 'application/json',
      'Prefer': opts.prefer || 'return=representation',
      ...opts.headers
    },
    method: opts.method || 'GET',
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  if (!res.ok) {
    const errText = await res.text();
    let errMsg = 'Error ' + res.status;
    if (res.status === 401) errMsg = 'API Key inválida — actualizá SB_KEY con la "anon public key" de tu proyecto Supabase';
    else if (res.status === 0 || !res.status) errMsg = 'Sin conexión a internet';
    throw new Error(errMsg + ': ' + errText.slice(0,100));
  }
  const text = await res.text();
  return text ? JSON.parse(text) : [];
}

// ===================== DATA STORE =====================
let db = {
  proyectos: [],
  personal: [],
  maquinaria: [],
  presupuestos: [],
  facturas: [],
  proveedores: [],
  materiales: []
};

// ── Aliases globales ──────────────────────────────────────────────────────────
// Las funciones de Asistencia, Flujo de Caja y Alertas usan las variables
// "proyectos", "personal", etc. directamente. Con defineProperty hacemos que
// esas variables siempre apunten a db.xxx sin tener que tocar cada función.
['proyectos','personal','maquinaria','presupuestos','facturas','materiales','proveedores'].forEach(key => {
  Object.defineProperty(window, key, { get: () => db[key], configurable: true });
});
// ─────────────────────────────────────────────────────────────────────────────

let currentPersonalId = null;
let currentMaquinaId = null;
let currentFilter = { proyectos: 'todos', personal: '', personalStatus: '' };

// ===================== AUTH =====================
const USERS = [{ user: 'admin', pass: '1234', name: 'Administrador', initials: 'AD' }];

function doLogin() {
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value.trim();

  // 1. Check custom app users (from Supabase, already loaded in cache or local fallback)
  // Try to load from local cache first for fast login, Supabase sync happens after
  let localUsers = [];
  try { localUsers = JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); } catch(e) {}
  const appUser = localUsers.find(x => x.user === u && x.pass === p && x.activo !== false);

  // 2. Check built-in admin
  const found = USERS.find(x => x.user === u && x.pass === p);

  if (!appUser && !found) {
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-pass').value = '';
    return;
  }

  const userName = appUser ? appUser.nombre : found.name;
  const userInitials = appUser ? (appUser.nombre||u).split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase() : found.initials;
  const effectiveRole = appUser ? appUser.rol : 'admin';

  document.getElementById('sidebar-name').textContent = userName;
  document.getElementById('sidebar-avatar').textContent = userInitials;
  document.getElementById('login-error').style.display = 'none';
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');

  // Store session
  window._sessionRole = effectiveRole;
  window._sessionUser = u;

  registrarActividad('login', u, effectiveRole, 'Ingreso al sistema');

  showLoading(true);
  loadAllData().then(() => {
    showLoading(false);
    // Forzar navegación al Dashboard para limpiar cualquier página anterior abierta
    nav('dashboard', document.querySelector(".nav-item[onclick*=\"nav('dashboard'\"]"));
    setTimeout(() => applyRolePermissions(effectiveRole), 80);
    setTimeout(initDashCharts, 150);
    setTimeout(() => { applyResponsiveClasses(); makeTablesResponsive(); }, 220);
    toast('¡Bienvenido, ' + userName + '!', 'Rol: ' + effectiveRole);
    setTimeout(checkContractAlerts, 1500);
  }).catch(err => {
    showLoading(false);
    // Don't block login on connection error — show warning but continue
    toast('⚠️ Sin conexión a BD', 'Trabajando con datos locales', 'warn');
    nav('dashboard', document.querySelector(".nav-item[onclick*=\"nav('dashboard'\"]"));
    setTimeout(initDashCharts, 150);
    setTimeout(() => { applyResponsiveClasses(); makeTablesResponsive(); }, 220);
    setTimeout(() => applyRolePermissions(effectiveRole), 80);
    console.error('Supabase error:', err);
  });
}

document.getElementById('login-pass').addEventListener('keydown', e => { if(e.key === 'Enter') doLogin(); });
document.getElementById('login-user').addEventListener('keydown', e => { if(e.key === 'Enter') document.getElementById('login-pass').focus(); });

function doLogout() {
  // 1. Volver al Dashboard ANTES de ocultar la app
  //    — así el próximo usuario nunca verá una sección que no le corresponde
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const dashPage = document.getElementById('page-dashboard');
  if (dashPage) dashPage.classList.add('active');

  // 2. Cerrar cualquier modal que esté abierto
  document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));

  // 3. Resetear título topbar
  const titleEl = document.getElementById('page-title');
  if (titleEl) titleEl.textContent = 'Dashboard General';

  // 4. Restaurar visibilidad de TODOS los nav-items (por si estaban ocultos por rol)
  document.querySelectorAll('.nav-item').forEach(el => el.style.display = '');

  // 5. Registrar logout ANTES de limpiar
  if (window._sessionUser) { registrarActividad('logout', window._sessionUser, window._sessionRole||'—', 'Cierre de sesión'); }
  window._sessionRole  = null;
  window._sessionUser  = null;
  window._roleAllowed  = null;

  // 6. Mostrar login / ocultar app
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').style.display = 'none';

  // 7. Limpiar datos en memoria
  db = { proyectos:[], personal:[], maquinaria:[], presupuestos:[], facturas:[], proveedores:[], materiales:[] };
}

function showLoading(show) {
  let el = document.getElementById('loading-overlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loading-overlay';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(13,15,18,0.85);z-index:998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;';
    el.innerHTML = '<div style="width:44px;height:44px;border:3px solid rgba(245,166,35,0.2);border-top-color:#f5a623;border-radius:50%;animation:spin 0.8s linear infinite;"></div><div style="font-family:Syne,sans-serif;font-size:14px;color:#94a3b8;">Cargando datos...</div><style>@keyframes spin{to{transform:rotate(360deg);}}</style>';
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

// ===================== LOAD ALL DATA FROM SUPABASE =====================
async function loadAllData() {
  let proyectos=[], personal=[], maquinaria=[], presupuestos=[], facturas=[], proveedores=[], materiales=[];
  try {
    [proyectos, personal, maquinaria, presupuestos, facturas, proveedores, materiales] = await Promise.all([
      sbFetch('proyectos?order=created_at.desc'),
      sbFetch('personal?order=created_at.desc'),
      sbFetch('maquinaria?order=created_at.desc'),
      sbFetch('presupuestos?order=created_at.desc'),
      sbFetch('facturas?order=created_at.desc'),
      sbFetch('proveedores?order=created_at.desc'),
      sbFetch('materiales?order=created_at.desc&limit=50'),
    ]);
  } catch(err) {
    console.warn('Supabase no disponible, trabajando offline:', err.message);
    refreshAll();
    throw err; // Re-throw so doLogin can show soft warning
  }

  // Map Supabase column names to app field names
  db.proyectos = proyectos.map(p => ({
    id: p.id, nombre: p.nombre, tipo: p.tipo, cliente: p.cliente,
    presupuesto: p.presupuesto, avance: p.avance, estado: p.estado,
    inicio: p.inicio, fin: p.fin,
    fechaFin: p.fin,        // alias usado por alertas
    fecha_fin: p.fin,       // alias alternativo
    ubicacion: p.ubicacion, descripcion: p.descripcion
  }));

  db.personal = personal.map(e => ({
    id: e.id, nombre: e.nombre, ci: e.ci, rol: e.rol, cuadrilla: e.cuadrilla,
    tipo: e.tipo, sueldo: e.sueldo, horas: e.horas,
    estado: e.estado || 'activo',
    proyecto: e.proyecto_id, tel: e.telefono, email: e.email, dir: e.direccion, obs: e.observaciones,
    fechaContrato: e.fecha_contrato, fechaFin: e.fecha_fin_contrato,
    pension: e.sistema_pension || 'ONP',
    asigFamiliar: e.asig_familiar || false,
    cuenta: e.cuenta_banco || ''
  }));

  db.maquinaria = maquinaria.map(m => ({
    id: m.id, nombre: m.nombre, tipo: m.tipo, modelo: m.modelo, matricula: m.matricula,
    horas: m.horas, tarifa: m.tarifa, costoHora: m.costo_hora,
    proyecto: m.proyecto_id, estado: m.estado, mantenim: m.proximo_mantenimiento,
    proxMantenimiento: m.proximo_mantenimiento, // alias para alertas
    obs: m.observaciones
  }));

  db.presupuestos = presupuestos.map(p => ({
    id: p.id, nombre: p.nombre, cliente: p.cliente, monto: p.monto,
    fecha: p.fecha, estado: p.estado, obs: p.observaciones
  }));

  db.facturas = facturas.map(f => ({
    id: f.id, numero: f.numero, cliente: f.cliente, proyecto: f.proyecto_id,
    monto: f.monto, fecha: f.fecha_emision,
    vence: f.fecha_vencimiento,
    fechaVencimiento: f.fecha_vencimiento,   // alias para alertas
    fecha_vencimiento: f.fecha_vencimiento,  // alias alternativo
    estado: f.estado
  }));

  db.proveedores = proveedores.map(p => ({
    id: p.id, nombre: p.nombre, rut: p.rut, rubro: p.rubro, tel: p.telefono, estado: p.estado
  }));

  db.materiales = materiales.map(m => ({
    id: m.id, nombre: m.nombre, tipo: m.tipo, cantidad: m.cantidad,
    proyecto: m.proyecto_id, responsable: m.responsable, fecha: m.fecha
  }));

  // También cargar usuarios y cotizaciones desde Supabase
  await Promise.allSettled([
    loadUsuariosSB(),
    loadCotizacionesSB(),
    loadMovimientosSB(),
    loadPartidasSB()
  ]);
  calcAndSyncAvances(); // recalc avances automáticos

  refreshAll();
  setTimeout(checkAlertasBadge, 200);
}

// ===================== RESPONSIVE HELPERS =====================
function makeTablesResponsive() {
  document.querySelectorAll('.table-wrap table').forEach(table => {
    table.classList.add('resp-table');
    const headers = [...table.querySelectorAll('thead th')].map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      [...tr.querySelectorAll('td')].forEach((td, i) => {
        if (headers[i]) td.setAttribute('data-label', headers[i]);
      });
    });
  });
}

// Auto-apply responsive classes to inline grids
function applyResponsiveClasses() {
  // Dashboard 2-col grids
  document.querySelectorAll('#page-dashboard > .content > [style*="grid-template-columns:2fr 1fr"], #page-dashboard [style*="grid-template-columns:2fr 1fr"]').forEach(el => el.classList.add('dash-two-col'));
  document.querySelectorAll('#page-dashboard [style*="grid-template-columns:1fr 1fr"]').forEach(el => el.classList.add('dash-two-col'));
  // Obras grid
  document.querySelectorAll('#page-obras [style*="grid-template-columns:2fr 1fr"]').forEach(el => el.classList.add('obras-grid'));
  // Reportes charts
  document.querySelectorAll('#page-reportes [style*="grid-template-columns:1fr 1fr"]').forEach(el => el.classList.add('charts-two-col'));
  // Sub stats
  document.querySelectorAll('#page-facturacion [style*="repeat(3"], #page-presupuestos [style*="repeat(3"]').forEach(el => el.classList.add('sub-stats-3'));
  document.querySelectorAll('#page-maquinaria [style*="repeat(4"], #page-presupuestos [style*="repeat(4"], #page-reportes [style*="repeat(4"], #page-obras [style*="repeat(4"]').forEach(el => el.classList.add('sub-stats-4'));
  // Filter rows
  document.querySelectorAll('.card > div[style*="display:flex"][style*="align-items:center"]').forEach(el => el.classList.add('filter-row'));
  // Topbar search
  document.querySelector('.topbar .search-bar')?.classList.add('top-search');
}

// ===================== SIDEBAR TOGGLE (MOBILE) =====================
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  const open    = sidebar.classList.toggle('open');
  overlay.classList.toggle('open', open);
  document.body.style.overflow = open ? 'hidden' : '';
}

function closeSidebarOnMobile() {
  if (window.innerWidth <= 1024) {
    document.querySelector('.sidebar')?.classList.remove('open');
    document.getElementById('sidebar-overlay')?.classList.remove('open');
    document.body.style.overflow = '';
  }
}

window.addEventListener('resize', () => {
  if (window.innerWidth > 1024) {
    document.querySelector('.sidebar')?.classList.remove('open');
    document.getElementById('sidebar-overlay')?.classList.remove('open');
    document.body.style.overflow = '';
  }
});

// ===================== NAVIGATION =====================
function nav(page, el) {
  // SEGURIDAD: bloquear acceso a páginas no permitidas por el rol activo
  if (page !== 'dashboard' && window._roleAllowed && Array.isArray(window._roleAllowed)) {
    if (!window._roleAllowed.includes(page)) {
      registrarActividad('acceso_denegado', window._sessionUser||'—', window._sessionRole||'—', 'Intentó acceder a: '+page);
      toast('Acceso denegado', 'Tu rol no tiene permiso para esta sección', 'err');
      return;
    }
  }
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (el) el.classList.add('active');
  const titles = { dashboard: 'Dashboard General', proyectos: 'Gestión de Proyectos', personal: 'Personal & Cuadrillas', maquinaria: 'Parque de Maquinaria', obras: 'Obras en Curso', presupuestos: 'Presupuestos', materiales: 'Control de Materiales', proveedores: 'Proveedores', facturacion: 'Facturación', reportes: 'Reportes & Analítica', cotizador: 'Cotizador de Proyectos', asistencia: 'Control de Asistencia', flujocaja: 'Flujo de Caja', alertas: 'Centro de Alertas' };
  document.getElementById('page-title').textContent = titles[page] || page;
  closeSidebarOnMobile();
  if (page === 'proyectos') renderProyectos();
  if (page === 'personal') renderPersonal();
  if (page === 'maquinaria') renderMaquinaria();
  if (page === 'dashboard') { renderDashboard(); setTimeout(initDashCharts, 60); }
  if (page === 'reportes') { renderReportes(); setTimeout(initReportesCharts, 60); }
  if (page === 'presupuestos') renderPresupuestos();
  if (page === 'usuarios') { 
    renderUsuarios(_usuarioFilterRol||''); // render cache immediately
    loadUsuariosSB().then(() => renderUsuarios(_usuarioFilterRol||'')); // then reload from SB
    populateProyectoDropdowns(); 
  }
  if (page === 'cotizador') renderCotizador();
  if (page === 'asistencia') initAsistencia();
  if (page === 'flujocaja') initFlujoCaja();
  if (page === 'obras') { loadPartesSB().then(() => renderObras()); }
  if (page === 'proveedores') {
    renderProveedores();
    // Always reload fresh movimientos so stats are current
    Promise.all([
      typeof loadMovimientosSB === 'function' ? loadMovimientosSB() : Promise.resolve()
    ]).then(() => renderProveedores());
  }
  if (page === 'alertas') { generarAlertas(); }
}

// ===================== REFRESH ALL =====================
function refreshAll() {
  updateBadges();
  renderDashboard();
  renderProyectos();
  renderPersonal();
  renderMaquinaria();
  renderPresupuestos();
  renderFacturas();
  renderProveedores();
  renderMateriales();
  setTimeout(makeTablesResponsive, 50);
}

function updateBadges() {
  document.getElementById('badge-proyectos').textContent = db.proyectos.length;
  document.getElementById('badge-personal').textContent = db.personal.length;
  document.getElementById('badge-maquinaria').textContent = db.maquinaria.length;
  document.getElementById('badge-presupuestos').textContent = db.presupuestos.length;
  const vencidas = db.facturas.filter(f=>f.estado==='pausado').length;
  if (vencidas > 0) document.getElementById('badge-facturas').textContent = vencidas;
}

function renderFacturas() {
  const tbody = document.getElementById('facturas-table');
  if (!tbody) return;
  // Update stats
  const totalMes = db.facturas.reduce((a,f) => a + Number(f.monto), 0);
  const pendiente = db.facturas.filter(f=>f.estado==='pendiente').reduce((a,f)=>a+Number(f.monto),0);
  const vencido = db.facturas.filter(f=>f.estado==='pausado').reduce((a,f)=>a+Number(f.monto),0);
  const meEl = document.getElementById('fac-mes');
  const penEl = document.getElementById('fac-pendiente');
  const venEl = document.getElementById('fac-vencido');
  if (meEl) meEl.textContent = fmtM(totalMes);
  if (penEl) penEl.textContent = fmtM(pendiente);
  if (venEl) venEl.textContent = fmtM(vencido);

  if (db.facturas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No hay facturas. Hacé clic en "+ Nueva Factura".</td></tr>';
    return;
  }
  const estadoTxt = { pendiente:'Pendiente', activo:'Cobrada', pausado:'Vencida' };
  const rows = db.facturas.map(f => ({
    tr: `<tr>
      <td><div class="td-name">${f.numero||'—'}</div></td>
      <td>${f.cliente}</td>
      <td>${getProyectoNombre(f.proyecto)||'—'}</td>
      <td><b>${fmt(f.monto)}</b></td>
      <td style="color:var(--muted2)">${f.fecha||'—'}</td>
      <td style="color:var(--muted2)">${f.vence||'—'}</td>
      <td><span class="status-badge ${f.estado||'pendiente'}">${estadoTxt[f.estado]||f.estado}</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF','Generando...')">📄 PDF</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactura('${f.id}')">🗑️</button>
      </div></td>
    </tr>`,
    card: `<div class="mobile-card">
      <div class="mc-header">
        <div><div class="mc-name">${f.numero||'Sin número'} — ${f.cliente}</div><div class="mc-sub">${getProyectoNombre(f.proyecto)||'—'}</div></div>
        <span class="status-badge ${f.estado||'pendiente'}">${estadoTxt[f.estado]||f.estado}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Monto</div><div class="mc-val" style="color:var(--green)">${fmt(f.monto)}</div></div>
        <div><div class="mc-label">Fecha</div><div class="mc-val">${f.fecha||'—'}</div></div>
        <div><div class="mc-label">Vence</div><div class="mc-val">${f.vence||'—'}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF','Generando...')">📄 PDF</button>
        <button class="btn btn-danger btn-sm" onclick="deleteFactura('${f.id}')">🗑️ Eliminar</button>
      </div>
    </div>`
  }));
  tbody.innerHTML = rows.map(r=>r.tr).join('');
  const mob = document.getElementById('facturas-mobile');
  if (mob) mob.innerHTML = rows.map(r=>r.card).join('');
}

async function deleteFactura(id) {
  document.getElementById('confirm-msg').textContent = '¿Eliminar esta factura?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('facturas?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Factura eliminada','','err');
      await loadAllData(); initTheme(); renderFacturas();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

function renderProveedores() {
  const tbody = document.getElementById('proveedores-table');
  if (!tbody) return;

  const anioActual = new Date().getFullYear();
  const movimientos = (typeof _movimientos !== 'undefined') ? _movimientos : [];
  const busqueda = (document.getElementById('prov-search')?.value || '').toLowerCase().trim();

  if (db.proveedores.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:32px;">No hay proveedores. Hacé clic en "+ Nuevo Proveedor".</td></tr>';
    document.getElementById('proveedores-mobile').innerHTML = '';
    actualizarKPIsProveedores([], movimientos, anioActual);
    return;
  }

  // ── Calcular stats por proveedor ──────────────────────────────────
  const calcProvStats = (prov) => {
    const palabras = (prov.nombre||'').toLowerCase().trim().split(/\s+/).filter(w => w.length > 2);
    const matchMov = (m) => {
      if (m.proveedorId && prov.id && m.proveedorId === prov.id) return true;
      const txt = ((m.descripcion||'') + ' ' + (m.referencia||'')).toLowerCase();
      return palabras.length > 0 && palabras.some(w => txt.includes(w));
    };
    // Todos los movimientos vinculados (egresos + cualquier tipo)
    const movsProv = movimientos.filter(m => matchMov(m));
    const movsAnio = movsProv.filter(m => {
      const d = new Date(m.fecha); return !isNaN(d) && d.getFullYear() === anioActual;
    });
    // Última compra = fecha más reciente de cualquier movimiento
    const fechas = movsProv.map(m => new Date(m.fecha)).filter(d => !isNaN(d));
    let ultimaCompra = '—';
    if (fechas.length > 0) {
      fechas.sort((a,b) => b - a);
      ultimaCompra = fechas[0].toLocaleDateString('es-PE', {day:'2-digit',month:'2-digit',year:'numeric',timeZone:'America/Lima'});
    }
    // Total año = suma montos año actual (todos los tipos)
    const totalAnio = movsAnio.reduce((a, m) => a + parseFloat(m.monto||0), 0);
    // Transacciones año = cantidad de movimientos este año
    const transacAnio = movsAnio.length;
    return { ultimaCompra, totalAnio, transacAnio, totalMovs: movsProv.length };
  };

  // ── Filtrar por búsqueda ──────────────────────────────────────────
  const provsFiltrados = busqueda
    ? db.proveedores.filter(p =>
        (p.nombre||'').toLowerCase().includes(busqueda) ||
        (p.rubro||'').toLowerCase().includes(busqueda) ||
        (p.rut||'').toLowerCase().includes(busqueda)
      )
    : db.proveedores;

  // ── Actualizar KPIs globales ──────────────────────────────────────
  actualizarKPIsProveedores(db.proveedores, movimientos, anioActual);

  if (provsFiltrados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">Sin resultados para "'+busqueda+'"</td></tr>';
    document.getElementById('proveedores-mobile').innerHTML = '';
    return;
  }

  const fmt = v => 'S/ ' + parseFloat(v||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});

  const pRows = provsFiltrados.map(p => {
    const s = calcProvStats(p);
    const eActivo = p.estado === 'activo';
    const tColor = s.totalAnio > 0 ? 'var(--accent)' : 'var(--muted)';
    const uColor = s.ultimaCompra !== '—' ? 'var(--text)' : 'var(--muted)';
    const initials = (p.nombre||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
    return {
      tr: `<tr>
        <td>
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,rgba(245,166,35,0.25),rgba(232,82,26,0.15));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px;color:var(--accent);flex-shrink:0;">${initials}</div>
            <div>
              <div class="td-name">${p.nombre}</div>
              <div class="td-sub">${p.rut||'Sin RUC'}</div>
            </div>
          </div>
        </td>
        <td><span style="background:rgba(168,85,247,0.12);color:#a855f7;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">${p.rubro||'—'}</span></td>
        <td style="font-size:12px;">${p.telefono||p.tel||'—'}</td>
        <td style="color:${uColor};font-size:12px;">${s.ultimaCompra}</td>
        <td style="font-weight:700;color:${tColor};">${fmt(s.totalAnio)}</td>
        <td style="text-align:center;">
          ${s.transacAnio > 0
            ? `<span style="background:rgba(59,130,246,0.15);color:var(--blue);padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700;">${s.transacAnio} mov.</span>`
            : '<span style="color:var(--muted);font-size:12px;">—</span>'}
        </td>
        <td><span class="status-badge ${eActivo?'activo':'pendiente'}">${eActivo?'Activo':'Inactivo'}</span></td>
        <td>
          <div style="display:flex;gap:5px;">
            <button class="btn btn-primary btn-sm" onclick="verDetalleProveedor('${p.id}')">👁 Ver</button>
            <button class="btn btn-danger btn-sm" onclick="deleteProveedor('${p.id}')">🗑️</button>
          </div>
        </td>
      </tr>`,
      card: `<div class="mobile-card" style="margin-bottom:10px;">
        <div class="mc-header">
          <div style="display:flex;align-items:center;gap:10px;flex:1;min-width:0;">
            <div style="width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,rgba(245,166,35,0.25),rgba(232,82,26,0.15));display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:var(--accent);flex-shrink:0;">${initials}</div>
            <div style="min-width:0;">
              <div class="mc-name" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.nombre}</div>
              <div class="mc-sub">${p.rubro||'—'} · ${p.rut||'Sin RUC'}</div>
            </div>
          </div>
          <span class="status-badge ${eActivo?'activo':'pendiente'}" style="flex-shrink:0;">${eActivo?'Activo':'Inactivo'}</span>
        </div>
        <div class="mc-body" style="grid-template-columns:1fr 1fr;gap:10px;">
          <div>
            <div class="mc-label">Teléfono</div>
            <div class="mc-val" style="font-size:12px;">${p.telefono||p.tel||'—'}</div>
          </div>
          <div>
            <div class="mc-label">Última Compra</div>
            <div class="mc-val" style="font-size:12px;color:${uColor};">${s.ultimaCompra}</div>
          </div>
          <div>
            <div class="mc-label">Total ${anioActual}</div>
            <div class="mc-val" style="color:${tColor};font-weight:700;">${fmt(s.totalAnio)}</div>
          </div>
          <div>
            <div class="mc-label">Transacciones</div>
            <div class="mc-val">
              ${s.transacAnio > 0
                ? `<span style="background:rgba(59,130,246,0.15);color:var(--blue);padding:2px 8px;border-radius:10px;font-size:12px;font-weight:700;">${s.transacAnio} mov.</span>`
                : '<span style="color:var(--muted);">—</span>'}
            </div>
          </div>
        </div>
        <div class="mc-actions">
          <button class="btn btn-primary btn-sm" onclick="verDetalleProveedor('${p.id}')">👁 Ver detalle</button>
          <button class="btn btn-danger btn-sm" onclick="deleteProveedor('${p.id}')">🗑️ Eliminar</button>
        </div>
      </div>`
    };
  });

  tbody.innerHTML = pRows.map(r=>r.tr).join('');
  document.getElementById('proveedores-mobile').innerHTML = pRows.map(r=>r.card).join('');
}

function actualizarKPIsProveedores(proveedores, movimientos, anioActual) {
  const activos = proveedores.filter(p => p.estado === 'activo').length;
  // Total gasto y transacciones del año (todos los movimientos de este año)
  const movsAnio = movimientos.filter(m => {
    const d = new Date(m.fecha); return !isNaN(d) && d.getFullYear() === anioActual;
  });
  // Solo los que tienen proveedor_id asignado o son pago_proveedor
  const movsProvAnio = movsAnio.filter(m => m.proveedorId || m.categoria === 'pago_proveedor' || m.categoria === 'materiales');
  const gastoTotal = movsProvAnio.reduce((a,m) => a + parseFloat(m.monto||0), 0);
  const fmtM = v => v >= 1000000 ? 'S/ '+(v/1000000).toFixed(1)+'M' : v >= 1000 ? 'S/ '+(v/1000).toFixed(0)+'k' : 'S/ '+parseFloat(v||0).toLocaleString('es-PE',{minimumFractionDigits:0});
  const setEl = (id, v) => { const el = document.getElementById(id); if(el) el.textContent = v; };
  setEl('prov-kpi-total',   proveedores.length);
  setEl('prov-kpi-activos', activos);
  setEl('prov-kpi-gasto',   fmtM(gastoTotal));
  setEl('prov-kpi-transac', movsProvAnio.length);
  const sub = document.getElementById('prov-sub');
  if (sub) sub.textContent = proveedores.length + ' proveedores · ' + activos + ' activos · ' + anioActual;
}

function filtrarProveedores() {
  renderProveedores();
}


async function deleteProveedor(id) {
  document.getElementById('confirm-msg').textContent = '¿Eliminar este proveedor?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('proveedores?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Proveedor eliminado','','err');
      await loadAllData(); renderProveedores();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

function renderMateriales() {
  const tbody = document.getElementById('materiales-table');
  if (!tbody) return;
  if (db.materiales.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay movimientos registrados.</td></tr>';
    return;
  }
  const matRows = db.materiales.map(m => {
    const color = m.tipo === 'ENTRADA' ? 'var(--green)' : 'var(--red)';
    const fecha = m.fecha ? new Date(m.fecha).toLocaleString('es-PE',{day:'2-digit',month:'2-digit',year:'2-digit',hour:'2-digit',minute:'2-digit',timeZone:'America/Lima'}) : '—';
    return {
      tr: `<tr>
        <td><div class="td-name">${m.nombre}</div></td>
        <td><span style="color:${color};font-weight:700;font-size:12px;">${m.tipo||'—'}</span></td>
        <td>${m.cantidad||'—'}</td>
        <td>${getProyectoNombre(m.proyecto)||'—'}</td>
        <td>${m.responsable||'—'}</td>
        <td style="color:var(--muted)">${fecha}</td>
      </tr>`,
      card: `<div class="mobile-card">
        <div class="mc-header">
          <div><div class="mc-name">${m.nombre}</div><div class="mc-sub">${getProyectoNombre(m.proyecto)||'—'}</div></div>
          <span style="color:${color};font-weight:800;font-size:13px;padding:3px 10px;background:${m.tipo==='ENTRADA'?'rgba(34,197,94,0.12)':'rgba(239,68,68,0.12)'};border-radius:20px;">${m.tipo||'—'}</span>
        </div>
        <div class="mc-body">
          <div><div class="mc-label">Cantidad</div><div class="mc-val">${m.cantidad||'—'}</div></div>
          <div><div class="mc-label">Responsable</div><div class="mc-val">${m.responsable||'—'}</div></div>
          <div><div class="mc-label">Fecha</div><div class="mc-val">${fecha}</div></div>
        </div>
      </div>`
    };
  });
  tbody.innerHTML = matRows.map(r=>r.tr).join('');
  const matMob = document.getElementById('materiales-mobile');
  if (matMob) matMob.innerHTML = matRows.map(r=>r.card).join('');
}

// ===================== HELPERS =====================
function fmt(n) { return 'S/ ' + Number(n).toLocaleString('es-PE'); }
function fmtM(n) { return n >= 1000000 ? 'S/ ' + (n/1000000).toFixed(1) + 'M' : n >= 1000 ? 'S/ ' + (n/1000).toFixed(0) + 'k' : 'S/ ' + Number(n).toLocaleString('es-PE'); }
function statusLabel(s) {
  const m = { activo: ['activo','Activo'], progreso: ['progreso','En Curso'], pendiente: ['pendiente','Pendiente'], pausado: ['pausado','Pausado'], finalizado: ['finalizado','Finalizado'] };
  const v = m[s] || ['pendiente', s];
  return `<span class="status-badge ${v[0]}">${v[1]}</span>`;
}
function tipoLabel(t) {
  const m = { planilla: 'En Planilla', contrato: 'Contrato', jornal: 'Jornalero' };
  return `<span class="status-badge ${t}">${m[t]||t}</span>`;
}
function getProyectoNombre(id) {
  const p = db.proyectos.find(x => x.id === id);
  return p ? p.nombre : '—';
}
function colorProgress(pct) {
  if (pct >= 70) return '#22c55e';
  if (pct >= 40) return '#f5a623';
  return '#ef4444';
}

// ===================== DASHBOARD =====================
function renderDashboard() {
  const activos = db.proyectos.filter(p => p.estado !== 'finalizado' && p.estado !== 'pausado').length;
  const totalPres = db.proyectos.reduce((a, p) => a + Number(p.presupuesto), 0);
  const enPlanilla = db.personal.filter(e => e.tipo === 'planilla').length;
  const maqActivas = db.maquinaria.filter(m => m.estado === 'activo').length;

  document.getElementById('kpi-proyectos').textContent = activos;
  document.getElementById('kpi-presupuesto').textContent = fmtM(totalPres);
  document.getElementById('kpi-personal').textContent = enPlanilla;
  document.getElementById('kpi-maquinas').textContent = maqActivas;

  // projects table on dashboard
  const tbody = document.getElementById('dash-projects-table');
  if (db.proyectos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos.</td></tr>';
  } else {
    tbody.innerHTML = db.proyectos.slice(0, 6).map(p => `
      <tr>
        <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.tipo} · ${p.ubicacion || '—'}</div></td>
        <td>${p.cliente}</td>
        <td>${fmtM(p.presupuesto)}</td>
        <td><div style="display:flex;align-items:center;gap:8px;font-size:12px;min-width:110px">
          <div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>${p.avance}%
        </div></td>
        <td>${statusLabel(p.estado)}</td>
      </tr>`).join('');
  }

  // personal top horas
  const topEmp = [...db.personal].sort((a,b) => b.horas - a.horas).slice(0, 4);
  const empDiv = document.getElementById('dash-personal-list');
  empDiv.innerHTML = topEmp.length ? topEmp.map(e => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
        <div><div style="font-size:13px;font-weight:600;">${e.nombre}</div><div style="font-size:11px;color:var(--muted);">${e.rol}</div></div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;color:var(--accent);">${e.horas}h</div>
    </div>`).join('') : '<p style="color:var(--muted);font-size:13px;">Sin datos.</p>';

  // maquinaria rentabilidad
  const maqDiv = document.getElementById('dash-maquinaria-list');
  maqDiv.innerHTML = db.maquinaria.length ? db.maquinaria.slice(0,4).map(m => {
    const ingreso = m.horas * m.tarifa;
    const costo = m.horas * m.costoHora;
    const rentab = ingreso > 0 ? ((ingreso - costo) / ingreso * 100).toFixed(1) : 0;
    const cls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';
    return `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;">
      <div><div style="font-size:13px;font-weight:600;">${m.nombre}</div><div style="font-size:11px;color:var(--muted);">${m.horas}h · ${fmtM(ingreso)} facturado</div></div>
      <div class="${cls}">${rentab}%</div>
    </div>`;
  }).join('') : '<p style="color:var(--muted);font-size:13px;">Sin datos.</p>';
}

// ===================== PROYECTOS =====================

// ══════════════════════════════════════════════════════════════════
// AVANCE AUTOMÁTICO POR TIEMPO + PARTIDAS
// ══════════════════════════════════════════════════════════════════
let _partidas = {}; // { proyectoId: [ {id, nombre, peso, avance} ] }

function calcAvanceProyecto(p) {
  const hoy = new Date(); hoy.setHours(0,0,0,0);
  const inicio = p.inicio ? new Date(p.inicio) : null;
  const fin    = p.fin    ? new Date(p.fin)    : null;

  // Avance por tiempo (base automática)
  let avanceTiempo = p.avance || 0;
  if (inicio && fin && fin > inicio) {
    const total = fin - inicio;
    const transcurrido = Math.min(Math.max(hoy - inicio, 0), total);
    avanceTiempo = Math.round((transcurrido / total) * 100);
  }

  // Avance por partidas (si existen, tienen prioridad)
  const partidas = _partidas[p.id] || [];
  let avancePartidas = null;
  if (partidas.length > 0) {
    const pesoTotal = partidas.reduce((s,pt) => s + (parseFloat(pt.peso)||0), 0);
    if (pesoTotal > 0) {
      avancePartidas = Math.round(
        partidas.reduce((s,pt) => s + (parseFloat(pt.avance)||0) * (parseFloat(pt.peso)||0), 0) / pesoTotal
      );
    }
  }

  // Si hay partidas → promedio ponderado (70% partidas + 30% tiempo)
  const avanceFinal = avancePartidas !== null
    ? Math.round(avancePartidas * 0.7 + avanceTiempo * 0.3)
    : avanceTiempo;

  // Estado de atraso
  let diasAtraso = 0;
  let atrasado = false;
  if (fin && hoy > fin && (p.estado||'').toLowerCase() !== 'finalizado') {
    diasAtraso = Math.round((hoy - fin) / 86400000);
    atrasado = true;
  } else if (avanceTiempo > 0 && avancePartidas !== null && avancePartidas < avanceTiempo - 10) {
    // avance real < avance esperado por tiempo (más de 10% de diferencia)
    atrasado = true;
  }

  return { avanceFinal, avanceTiempo, avancePartidas, atrasado, diasAtraso };
}

function calcAndSyncAvances() {
  // Recalcula avances automáticos y sincroniza con db.proyectos
  db.proyectos.forEach(p => {
    const { avanceFinal, atrasado, diasAtraso } = calcAvanceProyecto(p);
    p._avanceAuto = avanceFinal;
    p._atrasado   = atrasado;
    p._diasAtraso = diasAtraso;
  });
}

// ── Partidas localStorage (sincronizado con Supabase cuando esté disponible) ──
const PARTIDAS_KEY = 'bc_partidas_v1';

async function loadPartidasSB() {
  try {
    const rows = await sbFetch('partidas_proyecto?order=orden.asc');
    _partidas = {};
    rows.forEach(r => {
      if (!_partidas[r.proyecto_id]) _partidas[r.proyecto_id] = [];
      _partidas[r.proyecto_id].push({
        id: r.id, nombre: r.nombre, peso: parseFloat(r.peso||10),
        avance: parseFloat(r.avance||0), orden: r.orden||0
      });
    });
    localStorage.setItem(PARTIDAS_KEY, JSON.stringify(_partidas));
  } catch(e) {
    try { _partidas = JSON.parse(localStorage.getItem(PARTIDAS_KEY)||'{}'); } catch(e2) { _partidas = {}; }
  }
}

async function savePartida(proyId, partida) {
  const payload = { proyecto_id: proyId, nombre: partida.nombre, peso: partida.peso, avance: partida.avance, orden: partida.orden||0 };
  try {
    if (partida.id && !String(partida.id).startsWith('local_')) {
      await sbFetch('partidas_proyecto?id=eq.'+partida.id, { method:'PATCH', body: payload, prefer:'return=minimal' });
    } else {
      const res = await sbFetch('partidas_proyecto', { method:'POST', body: payload });
      partida.id = (Array.isArray(res)?res[0]:res)?.id || partida.id;
    }
  } catch(e) { console.warn('Partida guardada solo local:', e.message); }
  localStorage.setItem(PARTIDAS_KEY, JSON.stringify(_partidas));
}

async function deletePartida(proyId, partidaId) {
  try {
    if (!String(partidaId).startsWith('local_'))
      await sbFetch('partidas_proyecto?id=eq.'+partidaId, { method:'DELETE', prefer:'return=minimal' });
  } catch(e) { console.warn('Delete partida local only'); }
  _partidas[proyId] = (_partidas[proyId]||[]).filter(p => p.id !== partidaId);
  localStorage.setItem(PARTIDAS_KEY, JSON.stringify(_partidas));
}

// ── Modal de Partidas ─────────────────────────────────────────────
let _partidasModalProyId = null;

function abrirModalPartidas(proyId) {
  _partidasModalProyId = proyId;
  const p = db.proyectos.find(x => x.id === proyId);
  document.getElementById('modal-partidas-title').textContent = '📋 Partidas: ' + (p?.nombre || '');
  renderPartidasModal(proyId);
  document.getElementById('modal-partidas').classList.add('open');
}

function renderPartidasModal(proyId) {
  const lista = _partidas[proyId] || [];
  const container = document.getElementById('partidas-lista');

  if (lista.length === 0) {
    container.innerHTML =
      '<div style="text-align:center;color:var(--muted);padding:28px;">' +
        '<div style="font-size:36px;margin-bottom:8px;">📋</div>' +
        '<div style="font-weight:600;margin-bottom:4px;">Sin partidas aún</div>' +
        '<small style="font-size:11px;opacity:0.7;">Usá una plantilla o agregá partidas manualmente.</small>' +
      '</div>';
  } else {
    container.innerHTML = lista.map(function(pt) {
      var av    = parseFloat(pt.avance) || 0;
      var color = av >= 100 ? 'var(--green)' : av >= 50 ? 'var(--blue)' : av > 0 ? 'var(--accent)' : 'var(--muted)';
      var done  = av >= 100 ? '<span style="font-size:11px;color:var(--green);margin-left:4px;">✅ Completada</span>' : '';
      return (
        '<div style="background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:10px;border:1px solid var(--border);">' +
          '<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">' +
            '<div style="display:flex;align-items:center;gap:8px;flex:1;">' +
              '<span style="font-weight:700;font-size:13px;">' + pt.nombre + '</span>' +
              '<span style="font-size:11px;color:var(--muted2);background:var(--bg4);padding:2px 7px;border-radius:20px;">Peso ' + pt.peso + '%</span>' +
              done +
            '</div>' +
            '<button onclick="eliminarPartidaUI(\'' + proyId + '\',\'' + pt.id + '\')" ' +
              'style="background:none;border:none;color:var(--red);cursor:pointer;font-size:18px;padding:0 4px;" title="Eliminar">✕</button>' +
          '</div>' +
          '<div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted2);margin-bottom:6px;">' +
            '<span>Avance</span><span style="color:' + color + ';font-weight:700;">' + av + '%</span>' +
          '</div>' +
          '<input type="range" min="0" max="100" value="' + av + '" step="5" ' +
            'style="width:100%;accent-color:' + color + ';margin-bottom:4px;" ' +
            'oninput="updatePartidaAvance(\'' + proyId + '\',\'' + pt.id + '\',parseInt(this.value))">' +
          '<div style="background:var(--bg);border-radius:6px;height:8px;">' +
            '<div style="background:' + color + ';height:8px;border-radius:6px;width:' + av + '%;transition:width 0.4s;"></div>' +
          '</div>' +
        '</div>'
      );
    }).join('');
  }

  // Avance preview
  var proy = db.proyectos.find(function(x){ return x.id === proyId; }) || {};
  var calc = calcAvanceProyecto(proy);
  var avanceTiempo    = calc.avanceTiempo;
  var avancePartidas  = calc.avancePartidas;
  var avanceFinal     = calc.avanceFinal;
  var partLabel = avancePartidas !== null ? avancePartidas + '%' : '—';
  var colorFinal = avanceFinal >= 70 ? 'var(--green)' : avanceFinal >= 40 ? 'var(--accent)' : 'var(--red)';
  var preview = document.getElementById('partidas-avance-preview');
  if (preview) {
    preview.innerHTML =
      '<div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-bottom:4px;">' +
        '<div style="text-align:center;padding:10px 18px;background:var(--bg3);border-radius:10px;flex:1;min-width:90px;">' +
          '<div style="font-size:11px;color:var(--muted2);margin-bottom:4px;">⏱ Por Tiempo</div>' +
          '<div style="font-size:24px;font-weight:900;color:var(--blue);">' + avanceTiempo + '%</div>' +
        '</div>' +
        '<div style="text-align:center;padding:10px 18px;background:var(--bg3);border-radius:10px;flex:1;min-width:90px;">' +
          '<div style="font-size:11px;color:var(--muted2);margin-bottom:4px;">📋 Por Partidas</div>' +
          '<div style="font-size:24px;font-weight:900;color:var(--accent);">' + partLabel + '</div>' +
        '</div>' +
        '<div style="text-align:center;padding:10px 18px;background:var(--bg4);border-radius:10px;border:2px solid ' + colorFinal + ';flex:1;min-width:90px;">' +
          '<div style="font-size:11px;color:var(--muted2);margin-bottom:4px;">🎯 Avance Final</div>' +
          '<div style="font-size:24px;font-weight:900;color:' + colorFinal + ';">' + avanceFinal + '%</div>' +
        '</div>' +
      '</div>';
  }
}

async function updatePartidaAvance(proyId, partidaId, nuevoAvance) {
  const lista = _partidas[proyId] || [];
  const pt = lista.find(p => p.id === partidaId);
  if (!pt) return;
  pt.avance = nuevoAvance;
  await savePartida(proyId, pt);
  calcAndSyncAvances();
  renderPartidasModal(proyId);
  // también actualizar la card del proyecto
  renderProyectos();
  // sync avance en Supabase (campo avance del proyecto)
  const p = db.proyectos.find(x => x.id === proyId);
  if (p) {
    try { await sbFetch('proyectos?id=eq.'+proyId, { method:'PATCH', body:{ avance: p._avanceAuto }, prefer:'return=minimal' }); }
    catch(e) {}
  }
}

async function eliminarPartidaUI(proyId, partidaId) {
  await deletePartida(proyId, partidaId);
  renderPartidasModal(proyId);
  calcAndSyncAvances();
  renderProyectos();
}

function agregarPartidaUI() {
  const nombre = document.getElementById('nueva-partida-nombre').value.trim();
  const peso   = parseFloat(document.getElementById('nueva-partida-peso').value) || 10;
  if (!nombre) { toast('Error','Ingresá el nombre de la partida','err'); return; }
  const proyId = _partidasModalProyId;
  if (!_partidas[proyId]) _partidas[proyId] = [];
  const nueva = { id: 'local_'+Date.now(), nombre, peso, avance: 0, orden: _partidas[proyId].length };
  _partidas[proyId].push(nueva);
  savePartida(proyId, nueva);
  document.getElementById('nueva-partida-nombre').value = '';
  document.getElementById('nueva-partida-peso').value = '10';
  renderPartidasModal(proyId);
  calcAndSyncAvances();
  renderProyectos();
}

// Plantillas de partidas estándar
const PLANTILLAS_PARTIDAS = {
  'Residencial':  [{nombre:'Trabajos Preliminares',peso:5},{nombre:'Cimentación',peso:15},{nombre:'Estructura / Muros',peso:25},{nombre:'Techo / Losa',peso:15},{nombre:'Instalaciones Eléctricas',peso:10},{nombre:'Instalaciones Sanitarias',peso:10},{nombre:'Revoques y Enlucidos',peso:8},{nombre:'Pisos y Pavimentos',peso:7},{nombre:'Carpintería y Vidrios',peso:3},{nombre:'Pintura y Acabados',peso:2}],
  'Comercial':    [{nombre:'Demolición / Preliminares',peso:5},{nombre:'Cimentación',peso:12},{nombre:'Estructura',peso:25},{nombre:'Fachada',peso:15},{nombre:'Instalaciones',peso:18},{nombre:'Interiores',peso:15},{nombre:'Acabados',peso:10}],
  'Vial':         [{nombre:'Topografía / Trazado',peso:5},{nombre:'Movimiento de Tierras',peso:25},{nombre:'Sub-base',peso:20},{nombre:'Base',peso:20},{nombre:'Carpeta Asfáltica',peso:20},{nombre:'Señalización',peso:10}],
  'Industrial':   [{nombre:'Cimentaciones',peso:15},{nombre:'Estructura Metálica',peso:30},{nombre:'Cerramientos',peso:20},{nombre:'Instalaciones',peso:20},{nombre:'Pavimentos',peso:10},{nombre:'Acabados',peso:5}],
};

async function cargarPlantilla(tipo) {
  const plantilla = PLANTILLAS_PARTIDAS[tipo] || PLANTILLAS_PARTIDAS['Residencial'];
  const proyId = _partidasModalProyId;
  _partidas[proyId] = plantilla.map((pt,i) => ({...pt, id:'local_'+Date.now()+'_'+i, avance:0, orden:i}));
  for (const pt of _partidas[proyId]) { await savePartida(proyId, pt); }
  renderPartidasModal(proyId);
  calcAndSyncAvances();
  renderProyectos();
  toast('✅ Plantilla cargada', plantilla.length+' partidas de '+tipo, 'ok');
}

function renderProyectos(filter) {
  if (filter) currentFilter.proyectos = filter;
  const f = currentFilter.proyectos;
  let data = db.proyectos;
  if (f !== 'todos') data = data.filter(p => p.estado === f);
  document.getElementById('proyectos-sub').textContent = db.proyectos.length + ' proyectos en cartera · $' + (db.proyectos.reduce((a,p)=>a+Number(p.presupuesto),0)/1000000).toFixed(1) + 'M total';
  const grid = document.getElementById('projects-grid');
  if (data.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="icon">🏗️</div><p>No hay proyectos en esta categoría.</p></div>';
    return;
  }
  calcAndSyncAvances();
  grid.innerHTML = data.map(p => {
    const av = p._avanceAuto !== undefined ? p._avanceAuto : (p.avance||0);
    const atrasado = p._atrasado;
    const diasAtraso = p._diasAtraso || 0;
    const partidas = _partidas[p.id] || [];
    const avEsperado = (() => {
      const hoy = new Date(); const ini = p.inicio ? new Date(p.inicio) : null; const fin = p.fin ? new Date(p.fin) : null;
      if (!ini || !fin || fin <= ini) return null;
      return Math.round(Math.min(Math.max((hoy-ini)/(fin-ini),0),1)*100);
    })();
    const deficit = avEsperado !== null ? avEsperado - av : 0;
    return `
    <div class="project-card" style="${atrasado?'border-color:var(--red);box-shadow:0 0 0 1px rgba(239,68,68,0.3);':''}" onclick="openProyectoDetail('${p.id}')">
      <div class="project-card-header">
        <span class="project-type-badge">${p.tipo}</span>
        ${atrasado
          ? `<span style="font-size:11px;padding:3px 8px;border-radius:20px;background:rgba(239,68,68,0.15);color:var(--red);font-weight:700;">🔴 ${diasAtraso>0?diasAtraso+'d atraso':'Desfasada'}</span>`
          : statusLabel(p.estado)}
      </div>
      <div class="project-card-title">${p.nombre}</div>
      <div class="project-card-client">${p.cliente} · ${p.ubicacion || 'Sin ubicación'}</div>
      <div style="margin-top:12px;">
        <div class="project-progress-label">
          <span style="display:flex;align-items:center;gap:6px;">
            Avance
            <span style="font-size:10px;color:var(--muted2);">(auto)</span>
          </span>
          <div style="display:flex;align-items:center;gap:6px;">
            ${avEsperado!==null&&deficit>5?`<span style="font-size:10px;color:var(--red);">-${deficit}% vs plan</span>`:''}
            <span style="font-weight:800;color:${colorProgress(av)};font-size:15px;">${av}%</span>
          </div>
        </div>
        <div class="progress-bar" style="position:relative;">
          <div class="progress-fill" style="width:${av}%;background:${atrasado?'var(--red)':colorProgress(av)};transition:width 0.5s;"></div>
          ${avEsperado!==null?`<div style="position:absolute;top:0;left:${avEsperado}%;width:2px;height:100%;background:rgba(255,255,255,0.4);"></div>`:''}
        </div>
        ${avEsperado!==null?`<div style="font-size:10px;color:var(--muted);margin-top:3px;display:flex;justify-content:space-between;"><span>Esperado: ${avEsperado}%</span>${p.fin?`<span>Vence: ${new Date(p.fin).toLocaleDateString('es-PE',{day:'numeric',month:'short',year:'2-digit'})}</span>`:'<span></span>'}</div>`:''}
        ${partidas.length>0?`<div style="font-size:10px;color:var(--muted2);margin-top:4px;">📋 ${partidas.length} partida${partidas.length>1?'s':''} · ${partidas.filter(pt=>pt.avance>=100).length} completada${partidas.filter(pt=>pt.avance>=100).length!==1?'s':''}</div>`:''}
      </div>
      <div class="project-card-meta" style="margin-top:12px;">
        <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;">${fmtM(p.presupuesto)}</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" title="Partidas" onclick="event.stopPropagation();abrirModalPartidas('${p.id}')">📋</button>
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModal('proyecto','${p.id}')">✏️</button>
          <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();confirmDelete('proyecto','${p.id}')">🗑️</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function filterTab(page, filter, el) {
  document.querySelectorAll(`#page-${page} .tab`).forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (page === 'proyectos') renderProyectos(filter);
}

function openProyectoDetail(id) {
  openModal('proyecto', id, true);
}

// ===================== PERSONAL =====================
function renderPersonal(search, statusF) {
  if (search !== undefined) currentFilter.personal = search;
  if (statusF !== undefined) currentFilter.personalStatus = statusF;
  let data = db.personal;
  if (currentFilter.personal) {
    const q = currentFilter.personal.toLowerCase();
    data = data.filter(e => e.nombre.toLowerCase().includes(q) || e.rol.toLowerCase().includes(q) || e.ci.includes(q));
  }
  if (currentFilter.personalStatus) data = data.filter(e => e.tipo === currentFilter.personalStatus);
  document.getElementById('personal-sub').textContent = db.personal.length + ' empleados · ' + db.personal.filter(e=>e.tipo==='planilla').length + ' en planilla';
  const tbody = document.getElementById('personal-table');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No se encontraron resultados.</td></tr>';
    return;
  }
  const rows = data.map(e => {
    let contractAlert = '';
    let contractAlertMobile = '';
    if (e.fechaFin) {
      const today = new Date();
      const fin = new Date(e.fechaFin);
      const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
      if (diffDays < 0) {
        contractAlert = `<div style="font-size:10px;color:var(--red);font-weight:700;margin-top:2px;">⚠️ Contrato vencido</div>`;
        contractAlertMobile = `<div style="font-size:11px;color:var(--red);font-weight:700;margin-top:6px;">⚠️ Contrato vencido</div>`;
      } else if (diffDays <= 30) {
        contractAlert = `<div style="font-size:10px;color:var(--accent);font-weight:700;margin-top:2px;">⏰ Vence en ${diffDays}d</div>`;
        contractAlertMobile = `<div style="font-size:11px;color:var(--accent);font-weight:700;margin-top:6px;">⏰ Vence en ${diffDays} días</div>`;
      }
    }
    const initials = e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2);
    const sueldoStr = e.tipo === 'jornal' ? fmt(e.sueldo) + '/día' : fmt(e.sueldo) + '/mes';
    return {
      tr: `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">${initials}</div>
          <div><div class="td-name">${e.nombre}</div><div class="td-sub">${e.ci}</div>${contractAlert}</div>
        </div>
      </td>
      <td><div>${e.rol}</div><div class="td-sub">${e.cuadrilla || '—'}</div></td>
      <td>${tipoLabel(e.tipo)}</td>
      <td>${sueldoStr}</td>
      <td><span style="font-family:'Syne',sans-serif;font-weight:700;">${e.horas}h</span></td>
      <td>${getProyectoNombre(e.proyecto)}</td>
      <td><span class="status-badge activo">Activo</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-primary btn-sm" onclick="verPersonal('${e.id}')">👁 Ver</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('personal','${e.id}')">✏️</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('personal','${e.id}')">🗑️</button>
      </div></td>
    </tr>`,
      card: `
    <div class="mobile-card">
      <div class="mc-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="mc-avatar">${initials}</div>
          <div><div class="mc-name">${e.nombre}</div><div class="mc-sub">${e.ci} · ${e.rol}</div>${contractAlertMobile}</div>
        </div>
        ${tipoLabel(e.tipo)}
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Cuadrilla</div><div class="mc-val">${e.cuadrilla || '—'}</div></div>
        <div><div class="mc-label">Sueldo</div><div class="mc-val">${sueldoStr}</div></div>
        <div><div class="mc-label">Horas/mes</div><div class="mc-val">${e.horas}h</div></div>
        <div><div class="mc-label">Proyecto</div><div class="mc-val" style="font-size:12px;">${getProyectoNombre(e.proyecto)}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-primary btn-sm" onclick="verPersonal('${e.id}')">👁 Ver ficha</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('personal','${e.id}')">✏️ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('personal','${e.id}')">🗑️</button>
      </div>
    </div>`
    };
  });
  tbody.innerHTML = rows.map(r=>r.tr).join('');
  const mobileDiv = document.getElementById('personal-mobile');
  if (mobileDiv) mobileDiv.innerHTML = rows.map(r=>r.card).join('') || '<p style="color:var(--muted);text-align:center;padding:24px;">Sin resultados.</p>';
}

function filterPersonal(val) { renderPersonal(val); }
function filterPersonalStatus(val) { renderPersonal(undefined, val); }

function verPersonal(id) {
  currentPersonalId = id;
  const e = db.personal.find(x => x.id === id);
  if (!e) return;
  const proyecto = getProyectoNombre(e.proyecto);
  const sueldoLabel = e.tipo === 'jornal' ? fmt(e.sueldo) + '/día' : fmt(e.sueldo) + '/mes';
  const salarioTotal = e.tipo === 'jornal' ? e.sueldo * (e.horas / 8) : e.sueldo;
  const costoHora = salarioTotal / (e.horas || 1);

  // Contract expiry check
  let contractStatus = '';
  if (e.fechaFin) {
    const today = new Date();
    const fin = new Date(e.fechaFin);
    const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) {
      contractStatus = `<div style="margin-top:10px;padding:10px 14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;font-size:13px;color:var(--red);font-weight:600;">⚠️ Contrato VENCIDO hace ${Math.abs(diffDays)} días — Renovar urgente</div>`;
    } else if (diffDays <= 30) {
      contractStatus = `<div style="margin-top:10px;padding:10px 14px;background:rgba(245,166,35,0.1);border:1px solid rgba(245,166,35,0.3);border-radius:8px;font-size:13px;color:var(--accent);font-weight:600;">⏰ Contrato vence en ${diffDays} días (${fin.toLocaleDateString('es-PE')}) — Revisar renovación</div>`;
    }
  }

  // Simulated monthly hours breakdown
  const semanas = [
    { sem: 'Semana 1', lun: 8, mar: 8, mie: 8, jue: 8, vie: 8, sab: 4, total: 44 },
    { sem: 'Semana 2', lun: 8, mar: 8, mie: 8, jue: 0, vie: 8, sab: 0, total: 32 },
    { sem: 'Semana 3', lun: 8, mar: 8, mie: 8, jue: 8, vie: 8, sab: 8, total: 48 },
    { sem: 'Semana 4', lun: 8, mar: 8, mie: 0, jue: 8, vie: 8, sab: 4, total: e.horas - 124 > 0 ? e.horas - 124 : 36 },
  ];

  document.getElementById('personal-detail-content').innerHTML = `
    <div class="person-detail-header">
      <div class="person-avatar">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
      <div class="person-detail-info">
        <h2>${e.nombre}</h2>
        <p>${e.rol} · Cuadrilla: ${e.cuadrilla || 'No asignada'}</p>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${tipoLabel(e.tipo)}
          <span class="status-badge activo">Activo</span>
          ${e.tel ? `<span style="font-size:12px;color:var(--muted2);">📞 ${e.tel}</span>` : ''}
          ${e.email ? `<span style="font-size:12px;color:var(--muted2);">✉️ ${e.email}</span>` : ''}
        </div>
        ${contractStatus}
      </div>
    </div>
    <div class="detail-grid">
      <div class="detail-item">
        <div class="d-label">Sueldo Base</div>
        <div class="d-val" style="color:var(--accent)">${sueldoLabel}</div>
        <div class="d-sub">Salario mensual estimado: ${fmt(salarioTotal)}</div>
      </div>
      <div class="detail-item">
        <div class="d-label">Horas Trabajadas (mes)</div>
        <div class="d-val" style="color:var(--blue)">${e.horas}h</div>
        <div class="d-sub">Costo/hora: ${fmt(Math.round(costoHora))}</div>
      </div>
      <div class="detail-item">
        <div class="d-label">Proyecto Asignado</div>
        <div class="d-val" style="font-size:14px;font-weight:700;">${proyecto}</div>
        <div class="d-sub">CI: ${e.ci}</div>
      </div>
    </div>
    ${e.dir || e.obs ? `
    <div style="background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:16px;border:1px solid var(--border);">
      ${e.dir ? `<div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">📍 ${e.dir}</div>` : ''}
      ${e.obs ? `<div style="font-size:12px;color:var(--muted2);">📝 ${e.obs}</div>` : ''}
    </div>` : ''}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;color:var(--muted2);">REGISTRO DE HORAS — MES ACTUAL</div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <table class="hours-table">
        <thead><tr><th>Semana</th><th>Lun</th><th>Mar</th><th>Mié</th><th>Jue</th><th>Vie</th><th>Sáb</th><th>Total</th></tr></thead>
        <tbody>
          ${semanas.map(s=>`<tr>
            <td style="font-weight:600;">${s.sem}</td>
            <td>${s.lun}h</td><td>${s.mar}h</td><td>${s.mie}h</td>
            <td>${s.jue}h</td><td>${s.vie}h</td>
            <td style="color:${s.sab>0?'var(--accent)':'var(--muted)'};">${s.sab}h</td>
            <td style="font-weight:700;color:var(--blue);">${s.total}h</td>
          </tr>`).join('')}
          <tr style="background:rgba(245,166,35,0.05);">
            <td colspan="6" style="font-weight:700;text-align:right;padding-right:20px;color:var(--muted2);">TOTAL MES:</td>
            <td colspan="2" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--accent);">${e.horas}h</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  openModal('personal-detail');
}

function editPersonal() {
  closeModal('personal-detail');
  openModal('personal', currentPersonalId);
}

function exportPersonaExcel() {
  const e = db.personal.find(x => x.id === currentPersonalId);
  if (!e) return;
  exportToCSV([
    ['Campo', 'Valor'],
    ['Nombre', e.nombre], ['CI', e.ci], ['Rol', e.rol], ['Cuadrilla', e.cuadrilla],
    ['Tipo', e.tipo], ['Sueldo Base', e.sueldo], ['Horas Mes', e.horas],
    ['Proyecto', getProyectoNombre(e.proyecto)], ['Teléfono', e.tel], ['Email', e.email],
    ['Dirección', e.dir], ['Observaciones', e.obs],
    [''],['Registro de Horas'],
    ['Semana','Lunes','Martes','Miércoles','Jueves','Viernes','Sábado','Total'],
    ['Semana 1',8,8,8,8,8,4,44],['Semana 2',8,8,8,0,8,0,32],
    ['Semana 3',8,8,8,8,8,8,48],['Semana 4',8,8,0,8,8,4,36],
    ['TOTAL','','','','','','',e.horas]
  ], 'ficha_' + e.nombre.replace(/ /g,'_'));
  toast('Excel generado', 'Archivo descargado: ficha_' + e.nombre);
}

function exportPersonalExcel() {
  const rows = [['Nombre','CI','Rol','Cuadrilla','Tipo','Sueldo','Horas Mes','Proyecto','Teléfono','Email']];
  db.personal.forEach(e => rows.push([e.nombre,e.ci,e.rol,e.cuadrilla,e.tipo,e.sueldo,e.horas,getProyectoNombre(e.proyecto),e.tel,e.email]));
  exportToCSV(rows, 'personal_completo');
  toast('Excel exportado', db.personal.length + ' empleados exportados');
}

// ===================== BOLETA DE PAGO PDF =====================
function generarBoletaPDF() {
  const e = db.personal.find(x => x.id === currentPersonalId);
  if (!e) return;

  const proyecto = getProyectoNombre(e.proyecto);
  const hoy = new Date();
  const mes = hoy.toLocaleString('es-PE', { month: 'long', year: 'numeric' });
  const fechaEmision = hoy.toLocaleDateString('es-PE');

  // Calcular montos
  const sueldoBase = Number(e.sueldo) || 0;
  const horas = Number(e.horas) || 0;
  let sueldoBruto = sueldoBase;
  if (e.tipo === 'jornal') sueldoBruto = sueldoBase * (horas / 8);

  // Descuentos estándar Perú
  const onp = sueldoBruto * 0.13;         // ONP 13%
  const essalud = sueldoBruto * 0.09;     // EsSalud 9% (cargo empleador)
  const sctr = sueldoBruto * 0.009;       // SCTR ~0.9%
  const totalDescuentos = onp;            // descuento trabajador
  const sueldoNeto = sueldoBruto - totalDescuentos;

  const tipoMap = { planilla: 'En Planilla', contrato: 'Contrato', jornal: 'Jornalero' };

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Boleta de Pago — ${e.nombre}</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:Arial,sans-serif;font-size:13px;color:#1a1a2e;background:#fff;padding:30px;}
  .boleta{max-width:680px;margin:0 auto;border:2px solid #1a1a2e;border-radius:8px;overflow:hidden;}
  .header{background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}
  .header h1{font-size:22px;font-weight:900;letter-spacing:1px;}
  .header .sub{font-size:11px;opacity:0.85;margin-top:3px;}
  .header .fecha{text-align:right;font-size:12px;}
  .section{padding:16px 24px;border-bottom:1px solid #e5e7eb;}
  .section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#6b7280;margin-bottom:10px;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px 16px;}
  .field label{font-size:10px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;}
  .field span{font-weight:700;font-size:13px;color:#111;}
  table{width:100%;border-collapse:collapse;margin-top:4px;}
  table th{background:#f9fafb;padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6b7280;text-align:left;border-bottom:2px solid #e5e7eb;}
  table td{padding:9px 12px;font-size:13px;border-bottom:1px solid #f3f4f6;}
  table tr:last-child td{border-bottom:none;}
  .amount{text-align:right;font-weight:700;}
  .green{color:#16a34a;}
  .red{color:#dc2626;}
  .total-row{background:#fef9f0;}
  .total-row td{font-family:'Arial',sans-serif;font-weight:900;font-size:15px;padding:12px;}
  .neto-box{background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;padding:18px 24px;text-align:center;}
  .neto-box .label{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.85;}
  .neto-box .amount{font-size:32px;font-weight:900;margin:4px 0;}
  .neto-box .sub{font-size:11px;opacity:0.75;}
  .footer{padding:14px 24px;background:#f9fafb;font-size:11px;color:#6b7280;display:flex;justify-content:space-between;}
  @media print{body{padding:0;} .no-print{display:none;}}

/* ── Proveedores KPI grid ── */
.prov-kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 12px;
  margin-bottom: 16px;
}
@media (max-width: 768px) {
  .prov-kpi-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 8px !important; }
}
@media (max-width: 480px) {
  .prov-kpi-grid { grid-template-columns: repeat(2, 1fr) !important; gap: 6px !important; }
}

/* ── Proveedores table responsive ── */
@media (max-width: 768px) {
  #page-proveedores .hide-on-mobile { display: none !important; }
  #proveedores-mobile { display: block !important; }
  #page-proveedores .section-header .btn { flex: 1 !important; }
  #prov-search { font-size: 13px !important; }
}
/* Desktop: tabla con scroll si pantalla chica */
@media (min-width: 769px) {
  #page-proveedores .table-wrap { overflow-x: auto; }
  #page-proveedores table { min-width: 750px; }
  #proveedores-mobile { display: none !important; }
}
</style>
</head>
<body>
<div class="boleta">
  <div class="header">
    <div>
      <h1>🏗️ NorConstructores</h1>
      <div class="sub">Sistema de Gestión de Construcción</div>
      <div class="sub" style="margin-top:6px;font-size:13px;font-weight:700;">BOLETA DE PAGO</div>
    </div>
    <div class="fecha">
      <div style="font-weight:700;font-size:14px;">Período: ${mes}</div>
      <div style="margin-top:4px;">Emisión: ${fechaEmision}</div>
      <div style="margin-top:4px;opacity:0.7;">N° ${String(hoy.getFullYear()) + String(hoy.getMonth()+1).padStart(2,'0') + String(Math.floor(Math.random()*9000)+1000)}</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Datos del Trabajador</div>
    <div class="grid2">
      <div class="field"><label>Apellidos y Nombres</label><span>${e.nombre}</span></div>
      <div class="field"><label>DNI / CI</label><span>${e.ci || '—'}</span></div>
      <div class="field"><label>Cargo / Puesto</label><span>${e.rol || '—'}</span></div>
      <div class="field"><label>Cuadrilla</label><span>${e.cuadrilla || '—'}</span></div>
      <div class="field"><label>Tipo de Contrato</label><span>${tipoMap[e.tipo] || e.tipo}</span></div>
      <div class="field"><label>Proyecto Asignado</label><span>${proyecto}</span></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Detalle de Haberes</div>
    <table>
      <thead><tr><th>Concepto</th><th>Detalle</th><th class="amount">Monto</th></tr></thead>
      <tbody>
        <tr>
          <td><b>Sueldo / Jornal Base</b></td>
          <td style="color:#6b7280;">${e.tipo==='jornal'?horas+' horas × S/ '+sueldoBase+'/h':'Mensual fijo'}</td>
          <td class="amount green">S/ ${sueldoBruto.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>
        <tr>
          <td>Horas trabajadas</td>
          <td style="color:#6b7280;">${horas} horas en el mes</td>
          <td class="amount">—</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-title">Descuentos del Trabajador</div>
    <table>
      <thead><tr><th>Concepto</th><th>Base</th><th class="amount">Descuento</th></tr></thead>
      <tbody>
        <tr>
          <td>ONP (Sistema Nacional de Pensiones)</td>
          <td style="color:#6b7280;">13% s/ S/ ${sueldoBruto.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
          <td class="amount red">- S/ ${onp.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>
        <tr class="total-row">
          <td colspan="2"><b>Total Descuentos</b></td>
          <td class="amount red"><b>- S/ ${totalDescuentos.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</b></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section" style="border-bottom:none;">
    <div class="section-title">Aportes del Empleador</div>
    <table>
      <thead><tr><th>Concepto</th><th>Tasa</th><th class="amount">Monto</th></tr></thead>
      <tbody>
        <tr><td>EsSalud</td><td style="color:#6b7280;">9%</td><td class="amount" style="color:#2563eb;">S/ ${essalud.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
        <tr><td>SCTR (Salud + Pensión)</td><td style="color:#6b7280;">0.9%</td><td class="amount" style="color:#2563eb;">S/ ${sctr.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
      </tbody>
    </table>
  </div>

  <div class="neto-box">
    <div class="label">Neto a Pagar al Trabajador</div>
    <div class="amount">S/ ${sueldoNeto.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
    <div class="sub">${mes} · ${e.nombre.toUpperCase()}</div>
  </div>

  <div class="footer">
    <span>📋 Generado por NorConstructores · ${fechaEmision}</span>
    <span>Firma empleador: ___________________</span>
    <span>Firma trabajador: ___________________</span>
  </div>
</div>

<div class="no-print" style="text-align:center;margin-top:20px;">
  <button onclick="window.print()" style="background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;border:none;padding:12px 32px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">🖨️ Imprimir / Guardar PDF</button>
</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('Boleta generada', 'Se abrió la boleta en nueva ventana — imprimí o guardá como PDF');
}

// ===================== MAQUINARIA =====================
function renderMaquinaria() {
  document.getElementById('maquinaria-sub').textContent = db.maquinaria.length + ' equipos registrados';
  const totalH = db.maquinaria.reduce((a,m)=>a+Number(m.horas),0);
  const totalI = db.maquinaria.reduce((a,m)=>a+(m.horas*m.tarifa),0);
  const totalC = db.maquinaria.reduce((a,m)=>a+(m.horas*m.costoHora),0);
  const rentProm = totalI > 0 ? ((totalI-totalC)/totalI*100).toFixed(1) : 0;
  document.getElementById('maq-total-horas').textContent = totalH + 'h';
  document.getElementById('maq-total-ingreso').textContent = fmtM(totalI);
  document.getElementById('maq-total-costo').textContent = fmtM(totalC);
  document.getElementById('maq-rentab-prom').textContent = rentProm + '%';
  const grid = document.getElementById('machines-grid');
  if (db.maquinaria.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="icon">🚜</div><p>No hay equipos registrados.</p></div>';
    return;
  }
  grid.innerHTML = db.maquinaria.map(m => {
    const ingreso = m.horas * m.tarifa;
    const costo = m.horas * m.costoHora;
    const utilidad = ingreso - costo;
    const rentab = ingreso > 0 ? ((utilidad/ingreso)*100).toFixed(1) : 0;
    const rentCls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';
    const estadoColor = m.estado === 'activo' ? 'var(--green)' : m.estado === 'pausado' ? 'var(--red)' : 'var(--accent)';
    const estadoTxt = m.estado === 'activo' ? 'Operativo' : m.estado === 'pausado' ? 'Mantenimiento' : 'Reservado';
    return `
    <div class="machine-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;">${m.nombre}</div>
          <div style="font-size:12px;color:var(--muted2);margin-top:3px;">${m.modelo} · ${m.matricula}</div>
        </div>
        <span style="background:rgba(255,255,255,0.05);color:${estadoColor};font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid ${estadoColor}33;">${estadoTxt}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Horas Mes</div>
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--blue);">${m.horas}h</div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Rentabilidad</div>
          <div class="${rentCls}" style="font-family:'Syne',sans-serif;font-size:18px;">${rentab}%</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:12px;margin-bottom:14px;">
        <div style="text-align:center;"><div style="color:var(--muted);">Ingreso</div><div style="font-weight:700;color:var(--green);">${fmtM(ingreso)}</div></div>
        <div style="text-align:center;"><div style="color:var(--muted);">Costo</div><div style="font-weight:700;color:var(--red);">${fmtM(costo)}</div></div>
        <div style="text-align:center;"><div style="color:var(--muted);">Utilidad</div><div style="font-weight:700;color:var(--accent);">${fmtM(utilidad)}</div></div>
      </div>
      <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;">
        📋 ${getProyectoNombre(m.proyecto)} &nbsp;·&nbsp; 🔧 ${m.mantenim || 'Sin fecha'}
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" style="flex:1" onclick="verMaquina('${m.id}')">👁 Ver Detalle</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('maquina','${m.id}')">✏️</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('maquina','${m.id}')">🗑️</button>
      </div>
    </div>`;
  }).join('');
}

function verMaquina(id) {
  currentMaquinaId = id;
  const m = db.maquinaria.find(x => x.id === id);
  if (!m) return;
  const ingreso = m.horas * m.tarifa;
  const costo = m.horas * m.costoHora;
  const utilidad = ingreso - costo;
  const rentab = ingreso > 0 ? ((utilidad/ingreso)*100).toFixed(1) : 0;
  const rentCls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';

  // Simulated weekly breakdown
  const semanas = [
    { sem:'Sem 1', horas:Math.round(m.horas*0.27), ingreso:Math.round(m.horas*0.27*m.tarifa), costo:Math.round(m.horas*0.27*m.costoHora) },
    { sem:'Sem 2', horas:Math.round(m.horas*0.23), ingreso:Math.round(m.horas*0.23*m.tarifa), costo:Math.round(m.horas*0.23*m.costoHora) },
    { sem:'Sem 3', horas:Math.round(m.horas*0.28), ingreso:Math.round(m.horas*0.28*m.tarifa), costo:Math.round(m.horas*0.28*m.costoHora) },
    { sem:'Sem 4', horas:Math.round(m.horas*0.22), ingreso:Math.round(m.horas*0.22*m.tarifa), costo:Math.round(m.horas*0.22*m.costoHora) },
  ];

  document.getElementById('maquina-detail-content').innerHTML = `
    <div style="display:flex;align-items:center;gap:18px;padding:18px;background:var(--bg3);border-radius:12px;margin-bottom:18px;border:1px solid var(--border);">
      <div style="font-size:42px;">🚜</div>
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">${m.nombre}</div>
        <div style="font-size:13px;color:var(--muted2);margin-top:3px;">${m.tipo} · ${m.modelo} · ${m.matricula}</div>
        <div style="margin-top:8px;">
          <span class="status-badge ${m.estado === 'activo' ? 'activo' : m.estado === 'pausado' ? 'pausado' : 'pendiente'}">${m.estado === 'activo' ? 'Operativo' : m.estado === 'pausado' ? 'Mantenimiento' : 'Reservado'}</span>
        </div>
      </div>
    </div>
    <div class="machine-kpi-grid">
      <div class="detail-item"><div class="d-label">Horas Trabajadas</div><div class="d-val" style="color:var(--blue)">${m.horas}h</div><div class="d-sub">Tarifa: ${fmt(m.tarifa)}/h</div></div>
      <div class="detail-item"><div class="d-label">Ingresos</div><div class="d-val" style="color:var(--green)">${fmtM(ingreso)}</div><div class="d-sub">${fmt(m.tarifa)}/h × ${m.horas}h</div></div>
      <div class="detail-item"><div class="d-label">Costo Operativo</div><div class="d-val" style="color:var(--red)">${fmtM(costo)}</div><div class="d-sub">${fmt(m.costoHora)}/h × ${m.horas}h</div></div>
      <div class="detail-item"><div class="d-label">Rentabilidad</div><div class="d-val ${rentCls}">${rentab}%</div><div class="d-sub">Utilidad: ${fmtM(utilidad)}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
      <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">Proyecto Asignado</div>
        <div style="font-weight:700;">${getProyectoNombre(m.proyecto)}</div>
      </div>
      <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">Próximo Mantenimiento</div>
        <div style="font-weight:700;color:${m.mantenim ? 'var(--accent)':'var(--muted)'};">${m.mantenim || 'No programado'}</div>
      </div>
    </div>
    ${m.obs ? `<div style="background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--muted2);border:1px solid var(--border);">📝 ${m.obs}</div>` : ''}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;color:var(--muted2);">DESGLOSE SEMANAL — MES ACTUAL</div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <table class="hours-table">
        <thead><tr><th>Semana</th><th>Horas</th><th>Ingreso</th><th>Costo</th><th>Utilidad</th><th>Rentab.</th></tr></thead>
        <tbody>
          ${semanas.map(s=>{
            const util = s.ingreso - s.costo;
            const r = s.ingreso>0?((util/s.ingreso)*100).toFixed(1):0;
            const c = r>=40?'var(--green)':r>=20?'var(--accent)':'var(--red)';
            return `<tr>
              <td style="font-weight:600;">${s.sem}</td>
              <td style="color:var(--blue);font-weight:700;">${s.horas}h</td>
              <td style="color:var(--green);">${fmt(s.ingreso)}</td>
              <td style="color:var(--red);">${fmt(s.costo)}</td>
              <td style="font-weight:700;">${fmt(util)}</td>
              <td style="color:${c};font-weight:700;">${r}%</td>
            </tr>`;
          }).join('')}
          <tr style="background:rgba(245,166,35,0.05);font-weight:700;">
            <td>TOTAL</td>
            <td style="color:var(--blue);font-family:'Syne',sans-serif;">${m.horas}h</td>
            <td style="color:var(--green);">${fmt(ingreso)}</td>
            <td style="color:var(--red);">${fmt(costo)}</td>
            <td style="color:var(--accent);font-family:'Syne',sans-serif;">${fmt(utilidad)}</td>
            <td class="${rentCls}" style="font-family:'Syne',sans-serif;">${rentab}%</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  openModal('maquina-detail');
}

function editMaquina() {
  closeModal('maquina-detail');
  openModal('maquina', currentMaquinaId);
}

function exportMaquinaExcel() {
  const m = db.maquinaria.find(x => x.id === currentMaquinaId);
  if (!m) return;
  const ing = m.horas * m.tarifa;
  const cos = m.horas * m.costoHora;
  exportToCSV([
    ['Campo', 'Valor'],
    ['Equipo', m.nombre], ['Tipo', m.tipo], ['Modelo', m.modelo], ['Matrícula', m.matricula],
    ['Horas Trabajadas', m.horas], ['Tarifa/Hora (USD)', m.tarifa], ['Costo Operativo/Hora (USD)', m.costoHora],
    ['Ingresos (USD)', ing], ['Costos (USD)', cos], ['Utilidad (USD)', ing-cos],
    ['Rentabilidad (%)', ing>0?((ing-cos)/ing*100).toFixed(1):0],
    ['Proyecto', getProyectoNombre(m.proyecto)], ['Estado', m.estado], ['Próx. Mantenimiento', m.mantenim],
    ['Observaciones', m.obs]
  ], 'maquina_' + m.nombre.replace(/ /g,'_'));
  toast('Excel generado', 'Archivo descargado: ' + m.nombre);
}

function exportMaquinariaExcel() {
  const rows = [['Equipo','Tipo','Modelo','Matrícula','Horas','Tarifa/h','Costo/h','Ingreso','Costo','Utilidad','Rentabilidad','Proyecto','Estado']];
  db.maquinaria.forEach(m => {
    const ing = m.horas * m.tarifa;
    const cos = m.horas * m.costoHora;
    rows.push([m.nombre,m.tipo,m.modelo,m.matricula,m.horas,m.tarifa,m.costoHora,ing,cos,ing-cos,ing>0?((ing-cos)/ing*100).toFixed(1)+'%':0,getProyectoNombre(m.proyecto),m.estado]);
  });
  exportToCSV(rows, 'maquinaria_completo');
  toast('Excel exportado', db.maquinaria.length + ' equipos exportados');
}

// ===================== MODALS =====================
function openModal(type, id, readonly) {
  if (type === 'proyecto') {
    const isEdit = !!id;
    document.getElementById('modal-proyecto-title').textContent = isEdit ? (readonly ? 'Detalle del Proyecto' : 'Editar Proyecto') : 'Nuevo Proyecto';
    document.getElementById('proyecto-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const p = db.proyectos.find(x => x.id === id);
      if (p) {
        document.getElementById('p-nombre').value = p.nombre;
        document.getElementById('p-tipo').value = p.tipo;
        document.getElementById('p-cliente').value = p.cliente;
        document.getElementById('p-presupuesto').value = p.presupuesto;
        document.getElementById('p-inicio').value = p.inicio || '';
        document.getElementById('p-fin').value = p.fin || '';
        document.getElementById('p-ubicacion').value = p.ubicacion || '';
        document.getElementById('p-estado').value = p.estado;
        document.getElementById('p-avance').value = p.avance;
        document.getElementById('p-descripcion').value = p.descripcion || '';
      }
    } else {
      clearForm(['p-nombre','p-cliente','p-presupuesto','p-inicio','p-fin','p-ubicacion','p-avance','p-descripcion']);
      document.getElementById('p-tipo').value = 'Residencial';
      document.getElementById('p-estado').value = 'pendiente';
    }
    document.getElementById('modal-proyecto').classList.add('open');
  }
  if (type === 'personal') {
    const isEdit = !!id;
    document.getElementById('modal-personal-title').textContent = isEdit ? 'Editar Empleado' : 'Agregar Personal';
    document.getElementById('emp-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const e = db.personal.find(x => x.id === id);
      if (e) {
        document.getElementById('emp-nombre').value = e.nombre;
        document.getElementById('emp-ci').value = e.ci;
        document.getElementById('emp-rol').value = e.rol;
        document.getElementById('emp-cuadrilla').value = e.cuadrilla || '';
        document.getElementById('emp-tipo').value = e.tipo;
        document.getElementById('emp-sueldo').value = e.sueldo;
        document.getElementById('emp-horas').value = e.horas;
        document.getElementById('emp-proyecto').value = e.proyecto || '';
        document.getElementById('emp-tel').value = e.tel || '';
        document.getElementById('emp-email').value = e.email || '';
        document.getElementById('emp-dir').value = e.dir || '';
        document.getElementById('emp-obs').value = e.obs || '';
        document.getElementById('emp-fecha-contrato').value = e.fechaContrato || '';
        document.getElementById('emp-fecha-fin').value = e.fechaFin || '';
        const penEl = document.getElementById('emp-pension'); if(penEl) penEl.value = e.pension || 'ONP';
        const afEl  = document.getElementById('emp-asig-familiar'); if(afEl) afEl.value = e.asigFamiliar ? 'si' : 'no';
        const ctEl  = document.getElementById('emp-cuenta'); if(ctEl) ctEl.value = e.cuenta || '';
      }
    } else {
      clearForm(['emp-nombre','emp-ci','emp-cuadrilla','emp-sueldo','emp-horas','emp-tel','emp-email','emp-dir','emp-obs','emp-fecha-contrato','emp-fecha-fin']);
    }
    document.getElementById('modal-personal').classList.add('open');
  }
  if (type === 'personal-detail') document.getElementById('modal-personal-detail').classList.add('open');
  if (type === 'maquina') {
    const isEdit = !!id;
    document.getElementById('modal-maquina-title').textContent = isEdit ? 'Editar Equipo' : 'Registrar Equipo';
    document.getElementById('maq-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const m = db.maquinaria.find(x => x.id === id);
      if (m) {
        document.getElementById('maq-nombre').value = m.nombre;
        document.getElementById('maq-tipo').value = m.tipo;
        document.getElementById('maq-modelo').value = m.modelo || '';
        document.getElementById('maq-matricula').value = m.matricula || '';
        document.getElementById('maq-horas').value = m.horas;
        document.getElementById('maq-tarifa').value = m.tarifa;
        document.getElementById('maq-costo-hora').value = m.costoHora;
        document.getElementById('maq-proyecto').value = m.proyecto || '';
        document.getElementById('maq-estado').value = m.estado;
        document.getElementById('maq-mantenim').value = m.mantenim || '';
        document.getElementById('maq-obs').value = m.obs || '';
      }
    } else {
      clearForm(['maq-nombre','maq-modelo','maq-matricula','maq-horas','maq-tarifa','maq-costo-hora','maq-mantenim','maq-obs']);
    }
    document.getElementById('modal-maquina').classList.add('open');
  }
  if (type === 'maquina-detail') document.getElementById('modal-maquina-detail').classList.add('open');
  if (type === 'usuario') {
    document.getElementById('usr-id').value = '';
    document.getElementById('usr-nombre').value = '';
    document.getElementById('usr-user').value = '';
    document.getElementById('usr-pass').value = '';
    document.getElementById('usr-pass2').value = '';
    document.getElementById('usr-rol').value = '';
    document.getElementById('usr-email').value = '';
    document.getElementById('usr-rol-desc').style.display = 'none';
    document.getElementById('modal-usr-title').textContent = 'Nuevo Usuario';
    populateProyectoDropdowns();
    const usrProy = document.getElementById('usr-proyecto');
    if (usrProy) usrProy.innerHTML = '<option value="">Todos los proyectos</option>' + db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
    document.getElementById('modal-usuario').classList.add('open');
    return;
  }
  if (type === 'presupuesto') {
    populateProyectoDropdowns();
    document.getElementById('modal-presupuesto').classList.add('open');
  }
  if (type === 'factura') {
    populateProyectoDropdowns();
    clearForm(['fac-numero','fac-cliente','fac-monto','fac-fecha','fac-vence']);
    document.getElementById('fac-estado').value = 'pendiente';
    document.getElementById('modal-factura').classList.add('open');
  }
  if (type === 'proveedor') {
    clearForm(['prov-nombre','prov-rut','prov-rubro','prov-tel']);
    document.getElementById('modal-proveedor').classList.add('open');
  }
  if (type === 'material') {
    populateProyectoDropdowns();
    clearForm(['mat-nombre','mat-cantidad','mat-resp']);
    document.getElementById('mat-tipo').value = 'ENTRADA';
    document.getElementById('modal-material').classList.add('open');
  }
  if (type === 'parte') {
    populateProyectoDropdowns();
    clearForm(['parte-cuadrilla','parte-actividad','parte-obreros','parte-horas','parte-obs']);
    document.getElementById('modal-parte').classList.add('open');
  }
  if (type === 'movimiento') {
    // Populate proyectos in modal
    const mp = document.getElementById('mov-proyecto');
    if (mp) {
      mp.innerHTML = '<option value="">Sin proyecto específico</option>' +
        db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
    }
    document.getElementById('mov-id').value = '';
    document.getElementById('mov-tipo').value = 'ingreso';
    document.getElementById('mov-monto').value = '';
    document.getElementById('mov-fecha').value = new Date().toLocaleDateString('sv-SE', {timeZone:'America/Lima'});
    document.getElementById('mov-categoria').value = 'cobro_cliente';
    document.getElementById('mov-descripcion').value = '';
    document.getElementById('mov-referencia').value = '';
  const provWrap = document.getElementById('mov-proveedor-wrap');
  if (provWrap) provWrap.style.display = 'none';
  const provSel = document.getElementById('mov-proveedor');
  if (provSel) provSel.value = '';
    if (mp) mp.value = '';
    document.getElementById('mov-modal-title').textContent = 'Registrar Movimiento';
    document.getElementById('modal-movimiento').classList.add('open');
  }
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('open');
}

// Close on overlay click
['proyecto','personal','personal-detail','maquina','maquina-detail','confirm'].forEach(t => {
  const el = document.getElementById('modal-' + t);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeModal(t); });
});

function clearForm(ids) { ids.forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; }); }

function populateProyectoDropdowns() {
  const opts = '<option value="">Sin asignar</option>' + db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  ['emp-proyecto','maq-proyecto'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
}

// ===================== SAVE — SUPABASE =====================
async function saveProyecto() {
  const nombre = document.getElementById('p-nombre').value.trim();
  const cliente = document.getElementById('p-cliente').value.trim();
  const presupuesto = Number(document.getElementById('p-presupuesto').value);
  if (!nombre || !cliente || !presupuesto) { toast('Campos requeridos', 'Completá nombre, cliente y presupuesto', 'err'); return; }
  const id = document.getElementById('proyecto-id').value;
  const data = {
    nombre, cliente, presupuesto,
    tipo: document.getElementById('p-tipo').value,
    inicio: document.getElementById('p-inicio').value || null,
    fin: document.getElementById('p-fin').value || null,
    ubicacion: document.getElementById('p-ubicacion').value,
    estado: document.getElementById('p-estado').value,
    avance: Number(document.getElementById('p-avance').value) || 0,
    descripcion: document.getElementById('p-descripcion').value,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('proyectos?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Proyecto actualizado', nombre);
    } else {
      await sbFetch('proyectos', { method: 'POST', body: data });
      toast('Proyecto guardado', nombre);
    }
    closeModal('proyecto');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

async function savePersonal() {
  const nombre = document.getElementById('emp-nombre').value.trim();
  const ci = document.getElementById('emp-ci').value.trim();
  if (!nombre || !ci) { toast('Campos requeridos', 'Completá nombre y cédula', 'err'); return; }
  const id = document.getElementById('emp-id').value;
  const proyId = document.getElementById('emp-proyecto').value;
  const data = {
    nombre, ci,
    rol: document.getElementById('emp-rol').value,
    cuadrilla: document.getElementById('emp-cuadrilla').value,
    tipo: document.getElementById('emp-tipo').value,
    sueldo: Number(document.getElementById('emp-sueldo').value) || 0,
    horas: Number(document.getElementById('emp-horas').value) || 0,
    proyecto_id: proyId || null,
    telefono: document.getElementById('emp-tel').value,
    email: document.getElementById('emp-email').value,
    direccion: document.getElementById('emp-dir').value,
    observaciones: document.getElementById('emp-obs').value,
    fecha_contrato: document.getElementById('emp-fecha-contrato').value || null,
    fecha_fin_contrato: document.getElementById('emp-fecha-fin').value || null,
    sistema_pension: document.getElementById('emp-pension')?.value || 'ONP',
    asig_familiar: document.getElementById('emp-asig-familiar')?.value === 'si',
    cuenta_banco: document.getElementById('emp-cuenta')?.value || '',
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('personal?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Empleado actualizado', nombre);
    } else {
      await sbFetch('personal', { method: 'POST', body: data });
      toast('Empleado guardado', nombre);
    }
    closeModal('personal');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

async function saveMaquina() {
  const nombre = document.getElementById('maq-nombre').value.trim();
  if (!nombre) { toast('Campo requerido', 'Ingresá el nombre del equipo', 'err'); return; }
  const id = document.getElementById('maq-id').value;
  const proyId = document.getElementById('maq-proyecto').value;
  const data = {
    nombre,
    tipo: document.getElementById('maq-tipo').value,
    modelo: document.getElementById('maq-modelo').value,
    matricula: document.getElementById('maq-matricula').value,
    horas: Number(document.getElementById('maq-horas').value) || 0,
    tarifa: Number(document.getElementById('maq-tarifa').value) || 0,
    costo_hora: Number(document.getElementById('maq-costo-hora').value) || 0,
    proyecto_id: proyId || null,
    estado: document.getElementById('maq-estado').value,
    proximo_mantenimiento: document.getElementById('maq-mantenim').value || null,
    observaciones: document.getElementById('maq-obs').value,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('maquinaria?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Equipo actualizado', nombre);
    } else {
      await sbFetch('maquinaria', { method: 'POST', body: data });
      toast('Equipo registrado', nombre);
    }
    closeModal('maquina');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== DELETE — SUPABASE =====================
function confirmDelete(type, id) {
  const msgs = {
    proyecto: '¿Eliminar este proyecto? Se perderán todos sus datos.',
    personal: '¿Eliminar este empleado del sistema?',
    maquina: '¿Eliminar este equipo del parque de maquinaria?',
  };
  document.getElementById('confirm-msg').textContent = msgs[type] || '¿Confirmar eliminación?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      const tableMap = { proyecto: 'proyectos', personal: 'personal', maquina: 'maquinaria' };
      await sbFetch(tableMap[type] + '?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Eliminado correctamente', '', 'err');
      await loadAllData();
    } catch(e) { toast('Error al eliminar', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

// ===================== SEARCH =====================
function globalSearch(val) {
  if (!val) return;
  const q = val.toLowerCase();
  const found = [
    ...db.proyectos.filter(p => p.nombre.toLowerCase().includes(q) || p.cliente.toLowerCase().includes(q)).map(p => p.nombre + ' (Proyecto)'),
    ...db.personal.filter(e => e.nombre.toLowerCase().includes(q) || e.ci.includes(q)).map(e => e.nombre + ' (Personal)'),
    ...db.maquinaria.filter(m => m.nombre.toLowerCase().includes(q) || m.matricula.toLowerCase().includes(q)).map(m => m.nombre + ' (Maquinaria)'),
  ];
  if (found.length > 0) toast('Resultados: ' + found.length, found.slice(0,3).join(', '));
}

// ===================== EXPORT CSV/EXCEL =====================
function exportToCSV(rows, filename) {
  const csv = rows.map(r => r.map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename + '.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===================== CONTRACT ALERTS =====================
function checkContractAlerts() {
  const today = new Date();
  const expiring = [];
  const expired = [];
  db.personal.forEach(e => {
    if (!e.fechaFin) return;
    const fin = new Date(e.fechaFin);
    const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) expired.push(e.nombre);
    else if (diffDays <= 30) expiring.push({ nombre: e.nombre, dias: diffDays });
  });
  if (expired.length > 0) {
    toast('⚠️ Contratos vencidos', expired.join(', ') + ' — Renovar urgente', 'err');
  } else if (expiring.length > 0) {
    const msg = expiring.map(x => x.nombre + ' (' + x.dias + 'd)').join(', ');
    toast('⏰ Contratos por vencer', msg, 'warn');
  }
}

// ===================== TOAST =====================
let toastTimer;
function toast(title, msg, type) {
  clearTimeout(toastTimer);
  const t = document.getElementById('toast');
  document.getElementById('toast-title').textContent = title;
  document.getElementById('toast-msg').textContent = msg || '';
  t.className = 'toast open' + (type === 'warn' ? ' warn' : type === 'err' ? ' err' : '');
  toastTimer = setTimeout(() => t.classList.remove('open'), 3500);
}

// Close on overlay click for new modals
['presupuesto','factura','proveedor','material','parte'].forEach(t => {
  const el = document.getElementById('modal-' + t);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeModal(t); });
});

// ===================== OBRAS =====================
// ===================== COTIZADOR =====================
const COTIZ_KEY = 'norconstruc_cotizaciones'; // fallback local
function loadCotizacionesLocal() {
  try { return JSON.parse(localStorage.getItem(COTIZ_KEY) || '[]'); } catch(e) { return []; }
}
let cotizaciones = loadCotizacionesLocal();

async function loadCotizacionesSB() {
  try {
    const rows = await sbFetch('cotizaciones?order=created_at.desc');
    cotizaciones = rows.map(c => ({
      id: c.id,
      nombre: c.nombre, cliente: c.cliente, tipo: c.tipo,
      area: c.area, duracion: c.duracion, fecha: c.fecha,
      descripcion: c.descripcion,
      rubros: c.rubros || { materiales:[], manodeobra:[], maquinaria:[], subcontratos:[] },
      gg: c.gg, util: c.util, igv: c.igv,
      estado: c.estado, precioFinal: c.precio_final
    }));
    renderCotizador();
  } catch(e) {
    cotizaciones = loadCotizacionesLocal();
    console.warn('Cotizaciones: usando local', e.message);
  }
}

async function saveCotizacionSB(data, id) {
  const payload = {
    nombre: data.nombre, cliente: data.cliente, tipo: data.tipo,
    area: data.area, duracion: data.duracion, fecha: data.fecha || null,
    descripcion: data.descripcion,
    rubros: data.rubros,
    gg: data.gg, util: data.util, igv: data.igv,
    estado: data.estado, precio_final: data.precioFinal
  };
  if (id) {
    await sbFetch('cotizaciones?id=eq.' + id, { method: 'PATCH', body: payload, prefer: 'return=minimal' });
  } else {
    const res = await sbFetch('cotizaciones', { method: 'POST', body: payload });
    return Array.isArray(res) ? res[0] : res;
  }
}

async function deleteCotizacionSB(id) {
  await sbFetch('cotizaciones?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
}
let cotizActual = null; // cotización en edición

const RUBROS = {
  materiales:  { label: '🧱 Materiales',    color: 'var(--accent)',  units: ['m²','m³','ml','kg','ton','bolsa','u.','galón','rollo'] },
  manodeobra:  { label: '👷 Mano de Obra',  color: 'var(--blue)',    units: ['hora','día','semana','mes','global'] },
  maquinaria:  { label: '🚜 Maquinaria',    color: 'var(--purple)',  units: ['hora','día','semana','mes','global'] },
  subcontratos:{ label: '🔌 Subcontratos',  color: 'var(--green)',   units: ['global','m²','punto','ml','u.'] },
};

// Sugerencias de ítems por rubro
const SUGERENCIAS = {
  materiales:  ['Cemento Portland','Acero Ø8','Acero Ø12','Acero Ø16','Arena fina','Arena gruesa','Grava','Ladrillos King Kong','Ladrillos caravista','Triplay','Madera tornillo','Alambre #16','Clavos 3"','Pintura látex','Pintura epóxica','Cerámico piso','Porcelanato','Vidrio templado','Tubería PVC 4"','Tubería PVC 2"','Cable NYY 16mm','Cable NYY 10mm','Concreto premezclado f\'c=210','Concreto premezclado f\'c=175'],
  manodeobra:  ['Albañil','Operario','Ayudante','Capataz','Jefe de cuadrilla','Electricista','Plomero','Carpintero','Soldador','Operador de maquinaria','Ing. residente','Ing. de seguridad'],
  maquinaria:  ['Retroexcavadora','Volquete 15m³','Grúa torre','Mezcladora concreto','Vibrador de concreto','Compactadora','Motoniveladora','Cisterna de agua','Andamio metálico','Encofrado metálico'],
  subcontratos:['Instalaciones eléctricas','Instalaciones sanitarias','Sistema contraincendios','HVAC / Aire acondicionado','Ascensores','Pintura general','Vidrios y aluminios','Jardinería','Seguridad y vigilancia','Limpieza de obra'],
};

function renderCotizador() {
  document.getElementById('badge-cotiz').textContent = cotizaciones.length;
  renderListaCotizaciones();
}

function renderListaCotizaciones() {
  const el = document.getElementById('cotiz-lista');
  if (cotizaciones.length === 0) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:28px;font-size:13px;">No hay cotizaciones aún. Hacé clic en "＋ Nueva Cotización".</div>';
    return;
  }
  const estadoConfig = {
    borrador:  { cls:'pendiente', color:'var(--accent)',  emoji:'📝' },
    enviada:   { cls:'activo',    color:'var(--blue)',    emoji:'📤' },
    aprobada:  { cls:'activo',    color:'var(--green)',   emoji:'✅' },
    rechazada: { cls:'pausado',   color:'var(--red)',     emoji:'❌' },
  };
  el.innerHTML = cotizaciones.map((c,i) => {
    const est = estadoConfig[c.estado] || estadoConfig.borrador;
    return `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:16px 14px;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:10px;">
      <div style="display:flex;align-items:center;gap:14px;min-width:0;flex:1;">
        <div style="width:44px;height:44px;background:linear-gradient(135deg,rgba(168,85,247,0.2),rgba(168,85,247,0.05));border:1px solid rgba(168,85,247,0.3);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;">${est.emoji}</div>
        <div style="min-width:0;">
          <div style="font-weight:700;font-size:14px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${c.nombre}</div>
          <div style="font-size:12px;color:var(--muted2);margin-top:2px;">${c.cliente} · ${c.tipo} · ${c.fecha||'Sin fecha'}</div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end;">
        <div style="text-align:right;">
          <div style="font-size:10px;color:var(--muted);margin-bottom:2px;text-transform:uppercase;letter-spacing:.5px;">Precio Final</div>
          <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:17px;color:var(--accent);">S/ ${Number(c.precioFinal||0).toLocaleString('es-PE')}</div>
        </div>
        <select onchange="cambiarEstadoCotiz(${i}, this.value)" style="background:${est.color}18;color:${est.color};border:1px solid ${est.color}44;border-radius:20px;padding:5px 10px;font-size:12px;font-weight:700;cursor:pointer;outline:none;appearance:none;-webkit-appearance:none;text-align:center;">
          <option value="borrador"  ${c.estado==='borrador' ?'selected':''}>📝 Borrador</option>
          <option value="enviada"   ${c.estado==='enviada'  ?'selected':''}>📤 Enviada</option>
          <option value="aprobada"  ${c.estado==='aprobada' ?'selected':''}>✅ Aprobada</option>
          <option value="rechazada" ${c.estado==='rechazada'?'selected':''}>❌ Rechazada</option>
        </select>
        <div style="display:flex;gap:5px;">
          <button class="btn btn-primary btn-sm" onclick="abrirCotizacion(${i})" title="Ver/Editar">👁 Ver</button>
          <button class="btn btn-success btn-sm" onclick="exportCotizExcel(${i})" title="Exportar Excel">📥</button>
          <button class="btn btn-ghost btn-sm" onclick="exportCotizPDF(${i})" title="Exportar PDF">📄</button>
          <button class="btn btn-danger btn-sm" onclick="eliminarCotizacion(${i})" title="Eliminar">🗑️</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function cambiarEstadoCotiz(idx, nuevoEstado) {
  cotizaciones[idx].estado = nuevoEstado;
  localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
  // Sync to Supabase if connected
  const cotizId = cotizaciones[idx].id;
  if (cotizId && !String(cotizId).startsWith('local_')) {
    sbFetch('cotizaciones?id=eq.' + cotizId, { method:'PATCH', body:{ estado: nuevoEstado } }).catch(()=>{});
  }
  const labels = { borrador:'Borrador', enviada:'Enviada ✉️', aprobada:'Aprobada ✅', rechazada:'Rechazada ❌' };
  toast('Estado actualizado', cotizaciones[idx].nombre + ' → ' + (labels[nuevoEstado]||nuevoEstado));
  renderListaCotizaciones();
}

function nuevaCotizacion() {
  cotizActual = {
    nombre:'', cliente:'', tipo:'Residencial', area:'', duracion:'',
    fecha: new Date().toLocaleString('sv-SE', {timeZone:'America/Lima'}).replace(' ','T').slice(0,10),
    descripcion:'',
    rubros: { materiales:[], manodeobra:[], maquinaria:[], subcontratos:[] },
    gg:10, util:15, igv:18,
    estado:'borrador', precioFinal:0
  };
  mostrarFormCotiz();
}

function abrirCotizacion(idx) {
  cotizActual = JSON.parse(JSON.stringify(cotizaciones[idx]));
  cotizActual._editIdx = idx;
  mostrarFormCotiz();
}

function mostrarFormCotiz() {
  document.getElementById('cotiz-lista-wrap').style.display = 'none';
  document.getElementById('cotiz-form-wrap').style.display = 'block';
  document.getElementById('btn-volver-cotiz').style.display = 'inline-flex';
  document.getElementById('btn-export-cotiz').style.display = 'inline-flex';
  document.getElementById('btn-pdf-cotiz').style.display = 'inline-flex';

  // Rellenar header
  document.getElementById('cot-nombre').value = cotizActual.nombre || '';
  document.getElementById('cot-cliente').value = cotizActual.cliente || '';
  document.getElementById('cot-tipo').value = cotizActual.tipo || 'Residencial';
  document.getElementById('cot-area').value = cotizActual.area || '';
  document.getElementById('cot-duracion').value = cotizActual.duracion || '';
  document.getElementById('cot-fecha').value = cotizActual.fecha || '';
  document.getElementById('cot-descripcion').value = cotizActual.descripcion || '';

  // Sliders
  document.getElementById('slider-gg').value = cotizActual.gg;
  document.getElementById('slider-util').value = cotizActual.util;
  document.getElementById('slider-igv').value = cotizActual.igv;

  // Renderizar rubros
  ['materiales','manodeobra','maquinaria','subcontratos'].forEach(r => {
    const tbody = document.getElementById('tbody-' + r);
    tbody.innerHTML = '';
    (cotizActual.rubros[r] || []).forEach(item => addRubroRow(r, item));
    if ((cotizActual.rubros[r] || []).length === 0) addRubroRow(r);
  });

  recalcResumen();
}

function ocultarFormCotiz() {
  cotizActual = null;
  document.getElementById('cotiz-lista-wrap').style.display = 'block';
  document.getElementById('cotiz-form-wrap').style.display = 'none';
  document.getElementById('btn-volver-cotiz').style.display = 'none';
  document.getElementById('btn-export-cotiz').style.display = 'none';
  document.getElementById('btn-pdf-cotiz').style.display = 'none';
  renderListaCotizaciones();
}

function addRubroRow(rubro, item = {}) {
  const tbody = document.getElementById('tbody-' + rubro);
  const sugs = SUGERENCIAS[rubro] || [];
  const units = RUBROS[rubro].units;
  const rowId = 'row-' + rubro + '-' + Date.now() + '-' + Math.random().toString(36).slice(2,6);

  const tr = document.createElement('tr');
  tr.id = rowId;
  tr.innerHTML = `
    <td style="padding:6px 8px;">
      <input type="text" class="form-input" style="min-width:160px;" list="sug-${rubro}" value="${item.desc||''}"
        placeholder="Descripción..." oninput="recalcRow('${rowId}','${rubro}')">
      <datalist id="sug-${rubro}">${sugs.map(s=>`<option value="${s}">`).join('')}</datalist>
    </td>
    <td style="padding:6px 8px;">
      <select class="form-input" style="min-width:80px;" oninput="recalcRow('${rowId}','${rubro}')">
        ${units.map(u=>`<option value="${u}" ${u===(item.unit||units[0])?'selected':''}>${u}</option>`).join('')}
      </select>
    </td>
    <td style="padding:6px 8px;">
      <input type="number" class="form-input" style="min-width:80px;" value="${item.qty||''}" min="0"
        placeholder="0" oninput="recalcRow('${rowId}','${rubro}')">
    </td>
    <td style="padding:6px 8px;">
      <input type="number" class="form-input" style="min-width:90px;" value="${item.price||''}" min="0"
        placeholder="0.00" oninput="recalcRow('${rowId}','${rubro}')">
    </td>
    <td style="padding:6px 8px;font-family:'Syne',sans-serif;font-weight:700;color:${RUBROS[rubro].color};" id="sub-${rowId}">
      S/ ${formatNum((item.qty||0)*(item.price||0))}
    </td>
    <td style="padding:6px 4px;">
      <button style="background:rgba(239,68,68,0.1);border:none;color:var(--red);cursor:pointer;border-radius:6px;padding:5px 8px;font-size:13px;" onclick="removeRow('${rowId}','${rubro}')">✕</button>
    </td>`;
  tbody.appendChild(tr);
}

function recalcRow(rowId, rubro) {
  const tr = document.getElementById(rowId);
  if (!tr) return;
  const inputs = tr.querySelectorAll('input[type="number"]');
  const qty = parseFloat(inputs[0].value) || 0;
  const price = parseFloat(inputs[1].value) || 0;
  const sub = qty * price;
  document.getElementById('sub-'+rowId).textContent = 'S/ ' + formatNum(sub);
  recalcResumen();
}

function removeRow(rowId, rubro) {
  const el = document.getElementById(rowId);
  if (el) el.remove();
  recalcResumen();
}

function getRubroTotal(rubro) {
  const tbody = document.getElementById('tbody-' + rubro);
  if (!tbody) return 0;
  let total = 0;
  tbody.querySelectorAll('tr').forEach(tr => {
    const inputs = tr.querySelectorAll('input[type="number"]');
    if (inputs.length >= 2) {
      total += (parseFloat(inputs[0].value)||0) * (parseFloat(inputs[1].value)||0);
    }
  });
  return total;
}

function recalcResumen() {
  const gg = parseInt(document.getElementById('slider-gg').value) || 0;
  const util = parseInt(document.getElementById('slider-util').value) || 0;
  const igv = parseInt(document.getElementById('slider-igv').value) || 0;
  document.getElementById('val-gg').textContent = gg + '%';
  document.getElementById('val-util').textContent = util + '%';
  document.getElementById('val-igv').textContent = igv + '%';

  const mat = getRubroTotal('materiales');
  const mdo = getRubroTotal('manodeobra');
  const maq = getRubroTotal('maquinaria');
  const sub = getRubroTotal('subcontratos');

  ['materiales','manodeobra','maquinaria','subcontratos'].forEach(r => {
    const el = document.getElementById('sub-' + r);
    if (el) el.textContent = 'S/ ' + formatNum(getRubroTotal(r));
  });

  const costoDirecto = mat + mdo + maq + sub;
  const montoGG = costoDirecto * gg / 100;
  const costoTotal = costoDirecto + montoGG;
  const montoUtil = costoTotal * util / 100;
  const subtotalSinIGV = costoTotal + montoUtil;
  const montoIGV = subtotalSinIGV * igv / 100;
  const precioFinal = subtotalSinIGV + montoIGV;

  document.getElementById('sub-materiales').textContent = 'S/ ' + formatNum(mat);
  document.getElementById('sub-manodeobra').textContent = 'S/ ' + formatNum(mdo);
  document.getElementById('sub-maquinaria').textContent = 'S/ ' + formatNum(maq);
  document.getElementById('sub-subcontratos').textContent = 'S/ ' + formatNum(sub);
  document.getElementById('res-materiales').textContent = 'S/ ' + formatNum(mat);
  document.getElementById('res-mdo').textContent = 'S/ ' + formatNum(mdo);
  document.getElementById('res-maq').textContent = 'S/ ' + formatNum(maq);
  document.getElementById('res-sub').textContent = 'S/ ' + formatNum(sub);
  document.getElementById('res-costo-directo').textContent = 'S/ ' + formatNum(costoDirecto);
  document.getElementById('res-precio-final').textContent = 'S/ ' + formatNum(precioFinal);
  document.getElementById('res-desglose-final').textContent =
    `CD: S/${formatNum(costoDirecto)} + GG: S/${formatNum(montoGG)} + Util: S/${formatNum(montoUtil)} + IGV: S/${formatNum(montoIGV)}`;
}

function getCotizData() {
  return {
    nombre: document.getElementById('cot-nombre').value.trim() || 'Sin nombre',
    cliente: document.getElementById('cot-cliente').value.trim() || 'Sin cliente',
    tipo: document.getElementById('cot-tipo').value,
    area: document.getElementById('cot-area').value,
    duracion: document.getElementById('cot-duracion').value,
    fecha: document.getElementById('cot-fecha').value,
    descripcion: document.getElementById('cot-descripcion').value,
    gg: parseInt(document.getElementById('slider-gg').value),
    util: parseInt(document.getElementById('slider-util').value),
    igv: parseInt(document.getElementById('slider-igv').value),
    rubros: {
      materiales: getRowsData('materiales'),
      manodeobra: getRowsData('manodeobra'),
      maquinaria: getRowsData('maquinaria'),
      subcontratos: getRowsData('subcontratos'),
    },
    estado: 'borrador',
    precioFinal: calcPrecioFinal(),
  };
}

function getRowsData(rubro) {
  const tbody = document.getElementById('tbody-' + rubro);
  if (!tbody) return [];
  const rows = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const desc = tr.querySelector('input[type="text"]');
    const sel = tr.querySelector('select');
    const nums = tr.querySelectorAll('input[type="number"]');
    if (desc && nums.length >= 2) {
      const qty = parseFloat(nums[0].value) || 0;
      const price = parseFloat(nums[1].value) || 0;
      if (desc.value.trim() || qty || price) {
        rows.push({ desc: desc.value.trim(), unit: sel ? sel.value : '', qty, price, sub: qty*price });
      }
    }
  });
  return rows;
}

function calcPrecioFinal() {
  const gg = parseInt(document.getElementById('slider-gg').value) || 0;
  const util = parseInt(document.getElementById('slider-util').value) || 0;
  const igv = parseInt(document.getElementById('slider-igv').value) || 0;
  const cd = ['materiales','manodeobra','maquinaria','subcontratos'].reduce((a,r) => a + getRubroTotal(r), 0);
  const total = cd * (1 + gg/100) * (1 + util/100) * (1 + igv/100);
  return Math.round(total);
}

async function guardarCotizacion() {
  const data = getCotizData();
  if (!data.nombre || data.nombre === 'Sin nombre') {
    toast('Campo requerido', 'Ingresá el nombre del proyecto', 'err'); return;
  }
  showLoading(true);
  try {
    if (cotizActual && cotizActual._editIdx !== undefined) {
      const existId = cotizaciones[cotizActual._editIdx]?.id;
      if (existId) {
        await saveCotizacionSB(data, existId);
        data.id = existId;
      }
      cotizaciones[cotizActual._editIdx] = data;
      toast('Cotización actualizada', data.nombre);
    } else {
      const saved = await saveCotizacionSB(data);
      if (saved?.id) data.id = saved.id;
      cotizaciones.push(data);
      toast('Cotización guardada', data.nombre);
    }
    // Also update local fallback
    localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
  } catch(e) {
    // Offline fallback
    if (cotizActual && cotizActual._editIdx !== undefined) {
      cotizaciones[cotizActual._editIdx] = data;
    } else {
      data.id = 'local_' + Date.now();
      cotizaciones.push(data);
    }
    localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
    toast('Guardado localmente', 'Sin conexión a Supabase', 'warn');
  } finally {
    showLoading(false);
  }
  document.getElementById('badge-cotiz').textContent = cotizaciones.length;
  ocultarFormCotiz();
}

async function eliminarCotizacion(idx) {
  const cotiz = cotizaciones[idx];
  showLoading(true);
  try {
    if (cotiz?.id && !String(cotiz.id).startsWith('local_')) {
      await deleteCotizacionSB(cotiz.id);
    }
  } catch(e) { console.warn('No se pudo eliminar de Supabase:', e.message); }
  finally { showLoading(false); }
  cotizaciones.splice(idx, 1);
  localStorage.setItem(COTIZ_KEY, JSON.stringify(cotizaciones));
  document.getElementById('badge-cotiz').textContent = cotizaciones.length;
  renderListaCotizaciones();
  toast('Cotización eliminada', '', 'err');
}

// ===== EXPORT EXCEL =====
function exportCotizExcel(idx) {
  const c = idx !== undefined ? cotizaciones[idx] : getCotizData();
  const rows = [
    ['COTIZACIÓN DE PROYECTO — NorConstructores'],
    [''],
    ['Proyecto:', c.nombre, '', 'Cliente:', c.cliente],
    ['Tipo:', c.tipo, '', 'Área:', c.area],
    ['Duración:', c.duracion + ' meses', '', 'Fecha:', c.fecha],
    [''],
    ['MATERIALES'],
    ['Descripción','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.materiales.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL MATERIALES', c.rubros.materiales.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['MANO DE OBRA'],
    ['Descripción','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.manodeobra.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL MANO DE OBRA', c.rubros.manodeobra.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['MAQUINARIA'],
    ['Descripción','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.maquinaria.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL MAQUINARIA', c.rubros.maquinaria.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['SUBCONTRATOS'],
    ['Descripción','Unidad','Cantidad','Precio Unit.','Subtotal'],
    ...( c.rubros.subcontratos.map(r => [r.desc, r.unit, r.qty, r.price, r.sub]) ),
    ['','','','SUBTOTAL SUBCONTRATOS', c.rubros.subcontratos.reduce((a,r)=>a+r.sub,0)],
    [''],
    ['RESUMEN DE COSTOS'],
    ['Costo Directo Total','', '', '', Object.values(c.rubros).flat().reduce((a,r)=>a+r.sub,0)],
    ['Gastos Generales', c.gg + '%'],
    ['Utilidad', c.util + '%'],
    ['IGV', c.igv + '%'],
    ['PRECIO FINAL OFERTA', '', '', '', c.precioFinal],
  ];
  exportToCSV(rows, 'cotizacion_' + c.nombre.replace(/\s+/g,'_').toLowerCase());
  toast('Excel exportado', c.nombre);
}

// ===== EXPORT PDF =====
function exportCotizPDF(idx) {
  const c = idx !== undefined ? cotizaciones[idx] : getCotizData();
  const gg = c.gg; const util = c.util; const igv = c.igv;
  const cd = Object.values(c.rubros).flat().reduce((a,r)=>a+r.sub,0);
  const montoGG = cd * gg/100;
  const costoTotal = cd + montoGG;
  const montoUtil = costoTotal * util/100;
  const subtotal = costoTotal + montoUtil;
  const montoIGV = subtotal * igv/100;
  const precioFinal = subtotal + montoIGV;

  const rubroRows = (rubro, titulo, color) => {
    if (!c.rubros[rubro] || c.rubros[rubro].length === 0) return '';
    const sub = c.rubros[rubro].reduce((a,r)=>a+r.sub,0);
    return `
      <tr><td colspan="5" style="background:#1a1a2e;padding:8px 12px;font-weight:700;font-size:12px;color:${color};">${titulo}</td></tr>
      <tr style="background:#111;"><th style="padding:7px 10px;font-size:11px;color:#888;text-transform:uppercase;">Descripción</th><th style="padding:7px 10px;font-size:11px;color:#888;">Unidad</th><th style="padding:7px 10px;font-size:11px;color:#888;">Cant.</th><th style="padding:7px 10px;font-size:11px;color:#888;">P.Unit</th><th style="padding:7px 10px;font-size:11px;color:#888;text-align:right;">Subtotal</th></tr>
      ${c.rubros[rubro].map(r => `<tr style="border-bottom:1px solid #222;"><td style="padding:7px 10px;font-size:12px;">${r.desc}</td><td style="padding:7px 10px;font-size:12px;color:#888;">${r.unit}</td><td style="padding:7px 10px;font-size:12px;">${r.qty}</td><td style="padding:7px 10px;font-size:12px;">S/ ${formatNum(r.price)}</td><td style="padding:7px 10px;font-size:12px;text-align:right;font-weight:600;">S/ ${formatNum(r.sub)}</td></tr>`).join('')}
      <tr style="background:#1a1a2e;"><td colspan="4" style="padding:8px 10px;font-size:12px;font-weight:700;">Subtotal ${titulo}</td><td style="padding:8px 10px;font-weight:800;color:${color};text-align:right;font-size:13px;">S/ ${formatNum(sub)}</td></tr>`;
  };

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#0d0f12; color:#f1f5f9; padding:0; }
    .page { max-width:800px; margin:0 auto; padding:32px 28px; }
    .header { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:28px; padding-bottom:20px; border-bottom:2px solid #f5a623; }
    .logo { font-size:24px; font-weight:900; } .logo span { color:#f5a623; }
    .badge { background:rgba(245,166,35,0.15); color:#f5a623; padding:5px 14px; border-radius:20px; font-size:12px; font-weight:700; border:1px solid rgba(245,166,35,0.3); }
    h1 { font-size:20px; font-weight:800; margin-bottom:4px; }
    .meta { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px; }
    .meta-box { background:#13161b; border:1px solid #222; border-radius:10px; padding:14px; }
    .meta-label { font-size:10px; color:#64748b; font-weight:700; text-transform:uppercase; letter-spacing:.5px; margin-bottom:4px; }
    .meta-val { font-size:13px; font-weight:600; }
    table { width:100%; border-collapse:collapse; margin-bottom:16px; }
    .resumen { background:#13161b; border:1px solid #222; border-radius:12px; padding:20px; margin-top:20px; }
    .res-row { display:flex; justify-content:space-between; padding:9px 0; border-bottom:1px solid #222; font-size:13px; }
    .res-row:last-child { border:none; }
    .precio-final { background:linear-gradient(135deg,rgba(245,166,35,0.15),rgba(232,82,26,0.1)); border:1px solid rgba(245,166,35,0.3); border-radius:12px; padding:20px; text-align:center; margin-top:16px; }
    .precio-final .label { font-size:11px; color:#94a3b8; font-weight:700; letter-spacing:1px; text-transform:uppercase; margin-bottom:8px; }
    .precio-final .valor { font-size:36px; font-weight:900; color:#f5a623; }
    .footer { text-align:center; margin-top:28px; padding-top:16px; border-top:1px solid #222; font-size:11px; color:#64748b; }
    @media print { body { background:#fff; color:#000; } .page { padding:20px; } }
  </style></head><body>
  <div class="page">
    <div class="header">
      <div><div class="logo">Nor<span>Constructores</span></div><div style="font-size:12px;color:#64748b;margin-top:2px;">Sistema de Gestión de Constructoras</div></div>
      <div style="text-align:right;"><span class="badge">COTIZACIÓN OFICIAL</span><div style="font-size:11px;color:#64748b;margin-top:6px;">Fecha: ${c.fecha}</div></div>
    </div>
    <h1>${c.nombre}</h1>
    <div style="font-size:13px;color:#94a3b8;margin-bottom:20px;">${c.descripcion||''}</div>
    <div class="meta">
      <div class="meta-box"><div class="meta-label">Cliente</div><div class="meta-val">${c.cliente}</div></div>
      <div class="meta-box"><div class="meta-label">Tipo de Obra</div><div class="meta-val">${c.tipo}</div></div>
      <div class="meta-box"><div class="meta-label">Área / Envergadura</div><div class="meta-val">${c.area||'—'}</div></div>
      <div class="meta-box"><div class="meta-label">Duración Estimada</div><div class="meta-val">${c.duracion ? c.duracion+' meses' : '—'}</div></div>
    </div>
    <table>
      ${rubroRows('materiales','🧱 MATERIALES','#f5a623')}
      ${rubroRows('manodeobra','👷 MANO DE OBRA','#3b82f6')}
      ${rubroRows('maquinaria','🚜 MAQUINARIA','#a855f7')}
      ${rubroRows('subcontratos','🔌 SUBCONTRATOS','#22c55e')}
    </table>
    <div class="resumen">
      <div style="font-weight:800;font-size:14px;margin-bottom:14px;">📊 Resumen de Costos</div>
      <div class="res-row"><span>Costo Directo Total</span><span style="font-weight:700;">S/ ${formatNum(cd)}</span></div>
      <div class="res-row"><span>Gastos Generales (${gg}%)</span><span>S/ ${formatNum(montoGG)}</span></div>
      <div class="res-row"><span>Utilidad / Ganancia (${util}%)</span><span style="color:#22c55e;">S/ ${formatNum(montoUtil)}</span></div>
      <div class="res-row"><span>IGV (${igv}%)</span><span>S/ ${formatNum(montoIGV)}</span></div>
    </div>
    <div class="precio-final">
      <div class="label">💰 Precio Final — Oferta a Presentar</div>
      <div class="valor">S/ ${formatNum(precioFinal)}</div>
      <div style="font-size:12px;color:#64748b;margin-top:8px;">Precio válido por 30 días desde la fecha de emisión</div>
    </div>
    <div class="footer">Cotización generada por NorConstructores — Sistema de Gestión<br>Este documento es una estimación sujeta a revisión técnica final</div>
  </div>
  <script>window.onload=()=>window.print();<\/script>
  </body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('PDF generado', 'Se abrió la ventana de impresión');
}

function formatNum(n) {
  return Number(n||0).toLocaleString('es-PE', { minimumFractionDigits:2, maximumFractionDigits:2 });
}

function renderObras() {
  const activas = db.proyectos.filter(p => p.estado === 'activo' || p.estado === 'progreso').length;
  const totalObreros = db.personal.filter(e => e.proyecto).length;
  const totalHoras = db.personal.reduce((a,e)=>a+Number(e.horas),0);
  document.getElementById('ob-activas').textContent = activas || 5;
  document.getElementById('ob-obreros').textContent = totalObreros || 96;
  document.getElementById('ob-horas').textContent = (totalHoras || 768) + 'h';
}

// ===================== PRESUPUESTOS =====================
function renderPresupuestos() {
  const total = db.presupuestos.length;
  const aprobados = db.presupuestos.filter(p=>p.estado==='aprobado').length;
  const revision = db.presupuestos.filter(p=>p.estado==='revision' || p.estado==='negociacion').length;
  const rechazados = db.presupuestos.filter(p=>p.estado==='rechazado').length;
  document.getElementById('pres-total').textContent = total;
  document.getElementById('pres-aprobados').textContent = aprobados;
  document.getElementById('pres-revision').textContent = revision;
  document.getElementById('pres-rechazados').textContent = rechazados;
  document.getElementById('badge-presupuestos').textContent = total;
  const tbody = document.getElementById('presupuestos-table');
  if (!tbody) return;
  if (db.presupuestos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay presupuestos. Hacé clic en "+ Nuevo Presupuesto".</td></tr>';
    return;
  }
  const estadoMap = { revision:'pendiente', aprobado:'activo', negociacion:'progreso', rechazado:'pausado' };
  const estadoTxt = { revision:'En Revisión', aprobado:'Aprobado', negociacion:'Negociación', rechazado:'Rechazado' };
  const rows = db.presupuestos.map(p => ({
    tr: `<tr>
      <td><div class="td-name">${p.nombre}</div></td>
      <td>${p.cliente}</td>
      <td style="font-weight:700;">${fmt(p.monto)}</td>
      <td style="color:var(--muted2);">${p.fecha || '—'}</td>
      <td><span class="status-badge ${estadoMap[p.estado]||'pendiente'}">${estadoTxt[p.estado]||p.estado}</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF generado','${p.nombre}')">📄 PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="editPresupuesto('${p.id}')">✏️</button>
        <button class="btn btn-danger btn-sm" onclick="deletePresupuesto('${p.id}')">🗑️</button>
      </div></td>
    </tr>`,
    card: `<div class="mobile-card">
      <div class="mc-header">
        <div><div class="mc-name">${p.nombre}</div><div class="mc-sub">${p.cliente}</div></div>
        <span class="status-badge ${estadoMap[p.estado]||'pendiente'}">${estadoTxt[p.estado]||p.estado}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Monto</div><div class="mc-val" style="color:var(--green)">${fmt(p.monto)}</div></div>
        <div><div class="mc-label">Fecha Envío</div><div class="mc-val">${p.fecha || '—'}</div></div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF','${p.nombre}')">📄 PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="editPresupuesto('${p.id}')">✏️ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="deletePresupuesto('${p.id}')">🗑️</button>
      </div>
    </div>`
  }));
  tbody.innerHTML = rows.map(r=>r.tr).join('');
  const mob = document.getElementById('presupuestos-mobile');
  if (mob) mob.innerHTML = rows.map(r=>r.card).join('');
}

function editPresupuesto(id) {
  const p = db.presupuestos.find(x=>x.id===id);
  if (!p) return;
  document.getElementById('pres-id').value = p.id;
  document.getElementById('pres-nombre').value = p.nombre;
  document.getElementById('pres-cliente').value = p.cliente;
  document.getElementById('pres-monto').value = p.monto;
  document.getElementById('pres-fecha').value = p.fecha||'';
  document.getElementById('pres-estado').value = p.estado;
  document.getElementById('pres-obs').value = p.obs||'';
  document.getElementById('modal-pres-title').textContent = 'Editar Presupuesto';
  document.getElementById('modal-presupuesto').classList.add('open');
}

async function deletePresupuesto(id) {
  document.getElementById('confirm-msg').textContent = '¿Eliminar este presupuesto?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('presupuestos?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Presupuesto eliminado','','err');
      await loadAllData(); renderPresupuestos();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

async function savePresupuesto() {
  const nombre = document.getElementById('pres-nombre').value.trim();
  const cliente = document.getElementById('pres-cliente').value.trim();
  const monto = Number(document.getElementById('pres-monto').value);
  if (!nombre || !cliente || !monto) { toast('Campos requeridos','Completá nombre, cliente y monto','err'); return; }
  const id = document.getElementById('pres-id').value;
  const data = {
    nombre, cliente, monto,
    fecha: document.getElementById('pres-fecha').value || null,
    estado: document.getElementById('pres-estado').value,
    observaciones: document.getElementById('pres-obs').value
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('presupuestos?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Presupuesto actualizado', nombre);
    } else {
      await sbFetch('presupuestos', { method: 'POST', body: data });
      toast('Presupuesto guardado', nombre);
    }
    closeModal('presupuesto');
    document.getElementById('pres-id').value = '';
    document.getElementById('modal-pres-title').textContent = 'Nuevo Presupuesto';
    await loadAllData(); renderPresupuestos();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== FACTURA SAVE =====================
async function saveFactura() {
  const numero = document.getElementById('fac-numero').value.trim();
  const cliente = document.getElementById('fac-cliente').value.trim();
  const monto = Number(document.getElementById('fac-monto').value);
  if (!numero || !cliente || !monto) { toast('Campos requeridos','Completá número, cliente y monto','err'); return; }
  const proyId = document.getElementById('fac-proyecto').value;
  const data = {
    numero, cliente, monto,
    proyecto_id: proyId || null,
    fecha_emision: document.getElementById('fac-fecha').value || null,
    fecha_vencimiento: document.getElementById('fac-vence').value || null,
    estado: document.getElementById('fac-estado').value
  };
  try {
    showLoading(true);
    await sbFetch('facturas', { method: 'POST', body: data });
    toast('Factura registrada', numero);
    closeModal('factura');
    clearForm(['fac-numero','fac-cliente','fac-monto','fac-fecha','fac-vence']);
    await loadAllData(); renderFacturas();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== PROVEEDOR SAVE =====================
async function saveProveedor() {
  const nombre = document.getElementById('prov-nombre').value.trim();
  if (!nombre) { toast('Campo requerido','Ingresá el nombre del proveedor','err'); return; }
  const data = {
    nombre,
    rut: document.getElementById('prov-rut').value,
    rubro: document.getElementById('prov-rubro').value,
    telefono: document.getElementById('prov-tel').value,
    estado: 'activo'
  };
  try {
    showLoading(true);
    await sbFetch('proveedores', { method: 'POST', body: data });
    toast('Proveedor guardado', nombre);
    closeModal('proveedor');
    clearForm(['prov-nombre','prov-rut','prov-rubro','prov-tel']);
    await loadAllData(); renderProveedores();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== MATERIAL SAVE =====================
async function saveMaterial() {
  const nombre = document.getElementById('mat-nombre').value.trim();
  if (!nombre) { toast('Campo requerido','Ingresá el nombre del material','err'); return; }
  const proyId = document.getElementById('mat-proyecto').value;
  const data = {
    nombre,
    tipo: document.getElementById('mat-tipo').value,
    cantidad: document.getElementById('mat-cantidad').value,
    proyecto_id: proyId || null,
    responsable: document.getElementById('mat-resp').value,
    fecha: new Date().toLocaleString('sv-SE', {timeZone:'America/Lima'}).replace(' ','T')
  };
  try {
    showLoading(true);
    await sbFetch('materiales', { method: 'POST', body: data });
    toast('Movimiento registrado', data.tipo + ': ' + nombre);
    closeModal('material');
    clearForm(['mat-nombre','mat-cantidad','mat-resp']);
    await loadAllData(); renderMateriales();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== PARTE DIARIO SAVE =====================
// ==================== PARTE DIARIO ====================
const PARTES_KEY = 'bc_partes_v1';
let _partes = [];

async function loadPartesSB() {
  try {
    const rows = await sbFetch('partes_diarios?order=fecha.desc,created_at.desc');
    _partes = rows.map(r => ({
      id: r.id, fecha: r.fecha, proyectoId: r.proyecto_id,
      cuadrilla: r.cuadrilla||'', capataz: r.capataz||'',
      actividad: r.actividad||'',
      obreros: parseFloat(r.obreros||0), horas: parseFloat(r.horas||0),
      clima: r.clima||'Despejado', materiales: r.materiales||'',
      maquinaria: r.maquinaria||'', incidencia: r.incidencia||'',
      observaciones: r.observaciones||'', usuario: r.usuario||''
    }));
    localStorage.setItem(PARTES_KEY, JSON.stringify(_partes));
  } catch(e) {
    try { _partes = JSON.parse(localStorage.getItem(PARTES_KEY)||'[]'); } catch(e2) { _partes=[]; }
  }
}

function toggleIncidencia(show) {
  const el = document.getElementById('parte-incidencia');
  if (el) el.style.display = show ? '' : 'none';
  const si = document.getElementById('btn-inc-si');
  const no = document.getElementById('btn-inc-no');
  if (si) si.style.background = show ? 'rgba(239,68,68,0.15)' : '';
  if (no) no.style.background = show ? '' : 'var(--bg4)';
}

async function saveParte() {
  const actividad = document.getElementById('parte-actividad').value.trim();
  const fecha     = document.getElementById('parte-fecha').value;
  if (!actividad) { toast('Campo requerido','Ingresá la actividad realizada','err'); return; }
  if (!fecha)     { toast('Campo requerido','Seleccioná la fecha','err'); return; }

  const data = {
    id: 'parte_'+Date.now(),
    fecha,
    proyectoId:    document.getElementById('parte-proyecto').value,
    cuadrilla:     document.getElementById('parte-cuadrilla').value,
    capataz:       document.getElementById('parte-capataz').value,
    actividad,
    obreros:       parseFloat(document.getElementById('parte-obreros').value)||0,
    horas:         parseFloat(document.getElementById('parte-horas').value)||8,
    clima:         document.getElementById('parte-clima').value,
    materiales:    document.getElementById('parte-materiales').value,
    maquinaria:    document.getElementById('parte-maquinaria').value,
    incidencia:    document.getElementById('parte-incidencia').value,
    observaciones: document.getElementById('parte-obs').value,
    usuario:       window._sessionUser||''
  };

  const payload = {
    fecha: data.fecha, proyecto_id: data.proyectoId||null,
    cuadrilla: data.cuadrilla, capataz: data.capataz,
    actividad: data.actividad, obreros: data.obreros, horas: data.horas,
    clima: data.clima, materiales: data.materiales, maquinaria: data.maquinaria,
    incidencia: data.incidencia, observaciones: data.observaciones, usuario: data.usuario
  };

  try {
    showLoading(true);
    const res = await sbFetch('partes_diarios', { method:'POST', body: payload });
    data.id = (Array.isArray(res)?res[0]:res)?.id || data.id;
    toast('✅ Parte guardado', actividad);
  } catch(e) {
    toast('⚠️ Guardado localmente','Se sincronizará cuando haya conexión','warn');
  } finally { showLoading(false); }

  _partes.unshift(data);
  localStorage.setItem(PARTES_KEY, JSON.stringify(_partes));
  closeModal('parte');
  clearForm(['parte-cuadrilla','parte-capataz','parte-actividad','parte-obreros',
             'parte-horas','parte-materiales','parte-maquinaria','parte-incidencia','parte-obs']);
  toggleIncidencia(false);
  renderObras();
}

async function eliminarParte(id) {
  if (!confirm('¿Eliminar este parte diario?')) return;
  try {
    if (!String(id).startsWith('parte_'))
      await sbFetch('partes_diarios?id=eq.'+id, {method:'DELETE', prefer:'return=minimal'});
  } catch(e) {}
  _partes = _partes.filter(p => p.id !== id);
  localStorage.setItem(PARTES_KEY, JSON.stringify(_partes));
  renderObras();
  toast('Parte eliminado','','err');
}

function exportPartesExcel() {
  if (!_partes.length) { toast('Sin datos','No hay partes registrados','warn'); return; }
  const rows=[['Fecha','Proyecto','Cuadrilla','Capataz','Actividad','Obreros','Horas','HH Total','Clima','Materiales','Maquinaria','Incidencia','Observaciones','Usuario']];
  _partes.forEach(p=>rows.push([p.fecha, getProyectoNombre(p.proyectoId)||'Sin asignar',
    p.cuadrilla, p.capataz, p.actividad, p.obreros, p.horas, p.obreros*p.horas,
    p.clima, p.materiales, p.maquinaria, p.incidencia||'', p.observaciones, p.usuario]));
  exportToCSV(rows, 'partes_diarios_'+new Date().toISOString().slice(0,10));
  toast('📥 Excel exportado', _partes.length+' partes');
}

function renderObras() {
  // Poblar filtro de proyectos
  const selP = document.getElementById('obras-proyecto-filter');
  if (selP && db.proyectos.length) {
    const cur = selP.value;
    selP.innerHTML = '<option value="">Todos los proyectos</option>' +
      db.proyectos.map(p=>'<option value="'+p.id+'"'+(p.id===cur?' selected':'')+'>'+p.nombre+'</option>').join('');
  }
  // Fecha por defecto = hoy
  const fi = document.getElementById('obras-fecha-filter');
  if (fi && !fi.value) fi.value = new Date().toISOString().slice(0,10);
  const fechaSel = fi?.value||'';
  const proyeSel = document.getElementById('obras-proyecto-filter')?.value||'';

  // Filtrar
  let pf = _partes;
  if (fechaSel) pf = pf.filter(p=>p.fecha===fechaSel);
  if (proyeSel) pf = pf.filter(p=>p.proyectoId===proyeSel);

  // KPIs
  const activas   = db.proyectos.filter(p=>p.estado==='activo'||p.estado==='progreso').length;
  const setEl = (id,v)=>{ const e=document.getElementById(id); if(e) e.textContent=v; };
  setEl('ob-activas',     activas);
  setEl('ob-obreros',     pf.reduce((s,p)=>s+p.obreros,0));
  setEl('ob-horas',       pf.reduce((s,p)=>s+p.horas,0)+'h');
  setEl('ob-partes-hoy',  pf.length);
  setEl('ob-incidencias', pf.filter(p=>p.incidencia&&p.incidencia.trim()).length);
  setEl('badge-obras',    _partes.length);

  const fl = fechaSel
    ? new Date(fechaSel+'T12:00:00').toLocaleDateString('es-PE',{weekday:'long',day:'numeric',month:'long'})
    : 'Todos los días';
  setEl('obras-fecha-label', fl);
  setEl('obras-total-label', pf.length+' parte'+(pf.length!==1?'s':''));
  setEl('obras-sub', _partes.length+' partes · '+activas+' obras activas');

  const f2  = v=>parseFloat(v||0).toFixed(1);
  const ico = c=>c.includes('Lluvia')?'🌧️':c.includes('Nublado')?'⛅':c.includes('Viento')?'💨':c.includes('Tormenta')?'🌩️':'☀️';

  // Tabla escritorio
  const tbody = document.getElementById('obras-partes-table');
  if (tbody) {
    tbody.innerHTML = !pf.length
      ? '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:32px;">Sin partes para este filtro.</td></tr>'
      : pf.map(p=>{
          const pn = getProyectoNombre(p.proyectoId)||'Sin asignar';
          const inc = p.incidencia&&p.incidencia.trim()
            ? '<span style="color:var(--red);">⚠️</span><div style="font-size:10px;color:var(--red);max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="'+p.incidencia+'">'+p.incidencia+'</div>'
            : '<span style="color:var(--muted2);font-size:11px;">—</span>';
          return '<tr>'+
            '<td style="font-size:11px;white-space:nowrap;">'+p.fecha+'</td>'+
            '<td><div class="td-name">'+pn+'</div></td>'+
            '<td style="font-size:12px;">'+(p.cuadrilla||'—')+(p.capataz?'<div class="td-sub">'+p.capataz+'</div>':'')+'</td>'+
            '<td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="'+p.actividad+'">'+p.actividad+'</td>'+
            '<td style="text-align:center;font-weight:700;">'+p.obreros+'</td>'+
            '<td style="text-align:center;">'+f2(p.horas)+'h<br><span style="font-size:10px;color:var(--muted2);">'+f2(p.obreros*p.horas)+' HH</span></td>'+
            '<td>'+ico(p.clima)+'</td>'+
            '<td>'+inc+'</td>'+
            '<td><button class="btn btn-danger btn-sm" onclick="eliminarParte(&quot;'+p.id+'&quot;)">🗑️</button></td>'+
          '</tr>';
        }).join('');
  }

  // Mobile
  const mob = document.getElementById('obras-partes-mobile');
  if (mob) {
    mob.innerHTML = !pf.length
      ? '<div style="text-align:center;color:var(--muted);padding:24px;">Sin partes.</div>'
      : pf.map(p=>
          '<div class="mobile-card">'+
            '<div class="mc-header">'+
              '<div><div class="mc-name">'+(getProyectoNombre(p.proyectoId)||'Sin asignar')+'</div>'+
              '<div class="mc-sub">'+p.fecha+(p.cuadrilla?' · '+p.cuadrilla:'')+'</div></div>'+
              '<div style="text-align:right;">'+ico(p.clima)+'<br><span style="color:var(--blue);font-size:12px;">'+p.obreros+' ob.</span></div>'+
            '</div>'+
            '<div class="mc-body">'+
              '<div><div class="mc-label">Actividad</div><div class="mc-val" style="font-size:12px;">'+p.actividad+'</div></div>'+
              '<div><div class="mc-label">Horas / HH</div><div class="mc-val">'+f2(p.horas)+'h · '+f2(p.obreros*p.horas)+' HH</div></div>'+
              (p.incidencia?'<div><div class="mc-label" style="color:var(--red);">⚠️ Incidencia</div><div class="mc-val" style="font-size:11px;color:var(--red);">'+p.incidencia+'</div></div>':'')+
            '</div>'+
            '<div class="mc-actions"><button class="btn btn-danger btn-sm" onclick="eliminarParte(&quot;'+p.id+'&quot;)">🗑️</button></div>'+
          '</div>'
        ).join('');
  }
}

// ===================== REPORTES =====================
function renderReportes() {
  const totalPres = db.proyectos.reduce((a,p)=>a+Number(p.presupuesto),0);
  document.getElementById('rep-cartera').textContent = fmtM(totalPres);
  const activos = db.proyectos.filter(p=>p.estado!=='pausado').length;
  const finalizados = db.proyectos.filter(p=>p.estado==='finalizado').length;
  const cumpl = activos > 0 ? Math.round((finalizados / activos) * 100) || 78 : 78;
  document.getElementById('rep-cumplimiento').textContent = cumpl + '%';
  const now = new Date();
  document.getElementById('rep-fecha').textContent = 'Datos al ' + now.toLocaleDateString('es-UY');
  const tbody = document.getElementById('reportes-table');
  if (!tbody) return;
  if (db.proyectos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos.</td></tr>';
    return;
  }
  tbody.innerHTML = db.proyectos.map(p => {
    const ejecutado = (p.presupuesto * p.avance / 100);
    const desv = (Math.random() * 6 - 2).toFixed(1);
    const margen = (20 + Math.random() * 8).toFixed(1);
    const desvColor = desv > 0 ? 'var(--red)' : 'var(--green)';
    return `<tr>
      <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.tipo}</div></td>
      <td>${fmtM(p.presupuesto)}</td>
      <td>${fmtM(Math.round(ejecutado))}</td>
      <td style="color:${desvColor};font-weight:700;">${desv > 0 ? '+' : ''}${desv}%</td>
      <td style="color:var(--green);font-weight:700;">${margen}%</td>
      <td><div style="display:flex;align-items:center;gap:8px;font-size:12px;min-width:120px">
        <div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>${p.avance}%
      </div></td>
    </tr>`;
  }).join('');
}

// ===================== CANVAS CHARTS =====================

// Shared helpers
function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

function drawLineChart(canvasId, datasets, labels, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
  const H = opts.height || 140;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const pad = { top: 20, right: 20, bottom: 28, left: 42 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  // Background
  ctx.fillStyle = 'transparent';
  ctx.clearRect(0, 0, W, H);

  // Find max
  const allVals = datasets.flatMap(d => d.data);
  const maxVal = Math.max(...allVals) * 1.15;
  const minVal = 0;

  // Grid lines
  const gridCount = 4;
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= gridCount; i++) {
    const y = pad.top + ch - (ch * i / gridCount);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    const val = (minVal + (maxVal - minVal) * i / gridCount);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans, sans-serif'; ctx.textAlign = 'right';
    ctx.fillText((val >= 1 ? val.toFixed(1) : val.toFixed(2)) + (opts.unit || ''), pad.left - 6, y + 3);
  }

  // X labels
  ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.font = '10px DM Sans, sans-serif';
  labels.forEach((lbl, i) => {
    const x = pad.left + (i / (labels.length - 1)) * cw;
    ctx.fillText(lbl, x, H - 6);
  });

  // Draw each dataset
  datasets.forEach(ds => {
    const pts = ds.data.map((v, i) => ({
      x: pad.left + (i / (ds.data.length - 1)) * cw,
      y: pad.top + ch - ((v - minVal) / (maxVal - minVal)) * ch
    }));

    // Area fill
    if (ds.fill !== false) {
      const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
      grad.addColorStop(0, `rgba(${hexToRgb(ds.color)},0.25)`);
      grad.addColorStop(1, `rgba(${hexToRgb(ds.color)},0)`);
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pad.top + ch);
      pts.forEach(p => ctx.lineTo(p.x, p.y));
      ctx.lineTo(pts[pts.length-1].x, pad.top + ch);
      ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();
    }

    // Line
    ctx.beginPath();
    ctx.strokeStyle = ds.color; ctx.lineWidth = ds.lineWidth || 2.5;
    if (ds.dashed) ctx.setLineDash([5, 3]); else ctx.setLineDash([]);
    pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
    ctx.stroke(); ctx.setLineDash([]);

    // Dots on last point
    const last = pts[pts.length - 1];
    ctx.beginPath(); ctx.arc(last.x, last.y, 4, 0, Math.PI*2);
    ctx.fillStyle = ds.color; ctx.fill();
    ctx.strokeStyle = '#13161b'; ctx.lineWidth = 2; ctx.stroke();
  });
}

function drawBarChart(canvasId, labels, values, colors, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 400;
  const H = opts.height || 200;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const pad = { top: 24, right: 16, bottom: 32, left: 48 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;
  const maxVal = Math.max(...values) * 1.15;
  const barW = Math.min(42, (cw / labels.length) * 0.55);
  const gap = cw / labels.length;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (ch * i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    const v = (maxVal * i / 4);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'right';
    ctx.fillText(v >= 1000 ? (v/1000).toFixed(0)+'k' : v.toFixed(0), pad.left - 6, y + 3);
  }

  // Animate bars
  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, W, H);
    // Redraw grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + ch - (ch * i / 4);
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
      const v = (maxVal * i / 4);
      ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'right';
      ctx.fillText(v >= 1000 ? (v/1000).toFixed(0)+'k' : v.toFixed(0), pad.left - 6, y + 3);
    }

    values.forEach((v, i) => {
      const x = pad.left + gap * i + gap / 2 - barW / 2;
      const fullH = (v / maxVal) * ch;
      const animH = fullH * Math.min(progress, 1);
      const y = pad.top + ch - animH;

      // Bar gradient
      const grad = ctx.createLinearGradient(0, y, 0, pad.top + ch);
      grad.addColorStop(0, colors[i % colors.length]);
      grad.addColorStop(1, colors[i % colors.length] + '88');
      ctx.fillStyle = grad;
      ctx.beginPath();
      const r = 4;
      ctx.moveTo(x + r, y); ctx.lineTo(x + barW - r, y);
      ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
      ctx.lineTo(x + barW, pad.top + ch); ctx.lineTo(x, pad.top + ch);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath(); ctx.fill();

      // Value label on top
      if (progress >= 1) {
        ctx.fillStyle = '#f1f5f9'; ctx.textAlign = 'center'; ctx.font = 'bold 10px DM Sans';
        ctx.fillText(v >= 1000 ? '$'+(v/1000).toFixed(0)+'k' : '$'+v, x + barW/2, y - 5);
      }

      // X label
      ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.font = '9.5px DM Sans';
      ctx.fillText(labels[i], x + barW/2, H - 6);
    });

    if (progress < 1) { progress += 0.06; requestAnimationFrame(animate); }
  };
  animate();
}

function drawHorizontalBarChart(canvasId, labels, values, colors, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 400;
  const H = opts.height || 200;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const pad = { top: 8, right: 50, bottom: 8, left: 120 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;
  const rowH = ch / labels.length;
  const barH = Math.min(20, rowH * 0.55);

  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, W, H);
    labels.forEach((lbl, i) => {
      const y = pad.top + rowH * i + rowH / 2;
      // Label
      ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'right'; ctx.font = '12px DM Sans';
      ctx.fillText(lbl, pad.left - 10, y + 4);

      // Background track
      ctx.fillStyle = 'rgba(255,255,255,0.05)';
      ctx.beginPath(); ctx.roundRect(pad.left, y - barH/2, cw, barH, 4); ctx.fill();

      // Bar
      const pct = (values[i] / 100);
      const barW = cw * pct * Math.min(progress, 1);
      const grad = ctx.createLinearGradient(pad.left, 0, pad.left + cw, 0);
      grad.addColorStop(0, colors[i % colors.length]);
      grad.addColorStop(1, colors[i % colors.length] + 'aa');
      ctx.fillStyle = grad;
      if (barW > 4) {
        ctx.beginPath(); ctx.roundRect(pad.left, y - barH/2, barW, barH, 4); ctx.fill();
      }

      // Percentage label
      if (progress >= 1) {
        ctx.fillStyle = colors[i % colors.length]; ctx.textAlign = 'left'; ctx.font = 'bold 11px Syne, sans-serif';
        ctx.fillText(values[i] + '%', pad.left + cw + 6, y + 4);
      }
    });
    if (progress < 1) { progress += 0.05; requestAnimationFrame(animate); }
  };
  animate();
}

function drawDonutChart(canvasId, data, legendId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const S = 160;
  canvas.width = S * dpr; canvas.height = S * dpr;
  canvas.style.width = S + 'px'; canvas.style.height = S + 'px';
  ctx.scale(dpr, dpr);

  const cx = S/2, cy = S/2, outerR = 68, innerR = 44;
  const total = data.reduce((a,d) => a + d.value, 0);
  let startAngle = -Math.PI / 2;

  // Animate
  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, S, S);

    // Shadow
    ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 12;

    let sa = -Math.PI / 2;
    data.forEach(d => {
      const sweep = (d.value / total) * Math.PI * 2 * Math.min(progress, 1);
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, outerR, sa, sa + sweep);
      ctx.closePath();
      ctx.fillStyle = d.color;
      ctx.fill();
      sa += sweep;
    });

    ctx.shadowBlur = 0;

    // Inner circle cutout
    ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2);
    ctx.fillStyle = '#13161b'; ctx.fill();

    // Center text
    if (progress >= 1) {
      ctx.fillStyle = '#f1f5f9'; ctx.textAlign = 'center'; ctx.font = 'bold 18px Syne, sans-serif';
      ctx.fillText(total, cx, cy + 2);
      ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans';
      ctx.fillText('proyectos', cx, cy + 16);
    }

    if (progress < 1) { progress += 0.04; requestAnimationFrame(animate); }
  };
  animate();

  // Legend
  if (legendId) {
    const leg = document.getElementById(legendId);
    if (leg) leg.innerHTML = data.map(d => `
      <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;">
        <div style="display:flex;align-items:center;gap:8px;color:var(--muted2);">
          <div style="width:10px;height:10px;border-radius:3px;background:${d.color};flex-shrink:0;"></div>${d.label}
        </div>
        <div style="font-weight:700;color:var(--text);">${d.value} — ${Math.round(d.value/total*100)}%</div>
      </div>`).join('');
  }
}

// ===================== CHART INITIALIZERS =====================
function initDashCharts() {
  // Line chart data (facturación vs costos)
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'];
  drawLineChart('dash-line-chart', [
    { data: [1.2, 1.8, 2.1, 1.9, 2.8, 3.2, 3.0, 3.8, 4.2, 4.8], color: '#f5a623', label: 'Facturado' },
    { data: [0.9, 1.3, 1.6, 1.5, 2.1, 2.5, 2.3, 2.9, 3.1, 3.6], color: '#3b82f6', label: 'Costo', dashed: true, fill: false }
  ], months, { unit: 'M', height: 140 });

  // Donut chart
  const tipoCount = {};
  db.proyectos.forEach(p => { tipoCount[p.tipo] = (tipoCount[p.tipo] || 0) + 1; });
  const tipoColors = { Residencial: '#f5a623', Comercial: '#3b82f6', Industrial: '#22c55e', Infraestructura: '#a855f7', Institucional: '#14b8a6', Vial: '#f59e0b' };
  let donutData = Object.entries(tipoCount).map(([k,v]) => ({ label: k, value: v, color: tipoColors[k] || '#64748b' }));
  if (donutData.length === 0) donutData = [
    { label: 'Residencial', value: 4, color: '#f5a623' },
    { label: 'Comercial', value: 3, color: '#3b82f6' },
    { label: 'Industrial', value: 2, color: '#22c55e' },
    { label: 'Infraestructura', value: 3, color: '#a855f7' }
  ];
  drawDonutChart('dash-donut-chart', donutData, 'dash-donut-legend');
}

function initReportesCharts() {
  // ── 1. COSTOS POR RUBRO — desde movimientos reales de Flujo de Caja ──────────
  const rubroMap = {
    'materiales':      { label: 'Materiales',   color: '#f5a623' },
    'planilla':        { label: 'Mano de Obra', color: '#3b82f6' },
    'pago_proveedor':  { label: 'Subcontratos', color: '#22c55e' },
    'maquinaria':      { label: 'Maquinaria',   color: '#a855f7' },
    'gastos_generales':{ label: 'Adm. y Gral.', color: '#14b8a6' },
    'impuestos':       { label: 'Impuestos',    color: '#ef4444' },
    'otro':            { label: 'Otros',         color: '#64748b' },
  };

  // Sumar egresos por categoría
  const totalesCat = {};
  _movimientos.filter(m => m.tipo === 'egreso').forEach(m => {
    const cat = m.categoria || 'otro';
    totalesCat[cat] = (totalesCat[cat] || 0) + parseFloat(m.monto || 0);
  });

  // También incluir ingresos de clientes como referencia
  const totalIngresos = _movimientos
    .filter(m => m.tipo === 'ingreso')
    .reduce((s, m) => s + parseFloat(m.monto || 0), 0);

  // Armar arrays para el gráfico, ordenado de mayor a menor
  let rubroEntries = Object.entries(totalesCat)
    .filter(([,v]) => v > 0)
    .sort((a, b) => b[1] - a[1]);

  // Actualizar subtítulo con mes actual
  const subtitleEl = document.querySelector('#page-reportes .card-subtitle');
  if (subtitleEl) subtitleEl.textContent = 'Egresos reales acumulados — S/';

  if (rubroEntries.length === 0) {
    // Sin movimientos aún — mostrar mensaje en canvas
    const ctx = document.getElementById('rep-bar-chart');
    if (ctx) {
      const c = ctx.getContext('2d');
      c.clearRect(0, 0, ctx.width, ctx.height);
      c.fillStyle = '#64748b';
      c.font = '13px Arial';
      c.textAlign = 'center';
      c.fillText('Sin egresos registrados en Flujo de Caja', ctx.width / 2, 80);
      c.fillText('Registrá movimientos para ver este gráfico', ctx.width / 2, 100);
    }
  } else {
    const barLabels = rubroEntries.map(([cat]) => rubroMap[cat]?.label || cat);
    const barValues = rubroEntries.map(([,v]) => v);
    const barColors = rubroEntries.map(([cat]) => rubroMap[cat]?.color || '#64748b');
    drawBarChart('rep-bar-chart', barLabels, barValues, barColors, { height: 200 });
  }

  // ── 2. AVANCE POR PROYECTO — desde db.proyectos con cálculo automático ──────
  calcAndSyncAvances();
  const proyLabels = db.proyectos.length
    ? db.proyectos.map(p => p.nombre.length > 16 ? p.nombre.slice(0,14)+'…' : p.nombre)
    : ['Sin proyectos'];
  const proyVals = db.proyectos.length
    ? db.proyectos.map(p => p._avanceAuto !== undefined ? p._avanceAuto : (p.avance || 0))
    : [0];
  const proyColors = db.proyectos.map(p => p._atrasado ? '#ef4444' : '#f5a623');
  drawHorizontalBarChart('rep-hbar-chart', proyLabels, proyVals,
    proyColors.length ? proyColors : ['#f5a623'],
    { height: Math.max(160, db.proyectos.length * 36) }
  );

  // ── 3. EVOLUCIÓN MENSUAL — ingresos y egresos reales de los últimos 8 meses ─
  const now = new Date();
  const monthLabels = [];
  const ingData = [];
  const egrData = [];
  for (let i = 7; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const mesStr = d.toISOString().slice(0, 7); // YYYY-MM
    monthLabels.push(d.toLocaleDateString('es-PE', { month: 'short', year: '2-digit' }));
    const movsMes = _movimientos.filter(m => m.fecha && m.fecha.startsWith(mesStr));
    const ing = movsMes.filter(m => m.tipo === 'ingreso').reduce((s, m) => s + parseFloat(m.monto || 0), 0);
    const egr = movsMes.filter(m => m.tipo === 'egreso').reduce((s, m) => s + parseFloat(m.monto || 0), 0);
    ingData.push(+(ing / 1000).toFixed(1));  // en miles
    egrData.push(+(egr / 1000).toFixed(1));
  }

  drawLineChart('rep-line-chart', [
    { data: ingData, color: '#22c55e', label: 'Ingresos (miles S/)', fill: true },
    { data: egrData, color: '#ef4444', label: 'Egresos (miles S/)',  fill: false, dashed: false }
  ], monthLabels, { unit: 'K', height: 130 });

  // ── 4. TABLA RESUMEN + KPIs reales ────────────────────────────────────────────
  const totalCartera = db.proyectos.reduce((s, p) => s + parseFloat(p.presupuesto || 0), 0);
  const totalEjecutado = db.proyectos.reduce((s, p) => {
    const av = p._avanceAuto !== undefined ? p._avanceAuto : (p.avance || 0);
    return s + parseFloat(p.presupuesto || 0) * av / 100;
  }, 0);
  const proyFinalizados = db.proyectos.filter(p => (p.estado||'').toLowerCase() === 'finalizado').length;
  const tasaCumplimiento = db.proyectos.length > 0
    ? Math.round((proyFinalizados / db.proyectos.length) * 100) : 0;
  const totalEgr = _movimientos.filter(m=>m.tipo==='egreso').reduce((s,m)=>s+parseFloat(m.monto||0),0);
  const totalIng = _movimientos.filter(m=>m.tipo==='ingreso').reduce((s,m)=>s+parseFloat(m.monto||0),0);
  const margenReal = totalIng > 0 ? Math.round(((totalIng - totalEgr) / totalIng) * 100) : 0;

  const setEl = (id, v) => { const e = document.getElementById(id); if(e) e.textContent = v; };
  setEl('rep-cartera', 'S/ ' + totalCartera.toLocaleString('es-PE', {minimumFractionDigits:0}));
  setEl('rep-cumplimiento', tasaCumplimiento + '%');
  setEl('rep-margen', margenReal + '%');

  // Desvío promedio de plazo (días)
  const hoy = new Date();
  let sumAtraso = 0, countAtraso = 0;
  db.proyectos.forEach(p => {
    if (p._diasAtraso > 0) { sumAtraso += p._diasAtraso; countAtraso++; }
  });
  const desvioCards = document.querySelectorAll('#page-reportes .stat-card');
  if (desvioCards[3]) {
    const valEl = desvioCards[3].querySelector('.stat-value');
    if (valEl) valEl.textContent = countAtraso > 0 ? '+' + Math.round(sumAtraso/countAtraso) + ' días' : '✅ Al día';
  }

  // Tabla ejecutivo
  const tbody = document.getElementById('reportes-table');
  if (tbody && db.proyectos.length > 0) {
    tbody.innerHTML = db.proyectos.map(p => {
      const av = p._avanceAuto !== undefined ? p._avanceAuto : (p.avance || 0);
      const ejecutado = parseFloat(p.presupuesto || 0) * av / 100;
      const presup = parseFloat(p.presupuesto || 0);
      const desvio = presup > 0 ? Math.round(((ejecutado - presup) / presup) * 100) : 0;
      const margen = totalIng > 0 ? margenReal : '—';
      const colorAv = av >= 70 ? 'var(--green)' : av >= 40 ? 'var(--accent)' : 'var(--red)';
      const atrasoLabel = p._atrasado && p._diasAtraso > 0
        ? '<span style="color:var(--red);font-size:11px;">🔴 ' + p._diasAtraso + 'd atraso</span>' : '';
      return '<tr>' +
        '<td><b>' + p.nombre + '</b>' + (atrasoLabel ? '<br>' + atrasoLabel : '') + '</td>' +
        '<td>S/ ' + presup.toLocaleString('es-PE') + '</td>' +
        '<td>S/ ' + Math.round(ejecutado).toLocaleString('es-PE') + '</td>' +
        '<td style="color:' + (desvio > 10 ? 'var(--red)' : desvio > 0 ? 'var(--accent)' : 'var(--green)') + ';">' +
          (desvio >= 0 ? '+' : '') + desvio + '%</td>' +
        '<td>' + margenReal + '%</td>' +
        '<td>' +
          '<div style="display:flex;align-items:center;gap:8px;">' +
            '<div style="flex:1;background:var(--bg3);border-radius:4px;height:8px;">' +
              '<div style="width:' + av + '%;height:8px;border-radius:4px;background:' + colorAv + ';"></div>' +
            '</div>' +
            '<span style="font-weight:700;color:' + colorAv + ';min-width:35px;">' + av + '%</span>' +
          '</div>' +
        '</td>' +
      '</tr>';
    }).join('');
  } else if (tbody) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos registrados</td></tr>';
  }
}

function exportReporteExcel() {
  const rows = [['Proyecto','Tipo','Presupuesto','Ejecutado Est.','Desviación','Avance']];
  db.proyectos.forEach(p => rows.push([p.nombre, p.tipo, p.presupuesto, Math.round(p.presupuesto*p.avance/100), '—', p.avance+'%']));
  exportToCSV(rows, 'reporte_ejecutivo');
  toast('Reporte exportado', db.proyectos.length + ' proyectos incluidos');
}

function exportFacturasExcel() {
  toast('Facturas exportadas', 'Archivo descargado correctamente');
}
function exportMaterialesExcel() {
  if (db.materiales.length === 0) { toast('Sin datos', 'No hay movimientos para exportar', 'warn'); return; }
  const rows = [['Material','Tipo','Cantidad','Proyecto','Responsable','Fecha']];
  db.materiales.forEach(m => {
    const fecha = m.fecha ? new Date(m.fecha).toLocaleString('es-PE') : '—';
    rows.push([m.nombre, m.tipo||'—', m.cantidad||'—', getProyectoNombre(m.proyecto), m.responsable||'—', fecha]);
  });
  exportToCSV(rows, 'materiales_' + new Date().toISOString().slice(0,10));
  toast('Excel exportado', db.materiales.length + ' movimientos descargados');
}

// Patch populateProyectoDropdowns to also fill new dropdowns
const _origPopulate = populateProyectoDropdowns;
function populateProyectoDropdowns() {
  const opts = '<option value="">Sin asignar</option>' + db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  ['emp-proyecto','maq-proyecto','fac-proyecto','mat-proyecto','parte-proyecto'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
}

// Login on Enter key
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); });

// ===================== USUARIOS & ROLES =====================
// Storage key for users (localStorage as Supabase users table is optional)
const USERS_KEY = 'norconstruc_usuarios'; // fallback local
let _usuariosCache = [];

async function loadUsuariosSB() {
  // Show local cache immediately so UI never stays "Cargando..."
  try { 
    const cached = JSON.parse(localStorage.getItem(USERS_KEY) || '[]');
    if (cached.length > 0) { _usuariosCache = cached; }
  } catch(e) {}
  
  try {
    const rows = await sbFetch('usuarios_sistema?order=created_at.desc');
    if (!Array.isArray(rows)) throw new Error('Respuesta inválida');
    _usuariosCache = rows.map(u => ({
      id: u.id,
      nombre: u.nombre_completo || u.nombre || u.user_nombre || 'Sin nombre',
      user: u.user_nombre || u.usuario || u.user || '',
      pass: u.password_hash || '',
      rol: u.rol || 'capataz',
      proyecto: u.proyecto_id || '',
      email: u.email || '',
      activo: u.activo !== false,
      lastLogin: u.last_login || '',
      creado: u.created_at || ''
    }));
    localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
    return _usuariosCache;
  } catch(e) {
    console.warn('Usuarios SB error:', e.message);
    // If table doesn't exist or error, use localStorage
    try { _usuariosCache = JSON.parse(localStorage.getItem(USERS_KEY) || '[]'); }
    catch(e2) { _usuariosCache = []; }
    return _usuariosCache;
  }
}

function getUsuarios() {
  return _usuariosCache;
}

async function saveUsuarioSB(data, id) {
  const payload = {
    user_nombre: data.user,
    nombre_completo: data.nombre,
    password_hash: data.pass,
    rol: data.rol,
    proyecto_id: data.proyecto || null,
    email: data.email || null,
    activo: data.activo !== false
  };
  if (id) {
    if (data.pass) payload.password_hash = data.pass;
    else delete payload.password_hash;
    await sbFetch('usuarios_sistema?id=eq.' + id, { method: 'PATCH', body: payload, prefer: 'return=minimal' });
    return { id };
  } else {
    const res = await sbFetch('usuarios_sistema', { method: 'POST', body: payload });
    return Array.isArray(res) ? res[0] : res;
  }
}

async function deleteUsuarioSB(id) {
  await sbFetch('usuarios_sistema?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
}

const ROLE_DESCRIPTIONS = {
  admin: '👑 <b>Administrador:</b> Acceso total al sistema. Puede crear/editar/eliminar todo, gestionar usuarios y ver reportes completos.',
  supervisor: '🔍 <b>Supervisor:</b> Puede ver y gestionar todos los proyectos y obras. No accede a usuarios ni datos financieros sensibles.',
  capataz: '👷 <b>Capataz:</b> Solo puede registrar parte diario, ver y gestionar su cuadrilla. Ideal para el campo.',
  contador: '💼 <b>Contador:</b> Accede a presupuestos, proveedores, facturas y reportes financieros. No gestiona obras ni personal.',
  cliente: '👁 <b>Cliente:</b> Solo puede ver el avance de su proyecto asignado. No tiene acceso a datos internos.'
};

const ROLE_MODULES = {
  admin:      ['dashboard','proyectos','personal','maquinaria','obras','presupuestos','materiales','proveedores','cotizador','facturacion','reportes','usuarios','asistencia','flujocaja','alertas'],
  supervisor: ['dashboard','proyectos','personal','maquinaria','obras','presupuestos','materiales','proveedores','reportes','asistencia','flujocaja','alertas'],
  capataz:    ['dashboard','personal','obras','materiales','asistencia'],
  contador:   ['dashboard','proyectos','presupuestos','proveedores','facturacion','reportes','flujocaja'],
  cliente:    ['dashboard','proyectos']
};

function renderUsuarios(filterRol) {
  let users = getUsuarios();
  const setEl = (id, val) => { const e = document.getElementById(id); if(e) e.textContent = val; };
  setEl('badge-usuarios', users.length);
  setEl('usuarios-sub', users.length + ' usuarios registrados en el sistema');

  // Stats - use IDs from HTML
  const admins = users.filter(u => u.rol === 'admin').length;
  const activos = users.filter(u => u.activo !== false).length;
  setEl('usr-total', users.length);
  setEl('usr-admins', admins);
  setEl('usr-activos', activos);
  setEl('usr-inactivos', users.length - activos);
  // Also support old IDs
  setEl('cnt-todos', users.length); setEl('cnt-admin', admins);
  setEl('cnt-supervisor', users.filter(u=>u.rol==='supervisor').length);
  setEl('cnt-capataz', users.filter(u=>u.rol==='capataz').length);
  setEl('cnt-contador', users.filter(u=>u.rol==='contador').length);

  if (filterRol) users = users.filter(u => u.rol === filterRol);

  const rolLabel = { admin:'👑 Admin', supervisor:'🔍 Supervisor', capataz:'👷 Capataz', contador:'💼 Contador', cliente:'👁 Cliente' };
  const rolClass = { admin:'role-admin', supervisor:'role-supervisor', capataz:'role-capataz', contador:'role-contador', cliente:'role-cliente' };

  const tbody = document.getElementById('usuarios-table');
  const mob = document.getElementById('usuarios-mobile');

  if (users.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">No hay usuarios. Creá el primero con "+ Nuevo Usuario".</td></tr>';
    if (mob) mob.innerHTML = '<p style="color:var(--muted);text-align:center;padding:24px;">Sin usuarios aún.</p>';
    return;
  }

  const rows = users.map(u => {
    const initials = (u.nombre||u.user).split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const proyNombre = u.proyecto ? getProyectoNombre(u.proyecto) : 'Todos';
    const ultimoAcceso = u.lastLogin ? new Date(u.lastLogin).toLocaleDateString('es-PE') : 'Nunca';
    return {
      tr: `<tr>
        <td><div style="display:flex;align-items:center;gap:8px;">
          <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;">${initials}</div>
          <div class="td-name">@${u.user}</div>
        </div></td>
        <td>${u.nombre||'—'}</td>
        <td><span class="role-badge ${rolClass[u.rol]||'role-cliente'}">${rolLabel[u.rol]||u.rol}</span></td>
        <td style="color:var(--muted2)">${proyNombre}</td>
        <td style="color:var(--muted)">${ultimoAcceso}</td>
        <td><span class="status-badge ${u.activo!==false?'activo':'pausado'}">${u.activo!==false?'Activo':'Inactivo'}</span></td>
        <td><div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="editUsuario('${u.id}')">✏️</button>
          <button class="btn btn-ghost btn-sm" onclick="toggleUsuarioStatus('${u.id}')">${u.activo!==false?'🔒':'🔓'}</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUsuario('${u.id}')">🗑️</button>
        </div></td>
      </tr>`,
      card: `<div class="mobile-card">
        <div class="mc-header">
          <div style="display:flex;align-items:center;gap:10px;">
            <div style="width:38px;height:38px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;flex-shrink:0;">${initials}</div>
            <div><div class="mc-name">${u.nombre||u.user}</div><div class="mc-sub">@${u.user} · ${ultimoAcceso}</div></div>
          </div>
          <span class="role-badge ${rolClass[u.rol]||'role-cliente'}">${rolLabel[u.rol]||u.rol}</span>
        </div>
        <div class="mc-body">
          <div><div class="mc-label">Proyecto</div><div class="mc-val">${proyNombre}</div></div>
          <div><div class="mc-label">Estado</div><div class="mc-val"><span class="status-badge ${u.activo!==false?'activo':'pausado'}">${u.activo!==false?'Activo':'Inactivo'}</span></div></div>
          <div><div class="mc-label">Email</div><div class="mc-val" style="font-size:12px">${u.email||'—'}</div></div>
        </div>
        <div class="mc-actions">
          <button class="btn btn-ghost btn-sm" onclick="editUsuario('${u.id}')">✏️ Editar</button>
          <button class="btn btn-ghost btn-sm" onclick="toggleUsuarioStatus('${u.id}')">${u.activo!==false?'🔒 Desactivar':'🔓 Activar'}</button>
          <button class="btn btn-danger btn-sm" onclick="deleteUsuario('${u.id}')">🗑️</button>
        </div>
      </div>`
    };
  });

  tbody.innerHTML = rows.map(r=>r.tr).join('');
  if (mob) mob.innerHTML = rows.map(r=>r.card).join('');
}

let _usuarioFilterRol = '';
function filterUsuarios(rol) {
  _usuarioFilterRol = rol;
  renderUsuarios(rol);
}

function updateRolDescription() {
  const rol = document.getElementById('usr-rol').value;
  const el = document.getElementById('usr-rol-desc');
  if (rol && ROLE_DESCRIPTIONS[rol]) {
    el.innerHTML = ROLE_DESCRIPTIONS[rol];
    el.style.display = 'block';
  } else {
    el.style.display = 'none';
  }
}

async function saveUsuario() {
  const id = document.getElementById('usr-id').value;
  const nombre = document.getElementById('usr-nombre').value.trim();
  const user = document.getElementById('usr-user').value.trim().toLowerCase();
  const pass = document.getElementById('usr-pass').value;
  const pass2 = document.getElementById('usr-pass2').value;
  const rol = document.getElementById('usr-rol').value;
  const proyecto = document.getElementById('usr-proyecto').value;
  const email = document.getElementById('usr-email').value.trim();

  if (!nombre || !user || !rol) { toast('Campos requeridos', 'Completá nombre, usuario y rol', 'warn'); return; }
  if (!id && !pass) { toast('Contraseña requerida', 'Ingresá una contraseña', 'warn'); return; }
  if (pass && pass !== pass2) { toast('Contraseñas no coinciden', 'Verificá la contraseña', 'warn'); return; }
  if (pass && pass.length < 4) { toast('Contraseña muy corta', 'Mínimo 4 caracteres', 'warn'); return; }

  const users = getUsuarios();
  const dup = users.find(u => u.user === user && u.id !== id);
  if (dup) { toast('Usuario ya existe', '@' + user + ' ya está registrado', 'err'); return; }

  showLoading(true);
  try {
    const data = { nombre, user, pass, rol, proyecto, email, activo: true };
    const saved = await saveUsuarioSB(data, id || null);

    if (id) {
      const idx = _usuariosCache.findIndex(u => u.id === id);
      if (idx >= 0) {
        _usuariosCache[idx] = { ..._usuariosCache[idx], nombre, user, rol, proyecto, email };
        if (pass) _usuariosCache[idx].pass = pass;
      }
      toast('Usuario actualizado', '@' + user + ' — ' + rol);
    } else {
      const newId = saved?.id || ('local_' + Date.now());
      _usuariosCache.push({ id: newId, nombre, user, pass, rol, proyecto, email, activo: true, creado: new Date().toISOString(), lastLogin: null });
      toast('✅ Usuario creado', '@' + user + ' · Rol: ' + rol);
    }
    localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
  } catch(e) {
    toast('Error al guardar', e.message.slice(0,80), 'err');
    showLoading(false);
    return;
  }
  showLoading(false);
  closeModal('usuario');
  renderUsuarios(_usuarioFilterRol);
}

function editUsuario(id) {
  const u = _usuariosCache.find(x => x.id === id);
  if (!u) return;
  document.getElementById('usr-id').value = u.id;
  document.getElementById('usr-nombre').value = u.nombre || '';
  document.getElementById('usr-user').value = u.user;
  document.getElementById('usr-pass').value = '';
  document.getElementById('usr-pass2').value = '';
  document.getElementById('usr-rol').value = u.rol;
  document.getElementById('usr-proyecto').value = u.proyecto || '';
  document.getElementById('usr-email').value = u.email || '';
  document.getElementById('modal-usr-title').textContent = 'Editar Usuario';
  updateRolDescription();
  populateProyectoDropdowns();
  document.getElementById('modal-usuario').classList.add('open');
}

async function toggleUsuarioStatus(id) {
  const idx = _usuariosCache.findIndex(u => u.id === id);
  if (idx < 0) return;
  const newStatus = _usuariosCache[idx].activo === false ? true : false;
  try {
    await sbFetch('usuarios_sistema?id=eq.' + id, { method: 'PATCH', body: { activo: newStatus }, prefer: 'return=minimal' });
  } catch(e) { console.warn('Toggle status offline'); }
  _usuariosCache[idx].activo = newStatus;
  localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
  renderUsuarios(_usuarioFilterRol);
  toast(newStatus ? 'Usuario activado' : 'Usuario desactivado', '@' + _usuariosCache[idx].user);
}

function deleteUsuario(id) {
  const u = _usuariosCache.find(x => x.id === id);
  if (!u) return;
  document.getElementById('confirm-msg').textContent = '¿Eliminar usuario @' + u.user + '? Esta acción no se puede deshacer.';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await deleteUsuarioSB(id);
    } catch(e) { console.warn('Delete usuario offline'); }
    finally { showLoading(false); }
    _usuariosCache = _usuariosCache.filter(x => x.id !== id);
    localStorage.setItem(USERS_KEY, JSON.stringify(_usuariosCache));
    renderUsuarios(_usuarioFilterRol);
    toast('Usuario eliminado', '@' + u.user, 'err');
  };
  document.getElementById('modal-confirm').classList.add('open');
}

// ===== APPLY ROLE PERMISSIONS (hide nav items user can't access) =====
function applyRolePermissions(rol) {
  if (!rol || rol === 'admin') {
    // Admin ve todo — asegurar que todos los nav-items estén visibles
    document.querySelectorAll('.nav-item').forEach(el => el.style.display = '');
    window._roleAllowed = null; // sin restricciones
    return;
  }

  const allowed = ROLE_MODULES[rol] || [];

  // Guardar permisos para que nav() los verifique en tiempo real
  window._roleAllowed = allowed;

  const allPages = [
    'proyectos','personal','maquinaria','obras','presupuestos','materiales',
    'proveedores','cotizador','facturacion','reportes','usuarios',
    'asistencia','flujocaja','alertas','planilla','contratos'
  ];

  // Ocultar nav-items no permitidos para este rol
  allPages.forEach(page => {
    document.querySelectorAll(`.nav-item[onclick*="nav('${page}"]`).forEach(el => {
      el.style.display = allowed.includes(page) ? '' : 'none';
    });
  });

  // SEGURIDAD: si la página actualmente visible NO está permitida → redirigir al Dashboard
  const activePage = document.querySelector('.page.active');
  if (activePage) {
    const activeId = activePage.id.replace('page-', '');
    if (activeId !== 'dashboard' && !allowed.includes(activeId)) {
      nav('dashboard', document.querySelector(".nav-item[onclick*=\"nav('dashboard'\"]"));
    }
  }
}

// ============================================================
// ===== CONTROL DE ASISTENCIA ================================
// ============================================================

const ASIST_KEY = 'bc_asistencia_v1';
let _asistenciaData = JSON.parse(localStorage.getItem(ASIST_KEY) || '{}');
// Structure: { "2025-06-15": [ { personalId, nombre, rol, proyectoId, proyecto, estado, horaEntrada, horasExtras, observacion } ] }

function saveAsistenciaLocal() {
  localStorage.setItem(ASIST_KEY, JSON.stringify(_asistenciaData));
}

function initAsistencia() {
  // Set default date to today
  const fechaEl = document.getElementById('asist-fecha');
  if (!fechaEl.value) fechaEl.value = new Date().toISOString().split('T')[0];
  
  // Populate proyecto filter
  const pf = document.getElementById('asist-proyecto-filter');
  pf.innerHTML = '<option value="">Todos los proyectos</option>';
  proyectos.forEach(p => pf.innerHTML += `<option value="${p.id}">${p.nombre}</option>`);
  
  // Populate month filter for resumen
  const mf = document.getElementById('asist-mes-filter');
  mf.innerHTML = '';
  const now = new Date();
  for (let i = 0; i < 6; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const val = d.toISOString().slice(0,7);
    const label = d.toLocaleDateString('es-PE', { month: 'long', year: 'numeric' });
    mf.innerHTML += `<option value="${val}">${label}</option>`;
  }

  renderAsistencia();
  renderResumenMensual();
}

function renderAsistencia() {
  const fecha = document.getElementById('asist-fecha').value;
  const proyFil = document.getElementById('asist-proyecto-filter').value;
  if (!fecha) return;

  // Get personal for this date
  let personal_list = personal.filter(p => p.estado !== 'inactivo');
  if (proyFil) personal_list = personal_list.filter(p => 
    p.proyecto === proyFil || p.proyectoId === proyFil || p.proyecto_id === proyFil ||
    String(p.proyecto) === String(proyFil)
  );
  const existing = _asistenciaData[fecha] || [];
  const existMap = {};
  existing.forEach(r => existMap[r.personalId] = r);

  const tbody = document.getElementById('asist-table');
  const mobile = document.getElementById('asist-mobile');
  
  if (!personal_list.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Sin personal activo${proyFil ? ' en este proyecto' : ''}.</td></tr>`;
    mobile.innerHTML = '';
    updateAsistStats([]);
    return;
  }

  const rows = personal_list.map(per => {
    const r = existMap[per.id] || { estado: 'presente', horaEntrada: '08:00', horasExtras: 0, observacion: '' };
    const proyNombre = getProyectoNombre(per.proyecto || per.proyectoId || per.proyecto_id);
    const estados = ['presente','ausente','tardanza','permiso','feriado'];
    const estadoColors = { presente: 'var(--green)', ausente: 'var(--red)', tardanza: 'var(--accent)', permiso: 'var(--blue)', feriado: 'var(--muted)' };
    const estadoOpts = estados.map(e => `<option value="${e}" ${r.estado===e?'selected':''}>${e.charAt(0).toUpperCase()+e.slice(1)}</option>`).join('');
    return `<tr>
      <td><b>${per.nombre}</b></td>
      <td><span style="font-size:11px;color:var(--muted2);">${per.rol||per.cargo||''}</span></td>
      <td style="font-size:12px;">${proyNombre}</td>
      <td><select class="form-select" style="min-width:100px;font-size:12px;padding:4px 8px;border-color:${estadoColors[r.estado]||'var(--border)'};" onchange="this.style.borderColor=({presente:'var(--green)',ausente:'var(--red)',tardanza:'var(--accent)',permiso:'var(--blue)',feriado:'var(--muted)'})[this.value]||'var(--border)'" data-pid="${per.id}" data-field="estado">${estadoOpts}</select></td>
      <td><input type="time" class="form-input" style="padding:4px 8px;max-width:90px;" value="${r.horaEntrada||'08:00'}" data-pid="${per.id}" data-field="horaEntrada"></td>
      <td><input type="number" class="form-input" style="padding:4px 8px;max-width:70px;" value="${r.horasExtras||0}" min="0" max="12" step="0.5" data-pid="${per.id}" data-field="horasExtras"></td>
      <td><input type="text" class="form-input" style="padding:4px 8px;max-width:160px;" value="${r.observacion||''}" placeholder="..." data-pid="${per.id}" data-field="observacion"></td>
    </tr>`;
  });

  tbody.innerHTML = rows.join('');

  // Mobile cards (mc-* classes)
  const _bcMap = {presente:'var(--green)',ausente:'var(--red)',tardanza:'var(--accent)',permiso:'var(--blue)',feriado:'var(--muted)'};
  mobile.innerHTML = personal_list.map(per => {
    const r   = existMap[per.id] || {estado:'presente', horaEntrada:'08:00', horasExtras:0, observacion:''};
    const bc  = _bcMap[r.estado] || 'var(--muted)';
    const ini = per.nombre.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const prN = getProyectoNombre(per.proyecto||per.proyectoId||per.proyecto_id)||'Sin proyecto';
    const ests = ['presente','ausente','tardanza','permiso','feriado'];
    const opts = ests.map(e=>`<option value="${e}" ${r.estado===e?'selected':''}>${e[0].toUpperCase()+e.slice(1)}</option>`).join('');
    return `<div class="mobile-card">
      <div class="mc-header">
        <div class="mc-left">
          <div class="mc-avatar" style="background:linear-gradient(135deg,var(--blue),var(--purple));">${ini}</div>
          <div><div class="mc-name">${per.nombre}</div><div class="mc-sub">${per.rol||per.cargo||''} · ${prN}</div></div>
        </div>
        <span style="font-size:10px;padding:3px 9px;border-radius:20px;background:${bc}20;color:${bc};font-weight:700;flex-shrink:0;">${r.estado||'presente'}</span>
      </div>
      <div class="mc-body">
        <div><div class="mc-label">Estado</div>
          <select style="background:var(--bg3);border:1px solid ${bc};color:var(--text);border-radius:7px;padding:5px 8px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                  data-pid="${per.id}" data-field="estado">${opts}</select>
        </div>
        <div><div class="mc-label">H. Entrada</div>
          <input type="time" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 7px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                 value="${r.horaEntrada||'08:00'}" data-pid="${per.id}" data-field="horaEntrada">
        </div>
        <div><div class="mc-label">H. Extras</div>
          <input type="number" min="0" max="12" step="0.5" style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 7px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                 value="${r.horasExtras||0}" data-pid="${per.id}" data-field="horasExtras">
        </div>
        <div><div class="mc-label">Observación</div>
          <input type="text" placeholder="..." style="background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:5px 7px;font-size:12px;width:100%;margin-top:3px;outline:none;"
                 value="${r.observacion||''}" data-pid="${per.id}" data-field="observacion">
        </div>
      </div>
    </div>`;
  }).join('');

  // Compute stats
  const records = personal_list.map(per => existMap[per.id] || { estado: 'presente' });
  updateAsistStats(records);
  document.getElementById('asist-sub').textContent = `${personal_list.length} trabajadores · ${new Date(fecha+'T12:00').toLocaleDateString('es-PE', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}`;
}

function updateAsistStats(records) {
  const presentes = records.filter(r => r.estado === 'presente').length;
  const ausentes = records.filter(r => r.estado === 'ausente').length;
  const tardanzas = records.filter(r => r.estado === 'tardanza').length;
  const total = records.length;
  const tasa = total ? Math.round(((presentes + tardanzas) / total) * 100) : 0;
  document.getElementById('asist-presentes').textContent = presentes;
  document.getElementById('asist-ausentes').textContent = ausentes;
  document.getElementById('asist-tardanza').textContent = tardanzas;
  document.getElementById('asist-tasa').textContent = tasa + '%';
  document.getElementById('badge-asistencia').textContent = presentes;
}

function guardarParteDiario() {
  const fecha = document.getElementById('asist-fecha').value;
  if (!fecha) { toast('Error', 'Seleccioná una fecha', 'err'); return; }
  
  const rows = document.querySelectorAll('#asist-table tr[data-pid], #asist-table td select[data-pid], #asist-table td input[data-pid]');
  
  // Collect all data from inputs
  const inputs = document.querySelectorAll('#asist-table [data-pid]');
  const dataMap = {};
  inputs.forEach(el => {
    const pid = el.dataset.pid;
    const field = el.dataset.field;
    if (!dataMap[pid]) dataMap[pid] = {};
    dataMap[pid][field] = el.value;
  });

  if (!Object.keys(dataMap).length) { toast('Sin datos', 'No hay personal para guardar', 'err'); return; }

  const records = [];
  const proyFil = document.getElementById('asist-proyecto-filter').value;
  let personal_list = personal.filter(p => p.estado !== 'inactivo');
  if (proyFil) personal_list = personal_list.filter(p =>
    p.proyecto === proyFil || p.proyectoId === proyFil || p.proyecto_id === proyFil ||
    String(p.proyecto) === String(proyFil)
  );

  personal_list.forEach(per => {
    const d = dataMap[per.id] || {};
    const proy = proyectos.find(p => p.id === (per.proyectoId || per.proyecto_id));
    records.push({
      personalId: per.id,
      nombre: per.nombre,
      rol: per.rol || per.cargo || '',
      proyectoId: per.proyectoId || per.proyecto_id || '',
      proyecto: proy ? proy.nombre : (per.proyecto || ''),
      estado: d.estado || 'presente',
      horaEntrada: d.horaEntrada || '08:00',
      horasExtras: parseFloat(d.horasExtras) || 0,
      observacion: d.observacion || ''
    });
  });

  // Merge with existing (other projects)
  const existing = (_asistenciaData[fecha] || []).filter(r => {
    if (!proyFil) return false;
    return r.proyectoId !== proyFil;
  });
  _asistenciaData[fecha] = [...existing, ...records];
  saveAsistenciaLocal();
  toast('Parte guardado', `${records.length} registros para el ${fecha}`, 'ok');
  renderAsistencia();
  renderResumenMensual();
}

function renderResumenMensual() {
  const mes = document.getElementById('asist-mes-filter').value;
  if (!mes) return;
  const tbody = document.getElementById('asist-resumen-table');
  
  // Gather all dates for this month
  const diasMes = Object.keys(_asistenciaData).filter(d => d.startsWith(mes));
  
  if (!diasMes.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Sin registros para ${mes}</td></tr>`;
    return;
  }

  // Build summary per person
  const summary = {}; // personalId -> { nombre, proyecto, dias, ausencias, tardanzas, hExtras }
  diasMes.forEach(dia => {
    (_asistenciaData[dia] || []).forEach(r => {
      if (!summary[r.personalId]) summary[r.personalId] = { nombre: r.nombre, proyecto: r.proyecto, dias: 0, ausencias: 0, tardanzas: 0, hExtras: 0 };
      const s = summary[r.personalId];
      if (r.estado === 'presente' || r.estado === 'tardanza') s.dias++;
      if (r.estado === 'ausente') s.ausencias++;
      if (r.estado === 'tardanza') s.tardanzas++;
      s.hExtras += parseFloat(r.horasExtras) || 0;
    });
  });

  const totalDias = diasMes.length;
  const rows = Object.values(summary).map(s => {
    const pct = totalDias ? Math.round((s.dias / totalDias) * 100) : 0;
    const pctColor = pct >= 90 ? 'var(--green)' : pct >= 75 ? 'var(--accent)' : 'var(--red)';
    return `<tr>
      <td><b>${s.nombre}</b></td>
      <td style="font-size:12px;">${s.proyecto||'—'}</td>
      <td style="text-align:center;">${s.dias}</td>
      <td style="text-align:center;color:${s.ausencias>0?'var(--red)':'var(--muted)'};">${s.ausencias}</td>
      <td style="text-align:center;color:${s.tardanzas>0?'var(--accent)':'var(--muted)'};">${s.tardanzas}</td>
      <td style="text-align:center;">${s.hExtras.toFixed(1)}h</td>
      <td style="text-align:center;"><span style="color:${pctColor};font-weight:600;">${pct}%</span></td>
    </tr>`;
  });
  tbody.innerHTML = rows.join('') || `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px;">Sin datos</td></tr>`;
}

function exportAsistenciaExcel() {
  const fecha = document.getElementById('asist-fecha').value || 'sin_fecha';
  const records = _asistenciaData[fecha] || [];
  if (!records.length) { toast('Sin datos', 'No hay parte para esta fecha', 'err'); return; }
  let csv = 'Nombre,Rol,Proyecto,Estado,Hora Entrada,H. Extras,Observación\n';
  records.forEach(r => csv += `"${r.nombre}","${r.rol}","${r.proyecto}","${r.estado}","${r.horaEntrada}","${r.horasExtras}","${r.observacion}"\n`);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `asistencia_${fecha}.csv`; a.click();
  toast('Exportado', 'Archivo CSV descargado', 'ok');
}

// ============================================================
// ===== FLUJO DE CAJA ========================================
// ============================================================

const FLUJO_KEY = 'bc_flujocaja_v1';
// ── Mostrar/ocultar campo proveedor en modal movimiento ──────────────
function toggleProveedorField(categoria) {
  const wrap = document.getElementById('mov-proveedor-wrap');
  if (!wrap) return;
  const show = ['pago_proveedor', 'materiales'].includes(categoria);
  wrap.style.display = show ? '' : 'none';
  if (show) {
    const sel = document.getElementById('mov-proveedor');
    sel.innerHTML = '<option value="">— Seleccionar proveedor —</option>' +
      (db.proveedores||[]).map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  }
}

let _movimientos = [];
let _flujoFilter = 'todos';

// Guarda backup local (por si Supabase falla)
function saveMovimientosLocal() {
  try { localStorage.setItem(FLUJO_KEY, JSON.stringify(_movimientos)); } catch(e) {}
}

// Carga movimientos desde Supabase (con fallback a localStorage)
async function loadMovimientosSB() {
  try {
    const rows = await sbFetch('movimientos_caja?order=fecha.desc');
    _movimientos = rows.map(m => ({
      id: m.id,
      tipo: m.tipo,
      fecha: m.fecha,
      proyectoId: m.proyecto_id || '',
      categoria: m.categoria || 'otro',
      monto: parseFloat(m.monto || 0),
      proveedorId: m.proveedor_id || '',
      descripcion: m.descripcion || '',
      referencia: m.referencia || '',
      createdAt: m.created_at
    }));
    saveMovimientosLocal();
  } catch(e) {
    console.warn('movimientos_caja no disponible, usando caché local:', e.message);
    try { _movimientos = JSON.parse(localStorage.getItem(FLUJO_KEY) || '[]'); } catch(e2) { _movimientos = []; }
  }
}

async function initFlujoCaja() {
  await loadMovimientosSB(); // siempre trae datos frescos de Supabase
  // Populate proyecto filter
  const pf = document.getElementById('flujo-proyecto-filter');
  pf.innerHTML = '<option value="">Todos los proyectos</option>';
  proyectos.forEach(p => pf.innerHTML += `<option value="${p.id}">${p.nombre}</option>`);

  // Populate project modal select
  const mp = document.getElementById('mov-proyecto');
  mp.innerHTML = '<option value="">Sin proyecto específico</option>';
  proyectos.forEach(p => mp.innerHTML += `<option value="${p.id}">${p.nombre}</option>`);

  // Populate month filter
  const mf = document.getElementById('flujo-mes-filter');
  mf.innerHTML = '<option value="">Todos los meses</option>';
  const now = new Date();
  for (let i = 0; i < 12; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const val = d.toISOString().slice(0,7);
    const label = d.toLocaleDateString('es-PE', { month: 'long', year: 'numeric' });
    mf.innerHTML += `<option value="${val}" ${i===0?'selected':''}>${label}</option>`;
  }

  renderFlujoCaja();
  setTimeout(initFlujoChart, 100);
}

function filtrarFlujo(tipo) {
  _flujoFilter = tipo;
  document.querySelectorAll('[id^="flujo-btn-"]').forEach(b => b.style.fontWeight = 'normal');
  document.getElementById('flujo-btn-' + tipo).style.fontWeight = '700';
  renderFlujoCaja();
}

function renderFlujoCaja() {
  const proyFil = document.getElementById('flujo-proyecto-filter').value;
  const mesFil = document.getElementById('flujo-mes-filter').value;

  let movs = [..._movimientos];
  if (proyFil) movs = movs.filter(m => m.proyectoId === proyFil);
  if (mesFil) movs = movs.filter(m => m.fecha && m.fecha.startsWith(mesFil));
  if (_flujoFilter !== 'todos') movs = movs.filter(m => m.tipo === _flujoFilter);

  movs.sort((a,b) => b.fecha.localeCompare(a.fecha));

  const ingresos = movs.filter(m => m.tipo === 'ingreso').reduce((s,m) => s + (parseFloat(m.monto)||0), 0);
  const egresos = movs.filter(m => m.tipo === 'egreso').reduce((s,m) => s + (parseFloat(m.monto)||0), 0);
  const saldo = ingresos - egresos;
  const acumulado = _movimientos.filter(m => !proyFil || m.proyectoId === proyFil)
    .reduce((s, m) => s + (m.tipo === 'ingreso' ? 1 : -1) * (parseFloat(m.monto)||0), 0);

  document.getElementById('flujo-ingresos').textContent = 'S/ ' + ingresos.toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  document.getElementById('flujo-egresos').textContent = 'S/ ' + egresos.toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  const saldoEl = document.getElementById('flujo-saldo');
  saldoEl.textContent = 'S/ ' + Math.abs(saldo).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  saldoEl.style.color = saldo >= 0 ? 'var(--green)' : 'var(--red)';
  const acumEl = document.getElementById('flujo-acumulado');
  acumEl.textContent = 'S/ ' + Math.abs(acumulado).toLocaleString('es-PE', {minimumFractionDigits:2, maximumFractionDigits:2});
  acumEl.style.color = acumulado >= 0 ? 'var(--green)' : 'var(--red)';

  const tbody = document.getElementById('flujo-table');
  const catLabels = { cobro_cliente:'Cobro cliente', anticipo:'Anticipo', pago_proveedor:'Pago proveedor', planilla:'Planilla', maquinaria:'Maquinaria', materiales:'Materiales', gastos_generales:'Gastos generales', impuestos:'Impuestos', otro:'Otro' };

  if (!movs.length) {
    tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Sin movimientos para el filtro seleccionado</td></tr>`;
    document.getElementById('flujo-mobile').innerHTML = '';
    return;
  }

  tbody.innerHTML = movs.map(m => {
    const proy = proyectos.find(p => p.id === m.proyectoId);
    const montoColor = m.tipo === 'ingreso' ? 'var(--green)' : 'var(--red)';
    const signo = m.tipo === 'ingreso' ? '+' : '-';
    return `<tr>
      <td style="font-size:12px;">${m.fecha || '—'}</td>
      <td style="font-size:12px;">${proy ? proy.nombre : '—'}</td>
      <td><span style="font-size:11px;padding:2px 8px;border-radius:20px;background:var(--bg3);">${catLabels[m.categoria]||m.categoria}</span></td>
      <td style="font-size:12px;">${m.descripcion||'—'}</td>
      <td><span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${montoColor}20;color:${montoColor};">${m.tipo === 'ingreso' ? '▲ Ingreso' : '▼ Egreso'}</span></td>
      <td style="text-align:right;font-weight:700;color:${montoColor};">${signo} S/ ${parseFloat(m.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
      <td style="text-align:center;">
        <button class="btn btn-ghost btn-sm" style="padding:4px 8px;" onclick="editarMovimiento('${m.id}')">✏️</button>
        <button class="btn btn-ghost btn-sm" style="padding:4px 8px;color:var(--red);" onclick="eliminarMovimiento('${m.id}')">🗑</button>
      </td>
    </tr>`;
  }).join('');

  // Mobile cards (mc-* classes)
  document.getElementById('flujo-mobile').innerHTML = movs.map(m => {
    const mc  = m.tipo === 'ingreso' ? 'var(--green)' : 'var(--red)';
    const sig = m.tipo === 'ingreso' ? '▲' : '▼';
    const cat = catLabels[m.categoria] || m.categoria || '—';
    const amt = parseFloat(m.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
    const pN  = (proyectos.find(p=>p.id===m.proyectoId)||{}).nombre || '—';
    return `<div class="mobile-card">
      <div class="mc-header">
        <div class="mc-left">
          <div class="mc-avatar" style="background:${mc}18;color:${mc};font-size:18px;">${m.tipo==='ingreso'?'📈':'📉'}</div>
          <div>
            <div class="mc-name">${m.descripcion||cat}</div>
            <div class="mc-sub">${m.fecha||'—'} · ${pN}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;margin-left:8px;">
          <div style="font-family:'Syne',sans-serif;font-weight:800;color:${mc};font-size:15px;">${sig} S/ ${amt}</div>
          <span style="font-size:10px;padding:2px 7px;border-radius:20px;background:${mc}18;color:${mc};">${cat}</span>
        </div>
      </div>
      <div class="mc-actions">
        <button class="btn btn-ghost btn-sm" onclick="editarMovimiento('${m.id}')">✏️ Editar</button>
        <button class="btn btn-danger btn-sm" onclick="eliminarMovimiento('${m.id}')">🗑 Eliminar</button>
      </div>
    </div>`;
  }).join('');

  document.getElementById('flujo-sub').textContent = `${_movimientos.length} movimientos registrados`;
  initFlujoChart();
}

function abrirModalMovimiento(id) {
  const modal = document.getElementById('modal-movimiento');
  if (id) {
    const m = _movimientos.find(x => x.id === id);
    if (!m) return;
    document.getElementById('mov-modal-title').textContent = 'Editar Movimiento';
    document.getElementById('mov-id').value = m.id;
    document.getElementById('mov-tipo').value = m.tipo;
    document.getElementById('mov-fecha').value = m.fecha;
    document.getElementById('mov-proyecto').value = m.proyectoId || '';
    document.getElementById('mov-categoria').value = m.categoria;
    document.getElementById('mov-monto').value = m.monto;
    document.getElementById('mov-descripcion').value = m.descripcion || '';
    document.getElementById('mov-referencia').value = m.referencia || '';
  } else {
    document.getElementById('mov-modal-title').textContent = 'Nuevo Movimiento';
    document.getElementById('mov-id').value = '';
    document.getElementById('mov-tipo').value = 'ingreso';
    document.getElementById('mov-fecha').value = new Date().toLocaleDateString('sv-SE', {timeZone:'America/Lima'});
    document.getElementById('mov-proyecto').value = '';
    document.getElementById('mov-categoria').value = 'cobro_cliente';
    document.getElementById('mov-monto').value = '';
    document.getElementById('mov-descripcion').value = '';
    document.getElementById('mov-referencia').value = '';
  const provWrap = document.getElementById('mov-proveedor-wrap');
  if (provWrap) provWrap.style.display = 'none';
  const provSel = document.getElementById('mov-proveedor');
  if (provSel) provSel.value = '';
  }
  modal.classList.add('open');
}

async function guardarMovimiento() {
  const monto = parseFloat(document.getElementById('mov-monto').value);
  if (!monto || monto <= 0) { toast('Error', 'Ingresá un monto válido', 'err'); return; }
  const fecha = document.getElementById('mov-fecha').value;
  // Auto-include proveedor name in descripcion if selected
  const provSelect = document.getElementById('mov-proveedor');
  const provNombre = provSelect && provSelect.value ? (db.proveedores.find(p=>p.id===provSelect.value)||{}).nombre || provSelect.options[provSelect.selectedIndex]?.text || '' : '';
  if (!fecha) { toast('Error', 'Seleccioná una fecha', 'err'); return; }

  const id = document.getElementById('mov-id').value;
  const proveedorId = document.getElementById('mov-proveedor')?.value || '';
  const data = {
    id: id || 'mov_' + Date.now(),
    tipo: document.getElementById('mov-tipo').value,
    fecha,
    proyectoId: document.getElementById('mov-proyecto').value,
    categoria: document.getElementById('mov-categoria').value,
    monto,
    proveedorId,
    descripcion: document.getElementById('mov-descripcion').value.trim() || (provNombre ? provNombre : ''),
    referencia: document.getElementById('mov-referencia').value.trim(),
    createdAt: id ? undefined : new Date().toISOString()
  };

  document.getElementById('modal-movimiento').classList.remove('open');
  toast('Guardando...', 'Registrando en Supabase', 'ok');

  const payload = {
    tipo: data.tipo,
    fecha: data.fecha,
    proyecto_id: data.proyectoId || null,
    categoria: data.categoria,
    monto: data.monto,
    proveedor_id: data.proveedorId || null,
    descripcion: data.descripcion,
    referencia: data.referencia
  };

  try {
    if (id) {
      await sbFetch('movimientos_caja?id=eq.' + id, { method: 'PATCH', body: payload, prefer: 'return=minimal' });
      const idx = _movimientos.findIndex(m => m.id === id);
      if (idx >= 0) _movimientos[idx] = { ..._movimientos[idx], ...data };
    } else {
      const res = await sbFetch('movimientos_caja', { method: 'POST', body: payload });
      const saved = Array.isArray(res) ? res[0] : res;
      data.id = saved?.id || data.id;
      _movimientos.unshift(data);
    }
    saveMovimientosLocal();
    toast('✅ Guardado', `Movimiento ${data.tipo} registrado`, 'ok');
  } catch(e) {
    // Fallback: save locally if Supabase fails
    if (id) {
      const idx = _movimientos.findIndex(m => m.id === id);
      if (idx >= 0) _movimientos[idx] = { ..._movimientos[idx], ...data };
    } else {
      _movimientos.unshift(data);
    }
    saveMovimientosLocal();
    toast('⚠️ Guardado local', 'No se pudo conectar a Supabase', 'ok');
  }
  renderFlujoCaja();
}

function editarMovimiento(id) { abrirModalMovimiento(id); }

function eliminarMovimiento(id) {
  const m = _movimientos.find(x => x.id === id);
  if (!m) return;
  document.getElementById('confirm-msg').textContent = `¿Eliminar movimiento "${m.descripcion || m.categoria}" por S/ ${m.monto}?`;
  document.getElementById('confirm-ok').onclick = async () => {
    document.getElementById('modal-confirm').classList.remove('open');
    try {
      await sbFetch('movimientos_caja?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
    } catch(e) { console.warn('Delete SB failed:', e.message); }
    _movimientos = _movimientos.filter(x => x.id !== id);
    saveMovimientosLocal();
    toast('Eliminado', 'Movimiento eliminado', 'err');
    renderFlujoCaja();
  };
  document.getElementById('modal-confirm').classList.add('open');
}

let _flujoChart = null;
function initFlujoChart() {
  const ctx = document.getElementById('flujo-chart');
  if (!ctx) return;
  if (_flujoChart) { _flujoChart.destroy(); _flujoChart = null; }

  // Build last 6 months data
  const months = [];
  const ingrArr = [], egrArr = [], saldoArr = [];
  const now = new Date();
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    const mes = d.toISOString().slice(0,7);
    months.push(d.toLocaleDateString('es-PE', { month: 'short' }));
    const movsMes = _movimientos.filter(m => m.fecha && m.fecha.startsWith(mes));
    const ing = movsMes.filter(m => m.tipo === 'ingreso').reduce((s,m) => s + parseFloat(m.monto||0), 0);
    const eg = movsMes.filter(m => m.tipo === 'egreso').reduce((s,m) => s + parseFloat(m.monto||0), 0);
    ingrArr.push(ing);
    egrArr.push(eg);
    saldoArr.push(ing - eg);
  }

  if (typeof Chart === 'undefined') return;
  _flujoChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [
        { label: 'Ingresos', data: ingrArr, backgroundColor: 'rgba(40,167,69,0.7)', borderRadius: 4 },
        { label: 'Egresos', data: egrArr, backgroundColor: 'rgba(220,53,69,0.7)', borderRadius: 4 },
        { label: 'Saldo', data: saldoArr, type: 'line', borderColor: 'rgba(245,166,35,1)', backgroundColor: 'rgba(245,166,35,0.1)', tension: 0.3, fill: false, pointRadius: 4 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { labels: { color: '#aaa', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#aaa' }, grid: { color: 'rgba(255,255,255,0.05)' } },
        y: { ticks: { color: '#aaa', callback: v => 'S/'+v.toLocaleString() }, grid: { color: 'rgba(255,255,255,0.05)' } }
      }
    }
  });
}

function exportFlujoExcel() {
  let csv = 'Fecha,Proyecto,Categoría,Descripción,Tipo,Monto,Referencia\n';
  _movimientos.sort((a,b) => b.fecha.localeCompare(a.fecha)).forEach(m => {
    const proy = proyectos.find(p => p.id === m.proyectoId);
    csv += `"${m.fecha}","${proy?proy.nombre:'—'}","${m.categoria}","${m.descripcion||''}","${m.tipo}","${m.monto}","${m.referencia||''}"\n`;
  });
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'flujo_caja_norconstruc.csv'; a.click();
  toast('Exportado', 'Flujo de caja descargado', 'ok');
}

// ============================================================
// ===== ALERTAS AUTOMÁTICAS ==================================
// ============================================================

let _alertas = [];
let _alertasFiltroActual = 'todas';

function generarAlertas() {
  _alertas = [];
  const hoy = new Date();
  const msDay = 86400000;

  // 1. Proyectos con fecha de fin próxima o vencida
  proyectos.forEach(p => {
    const finStr = p.fechaFin || p.fecha_fin || p.fin; // todas las variantes
    if (!finStr) return;
    const fin = new Date(finStr);
    if (isNaN(fin.getTime())) return; // fecha inválida
    const diff = Math.round((fin - hoy) / msDay);
    if (diff < 0) {
      _alertas.push({ id: 'p_'+p.id+'_vencido', tipo: 'critica', modulo: 'proyectos', icono: '🚨', titulo: 'Proyecto vencido', mensaje: `"${p.nombre}" venció hace ${Math.abs(diff)} días (${fin.toLocaleDateString('es-PE')})`, ref: p.nombre, leida: false });
    } else if (diff <= 15) {
      _alertas.push({ id: 'p_'+p.id+'_proximo', tipo: 'advertencia', modulo: 'proyectos', icono: '⚠️', titulo: 'Proyecto próximo a vencer', mensaje: `"${p.nombre}" vence en ${diff} días (${fin.toLocaleDateString('es-PE')})`, ref: p.nombre, leida: false });
    }
  });

  // 1b. Proyectos con desfase de avance (avance real < avance esperado por tiempo)
  db.proyectos.forEach(p => {
    if ((p.estado||'').toLowerCase() === 'finalizado') return;
    const { avanceFinal, avanceTiempo, atrasado, diasAtraso } = calcAvanceProyecto(p);
    if (atrasado && diasAtraso === 0 && avanceTiempo > 0) {
      // Desfase sin vencimiento (avance real muy por debajo del esperado)
      const deficit = avanceTiempo - avanceFinal;
      if (deficit >= 10) {
        _alertas.push({ id: 'p_'+p.id+'_desfase', tipo: 'advertencia', modulo: 'proyectos', icono: '📉',
          titulo: 'Obra desfasada', mensaje: `"${p.nombre}" — avance real ${avanceFinal}% vs ${avanceTiempo}% esperado (${deficit}% de atraso)`, ref: p.nombre, leida: false });
      }
    }
  });

  // 2. Facturas vencidas o por vencer
  facturas.forEach(f => {
    if (!f.fechaVencimiento && !f.fecha_vencimiento) return;
    const venc = new Date(f.fechaVencimiento || f.fecha_vencimiento);
    const diff = Math.round((venc - hoy) / msDay);
    const estadoFactura = (f.estado || '').toLowerCase();
    if (estadoFactura === 'cobrada' || estadoFactura === 'pagada') return;
    if (diff < 0) {
      _alertas.push({ id: 'f_'+f.id+'_vencida', tipo: 'critica', modulo: 'facturacion', icono: '💸', titulo: 'Factura vencida sin cobrar', mensaje: `Factura ${f.numero||f.id} — ${f.cliente||''} — S/ ${parseFloat(f.monto||f.total||0).toLocaleString()} — vencida hace ${Math.abs(diff)} días`, ref: f.numero||f.id, leida: false });
    } else if (diff <= 7) {
      _alertas.push({ id: 'f_'+f.id+'_proxima', tipo: 'advertencia', modulo: 'facturacion', icono: '📋', titulo: 'Factura por vencer', mensaje: `Factura ${f.numero||f.id} — ${f.cliente||''} — S/ ${parseFloat(f.monto||f.total||0).toLocaleString()} — vence en ${diff} días`, ref: f.numero||f.id, leida: false });
    }
  });

  // 3. Maquinaria con mantenimiento vencido
  maquinaria.forEach(m => {
    const mantStr = m.proxMantenimiento || m.prox_mantenimiento || m.mantenim;
    if (!mantStr) return;
    const mant = new Date(mantStr);
    if (isNaN(mant.getTime())) return;
    const diff = Math.round((mant - hoy) / msDay);
    if (diff < 0) {
      _alertas.push({ id: 'm_'+m.id+'_mant', tipo: 'critica', modulo: 'maquinaria', icono: '🔧', titulo: 'Mantenimiento vencido', mensaje: `${m.nombre||m.codigo} — mantenimiento vencido hace ${Math.abs(diff)} días`, ref: m.nombre||m.codigo, leida: false });
    } else if (diff <= 10) {
      _alertas.push({ id: 'm_'+m.id+'_prox', tipo: 'advertencia', modulo: 'maquinaria', icono: '⚙️', titulo: 'Mantenimiento próximo', mensaje: `${m.nombre||m.codigo} — mantenimiento en ${diff} días (${mant.toLocaleDateString('es-PE')})`, ref: m.nombre||m.codigo, leida: false });
    }
  });

  // 4. Presupuestos con alto desvío
  presupuestos.forEach(p => {
    const total = parseFloat(p.total || p.monto || 0);
    const ejecutado = parseFloat(p.ejecutado || p.costoReal || 0);
    if (!total || !ejecutado) return;
    const desvio = ((ejecutado - total) / total) * 100;
    if (desvio > 20) {
      _alertas.push({ id: 'pre_'+p.id+'_desvio', tipo: 'critica', modulo: 'presupuestos', icono: '📊', titulo: 'Desvío crítico en presupuesto', mensaje: `${p.nombre||p.titulo||'Presupuesto'} — desvío de +${desvio.toFixed(0)}% (ejecutado S/ ${ejecutado.toLocaleString()} vs S/ ${total.toLocaleString()} presupuestado)`, ref: p.nombre||p.titulo, leida: false });
    } else if (desvio > 10) {
      _alertas.push({ id: 'pre_'+p.id+'_alerta', tipo: 'advertencia', modulo: 'presupuestos', icono: '📉', titulo: 'Desvío en presupuesto', mensaje: `${p.nombre||p.titulo||'Presupuesto'} — desvío de +${desvio.toFixed(0)}%`, ref: p.nombre||p.titulo, leida: false });
    }
  });

  // 5. Materiales con stock bajo
  materiales.forEach(m => {
    const stock = parseFloat(m.stock || m.cantidad || 0);
    const minStock = parseFloat(m.stockMinimo || m.stock_minimo || 0);
    if (!minStock) return;
    if (stock <= 0) {
      _alertas.push({ id: 'mat_'+m.id+'_agotado', tipo: 'critica', modulo: 'materiales', icono: '📦', titulo: 'Material agotado', mensaje: `${m.nombre||m.descripcion} — sin stock (mínimo: ${minStock} ${m.unidad||''})`, ref: m.nombre, leida: false });
    } else if (stock < minStock) {
      _alertas.push({ id: 'mat_'+m.id+'_bajo', tipo: 'advertencia', modulo: 'materiales', icono: '⚠️', titulo: 'Stock bajo de material', mensaje: `${m.nombre||m.descripcion} — stock: ${stock} ${m.unidad||''} (mínimo: ${minStock})`, ref: m.nombre, leida: false });
    }
  });

  // 6. Flujo de caja negativo
  const saldoTotal = _movimientos.reduce((s,m) => s + (m.tipo === 'ingreso' ? 1 : -1) * (parseFloat(m.monto)||0), 0);
  if (saldoTotal < 0) {
    _alertas.push({ id: 'fc_negativo', tipo: 'critica', modulo: 'flujocaja', icono: '🏦', titulo: 'Saldo de caja negativo', mensaje: `Saldo acumulado negativo: S/ ${Math.abs(saldoTotal).toLocaleString('es-PE',{minimumFractionDigits:2})}`, ref: 'Flujo de caja', leida: false });
  }

  // 7. Información general
  const proyActivos = proyectos.filter(p => (p.estado||'').toLowerCase() === 'activo' || (p.estado||'').toLowerCase() === 'en curso').length;
  if (proyActivos > 0) {
    _alertas.push({ id: 'info_proyectos', tipo: 'info', modulo: 'proyectos', icono: 'ℹ️', titulo: 'Proyectos activos', mensaje: `Tenés ${proyActivos} proyecto${proyActivos>1?'s':''} activo${proyActivos>1?'s':''}`, ref: '', leida: true });
  }

  // Load leidas from localStorage
  const leidasGuardadas = JSON.parse(localStorage.getItem('bc_alertas_leidas') || '[]');
  _alertas.forEach(a => { if (leidasGuardadas.includes(a.id)) a.leida = true; });

  renderAlertas();
}

function renderAlertas() {
  const container = document.getElementById('alertas-container');
  let filtradas = _alertas;
  if (_alertasFiltroActual !== 'todas') filtradas = _alertas.filter(a => a.tipo === _alertasFiltroActual);
  
  const criticas = _alertas.filter(a => a.tipo === 'critica').length;
  const advertencias = _alertas.filter(a => a.tipo === 'advertencia').length;
  const infos = _alertas.filter(a => a.tipo === 'info').length;
  const leidas = _alertas.filter(a => a.leida).length;

  const _sEl = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
  _sEl('cnt-alertas-criticas', criticas);
  _sEl('cnt-alertas-advertencias', advertencias);
  _sEl('cnt-alertas-info', infos);
  _sEl('cnt-alertas-leidas', leidas);
  _sEl('alertas-sub', `${_alertas.length} alertas · ${criticas} críticas · ${advertencias} advertencias`);

  // Update badge in nav
  const noLeidas = _alertas.filter(a => !a.leida && a.tipo !== 'info').length;
  const badge = document.getElementById('badge-alertas');
  if (badge) { badge.textContent = noLeidas; badge.style.display = noLeidas > 0 ? '' : 'none'; }

  if (!filtradas.length) {
    container.innerHTML = `<div style="text-align:center;padding:60px;color:var(--muted);">
      <div style="font-size:48px;margin-bottom:12px;">✅</div>
      <div style="font-size:16px;font-weight:600;margin-bottom:6px;">Sin alertas${_alertasFiltroActual!=='todas'?' de este tipo':''}</div>
      <div style="font-size:13px;">Todo en orden</div>
    </div>`;
    return;
  }

  const tipoConfig = {
    critica: { bg: 'rgba(220,53,69,0.08)', border: 'var(--red)', badge: 'rgba(220,53,69,0.15)', badgeColor: 'var(--red)', label: 'Crítica' },
    advertencia: { bg: 'rgba(245,166,35,0.08)', border: 'var(--accent)', badge: 'rgba(245,166,35,0.15)', badgeColor: 'var(--accent)', label: 'Advertencia' },
    info: { bg: 'rgba(0,123,255,0.06)', border: 'var(--blue)', badge: 'rgba(0,123,255,0.15)', badgeColor: 'var(--blue)', label: 'Info' }
  };

  container.innerHTML = filtradas.map(a => {
    const cfg = tipoConfig[a.tipo] || tipoConfig.info;
    const opacidad = a.leida ? '0.5' : '1';
    return `<div style="display:flex;align-items:flex-start;gap:14px;padding:16px 18px;background:${cfg.bg};border:1px solid ${a.leida?'var(--border)':cfg.border};border-left:4px solid ${a.leida?'var(--border)':cfg.border};border-radius:10px;opacity:${opacidad};transition:opacity 0.3s;">
      <div style="font-size:24px;flex-shrink:0;">${a.icono}</div>
      <div style="flex:1;">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px;flex-wrap:wrap;">
          <span style="font-weight:700;font-size:14px;">${a.titulo}</span>
          <span style="font-size:11px;padding:2px 8px;border-radius:20px;background:${cfg.badge};color:${cfg.badgeColor};">${cfg.label}</span>
          ${a.leida ? '<span style="font-size:11px;color:var(--muted);">✓ Leída</span>' : ''}
        </div>
        <div style="font-size:13px;color:var(--muted2);">${a.mensaje}</div>
      </div>
      <div style="flex-shrink:0;display:flex;gap:8px;align-items:center;">
        ${!a.leida ? `<button class="btn btn-ghost btn-sm" style="padding:4px 10px;font-size:11px;" onclick="marcarLeida('${a.id}')">✓ Leída</button>` : ''}
        <button class="btn btn-ghost btn-sm" style="padding:4px 10px;font-size:11px;" onclick="irAModulo('${a.modulo}')">Ver →</button>
      </div>
    </div>`;
  }).join('');
}

function filtrarAlertas(tipo, btn) {
  _alertasFiltroActual = tipo;
  document.querySelectorAll('.alerta-filter').forEach(b => b.classList.remove('active'));
  if (btn) btn.classList.add('active');
  renderAlertas();
}

function marcarLeida(id) {
  const a = _alertas.find(x => x.id === id);
  if (a) a.leida = true;
  const leidas = _alertas.filter(x => x.leida).map(x => x.id);
  localStorage.setItem('bc_alertas_leidas', JSON.stringify(leidas));
  renderAlertas();
}

function marcarTodasLeidas() {
  _alertas.forEach(a => a.leida = true);
  localStorage.setItem('bc_alertas_leidas', JSON.stringify(_alertas.map(a => a.id)));
  renderAlertas();
  toast('Alertas', 'Todas marcadas como leídas', 'ok');
}

function irAModulo(modulo) {
  const navEl = document.querySelector(`.nav-item[onclick*="nav('${modulo}"]`);
  nav(modulo, navEl);
}

// Auto-generate alerts on load and update badge
function checkAlertasBadge() {
  // Quick scan without rendering
  const hoy = new Date();
  const msDay = 86400000;
  let count = 0;
  proyectos.forEach(p => {
    const finStr = p.fechaFin || p.fecha_fin || p.fin;
    if (!finStr) return;
    const fin = new Date(finStr);
    if (isNaN(fin.getTime())) return;
    const diff = Math.round((fin - hoy) / msDay);
    if (diff <= 15) count++;
    // también contar desfase de avance
    if (p._atrasado) count++;
  });
  facturas.forEach(f => {
    if (!f.fechaVencimiento && !f.fecha_vencimiento) return;
    const estadoF = (f.estado||'').toLowerCase();
    if (estadoF === 'cobrada' || estadoF === 'pagada') return;
    const diff = Math.round((new Date(f.fechaVencimiento||f.fecha_vencimiento) - hoy) / msDay);
    if (diff <= 7) count++;
  });
  const badge = document.getElementById('badge-alertas');
  if (badge) { badge.textContent = count; badge.style.display = count > 0 ? '' : 'none'; }
}

// ============================================================
// ===== REPORTES PDF (mejorado con Gantt) ====================
// ============================================================

function exportReportePDF() {
  const hoy = new Date().toLocaleDateString('es-PE', { day:'numeric', month:'long', year:'numeric' });
  const totalCartera = proyectos.reduce((s,p) => s + parseFloat(p.presupuesto||p.monto||0), 0);
  const proyActivos = proyectos.filter(p => ['activo','en curso','en ejecución'].includes((p.estado||'').toLowerCase())).length;

  // Gantt chart data
  const ganttRows = proyectos.slice(0,10).map(p => {
    const inicio = p.fechaInicio || p.fecha_inicio || new Date().toISOString().slice(0,10);
    const fin = p.fechaFin || p.fecha_fin || new Date(Date.now() + 90*86400000).toISOString().slice(0,10);
    const dInicio = new Date(inicio);
    const dFin = new Date(fin);
    const totalDias = Math.max(1, Math.round((dFin - dInicio) / 86400000));
    const diasTranscurridos = Math.max(0, Math.round((new Date() - dInicio) / 86400000));
    const avance = Math.min(100, Math.round((diasTranscurridos / totalDias) * 100));
    return { nombre: p.nombre, inicio, fin, avance, estado: p.estado || 'activo' };
  });

  // Find date range for Gantt
  const allFechas = ganttRows.flatMap(r => [new Date(r.inicio), new Date(r.fin)]);
  const minDate = allFechas.length ? new Date(Math.min(...allFechas.map(d => d.getTime()))) : new Date();
  const maxDate = allFechas.length ? new Date(Math.max(...allFechas.map(d => d.getTime()))) : new Date(Date.now() + 180*86400000);
  const totalRangeDias = Math.max(1, Math.round((maxDate - minDate) / 86400000));

  const ganttHTML = ganttRows.map(r => {
    const dInicio = new Date(r.inicio);
    const dFin = new Date(r.fin);
    const offsetPct = Math.round(((dInicio - minDate) / 86400000 / totalRangeDias) * 100);
    const widthPct = Math.max(2, Math.round(((dFin - dInicio) / 86400000 / totalRangeDias) * 100));
    const estadoColor = { activo:'#f5a623', 'en curso':'#28a745', completado:'#007bff', inactivo:'#6c757d' }[(r.estado||'').toLowerCase()] || '#f5a623';
    return `<tr>
      <td style="padding:6px 10px;font-size:11px;width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${r.nombre}</td>
      <td style="padding:6px 4px;font-size:10px;color:#888;">${r.inicio}</td>
      <td style="padding:6px 4px;font-size:10px;color:#888;">${r.fin}</td>
      <td style="padding:6px 8px;position:relative;">
        <div style="background:#2a2a3a;border-radius:4px;height:18px;position:relative;">
          <div style="position:absolute;left:${offsetPct}%;width:${widthPct}%;background:${estadoColor};height:100%;border-radius:4px;opacity:0.85;"></div>
          <div style="position:absolute;left:${offsetPct}%;width:${Math.min(widthPct, r.avance * widthPct / 100)}%;background:${estadoColor};height:100%;border-radius:4px;"></div>
        </div>
      </td>
      <td style="padding:6px 8px;font-size:11px;text-align:right;white-space:nowrap;color:${estadoColor};font-weight:600;">${r.avance}%</td>
    </tr>`;
  }).join('');

  // Movimientos summary for flujo
  const movResumen = {};
  _movimientos.forEach(m => {
    const mes = (m.fecha||'').slice(0,7);
    if (!movResumen[mes]) movResumen[mes] = { ing:0, eg:0 };
    if (m.tipo === 'ingreso') movResumen[mes].ing += parseFloat(m.monto||0);
    else movResumen[mes].eg += parseFloat(m.monto||0);
  });
  const flujoRows = Object.entries(movResumen).sort((a,b) => b[0].localeCompare(a[0])).slice(0,6).map(([mes, v]) => {
    const saldo = v.ing - v.eg;
    return `<tr style="border-bottom:1px solid #1e1e2a;">
      <td style="padding:7px 12px;">${mes}</td>
      <td style="padding:7px 12px;color:#28a745;text-align:right;">S/ ${v.ing.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
      <td style="padding:7px 12px;color:#dc3545;text-align:right;">S/ ${v.eg.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
      <td style="padding:7px 12px;font-weight:700;color:${saldo>=0?'#28a745':'#dc3545'};text-align:right;">S/ ${Math.abs(saldo).toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
    </tr>`;
  }).join('');

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>Reporte NorConstructores — ${hoy}</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',Arial,sans-serif; background:#0f0f17; color:#e0e0e0; padding:30px; }
  @media print { body { background:#fff !important; color:#000 !important; } .no-print { display:none; } }
  .header { background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%); border-radius:12px; padding:28px 32px; margin-bottom:24px; border:1px solid #2a2a4a; display:flex; justify-content:space-between; align-items:center; }
  .logo { font-size:22px; font-weight:800; color:#f5a623; letter-spacing:-0.5px; }
  .report-meta { text-align:right; font-size:12px; color:#888; }
  .report-meta span { display:block; }
  .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:14px; margin-bottom:24px; }
  .stat { background:#1a1a2e; border-radius:10px; padding:18px; border:1px solid #2a2a3a; text-align:center; }
  .stat-val { font-size:24px; font-weight:800; color:#f5a623; }
  .stat-lbl { font-size:11px; color:#888; margin-top:4px; }
  .section { background:#1a1a2e; border-radius:10px; padding:20px; margin-bottom:20px; border:1px solid #2a2a3a; }
  .section-title { font-size:14px; font-weight:700; margin-bottom:14px; color:#f5a623; border-bottom:1px solid #2a2a3a; padding-bottom:10px; }
  table { width:100%; border-collapse:collapse; font-size:12px; }
  th { background:#0f0f17; padding:8px 12px; text-align:left; color:#888; font-weight:600; font-size:11px; }
  td { padding:8px 12px; border-bottom:1px solid #1e1e2a; }
  .badge { display:inline-block; padding:2px 8px; border-radius:20px; font-size:10px; font-weight:600; }
  .badge-green { background:rgba(40,167,69,0.2); color:#28a745; }
  .badge-orange { background:rgba(245,166,35,0.2); color:#f5a623; }
  .badge-red { background:rgba(220,53,69,0.2); color:#dc3545; }
  .btn-print { background:#f5a623; color:#000; border:none; padding:10px 24px; border-radius:8px; font-size:13px; font-weight:700; cursor:pointer; margin-bottom:20px; }
</style></head>
<body>
<div class="no-print" style="margin-bottom:20px;">
  <button class="btn-print" onclick="window.print()">🖨️ Imprimir / Guardar PDF</button>
  <button class="btn-print" style="background:#2a2a4a;color:#e0e0e0;margin-left:10px;" onclick="window.close()">✕ Cerrar</button>
</div>

<div class="header">
  <div>
    <div class="logo">🏗️ NorConstructores</div>
    <div style="font-size:13px;color:#888;margin-top:4px;">Reporte Ejecutivo de Gestión</div>
  </div>
  <div class="report-meta">
    <span style="font-size:16px;font-weight:700;color:#e0e0e0;">${hoy}</span>
    <span>Generado automáticamente</span>
  </div>
</div>

<div class="stats-row">
  <div class="stat"><div class="stat-val">S/ ${(totalCartera/1000000).toFixed(1)}M</div><div class="stat-lbl">Cartera Total</div></div>
  <div class="stat"><div class="stat-val">${proyActivos}</div><div class="stat-lbl">Proyectos Activos</div></div>
  <div class="stat"><div class="stat-val">${personal.length}</div><div class="stat-lbl">Personal</div></div>
  <div class="stat"><div class="stat-val">${facturas.length}</div><div class="stat-lbl">Facturas</div></div>
</div>

<div class="section">
  <div class="section-title">📊 Cronograma Gantt — Proyectos</div>
  <table>
    <thead><tr><th>Proyecto</th><th>Inicio</th><th>Fin</th><th>Progreso</th><th>Avance</th></tr></thead>
    <tbody>${ganttHTML}</tbody>
  </table>
</div>

<div class="section">
  <div class="section-title">💰 Flujo de Caja — Últimos 6 Meses</div>
  ${flujoRows ? `<table>
    <thead><tr><th>Mes</th><th style="text-align:right;">Ingresos</th><th style="text-align:right;">Egresos</th><th style="text-align:right;">Saldo</th></tr></thead>
    <tbody>${flujoRows}</tbody>
  </table>` : '<div style="color:#888;text-align:center;padding:20px;">Sin movimientos de caja registrados</div>'}
</div>

<div class="section">
  <div class="section-title">🏗️ Estado de Proyectos</div>
  <table>
    <thead><tr><th>Proyecto</th><th>Cliente</th><th>Presupuesto</th><th>Estado</th><th>Avance</th></tr></thead>
    <tbody>
      ${proyectos.map(p => {
        const est = (p.estado||'activo').toLowerCase();
        const badgeClass = est.includes('complet') ? 'badge-green' : est.includes('activo')||est.includes('ejecución')||est.includes('curso') ? 'badge-orange' : 'badge-red';
        return `<tr>
          <td><b>${p.nombre}</b></td>
          <td style="color:#888;">${p.cliente||'—'}</td>
          <td>S/ ${parseFloat(p.presupuesto||p.monto||0).toLocaleString('es-PE')}</td>
          <td><span class="badge ${badgeClass}">${p.estado||'Activo'}</span></td>
          <td>${p.avance||0}%</td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>
</div>

<div style="text-align:center;color:#555;font-size:11px;margin-top:30px;padding:16px;border-top:1px solid #2a2a3a;">
  NorConstructores — Sistema de Gestión · Reporte generado el ${hoy}
</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('PDF', 'Reporte abierto — usá Ctrl+P para guardar como PDF', 'ok');
}

// Override existing export button in Reportes page to also offer PDF
const _origExportReporteExcel = typeof exportReporteExcel !== 'undefined' ? exportReporteExcel : null;


// =====================================================================
// ==================== GANTT ==========================================
// =====================================================================
function renderGantt() {
  const container = document.getElementById('gantt-container');
  if (!container) return;
  const proyectos = db.proyectos.filter(p => p.inicio && p.fin);
  if (proyectos.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);text-align:center;padding:32px;">Sin proyectos con fechas. Agregá fechas de inicio y fin en cada proyecto.</div>';
    return;
  }
  const fechaMin = new Date(Math.min(...proyectos.map(p => new Date(p.inicio))));
  const fechaMax = new Date(Math.max(...proyectos.map(p => new Date(p.fin))));
  const totalDias = Math.ceil((fechaMax - fechaMin) / 86400000) + 1;
  const hoy = new Date();
  const todayPct = Math.min(Math.max(Math.ceil((hoy - fechaMin) / 86400000) / totalDias * 100, 0), 100).toFixed(2);
  const colores = ['var(--accent)','var(--blue)','var(--green)','var(--purple)','#f43f5e','#06b6d4'];

  const meses = {};
  for (let i = 0; i <= totalDias; i++) {
    const d = new Date(fechaMin); d.setDate(d.getDate() + i);
    const key = d.toISOString().slice(0,7);
    meses[key] = (meses[key]||0) + 1;
  }
  const monthsHtml = Object.entries(meses).map(([mes, dias]) =>
    `<div style="width:${(dias/totalDias*100).toFixed(1)}%;min-width:28px;font-size:10px;color:var(--muted2);border-left:1px solid var(--border);padding-left:3px;overflow:hidden;white-space:nowrap;">${mes}</div>`
  ).join('');

  const barsHtml = proyectos.map((p, i) => {
    const ini = new Date(p.inicio), fin = new Date(p.fin);
    const left = (Math.max(Math.ceil((ini - fechaMin) / 86400000), 0) / totalDias * 100).toFixed(2);
    const width = Math.max((Math.ceil((fin - ini) / 86400000) + 1) / totalDias * 100, 0.5).toFixed(2);
    const avance = Math.min(parseFloat(p.avance || 0), 100);
    const color = colores[i % colores.length];
    return `<div style="display:flex;align-items:center;margin-bottom:8px;">
      <div style="width:150px;font-size:11px;font-weight:600;color:var(--text);padding-right:8px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex-shrink:0;" title="${p.nombre}">${p.nombre}</div>
      <div style="flex:1;position:relative;height:26px;background:var(--bg4);border-radius:6px;overflow:visible;">
        <div style="position:absolute;left:${todayPct}%;top:-4px;bottom:-4px;width:2px;background:rgba(239,68,68,0.8);z-index:2;border-radius:1px;"></div>
        <div style="position:absolute;left:${left}%;width:${width}%;height:100%;background:${color}22;border:1px solid ${color}66;border-radius:5px;overflow:hidden;">
          <div style="width:${avance}%;height:100%;background:${color};opacity:0.85;"></div>
          <div style="position:absolute;inset:0;display:flex;align-items:center;padding:0 6px;font-size:9px;color:#fff;font-weight:700;white-space:nowrap;overflow:hidden;">${p.nombre.slice(0,16)} ${avance}%</div>
        </div>
      </div>
      <div style="width:70px;font-size:9px;color:var(--muted);padding-left:6px;flex-shrink:0;">${p.inicio}<br>${p.fin}</div>
    </div>`;
  }).join('');

  container.innerHTML = `<div style="min-width:600px;padding:4px 0;">
    <div style="display:flex;margin-left:150px;margin-right:70px;margin-bottom:6px;">${monthsHtml}</div>
    ${barsHtml}
    <div style="font-size:10px;color:var(--muted);margin-top:6px;margin-left:150px;">
      <span style="display:inline-block;width:14px;height:2px;background:rgba(239,68,68,0.8);vertical-align:middle;margin-right:4px;"></span>Hoy (${hoy.toISOString().slice(0,10)})
    </div>
  </div>`;
}

function exportGanttPDF() {
  if (!window.jspdf) { toast('jsPDF no disponible','Recargá la página','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape' });
  doc.setFillColor(13,15,18); doc.rect(0,0,297,210,'F');
  doc.setFontSize(16); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text('NorConstructores — Diagrama Gantt', 148, 18, {align:'center'});
  doc.setFontSize(9); doc.setTextColor(100,116,139); doc.setFont('helvetica','normal');
  doc.text('Generado: ' + new Date().toLocaleDateString('es-PE'), 148, 26, {align:'center'});
  const proyectos = db.proyectos.filter(p => p.inicio && p.fin);
  if (proyectos.length === 0) { doc.setTextColor(148,163,184); doc.text('Sin proyectos con fechas.',148,80,{align:'center'}); doc.save('gantt.pdf'); return; }
  const fechaMin = new Date(Math.min(...proyectos.map(p=>new Date(p.inicio))));
  const fechaMax = new Date(Math.max(...proyectos.map(p=>new Date(p.fin))));
  const totalDias = Math.ceil((fechaMax-fechaMin)/86400000)+1;
  const hoy = new Date();
  const cL=55,cR=265,cW=cR-cL;
  doc.setFontSize(7); doc.setTextColor(100,116,139);
  doc.text(fechaMin.toISOString().slice(0,10),cL,33); doc.text(fechaMax.toISOString().slice(0,10),cR,33,{align:'right'});
  doc.setDrawColor(30,35,45); doc.line(cL,35,cR,35);
  let y=40;
  [[245,166,35],[59,130,246],[168,85,247],[34,197,94],[239,68,68],[6,182,212]].forEach((c,i)=>{
    const p=proyectos[i]; if(!p) return;
    const ini=new Date(p.inicio),fin=new Date(p.fin);
    const lft=cL+(Math.max(Math.ceil((ini-fechaMin)/86400000),0)/totalDias)*cW;
    const wdt=Math.max((Math.ceil((fin-ini)/86400000)+1)/totalDias*cW,1);
    const av=Math.min(parseFloat(p.avance||0),100);
    doc.setFillColor(c[0],c[1],c[2],0.15); doc.setDrawColor(c[0],c[1],c[2]);
    doc.roundedRect(lft,y,wdt,7,1.5,1.5,'FD');
    doc.setFillColor(c[0],c[1],c[2]);
    if(wdt*av/100>0) doc.roundedRect(lft,y,wdt*(av/100),7,1.5,1.5,'F');
    doc.setTextColor(40,50,60); doc.setFontSize(6);
    if(wdt>15) doc.text(p.nombre.slice(0,18)+' '+av+'%',lft+2,y+4.5);
    doc.setTextColor(148,163,184); doc.setFontSize(7.5); doc.text(p.nombre.slice(0,22),5,y+4.5);
    y+=11; if(y>185) y=185;
  });
  proyectos.slice(6).forEach((p,ii)=>{
    const c=[100,116,139]; const i=ii+6;
    const ini=new Date(p.inicio),fin=new Date(p.fin);
    const lft=cL+(Math.max(Math.ceil((ini-fechaMin)/86400000),0)/totalDias)*cW;
    const wdt=Math.max((Math.ceil((fin-ini)/86400000)+1)/totalDias*cW,1);
    const av=Math.min(parseFloat(p.avance||0),100);
    doc.setFillColor(c[0],c[1],c[2],0.15); doc.setDrawColor(c[0],c[1],c[2]);
    doc.roundedRect(lft,y,wdt,7,1.5,1.5,'FD');
    doc.setFillColor(c[0],c[1],c[2]);
    if(wdt*av/100>0) doc.roundedRect(lft,y,wdt*(av/100),7,1.5,1.5,'F');
    doc.setTextColor(148,163,184); doc.setFontSize(7.5); doc.text(p.nombre.slice(0,22),5,y+4.5);
    y+=11; if(y>185) y=185;
  });
  const todX=cL+(Math.ceil((hoy-fechaMin)/86400000)/totalDias)*cW;
  if(todX>=cL&&todX<=cR){doc.setDrawColor(239,68,68);doc.setLineWidth(0.5);doc.line(todX,32,todX,y);doc.setFontSize(6);doc.setTextColor(239,68,68);doc.text('HOY',todX-4,31);}
  doc.save('gantt_norconstruc_'+new Date().toISOString().slice(0,10)+'.pdf');
  toast('📄 Gantt PDF generado','Descargado exitosamente');
}

function generarReportePDF() {
  if (!window.jspdf) { toast('jsPDF no disponible','Recargá la página','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const hoy = new Date().toLocaleDateString('es-PE');
  doc.setFillColor(13,15,18); doc.rect(0,0,210,297,'F');
  doc.setFontSize(22); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text('NorConstructores', 105, 25, {align:'center'});
  doc.setFontSize(14); doc.setTextColor(241,245,249);
  doc.text('Reporte Ejecutivo de Proyectos', 105, 35, {align:'center'});
  doc.setFontSize(10); doc.setTextColor(100,116,139);
  doc.text('Generado: ' + hoy, 105, 43, {align:'center'});
  doc.setDrawColor(245,166,35); doc.setLineWidth(0.5); doc.line(20,48,190,48);
  const totalCartera=db.proyectos.reduce((a,p)=>a+parseFloat(p.presupuesto||0),0);
  const cumplim=db.proyectos.length>0?Math.round(db.proyectos.reduce((a,p)=>a+parseFloat(p.avance||0),0)/db.proyectos.length):0;
  const movs=window.dbMovimientos||[];
  const totalIng=movs.filter(m=>m.tipo==='ingreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  const totalEgr=movs.filter(m=>m.tipo==='egreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  doc.setFontSize(12); doc.setTextColor(241,245,249); doc.setFont('helvetica','bold');
  doc.text('RESUMEN EJECUTIVO',20,58);
  [['Cartera Total:','S/ '+totalCartera.toLocaleString('es-PE')],['Proyectos:',db.proyectos.length+' total'],['Avance Promedio:',cumplim+'%'],['Personal:',db.personal.length+' empleados'],['Ingresos:','S/ '+totalIng.toLocaleString('es-PE')],['Egresos:','S/ '+totalEgr.toLocaleString('es-PE')],['Saldo Neto:','S/ '+(totalIng-totalEgr).toLocaleString('es-PE')]].forEach(([k,v],i)=>{
    doc.setFont('helvetica','normal');doc.setFontSize(10);doc.setTextColor(148,163,184);doc.text(k,20,68+i*8);
    doc.setFont('helvetica','bold');doc.setTextColor(241,245,249);doc.text(v,80,68+i*8);
  });
  let y=130;
  doc.setFontSize(12);doc.setTextColor(245,166,35);doc.setFont('helvetica','bold');doc.text('PROYECTOS',20,y);y+=8;
  doc.setFontSize(8.5);doc.setTextColor(100,116,139);doc.setFont('helvetica','normal');
  doc.text('Proyecto',20,y);doc.text('Cliente',70,y);doc.text('Presupuesto',120,y);doc.text('Avance',155,y);doc.text('Estado',175,y);
  y+=3;doc.setDrawColor(40,50,60);doc.line(20,y,190,y);y+=5;
  db.proyectos.forEach(p=>{
    if(y>265){doc.addPage();doc.setFillColor(13,15,18);doc.rect(0,0,210,297,'F');y=20;}
    doc.setTextColor(241,245,249);doc.setFontSize(9);
    doc.text((p.nombre||'').slice(0,28),20,y);doc.text((p.cliente||'').slice(0,18),70,y);
    doc.text('S/ '+(parseFloat(p.presupuesto||0)/1000).toFixed(0)+'K',120,y);
    doc.text((p.avance||0)+'%',155,y);doc.text(p.estado||'',175,y);y+=7;
  });
  doc.save('reporte_norconstruc_'+hoy.replace(/\//g,'-')+'.pdf');
  toast('📄 PDF generado','Reporte descargado exitosamente');
}

function exportFlujoCajaExcel() {
  const movs=window.dbMovimientos||[];
  const rows=[['Fecha','Concepto','Categoría','Proyecto','Tipo','Monto (S/)','Referencia']];
  movs.forEach(m=>{const proy=db.proyectos.find(p=>p.id===m.proyecto_id);rows.push([m.fecha,m.concepto,m.categoria||'',proy?.nombre||'General',m.tipo,m.monto,m.referencia||'']);});
  const ws=XLSX.utils.aoa_to_sheet(rows);const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'FlujoCaja');
  XLSX.writeFile(wb,'flujo_caja_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('📥 Excel generado','Flujo de caja exportado');
}

// =====================================================================
// ==================== HOOK NAV & REPORTES CHARTS =====================
// =====================================================================
document.addEventListener('DOMContentLoaded', function() {
  // Make dbMovimientos globally accessible for PDF
  if (typeof dbMovimientos !== 'undefined') window.dbMovimientos = dbMovimientos;
});

// Patch initReportesCharts to also render Gantt
const _bcOrigRepCharts = window.initReportesCharts;
window.initReportesCharts = function() {
  if (_bcOrigRepCharts) _bcOrigRepCharts();
  setTimeout(renderGantt, 120);
};

// Patch nav to handle new modules
const _bcOrigNav = window.nav;
if (typeof _bcOrigNav === 'function') {
  window.nav = function(page, el) {
    _bcOrigNav(page, el);
    if (page === 'reportes') setTimeout(renderGantt, 150);
    if (page === 'flujocaja') {
      const sel = document.getElementById('caja-filtro-proyecto');
      if (sel && db.proyectos.length > 0) {
        const cur = sel.value;
        sel.innerHTML = '<option value="">Todos los proyectos</option>' + db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
        sel.value = cur;
      }
    }
  };
}


// =====================================================================
// ==================== PWA — MANIFEST + SERVICE WORKER ===============
// =====================================================================
(function initPWA() {
  // Inject manifest dynamically
  const manifest = {
    name: "NorConstructores — Sistema de Gestión",
    short_name: "NorConstructores",
    description: "Sistema de gestión para empresas constructoras",
    start_url: "./",
    display: "standalone",
    background_color: "#0d0f12",
    theme_color: "#0d0f12",
    orientation: "any",
    icons: [
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230d0f12'/%3E%3Ctext y='.9em' font-size='80' x='10'%3E🏗%3C/text%3E%3C/svg%3E", sizes: "192x192", type: "image/svg+xml" },
      { src: "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' fill='%230d0f12'/%3E%3Ctext y='.9em' font-size='80' x='10'%3E🏗%3C/text%3E%3C/svg%3E", sizes: "512x512", type: "image/svg+xml" }
    ]
  };
  const blob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  document.getElementById('pwa-manifest').href = url;

  // Register service worker (inline via blob)
  if ('serviceWorker' in navigator) {
    const swCode = `
const CACHE = 'norconstruc-v1';
const OFFLINE_KEY = 'bc_offline_queue';
self.addEventListener('install', e => {
  e.waitUntil(caches.open(CACHE).then(c => c.addAll(['/'])));
  self.skipWaiting();
});
self.addEventListener('activate', e => { e.waitUntil(clients.claim()); });
self.addEventListener('fetch', e => {
  if (e.request.method !== 'GET') return;
  e.respondWith(
    fetch(e.request).catch(() => caches.match(e.request).then(r => r || new Response('Offline', { status: 503 })))
  );
});
self.addEventListener('push', e => {
  const data = e.data ? e.data.json() : { title: 'NorConstructores', body: 'Nueva notificación' };
  e.waitUntil(self.registration.showNotification(data.title, {
    body: data.body, icon: data.icon || '', badge: data.badge || '',
    tag: data.tag || 'norconstruc', data: data.url || '/'
  }));
});
self.addEventListener('notificationclick', e => {
  e.notification.close();
  e.waitUntil(clients.openWindow(e.notification.data || '/'));
});
    `;
    const swBlob = new Blob([swCode], { type: 'application/javascript' });
    const swUrl = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swUrl).then(reg => {
      window._swReg = reg;
      console.log('[NorConstructores PWA] Service Worker registrado');
    }).catch(e => console.warn('[NorConstructores PWA] SW error:', e));
  }

  // PWA install prompt
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    const btn = document.getElementById('pwa-install-btn');
    if (btn) btn.style.display = 'flex';
  });
  window.installPWA = function() {
    if (!deferredPrompt) { toast('Instalación', 'Abrí NorConstructores en Chrome/Edge y usá "Agregar a pantalla de inicio"', 'info'); return; }
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(r => {
      if (r.outcome === 'accepted') { toast('✅ App instalada', 'NorConstructores se instaló en tu dispositivo'); document.getElementById('pwa-install-btn').style.display = 'none'; }
      deferredPrompt = null;
    });
  };
  window.addEventListener('appinstalled', () => {
    toast('✅ Instalada', 'NorConstructores está disponible desde tu pantalla de inicio');
    document.getElementById('pwa-install-btn').style.display = 'none';
  });
})();

// =====================================================================
// ==================== OFFLINE MODE + SYNC AUTO =======================
// =====================================================================
const OFFLINE_QUEUE_KEY = 'bc_offline_queue_v1';
let _isOnline = navigator.onLine;
let _offlineQueue = JSON.parse(localStorage.getItem(OFFLINE_QUEUE_KEY) || '[]');

function updateOnlineStatus() {
  _isOnline = navigator.onLine;
  const offEl = document.getElementById('offline-indicator');
  const syncEl = document.getElementById('sync-indicator');
  const pendEl = document.getElementById('pending-sync-indicator');
  const pendCnt = document.getElementById('pending-count');
  if (!_isOnline) {
    if (offEl) offEl.style.display = '';
    if (syncEl) syncEl.style.display = 'none';
    if (pendEl) pendEl.style.display = 'none';
    toast('📡 Sin conexión', 'Los cambios se guardarán localmente y sincronizarán al reconectar', 'warn');
  } else {
    if (offEl) offEl.style.display = 'none';
    if (_offlineQueue.length > 0) {
      if (pendEl) pendEl.style.display = '';
      if (pendCnt) pendCnt.textContent = _offlineQueue.length;
      syncOfflineQueue();
    } else {
      if (syncEl) { syncEl.style.display = ''; setTimeout(() => { syncEl.style.display = 'none'; }, 3000); }
    }
  }
}

window.addEventListener('online', () => { updateOnlineStatus(); toast('🌐 Conexión restaurada', 'Sincronizando datos pendientes...', 'ok'); });
window.addEventListener('offline', () => updateOnlineStatus());

function addToOfflineQueue(table, method, data, id) {
  _offlineQueue.push({ table, method, data, id, ts: Date.now() });
  localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(_offlineQueue));
  const pendEl = document.getElementById('pending-sync-indicator');
  const pendCnt = document.getElementById('pending-count');
  if (pendEl) pendEl.style.display = '';
  if (pendCnt) pendCnt.textContent = _offlineQueue.length;
}

async function syncOfflineQueue() {
  if (!_isOnline || _offlineQueue.length === 0) return;
  const queue = [..._offlineQueue];
  let synced = 0;
  for (const item of queue) {
    try {
      const path = item.id ? `${item.table}?id=eq.${item.id}` : item.table;
      await sbFetch(path, { method: item.method, body: item.data });
      _offlineQueue = _offlineQueue.filter(q => q.ts !== item.ts);
      synced++;
    } catch(e) { break; }
  }
  localStorage.setItem(OFFLINE_QUEUE_KEY, JSON.stringify(_offlineQueue));
  const pendEl = document.getElementById('pending-sync-indicator');
  const syncEl = document.getElementById('sync-indicator');
  const pendCnt = document.getElementById('pending-count');
  if (_offlineQueue.length === 0) {
    if (pendEl) pendEl.style.display = 'none';
    if (syncEl) { syncEl.style.display = ''; setTimeout(() => { syncEl.style.display = 'none'; }, 3000); }
    if (synced > 0) toast('✅ Sincronizado', synced + ' registro(s) enviados a Supabase');
  } else {
    if (pendCnt) pendCnt.textContent = _offlineQueue.length;
  }
}

// Run sync check on start
setTimeout(() => { updateOnlineStatus(); if (_isOnline && _offlineQueue.length > 0) syncOfflineQueue(); }, 2000);

// =====================================================================
// ==================== NOTIFICACIONES PUSH ============================
// =====================================================================
let _notifPermission = 'default';

async function requestNotifications() {
  if (!('Notification' in window)) { toast('No disponible', 'Tu navegador no soporta notificaciones', 'warn'); return; }
  if (Notification.permission === 'granted') { toast('✅ Notificaciones activas', 'Ya tenés las notificaciones habilitadas'); return; }
  const perm = await Notification.requestPermission();
  _notifPermission = perm;
  if (perm === 'granted') {
    toast('🔔 Notificaciones habilitadas', 'Te avisaremos de alertas importantes');
    sendLocalNotification('NorConstructores', '¡Notificaciones activas! Te avisaremos de contratos, facturas y alertas.');
    scheduleAlertNotifications();
  } else {
    toast('Notificaciones bloqueadas', 'Habilitá los permisos en la configuración de tu navegador', 'warn');
  }
}

function sendLocalNotification(title, body, tag) {
  if (Notification.permission !== 'granted') return;
  try {
    if (window._swReg && window._swReg.showNotification) {
      window._swReg.showNotification(title, { body, icon: '', tag: tag || 'norconstruc', badge: '' });
    } else {
      new Notification(title, { body, tag: tag || 'norconstruc' });
    }
  } catch(e) { console.warn('Notification error:', e); }
}

function scheduleAlertNotifications() {
  // Check every 30 min for critical alerts
  setInterval(() => {
    if (typeof generarAlertas !== 'function') return;
    const alertas = generarAlertas();
    const criticas = alertas.filter(a => a.tipo === 'critica');
    if (criticas.length > 0) {
      sendLocalNotification(
        '🚨 NorConstructores — ' + criticas.length + ' alerta(s) crítica(s)',
        criticas.slice(0,3).map(a => a.msg).join(' | '),
        'alertas-criticas'
      );
    }
  }, 30 * 60 * 1000);
}

// Auto-request notifications after login
function initNotifications() {
  _notifPermission = Notification ? Notification.permission : 'default';
  if (_notifPermission === 'granted') scheduleAlertNotifications();
  else if (_notifPermission === 'default') {
    // Show subtle prompt after 10 seconds
    setTimeout(() => {
      if (document.getElementById('login-screen').style.display === 'none') {
        showNotifPrompt();
      }
    }, 10000);
  }
}

function showNotifPrompt() {
  const existing = document.getElementById('notif-prompt');
  if (existing) return;
  const el = document.createElement('div');
  el.id = 'notif-prompt';
  el.style.cssText = 'position:fixed;bottom:20px;right:20px;background:var(--bg3);border:1px solid var(--border2);border-radius:12px;padding:16px 20px;z-index:9998;max-width:300px;box-shadow:0 8px 32px rgba(0,0,0,0.4);';
  el.innerHTML = `
    <div style="font-weight:700;font-size:14px;margin-bottom:6px;">🔔 Activar notificaciones</div>
    <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;">Recibí alertas de contratos vencidos, facturas y más.</div>
    <div style="display:flex;gap:8px;">
      <button class="btn btn-primary btn-sm" style="flex:1" onclick="requestNotifications();document.getElementById('notif-prompt').remove()">Activar</button>
      <button class="btn btn-ghost btn-sm" onclick="document.getElementById('notif-prompt').remove()">Ahora no</button>
    </div>`;
  document.body.appendChild(el);
}

// =====================================================================
// ==================== IMPORTAR DESDE EXCEL ==========================
// =====================================================================
const IMPORT_SCHEMAS = {
  personal: {
    cols: ['nombre *', 'rol', 'cuadrilla', 'tipo_contrato', 'sueldo', 'horas_semana', 'telefono', 'email', 'fecha_inicio', 'fecha_fin'],
    example: [['Juan Pérez','Albañil','Cuadrilla A','Fijo',1800,48,'099123456','juan@mail.com','2025-01-01','2025-12-31']]
  },
  proyectos: {
    cols: ['nombre *', 'tipo', 'cliente', 'presupuesto', 'avance', 'estado', 'ubicacion', 'inicio', 'fin'],
    example: [['Torre Central','Residencial','Cliente SA',500000,35,'activo','Av. Principal 123','2025-01-01','2025-12-31']]
  },
  maquinaria: {
    cols: ['nombre *', 'tipo', 'modelo', 'matricula', 'horas', 'tarifa', 'costo_hora', 'estado', 'proximo_mantenimiento'],
    example: [['Excavadora 320','Excavadora','CAT 320','ABC-123',120,85,30,'activo','2025-06-01']]
  },
  materiales: {
    cols: ['nombre *', 'categoria', 'unidad', 'stock', 'stock_minimo', 'precio_unitario', 'proveedor'],
    example: [['Cemento Portland','Materiales básicos','bolsa',500,50,18.5,'Proveedor ABC']]
  },
  proveedores: {
    cols: ['empresa *', 'ruc', 'contacto', 'telefono', 'email', 'categoria', 'ciudad'],
    example: [['Proveedor ABC SAC','20123456789','Juan García','01-234-5678','info@prov.com','Materiales','Lima']]
  }
};

let _importData = null;
let _importTipo = 'personal';

function updateImportTemplate() {
  _importTipo = document.getElementById('import-tipo').value;
  const schema = IMPORT_SCHEMAS[_importTipo];
  document.getElementById('import-columns').innerHTML = schema.cols.map((c,i) => `<span style="background:var(--bg4);padding:2px 8px;border-radius:4px;margin:2px;display:inline-block;">${i+1}. ${c}</span>`).join('');
  _importData = null;
  document.getElementById('import-preview').style.display = 'none';
  document.getElementById('import-result').style.display = 'none';
  document.getElementById('import-btn').disabled = true;
  document.getElementById('import-file').value = '';
}

function downloadImportTemplate() {
  const tipo = document.getElementById('import-tipo').value;
  const schema = IMPORT_SCHEMAS[tipo];
  const ws = XLSX.utils.aoa_to_sheet([schema.cols.map(c => c.replace(' *','')), ...schema.example]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, tipo);
  XLSX.writeFile(wb, 'plantilla_' + tipo + '.xlsx');
  toast('⬇️ Plantilla descargada', 'Completá el archivo y luego importalo');
}

function previewImport(input) {
  const file = input.files[0];
  if (!file) return;
  _importData = null;
  document.getElementById('import-btn').disabled = true;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
      if (rows.length < 2) { toast('Archivo vacío', 'El archivo no tiene datos', 'err'); return; }

      const headers = rows[0].map(h => String(h).toLowerCase().trim());
      const dataRows = rows.slice(1).filter(r => r.some(c => c !== ''));
      _importData = { headers, rows: dataRows, tipo: _importTipo };

      // Preview table
      const preview = document.getElementById('import-preview');
      const previewTitle = document.getElementById('import-preview-title');
      const previewContent = document.getElementById('import-preview-content');
      previewTitle.textContent = `Vista previa — ${dataRows.length} fila(s) encontrada(s)`;
      const sample = dataRows.slice(0,5);
      previewContent.innerHTML = `<div style="overflow-x:auto;"><table style="font-size:11px;width:100%;border-collapse:collapse;">
        <thead><tr>${headers.map(h=>`<th style="padding:4px 8px;background:var(--bg4);color:var(--muted2);white-space:nowrap;">${h}</th>`).join('')}</tr></thead>
        <tbody>${sample.map(r=>`<tr>${r.map(c=>`<td style="padding:3px 8px;border-top:1px solid var(--border);white-space:nowrap;">${c}</td>`).join('')}</tr>`).join('')}</tbody>
      </table></div>`;
      preview.style.display = '';
      document.getElementById('import-btn').disabled = false;
      toast('✅ Archivo leído', dataRows.length + ' filas listas para importar');
    } catch(err) {
      toast('Error al leer archivo', err.message, 'err');
    }
  };
  reader.readAsArrayBuffer(file);
}

async function executeImport() {
  if (!_importData) return;
  const { headers, rows, tipo } = _importData;
  showLoading(true);
  let imported = 0, errors = 0;
  const resultEl = document.getElementById('import-result');

  const mapRow = (row) => {
    const obj = {};
    headers.forEach((h,i) => { obj[h.replace(/[^a-z0-9_]/g,'')] = row[i]; });
    return obj;
  };

  for (const row of rows) {
    const r = mapRow(row);
    try {
      if (tipo === 'personal') {
        await importPersonal(r);
      } else if (tipo === 'proyectos') {
        await importProyecto(r);
      } else if (tipo === 'maquinaria') {
        await importMaquina(r);
      } else if (tipo === 'materiales') {
        await importMaterial(r);
      } else if (tipo === 'proveedores') {
        await importProveedor(r);
      }
      imported++;
    } catch(e) { errors++; console.warn('Import error row:', row, e); }
  }

  showLoading(false);
  resultEl.style.display = '';
  resultEl.innerHTML = `<div style="background:${imported>0?'rgba(34,197,94,0.1)':'rgba(239,68,68,0.1)'};border-radius:10px;padding:14px;border:1px solid ${imported>0?'rgba(34,197,94,0.3)':'rgba(239,68,68,0.3)'};">
    <div style="font-weight:700;color:${imported>0?'var(--green)':'var(--red)'};">${imported>0?'✅':'❌'} Importación ${imported>0?'completada':'con errores'}</div>
    <div style="font-size:12px;color:var(--muted2);margin-top:4px;">${imported} importado(s) exitosamente · ${errors} error(es)</div>
  </div>`;

  if (imported > 0) {
    await loadAllData();
    toast('📤 Importación completa', imported + ' registros de ' + tipo + ' importados');
  }
  _importData = null;
  document.getElementById('import-btn').disabled = true;
}

async function importPersonal(r) {
  const nombre = r.nombre || r['nombre_'] || r.name;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre), rol: r.rol||r.cargo||'Obrero',
    cuadrilla: r.cuadrilla||'', tipo: r.tipo_contrato||r.tipo||'Fijo',
    sueldo: parseFloat(r.sueldo)||0, horas: parseFloat(r.horas_semana||r.horas)||48,
    telefono: r.telefono||r.tel||'', email: r.email||'',
    proyecto_id: null, activo: true,
    fecha_inicio: r.fecha_inicio||r.inicio||null, fecha_fin: r.fecha_fin||r.fin||null
  };
  try { await sbFetch('personal', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('personal','POST',payload,null); }
}

async function importProyecto(r) {
  const nombre = r.nombre || r.project || r.proyecto;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre), tipo: r.tipo||'Residencial',
    cliente: r.cliente||'', presupuesto: parseFloat(r.presupuesto)||0,
    avance: parseFloat(r.avance)||0, estado: r.estado||'activo',
    ubicacion: r.ubicacion||r.direccion||'',
    inicio: r.inicio||r.fecha_inicio||null, fin: r.fin||r.fecha_fin||null
  };
  try { await sbFetch('proyectos', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('proyectos','POST',payload,null); }
}

async function importMaquina(r) {
  const nombre = r.nombre || r.equipo || r.maquina;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre), tipo: r.tipo||'',
    modelo: r.modelo||'', matricula: r.matricula||r.patente||'',
    horas: parseFloat(r.horas)||0, tarifa: parseFloat(r.tarifa)||0,
    costo_hora: parseFloat(r.costo_hora||r.costohora)||0,
    estado: r.estado||'activo', proximo_mantenimiento: r.proximo_mantenimiento||r.mantenim||null
  };
  try { await sbFetch('maquinaria', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('maquinaria','POST',payload,null); }
}

async function importMaterial(r) {
  const nombre = r.nombre || r.material || r.descripcion;
  if (!nombre) throw new Error('Sin nombre');
  const payload = {
    id: crypto.randomUUID(), nombre: String(nombre),
    categoria: r.categoria||'', unidad: r.unidad||'und',
    stock: parseFloat(r.stock)||0, stock_minimo: parseFloat(r.stock_minimo||r.stockminimo)||0,
    precio_unitario: parseFloat(r.precio_unitario||r.precio)||0,
    proveedor: r.proveedor||''
  };
  try { await sbFetch('materiales', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('materiales','POST',payload,null); }
}

async function importProveedor(r) {
  const empresa = r.empresa || r.nombre || r.company;
  if (!empresa) throw new Error('Sin empresa');
  const payload = {
    id: crypto.randomUUID(), empresa: String(empresa), ruc: r.ruc||'',
    contacto: r.contacto||r.nombre_contacto||'',
    telefono: r.telefono||r.tel||'', email: r.email||'',
    categoria: r.categoria||'', ciudad: r.ciudad||''
  };
  try { await sbFetch('proveedores', { method:'POST', body: payload }); }
  catch(e) { addToOfflineQueue('proveedores','POST',payload,null); }
}

// =====================================================================
// ==================== HISTORIAL MAQUINARIA ===========================
// =====================================================================
const MAQ_HIST_KEY = 'bc_maq_historial_v1';
let dbMaqHistorial = JSON.parse(localStorage.getItem(MAQ_HIST_KEY) || '[]');

async function loadMaqHistorialSB() {
  try {
    const rows = await sbFetch('maquinaria_historial?order=fecha.desc&limit=500');
    dbMaqHistorial = rows.map(r => ({
      id: r.id, maquina_id: r.maquina_id, maquina_nombre: r.maquina_nombre,
      fecha: r.fecha, tipo: r.tipo, proyecto_id: r.proyecto_id,
      horas: r.horas, combustible: r.combustible, costo_combustible: r.costo_combustible,
      operador: r.operador, obs: r.observacion
    }));
    localStorage.setItem(MAQ_HIST_KEY, JSON.stringify(dbMaqHistorial));
  } catch(e) {
    dbMaqHistorial = JSON.parse(localStorage.getItem(MAQ_HIST_KEY) || '[]');
  }
}

function renderHistorialMaq() {
  const filtro = document.getElementById('maq-hist-filtro')?.value || '';

  // Populate selector
  const sel = document.getElementById('maq-hist-filtro');
  if (sel && db.maquinaria.length > 0) {
    const cur = sel.value;
    sel.innerHTML = '<option value="">Todos los equipos</option>' + db.maquinaria.map(m=>`<option value="${m.id}">${m.nombre}</option>`).join('');
    sel.value = cur;
  }

  const items = filtro ? dbMaqHistorial.filter(r => r.maquina_id === filtro) : dbMaqHistorial;

  // KPIs combustible
  const totalComb = dbMaqHistorial.reduce((a,r) => a + parseFloat(r.combustible||0), 0);
  const totalCostoComb = dbMaqHistorial.reduce((a,r) => a + parseFloat(r.costo_combustible||0), 0);
  const totalMantenim = dbMaqHistorial.filter(r => r.tipo === 'mantenimiento').length;
  const el_c = document.getElementById('maq-combustible-total');
  const el_cc = document.getElementById('maq-comb-costo');
  const el_m = document.getElementById('maq-mantenim-count');
  if (el_c) el_c.textContent = totalComb.toFixed(2) + ' Gal';
  if (el_cc) el_cc.textContent = 'S/ ' + totalCostoComb.toLocaleString('es-PE');
  if (el_m) el_m.textContent = totalMantenim;

  const tipoEmoji = { uso:'⚙️', combustible:'⛽', mantenimiento:'🔧', revision:'🔍' };
  const tipoColor = { uso:'var(--blue)', combustible:'var(--accent)', mantenimiento:'var(--red)', revision:'var(--purple)' };

  const tbody = document.getElementById('historial-maq-table');
  if (!tbody) return;

  tbody.innerHTML = items.length === 0
    ? '<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:24px;">Sin registros. Hacé clic en "+ Registrar Uso".</td></tr>'
    : items.map(r => {
        const proy = db.proyectos.find(p => p.id === r.proyecto_id);
        const tc = tipoColor[r.tipo] || 'var(--muted)';
        return `<tr>
          <td>${r.fecha||'—'}</td>
          <td><strong>${r.maquina_nombre||'—'}</strong></td>
          <td>${proy?.nombre||'—'}</td>
          <td>${r.horas||0}h</td>
          <td>${r.combustible||0} Gal</td>
          <td>S/ ${parseFloat(r.costo_combustible||0).toFixed(2)}</td>
          <td>${r.operador||'—'}</td>
          <td><span style="color:${tc};font-weight:600;">${tipoEmoji[r.tipo]||''} ${r.tipo||'—'}</span></td>
          <td style="font-size:11px;color:var(--muted2);">${r.obs||'—'}</td>
          <td>
            <button class="btn btn-danger btn-sm" onclick="deleteUsoMaquina('${r.id}')">🗑️</button>
          </td>
        </tr>`;
      }).join('');

  // Mobile cards
  const mobile = document.getElementById('historial-maq-mobile');
  if (mobile) {
    mobile.innerHTML = items.slice(0,20).map(r => {
      const tc = tipoColor[r.tipo] || 'var(--muted)';
      return `<div class="mobile-card">
        <div class="mc-header">
          <div class="mc-avatar" style="background:${tc}22;color:${tc};">${tipoEmoji[r.tipo]||'⚙'}</div>
          <div class="mc-name">${r.maquina_nombre||'—'}<div class="mc-sub">${r.fecha||'—'}</div></div>
          <span style="color:${tc};font-weight:700;font-size:12px;">${r.tipo}</span>
        </div>
        <div class="mc-body">
          <div><div class="mc-label">Horas</div><div class="mc-val">${r.horas||0}h</div></div>
          <div><div class="mc-label">Combustible</div><div class="mc-val">${r.combustible||0} Gal</div></div>
          <div><div class="mc-label">Operador</div><div class="mc-val">${r.operador||'—'}</div></div>
        </div>
      </div>`;
    }).join('');
  }
}

function openUsoMaquinaModal(maquinaId) {
  document.getElementById('uso-edit-id').value = '';
  document.getElementById('uso-fecha').value = new Date().toISOString().slice(0,10);
  document.getElementById('uso-tipo').value = 'uso';
  document.getElementById('uso-horas').value = 0;
  document.getElementById('uso-combustible').value = 0;
  document.getElementById('uso-costo-comb').value = 0;
  document.getElementById('uso-operador').value = '';
  document.getElementById('uso-obs').value = '';
  // Populate maquinas
  const sel = document.getElementById('uso-maquina-sel');
  sel.innerHTML = db.maquinaria.map(m => `<option value="${m.id}">${m.nombre}</option>`).join('');
  if (maquinaId) sel.value = maquinaId;
  // Populate proyectos
  const psel = document.getElementById('uso-proyecto');
  psel.innerHTML = '<option value="">— Sin proyecto —</option>' + db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('');
  document.getElementById('modal-uso-maquina').classList.add('open');
}

async function saveUsoMaquina() {
  const id = document.getElementById('uso-edit-id').value;
  const maquinaId = document.getElementById('uso-maquina-sel').value;
  const maquina = db.maquinaria.find(m => m.id === maquinaId);
  const fecha = document.getElementById('uso-fecha').value;
  const tipo = document.getElementById('uso-tipo').value;
  const proyId = document.getElementById('uso-proyecto').value || null;
  const horas = parseFloat(document.getElementById('uso-horas').value) || 0;
  const combustible = parseFloat(document.getElementById('uso-combustible').value) || 0;
  const costoComb = parseFloat(document.getElementById('uso-costo-comb').value) || 0;
  const operador = document.getElementById('uso-operador').value.trim();
  const obs = document.getElementById('uso-obs').value.trim();

  if (!maquinaId || !fecha) { toast('Campos requeridos', 'Seleccioná equipo y fecha', 'warn'); return; }

  const payload = {
    maquina_id: maquinaId, maquina_nombre: maquina?.nombre || '?',
    fecha, tipo, proyecto_id: proyId,
    horas, combustible, costo_combustible: costoComb,
    operador, observacion: obs
  };

  showLoading(true);
  try {
    const res = await sbFetch('maquinaria_historial', { method:'POST', body: payload });
    const newId = (Array.isArray(res)?res[0]:res)?.id || ('local_'+Date.now());
    dbMaqHistorial.unshift({ id: newId, ...payload, obs });
    toast('✅ Registro guardado', `${maquina?.nombre} — ${tipo}`);
  } catch(e) {
    const newId = 'local_'+Date.now();
    dbMaqHistorial.unshift({ id: newId, ...payload, obs });
    addToOfflineQueue('maquinaria_historial','POST',payload,null);
    toast('Guardado local', 'Se sincronizará al conectar', 'warn');
  }
  localStorage.setItem(MAQ_HIST_KEY, JSON.stringify(dbMaqHistorial));
  showLoading(false);
  closeModal('uso-maquina');
  renderHistorialMaq();
}

async function deleteUsoMaquina(id) {
  if (!confirm('¿Eliminar este registro?')) return;
  if (!id.startsWith('local_')) {
    try { await sbFetch('maquinaria_historial?id=eq.' + id, { method:'DELETE', prefer:'return=minimal' }); }
    catch(e) {}
  }
  dbMaqHistorial = dbMaqHistorial.filter(r => r.id !== id);
  localStorage.setItem(MAQ_HIST_KEY, JSON.stringify(dbMaqHistorial));
  renderHistorialMaq();
  toast('Registro eliminado','','err');
}

function exportHistorialMaqExcel() {
  const rows = [['Fecha','Equipo','Proyecto','Horas','Combustible (Gal)','Costo Comb. S/','Operador','Tipo','Observación']];
  dbMaqHistorial.forEach(r => {
    const proy = db.proyectos.find(p=>p.id===r.proyecto_id);
    rows.push([r.fecha,r.maquina_nombre,proy?.nombre||'',r.horas||0,r.combustible||0,r.costo_combustible||0,r.operador||'',r.tipo||'',r.obs||'']);
  });
  const ws=XLSX.utils.aoa_to_sheet(rows); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Historial');
  XLSX.writeFile(wb,'historial_maquinaria_'+new Date().toISOString().slice(0,10)+'.xlsx');
  toast('📥 Historial exportado');
}

// Override openModal to handle new modals
const _origOpenModal = window.openModal || openModal;
window.openModal = function(name, id) {
  if (name === 'importar') {
    document.getElementById('modal-importar').classList.add('open');
    updateImportTemplate();
    return;
  }
  if (name === 'uso-maquina') {
    openUsoMaquinaModal(id);
    return;
  }
  _origOpenModal(name, id);
};

// =====================================================================
// ==================== REPORTES PDF MEJORADO =========================
// =====================================================================
// Override generarReportePDF with enhanced version using autotable
const _origGenerarPDF = window.generarReportePDF;
window.generarReportePDF = async function() {
  if (!window.jspdf) { toast('Cargando jsPDF...','','warn'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
  const W = 210, PRIMARY = [245,166,35], DARK = [13,15,18], LIGHT = [241,245,249], MUTED = [100,116,139];
  const hoy = new Date();
  const fechaStr = hoy.toLocaleDateString('es-PE', { year:'numeric', month:'long', day:'numeric' });

  // Cover / Header
  doc.setFillColor(...DARK); doc.rect(0,0,W,40,'F');
  doc.setFontSize(24); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('NorConstructores', 20, 20);
  doc.setFontSize(11); doc.setTextColor(...LIGHT); doc.setFont('helvetica','normal');
  doc.text('Reporte Ejecutivo de Proyectos', 20, 29);
  doc.setFontSize(9); doc.setTextColor(...MUTED);
  doc.text(fechaStr, W-20, 29, {align:'right'});
  doc.setDrawColor(...PRIMARY); doc.setLineWidth(0.8); doc.line(0,40,W,40);

  let y = 50;

  // KPI boxes
  const totalCartera = db.proyectos.reduce((a,p)=>a+parseFloat(p.presupuesto||0),0);
  const avgAvance = db.proyectos.length ? Math.round(db.proyectos.reduce((a,p)=>a+parseFloat(p.avance||0),0)/db.proyectos.length) : 0;
  const movs = window.dbMovimientos || [];
  const totalIng = movs.filter(m=>m.tipo==='ingreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  const totalEgr = movs.filter(m=>m.tipo==='egreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
  const saldo = totalIng - totalEgr;

  const kpis = [
    { label:'Cartera Total', val:'S/ '+totalCartera.toLocaleString('es-PE'), color:[245,166,35] },
    { label:'Avance Promedio', val:avgAvance+'%', color:[59,130,246] },
    { label:'Ingresos', val:'S/ '+totalIng.toLocaleString('es-PE'), color:[34,197,94] },
    { label:'Saldo Neto', val:'S/ '+saldo.toLocaleString('es-PE'), color: saldo>=0?[34,197,94]:[239,68,68] },
  ];
  const kw = 42, kh = 22, kgap = 4, kstart = 20;
  kpis.forEach((k,i) => {
    const kx = kstart + i*(kw+kgap);
    doc.setFillColor(k.color[0],k.color[1],k.color[2],0.1);
    doc.roundedRect(kx,y,kw,kh,3,3,'F');
    doc.setDrawColor(k.color[0],k.color[1],k.color[2],0.3); doc.setLineWidth(0.3);
    doc.roundedRect(kx,y,kw,kh,3,3,'S');
    doc.setFontSize(7); doc.setTextColor(...MUTED); doc.setFont('helvetica','normal');
    doc.text(k.label, kx+kw/2, y+7, {align:'center'});
    doc.setFontSize(10); doc.setTextColor(k.color[0],k.color[1],k.color[2]); doc.setFont('helvetica','bold');
    doc.text(k.val, kx+kw/2, y+16, {align:'center'});
  });
  y += kh + 12;

  // Section: Proyectos
  doc.setFontSize(12); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('PROYECTOS', 20, y); y += 2;
  doc.setDrawColor(...PRIMARY); doc.setLineWidth(0.4); doc.line(20,y,W-20,y); y += 6;

  if (doc.autoTable) {
    doc.autoTable({
      startY: y,
      head: [['Proyecto','Cliente','Presupuesto','Avance','Estado']],
      body: db.proyectos.map(p => [
        p.nombre||'', p.cliente||'', 'S/ '+(parseFloat(p.presupuesto||0)/1000).toFixed(0)+'K',
        (p.avance||0)+'%', p.estado||''
      ]),
      theme: 'grid',
      headStyles: { fillColor: [30,35,45], textColor: [245,166,35], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor: [20,25,32], textColor: [200,210,220], fontSize:8 },
      alternateRowStyles: { fillColor: [25,30,38] },
      margin: { left:20, right:20 },
      styles: { lineColor:[40,50,60], lineWidth:0.2 }
    });
    y = doc.lastAutoTable.finalY + 10;
  } else {
    db.proyectos.forEach(p => {
      doc.setTextColor(...LIGHT); doc.setFontSize(9); doc.setFont('helvetica','normal');
      doc.text(`${p.nombre||''} | ${p.cliente||''} | S/ ${(parseFloat(p.presupuesto||0)/1000).toFixed(0)}K | ${p.avance||0}% | ${p.estado||''}`, 20, y);
      y += 7; if(y>270){doc.addPage();y=20;}
    });
    y += 5;
  }

  // Section: Personal
  if (y > 230) { doc.addPage(); y = 20; }
  doc.setFontSize(12); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('PERSONAL', 20, y); y += 2;
  doc.setDrawColor(...PRIMARY); doc.line(20,y,W-20,y); y += 6;

  if (doc.autoTable) {
    doc.autoTable({
      startY: y,
      head: [['Nombre','Rol','Cuadrilla','Tipo','Sueldo S/']],
      body: db.personal.map(p => [p.nombre||'', p.rol||'', p.cuadrilla||'', p.tipo||'', p.sueldo||0]),
      theme: 'grid',
      headStyles: { fillColor:[30,35,45], textColor:[59,130,246], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor:[20,25,32], textColor:[200,210,220], fontSize:8 },
      alternateRowStyles: { fillColor:[25,30,38] },
      margin:{left:20,right:20},
      styles:{lineColor:[40,50,60],lineWidth:0.2}
    });
    y = doc.lastAutoTable.finalY + 10;
  }

  // Section: Flujo de Caja
  if (y > 230) { doc.addPage(); y = 20; }
  doc.setFontSize(12); doc.setTextColor(...PRIMARY); doc.setFont('helvetica','bold');
  doc.text('FLUJO DE CAJA', 20, y); y += 2;
  doc.setDrawColor(...PRIMARY); doc.line(20,y,W-20,y); y += 6;

  if (doc.autoTable && movs.length > 0) {
    doc.autoTable({
      startY: y,
      head: [['Fecha','Concepto','Categoría','Tipo','Monto S/']],
      body: movs.slice(0,30).map(m => [m.fecha||'', m.concepto||'', m.categoria||'', m.tipo||'', parseFloat(m.monto||0).toFixed(2)]),
      theme: 'grid',
      headStyles: { fillColor:[30,35,45], textColor:[34,197,94], fontStyle:'bold', fontSize:8 },
      bodyStyles: { fillColor:[20,25,32], textColor:[200,210,220], fontSize:8 },
      alternateRowStyles: { fillColor:[25,30,38] },
      margin:{left:20,right:20},
      styles:{lineColor:[40,50,60],lineWidth:0.2}
    });
  } else if (!movs.length) {
    doc.setFontSize(9); doc.setTextColor(...MUTED); doc.text('Sin movimientos registrados.', 20, y+6);
  }

  // Footer on all pages
  const pageCount = doc.internal.getNumberOfPages();
  for (let i=1;i<=pageCount;i++) {
    doc.setPage(i);
    doc.setFillColor(...DARK); doc.rect(0,285,W,12,'F');
    doc.setFontSize(7); doc.setTextColor(...MUTED);
    doc.text('NorConstructores — Sistema de Gestión Constructora', 20, 292);
    doc.text(`Página ${i} de ${pageCount}`, W-20, 292, {align:'right'});
  }

  doc.save('reporte_norconstruc_'+hoy.toISOString().slice(0,10)+'.pdf');
  toast('📄 PDF generado', 'Reporte completo con tablas descargado');
};

// =====================================================================
// ==================== INIT HOOKS ====================================
// =====================================================================
// Init notifications after login
const _origLoadAllNewModules = window.loadAllData || loadAllData;
window.loadAllData = async function() {
  await _origLoadAllNewModules();
  await Promise.allSettled([loadMaqHistorialSB()]);
  setTimeout(() => {
    renderHistorialMaq();
    updateOnlineStatus();
    initNotifications();
    // Update topbar alert badge
    if (typeof generarAlertas === 'function') {
      const al = generarAlertas();
      const cnt = al.filter(a=>a.tipo!=='info').length;
      const badge = document.getElementById('topbar-alert-badge');
      if (badge && cnt > 0) { badge.textContent = cnt > 9 ? '9+' : cnt; badge.style.display = 'flex'; }
    }
  }, 500);
};

// Also patch nav for maquinaria to show historial
const _origNavMaq = window.nav;
window.nav = function(page, el) {
  if (_origNavMaq) _origNavMaq(page, el);
  if (page === 'maquinaria') setTimeout(renderHistorialMaq, 100);
};

// Patch openModal for uso-maquina button in machine card
document.addEventListener('click', e => {
  const btn = e.target.closest('[data-uso-maquina]');
  if (btn) openUsoMaquinaModal(btn.dataset.usoMaquina);
});


// =====================================================================
// ==================== PLANILLA DE SUELDOS ============================
// =====================================================================
const PLANILLA_KEY = 'bc_planilla_v1';
let _planillaData = [];
let _planillaPeriodo = 'mensual'; // 'mensual' | 'quincenal' | 'semanal'
let _planillaMes = '';

// ── Tasas legales Perú ────────────────────────────────────────────────
const TASAS = {
  ONP:            0.13,   // 13% trabajador → ONP
  AFP_APORTE:     0.10,   // 10% trabajador → AFP (fondo)
  AFP_COMISION:   0.015,  // ~1.5% comisión AFP (varía por AFP)
  AFP_SEGURO:     0.0137, // ~1.37% seguro de invalidez y sobrevivencia
  ESSALUD:        0.09,   // 9% empleador → EsSalud
  CTS:            0.0833, // 8.33% mensual provisión CTS (1/12 sueldo)
  GRATIFICACION:  0.1667, // 16.67% mensual provisión Gratificación (2 al año)
  ASIG_FAMILIAR:  102.50, // S/ 102.50 (10% RMV 2024 = S/ 1025)
  RMV:            1025,   // Remuneración Mínima Vital 2024
  UIT:            5150,   // UIT 2024
};

const AFP_INFO = {
  'Integra':   { comision: 0.0155, seguro: 0.0137 },
  'Prima':     { comision: 0.0160, seguro: 0.0137 },
  'Profuturo': { comision: 0.0169, seguro: 0.0137 },
  'Habitat':   { comision: 0.0138, seguro: 0.0137 },
};

function initPlanilla() {
  const sel = document.getElementById('planilla-mes');
  if (!sel) return;
  const opts = [];
  for (let i = 0; i < 12; i++) {
    const d = new Date(); d.setDate(1); d.setMonth(d.getMonth() - i);
    const val = d.toISOString().slice(0,7);
    const lbl = d.toLocaleDateString('es-PE', { year:'numeric', month:'long' });
    opts.push('<option value="' + val + '">' + lbl + '</option>');
  }
  sel.innerHTML = opts.join('');
  calcularPlanilla();
}

function togglePlanillaConfig() {
  const el = document.getElementById('planilla-config');
  el.style.display = el.style.display === 'none' ? '' : 'none';
}

function setPeriodo(tipo) {
  _planillaPeriodo = tipo;
  document.querySelectorAll('.btn-periodo').forEach(b => b.classList.remove('btn-primary'));
  const btn = document.getElementById('btn-periodo-' + tipo);
  if (btn) btn.classList.add('btn-primary');
  calcularPlanilla();
}

// ── Cálculo principal ────────────────────────────────────────────────
function calcularPlanilla() {
  const mes = document.getElementById('planilla-mes')?.value;
  if (!mes) return;
  _planillaMes = mes;

  if (!db.personal.length) {
    document.getElementById('planilla-table').innerHTML =
      '<tr><td colspan="15" style="text-align:center;color:var(--muted);padding:28px;">Sin personal registrado. Agregá empleados en la sección Personal.</td></tr>';
    return;
  }

  // Asistencia del mes
  const diasMes = Object.keys(_asistenciaData || {}).filter(d => d.startsWith(mes));
  const asistMap = {};
  diasMes.forEach(dia => {
    (_asistenciaData[dia] || []).forEach(r => {
      if (!asistMap[r.personalId]) asistMap[r.personalId] = { dias: 0, hExtras: 0, tardanzas: 0 };
      if (r.estado === 'presente') asistMap[r.personalId].dias++;
      if (r.estado === 'tardanza') { asistMap[r.personalId].dias++; asistMap[r.personalId].tardanzas++; }
      asistMap[r.personalId].hExtras += parseFloat(r.horasExtras) || 0;
    });
  });

  const diasLaborables = 26;
  const divisorSemana  = diasLaborables / 4;  // ~6.5 días por semana
  const divisorQuin    = diasLaborables / 2;   // 13 días por quincena

  _planillaData = db.personal.map(p => {
    const sueldo    = parseFloat(p.sueldo) || 0;
    const horasWeek = parseFloat(p.horas) || 48;
    const valorHora = sueldo / (horasWeek * 4.33);
    const esHonorarios = (p.tipo || '').toLowerCase().includes('honorar');
    const tieneAsigFam = p.asigFamiliar === true || p.asigFamiliar === 'true';
    const sistPension  = (p.pension || 'ONP').toUpperCase(); // 'ONP' o nombre AFP
    const afpNombre    = sistPension !== 'ONP' ? sistPension : null;
    const afpTasas     = afpNombre ? (AFP_INFO[afpNombre] || AFP_INFO['Integra']) : null;

    const asist     = asistMap[p.id] || { dias: diasLaborables, hExtras: 0, tardanzas: 0 };
    let diasTrab    = asist.dias || diasLaborables;
    const hExtras   = asist.hExtras || 0;
    const tardanzas = asist.tardanzas || 0;

    // Proporcional según período
    let factor = 1;
    if (_planillaPeriodo === 'semanal')    factor = divisorSemana / diasLaborables;
    if (_planillaPeriodo === 'quincenal')  factor = 0.5;

    const sueldoBase = (sueldo / diasLaborables) * diasTrab * factor;
    const montoHExt  = hExtras * valorHora * 1.25 * factor; // 25% recargo mínimo
    const asigFam    = (!esHonorarios && tieneAsigFam) ? TASAS.ASIG_FAMILIAR * factor : 0;

    // Descuento por tardanza (30 min de descuento por tardanza)
    const descTardanza = tardanzas * (valorHora * 0.5) * factor;

    const bruto = sueldoBase + montoHExt + asigFam - descTardanza;

    // ── Descuentos del trabajador ────────────────────────────────────
    let descPension = 0, descComision = 0, descSeguro = 0;

    if (esHonorarios) {
      // Honorarios: retención 8% 4ta categoría (si supera 1500 en el mes)
      descPension = bruto >= 1500 ? bruto * 0.08 : 0;
    } else if (sistPension === 'ONP') {
      descPension = bruto * TASAS.ONP;
    } else {
      // AFP
      descPension = bruto * TASAS.AFP_APORTE;
      descComision = bruto * (afpTasas?.comision || TASAS.AFP_COMISION);
      descSeguro   = bruto * (afpTasas?.seguro   || TASAS.AFP_SEGURO);
    }

    const totalDesc = descPension + descComision + descSeguro;
    const neto = bruto - totalDesc;

    // ── Aportes del empleador (no descuentan al trabajador) ──────────
    const aportEsSalud = esHonorarios ? 0 : bruto * TASAS.ESSALUD;
    const aportCTS     = esHonorarios ? 0 : bruto * TASAS.CTS * factor;
    const aportGrat    = esHonorarios ? 0 : bruto * TASAS.GRATIFICACION * factor;
    const costoTotal   = bruto + aportEsSalud + aportCTS + aportGrat;

    return {
      id: p.id, nombre: p.nombre, rol: p.rol || '', cuadrilla: p.cuadrilla || '',
      tipo: esHonorarios ? 'Honorarios' : 'Planilla',
      sistPension: esHonorarios ? '4ta Cat.' : (afpNombre || 'ONP'),
      sueldo, diasTrab, hExtras, tardanzas, valorHora, factor,
      sueldoBase, montoHExt, asigFam, descTardanza,
      bruto, descPension, descComision, descSeguro, totalDesc,
      aportEsSalud, aportCTS, aportGrat, neto, costoTotal,
      mes: _planillaMes, periodo: _planillaPeriodo
    };
  });

  renderPlanillaTabla();
}

function renderPlanillaTabla() {
  const fmt = v => 'S/ ' + parseFloat(v||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const diasLab = 26;

  const totBruto  = _planillaData.reduce((a,r)=>a+r.bruto,0);
  const totDesc   = _planillaData.reduce((a,r)=>a+r.totalDesc,0);
  const totNeto   = _planillaData.reduce((a,r)=>a+r.neto,0);
  const totAport  = _planillaData.reduce((a,r)=>a+r.aportEsSalud+r.aportCTS+r.aportGrat,0);
  const totCosto  = _planillaData.reduce((a,r)=>a+r.costoTotal,0);

  const setEl = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
  setEl('plan-total-bruto',   fmt(totBruto));
  setEl('plan-total-desc',    fmt(totDesc));
  setEl('plan-total-neto',    fmt(totNeto));
  setEl('plan-total-aportes', fmt(totAport));
  setEl('plan-total-personal', _planillaData.length);
  setEl('badge-planilla', _planillaData.length);

  const periodoLabel = { mensual:'Mensual', quincenal:'Quincenal', semanal:'Semanal' }[_planillaPeriodo];
  const mesLabel = new Date(_planillaMes+'-02').toLocaleDateString('es-PE',{year:'numeric',month:'long'});
  setEl('planilla-sub', 'Planilla ' + periodoLabel + ' — ' + mesLabel + ' — ' + _planillaData.length + ' empleados');
  setEl('planilla-periodo-label', periodoLabel + ' · ' + mesLabel);

  // Costo total empresa label
  const costoEl = document.getElementById('plan-costo-total');
  if (costoEl) costoEl.textContent = fmt(totCosto);

  // ── Tabla escritorio ─────────────────────────────────────────────────
  document.getElementById('planilla-table').innerHTML = _planillaData.map(r => {
    const tipoBadge = r.tipo === 'Honorarios'
      ? '<span style="font-size:10px;padding:2px 6px;background:rgba(168,85,247,0.15);color:var(--purple);border-radius:20px;">Honorarios</span>'
      : '<span style="font-size:10px;padding:2px 6px;background:rgba(34,197,94,0.15);color:var(--green);border-radius:20px;">Planilla</span>';
    const pensionBadge = '<span style="font-size:10px;color:var(--muted2);">' + r.sistPension + '</span>';
    const descDetalle = r.tipo === 'Honorarios'
      ? '-' + fmt(r.descPension) + '<br><small style="color:var(--muted2);">Ret.4ta</small>'
      : r.sistPension === 'ONP'
        ? '-' + fmt(r.descPension) + '<br><small style="color:var(--muted2);">ONP 13%</small>'
        : '-' + fmt(r.descPension+r.descComision+r.descSeguro) + '<br><small style="color:var(--muted2);">AFP+Com+Seg</small>';

    return '<tr>' +
      '<td><strong>' + r.nombre + '</strong><br>' + tipoBadge + '</td>' +
      '<td style="font-size:11px;">' + r.rol + '<br>' + pensionBadge + '</td>' +
      '<td style="text-align:center;">' + r.diasTrab + '/' + Math.round(diasLab*r.factor) +
        (r.tardanzas > 0 ? '<br><small style="color:var(--accent);">' + r.tardanzas + ' tard.</small>' : '') + '</td>' +
      '<td style="text-align:center;color:var(--green);">' + r.hExtras.toFixed(1) + 'h</td>' +
      '<td>' + fmt(r.sueldoBase) + '</td>' +
      '<td style="color:var(--green);">' + (r.montoHExt > 0 ? '+'+fmt(r.montoHExt) : '—') + '</td>' +
      '<td>' + (r.asigFam > 0 ? fmt(r.asigFam) : '—') + '</td>' +
      '<td style="font-weight:700;color:var(--green);">' + fmt(r.bruto) + '</td>' +
      '<td style="color:var(--red);font-size:11px;">' + descDetalle + '</td>' +
      '<td style="color:var(--accent);">' + (r.aportEsSalud>0?fmt(r.aportEsSalud):'—') + '</td>' +
      '<td style="color:var(--blue);">' + (r.aportCTS>0?fmt(r.aportCTS):'—') + '</td>' +
      '<td style="color:var(--purple);">' + (r.aportGrat>0?fmt(r.aportGrat):'—') + '</td>' +
      '<td style="font-weight:800;color:var(--green);font-size:13px;">' + fmt(r.neto) + '</td>' +
      '<td style="color:var(--muted2);font-size:11px;">' + fmt(r.costoTotal) + '</td>' +
      '<td>' +
        '<button class="btn btn-ghost btn-sm" onclick="verRecibo(\'' + r.id + '\')" title="Ver boleta">🧾</button>' +
        '<button class="btn btn-primary btn-sm" onclick="generarReciboPDF(\'' + r.id + '\')" title="PDF">📄</button>' +
      '</td>' +
    '</tr>';
  }).join('');

  // ── Mobile cards ──────────────────────────────────────────────────────
  const fmt2 = v => parseFloat(v||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('planilla-mobile').innerHTML = _planillaData.map(r =>
    '<div class="mobile-card">' +
      '<div class="mc-header">' +
        '<div class="mc-avatar">' + (r.nombre||'?')[0] + '</div>' +
        '<div><div class="mc-name">' + r.nombre + '</div>' +
          '<div class="mc-sub">' + r.rol + ' · ' + r.sistPension + ' · ' + r.tipo + '</div></div>' +
        '<div style="font-weight:800;color:var(--green);font-size:15px;">S/ ' + fmt2(r.neto) + '</div>' +
      '</div>' +
      '<div class="mc-body">' +
        '<div><div class="mc-label">Bruto</div><div class="mc-val" style="color:var(--green);">S/ ' + fmt2(r.bruto) + '</div></div>' +
        '<div><div class="mc-label">Descuento</div><div class="mc-val" style="color:var(--red);">-S/ ' + fmt2(r.totalDesc) + '</div></div>' +
        '<div><div class="mc-label">Días / H.Extra</div><div class="mc-val">' + r.diasTrab + 'd / ' + r.hExtras.toFixed(1) + 'h</div></div>' +
        '<div><div class="mc-label">Costo empresa</div><div class="mc-val">S/ ' + fmt2(r.costoTotal) + '</div></div>' +
      '</div>' +
      '<div class="mc-actions">' +
        '<button class="btn btn-ghost btn-sm" onclick="verRecibo(\'' + r.id + '\')">🧾 Boleta</button>' +
        '<button class="btn btn-primary btn-sm" onclick="generarReciboPDF(\'' + r.id + '\')">📄 PDF</button>' +
      '</div>' +
    '</div>'
  ).join('');
}

// ── Boleta de pago ─────────────────────────────────────────────────────
function verRecibo(personalId) {
  const r = _planillaData.find(x => x.id === personalId);
  if (!r) return;
  const fmt2 = v => parseFloat(v||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const mesLabel = new Date(r.mes+'-02').toLocaleDateString('es-PE',{year:'numeric',month:'long'});
  const periodoLabel = { mensual:'Mensual', quincenal:'Quincenal 1ra', semanal:'Semanal' }[r.periodo] || r.periodo;
  const empresa = document.getElementById('cfg-empresa')?.value || 'NorConstructores S.A.C.';
  const ruc     = document.getElementById('cfg-ruc')?.value || '20XXXXXXXXX';

  let descRows = '';
  if (r.tipo === 'Honorarios') {
    descRows = r.descPension > 0
      ? '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#ef4444;">(-) Retención 4ta Categoría (8%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#ef4444;">-' + fmt2(r.descPension) + '</td></tr>'
      : '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#64748b;">Sin retención 4ta (monto < S/ 1,500)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;">0.00</td></tr>';
  } else if (r.sistPension === 'ONP') {
    descRows = '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#ef4444;">(-) ONP (13%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#ef4444;">-' + fmt2(r.descPension) + '</td></tr>';
  } else {
    descRows =
      '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#ef4444;">(-) AFP Aporte (10%) — ' + r.sistPension + '</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#ef4444;">-' + fmt2(r.descPension) + '</td></tr>' +
      '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#ef4444;">(-) Comisión AFP (~1.5%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#ef4444;">-' + fmt2(r.descComision) + '</td></tr>' +
      '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#ef4444;">(-) Seguro Invalidez AFP (~1.37%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#ef4444;">-' + fmt2(r.descSeguro) + '</td></tr>';
  }

  const aporteRows = r.tipo !== 'Honorarios'
    ? '<div style="background:#f0f9ff;border-radius:6px;padding:10px;font-size:11px;color:#0369a1;margin-top:8px;">' +
        '<strong>Aportes del Empleador (no afectan tu sueldo):</strong><br>' +
        'EsSalud 9%: S/ ' + fmt2(r.aportEsSalud) +
        ' &nbsp;·&nbsp; CTS (prov.): S/ ' + fmt2(r.aportCTS) +
        ' &nbsp;·&nbsp; Gratificación (prov.): S/ ' + fmt2(r.aportGrat) +
        '<br><strong>Costo total empresa: S/ ' + fmt2(r.costoTotal) + '</strong>' +
      '</div>'
    : '';

  document.getElementById('recibo-preview').innerHTML =
    '<div style="border:2px solid #1e293b;border-radius:10px;padding:20px;background:#fff;font-family:Arial,sans-serif;">' +
      '<div style="display:flex;justify-content:space-between;align-items:flex-start;border-bottom:2px solid #f5a623;padding-bottom:12px;margin-bottom:14px;">' +
        '<div>' +
          '<div style="font-size:16px;font-weight:800;color:#0d0f12;">🏗️ ' + empresa + '</div>' +
          '<div style="font-size:11px;color:#64748b;">RUC: ' + ruc + '</div>' +
        '</div>' +
        '<div style="text-align:right;">' +
          '<div style="font-size:13px;font-weight:700;color:#f5a623;">BOLETA DE PAGO</div>' +
          '<div style="font-size:11px;color:#64748b;">' + periodoLabel + ' — ' + mesLabel.toUpperCase() + '</div>' +
        '</div>' +
      '</div>' +
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px;font-size:12px;background:#f8fafc;padding:10px;border-radius:6px;">' +
        '<div><strong>Trabajador:</strong> ' + r.nombre + '</div>' +
        '<div><strong>Cargo:</strong> ' + r.rol + '</div>' +
        '<div><strong>Tipo:</strong> ' + r.tipo + '</div>' +
        '<div><strong>Sistema Pensión:</strong> ' + r.sistPension + '</div>' +
        '<div><strong>Días trabajados:</strong> ' + r.diasTrab + ' días</div>' +
        '<div><strong>Horas extras:</strong> ' + r.hExtras.toFixed(1) + ' h</div>' +
      '</div>' +
      '<table style="width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px;">' +
        '<thead><tr style="background:#f5a62320;">' +
          '<th style="padding:6px 8px;text-align:left;border:1px solid #e2e8f0;">Concepto</th>' +
          '<th style="padding:6px 8px;text-align:right;border:1px solid #e2e8f0;">Importe S/</th>' +
        '</tr></thead><tbody>' +
        '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;">Remuneración Básica (' + r.diasTrab + ' días)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;">' + fmt2(r.sueldoBase) + '</td></tr>' +
        (r.montoHExt > 0 ? '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;">Horas Extras (' + r.hExtras.toFixed(1) + 'h × 125%)</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;">' + fmt2(r.montoHExt) + '</td></tr>' : '') +
        (r.asigFam > 0 ? '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;">Asignación Familiar</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;">' + fmt2(r.asigFam) + '</td></tr>' : '') +
        (r.descTardanza > 0 ? '<tr><td style="padding:5px 8px;border:1px solid #e2e8f0;color:#f59e0b;">(-) Descuento tardanzas (' + r.tardanzas + ')</td><td style="padding:5px 8px;text-align:right;border:1px solid #e2e8f0;color:#f59e0b;">-' + fmt2(r.descTardanza) + '</td></tr>' : '') +
        '<tr style="background:#f0fdf4;font-weight:700;"><td style="padding:6px 8px;border:1px solid #e2e8f0;">TOTAL INGRESOS (BRUTO)</td><td style="padding:6px 8px;text-align:right;border:1px solid #e2e8f0;color:#16a34a;">' + fmt2(r.bruto) + '</td></tr>' +
        descRows +
        '<tr style="background:#fef9c3;font-weight:800;font-size:14px;"><td style="padding:7px 8px;border:1px solid #e2e8f0;">✅ NETO A PAGAR</td><td style="padding:7px 8px;text-align:right;border:1px solid #e2e8f0;color:#16a34a;">S/ ' + fmt2(r.neto) + '</td></tr>' +
        '</tbody></table>' +
      aporteRows +
      '<div style="margin-top:16px;display:flex;justify-content:space-between;padding-top:12px;border-top:1px solid #e2e8f0;font-size:11px;color:#94a3b8;">' +
        '<div>_________________________<br>Firma Empleador</div>' +
        '<div style="text-align:right;">_________________________<br>Firma Trabajador</div>' +
      '</div>' +
    '</div>';
  document.getElementById('modal-recibo').classList.add('open');
  window._currentRecibo = r;
}

function imprimirRecibo() {
  const content = document.getElementById('recibo-preview').innerHTML;
  const win = window.open('','_blank','width=620,height=750');
  win.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Boleta de Pago</title>' +
    '<style>body{font-family:Arial,sans-serif;margin:20px;}</style></head>' +
    '<body>' + content + '<script>window.onload=()=>window.print()<\/script></body></html>');
  win.document.close();
}

function generarReciboPDF(personalId) {
  verRecibo(personalId);
  setTimeout(imprimirRecibo, 350);
}

function exportPlanillaExcel() {
  if (!_planillaData.length) { toast('Sin datos','Calculá la planilla primero','warn'); return; }
  const fmt2 = v => parseFloat(v||0).toFixed(2);
  const mes = _planillaMes;
  const rows = [['Empleado','Tipo','Sistema Pensión','Rol','Días','H.Extra','Tardanzas',
    'Sueldo Base','H.Extra S/','Asig.Fam','Bruto','Desc.Pensión','Desc.Comisión','Desc.Seguro',
    'NETO','EsSalud (E)','CTS (E)','Gratif. (E)','Costo Total (E)']];
  _planillaData.forEach(r => rows.push([
    r.nombre, r.tipo, r.sistPension, r.rol, r.diasTrab, r.hExtras.toFixed(1), r.tardanzas,
    fmt2(r.sueldoBase), fmt2(r.montoHExt), fmt2(r.asigFam), fmt2(r.bruto),
    fmt2(r.descPension), fmt2(r.descComision), fmt2(r.descSeguro),
    fmt2(r.neto), fmt2(r.aportEsSalud), fmt2(r.aportCTS), fmt2(r.aportGrat), fmt2(r.costoTotal)
  ]));
  // Totals row
  const tot = k => _planillaData.reduce((a,r)=>a+r[k],0).toFixed(2);
  rows.push(['TOTALES','','','','','','','',
    '','','',tot('bruto'),tot('descPension'),tot('descComision'),tot('descSeguro'),
    tot('neto'),tot('aportEsSalud'),tot('aportCTS'),tot('aportGrat'),tot('costoTotal')]);
  exportToCSV(rows, 'planilla_' + mes + '_' + _planillaPeriodo);
  toast('📥 Excel exportado', _planillaData.length + ' empleados · planilla ' + mes);
}

function generarPlanillaPDF() {
  if (!_planillaData.length) { toast('Sin datos','Calculá la planilla primero','warn'); return; }
  const fmt2 = v => parseFloat(v||0).toFixed(2);
  const mesLabel = new Date(_planillaMes+'-02').toLocaleDateString('es-PE',{year:'numeric',month:'long'});
  const periodoLabel = { mensual:'Mensual', quincenal:'Quincenal', semanal:'Semanal' }[_planillaPeriodo];
  const empresa = document.getElementById('cfg-empresa')?.value || 'NorConstructores S.A.C.';

  if (!window.jspdf) { toast('jsPDF no disponible','','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
  const W = 297;

  doc.setFillColor(13,15,18); doc.rect(0,0,W,30,'F');
  doc.setFontSize(16); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text(empresa.toUpperCase() + ' — PLANILLA ' + periodoLabel.toUpperCase(), W/2, 13, {align:'center'});
  doc.setFontSize(10); doc.setTextColor(200,210,220); doc.setFont('helvetica','normal');
  doc.text(mesLabel.toUpperCase() + ' · ' + _planillaData.length + ' empleados', W/2, 23, {align:'center'});

  if (doc.autoTable) {
    doc.autoTable({
      startY: 34,
      head:[['Empleado','Tipo/AFP','Días','H.Ext','Bruto S/','Descuentos','NETO S/','Costo Emp.']],
      body: _planillaData.map(r=>[
        r.nombre, r.tipo+'\n'+r.sistPension, r.diasTrab, r.hExtras.toFixed(1),
        fmt2(r.bruto), fmt2(r.totalDesc), fmt2(r.neto), fmt2(r.costoTotal)
      ]),
      foot:[['TOTALES','','','',
        fmt2(_planillaData.reduce((a,r)=>a+r.bruto,0)),
        fmt2(_planillaData.reduce((a,r)=>a+r.totalDesc,0)),
        fmt2(_planillaData.reduce((a,r)=>a+r.neto,0)),
        fmt2(_planillaData.reduce((a,r)=>a+r.costoTotal,0))
      ]],
      theme:'grid',
      headStyles:{fillColor:[30,35,45],textColor:[245,166,35],fontStyle:'bold',fontSize:8},
      bodyStyles:{fillColor:[20,25,32],textColor:[200,210,220],fontSize:8},
      footStyles:{fillColor:[40,50,30],textColor:[34,197,94],fontStyle:'bold',fontSize:9},
      alternateRowStyles:{fillColor:[25,30,38]},
      columnStyles:{4:{halign:'right'},5:{halign:'right'},6:{halign:'right',fontStyle:'bold',textColor:[34,197,94]},7:{halign:'right'}},
      margin:{left:8,right:8}
    });
  }
  doc.setFontSize(7); doc.setTextColor(100,116,139);
  doc.text('NorConstructores — Generado: ' + new Date().toLocaleDateString('es-PE'), W/2, 200, {align:'center'});
  doc.save('planilla_' + _planillaMes + '_' + _planillaPeriodo + '.pdf');
  toast('📄 PDF generado', mesLabel + ' · ' + periodoLabel);
}



// =====================================================================
// ==================== CONTRATOS & ACTAS ==============================
// =====================================================================
let _contratosHistorial = JSON.parse(localStorage.getItem('bc_contratos_v1') || '[]');

const CONTRATOS_CONFIG = {
  obra: {
    title: 'Contrato de Obra',
    fields: [
      { id:'c-cliente', label:'Nombre del Cliente *', type:'text', placeholder:'Empresa o persona natural' },
      { id:'c-cliente-dni', label:'DNI/RUC Cliente *', type:'text', placeholder:'20123456789' },
      { id:'c-proyecto', label:'Proyecto', type:'select-proyecto' },
      { id:'c-descripcion', label:'Descripción de la obra *', type:'textarea', placeholder:'Descripción detallada de los trabajos...' },
      { id:'c-monto', label:'Monto total S/ *', type:'number', placeholder:'0.00' },
      { id:'c-anticipo', label:'Anticipo S/ (opcional)', type:'number', placeholder:'0.00' },
      { id:'c-plazo', label:'Plazo de ejecución (días) *', type:'number', placeholder:'90' },
      { id:'c-fecha-inicio', label:'Fecha de inicio *', type:'date' },
      { id:'c-penalidad', label:'Penalidad por día de retraso (%)', type:'number', placeholder:'0.5' },
      { id:'c-garantia', label:'Garantía de obra (meses)', type:'number', placeholder:'12' },
    ]
  },
  personal: {
    title: 'Contrato de Personal',
    fields: [
      { id:'c-empleado', label:'Empleado', type:'select-personal' },
      { id:'c-cargo', label:'Cargo *', type:'text', placeholder:'Albañil, Supervisor, etc.' },
      { id:'c-sueldo', label:'Remuneración mensual S/ *', type:'number', placeholder:'0.00' },
      { id:'c-fecha-inicio', label:'Fecha de inicio *', type:'date' },
      { id:'c-fecha-fin', label:'Fecha de fin (si aplica)', type:'date' },
      { id:'c-tipo', label:'Tipo de contrato', type:'select', options:['A plazo indeterminado','A plazo fijo','Por obra o servicio','Eventual'] },
      { id:'c-horario', label:'Horario de trabajo', type:'text', placeholder:'Lun-Sab 7:00am-5:00pm' },
      { id:'c-proyecto', label:'Proyecto asignado', type:'select-proyecto' },
    ]
  },
  entrega: {
    title: 'Acta de Entrega de Obra',
    fields: [
      { id:'c-cliente', label:'Nombre del Cliente *', type:'text', placeholder:'Nombre completo' },
      { id:'c-proyecto', label:'Proyecto *', type:'select-proyecto' },
      { id:'c-descripcion', label:'Descripción de trabajos entregados *', type:'textarea', placeholder:'Descripción de los trabajos realizados...' },
      { id:'c-monto', label:'Monto total del contrato S/', type:'number', placeholder:'0.00' },
      { id:'c-observaciones', label:'Observaciones / Pendientes', type:'textarea', placeholder:'Detallar si hay pendientes...' },
      { id:'c-fecha-inicio', label:'Fecha de entrega *', type:'date' },
      { id:'c-garantia', label:'Período de garantía (meses)', type:'number', placeholder:'12' },
    ]
  },
  subcontrato: {
    title: 'Subcontrato',
    fields: [
      { id:'c-cliente', label:'Razón social subcontratista *', type:'text', placeholder:'Empresa o persona' },
      { id:'c-cliente-dni', label:'RUC subcontratista *', type:'text', placeholder:'20123456789' },
      { id:'c-descripcion', label:'Trabajos a subcontratar *', type:'textarea', placeholder:'Descripción detallada...' },
      { id:'c-proyecto', label:'Proyecto', type:'select-proyecto' },
      { id:'c-monto', label:'Monto S/ *', type:'number', placeholder:'0.00' },
      { id:'c-plazo', label:'Plazo (días) *', type:'number', placeholder:'30' },
      { id:'c-fecha-inicio', label:'Fecha inicio *', type:'date' },
    ]
  },
  adicional: {
    title: 'Acta de Adicional de Obra',
    fields: [
      { id:'c-cliente', label:'Cliente *', type:'text', placeholder:'Nombre del cliente' },
      { id:'c-proyecto', label:'Proyecto *', type:'select-proyecto' },
      { id:'c-descripcion', label:'Descripción de trabajos adicionales *', type:'textarea', placeholder:'Detallar los trabajos adicionales...' },
      { id:'c-monto', label:'Monto adicional S/ *', type:'number', placeholder:'0.00' },
      { id:'c-plazo', label:'Días adicionales al plazo', type:'number', placeholder:'0' },
      { id:'c-fecha-inicio', label:'Fecha *', type:'date' },
    ]
  },
  finiquito: {
    title: 'Finiquito Laboral',
    fields: [
      { id:'c-empleado', label:'Empleado *', type:'select-personal' },
      { id:'c-cargo', label:'Cargo', type:'text', placeholder:'Cargo desempeñado' },
      { id:'c-fecha-inicio', label:'Fecha de ingreso *', type:'date' },
      { id:'c-fecha-fin', label:'Fecha de cese *', type:'date' },
      { id:'c-motivo', label:'Motivo del cese', type:'select', options:['Renuncia voluntaria','Vencimiento de contrato','Mutuo acuerdo','Despido justificado','Fallecimiento'] },
      { id:'c-sueldo', label:'Última remuneración S/ *', type:'number', placeholder:'0.00' },
      { id:'c-cts-acumulada', label:'CTS acumulada S/', type:'number', placeholder:'0.00' },
      { id:'c-vacaciones', label:'Vacaciones pendientes (días)', type:'number', placeholder:'0' },
    ]
  }
};

function abrirGeneradorContrato(tipo) {
  document.getElementById('contrato-tipo').value = tipo;
  const cfg = CONTRATOS_CONFIG[tipo];
  document.getElementById('contrato-modal-title').textContent = cfg.title;

  // Build form fields
  let html = '<div style="display:flex;flex-direction:column;gap:14px;">';
  cfg.fields.forEach(f => {
    html += '<div class="form-group"><label class="form-label">' + f.label + '</label>';
    if (f.type === 'text' || f.type === 'number' || f.type === 'date') {
      html += `<input type="${f.type}" class="form-input" id="${f.id}" placeholder="${f.placeholder||''}" ${f.type==='date'?'value="'+new Date().toISOString().slice(0,10)+'"':''}>`;
    } else if (f.type === 'textarea') {
      html += `<textarea class="form-input" id="${f.id}" rows="3" placeholder="${f.placeholder||''}" style="resize:vertical;"></textarea>`;
    } else if (f.type === 'select') {
      html += `<select class="form-input" id="${f.id}">${f.options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
    } else if (f.type === 'select-proyecto') {
      html += `<select class="form-input" id="${f.id}"><option value="">— Sin proyecto —</option>${db.proyectos.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('')}</select>`;
    } else if (f.type === 'select-personal') {
      html += `<select class="form-input" id="${f.id}" onchange="autoFillPersonal('${f.id}')"><option value="">— Seleccioná —</option>${db.personal.map(p=>`<option value="${p.id}">${p.nombre}</option>`).join('')}</select>`;
    }
    html += '</div>';
  });
  html += '</div>';
  document.getElementById('contrato-form-fields').innerHTML = html;
  document.getElementById('modal-nuevo-contrato').classList.add('open');
}

function autoFillPersonal(selId) {
  const id = document.getElementById(selId).value;
  const p = db.personal.find(x => x.id === id);
  if (!p) return;
  const cargoEl = document.getElementById('c-cargo');
  const sueldoEl = document.getElementById('c-sueldo');
  const tipoEl = document.getElementById('c-tipo');
  const proyEl = document.getElementById('c-proyecto');
  const fIniEl = document.getElementById('c-fecha-inicio');
  const fFinEl = document.getElementById('c-fecha-fin');
  if (cargoEl) cargoEl.value = p.rol || p.cargo || '';
  if (sueldoEl) sueldoEl.value = p.sueldo || '';
  if (tipoEl && p.tipo) tipoEl.value = p.tipo;
  if (proyEl && p.proyecto) proyEl.value = p.proyecto;
  if (fIniEl && p.fechaInicio) fIniEl.value = p.fechaInicio;
  if (fFinEl && p.fechaFin) fFinEl.value = p.fechaFin;
}

function getContratoData(tipo) {
  const cfg = CONTRATOS_CONFIG[tipo];
  const data = { tipo };
  cfg.fields.forEach(f => {
    const el = document.getElementById(f.id);
    if (el) data[f.id.replace('c-','')] = el.value;
  });
  // Resolve names
  if (data.proyecto) {
    const p = db.proyectos.find(x => x.id === data.proyecto);
    data.proyectoNombre = p ? p.nombre : data.proyecto;
    data.proyectoCliente = p ? (p.cliente||'') : '';
  }
  if (data.empleado) {
    const p = db.personal.find(x => x.id === data.empleado);
    data.empleadoNombre = p ? p.nombre : data.empleado;
    data.empleadoDNI = p ? (p.dni||'') : '';
  }
  return data;
}

function previsualizarContrato() {
  generarContratoPDF(true);
}

function generarContratoPDF(preview = false) {
  const tipo = document.getElementById('contrato-tipo').value;
  const data = getContratoData(tipo);
  const cfg = CONTRATOS_CONFIG[tipo];

  if (!window.jspdf) { toast('jsPDF no disponible','','err'); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:'mm', format:'a4' });
  const W = 210, MARGIN = 20;
  const empresa = 'NorConstructores S.A.C.';
  const hoy = new Date().toLocaleDateString('es-PE', {year:'numeric',month:'long',day:'numeric'});
  let y = 20;

  // Header
  doc.setFillColor(13,15,18); doc.rect(0,0,W,35,'F');
  doc.setFontSize(16); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
  doc.text(empresa, W/2, 13, {align:'center'});
  doc.setFontSize(12); doc.setTextColor(220,225,235);
  doc.text(cfg.title.toUpperCase(), W/2, 22, {align:'center'});
  doc.setFontSize(9); doc.setTextColor(100,116,139); doc.setFont('helvetica','normal');
  doc.text('Lima, ' + hoy, W/2, 30, {align:'center'});
  y = 45;

  // Contract number
  const numContrato = 'DOC-' + Date.now().toString().slice(-6);
  doc.setFontSize(9); doc.setTextColor(100,116,139);
  doc.text('N° ' + numContrato, W-MARGIN, y, {align:'right'});
  y += 8;

  const writePara = (text, bold=false, color=[40,50,60]) => {
    doc.setFontSize(10); doc.setTextColor(...color);
    doc.setFont('helvetica', bold ? 'bold' : 'normal');
    const lines = doc.splitTextToSize(text, W - MARGIN*2);
    lines.forEach(line => {
      if (y > 268) { doc.addPage(); y = 20; }
      doc.text(line, MARGIN, y); y += 6;
    });
    y += 2;
  };

  const writeSection = (title) => {
    if (y > 255) { doc.addPage(); y = 20; }
    y += 4;
    doc.setFillColor(30,35,45); doc.rect(MARGIN, y-4, W-MARGIN*2, 8, 'F');
    doc.setFontSize(10); doc.setTextColor(245,166,35); doc.setFont('helvetica','bold');
    doc.text(title, MARGIN+3, y+1);
    y += 8;
  };

  // Generate content by type
  if (tipo === 'obra') {
    writePara(`Conste por el presente documento el CONTRATO DE OBRA que celebran de una parte ${empresa} (en adelante EL CONTRATISTA) y de la otra parte ${data.cliente||'_______________'}, identificado con DNI/RUC ${data['cliente-dni']||'_______________'} (en adelante EL COMITENTE).`);

    writeSection('PRIMERA: OBJETO DEL CONTRATO');
    writePara(`El Contratista se compromete a ejecutar ${data.proyectoNombre ? 'el proyecto "'+data.proyectoNombre+'"' : 'la obra'}, consistente en: ${data.descripcion||'_______________'}`);

    writeSection('SEGUNDA: PRECIO Y FORMA DE PAGO');
    const monto = parseFloat(data.monto||0).toLocaleString('es-PE', {minimumFractionDigits:2});
    const anticipo = parseFloat(data.anticipo||0).toLocaleString('es-PE', {minimumFractionDigits:2});
    writePara(`El precio total convenido es de S/ ${monto} (Soles).`);
    if (parseFloat(data.anticipo||0) > 0) writePara(`Se abonará un anticipo de S/ ${anticipo} a la firma del presente contrato.`);
    writePara(`El saldo restante se cancelará de acuerdo al avance de obra conforme a los hitos acordados.`);

    writeSection('TERCERA: PLAZO DE EJECUCIÓN');
    writePara(`La obra será ejecutada en un plazo de ${data.plazo||'___'} días calendario, iniciando el ${data['fecha-inicio']||'___/___/______'}. La penalidad por día de retraso es del ${data.penalidad||0.5}% del monto total del contrato.`);

    writeSection('CUARTA: GARANTÍA');
    writePara(`El Contratista otorga una garantía de ${data.garantia||12} meses contados desde la fecha de entrega de la obra.`);

  } else if (tipo === 'personal') {
    writePara(`Conste por el presente documento el CONTRATO DE TRABAJO ${(data.tipo||'').toUpperCase()} que celebran ${empresa} (en adelante EL EMPLEADOR) y ${data.empleadoNombre||'_______________'} (en adelante EL TRABAJADOR).`);

    writeSection('PRIMERA: CARGO Y FUNCIONES');
    writePara(`El Trabajador se desempeñará en el cargo de ${data.cargo||'_______________'} realizando las funciones propias del puesto.`);

    writeSection('SEGUNDA: REMUNERACIÓN');
    const sueldo = parseFloat(data.sueldo||0).toLocaleString('es-PE', {minimumFractionDigits:2});
    writePara(`El Empleador pagará al Trabajador una remuneración mensual de S/ ${sueldo}, sujeta a los descuentos de ley (ONP/AFP, EsSalud, etc.).`);

    writeSection('TERCERA: JORNADA LABORAL');
    writePara(`La jornada de trabajo es de ${data.horario||'Lunes a Sábado de 7:00am a 5:00pm'}, con un máximo de 48 horas semanales.`);

    writeSection('CUARTA: VIGENCIA');
    writePara(`El presente contrato rige desde el ${data['fecha-inicio']||'___/___/______'}${data['fecha-fin']?` hasta el ${data['fecha-fin']}`:', por tiempo indeterminado'}.`);

  } else if (tipo === 'entrega') {
    writePara(`En Lima, a ${hoy}, ${empresa} representada por su Gerente General, hace entrega formal de la obra al Sr./Sra. ${data.cliente||'_______________'}.`);

    writeSection('DESCRIPCIÓN DE TRABAJOS ENTREGADOS');
    writePara(data.descripcion || '_______________');

    writeSection('CONDICIONES DE ENTREGA');
    writePara(`Monto total del contrato: S/ ${parseFloat(data.monto||0).toLocaleString('es-PE', {minimumFractionDigits:2})}`);
    writePara(`Garantía de obra: ${data.garantia||12} meses a partir de la fecha de entrega.`);
    if (data.observaciones) { writeSection('OBSERVACIONES Y PENDIENTES'); writePara(data.observaciones); }

  } else if (tipo === 'subcontrato') {
    writePara(`Conste el presente SUBCONTRATO celebrado entre ${empresa} (CONTRATANTE) y ${data.cliente||'_______________'}, RUC ${data['cliente-dni']||'_______________'} (SUBCONTRATISTA).`);
    writeSection('TRABAJOS A EJECUTAR');
    writePara(data.descripcion || '_______________');
    writeSection('PRECIO Y PLAZO');
    writePara(`Monto: S/ ${parseFloat(data.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2})} · Plazo: ${data.plazo||'___'} días desde el ${data['fecha-inicio']||'___'}.`);

  } else if (tipo === 'adicional') {
    writePara(`ACTA DE ADICIONAL DE OBRA — Proyecto: ${data.proyectoNombre||'___'}`);
    writePara(`Cliente: ${data.cliente||'___'} · Fecha: ${data['fecha-inicio']||hoy}`);
    writeSection('TRABAJOS ADICIONALES');
    writePara(data.descripcion || '_______________');
    writeSection('MONTO Y PLAZO ADICIONAL');
    writePara(`Monto adicional: S/ ${parseFloat(data.monto||0).toLocaleString('es-PE',{minimumFractionDigits:2})} · Días adicionales al plazo: ${data.plazo||0}`);

  } else if (tipo === 'finiquito') {
    writePara(`LIQUIDACIÓN Y FINIQUITO LABORAL del Sr./Sra. ${data.empleadoNombre||'___'} con cargo ${data.cargo||'___'}.`);
    writeSection('DATOS DE LA RELACIÓN LABORAL');
    writePara(`Fecha de ingreso: ${data['fecha-inicio']||'___'} · Fecha de cese: ${data['fecha-fin']||'___'}`);
    writePara(`Motivo: ${data.motivo||'___'}`);
    writeSection('LIQUIDACIÓN');
    const sueldo = parseFloat(data.sueldo||0);
    const vacDias = parseFloat(data.vacaciones||0);
    const vacMonto = (sueldo / 30) * vacDias;
    const cts = parseFloat(data['cts-acumulada']||0);
    const total = vacMonto + cts;
    writePara(`Última remuneración: S/ ${sueldo.toLocaleString('es-PE',{minimumFractionDigits:2})}`);
    writePara(`Vacaciones pendientes (${vacDias} días): S/ ${vacMonto.toFixed(2)}`);
    writePara(`CTS acumulada: S/ ${cts.toFixed(2)}`);
    doc.setFontSize(11); doc.setTextColor(34,197,94); doc.setFont('helvetica','bold');
    writePara(`TOTAL A PAGAR: S/ ${total.toFixed(2)}`, true, [34,197,94]);
  }

  // Signature block
  y += 10;
  if (y > 240) { doc.addPage(); y = 20; }
  doc.setFontSize(10); doc.setTextColor(40,50,60); doc.setFont('helvetica','normal');
  const sigY = y + 20;
  doc.line(MARGIN, sigY, MARGIN+60, sigY);
  doc.line(W-MARGIN-60, sigY, W-MARGIN, sigY);
  doc.setFontSize(9); doc.setTextColor(100,116,139);
  doc.text(empresa, MARGIN+30, sigY+5, {align:'center'});
  doc.text(tipo === 'personal' ? (data.empleadoNombre||'El Trabajador') : (data.cliente||'El Cliente'), W-MARGIN-30, sigY+5, {align:'center'});
  doc.text('Firma y Sello', MARGIN+30, sigY+10, {align:'center'});
  doc.text('Firma', W-MARGIN-30, sigY+10, {align:'center'});

  // Footer
  doc.setFontSize(7); doc.setTextColor(150,150,150);
  doc.text(`NorConstructores — ${cfg.title} — Generado ${hoy} — N° ${numContrato}`, W/2, 290, {align:'center'});

  // Save to history
  const histItem = { id: numContrato, tipo, titulo: cfg.title, fecha: new Date().toISOString().slice(0,10), ...data };
  _contratosHistorial.unshift(histItem);
  localStorage.setItem('bc_contratos_v1', JSON.stringify(_contratosHistorial.slice(0,50)));
  renderContratosHistorial();

  if (preview) {
    const pdfUrl = doc.output('bloburl');
    window.open(pdfUrl, '_blank');
  } else {
    doc.save(tipo + '_' + numContrato + '.pdf');
    toast('📄 ' + cfg.title + ' generado', 'N° ' + numContrato);
    closeModal('nuevo-contrato');
  }
}

function renderContratosHistorial() {
  const el = document.getElementById('contratos-historial');
  if (!el) return;
  const badge = document.getElementById('badge-contratos');
  if (badge) badge.textContent = _contratosHistorial.length;

  if (!_contratosHistorial.length) {
    el.innerHTML = '<div style="text-align:center;color:var(--muted);padding:32px;">Generá tu primer documento haciendo clic en uno de los tipos de arriba.</div>';
    return;
  }
  const tipoColor = { obra:'var(--accent)', personal:'var(--blue)', entrega:'var(--green)', subcontrato:'var(--purple)', adicional:'var(--red)', finiquito:'#06b6d4' };
  const tipoEmoji = { obra:'🏗️', personal:'👷', entrega:'✅', subcontrato:'🤝', adicional:'📝', finiquito:'📋' };
  el.innerHTML = `<div class="table-wrap"><table><thead><tr><th>N° Documento</th><th>Tipo</th><th>Partes</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody>
    ${_contratosHistorial.map(h => `<tr>
      <td><strong>${h.id}</strong></td>
      <td><span style="color:${tipoColor[h.tipo]||'var(--muted)'};">${tipoEmoji[h.tipo]||''} ${h.titulo}</span></td>
      <td style="font-size:12px;color:var(--muted2);">${h.cliente||h.empleadoNombre||'—'}${h.proyectoNombre?' · '+h.proyectoNombre:''}</td>
      <td>${h.fecha}</td>
      <td><button class="btn btn-danger btn-sm" onclick="eliminarContrato('${h.id}')">🗑️</button></td>
    </tr>`).join('')}
  </tbody></table></div>`;
}

function eliminarContrato(id) {
  if (!confirm('¿Eliminar este documento del historial?')) return;
  _contratosHistorial = _contratosHistorial.filter(h => h.id !== id);
  localStorage.setItem('bc_contratos_v1', JSON.stringify(_contratosHistorial));
  renderContratosHistorial();
}

// =====================================================================
// ==================== HOOKS NAV + INIT ===============================
// =====================================================================
const _origNavPlanContr = window.nav;
window.nav = function(page, el) {
  if (_origNavPlanContr) _origNavPlanContr(page, el);
  const extras = { planilla:'Planilla de Sueldos', contratos:'Contratos & Actas' };
  if (extras[page]) document.getElementById('page-title').textContent = extras[page];
  if (page === 'planilla') initPlanilla();
  if (page === 'contratos') renderContratosHistorial();
};

// Init on load
const _origLoadAllPlanContr = window.loadAllData;
window.loadAllData = async function() {
  if (_origLoadAllPlanContr) await _origLoadAllPlanContr();
  renderContratosHistorial();
};


// =====================================================================
// ==================== MODO CLARO / OSCURO ============================
// =====================================================================
function toggleTheme() {
  const isLight = document.body.classList.toggle('light-mode');
  localStorage.setItem('nc_theme', isLight ? 'light' : 'dark');
  updateThemeBtn(isLight);
  // Update meta theme-color for PWA
  const meta = document.querySelector('meta[name="theme-color"]');
  if (meta) meta.content = isLight ? '#f0f2f5' : '#0d0f12';
  toast(isLight ? '☀️ Modo claro activado' : '🌙 Modo oscuro activado', '', 'ok');
}

function updateThemeBtn(isLight) {
  const icon  = document.getElementById('theme-icon');
  const label = document.getElementById('theme-label');
  const btn   = document.getElementById('theme-toggle-btn');
  if (!icon || !label) return;
  if (isLight) {
    icon.textContent  = '☀️';
    label.textContent = 'Modo Oscuro';
    if (btn) { btn.style.color = 'var(--accent)'; btn.style.borderColor = 'rgba(245,166,35,0.3)'; }
  } else {
    icon.textContent  = '🌙';
    label.textContent = 'Modo Claro';
    if (btn) { btn.style.color = ''; btn.style.borderColor = ''; }
  }
}

function initTheme() {
  const saved = localStorage.getItem('nc_theme');
  const isLight = saved === 'light';
  if (isLight) document.body.classList.add('light-mode');
  updateThemeBtn(isLight);
}

// =====================================================================
// ==================== EXPORTAR TODO A EXCEL ==========================
// =====================================================================
async function exportarTodo() {
  if (typeof XLSX === 'undefined') { toast('Error', 'XLSX no disponible', 'err'); return; }
  toast('📥 Generando Excel...', 'Exportando todos los módulos', 'ok');
  showLoading(true);

  try {
    const wb = XLSX.utils.book_new();
    const fmt2 = v => parseFloat(v||0).toFixed(2);
    const hoy = new Date().toLocaleDateString('es-PE', {timeZone:'America/Lima'});

    // ── Hoja: PROYECTOS ─────────────────────────────────────────────
    if (db.proyectos.length > 0) {
      const rows = [
        ['PROYECTOS — NorConstructores — ' + hoy], [],
        ['Nombre','Cliente','Tipo','Estado','Presupuesto S/','Avance %','Inicio','Fin','Ubicación']
      ];
      db.proyectos.forEach(p => rows.push([
        p.nombre, p.cliente, p.tipo, p.estado,
        fmt2(p.presupuesto), p.avance||0, p.inicio||'', p.fin||'', p.ubicacion||''
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:30},{wch:20},{wch:15},{wch:12},{wch:15},{wch:10},{wch:12},{wch:12},{wch:20}];
      XLSX.utils.book_append_sheet(wb, ws, 'Proyectos');
    }

    // ── Hoja: PERSONAL ──────────────────────────────────────────────
    if (db.personal.length > 0) {
      const rows = [
        ['PERSONAL — NorConstructores — ' + hoy], [],
        ['Nombre','Rol / Cargo','Cuadrilla','Tipo','Sueldo S/','Teléfono','DNI','Estado']
      ];
      db.personal.forEach(p => rows.push([
        p.nombre, p.rol||p.cargo||'', p.cuadrilla||'', p.tipo||'',
        fmt2(p.sueldo), p.tel||p.telefono||'', p.dni||'', p.estado||'activo'
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:25},{wch:20},{wch:15},{wch:12},{wch:12},{wch:14},{wch:12},{wch:10}];
      XLSX.utils.book_append_sheet(wb, ws, 'Personal');
    }

    // ── Hoja: MAQUINARIA ────────────────────────────────────────────
    if (db.maquinaria.length > 0) {
      const rows = [
        ['MAQUINARIA — NorConstructores — ' + hoy], [],
        ['Nombre','Modelo','Matrícula','Estado','Tarifa S/h','Costo/hora','Próx. Mantenimiento']
      ];
      db.maquinaria.forEach(m => rows.push([
        m.nombre, m.modelo||'', m.matricula||'', m.estado||'',
        fmt2(m.tarifa), fmt2(m.costo_hora||m.costoHora), m.proximo_mantenimiento||''
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:25},{wch:20},{wch:14},{wch:12},{wch:12},{wch:12},{wch:20}];
      XLSX.utils.book_append_sheet(wb, ws, 'Maquinaria');
    }

    // ── Hoja: MATERIALES ────────────────────────────────────────────
    if (db.materiales.length > 0) {
      const rows = [
        ['MATERIALES — NorConstructores — ' + hoy], [],
        ['Nombre','Tipo','Cantidad','Proyecto','Responsable','Fecha']
      ];
      db.materiales.forEach(m => rows.push([
        m.nombre, m.tipo||'', m.cantidad||'', getProyectoNombre(m.proyecto_id||m.proyecto)||'',
        m.responsable||'', m.fecha ? new Date(m.fecha).toLocaleDateString('es-PE',{timeZone:'America/Lima'}) : ''
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:25},{wch:10},{wch:10},{wch:25},{wch:20},{wch:18}];
      XLSX.utils.book_append_sheet(wb, ws, 'Materiales');
    }

    // ── Hoja: PROVEEDORES ───────────────────────────────────────────
    if (db.proveedores.length > 0) {
      const rows = [
        ['PROVEEDORES — NorConstructores — ' + hoy], [],
        ['Nombre','RUC / RUT','Rubro','Teléfono','Email','Estado']
      ];
      db.proveedores.forEach(p => rows.push([
        p.nombre, p.rut||p.ruc||'', p.rubro||'',
        p.telefono||p.tel||'', p.email||'', p.estado||'activo'
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:28},{wch:14},{wch:18},{wch:14},{wch:25},{wch:10}];
      XLSX.utils.book_append_sheet(wb, ws, 'Proveedores');
    }

    // ── Hoja: FACTURAS ──────────────────────────────────────────────
    if (db.facturas.length > 0) {
      const rows = [
        ['FACTURAS — NorConstructores — ' + hoy], [],
        ['N° Factura','Cliente','Proyecto','Monto S/','Estado','Fecha Emisión','Fecha Venc.']
      ];
      db.facturas.forEach(f => rows.push([
        f.numero||f.nro||'', f.cliente||'', getProyectoNombre(f.proyecto_id||f.proyecto)||'',
        fmt2(f.monto||f.total), f.estado||'', f.fecha||'', f.vencimiento||''
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:14},{wch:25},{wch:25},{wch:14},{wch:12},{wch:14},{wch:14}];
      XLSX.utils.book_append_sheet(wb, ws, 'Facturas');
    }

    // ── Hoja: FLUJO DE CAJA ─────────────────────────────────────────
    const movs = (typeof _movimientos !== 'undefined') ? _movimientos : [];
    if (movs.length > 0) {
      const rows = [
        ['FLUJO DE CAJA — NorConstructores — ' + hoy], [],
        ['Fecha','Tipo','Categoría','Proyecto','Monto S/','Descripción','Referencia']
      ];
      movs.forEach(m => rows.push([
        m.fecha||'', m.tipo||'', m.categoria||'',
        getProyectoNombre(m.proyectoId)||'',
        fmt2(m.monto), m.descripcion||'', m.referencia||''
      ]));
      // Totals
      const totalIng = movs.filter(m=>m.tipo==='ingreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
      const totalEgr = movs.filter(m=>m.tipo==='egreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
      rows.push([]);
      rows.push(['','','','TOTAL INGRESOS', fmt2(totalIng)]);
      rows.push(['','','','TOTAL EGRESOS',  fmt2(totalEgr)]);
      rows.push(['','','','SALDO NETO',     fmt2(totalIng - totalEgr)]);
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:14},{wch:10},{wch:18},{wch:22},{wch:14},{wch:30},{wch:14}];
      XLSX.utils.book_append_sheet(wb, ws, 'Flujo de Caja');
    }

    // ── Hoja: PRESUPUESTOS ──────────────────────────────────────────
    if (db.presupuestos.length > 0) {
      const rows = [
        ['PRESUPUESTOS — NorConstructores — ' + hoy], [],
        ['Nombre','Proyecto','Cliente','Monto Total S/','Estado','Fecha']
      ];
      db.presupuestos.forEach(p => rows.push([
        p.nombre||'', getProyectoNombre(p.proyecto_id||p.proyecto)||'',
        p.cliente||'', fmt2(p.total||p.monto), p.estado||'', p.fecha||''
      ]));
      const ws = XLSX.utils.aoa_to_sheet(rows);
      ws['!cols'] = [{wch:28},{wch:25},{wch:20},{wch:16},{wch:12},{wch:14}];
      XLSX.utils.book_append_sheet(wb, ws, 'Presupuestos');
    }

    // ── Hoja: RESUMEN GENERAL ───────────────────────────────────────
    const movs2 = (typeof _movimientos !== 'undefined') ? _movimientos : [];
    const totalIng = movs2.filter(m=>m.tipo==='ingreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
    const totalEgr = movs2.filter(m=>m.tipo==='egreso').reduce((a,m)=>a+parseFloat(m.monto||0),0);
    const resumen = [
      ['RESUMEN EJECUTIVO — NorConstructores'],
      ['Generado:', hoy], [],
      ['MÓDULO', 'TOTAL REGISTROS', 'DATO CLAVE'],
      ['Proyectos',     db.proyectos.length,   'Activos: '+db.proyectos.filter(p=>p.estado!=='finalizado').length],
      ['Personal',      db.personal.length,    'En planilla: '+db.personal.filter(p=>p.tipo==='planilla').length],
      ['Maquinaria',    db.maquinaria.length,  'Activa: '+db.maquinaria.filter(m=>m.estado==='activo').length],
      ['Materiales',    db.materiales.length,  'Entradas: '+db.materiales.filter(m=>m.tipo==='ENTRADA').length],
      ['Proveedores',   db.proveedores.length, 'Activos: '+db.proveedores.filter(p=>p.estado==='activo').length],
      ['Facturas',      db.facturas.length,    ''],
      ['Presupuestos',  db.presupuestos.length,''],
      ['Movimientos Caja', movs2.length,       ''],
      [],
      ['FINANCIERO', '', ''],
      ['Total Ingresos',  '', 'S/ '+totalIng.toLocaleString('es-PE',{minimumFractionDigits:2})],
      ['Total Egresos',   '', 'S/ '+totalEgr.toLocaleString('es-PE',{minimumFractionDigits:2})],
      ['Saldo Neto',      '', 'S/ '+(totalIng-totalEgr).toLocaleString('es-PE',{minimumFractionDigits:2})],
    ];
    const wsRes = XLSX.utils.aoa_to_sheet(resumen);
    wsRes['!cols'] = [{wch:22},{wch:18},{wch:28}];
    XLSX.utils.book_append_sheet(wb, wsRes, 'Resumen');

    // ── Descargar ───────────────────────────────────────────────────
    const fecha = new Date().toLocaleDateString('sv-SE',{timeZone:'America/Lima'});
    XLSX.writeFile(wb, 'NorConstructores_Completo_' + fecha + '.xlsx');
    toast('✅ Excel generado', 'Todos los módulos exportados (' + wb.SheetNames.length + ' hojas)', 'ok');

  } catch(e) {
    toast('Error al exportar', e.message, 'err');
    console.error(e);
  } finally {
    showLoading(false);
  }
}


// =====================================================================
// ============= DETALLE PROVEEDOR — MODAL =============================
// =====================================================================
function verDetalleProveedor(provId) {
  const prov = db.proveedores.find(p => p.id === provId);
  if (!prov) return;

  const movimientos = (typeof _movimientos !== 'undefined') ? _movimientos : [];
  const anioActual  = new Date().getFullYear();
  const fmt2 = v => 'S/ ' + parseFloat(v||0).toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2});
  const catLabels = {
    cobro_cliente:'Cobro cliente', anticipo:'Anticipo', pago_proveedor:'Pago proveedor',
    planilla:'Planilla', maquinaria:'Maquinaria', materiales:'Materiales',
    gastos_generales:'Gastos generales', impuestos:'Impuestos', otro:'Otro'
  };

  // Palabras clave para match
  const palabras = (prov.nombre||'').toLowerCase().trim().split(/\s+/).filter(w=>w.length>2);
  const matchMov = (m) => {
    if (m.proveedorId && prov.id && m.proveedorId === prov.id) return true;
    const txt = ((m.descripcion||'') + ' ' + (m.referencia||'')).toLowerCase();
    return palabras.length > 0 && palabras.some(w => txt.includes(w));
  };

  // Todos los movimientos del proveedor
  const movsProv = movimientos.filter(m => matchMov(m))
    .sort((a,b) => new Date(b.fecha) - new Date(a.fecha));

  // KPIs
  const totalPagado  = movsProv.reduce((a,m) => a + parseFloat(m.monto||0), 0);
  const transacciones = movsProv.length;
  const promedio     = transacciones > 0 ? totalPagado / transacciones : 0;

  // Avatar e info
  const initials = (prov.nombre||'?').split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
  document.getElementById('dprov-avatar').textContent = initials;
  document.getElementById('dprov-nombre').textContent = prov.nombre;
  document.getElementById('dprov-sub').textContent    = (prov.rubro||'Sin rubro') + ' · ' + (prov.rut||prov.ruc||'Sin RUC') + ' · ' + (prov.telefono||prov.tel||'Sin teléfono');
  document.getElementById('dprov-total').textContent   = fmt2(totalPagado);
  document.getElementById('dprov-transac').textContent = transacciones;
  document.getElementById('dprov-promedio').textContent = fmt2(promedio);
  document.getElementById('dprov-anio').textContent    = anioActual;

  // Historial
  const tbody = document.getElementById('dprov-historial');
  if (movsProv.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px;font-size:13px;">Sin movimientos registrados para este proveedor.<br><span style="font-size:11px;color:var(--muted);">Vinculá movimientos en Flujo de Caja seleccionando el proveedor al registrar.</span></td></tr>';
  } else {
    const tipoColors = { ingreso:'var(--green)', egreso:'var(--red)' };
    tbody.innerHTML = movsProv.map(m => {
      const fecha = m.fecha ? new Date(m.fecha).toLocaleDateString('es-PE',{day:'2-digit',month:'2-digit',year:'numeric',timeZone:'America/Lima'}) : '—';
      const tipo  = m.tipo === 'egreso' ? '▼ Egreso' : '▲ Ingreso';
      const color = tipoColors[m.tipo] || 'var(--text)';
      const cat   = catLabels[m.categoria] || m.categoria || '—';
      const desc  = m.descripcion || m.referencia || '—';
      return `<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:9px 10px;font-size:12px;color:var(--muted2);">${fecha}</td>
        <td style="padding:9px 10px;"><span style="color:${color};font-weight:700;font-size:12px;">${tipo}</span></td>
        <td style="padding:9px 10px;"><span style="background:rgba(168,85,247,0.12);color:#a855f7;padding:2px 8px;border-radius:10px;font-size:11px;">${cat}</span></td>
        <td style="padding:9px 10px;font-size:12px;color:var(--muted2);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${desc}</td>
        <td style="padding:9px 10px;font-weight:700;text-align:right;color:${color};">${fmt2(m.monto)}</td>
      </tr>`;
    }).join('');
  }
  document.getElementById('dprov-historial-sub').textContent =
    transacciones > 0 ? transacciones + ' movimiento(s) · Total: ' + fmt2(totalPagado) : '';

  // Gráfico barras por mes
  const meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  const montosMes = Array(12).fill(0);
  movsProv.forEach(m => {
    const d = new Date(m.fecha);
    if (!isNaN(d) && d.getFullYear() === anioActual) {
      montosMes[d.getMonth()] += parseFloat(m.monto||0);
    }
  });

  const canvas = document.getElementById('dprov-chart');
  if (window._dprovChart) { window._dprovChart.destroy(); }
  const isLight = document.body.classList.contains('light-mode');
  const gridColor = isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.06)';
  const textColor = isLight ? '#475569' : '#64748b';
  window._dprovChart = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: meses,
      datasets: [{
        data: montosMes,
        backgroundColor: montosMes.map(v => v > 0 ? 'rgba(245,166,35,0.7)' : 'rgba(255,255,255,0.05)'),
        borderColor:     montosMes.map(v => v > 0 ? '#f5a623' : 'transparent'),
        borderWidth: 1,
        borderRadius: 6,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: true,
      plugins: { legend: { display: false }, tooltip: {
        callbacks: { label: ctx => ' S/ ' + parseFloat(ctx.raw||0).toLocaleString('es-PE',{minimumFractionDigits:2}) }
      }},
      scales: {
        x: { grid: { color: gridColor }, ticks: { color: textColor, font: { size: 11 } } },
        y: { grid: { color: gridColor }, ticks: { color: textColor, font: { size: 10 },
          callback: v => v >= 1000 ? 'S/'+Math.round(v/1000)+'k' : 'S/'+v } }
      }
    }
  });

  document.getElementById('modal-detalle-proveedor').classList.add('open');
}


// ═══════════════════════════════════════════════
// SISTEMA DE REGISTRO DE ACTIVIDAD
// ═══════════════════════════════════════════════
const ACTIVITY_KEY = 'bc_activity_log_v1';

function getActivityLog() {
  try { return JSON.parse(localStorage.getItem(ACTIVITY_KEY) || '[]'); } catch(e) { return []; }
}
function saveActivityLog(log) {
  if (log.length > 500) log = log.slice(log.length - 500);
  try { localStorage.setItem(ACTIVITY_KEY, JSON.stringify(log)); } catch(e){}
}
function registrarActividad(tipo, usuario, rol, detalle) {
  const log = getActivityLog();
  log.push({ id: Date.now(), tipo, usuario: usuario||'—', rol: rol||'—', detalle: detalle||'', fecha: new Date().toISOString() });
  saveActivityLog(log);
}

function abrirModalActividad() {
  const log = getActivityLog();
  // Poblar filtro usuarios
  const sel = document.getElementById('act-filtro-usuario');
  if (sel) {
    const us = [...new Set(log.map(e => e.usuario))].filter(Boolean).sort();
    sel.innerHTML = '<option value="">Todos los usuarios</option>' + us.map(u => `<option value="${u}">${u}</option>`).join('');
  }
  const selT = document.getElementById('act-filtro-tipo');
  if (selT) selT.value = '';
  renderModalActividad();
  // Abrir directamente con classList (sin depender de openModal)
  document.getElementById('modal-actividad').classList.add('open');
}

function renderModalActividad() {
  const lista = document.getElementById('act-lista');
  const total = document.getElementById('act-total');
  if (!lista) return;

  const filtU = (document.getElementById('act-filtro-usuario')?.value || '').toLowerCase();
  const filtT =  document.getElementById('act-filtro-tipo')?.value || '';

  let log = getActivityLog().slice().reverse();
  if (filtU) log = log.filter(e => (e.usuario||'').toLowerCase() === filtU);
  if (filtT) log = log.filter(e => e.tipo === filtT);

  if (total) total.textContent = log.length + (log.length === 1 ? ' evento' : ' eventos');

  if (!log.length) {
    lista.innerHTML = '<p style="color:var(--muted);text-align:center;padding:32px;font-size:13px;">Sin registros para este filtro.</p>';
    return;
  }

  const ICO = { login:'🟢', logout:'🔴', acceso_denegado:'⛔' };
  const COL = { login:'var(--green)', logout:'var(--red)', acceso_denegado:'#f97316' };
  const LAB = { login:'Ingreso', logout:'Cierre de sesión', acceso_denegado:'Acceso denegado' };

  lista.innerHTML = log.map(e => {
    const d  = new Date(e.fecha);
    const fs = d.toLocaleDateString('es-PE',{day:'2-digit',month:'short',year:'numeric'});
    const hs = d.toLocaleTimeString('es-PE',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
    const c  = COL[e.tipo] || 'var(--muted2)';
    return `<div style="display:flex;align-items:flex-start;gap:12px;background:var(--bg3);border:1px solid var(--border);border-left:3px solid ${c};border-radius:10px;padding:12px 14px;">
      <div style="font-size:20px;flex-shrink:0;">${ICO[e.tipo]||'•'}</div>
      <div style="flex:1;min-width:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-weight:700;font-size:13px;">${e.usuario} <span style="font-weight:400;color:var(--muted);font-size:11px;">· ${e.rol}</span></span>
          <span style="font-size:11px;color:var(--muted);white-space:nowrap;">${fs} ${hs}</span>
        </div>
        <div style="margin-top:5px;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
          <span style="font-size:11px;padding:2px 9px;border-radius:20px;background:${c}20;color:${c};font-weight:700;">${LAB[e.tipo]||e.tipo}</span>
          ${e.detalle ? `<span style="font-size:11px;color:var(--muted2);">${e.detalle}</span>` : ''}
        </div>
      </div>
    </div>`;
  }).join('');
}

function limpiarRegistroActividad() {
  if (!confirm('¿Borrar todo el historial de actividad?')) return;
  localStorage.removeItem(ACTIVITY_KEY);
  renderModalActividad();
  toast('Historial limpiado', 'Se eliminaron todos los registros', 'warn');
}
</script>
</body>
</html>
