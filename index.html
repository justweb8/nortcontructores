<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BuildCore â€” Sistema de GestiÃ³n</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0d0f12; --bg2:#13161b; --bg3:#1a1e26; --bg4:#20252f;
  --border:rgba(255,255,255,0.07); --border2:rgba(255,255,255,0.12);
  --accent:#f5a623; --accent2:#e8521a;
  --green:#22c55e; --red:#ef4444; --blue:#3b82f6; --purple:#a855f7;
  --text:#f1f5f9; --muted:#64748b; --muted2:#94a3b8;
  --sidebar-w:260px;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;}

/* ===== LOGIN ===== */
#login-screen{
  position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;
  z-index:999;
}
.login-bg{
  position:absolute;inset:0;
  background:radial-gradient(ellipse at 20% 50%,rgba(245,166,35,0.08) 0%,transparent 60%),
             radial-gradient(ellipse at 80% 20%,rgba(232,82,26,0.06) 0%,transparent 50%);
}
.login-grid{
  position:absolute;inset:0;opacity:0.03;
  background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);
  background-size:40px 40px;
}
.login-card{
  background:var(--bg2);border:1px solid var(--border2);border-radius:20px;
  padding:44px 40px;width:420px;position:relative;z-index:1;
  box-shadow:0 32px 80px rgba(0,0,0,0.6);
  animation:cardIn 0.5s cubic-bezier(.16,1,.3,1);
}
@keyframes cardIn{from{opacity:0;transform:translateY(24px) scale(0.97);}to{opacity:1;transform:none;}}
.login-logo{display:flex;align-items:center;gap:12px;margin-bottom:32px;justify-content:center;}
.login-logo-icon{
  width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent2));
  border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:22px;
  box-shadow:0 8px 24px rgba(245,166,35,0.3);
}
.login-logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:22px;}
.login-logo-text span{color:var(--accent);}
.login-subtitle{text-align:center;color:var(--muted);font-size:13px;margin-bottom:28px;}
.login-label{font-size:11px;font-weight:700;letter-spacing:1px;color:var(--muted2);text-transform:uppercase;margin-bottom:6px;display:block;}
.login-input{
  width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);
  padding:12px 14px;border-radius:10px;font-size:14px;font-family:'DM Sans',sans-serif;
  outline:none;transition:border-color 0.2s,box-shadow 0.2s;margin-bottom:14px;
}
.login-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,166,35,0.1);}
.login-input::placeholder{color:var(--muted);}
.login-btn{
  width:100%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;
  border:none;padding:13px;border-radius:10px;font-size:14px;font-weight:700;
  font-family:'Syne',sans-serif;cursor:pointer;transition:all 0.2s;margin-top:6px;
  letter-spacing:0.3px;
}
.login-btn:hover{transform:translateY(-1px);box-shadow:0 8px 24px rgba(245,166,35,0.3);}
.login-btn:active{transform:none;}
.login-error{
  background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);
  color:var(--red);padding:10px 14px;border-radius:8px;font-size:13px;
  margin-bottom:14px;display:none;
}
.login-hint{text-align:center;color:var(--muted);font-size:12px;margin-top:16px;}
.login-hint b{color:var(--muted2);}

/* ===== LAYOUT ===== */
#app{display:none;}
#app.visible{display:flex;}
.sidebar{
  width:var(--sidebar-w);background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;height:100vh;z-index:100;overflow-y:auto;
}
.sidebar-logo{padding:20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.logo-icon{width:36px;height:36px;background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:16px;}
.logo-text{font-family:'Syne',sans-serif;font-weight:800;font-size:17px;}
.logo-text span{color:var(--accent);}
.nav-section{padding:14px 10px 6px;}
.nav-label{font-size:10px;font-weight:700;letter-spacing:1.5px;color:var(--muted);text-transform:uppercase;padding:0 8px;margin-bottom:6px;}
.nav-item{
  display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:8px;
  cursor:pointer;color:var(--muted2);font-size:13px;font-weight:500;transition:all 0.15s;
  margin-bottom:2px;position:relative;
}
.nav-item:hover{background:var(--bg3);color:var(--text);}
.nav-item.active{background:rgba(245,166,35,0.12);color:var(--accent);}
.nav-item.active::before{content:'';position:absolute;left:0;top:50%;transform:translateY(-50%);width:3px;height:18px;background:var(--accent);border-radius:0 3px 3px 0;}
.nav-item svg{width:17px;height:17px;flex-shrink:0;}
.badge{margin-left:auto;background:var(--accent2);color:#fff;font-size:10px;font-weight:700;padding:2px 6px;border-radius:20px;}
.badge.green{background:rgba(34,197,94,0.2);color:var(--green);}
.sidebar-bottom{margin-top:auto;padding:14px 10px;border-top:1px solid var(--border);}
.user-card{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;cursor:pointer;transition:background 0.15s;}
.user-card:hover{background:var(--bg3);}
.avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0;}
.user-info .name{font-size:13px;font-weight:600;}
.user-info .role{font-size:11px;color:var(--muted);}
.logout-btn{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;cursor:pointer;color:var(--red);font-size:12px;font-weight:600;margin-top:6px;transition:background 0.15s;}
.logout-btn:hover{background:rgba(239,68,68,0.1);}

.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
.topbar{
  background:var(--bg2);border-bottom:1px solid var(--border);
  padding:0 24px;height:58px;display:flex;align-items:center;gap:14px;
  position:sticky;top:0;z-index:50;
}
.topbar-title{font-family:'Syne',sans-serif;font-weight:700;font-size:18px;flex:1;}
.btn{padding:8px 16px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all 0.15s;font-family:'DM Sans',sans-serif;}
.btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 16px rgba(245,166,35,0.3);}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border);}
.btn-ghost:hover{background:var(--bg3);color:var(--text);}
.btn-danger{background:rgba(239,68,68,0.15);color:var(--red);border:1px solid rgba(239,68,68,0.3);}
.btn-danger:hover{background:rgba(239,68,68,0.25);}
.btn-success{background:rgba(34,197,94,0.15);color:var(--green);border:1px solid rgba(34,197,94,0.3);}
.btn-success:hover{background:rgba(34,197,94,0.25);}
.btn-sm{padding:5px 12px;font-size:12px;}
.icon-btn{width:34px;height:34px;border-radius:8px;background:var(--bg3);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--muted2);transition:all 0.15s;}
.icon-btn:hover{color:var(--text);border-color:var(--accent);}
.content{padding:22px 24px;flex:1;}
.page{display:none;}
.page.active{display:block;}

/* CARDS */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:20px;}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.card-subtitle{font-size:12px;color:var(--muted);margin-top:2px;}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:border-color 0.2s;}
.stat-card:hover{border-color:rgba(245,166,35,0.3);}
.stat-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.stat-icon{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;}
.stat-icon.orange{background:rgba(245,166,35,0.15);}
.stat-icon.blue{background:rgba(59,130,246,0.15);}
.stat-icon.green{background:rgba(34,197,94,0.15);}
.stat-icon.red{background:rgba(239,68,68,0.15);}
.stat-change{font-size:11px;font-weight:700;padding:2px 7px;border-radius:20px;}
.stat-change.up{background:rgba(34,197,94,0.12);color:var(--green);}
.stat-change.down{background:rgba(239,68,68,0.12);color:var(--red);}
.stat-value{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;line-height:1;margin-bottom:4px;}
.stat-label{font-size:12px;color:var(--muted2);}

/* TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead th{text-align:left;padding:9px 12px;font-size:11px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:rgba(255,255,255,0.025);}
tbody td{padding:11px 12px;font-size:13px;vertical-align:middle;}
.td-name{font-weight:600;}
.td-sub{font-size:11px;color:var(--muted);margin-top:2px;}

/* STATUS */
.status-badge{display:inline-flex;align-items:center;gap:5px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;}
.status-badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.status-badge.activo{background:rgba(34,197,94,0.12);color:var(--green);}
.status-badge.progreso{background:rgba(59,130,246,0.12);color:var(--blue);}
.status-badge.pendiente{background:rgba(245,166,35,0.12);color:var(--accent);}
.status-badge.pausado{background:rgba(239,68,68,0.12);color:var(--red);}
.status-badge.finalizado{background:rgba(168,85,247,0.12);color:var(--purple);}
.status-badge.planilla{background:rgba(34,197,94,0.12);color:var(--green);}
.status-badge.contrato{background:rgba(59,130,246,0.12);color:var(--blue);}
.status-badge.jornal{background:rgba(245,166,35,0.12);color:var(--accent);}

/* PROGRESS */
.progress-bar{height:5px;background:var(--bg3);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(4px);padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;width:100%;max-width:580px;max-height:90vh;overflow-y:auto;padding:26px;animation:fadeUp 0.2s ease;}
.modal.modal-lg{max-width:780px;}
.modal.modal-xl{max-width:960px;}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px);}to{opacity:1;transform:none;}}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.modal-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;}
.modal-close{background:var(--bg3);border:1px solid var(--border);color:var(--muted2);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.15s;}
.modal-close:hover{background:rgba(239,68,68,0.15);color:var(--red);border-color:rgba(239,68,68,0.3);}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-group{margin-bottom:12px;}
.form-label{font-size:11px;font-weight:700;color:var(--muted2);margin-bottom:5px;display:block;text-transform:uppercase;letter-spacing:0.5px;}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:9px 12px;border-radius:8px;font-size:13px;font-family:'DM Sans',sans-serif;outline:none;transition:border-color 0.15s;}
.form-input:focus{border-color:var(--accent);}
.form-input::placeholder{color:var(--muted);}
select.form-input{cursor:pointer;}
textarea.form-input{resize:vertical;min-height:72px;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--green);border-radius:10px;padding:12px 16px;z-index:500;display:none;min-width:260px;animation:slideIn 0.3s ease;}
.toast.open{display:block;}
.toast.warn{border-left-color:var(--accent);}
.toast.err{border-left-color:var(--red);}
@keyframes slideIn{from{transform:translateX(60px);opacity:0;}to{transform:none;opacity:1;}}
.toast-title{font-weight:700;font-size:13px;margin-bottom:2px;}
.toast-msg{font-size:11px;color:var(--muted2);}

/* PERSON DETAIL */
.person-detail-header{
  display:flex;align-items:center;gap:18px;padding:20px;background:var(--bg3);
  border-radius:12px;margin-bottom:18px;border:1px solid var(--border);
}
.person-avatar{
  width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:22px;flex-shrink:0;
}
.person-detail-info h2{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;}
.person-detail-info p{font-size:13px;color:var(--muted2);margin-top:3px;}
.detail-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.detail-item{background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);}
.detail-item .d-label{font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.detail-item .d-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;}
.detail-item .d-sub{font-size:11px;color:var(--muted2);margin-top:2px;}
.hours-table{width:100%;border-collapse:collapse;font-size:13px;}
.hours-table th{text-align:left;padding:8px 10px;font-size:10px;font-weight:700;letter-spacing:0.8px;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
.hours-table td{padding:9px 10px;border-bottom:1px solid var(--border);}
.hours-table tr:last-child td{border-bottom:none;}

/* MACHINE DETAIL */
.machine-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}

/* SEARCH */
.search-bar{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:0 10px;height:34px;min-width:200px;}
.search-bar input{background:none;border:none;outline:none;color:var(--text);font-size:12px;font-family:'DM Sans',sans-serif;width:100%;}
.search-bar input::placeholder{color:var(--muted);}

/* TABS */
.tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin-bottom:16px;}
.tab{padding:8px 14px;font-size:13px;font-weight:500;color:var(--muted2);cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-1px;transition:all 0.15s;}
.tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.tab:hover:not(.active){color:var(--text);}

/* EMPTY STATE */
.empty-state{text-align:center;padding:48px 20px;color:var(--muted);}
.empty-state .icon{font-size:40px;margin-bottom:12px;}
.empty-state p{font-size:13px;}

/* SECTION HEADER */
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;}
.section-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;}
.section-sub{font-size:12px;color:var(--muted);margin-top:3px;}

/* PROJECT CARD */
.projects-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.project-card{
  background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;
  cursor:pointer;transition:all 0.2s;
}
.project-card:hover{border-color:rgba(245,166,35,0.4);transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.project-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;}
.project-type-badge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:6px;background:var(--bg3);color:var(--muted2);text-transform:uppercase;letter-spacing:0.5px;}
.project-card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:4px;}
.project-card-client{font-size:12px;color:var(--muted2);}
.project-card-meta{display:flex;align-items:center;justify-content:space-between;margin-top:14px;}
.project-progress-label{font-size:11px;color:var(--muted2);margin-bottom:5px;display:flex;justify-content:space-between;}

/* SCROLLBAR */
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px;}

/* MACHINE CARD */
.machine-card{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:18px;transition:all 0.2s;}
.machine-card:hover{border-color:rgba(59,130,246,0.4);}
.machines-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}

/* RENTAB COLOR */
.rentab-high{color:var(--green);font-weight:700;}
.rentab-mid{color:var(--accent);font-weight:700;}
.rentab-low{color:var(--red);font-weight:700;}

/* CONFIRM MODAL */
.confirm-modal{max-width:380px;}

@media(max-width:1200px){
  .projects-grid,.machines-grid{grid-template-columns:repeat(2,1fr);}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .detail-grid{grid-template-columns:repeat(2,1fr);}
  .machine-kpi-grid{grid-template-columns:repeat(2,1fr);}
}

/* ===== HAMBURGER ===== */
.hamburger{display:none;background:none;border:none;cursor:pointer;padding:6px;color:var(--text);flex-direction:column;gap:5px;flex-shrink:0;}
.hamburger span{display:block;width:22px;height:2px;background:var(--text);border-radius:2px;transition:all 0.3s;}
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:99;}
.sidebar-overlay.open{display:block;}

/* ===== RESPONSIVE TABLE CARDS ===== */
/* On mobile, tables become stacked cards */
@media(max-width:768px){
  .resp-table thead { display:none; }
  .resp-table tbody tr {
    display:block;
    background:var(--bg3);
    border:1px solid var(--border);
    border-radius:10px;
    margin-bottom:10px;
    padding:12px 14px;
  }
  .resp-table tbody td {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:5px 0;
    font-size:13px;
    border:none;
  }
  .resp-table tbody td::before {
    content: attr(data-label);
    font-size:10px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:0.5px;
    color:var(--muted);
    flex-shrink:0;
    margin-right:8px;
  }
  .resp-table tbody tr:last-child { border-bottom:1px solid var(--border); }
}

/* ===== TABLET ===== */
@media(max-width:1024px){
  :root{--sidebar-w:240px;}
  .main{margin-left:0 !important;}
  .sidebar{transform:translateX(-100%);transition:transform 0.3s cubic-bezier(.16,1,.3,1);z-index:200;}
  .sidebar.open{transform:translateX(0);}
  .hamburger{display:flex;}
  .topbar{padding:0 16px;}
  .content{padding:16px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);}
  .projects-grid{grid-template-columns:repeat(2,1fr);}
  .machines-grid{grid-template-columns:repeat(2,1fr);}
  .section-header{flex-wrap:wrap;gap:10px;}
  .section-header > div:first-child{flex:1;min-width:0;}
}

/* ===== MOBILE ===== */
@media(max-width:768px){
  :root{--sidebar-w:280px;}
  .content{padding:12px;}
  .topbar{padding:0 10px;height:52px;}
  .topbar-title{font-size:14px;}
  .search-bar.top-search{display:none;}

  .stats-grid{grid-template-columns:repeat(2,1fr);gap:10px;}
  .stat-card{padding:12px;}
  .stat-value{font-size:18px;}

  .projects-grid{grid-template-columns:1fr;}
  .machines-grid{grid-template-columns:1fr;}

  .section-header{flex-direction:column;align-items:flex-start;gap:8px;}
  .section-header > div:last-child{width:100%;display:flex;gap:6px;flex-wrap:wrap;}
  .section-header .btn{flex:1;font-size:11px;padding:7px 8px;text-align:center;}

  /* All table wrappers scroll horizontally */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}

  /* Cards padding */
  .card{padding:12px;}
  .card-header{flex-wrap:wrap;gap:8px;}

  /* Dashboard inline grids â†’ 1 col */
  .dash-two-col{display:grid !important;grid-template-columns:1fr !important;}

  /* Stat grids in subpages */
  .sub-stats-3{grid-template-columns:1fr !important;}
  .sub-stats-4{grid-template-columns:repeat(2,1fr) !important;}

  /* Charts side-by-side â†’ stack */
  .charts-two-col{display:grid !important;grid-template-columns:1fr !important;}

  /* Obras 2-col â†’ 1 col */
  .obras-grid{display:grid !important;grid-template-columns:1fr !important;}

  /* Modals */
  .modal-overlay{align-items:flex-end;padding:0;}
  .modal{
    border-radius:18px 18px 0 0;
    margin:0;width:100%;
    max-width:100%;
    max-height:88vh;
    overflow-y:auto;
    padding:20px 16px;
    animation:slideUp 0.3s cubic-bezier(.16,1,.3,1);
  }
  @keyframes slideUp{from{transform:translateY(100%);}to{transform:none;}}
  .modal.modal-lg,.modal.modal-xl{max-height:92vh;}
  .form-row{display:grid;grid-template-columns:1fr;gap:0;}

  /* Login */
  .login-card{width:calc(100vw - 24px);padding:24px 16px;}

  /* Detail grids */
  .detail-grid{grid-template-columns:1fr 1fr;}
  .machine-kpi-grid{grid-template-columns:1fr 1fr;}
  .person-detail-header{flex-direction:column;text-align:center;gap:12px;}

  /* Tabs scroll */
  .tabs{overflow-x:auto;flex-wrap:nowrap;-webkit-overflow-scrolling:touch;padding-bottom:2px;}
  .tab{white-space:nowrap;padding:7px 12px;font-size:12px;}

  /* Filter row */
  .filter-row{flex-wrap:wrap !important;gap:8px !important;}
  .filter-row .search-bar{flex:1;min-width:0;}
  .filter-row select{width:100% !important;}

  /* Toast bottom left on mobile */
  .toast{right:12px;left:12px;bottom:16px;min-width:0;}
}

@media(max-width:400px){
  .stats-grid{grid-template-columns:1fr;}
  .detail-grid{grid-template-columns:1fr;}
  .machine-kpi-grid{grid-template-columns:1fr;}
  .sub-stats-4{grid-template-columns:1fr !important;}
}
</style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<div id="login-screen">
  <div class="login-bg"></div>
  <div class="login-grid"></div>
  <div class="login-card">
    <div class="login-logo">
      <div class="login-logo-icon">ğŸ—ï¸</div>
      <div class="login-logo-text">Build<span>Core</span></div>
    </div>
    <p class="login-subtitle">Sistema de GestiÃ³n para Constructoras<br>IngresÃ¡ tus credenciales para continuar</p>
    <div id="login-error" class="login-error">âš ï¸ Usuario o contraseÃ±a incorrectos.</div>
    <label class="login-label">Usuario</label>
    <input type="text" class="login-input" id="login-user" placeholder="Ej: admin" autocomplete="username">
    <label class="login-label">ContraseÃ±a</label>
    <input type="password" class="login-input" id="login-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
    <button class="login-btn" onclick="doLogin()">INGRESAR AL SISTEMA</button>
    <p class="login-hint">Demo: usuario <b>admin</b> Â· contraseÃ±a <b>1234</b></p>
  </div>
</div>

<!-- ===== APP ===== -->
<div id="app">
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon">ğŸ—ï¸</div>
    <div class="logo-text">Build<span>Core</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Principal</div>
    <div class="nav-item active" onclick="nav('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </div>
    <div class="nav-item" onclick="nav('proyectos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 20h20M4 20V10l8-6 8 6v10"/><path d="M9 20v-5h6v5"/></svg>
      Proyectos
      <span class="badge green" id="badge-proyectos">0</span>
    </div>
    <div class="nav-item" onclick="nav('personal',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      Personal & Cuadrillas
      <span class="badge" id="badge-personal">0</span>
    </div>
    <div class="nav-item" onclick="nav('maquinaria',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2"/></svg>
      Maquinaria
      <span class="badge" id="badge-maquinaria">0</span>
    </div>
    <div class="nav-item" onclick="nav('obras',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
      Obras en Curso
      <span class="badge green" id="badge-obras">0</span>
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">GestiÃ³n</div>
    <div class="nav-item" onclick="nav('presupuestos',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      Presupuestos
      <span class="badge" id="badge-presupuestos">0</span>
    </div>
    <div class="nav-item" onclick="nav('materiales',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z"/></svg>
      Materiales
    </div>
    <div class="nav-item" onclick="nav('proveedores',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 3h18l-2 9H5L3 3z"/><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/></svg>
      Proveedores
    </div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Finanzas</div>
    <div class="nav-item" onclick="nav('facturacion',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
      FacturaciÃ³n
      <span class="badge" id="badge-facturas">3</span>
    </div>
    <div class="nav-item" onclick="nav('reportes',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      Reportes
    </div>
  </div>
  <div class="sidebar-bottom">
    <div class="user-card">
      <div class="avatar" id="sidebar-avatar">AD</div>
      <div class="user-info">
        <div class="name" id="sidebar-name">Administrador</div>
        <div class="role">Director de Obras</div>
      </div>
    </div>
    <div class="logout-btn" onclick="doLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9"/></svg>
      Cerrar SesiÃ³n
    </div>
  </div>
</aside>

<!-- MAIN -->
<main class="main">
  <header class="topbar">
    <button class="hamburger" id="hamburger-btn" onclick="toggleSidebar()" aria-label="MenÃº">
      <span></span><span></span><span></span>
    </button>
    <div class="topbar-title" id="page-title">Dashboard General</div>
    <div class="search-bar">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" placeholder="Buscar..." id="global-search" oninput="globalSearch(this.value)">
    </div>
    <div class="icon-btn" title="Notificaciones">
      <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg>
    </div>
  </header>

  <div class="content">

    <!-- ===== DASHBOARD ===== -->
    <div class="page active" id="page-dashboard">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon orange">ğŸ—ï¸</div><span class="stat-change up" id="kpi-p-change">0</span></div>
          <div class="stat-value" id="kpi-proyectos">0</div>
          <div class="stat-label">Proyectos Activos</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon blue">ğŸ’°</div></div>
          <div class="stat-value" id="kpi-presupuesto">$0</div>
          <div class="stat-label">Presupuesto Total</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon green">ğŸ‘·</div></div>
          <div class="stat-value" id="kpi-personal">0</div>
          <div class="stat-label">Personal en Planilla</div>
        </div>
        <div class="stat-card">
          <div class="stat-header"><div class="stat-icon red">ğŸšœ</div></div>
          <div class="stat-value" id="kpi-maquinas">0</div>
          <div class="stat-label">Equipos Activos</div>
        </div>
      </div>

      <!-- PROYECTOS RESUMEN -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">Resumen de Proyectos</div></div>
          <button class="btn btn-ghost btn-sm" onclick="nav('proyectos',null)">Ver todos â†’</button>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Proyecto</th><th>Cliente</th><th>Presupuesto</th><th>Avance</th><th>Estado</th></tr></thead>
            <tbody id="dash-projects-table"><tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">No hay proyectos aÃºn.</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- CHARTS ROW -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:16px;">
        <!-- LINE CHART: FacturaciÃ³n mensual -->
        <div class="card">
          <div class="card-header">
            <div><div class="card-title">FacturaciÃ³n vs Costos â€” 2025</div><div class="card-subtitle">Comparativa mensual en millones USD</div></div>
            <div style="display:flex;gap:14px;align-items:center;">
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--accent);border-radius:2px;"></div>Facturado</div>
              <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--blue);border-radius:2px;border-style:dashed;"></div>Costo</div>
            </div>
          </div>
          <canvas id="dash-line-chart" height="140" style="width:100%;"></canvas>
        </div>
        <!-- DONUT: Proyectos por tipo -->
        <div class="card">
          <div class="card-header"><div><div class="card-title">Proyectos por Tipo</div><div class="card-subtitle">DistribuciÃ³n de cartera</div></div></div>
          <div style="display:flex;flex-direction:column;align-items:center;padding:4px 0;">
            <canvas id="dash-donut-chart" width="160" height="160" style="max-width:160px;"></canvas>
            <div id="dash-donut-legend" style="width:100%;margin-top:14px;display:flex;flex-direction:column;gap:8px;"></div>
          </div>
        </div>
      </div>

      <!-- BOTTOM ROW -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Personal â€” Top Horas Mes</div></div>
          <div id="dash-personal-list" style="display:flex;flex-direction:column;gap:10px;">
            <p style="color:var(--muted);font-size:13px;">Sin datos aÃºn.</p>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Maquinaria â€” Rentabilidad</div></div>
          <div id="dash-maquinaria-list" style="display:flex;flex-direction:column;gap:10px;">
            <p style="color:var(--muted);font-size:13px;">Sin datos aÃºn.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PROYECTOS ===== -->
    <div class="page" id="page-proyectos">
      <div class="section-header">
        <div>
          <div class="section-title">GestiÃ³n de Proyectos</div>
          <div class="section-sub" id="proyectos-sub">0 proyectos en cartera</div>
        </div>
        <button class="btn btn-primary" onclick="openModal('proyecto')">ï¼‹ Nuevo Proyecto</button>
      </div>
      <div class="tabs">
        <div class="tab active" onclick="filterTab('proyectos','todos',this)">Todos</div>
        <div class="tab" onclick="filterTab('proyectos','activo',this)">Activos</div>
        <div class="tab" onclick="filterTab('proyectos','progreso',this)">En Curso</div>
        <div class="tab" onclick="filterTab('proyectos','pendiente',this)">Pendientes</div>
        <div class="tab" onclick="filterTab('proyectos','finalizado',this)">Finalizados</div>
      </div>
      <div class="projects-grid" id="projects-grid">
        <div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸ—ï¸</div><p>No hay proyectos.<br>HacÃ© clic en "Nuevo Proyecto" para comenzar.</p></div>
      </div>
    </div>

    <!-- ===== PERSONAL ===== -->
    <div class="page" id="page-personal">
      <div class="section-header">
        <div>
          <div class="section-title">Personal & Cuadrillas</div>
          <div class="section-sub" id="personal-sub">0 empleados registrados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportPersonalExcel()">ğŸ“¥ Exportar Excel</button>
          <button class="btn btn-primary" onclick="openModal('personal')">ï¼‹ Agregar Personal</button>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px;">
          <div class="search-bar" style="flex:1;max-width:300px;">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" placeholder="Buscar empleado..." oninput="filterPersonal(this.value)">
          </div>
          <select class="form-input" style="width:180px;height:34px;padding:0 10px;" onchange="filterPersonalStatus(this.value)">
            <option value="">Todos los tipos</option>
            <option value="planilla">En Planilla</option>
            <option value="contrato">Contrato</option>
            <option value="jornal">Jornalero</option>
          </select>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Empleado</th>
                <th>Rol / Cuadrilla</th>
                <th>Tipo</th>
                <th>Sueldo Base</th>
                <th>Horas Mes</th>
                <th>Proyecto</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="personal-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No hay personal registrado.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== MAQUINARIA ===== -->
    <div class="page" id="page-maquinaria">
      <div class="section-header">
        <div>
          <div class="section-title">Parque de Maquinaria</div>
          <div class="section-sub" id="maquinaria-sub">0 equipos registrados</div>
        </div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportMaquinariaExcel()">ğŸ“¥ Exportar Excel</button>
          <button class="btn btn-primary" onclick="openModal('maquina')">ï¼‹ Registrar Equipo</button>
        </div>
      </div>

      <!-- KPIs maquinaria -->
      <div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â±ï¸</div></div><div class="stat-value" id="maq-total-horas">0h</div><div class="stat-label">Horas Totales Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ’µ</div></div><div class="stat-value" id="maq-total-ingreso">$0</div><div class="stat-label">Ingresos Generados</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">ğŸ”§</div></div><div class="stat-value" id="maq-total-costo">$0</div><div class="stat-label">Costos Operativos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ“ˆ</div></div><div class="stat-value" id="maq-rentab-prom">0%</div><div class="stat-label">Rentabilidad Promedio</div></div>
      </div>

      <div class="machines-grid" id="machines-grid">
        <div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸšœ</div><p>No hay equipos registrados.</p></div>
      </div>
    </div>

    <!-- ===== OBRAS EN CURSO ===== -->
    <div class="page" id="page-obras">
      <div class="section-header">
        <div><div class="section-title">Obras en Curso</div><div class="section-sub">Actividad diaria en campo</div></div>
        <button class="btn btn-primary" onclick="openModal('parte')">ï¼‹ Registrar Parte Diario</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ—ï¸</div></div><div class="stat-value" id="ob-activas">0</div><div class="stat-label">Obras Activas</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ‘·</div></div><div class="stat-value" id="ob-obreros">0</div><div class="stat-label">Obreros en Campo Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">â±ï¸</div></div><div class="stat-value" id="ob-horas">0h</div><div class="stat-label">Horas Totales Hoy</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âš ï¸</div></div><div class="stat-value" id="ob-incidencias">2</div><div class="stat-label">Incidencias Abiertas</div></div>
      </div>
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:16px;">
        <div class="card">
          <div class="card-header"><div class="card-title">Partes Diarios â€” Hoy</div></div>
          <div class="table-wrap">
            <table>
              <thead><tr><th>Obra</th><th>Actividad</th><th>Cuadrilla</th><th>Obreros</th><th>Horas</th><th>Estado</th></tr></thead>
              <tbody id="obras-partes-table">
                <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px;">Sin partes registrados hoy. HacÃ© clic en "+ Registrar Parte Diario".</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title">Condiciones por Obra</div></div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â˜€ï¸ Torre Mirador</div><div style="font-size:12px;color:var(--green);">24Â°C Despejado âœ“</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">ğŸŒ§ï¸ Ruta 102</div><div style="font-size:12px;color:var(--accent);">18Â°C Lluvia âš ï¸</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â˜€ï¸ Hospital Norte</div><div style="font-size:12px;color:var(--green);">22Â°C Despejado âœ“</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â›… CC Sur</div><div style="font-size:12px;color:var(--muted2);">20Â°C Nublado</div></div>
            <div style="background:var(--bg3);border-radius:8px;padding:12px;display:flex;justify-content:space-between;align-items:center;"><div style="font-weight:600;font-size:13px;">â˜€ï¸ Planta LogÃ­stica</div><div style="font-size:12px;color:var(--green);">25Â°C Despejado âœ“</div></div>
          </div>
          <div style="margin-top:14px;padding:12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;">
            <div style="font-size:12px;font-weight:700;color:var(--red);margin-bottom:6px;">âš ï¸ INCIDENCIAS ABIERTAS</div>
            <div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">â€¢ Ruta 102: DesvÃ­o bloqueado por lluvia</div>
            <div style="font-size:12px;color:var(--muted2);">â€¢ CC Sur: Retraso entrega acero (2 dÃ­as)</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== PRESUPUESTOS ===== -->
    <div class="page" id="page-presupuestos">
      <div class="section-header">
        <div><div class="section-title">Presupuestos</div><div class="section-sub" id="pres-sub">GestiÃ³n de ofertas y cotizaciones</div></div>
        <button class="btn btn-primary" onclick="openModal('presupuesto')">ï¼‹ Nuevo Presupuesto</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">ğŸ“‹</div></div><div class="stat-value" id="pres-total">0</div><div class="stat-label">Total Presupuestos</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">âœ…</div></div><div class="stat-value" id="pres-aprobados">0</div><div class="stat-label">Aprobados</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â³</div></div><div class="stat-value" id="pres-revision">0</div><div class="stat-label">En RevisiÃ³n</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âŒ</div></div><div class="stat-value" id="pres-rechazados">0</div><div class="stat-label">Rechazados</div></div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Presupuesto</th><th>Cliente</th><th>Monto (S/)</th><th>Fecha EnvÃ­o</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="presupuestos-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay presupuestos registrados.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== MATERIALES ===== -->
    <div class="page" id="page-materiales">
      <div class="section-header">
        <div><div class="section-title">Control de Materiales</div><div class="section-sub">Inventario y movimientos</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportMaterialesExcel()">ğŸ“¥ Exportar</button>
          <button class="btn btn-primary" onclick="openModal('material')">ï¼‹ Registrar Movimiento</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;" id="mat-stock-grid">
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸ§±</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">48,200</div><div style="font-size:12px;color:var(--muted);">Ladrillos (u.)</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸ”©</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">84 ton</div><div style="font-size:12px;color:var(--muted);">Acero corrugado</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸª£</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">620 bolsas</div><div style="font-size:12px;color:var(--muted);">Cemento Portland</div></div></div>
        <div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸª¨</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;">320 mÂ³</div><div style="font-size:12px;color:var(--muted);">Arena / Granza</div></div></div>
        <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">âš¡</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--red);">12 rollos</div><div style="font-size:12px;color:var(--muted);">Cable elÃ©ct. âš ï¸ Stock bajo</div></div></div>
        <div style="background:var(--bg2);border:1px solid rgba(239,68,68,0.3);border-radius:12px;padding:14px;display:flex;align-items:center;gap:12px;"><div style="font-size:22px;">ğŸ”§</div><div><div style="font-family:'Syne',sans-serif;font-weight:700;font-size:18px;color:var(--red);">8 u.</div><div style="font-size:12px;color:var(--muted);">TuberÃ­as PVC âš ï¸ Stock bajo</div></div></div>
      </div>
      <div class="card">
        <div class="card-header"><div class="card-title">Movimientos Recientes</div></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Material</th><th>Tipo</th><th>Cantidad</th><th>Proyecto</th><th>Responsable</th><th>Fecha</th></tr></thead>
            <tbody id="materiales-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">Cargando movimientos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== PROVEEDORES ===== -->
    <div class="page" id="page-proveedores">
      <div class="section-header">
        <div><div class="section-title">Proveedores</div><div class="section-sub" id="prov-sub">GestiÃ³n de proveedores activos</div></div>
        <button class="btn btn-primary" onclick="openModal('proveedor')">ï¼‹ Nuevo Proveedor</button>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>Proveedor</th><th>Rubro</th><th>Contacto</th><th>Ãšltima Compra</th><th>Total AÃ±o</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="proveedores-table">
              <tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">Cargando proveedores...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== FACTURACIÃ“N ===== -->
    <div class="page" id="page-facturacion">
      <div class="section-header">
        <div><div class="section-title">FacturaciÃ³n</div><div class="section-sub">Control de facturas emitidas y cobros</div></div>
        <div style="display:flex;gap:10px;">
          <button class="btn btn-success btn-sm" onclick="exportFacturasExcel()">ğŸ“¥ Exportar</button>
          <button class="btn btn-primary" onclick="openModal('factura')">ï¼‹ Nueva Factura</button>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ’µ</div><span class="stat-change up">â–² 14%</span></div><div class="stat-value" id="fac-mes">S/ 0</div><div class="stat-label">Facturado en el Mes</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">â³</div></div><div class="stat-value" id="fac-pendiente">S/ 0</div><div class="stat-label">Pendiente de Cobro</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">âŒ</div></div><div class="stat-value" id="fac-vencido">S/ 0</div><div class="stat-label">Vencido (+30 dÃ­as)</div></div>
      </div>
      <div class="card">
        <div class="table-wrap">
          <table>
            <thead><tr><th>NÂ° Factura</th><th>Cliente</th><th>Proyecto</th><th>Monto</th><th>Fecha</th><th>Vence</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="facturas-table">
              <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">Cargando facturas...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ===== REPORTES ===== -->
    <div class="page" id="page-reportes">
      <div class="section-header">
        <div><div class="section-title">Reportes & AnalÃ­tica</div><div class="section-sub" id="rep-fecha">Datos actualizados</div></div>
        <button class="btn btn-success btn-sm" onclick="exportReporteExcel()">ğŸ“¥ Exportar Reporte</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:20px;">
        <div class="stat-card"><div class="stat-header"><div class="stat-icon orange">ğŸ“Š</div></div><div class="stat-value" id="rep-cartera">S/ 0</div><div class="stat-label">Cartera Total</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon blue">âœ…</div><span class="stat-change up">â–² 18%</span></div><div class="stat-value" id="rep-cumplimiento">0%</div><div class="stat-label">Tasa de Cumplimiento</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon green">ğŸ’¹</div></div><div class="stat-value" id="rep-margen">23.4%</div><div class="stat-label">Margen Promedio</div></div>
        <div class="stat-card"><div class="stat-header"><div class="stat-icon red">â±ï¸</div></div><div class="stat-value">+8 dÃ­as</div><div class="stat-label">DesvÃ­o Promedio Plazo</div></div>
      </div>
      <!-- CHARTS GRID EN REPORTES -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
        <!-- BAR CHART: Costos por rubro -->
        <div class="card">
          <div class="card-header"><div><div class="card-title">Costos por Rubro</div><div class="card-subtitle">Mes actual â€” miles S/</div></div></div>
          <canvas id="rep-bar-chart" height="200" style="width:100%;"></canvas>
        </div>
        <!-- HORIZONTAL BAR: Avance por proyecto -->
        <div class="card">
          <div class="card-header"><div><div class="card-title">Avance por Proyecto</div><div class="card-subtitle">% completado vs meta</div></div></div>
          <canvas id="rep-hbar-chart" height="200" style="width:100%;"></canvas>
        </div>
      </div>

      <!-- LINE CHART: EvoluciÃ³n anual -->
      <div class="card" style="margin-bottom:16px;">
        <div class="card-header">
          <div><div class="card-title">EvoluciÃ³n de FacturaciÃ³n â€” 2025</div><div class="card-subtitle">Facturado, cobrado y costo mensual en S/ M</div></div>
          <div style="display:flex;gap:14px;align-items:center;">
            <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--accent);border-radius:2px;"></div>Facturado</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--green);border-radius:2px;"></div>Cobrado</div>
            <div style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted2);"><div style="width:20px;height:2px;background:var(--red);border-radius:2px;border-style:dashed;"></div>Costo</div>
          </div>
        </div>
        <canvas id="rep-line-chart" height="130" style="width:100%;"></canvas>
      </div>

      <div class="card">
        <div class="card-header"><div class="card-title">Resumen Ejecutivo por Proyecto</div></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>Proyecto</th><th>Presupuesto</th><th>Ejecutado Est.</th><th>DesviaciÃ³n</th><th>Margen Est.</th><th>Avance FÃ­sico</th></tr></thead>
            <tbody id="reportes-table">
              <tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Cargando datos...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div><!-- /content -->
</main>
</div><!-- /app -->

<!-- ===== MODALES ===== -->

<!-- PROYECTO MODAL -->
<div class="modal-overlay" id="modal-proyecto">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-proyecto-title">Nuevo Proyecto</div>
      <button class="modal-close" onclick="closeModal('proyecto')">âœ•</button>
    </div>
    <input type="hidden" id="proyecto-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre del Proyecto *</label><input type="text" class="form-input" id="p-nombre" placeholder="Ej: Torre Central"></div>
      <div class="form-group"><label class="form-label">Tipo *</label>
        <select class="form-input" id="p-tipo">
          <option value="Residencial">Residencial</option>
          <option value="Comercial">Comercial</option>
          <option value="Industrial">Industrial</option>
          <option value="Infraestructura">Infraestructura</option>
          <option value="Institucional">Institucional</option>
          <option value="Vial">Vial</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="p-cliente" placeholder="Nombre del cliente"></div>
      <div class="form-group"><label class="form-label">Presupuesto (USD) *</label><input type="number" class="form-input" id="p-presupuesto" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha Inicio</label><input type="date" class="form-input" id="p-inicio"></div>
      <div class="form-group"><label class="form-label">Fecha Fin Est.</label><input type="date" class="form-input" id="p-fin"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">UbicaciÃ³n</label><input type="text" class="form-input" id="p-ubicacion" placeholder="DirecciÃ³n de la obra"></div>
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="p-estado">
          <option value="pendiente">Pendiente / Iniciando</option>
          <option value="activo">Activo</option>
          <option value="progreso">En Curso</option>
          <option value="finalizado">Finalizado</option>
          <option value="pausado">Pausado</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Avance FÃ­sico (%)</label><input type="number" class="form-input" id="p-avance" placeholder="0" min="0" max="100"></div>
    <div class="form-group"><label class="form-label">DescripciÃ³n</label><textarea class="form-input" id="p-descripcion" placeholder="DescripciÃ³n del proyecto..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveProyecto()">Guardar Proyecto</button>
      <button class="btn btn-ghost" onclick="closeModal('proyecto')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PERSONAL MODAL -->
<div class="modal-overlay" id="modal-personal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-personal-title">Agregar Personal</div>
      <button class="modal-close" onclick="closeModal('personal')">âœ•</button>
    </div>
    <input type="hidden" id="emp-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre Completo *</label><input type="text" class="form-input" id="emp-nombre" placeholder="Nombre y apellido"></div>
      <div class="form-group"><label class="form-label">CÃ©dula / DNI *</label><input type="text" class="form-input" id="emp-ci" placeholder="Ej: 1.234.567-8"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rol / Cargo *</label>
        <select class="form-input" id="emp-rol">
          <option>AlbaÃ±il</option><option>Jefe de Cuadrilla</option><option>Electricista</option>
          <option>Plomero</option><option>Operador de Maquinaria</option><option>Carpintero</option>
          <option>Soldador</option><option>Pintor</option><option>Capataz</option>
          <option>Arquitecto</option><option>Ingeniero Civil</option><option>Administrador</option><option>Otro</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Cuadrilla</label><input type="text" class="form-input" id="emp-cuadrilla" placeholder="Ej: A-01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Tipo de Contrato *</label>
        <select class="form-input" id="emp-tipo">
          <option value="planilla">En Planilla</option>
          <option value="contrato">Contrato</option>
          <option value="jornal">Jornalero</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Sueldo Base (S//mes)</label><input type="number" class="form-input" id="emp-sueldo" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas (mes)</label><input type="number" class="form-input" id="emp-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Proyecto Asignado</label>
        <select class="form-input" id="emp-proyecto"><option value="">Sin asignar</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input type="text" class="form-input" id="emp-tel" placeholder="Ej: 099 123 456"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="text" class="form-input" id="emp-email" placeholder="correo@ejemplo.com"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha de Contrato</label><input type="date" class="form-input" id="emp-fecha-contrato"></div>
      <div class="form-group"><label class="form-label">Fecha Fin de Contrato</label><input type="date" class="form-input" id="emp-fecha-fin"></div>
    </div>
    <div class="form-group"><label class="form-label">DirecciÃ³n</label><input type="text" class="form-input" id="emp-dir" placeholder="DirecciÃ³n del empleado"></div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="emp-obs" placeholder="Notas adicionales..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="savePersonal()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeModal('personal')">Cancelar</button>
    </div>
  </div>
</div>

<!-- PERSONAL DETAIL MODAL -->
<div class="modal-overlay" id="modal-personal-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">Ficha del Empleado</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-primary btn-sm" onclick="generarBoletaPDF()">ğŸ“„ Boleta PDF</button>
        <button class="btn btn-success btn-sm" onclick="exportPersonaExcel()">ğŸ“¥ Excel</button>
        <button class="btn btn-ghost btn-sm" id="btn-edit-emp" onclick="editPersonal()">âœï¸ Editar</button>
        <button class="modal-close" onclick="closeModal('personal-detail')">âœ•</button>
      </div>
    </div>
    <div id="personal-detail-content"></div>
  </div>
</div>

<!-- MAQUINA MODAL -->
<div class="modal-overlay" id="modal-maquina">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-maquina-title">Registrar Equipo</div>
      <button class="modal-close" onclick="closeModal('maquina')">âœ•</button>
    </div>
    <input type="hidden" id="maq-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre del Equipo *</label><input type="text" class="form-input" id="maq-nombre" placeholder="Ej: GrÃºa Torre #1"></div>
      <div class="form-group"><label class="form-label">Tipo</label>
        <select class="form-input" id="maq-tipo">
          <option>GrÃºa Torre</option><option>Retroexcavadora</option><option>Bulldozer</option>
          <option>CamiÃ³n Volquete</option><option>Hormigonera</option><option>Compactadora</option>
          <option>Martillo HidrÃ¡ulico</option><option>Cargador Frontal</option><option>Andamio Motorizado</option><option>Otro</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Modelo / Marca</label><input type="text" class="form-input" id="maq-modelo" placeholder="Ej: Caterpillar 320"></div>
      <div class="form-group"><label class="form-label">MatrÃ­cula / CÃ³digo</label><input type="text" class="form-input" id="maq-matricula" placeholder="Ej: CAT-001"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas (mes)</label><input type="number" class="form-input" id="maq-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Tarifa por Hora (S/)</label><input type="number" class="form-input" id="maq-tarifa" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Costo Operativo/Hora (S/)</label><input type="number" class="form-input" id="maq-costo-hora" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Proyecto Asignado</label>
        <select class="form-input" id="maq-proyecto"><option value="">Sin asignar</option></select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Estado</label>
        <select class="form-input" id="maq-estado">
          <option value="activo">Operativo</option>
          <option value="pausado">En Mantenimiento</option>
          <option value="pendiente">Reservado</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">PrÃ³ximo Mantenimiento</label><input type="date" class="form-input" id="maq-mantenim"></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="maq-obs" placeholder="Notas..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;">
      <button class="btn btn-primary" style="flex:1" onclick="saveMaquina()">Guardar</button>
      <button class="btn btn-ghost" onclick="closeModal('maquina')">Cancelar</button>
    </div>
  </div>
</div>

<!-- MAQUINA DETAIL MODAL -->
<div class="modal-overlay" id="modal-maquina-detail">
  <div class="modal modal-lg">
    <div class="modal-header">
      <div class="modal-title">Detalle del Equipo</div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-success btn-sm" onclick="exportMaquinaExcel()">ğŸ“¥ Excel</button>
        <button class="btn btn-ghost btn-sm" id="btn-edit-maq" onclick="editMaquina()">âœï¸ Editar</button>
        <button class="modal-close" onclick="closeModal('maquina-detail')">âœ•</button>
      </div>
    </div>
    <div id="maquina-detail-content"></div>
  </div>
</div>

<!-- PRESUPUESTO MODAL -->
<div class="modal-overlay" id="modal-presupuesto">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modal-pres-title">Nuevo Presupuesto</div><button class="modal-close" onclick="closeModal('presupuesto')">âœ•</button></div>
    <input type="hidden" id="pres-id">
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre / DescripciÃ³n *</label><input type="text" class="form-input" id="pres-nombre" placeholder="Ej: Residencial La CaÃ±ada"></div>
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="pres-cliente" placeholder="Nombre del cliente"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Monto (S/) *</label><input type="number" class="form-input" id="pres-monto" placeholder="0"></div>
      <div class="form-group"><label class="form-label">Fecha EnvÃ­o</label><input type="date" class="form-input" id="pres-fecha"></div>
    </div>
    <div class="form-group"><label class="form-label">Estado</label>
      <select class="form-input" id="pres-estado">
        <option value="revision">En RevisiÃ³n</option><option value="aprobado">Aprobado</option>
        <option value="negociacion">NegociaciÃ³n</option><option value="rechazado">Rechazado</option>
      </select>
    </div>
    <div class="form-group"><label class="form-label">Observaciones</label><textarea class="form-input" id="pres-obs" placeholder="Notas..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="savePresupuesto()">Guardar</button><button class="btn btn-ghost" onclick="closeModal('presupuesto')">Cancelar</button></div>
  </div>
</div>

<!-- FACTURA MODAL -->
<div class="modal-overlay" id="modal-factura">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Nueva Factura</div><button class="modal-close" onclick="closeModal('factura')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">NÂ° Factura *</label><input type="text" class="form-input" id="fac-numero" placeholder="Ej: #2025-0900"></div>
      <div class="form-group"><label class="form-label">Cliente *</label><input type="text" class="form-input" id="fac-cliente" placeholder="Nombre del cliente"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="fac-proyecto"><option value="">Sin asignar</option></select></div>
      <div class="form-group"><label class="form-label">Monto (S/) *</label><input type="number" class="form-input" id="fac-monto" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Fecha EmisiÃ³n</label><input type="date" class="form-input" id="fac-fecha"></div>
      <div class="form-group"><label class="form-label">Fecha Vencimiento</label><input type="date" class="form-input" id="fac-vence"></div>
    </div>
    <div class="form-group"><label class="form-label">Estado</label>
      <select class="form-input" id="fac-estado"><option value="pendiente">Pendiente</option><option value="activo">Cobrada</option><option value="pausado">Vencida</option></select>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveFactura()">Guardar Factura</button><button class="btn btn-ghost" onclick="closeModal('factura')">Cancelar</button></div>
  </div>
</div>

<!-- PROVEEDOR MODAL -->
<div class="modal-overlay" id="modal-proveedor">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Nuevo Proveedor</div><button class="modal-close" onclick="closeModal('proveedor')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Nombre *</label><input type="text" class="form-input" id="prov-nombre" placeholder="Nombre de la empresa"></div>
      <div class="form-group"><label class="form-label">RUT / RUC</label><input type="text" class="form-input" id="prov-rut" placeholder="Ej: 21234567891"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Rubro</label><input type="text" class="form-input" id="prov-rubro" placeholder="Ej: HormigÃ³n Pronto"></div>
      <div class="form-group"><label class="form-label">TelÃ©fono</label><input type="text" class="form-input" id="prov-tel" placeholder="Ej: 098 123 456"></div>
    </div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveProveedor()">Guardar</button><button class="btn btn-ghost" onclick="closeModal('proveedor')">Cancelar</button></div>
  </div>
</div>

<!-- MATERIAL MODAL -->
<div class="modal-overlay" id="modal-material">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Registrar Movimiento de Material</div><button class="modal-close" onclick="closeModal('material')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Material *</label><input type="text" class="form-input" id="mat-nombre" placeholder="Ej: Cemento Portland"></div>
      <div class="form-group"><label class="form-label">Tipo</label><select class="form-input" id="mat-tipo"><option value="ENTRADA">ENTRADA</option><option value="SALIDA">SALIDA</option></select></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Cantidad</label><input type="text" class="form-input" id="mat-cantidad" placeholder="Ej: 200 bolsas"></div>
      <div class="form-group"><label class="form-label">Proyecto</label><select class="form-input" id="mat-proyecto"><option value="">Sin asignar</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Responsable</label><input type="text" class="form-input" id="mat-resp" placeholder="Nombre del responsable"></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveMaterial()">Registrar</button><button class="btn btn-ghost" onclick="closeModal('material')">Cancelar</button></div>
  </div>
</div>

<!-- PARTE DIARIO MODAL -->
<div class="modal-overlay" id="modal-parte">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Registrar Parte Diario</div><button class="modal-close" onclick="closeModal('parte')">âœ•</button></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Obra / Proyecto</label><select class="form-input" id="parte-proyecto"><option value="">Seleccionar...</option></select></div>
      <div class="form-group"><label class="form-label">Cuadrilla</label><input type="text" class="form-input" id="parte-cuadrilla" placeholder="Ej: A-01"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Actividad Realizada</label><input type="text" class="form-input" id="parte-actividad" placeholder="Ej: Hormigonado piso 8"></div>
      <div class="form-group"><label class="form-label">NÂ° Obreros</label><input type="number" class="form-input" id="parte-obreros" placeholder="0"></div>
    </div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Horas Trabajadas</label><input type="number" class="form-input" id="parte-horas" placeholder="0"></div>
      <div class="form-group"><label class="form-label">CondiciÃ³n ClimÃ¡tica</label><select class="form-input" id="parte-clima"><option>Despejado</option><option>Nublado</option><option>Lluvia</option><option>Viento fuerte</option></select></div>
    </div>
    <div class="form-group"><label class="form-label">Observaciones / Incidencias</label><textarea class="form-input" id="parte-obs" placeholder="Anotar cualquier novedad..."></textarea></div>
    <div style="display:flex;gap:10px;margin-top:4px;"><button class="btn btn-primary" style="flex:1" onclick="saveParte()">Registrar Parte</button><button class="btn btn-ghost" onclick="closeModal('parte')">Cancelar</button></div>
  </div>
</div>

<!-- CONFIRM DELETE -->
<div class="modal-overlay" id="modal-confirm">
  <div class="modal confirm-modal">
    <div class="modal-header"><div class="modal-title">âš ï¸ Confirmar EliminaciÃ³n</div><button class="modal-close" onclick="closeModal('confirm')">âœ•</button></div>
    <p style="color:var(--muted2);font-size:14px;margin-bottom:20px;" id="confirm-msg">Â¿EstÃ¡s seguro de que querÃ©s eliminar este registro? Esta acciÃ³n no se puede deshacer.</p>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-danger" style="flex:1" id="confirm-ok">SÃ­, Eliminar</button>
      <button class="btn btn-ghost" onclick="closeModal('confirm')">Cancelar</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast">
  <div class="toast-title" id="toast-title"></div>
  <div class="toast-msg" id="toast-msg"></div>
</div>

<script>
// ===================== SUPABASE CONFIG =====================
const SB_URL = 'https://kvyaksujublfwbgkarnf.supabase.co';
const SB_KEY = 'sb_publishable_GZtUrvqdgtO_eh8BNR5C7g_QUtKBrD0';

async function sbFetch(path, opts = {}) {
  const res = await fetch(SB_URL + '/rest/v1/' + path, {
    headers: {
      'apikey': SB_KEY,
      'Authorization': 'Bearer ' + SB_KEY,
      'Content-Type': 'application/json',
      'Prefer': opts.prefer || 'return=representation',
      ...opts.headers
    },
    method: opts.method || 'GET',
    body: opts.body ? JSON.stringify(opts.body) : undefined
  });
  if (!res.ok) {
    const err = await res.text();
    throw new Error(err);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : [];
}

// ===================== DATA STORE =====================
let db = {
  proyectos: [],
  personal: [],
  maquinaria: [],
  presupuestos: [],
  facturas: [],
  proveedores: [],
  materiales: []
};
let currentPersonalId = null;
let currentMaquinaId = null;
let currentFilter = { proyectos: 'todos', personal: '', personalStatus: '' };

// ===================== AUTH =====================
const USERS = [{ user: 'admin', pass: '1234', name: 'Administrador', initials: 'AD' }];

function doLogin() {
  const u = document.getElementById('login-user').value.trim();
  const p = document.getElementById('login-pass').value.trim();
  const found = USERS.find(x => x.user === u && x.pass === p);
  if (!found) {
    document.getElementById('login-error').style.display = 'block';
    document.getElementById('login-pass').value = '';
    return;
  }
  document.getElementById('sidebar-name').textContent = found.name;
  document.getElementById('sidebar-avatar').textContent = found.initials;
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');
  showLoading(true);
  loadAllData().then(() => {
    showLoading(false);
    renderDashboard();
    setTimeout(initDashCharts, 120);
    setTimeout(() => { applyResponsiveClasses(); makeTablesResponsive(); }, 200);
    toast('Â¡Bienvenido, ' + found.name + '!', 'Datos cargados desde la base de datos');
    // Check contract expiries
    setTimeout(checkContractAlerts, 1500);
  }).catch(err => {
    showLoading(false);
    toast('Error de conexiÃ³n', 'VerificÃ¡ tu conexiÃ³n a internet', 'err');
    console.error(err);
  });
}

document.getElementById('login-pass').addEventListener('keydown', e => { if(e.key === 'Enter') doLogin(); });
document.getElementById('login-user').addEventListener('keydown', e => { if(e.key === 'Enter') document.getElementById('login-pass').focus(); });

function doLogout() {
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('app').classList.remove('visible');
  document.getElementById('login-user').value = '';
  document.getElementById('login-pass').value = '';
  document.getElementById('login-error').style.display = 'none';
  db = { proyectos:[], personal:[], maquinaria:[], presupuestos:[], facturas:[], proveedores:[], materiales:[] };
}

function showLoading(show) {
  let el = document.getElementById('loading-overlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loading-overlay';
    el.style.cssText = 'position:fixed;inset:0;background:rgba(13,15,18,0.85);z-index:998;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;';
    el.innerHTML = '<div style="width:44px;height:44px;border:3px solid rgba(245,166,35,0.2);border-top-color:#f5a623;border-radius:50%;animation:spin 0.8s linear infinite;"></div><div style="font-family:Syne,sans-serif;font-size:14px;color:#94a3b8;">Cargando datos...</div><style>@keyframes spin{to{transform:rotate(360deg);}}</style>';
    document.body.appendChild(el);
  }
  el.style.display = show ? 'flex' : 'none';
}

// ===================== LOAD ALL DATA FROM SUPABASE =====================
async function loadAllData() {
  const [proyectos, personal, maquinaria, presupuestos, facturas, proveedores, materiales] = await Promise.all([
    sbFetch('proyectos?order=created_at.desc'),
    sbFetch('personal?order=created_at.desc'),
    sbFetch('maquinaria?order=created_at.desc'),
    sbFetch('presupuestos?order=created_at.desc'),
    sbFetch('facturas?order=created_at.desc'),
    sbFetch('proveedores?order=created_at.desc'),
    sbFetch('materiales?order=created_at.desc&limit=50'),
  ]);

  // Map Supabase column names to app field names
  db.proyectos = proyectos.map(p => ({
    id: p.id, nombre: p.nombre, tipo: p.tipo, cliente: p.cliente,
    presupuesto: p.presupuesto, avance: p.avance, estado: p.estado,
    inicio: p.inicio, fin: p.fin, ubicacion: p.ubicacion, descripcion: p.descripcion
  }));

  db.personal = personal.map(e => ({
    id: e.id, nombre: e.nombre, ci: e.ci, rol: e.rol, cuadrilla: e.cuadrilla,
    tipo: e.tipo, sueldo: e.sueldo, horas: e.horas,
    proyecto: e.proyecto_id, tel: e.telefono, email: e.email, dir: e.direccion, obs: e.observaciones,
    fechaContrato: e.fecha_contrato, fechaFin: e.fecha_fin_contrato
  }));

  db.maquinaria = maquinaria.map(m => ({
    id: m.id, nombre: m.nombre, tipo: m.tipo, modelo: m.modelo, matricula: m.matricula,
    horas: m.horas, tarifa: m.tarifa, costoHora: m.costo_hora,
    proyecto: m.proyecto_id, estado: m.estado, mantenim: m.proximo_mantenimiento, obs: m.observaciones
  }));

  db.presupuestos = presupuestos.map(p => ({
    id: p.id, nombre: p.nombre, cliente: p.cliente, monto: p.monto,
    fecha: p.fecha, estado: p.estado, obs: p.observaciones
  }));

  db.facturas = facturas.map(f => ({
    id: f.id, numero: f.numero, cliente: f.cliente, proyecto: f.proyecto_id,
    monto: f.monto, fecha: f.fecha_emision, vence: f.fecha_vencimiento, estado: f.estado
  }));

  db.proveedores = proveedores.map(p => ({
    id: p.id, nombre: p.nombre, rut: p.rut, rubro: p.rubro, tel: p.telefono, estado: p.estado
  }));

  db.materiales = materiales.map(m => ({
    id: m.id, nombre: m.nombre, tipo: m.tipo, cantidad: m.cantidad,
    proyecto: m.proyecto_id, responsable: m.responsable, fecha: m.fecha
  }));

  refreshAll();
}

// ===================== RESPONSIVE HELPERS =====================
function makeTablesResponsive() {
  document.querySelectorAll('.table-wrap table').forEach(table => {
    table.classList.add('resp-table');
    const headers = [...table.querySelectorAll('thead th')].map(th => th.textContent.trim());
    table.querySelectorAll('tbody tr').forEach(tr => {
      [...tr.querySelectorAll('td')].forEach((td, i) => {
        if (headers[i]) td.setAttribute('data-label', headers[i]);
      });
    });
  });
}

// Auto-apply responsive classes to inline grids
function applyResponsiveClasses() {
  // Dashboard 2-col grids
  document.querySelectorAll('#page-dashboard > .content > [style*="grid-template-columns:2fr 1fr"], #page-dashboard [style*="grid-template-columns:2fr 1fr"]').forEach(el => el.classList.add('dash-two-col'));
  document.querySelectorAll('#page-dashboard [style*="grid-template-columns:1fr 1fr"]').forEach(el => el.classList.add('dash-two-col'));
  // Obras grid
  document.querySelectorAll('#page-obras [style*="grid-template-columns:2fr 1fr"]').forEach(el => el.classList.add('obras-grid'));
  // Reportes charts
  document.querySelectorAll('#page-reportes [style*="grid-template-columns:1fr 1fr"]').forEach(el => el.classList.add('charts-two-col'));
  // Sub stats
  document.querySelectorAll('#page-facturacion [style*="repeat(3"], #page-presupuestos [style*="repeat(3"]').forEach(el => el.classList.add('sub-stats-3'));
  document.querySelectorAll('#page-maquinaria [style*="repeat(4"], #page-presupuestos [style*="repeat(4"], #page-reportes [style*="repeat(4"], #page-obras [style*="repeat(4"]').forEach(el => el.classList.add('sub-stats-4'));
  // Filter rows
  document.querySelectorAll('.card > div[style*="display:flex"][style*="align-items:center"]').forEach(el => el.classList.add('filter-row'));
  // Topbar search
  document.querySelector('.topbar .search-bar')?.classList.add('top-search');
}

// ===================== SIDEBAR TOGGLE (MOBILE) =====================
function toggleSidebar() {
  const sidebar = document.querySelector('.sidebar');
  const overlay = document.getElementById('sidebar-overlay');
  sidebar.classList.toggle('open');
  overlay.classList.toggle('open');
}

function closeSidebarOnMobile() {
  if (window.innerWidth <= 1024) {
    document.querySelector('.sidebar').classList.remove('open');
    document.getElementById('sidebar-overlay').classList.remove('open');
  }
}

// ===================== NAVIGATION =====================
function nav(page, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  if (el) el.classList.add('active');
  const titles = { dashboard: 'Dashboard General', proyectos: 'GestiÃ³n de Proyectos', personal: 'Personal & Cuadrillas', maquinaria: 'Parque de Maquinaria', obras: 'Obras en Curso', presupuestos: 'Presupuestos', materiales: 'Control de Materiales', proveedores: 'Proveedores', facturacion: 'FacturaciÃ³n', reportes: 'Reportes & AnalÃ­tica' };
  document.getElementById('page-title').textContent = titles[page] || page;
  closeSidebarOnMobile();
  if (page === 'proyectos') renderProyectos();
  if (page === 'personal') renderPersonal();
  if (page === 'maquinaria') renderMaquinaria();
  if (page === 'dashboard') { renderDashboard(); setTimeout(initDashCharts, 60); }
  if (page === 'reportes') { renderReportes(); setTimeout(initReportesCharts, 60); }
  if (page === 'presupuestos') renderPresupuestos();
  if (page === 'obras') renderObras();
}

// ===================== REFRESH ALL =====================
function refreshAll() {
  updateBadges();
  renderDashboard();
  renderProyectos();
  renderPersonal();
  renderMaquinaria();
  renderPresupuestos();
  renderFacturas();
  renderProveedores();
  renderMateriales();
  setTimeout(makeTablesResponsive, 50);
}

function updateBadges() {
  document.getElementById('badge-proyectos').textContent = db.proyectos.length;
  document.getElementById('badge-personal').textContent = db.personal.length;
  document.getElementById('badge-maquinaria').textContent = db.maquinaria.length;
  document.getElementById('badge-presupuestos').textContent = db.presupuestos.length;
  const vencidas = db.facturas.filter(f=>f.estado==='pausado').length;
  if (vencidas > 0) document.getElementById('badge-facturas').textContent = vencidas;
}

function renderFacturas() {
  const tbody = document.getElementById('facturas-table');
  if (!tbody) return;
  // Update stats
  const totalMes = db.facturas.reduce((a,f) => a + Number(f.monto), 0);
  const pendiente = db.facturas.filter(f=>f.estado==='pendiente').reduce((a,f)=>a+Number(f.monto),0);
  const vencido = db.facturas.filter(f=>f.estado==='pausado').reduce((a,f)=>a+Number(f.monto),0);
  const meEl = document.getElementById('fac-mes');
  const penEl = document.getElementById('fac-pendiente');
  const venEl = document.getElementById('fac-vencido');
  if (meEl) meEl.textContent = fmtM(totalMes);
  if (penEl) penEl.textContent = fmtM(pendiente);
  if (venEl) venEl.textContent = fmtM(vencido);

  if (db.facturas.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No hay facturas. HacÃ© clic en "+ Nueva Factura".</td></tr>';
    return;
  }
  const estadoTxt = { pendiente:'Pendiente', activo:'Cobrada', pausado:'Vencida' };
  tbody.innerHTML = db.facturas.map(f => `
    <tr>
      <td><div class="td-name">${f.numero||'â€”'}</div></td>
      <td>${f.cliente}</td>
      <td>${getProyectoNombre(f.proyecto)||'â€”'}</td>
      <td><b>${fmt(f.monto)}</b></td>
      <td style="color:var(--muted2)">${f.fecha||'â€”'}</td>
      <td style="color:var(--muted2)">${f.vence||'â€”'}</td>
      <td><span class="status-badge ${f.estado||'pendiente'}">${estadoTxt[f.estado]||f.estado}</span></td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="toast('PDF','Generando PDF...')">ğŸ“„ PDF</button>
          <button class="btn btn-danger btn-sm" onclick="deleteFactura('${f.id}')">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`).join('');
}

async function deleteFactura(id) {
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar esta factura?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('facturas?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Factura eliminada','','err');
      await loadAllData(); renderFacturas();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

function renderProveedores() {
  const tbody = document.getElementById('proveedores-table');
  if (!tbody) return;
  if (db.proveedores.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:28px;">No hay proveedores. HacÃ© clic en "+ Nuevo Proveedor".</td></tr>';
    return;
  }
  tbody.innerHTML = db.proveedores.map(p => `
    <tr>
      <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.rut||'â€”'}</div></td>
      <td>${p.rubro||'â€”'}</td>
      <td>${p.tel||'â€”'}</td>
      <td>â€”</td>
      <td style="font-weight:700">$0</td>
      <td><span class="status-badge ${p.estado==='activo'?'activo':'pendiente'}">${p.estado==='activo'?'Activo':'Inactivo'}</span></td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-danger btn-sm" onclick="deleteProveedor('${p.id}')">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`).join('');
}

async function deleteProveedor(id) {
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar este proveedor?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('proveedores?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Proveedor eliminado','','err');
      await loadAllData(); renderProveedores();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

function renderMateriales() {
  const tbody = document.getElementById('materiales-table');
  if (!tbody) return;
  if (db.materiales.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay movimientos registrados.</td></tr>';
    return;
  }
  tbody.innerHTML = db.materiales.map(m => {
    const color = m.tipo === 'ENTRADA' ? 'var(--green)' : 'var(--red)';
    const fecha = m.fecha ? new Date(m.fecha).toLocaleString('es-UY',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'}) : 'â€”';
    return `<tr>
      <td><div class="td-name">${m.nombre}</div></td>
      <td><span style="color:${color};font-weight:700;font-size:12px;">${m.tipo||'â€”'}</span></td>
      <td>${m.cantidad||'â€”'}</td>
      <td>${getProyectoNombre(m.proyecto)||'â€”'}</td>
      <td>${m.responsable||'â€”'}</td>
      <td style="color:var(--muted)">${fecha}</td>
    </tr>`;
  }).join('');
}

// ===================== HELPERS =====================
function fmt(n) { return 'S/ ' + Number(n).toLocaleString('es-PE'); }
function fmtM(n) { return n >= 1000000 ? 'S/ ' + (n/1000000).toFixed(1) + 'M' : n >= 1000 ? 'S/ ' + (n/1000).toFixed(0) + 'k' : 'S/ ' + Number(n).toLocaleString('es-PE'); }
function statusLabel(s) {
  const m = { activo: ['activo','Activo'], progreso: ['progreso','En Curso'], pendiente: ['pendiente','Pendiente'], pausado: ['pausado','Pausado'], finalizado: ['finalizado','Finalizado'] };
  const v = m[s] || ['pendiente', s];
  return `<span class="status-badge ${v[0]}">${v[1]}</span>`;
}
function tipoLabel(t) {
  const m = { planilla: 'En Planilla', contrato: 'Contrato', jornal: 'Jornalero' };
  return `<span class="status-badge ${t}">${m[t]||t}</span>`;
}
function getProyectoNombre(id) {
  const p = db.proyectos.find(x => x.id === id);
  return p ? p.nombre : 'â€”';
}
function colorProgress(pct) {
  if (pct >= 70) return '#22c55e';
  if (pct >= 40) return '#f5a623';
  return '#ef4444';
}

// ===================== DASHBOARD =====================
function renderDashboard() {
  const activos = db.proyectos.filter(p => p.estado !== 'finalizado' && p.estado !== 'pausado').length;
  const totalPres = db.proyectos.reduce((a, p) => a + Number(p.presupuesto), 0);
  const enPlanilla = db.personal.filter(e => e.tipo === 'planilla').length;
  const maqActivas = db.maquinaria.filter(m => m.estado === 'activo').length;

  document.getElementById('kpi-proyectos').textContent = activos;
  document.getElementById('kpi-presupuesto').textContent = fmtM(totalPres);
  document.getElementById('kpi-personal').textContent = enPlanilla;
  document.getElementById('kpi-maquinas').textContent = maqActivas;

  // projects table on dashboard
  const tbody = document.getElementById('dash-projects-table');
  if (db.proyectos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos.</td></tr>';
  } else {
    tbody.innerHTML = db.proyectos.slice(0, 6).map(p => `
      <tr>
        <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.tipo} Â· ${p.ubicacion || 'â€”'}</div></td>
        <td>${p.cliente}</td>
        <td>${fmtM(p.presupuesto)}</td>
        <td><div style="display:flex;align-items:center;gap:8px;font-size:12px;min-width:110px">
          <div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>${p.avance}%
        </div></td>
        <td>${statusLabel(p.estado)}</td>
      </tr>`).join('');
  }

  // personal top horas
  const topEmp = [...db.personal].sort((a,b) => b.horas - a.horas).slice(0, 4);
  const empDiv = document.getElementById('dash-personal-list');
  empDiv.innerHTML = topEmp.length ? topEmp.map(e => `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;">
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
        <div><div style="font-size:13px;font-weight:600;">${e.nombre}</div><div style="font-size:11px;color:var(--muted);">${e.rol}</div></div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-weight:700;color:var(--accent);">${e.horas}h</div>
    </div>`).join('') : '<p style="color:var(--muted);font-size:13px;">Sin datos.</p>';

  // maquinaria rentabilidad
  const maqDiv = document.getElementById('dash-maquinaria-list');
  maqDiv.innerHTML = db.maquinaria.length ? db.maquinaria.slice(0,4).map(m => {
    const ingreso = m.horas * m.tarifa;
    const costo = m.horas * m.costoHora;
    const rentab = ingreso > 0 ? ((ingreso - costo) / ingreso * 100).toFixed(1) : 0;
    const cls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';
    return `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--bg3);border-radius:8px;">
      <div><div style="font-size:13px;font-weight:600;">${m.nombre}</div><div style="font-size:11px;color:var(--muted);">${m.horas}h Â· ${fmtM(ingreso)} facturado</div></div>
      <div class="${cls}">${rentab}%</div>
    </div>`;
  }).join('') : '<p style="color:var(--muted);font-size:13px;">Sin datos.</p>';
}

// ===================== PROYECTOS =====================
function renderProyectos(filter) {
  if (filter) currentFilter.proyectos = filter;
  const f = currentFilter.proyectos;
  let data = db.proyectos;
  if (f !== 'todos') data = data.filter(p => p.estado === f);
  document.getElementById('proyectos-sub').textContent = db.proyectos.length + ' proyectos en cartera Â· $' + (db.proyectos.reduce((a,p)=>a+Number(p.presupuesto),0)/1000000).toFixed(1) + 'M total';
  const grid = document.getElementById('projects-grid');
  if (data.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸ—ï¸</div><p>No hay proyectos en esta categorÃ­a.</p></div>';
    return;
  }
  grid.innerHTML = data.map(p => `
    <div class="project-card" onclick="openProyectoDetail('${p.id}')">
      <div class="project-card-header">
        <span class="project-type-badge">${p.tipo}</span>
        ${statusLabel(p.estado)}
      </div>
      <div class="project-card-title">${p.nombre}</div>
      <div class="project-card-client">${p.cliente} Â· ${p.ubicacion || 'Sin ubicaciÃ³n'}</div>
      <div style="margin-top:12px;">
        <div class="project-progress-label"><span>Avance fÃ­sico</span><span style="font-weight:700;color:${colorProgress(p.avance)}">${p.avance}%</span></div>
        <div class="progress-bar"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>
      </div>
      <div class="project-card-meta" style="margin-top:12px;">
        <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;">${fmtM(p.presupuesto)}</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation();openModal('proyecto','${p.id}')">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();confirmDelete('proyecto','${p.id}')">ğŸ—‘ï¸</button>
        </div>
      </div>
    </div>`).join('');
}

function filterTab(page, filter, el) {
  document.querySelectorAll(`#page-${page} .tab`).forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  if (page === 'proyectos') renderProyectos(filter);
}

function openProyectoDetail(id) {
  openModal('proyecto', id, true);
}

// ===================== PERSONAL =====================
function renderPersonal(search, statusF) {
  if (search !== undefined) currentFilter.personal = search;
  if (statusF !== undefined) currentFilter.personalStatus = statusF;
  let data = db.personal;
  if (currentFilter.personal) {
    const q = currentFilter.personal.toLowerCase();
    data = data.filter(e => e.nombre.toLowerCase().includes(q) || e.rol.toLowerCase().includes(q) || e.ci.includes(q));
  }
  if (currentFilter.personalStatus) data = data.filter(e => e.tipo === currentFilter.personalStatus);
  document.getElementById('personal-sub').textContent = db.personal.length + ' empleados Â· ' + db.personal.filter(e=>e.tipo==='planilla').length + ' en planilla';
  const tbody = document.getElementById('personal-table');
  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px;">No se encontraron resultados.</td></tr>';
    return;
  }
  tbody.innerHTML = data.map(e => {
    // Contract expiry check
    let contractAlert = '';
    if (e.fechaFin) {
      const today = new Date();
      const fin = new Date(e.fechaFin);
      const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
      if (diffDays < 0) {
        contractAlert = `<div style="font-size:10px;color:var(--red);font-weight:700;margin-top:2px;">âš ï¸ Contrato vencido</div>`;
      } else if (diffDays <= 30) {
        contractAlert = `<div style="font-size:10px;color:var(--accent);font-weight:700;margin-top:2px;">â° Vence en ${diffDays}d</div>`;
      }
    }
    return `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--blue),var(--purple));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;flex-shrink:0;">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
          <div><div class="td-name">${e.nombre}</div><div class="td-sub">${e.ci}</div>${contractAlert}</div>
        </div>
      </td>
      <td><div>${e.rol}</div><div class="td-sub">${e.cuadrilla || 'â€”'}</div></td>
      <td>${tipoLabel(e.tipo)}</td>
      <td>${e.tipo === 'jornal' ? fmt(e.sueldo) + '/dÃ­a' : fmt(e.sueldo) + '/mes'}</td>
      <td><span style="font-family:'Syne',sans-serif;font-weight:700;">${e.horas}h</span></td>
      <td>${getProyectoNombre(e.proyecto)}</td>
      <td><span class="status-badge activo">Activo</span></td>
      <td>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-primary btn-sm" onclick="verPersonal('${e.id}')">ğŸ‘ Ver</button>
          <button class="btn btn-ghost btn-sm" onclick="openModal('personal','${e.id}')">âœï¸</button>
          <button class="btn btn-danger btn-sm" onclick="confirmDelete('personal','${e.id}')">ğŸ—‘ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function filterPersonal(val) { renderPersonal(val); }
function filterPersonalStatus(val) { renderPersonal(undefined, val); }

function verPersonal(id) {
  currentPersonalId = id;
  const e = db.personal.find(x => x.id === id);
  if (!e) return;
  const proyecto = getProyectoNombre(e.proyecto);
  const sueldoLabel = e.tipo === 'jornal' ? fmt(e.sueldo) + '/dÃ­a' : fmt(e.sueldo) + '/mes';
  const salarioTotal = e.tipo === 'jornal' ? e.sueldo * (e.horas / 8) : e.sueldo;
  const costoHora = salarioTotal / (e.horas || 1);

  // Contract expiry check
  let contractStatus = '';
  if (e.fechaFin) {
    const today = new Date();
    const fin = new Date(e.fechaFin);
    const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) {
      contractStatus = `<div style="margin-top:10px;padding:10px 14px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;font-size:13px;color:var(--red);font-weight:600;">âš ï¸ Contrato VENCIDO hace ${Math.abs(diffDays)} dÃ­as â€” Renovar urgente</div>`;
    } else if (diffDays <= 30) {
      contractStatus = `<div style="margin-top:10px;padding:10px 14px;background:rgba(245,166,35,0.1);border:1px solid rgba(245,166,35,0.3);border-radius:8px;font-size:13px;color:var(--accent);font-weight:600;">â° Contrato vence en ${diffDays} dÃ­as (${fin.toLocaleDateString('es-PE')}) â€” Revisar renovaciÃ³n</div>`;
    }
  }

  // Simulated monthly hours breakdown
  const semanas = [
    { sem: 'Semana 1', lun: 8, mar: 8, mie: 8, jue: 8, vie: 8, sab: 4, total: 44 },
    { sem: 'Semana 2', lun: 8, mar: 8, mie: 8, jue: 0, vie: 8, sab: 0, total: 32 },
    { sem: 'Semana 3', lun: 8, mar: 8, mie: 8, jue: 8, vie: 8, sab: 8, total: 48 },
    { sem: 'Semana 4', lun: 8, mar: 8, mie: 0, jue: 8, vie: 8, sab: 4, total: e.horas - 124 > 0 ? e.horas - 124 : 36 },
  ];

  document.getElementById('personal-detail-content').innerHTML = `
    <div class="person-detail-header">
      <div class="person-avatar">${e.nombre.split(' ').map(x=>x[0]).join('').slice(0,2)}</div>
      <div class="person-detail-info">
        <h2>${e.nombre}</h2>
        <p>${e.rol} Â· Cuadrilla: ${e.cuadrilla || 'No asignada'}</p>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          ${tipoLabel(e.tipo)}
          <span class="status-badge activo">Activo</span>
          ${e.tel ? `<span style="font-size:12px;color:var(--muted2);">ğŸ“ ${e.tel}</span>` : ''}
          ${e.email ? `<span style="font-size:12px;color:var(--muted2);">âœ‰ï¸ ${e.email}</span>` : ''}
        </div>
        ${contractStatus}
      </div>
    </div>
    <div class="detail-grid">
      <div class="detail-item">
        <div class="d-label">Sueldo Base</div>
        <div class="d-val" style="color:var(--accent)">${sueldoLabel}</div>
        <div class="d-sub">Salario mensual estimado: ${fmt(salarioTotal)}</div>
      </div>
      <div class="detail-item">
        <div class="d-label">Horas Trabajadas (mes)</div>
        <div class="d-val" style="color:var(--blue)">${e.horas}h</div>
        <div class="d-sub">Costo/hora: ${fmt(Math.round(costoHora))}</div>
      </div>
      <div class="detail-item">
        <div class="d-label">Proyecto Asignado</div>
        <div class="d-val" style="font-size:14px;font-weight:700;">${proyecto}</div>
        <div class="d-sub">CI: ${e.ci}</div>
      </div>
    </div>
    ${e.dir || e.obs ? `
    <div style="background:var(--bg3);border-radius:10px;padding:14px;margin-bottom:16px;border:1px solid var(--border);">
      ${e.dir ? `<div style="font-size:12px;color:var(--muted2);margin-bottom:4px;">ğŸ“ ${e.dir}</div>` : ''}
      ${e.obs ? `<div style="font-size:12px;color:var(--muted2);">ğŸ“ ${e.obs}</div>` : ''}
    </div>` : ''}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;color:var(--muted2);">REGISTRO DE HORAS â€” MES ACTUAL</div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <table class="hours-table">
        <thead><tr><th>Semana</th><th>Lun</th><th>Mar</th><th>MiÃ©</th><th>Jue</th><th>Vie</th><th>SÃ¡b</th><th>Total</th></tr></thead>
        <tbody>
          ${semanas.map(s=>`<tr>
            <td style="font-weight:600;">${s.sem}</td>
            <td>${s.lun}h</td><td>${s.mar}h</td><td>${s.mie}h</td>
            <td>${s.jue}h</td><td>${s.vie}h</td>
            <td style="color:${s.sab>0?'var(--accent)':'var(--muted)'};">${s.sab}h</td>
            <td style="font-weight:700;color:var(--blue);">${s.total}h</td>
          </tr>`).join('')}
          <tr style="background:rgba(245,166,35,0.05);">
            <td colspan="6" style="font-weight:700;text-align:right;padding-right:20px;color:var(--muted2);">TOTAL MES:</td>
            <td colspan="2" style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--accent);">${e.horas}h</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  openModal('personal-detail');
}

function editPersonal() {
  closeModal('personal-detail');
  openModal('personal', currentPersonalId);
}

function exportPersonaExcel() {
  const e = db.personal.find(x => x.id === currentPersonalId);
  if (!e) return;
  exportToCSV([
    ['Campo', 'Valor'],
    ['Nombre', e.nombre], ['CI', e.ci], ['Rol', e.rol], ['Cuadrilla', e.cuadrilla],
    ['Tipo', e.tipo], ['Sueldo Base', e.sueldo], ['Horas Mes', e.horas],
    ['Proyecto', getProyectoNombre(e.proyecto)], ['TelÃ©fono', e.tel], ['Email', e.email],
    ['DirecciÃ³n', e.dir], ['Observaciones', e.obs],
    [''],['Registro de Horas'],
    ['Semana','Lunes','Martes','MiÃ©rcoles','Jueves','Viernes','SÃ¡bado','Total'],
    ['Semana 1',8,8,8,8,8,4,44],['Semana 2',8,8,8,0,8,0,32],
    ['Semana 3',8,8,8,8,8,8,48],['Semana 4',8,8,0,8,8,4,36],
    ['TOTAL','','','','','','',e.horas]
  ], 'ficha_' + e.nombre.replace(/ /g,'_'));
  toast('Excel generado', 'Archivo descargado: ficha_' + e.nombre);
}

function exportPersonalExcel() {
  const rows = [['Nombre','CI','Rol','Cuadrilla','Tipo','Sueldo','Horas Mes','Proyecto','TelÃ©fono','Email']];
  db.personal.forEach(e => rows.push([e.nombre,e.ci,e.rol,e.cuadrilla,e.tipo,e.sueldo,e.horas,getProyectoNombre(e.proyecto),e.tel,e.email]));
  exportToCSV(rows, 'personal_completo');
  toast('Excel exportado', db.personal.length + ' empleados exportados');
}

// ===================== BOLETA DE PAGO PDF =====================
function generarBoletaPDF() {
  const e = db.personal.find(x => x.id === currentPersonalId);
  if (!e) return;

  const proyecto = getProyectoNombre(e.proyecto);
  const hoy = new Date();
  const mes = hoy.toLocaleString('es-PE', { month: 'long', year: 'numeric' });
  const fechaEmision = hoy.toLocaleDateString('es-PE');

  // Calcular montos
  const sueldoBase = Number(e.sueldo) || 0;
  const horas = Number(e.horas) || 0;
  let sueldoBruto = sueldoBase;
  if (e.tipo === 'jornal') sueldoBruto = sueldoBase * (horas / 8);

  // Descuentos estÃ¡ndar PerÃº
  const onp = sueldoBruto * 0.13;         // ONP 13%
  const essalud = sueldoBruto * 0.09;     // EsSalud 9% (cargo empleador)
  const sctr = sueldoBruto * 0.009;       // SCTR ~0.9%
  const totalDescuentos = onp;            // descuento trabajador
  const sueldoNeto = sueldoBruto - totalDescuentos;

  const tipoMap = { planilla: 'En Planilla', contrato: 'Contrato', jornal: 'Jornalero' };

  const html = `<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Boleta de Pago â€” ${e.nombre}</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:Arial,sans-serif;font-size:13px;color:#1a1a2e;background:#fff;padding:30px;}
  .boleta{max-width:680px;margin:0 auto;border:2px solid #1a1a2e;border-radius:8px;overflow:hidden;}
  .header{background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;padding:20px 24px;display:flex;justify-content:space-between;align-items:center;}
  .header h1{font-size:22px;font-weight:900;letter-spacing:1px;}
  .header .sub{font-size:11px;opacity:0.85;margin-top:3px;}
  .header .fecha{text-align:right;font-size:12px;}
  .section{padding:16px 24px;border-bottom:1px solid #e5e7eb;}
  .section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#6b7280;margin-bottom:10px;}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px 24px;}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px 16px;}
  .field label{font-size:10px;color:#9ca3af;text-transform:uppercase;letter-spacing:0.5px;display:block;margin-bottom:2px;}
  .field span{font-weight:700;font-size:13px;color:#111;}
  table{width:100%;border-collapse:collapse;margin-top:4px;}
  table th{background:#f9fafb;padding:8px 12px;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6b7280;text-align:left;border-bottom:2px solid #e5e7eb;}
  table td{padding:9px 12px;font-size:13px;border-bottom:1px solid #f3f4f6;}
  table tr:last-child td{border-bottom:none;}
  .amount{text-align:right;font-weight:700;}
  .green{color:#16a34a;}
  .red{color:#dc2626;}
  .total-row{background:#fef9f0;}
  .total-row td{font-family:'Arial',sans-serif;font-weight:900;font-size:15px;padding:12px;}
  .neto-box{background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;padding:18px 24px;text-align:center;}
  .neto-box .label{font-size:11px;text-transform:uppercase;letter-spacing:1px;opacity:0.85;}
  .neto-box .amount{font-size:32px;font-weight:900;margin:4px 0;}
  .neto-box .sub{font-size:11px;opacity:0.75;}
  .footer{padding:14px 24px;background:#f9fafb;font-size:11px;color:#6b7280;display:flex;justify-content:space-between;}
  @media print{body{padding:0;} .no-print{display:none;}}
</style>
</head>
<body>
<div class="boleta">
  <div class="header">
    <div>
      <h1>ğŸ—ï¸ BuildCore</h1>
      <div class="sub">Sistema de GestiÃ³n de ConstrucciÃ³n</div>
      <div class="sub" style="margin-top:6px;font-size:13px;font-weight:700;">BOLETA DE PAGO</div>
    </div>
    <div class="fecha">
      <div style="font-weight:700;font-size:14px;">PerÃ­odo: ${mes}</div>
      <div style="margin-top:4px;">EmisiÃ³n: ${fechaEmision}</div>
      <div style="margin-top:4px;opacity:0.7;">NÂ° ${String(hoy.getFullYear()) + String(hoy.getMonth()+1).padStart(2,'0') + String(Math.floor(Math.random()*9000)+1000)}</div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Datos del Trabajador</div>
    <div class="grid2">
      <div class="field"><label>Apellidos y Nombres</label><span>${e.nombre}</span></div>
      <div class="field"><label>DNI / CI</label><span>${e.ci || 'â€”'}</span></div>
      <div class="field"><label>Cargo / Puesto</label><span>${e.rol || 'â€”'}</span></div>
      <div class="field"><label>Cuadrilla</label><span>${e.cuadrilla || 'â€”'}</span></div>
      <div class="field"><label>Tipo de Contrato</label><span>${tipoMap[e.tipo] || e.tipo}</span></div>
      <div class="field"><label>Proyecto Asignado</label><span>${proyecto}</span></div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">Detalle de Haberes</div>
    <table>
      <thead><tr><th>Concepto</th><th>Detalle</th><th class="amount">Monto</th></tr></thead>
      <tbody>
        <tr>
          <td><b>Sueldo / Jornal Base</b></td>
          <td style="color:#6b7280;">${e.tipo==='jornal'?horas+' horas Ã— S/ '+sueldoBase+'/h':'Mensual fijo'}</td>
          <td class="amount green">S/ ${sueldoBruto.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>
        <tr>
          <td>Horas trabajadas</td>
          <td style="color:#6b7280;">${horas} horas en el mes</td>
          <td class="amount">â€”</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section">
    <div class="section-title">Descuentos del Trabajador</div>
    <table>
      <thead><tr><th>Concepto</th><th>Base</th><th class="amount">Descuento</th></tr></thead>
      <tbody>
        <tr>
          <td>ONP (Sistema Nacional de Pensiones)</td>
          <td style="color:#6b7280;">13% s/ S/ ${sueldoBruto.toLocaleString('es-PE',{minimumFractionDigits:2})}</td>
          <td class="amount red">- S/ ${onp.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
        </tr>
        <tr class="total-row">
          <td colspan="2"><b>Total Descuentos</b></td>
          <td class="amount red"><b>- S/ ${totalDescuentos.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</b></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="section" style="border-bottom:none;">
    <div class="section-title">Aportes del Empleador</div>
    <table>
      <thead><tr><th>Concepto</th><th>Tasa</th><th class="amount">Monto</th></tr></thead>
      <tbody>
        <tr><td>EsSalud</td><td style="color:#6b7280;">9%</td><td class="amount" style="color:#2563eb;">S/ ${essalud.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
        <tr><td>SCTR (Salud + PensiÃ³n)</td><td style="color:#6b7280;">0.9%</td><td class="amount" style="color:#2563eb;">S/ ${sctr.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</td></tr>
      </tbody>
    </table>
  </div>

  <div class="neto-box">
    <div class="label">Neto a Pagar al Trabajador</div>
    <div class="amount">S/ ${sueldoNeto.toLocaleString('es-PE',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
    <div class="sub">${mes} Â· ${e.nombre.toUpperCase()}</div>
  </div>

  <div class="footer">
    <span>ğŸ“‹ Generado por BuildCore Â· ${fechaEmision}</span>
    <span>Firma empleador: ___________________</span>
    <span>Firma trabajador: ___________________</span>
  </div>
</div>

<div class="no-print" style="text-align:center;margin-top:20px;">
  <button onclick="window.print()" style="background:linear-gradient(135deg,#f5a623,#e8521a);color:#fff;border:none;padding:12px 32px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;">ğŸ–¨ï¸ Imprimir / Guardar PDF</button>
</div>
</body></html>`;

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  toast('Boleta generada', 'Se abriÃ³ la boleta en nueva ventana â€” imprimÃ­ o guardÃ¡ como PDF');
}

// ===================== MAQUINARIA =====================
function renderMaquinaria() {
  document.getElementById('maquinaria-sub').textContent = db.maquinaria.length + ' equipos registrados';
  const totalH = db.maquinaria.reduce((a,m)=>a+Number(m.horas),0);
  const totalI = db.maquinaria.reduce((a,m)=>a+(m.horas*m.tarifa),0);
  const totalC = db.maquinaria.reduce((a,m)=>a+(m.horas*m.costoHora),0);
  const rentProm = totalI > 0 ? ((totalI-totalC)/totalI*100).toFixed(1) : 0;
  document.getElementById('maq-total-horas').textContent = totalH + 'h';
  document.getElementById('maq-total-ingreso').textContent = fmtM(totalI);
  document.getElementById('maq-total-costo').textContent = fmtM(totalC);
  document.getElementById('maq-rentab-prom').textContent = rentProm + '%';
  const grid = document.getElementById('machines-grid');
  if (db.maquinaria.length === 0) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="icon">ğŸšœ</div><p>No hay equipos registrados.</p></div>';
    return;
  }
  grid.innerHTML = db.maquinaria.map(m => {
    const ingreso = m.horas * m.tarifa;
    const costo = m.horas * m.costoHora;
    const utilidad = ingreso - costo;
    const rentab = ingreso > 0 ? ((utilidad/ingreso)*100).toFixed(1) : 0;
    const rentCls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';
    const estadoColor = m.estado === 'activo' ? 'var(--green)' : m.estado === 'pausado' ? 'var(--red)' : 'var(--accent)';
    const estadoTxt = m.estado === 'activo' ? 'Operativo' : m.estado === 'pausado' ? 'Mantenimiento' : 'Reservado';
    return `
    <div class="machine-card">
      <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;">
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;">${m.nombre}</div>
          <div style="font-size:12px;color:var(--muted2);margin-top:3px;">${m.modelo} Â· ${m.matricula}</div>
        </div>
        <span style="background:rgba(255,255,255,0.05);color:${estadoColor};font-size:11px;font-weight:700;padding:3px 9px;border-radius:20px;border:1px solid ${estadoColor}33;">${estadoTxt}</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Horas Mes</div>
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--blue);">${m.horas}h</div>
        </div>
        <div style="background:var(--bg3);border-radius:8px;padding:10px;text-align:center;">
          <div style="font-size:10px;font-weight:700;letter-spacing:1px;color:var(--muted);text-transform:uppercase;">Rentabilidad</div>
          <div class="${rentCls}" style="font-family:'Syne',sans-serif;font-size:18px;">${rentab}%</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:12px;margin-bottom:14px;">
        <div style="text-align:center;"><div style="color:var(--muted);">Ingreso</div><div style="font-weight:700;color:var(--green);">${fmtM(ingreso)}</div></div>
        <div style="text-align:center;"><div style="color:var(--muted);">Costo</div><div style="font-weight:700;color:var(--red);">${fmtM(costo)}</div></div>
        <div style="text-align:center;"><div style="color:var(--muted);">Utilidad</div><div style="font-weight:700;color:var(--accent);">${fmtM(utilidad)}</div></div>
      </div>
      <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;">
        ğŸ“‹ ${getProyectoNombre(m.proyecto)} &nbsp;Â·&nbsp; ğŸ”§ ${m.mantenim || 'Sin fecha'}
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary btn-sm" style="flex:1" onclick="verMaquina('${m.id}')">ğŸ‘ Ver Detalle</button>
        <button class="btn btn-ghost btn-sm" onclick="openModal('maquina','${m.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelete('maquina','${m.id}')">ğŸ—‘ï¸</button>
      </div>
    </div>`;
  }).join('');
}

function verMaquina(id) {
  currentMaquinaId = id;
  const m = db.maquinaria.find(x => x.id === id);
  if (!m) return;
  const ingreso = m.horas * m.tarifa;
  const costo = m.horas * m.costoHora;
  const utilidad = ingreso - costo;
  const rentab = ingreso > 0 ? ((utilidad/ingreso)*100).toFixed(1) : 0;
  const rentCls = rentab >= 40 ? 'rentab-high' : rentab >= 20 ? 'rentab-mid' : 'rentab-low';

  // Simulated weekly breakdown
  const semanas = [
    { sem:'Sem 1', horas:Math.round(m.horas*0.27), ingreso:Math.round(m.horas*0.27*m.tarifa), costo:Math.round(m.horas*0.27*m.costoHora) },
    { sem:'Sem 2', horas:Math.round(m.horas*0.23), ingreso:Math.round(m.horas*0.23*m.tarifa), costo:Math.round(m.horas*0.23*m.costoHora) },
    { sem:'Sem 3', horas:Math.round(m.horas*0.28), ingreso:Math.round(m.horas*0.28*m.tarifa), costo:Math.round(m.horas*0.28*m.costoHora) },
    { sem:'Sem 4', horas:Math.round(m.horas*0.22), ingreso:Math.round(m.horas*0.22*m.tarifa), costo:Math.round(m.horas*0.22*m.costoHora) },
  ];

  document.getElementById('maquina-detail-content').innerHTML = `
    <div style="display:flex;align-items:center;gap:18px;padding:18px;background:var(--bg3);border-radius:12px;margin-bottom:18px;border:1px solid var(--border);">
      <div style="font-size:42px;">ğŸšœ</div>
      <div>
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">${m.nombre}</div>
        <div style="font-size:13px;color:var(--muted2);margin-top:3px;">${m.tipo} Â· ${m.modelo} Â· ${m.matricula}</div>
        <div style="margin-top:8px;">
          <span class="status-badge ${m.estado === 'activo' ? 'activo' : m.estado === 'pausado' ? 'pausado' : 'pendiente'}">${m.estado === 'activo' ? 'Operativo' : m.estado === 'pausado' ? 'Mantenimiento' : 'Reservado'}</span>
        </div>
      </div>
    </div>
    <div class="machine-kpi-grid">
      <div class="detail-item"><div class="d-label">Horas Trabajadas</div><div class="d-val" style="color:var(--blue)">${m.horas}h</div><div class="d-sub">Tarifa: ${fmt(m.tarifa)}/h</div></div>
      <div class="detail-item"><div class="d-label">Ingresos</div><div class="d-val" style="color:var(--green)">${fmtM(ingreso)}</div><div class="d-sub">${fmt(m.tarifa)}/h Ã— ${m.horas}h</div></div>
      <div class="detail-item"><div class="d-label">Costo Operativo</div><div class="d-val" style="color:var(--red)">${fmtM(costo)}</div><div class="d-sub">${fmt(m.costoHora)}/h Ã— ${m.horas}h</div></div>
      <div class="detail-item"><div class="d-label">Rentabilidad</div><div class="d-val ${rentCls}">${rentab}%</div><div class="d-sub">Utilidad: ${fmtM(utilidad)}</div></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
      <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">Proyecto Asignado</div>
        <div style="font-weight:700;">${getProyectoNombre(m.proyecto)}</div>
      </div>
      <div style="background:var(--bg3);border-radius:10px;padding:14px;border:1px solid var(--border);">
        <div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--muted);margin-bottom:8px;">PrÃ³ximo Mantenimiento</div>
        <div style="font-weight:700;color:${m.mantenim ? 'var(--accent)':'var(--muted)'};">${m.mantenim || 'No programado'}</div>
      </div>
    </div>
    ${m.obs ? `<div style="background:var(--bg3);border-radius:10px;padding:12px;margin-bottom:16px;font-size:13px;color:var(--muted2);border:1px solid var(--border);">ğŸ“ ${m.obs}</div>` : ''}
    <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:10px;color:var(--muted2);">DESGLOSE SEMANAL â€” MES ACTUAL</div>
    <div style="border:1px solid var(--border);border-radius:10px;overflow:hidden;">
      <table class="hours-table">
        <thead><tr><th>Semana</th><th>Horas</th><th>Ingreso</th><th>Costo</th><th>Utilidad</th><th>Rentab.</th></tr></thead>
        <tbody>
          ${semanas.map(s=>{
            const util = s.ingreso - s.costo;
            const r = s.ingreso>0?((util/s.ingreso)*100).toFixed(1):0;
            const c = r>=40?'var(--green)':r>=20?'var(--accent)':'var(--red)';
            return `<tr>
              <td style="font-weight:600;">${s.sem}</td>
              <td style="color:var(--blue);font-weight:700;">${s.horas}h</td>
              <td style="color:var(--green);">${fmt(s.ingreso)}</td>
              <td style="color:var(--red);">${fmt(s.costo)}</td>
              <td style="font-weight:700;">${fmt(util)}</td>
              <td style="color:${c};font-weight:700;">${r}%</td>
            </tr>`;
          }).join('')}
          <tr style="background:rgba(245,166,35,0.05);font-weight:700;">
            <td>TOTAL</td>
            <td style="color:var(--blue);font-family:'Syne',sans-serif;">${m.horas}h</td>
            <td style="color:var(--green);">${fmt(ingreso)}</td>
            <td style="color:var(--red);">${fmt(costo)}</td>
            <td style="color:var(--accent);font-family:'Syne',sans-serif;">${fmt(utilidad)}</td>
            <td class="${rentCls}" style="font-family:'Syne',sans-serif;">${rentab}%</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  openModal('maquina-detail');
}

function editMaquina() {
  closeModal('maquina-detail');
  openModal('maquina', currentMaquinaId);
}

function exportMaquinaExcel() {
  const m = db.maquinaria.find(x => x.id === currentMaquinaId);
  if (!m) return;
  const ing = m.horas * m.tarifa;
  const cos = m.horas * m.costoHora;
  exportToCSV([
    ['Campo', 'Valor'],
    ['Equipo', m.nombre], ['Tipo', m.tipo], ['Modelo', m.modelo], ['MatrÃ­cula', m.matricula],
    ['Horas Trabajadas', m.horas], ['Tarifa/Hora (USD)', m.tarifa], ['Costo Operativo/Hora (USD)', m.costoHora],
    ['Ingresos (USD)', ing], ['Costos (USD)', cos], ['Utilidad (USD)', ing-cos],
    ['Rentabilidad (%)', ing>0?((ing-cos)/ing*100).toFixed(1):0],
    ['Proyecto', getProyectoNombre(m.proyecto)], ['Estado', m.estado], ['PrÃ³x. Mantenimiento', m.mantenim],
    ['Observaciones', m.obs]
  ], 'maquina_' + m.nombre.replace(/ /g,'_'));
  toast('Excel generado', 'Archivo descargado: ' + m.nombre);
}

function exportMaquinariaExcel() {
  const rows = [['Equipo','Tipo','Modelo','MatrÃ­cula','Horas','Tarifa/h','Costo/h','Ingreso','Costo','Utilidad','Rentabilidad','Proyecto','Estado']];
  db.maquinaria.forEach(m => {
    const ing = m.horas * m.tarifa;
    const cos = m.horas * m.costoHora;
    rows.push([m.nombre,m.tipo,m.modelo,m.matricula,m.horas,m.tarifa,m.costoHora,ing,cos,ing-cos,ing>0?((ing-cos)/ing*100).toFixed(1)+'%':0,getProyectoNombre(m.proyecto),m.estado]);
  });
  exportToCSV(rows, 'maquinaria_completo');
  toast('Excel exportado', db.maquinaria.length + ' equipos exportados');
}

// ===================== MODALS =====================
function openModal(type, id, readonly) {
  if (type === 'proyecto') {
    const isEdit = !!id;
    document.getElementById('modal-proyecto-title').textContent = isEdit ? (readonly ? 'Detalle del Proyecto' : 'Editar Proyecto') : 'Nuevo Proyecto';
    document.getElementById('proyecto-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const p = db.proyectos.find(x => x.id === id);
      if (p) {
        document.getElementById('p-nombre').value = p.nombre;
        document.getElementById('p-tipo').value = p.tipo;
        document.getElementById('p-cliente').value = p.cliente;
        document.getElementById('p-presupuesto').value = p.presupuesto;
        document.getElementById('p-inicio').value = p.inicio || '';
        document.getElementById('p-fin').value = p.fin || '';
        document.getElementById('p-ubicacion').value = p.ubicacion || '';
        document.getElementById('p-estado').value = p.estado;
        document.getElementById('p-avance').value = p.avance;
        document.getElementById('p-descripcion').value = p.descripcion || '';
      }
    } else {
      clearForm(['p-nombre','p-cliente','p-presupuesto','p-inicio','p-fin','p-ubicacion','p-avance','p-descripcion']);
      document.getElementById('p-tipo').value = 'Residencial';
      document.getElementById('p-estado').value = 'pendiente';
    }
    document.getElementById('modal-proyecto').classList.add('open');
  }
  if (type === 'personal') {
    const isEdit = !!id;
    document.getElementById('modal-personal-title').textContent = isEdit ? 'Editar Empleado' : 'Agregar Personal';
    document.getElementById('emp-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const e = db.personal.find(x => x.id === id);
      if (e) {
        document.getElementById('emp-nombre').value = e.nombre;
        document.getElementById('emp-ci').value = e.ci;
        document.getElementById('emp-rol').value = e.rol;
        document.getElementById('emp-cuadrilla').value = e.cuadrilla || '';
        document.getElementById('emp-tipo').value = e.tipo;
        document.getElementById('emp-sueldo').value = e.sueldo;
        document.getElementById('emp-horas').value = e.horas;
        document.getElementById('emp-proyecto').value = e.proyecto || '';
        document.getElementById('emp-tel').value = e.tel || '';
        document.getElementById('emp-email').value = e.email || '';
        document.getElementById('emp-dir').value = e.dir || '';
        document.getElementById('emp-obs').value = e.obs || '';
        document.getElementById('emp-fecha-contrato').value = e.fechaContrato || '';
        document.getElementById('emp-fecha-fin').value = e.fechaFin || '';
      }
    } else {
      clearForm(['emp-nombre','emp-ci','emp-cuadrilla','emp-sueldo','emp-horas','emp-tel','emp-email','emp-dir','emp-obs','emp-fecha-contrato','emp-fecha-fin']);
    }
    document.getElementById('modal-personal').classList.add('open');
  }
  if (type === 'personal-detail') document.getElementById('modal-personal-detail').classList.add('open');
  if (type === 'maquina') {
    const isEdit = !!id;
    document.getElementById('modal-maquina-title').textContent = isEdit ? 'Editar Equipo' : 'Registrar Equipo';
    document.getElementById('maq-id').value = id || '';
    populateProyectoDropdowns();
    if (isEdit) {
      const m = db.maquinaria.find(x => x.id === id);
      if (m) {
        document.getElementById('maq-nombre').value = m.nombre;
        document.getElementById('maq-tipo').value = m.tipo;
        document.getElementById('maq-modelo').value = m.modelo || '';
        document.getElementById('maq-matricula').value = m.matricula || '';
        document.getElementById('maq-horas').value = m.horas;
        document.getElementById('maq-tarifa').value = m.tarifa;
        document.getElementById('maq-costo-hora').value = m.costoHora;
        document.getElementById('maq-proyecto').value = m.proyecto || '';
        document.getElementById('maq-estado').value = m.estado;
        document.getElementById('maq-mantenim').value = m.mantenim || '';
        document.getElementById('maq-obs').value = m.obs || '';
      }
    } else {
      clearForm(['maq-nombre','maq-modelo','maq-matricula','maq-horas','maq-tarifa','maq-costo-hora','maq-mantenim','maq-obs']);
    }
    document.getElementById('modal-maquina').classList.add('open');
  }
  if (type === 'maquina-detail') document.getElementById('modal-maquina-detail').classList.add('open');
  if (type === 'presupuesto') {
    populateProyectoDropdowns();
    document.getElementById('modal-presupuesto').classList.add('open');
  }
  if (type === 'factura') {
    populateProyectoDropdowns();
    clearForm(['fac-numero','fac-cliente','fac-monto','fac-fecha','fac-vence']);
    document.getElementById('fac-estado').value = 'pendiente';
    document.getElementById('modal-factura').classList.add('open');
  }
  if (type === 'proveedor') {
    clearForm(['prov-nombre','prov-rut','prov-rubro','prov-tel']);
    document.getElementById('modal-proveedor').classList.add('open');
  }
  if (type === 'material') {
    populateProyectoDropdowns();
    clearForm(['mat-nombre','mat-cantidad','mat-resp']);
    document.getElementById('mat-tipo').value = 'ENTRADA';
    document.getElementById('modal-material').classList.add('open');
  }
  if (type === 'parte') {
    populateProyectoDropdowns();
    clearForm(['parte-cuadrilla','parte-actividad','parte-obreros','parte-horas','parte-obs']);
    document.getElementById('modal-parte').classList.add('open');
  }
}

function closeModal(type) {
  document.getElementById('modal-' + type).classList.remove('open');
}

// Close on overlay click
['proyecto','personal','personal-detail','maquina','maquina-detail','confirm'].forEach(t => {
  const el = document.getElementById('modal-' + t);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeModal(t); });
});

function clearForm(ids) { ids.forEach(id => { const el = document.getElementById(id); if(el) el.value = ''; }); }

function populateProyectoDropdowns() {
  const opts = '<option value="">Sin asignar</option>' + db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  ['emp-proyecto','maq-proyecto'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
}

// ===================== SAVE â€” SUPABASE =====================
async function saveProyecto() {
  const nombre = document.getElementById('p-nombre').value.trim();
  const cliente = document.getElementById('p-cliente').value.trim();
  const presupuesto = Number(document.getElementById('p-presupuesto').value);
  if (!nombre || !cliente || !presupuesto) { toast('Campos requeridos', 'CompletÃ¡ nombre, cliente y presupuesto', 'err'); return; }
  const id = document.getElementById('proyecto-id').value;
  const data = {
    nombre, cliente, presupuesto,
    tipo: document.getElementById('p-tipo').value,
    inicio: document.getElementById('p-inicio').value || null,
    fin: document.getElementById('p-fin').value || null,
    ubicacion: document.getElementById('p-ubicacion').value,
    estado: document.getElementById('p-estado').value,
    avance: Number(document.getElementById('p-avance').value) || 0,
    descripcion: document.getElementById('p-descripcion').value,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('proyectos?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Proyecto actualizado', nombre);
    } else {
      await sbFetch('proyectos', { method: 'POST', body: data });
      toast('Proyecto guardado', nombre);
    }
    closeModal('proyecto');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

async function savePersonal() {
  const nombre = document.getElementById('emp-nombre').value.trim();
  const ci = document.getElementById('emp-ci').value.trim();
  if (!nombre || !ci) { toast('Campos requeridos', 'CompletÃ¡ nombre y cÃ©dula', 'err'); return; }
  const id = document.getElementById('emp-id').value;
  const proyId = document.getElementById('emp-proyecto').value;
  const data = {
    nombre, ci,
    rol: document.getElementById('emp-rol').value,
    cuadrilla: document.getElementById('emp-cuadrilla').value,
    tipo: document.getElementById('emp-tipo').value,
    sueldo: Number(document.getElementById('emp-sueldo').value) || 0,
    horas: Number(document.getElementById('emp-horas').value) || 0,
    proyecto_id: proyId || null,
    telefono: document.getElementById('emp-tel').value,
    email: document.getElementById('emp-email').value,
    direccion: document.getElementById('emp-dir').value,
    observaciones: document.getElementById('emp-obs').value,
    fecha_contrato: document.getElementById('emp-fecha-contrato').value || null,
    fecha_fin_contrato: document.getElementById('emp-fecha-fin').value || null,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('personal?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Empleado actualizado', nombre);
    } else {
      await sbFetch('personal', { method: 'POST', body: data });
      toast('Empleado guardado', nombre);
    }
    closeModal('personal');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

async function saveMaquina() {
  const nombre = document.getElementById('maq-nombre').value.trim();
  if (!nombre) { toast('Campo requerido', 'IngresÃ¡ el nombre del equipo', 'err'); return; }
  const id = document.getElementById('maq-id').value;
  const proyId = document.getElementById('maq-proyecto').value;
  const data = {
    nombre,
    tipo: document.getElementById('maq-tipo').value,
    modelo: document.getElementById('maq-modelo').value,
    matricula: document.getElementById('maq-matricula').value,
    horas: Number(document.getElementById('maq-horas').value) || 0,
    tarifa: Number(document.getElementById('maq-tarifa').value) || 0,
    costo_hora: Number(document.getElementById('maq-costo-hora').value) || 0,
    proyecto_id: proyId || null,
    estado: document.getElementById('maq-estado').value,
    proximo_mantenimiento: document.getElementById('maq-mantenim').value || null,
    observaciones: document.getElementById('maq-obs').value,
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('maquinaria?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Equipo actualizado', nombre);
    } else {
      await sbFetch('maquinaria', { method: 'POST', body: data });
      toast('Equipo registrado', nombre);
    }
    closeModal('maquina');
    await loadAllData();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== DELETE â€” SUPABASE =====================
function confirmDelete(type, id) {
  const msgs = {
    proyecto: 'Â¿Eliminar este proyecto? Se perderÃ¡n todos sus datos.',
    personal: 'Â¿Eliminar este empleado del sistema?',
    maquina: 'Â¿Eliminar este equipo del parque de maquinaria?',
  };
  document.getElementById('confirm-msg').textContent = msgs[type] || 'Â¿Confirmar eliminaciÃ³n?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      const tableMap = { proyecto: 'proyectos', personal: 'personal', maquina: 'maquinaria' };
      await sbFetch(tableMap[type] + '?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Eliminado correctamente', '', 'err');
      await loadAllData();
    } catch(e) { toast('Error al eliminar', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

// ===================== SEARCH =====================
function globalSearch(val) {
  if (!val) return;
  const q = val.toLowerCase();
  const found = [
    ...db.proyectos.filter(p => p.nombre.toLowerCase().includes(q) || p.cliente.toLowerCase().includes(q)).map(p => p.nombre + ' (Proyecto)'),
    ...db.personal.filter(e => e.nombre.toLowerCase().includes(q) || e.ci.includes(q)).map(e => e.nombre + ' (Personal)'),
    ...db.maquinaria.filter(m => m.nombre.toLowerCase().includes(q) || m.matricula.toLowerCase().includes(q)).map(m => m.nombre + ' (Maquinaria)'),
  ];
  if (found.length > 0) toast('Resultados: ' + found.length, found.slice(0,3).join(', '));
}

// ===================== EXPORT CSV/EXCEL =====================
function exportToCSV(rows, filename) {
  const csv = rows.map(r => r.map(c => '"' + String(c||'').replace(/"/g,'""') + '"').join(',')).join('\n');
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename + '.csv';
  a.click();
  URL.revokeObjectURL(a.href);
}

// ===================== CONTRACT ALERTS =====================
function checkContractAlerts() {
  const today = new Date();
  const expiring = [];
  const expired = [];
  db.personal.forEach(e => {
    if (!e.fechaFin) return;
    const fin = new Date(e.fechaFin);
    const diffDays = Math.ceil((fin - today) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) expired.push(e.nombre);
    else if (diffDays <= 30) expiring.push({ nombre: e.nombre, dias: diffDays });
  });
  if (expired.length > 0) {
    toast('âš ï¸ Contratos vencidos', expired.join(', ') + ' â€” Renovar urgente', 'err');
  } else if (expiring.length > 0) {
    const msg = expiring.map(x => x.nombre + ' (' + x.dias + 'd)').join(', ');
    toast('â° Contratos por vencer', msg, 'warn');
  }
}

// ===================== TOAST =====================
let toastTimer;
function toast(title, msg, type) {
  clearTimeout(toastTimer);
  const t = document.getElementById('toast');
  document.getElementById('toast-title').textContent = title;
  document.getElementById('toast-msg').textContent = msg || '';
  t.className = 'toast open' + (type === 'warn' ? ' warn' : type === 'err' ? ' err' : '');
  toastTimer = setTimeout(() => t.classList.remove('open'), 3500);
}

// Close on overlay click for new modals
['presupuesto','factura','proveedor','material','parte'].forEach(t => {
  const el = document.getElementById('modal-' + t);
  if (el) el.addEventListener('click', function(e) { if (e.target === this) closeModal(t); });
});

// ===================== OBRAS =====================
function renderObras() {
  const activas = db.proyectos.filter(p => p.estado === 'activo' || p.estado === 'progreso').length;
  const totalObreros = db.personal.filter(e => e.proyecto).length;
  const totalHoras = db.personal.reduce((a,e)=>a+Number(e.horas),0);
  document.getElementById('ob-activas').textContent = activas || 5;
  document.getElementById('ob-obreros').textContent = totalObreros || 96;
  document.getElementById('ob-horas').textContent = (totalHoras || 768) + 'h';
}

// ===================== PRESUPUESTOS =====================
function renderPresupuestos() {
  const total = db.presupuestos.length;
  const aprobados = db.presupuestos.filter(p=>p.estado==='aprobado').length;
  const revision = db.presupuestos.filter(p=>p.estado==='revision' || p.estado==='negociacion').length;
  const rechazados = db.presupuestos.filter(p=>p.estado==='rechazado').length;
  document.getElementById('pres-total').textContent = total;
  document.getElementById('pres-aprobados').textContent = aprobados;
  document.getElementById('pres-revision').textContent = revision;
  document.getElementById('pres-rechazados').textContent = rechazados;
  document.getElementById('badge-presupuestos').textContent = total;
  const tbody = document.getElementById('presupuestos-table');
  if (!tbody) return;
  if (db.presupuestos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:28px;">No hay presupuestos. HacÃ© clic en "+ Nuevo Presupuesto".</td></tr>';
    return;
  }
  const estadoMap = { revision:'pendiente', aprobado:'activo', negociacion:'progreso', rechazado:'pausado' };
  const estadoTxt = { revision:'En RevisiÃ³n', aprobado:'Aprobado', negociacion:'NegociaciÃ³n', rechazado:'Rechazado' };
  tbody.innerHTML = db.presupuestos.map(p => `
    <tr>
      <td><div class="td-name">${p.nombre}</div></td>
      <td>${p.cliente}</td>
      <td style="font-weight:700;">${fmt(p.monto)}</td>
      <td style="color:var(--muted2);">${p.fecha || 'â€”'}</td>
      <td><span class="status-badge ${estadoMap[p.estado]||'pendiente'}">${estadoTxt[p.estado]||p.estado}</span></td>
      <td><div style="display:flex;gap:6px;">
        <button class="btn btn-ghost btn-sm" onclick="toast('PDF generado','${p.nombre}')">ğŸ“„ PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="editPresupuesto('${p.id}')">âœï¸</button>
        <button class="btn btn-danger btn-sm" onclick="deletePresupuesto('${p.id}')">ğŸ—‘ï¸</button>
      </div></td>
    </tr>`).join('');
}

function editPresupuesto(id) {
  const p = db.presupuestos.find(x=>x.id===id);
  if (!p) return;
  document.getElementById('pres-id').value = p.id;
  document.getElementById('pres-nombre').value = p.nombre;
  document.getElementById('pres-cliente').value = p.cliente;
  document.getElementById('pres-monto').value = p.monto;
  document.getElementById('pres-fecha').value = p.fecha||'';
  document.getElementById('pres-estado').value = p.estado;
  document.getElementById('pres-obs').value = p.obs||'';
  document.getElementById('modal-pres-title').textContent = 'Editar Presupuesto';
  document.getElementById('modal-presupuesto').classList.add('open');
}

async function deletePresupuesto(id) {
  document.getElementById('confirm-msg').textContent = 'Â¿Eliminar este presupuesto?';
  document.getElementById('confirm-ok').onclick = async () => {
    closeModal('confirm');
    showLoading(true);
    try {
      await sbFetch('presupuestos?id=eq.' + id, { method: 'DELETE', prefer: 'return=minimal' });
      toast('Presupuesto eliminado','','err');
      await loadAllData(); renderPresupuestos();
    } catch(e) { toast('Error', e.message, 'err'); }
    finally { showLoading(false); }
  };
  document.getElementById('modal-confirm').classList.add('open');
}

async function savePresupuesto() {
  const nombre = document.getElementById('pres-nombre').value.trim();
  const cliente = document.getElementById('pres-cliente').value.trim();
  const monto = Number(document.getElementById('pres-monto').value);
  if (!nombre || !cliente || !monto) { toast('Campos requeridos','CompletÃ¡ nombre, cliente y monto','err'); return; }
  const id = document.getElementById('pres-id').value;
  const data = {
    nombre, cliente, monto,
    fecha: document.getElementById('pres-fecha').value || null,
    estado: document.getElementById('pres-estado').value,
    observaciones: document.getElementById('pres-obs').value
  };
  try {
    showLoading(true);
    if (id) {
      await sbFetch('presupuestos?id=eq.' + id, { method: 'PATCH', body: data, prefer: 'return=minimal' });
      toast('Presupuesto actualizado', nombre);
    } else {
      await sbFetch('presupuestos', { method: 'POST', body: data });
      toast('Presupuesto guardado', nombre);
    }
    closeModal('presupuesto');
    document.getElementById('pres-id').value = '';
    document.getElementById('modal-pres-title').textContent = 'Nuevo Presupuesto';
    await loadAllData(); renderPresupuestos();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== FACTURA SAVE =====================
async function saveFactura() {
  const numero = document.getElementById('fac-numero').value.trim();
  const cliente = document.getElementById('fac-cliente').value.trim();
  const monto = Number(document.getElementById('fac-monto').value);
  if (!numero || !cliente || !monto) { toast('Campos requeridos','CompletÃ¡ nÃºmero, cliente y monto','err'); return; }
  const proyId = document.getElementById('fac-proyecto').value;
  const data = {
    numero, cliente, monto,
    proyecto_id: proyId || null,
    fecha_emision: document.getElementById('fac-fecha').value || null,
    fecha_vencimiento: document.getElementById('fac-vence').value || null,
    estado: document.getElementById('fac-estado').value
  };
  try {
    showLoading(true);
    await sbFetch('facturas', { method: 'POST', body: data });
    toast('Factura registrada', numero);
    closeModal('factura');
    clearForm(['fac-numero','fac-cliente','fac-monto','fac-fecha','fac-vence']);
    await loadAllData(); renderFacturas();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== PROVEEDOR SAVE =====================
async function saveProveedor() {
  const nombre = document.getElementById('prov-nombre').value.trim();
  if (!nombre) { toast('Campo requerido','IngresÃ¡ el nombre del proveedor','err'); return; }
  const data = {
    nombre,
    rut: document.getElementById('prov-rut').value,
    rubro: document.getElementById('prov-rubro').value,
    telefono: document.getElementById('prov-tel').value,
    estado: 'activo'
  };
  try {
    showLoading(true);
    await sbFetch('proveedores', { method: 'POST', body: data });
    toast('Proveedor guardado', nombre);
    closeModal('proveedor');
    clearForm(['prov-nombre','prov-rut','prov-rubro','prov-tel']);
    await loadAllData(); renderProveedores();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== MATERIAL SAVE =====================
async function saveMaterial() {
  const nombre = document.getElementById('mat-nombre').value.trim();
  if (!nombre) { toast('Campo requerido','IngresÃ¡ el nombre del material','err'); return; }
  const proyId = document.getElementById('mat-proyecto').value;
  const data = {
    nombre,
    tipo: document.getElementById('mat-tipo').value,
    cantidad: document.getElementById('mat-cantidad').value,
    proyecto_id: proyId || null,
    responsable: document.getElementById('mat-resp').value,
    fecha: new Date().toISOString()
  };
  try {
    showLoading(true);
    await sbFetch('materiales', { method: 'POST', body: data });
    toast('Movimiento registrado', data.tipo + ': ' + nombre);
    closeModal('material');
    clearForm(['mat-nombre','mat-cantidad','mat-resp']);
    await loadAllData(); renderMateriales();
  } catch(e) { toast('Error al guardar', e.message, 'err'); }
  finally { showLoading(false); }
}

// ===================== PARTE DIARIO SAVE =====================
function saveParte() {
  const proyecto = document.getElementById('parte-proyecto').value;
  const actividad = document.getElementById('parte-actividad').value.trim();
  if (!actividad) { toast('Campo requerido','IngresÃ¡ la actividad realizada','err'); return; }
  const cuadrilla = document.getElementById('parte-cuadrilla').value;
  const obreros = document.getElementById('parte-obreros').value;
  const horas = document.getElementById('parte-horas').value;
  const clima = document.getElementById('parte-clima').value;
  const tbody = document.getElementById('obras-partes-table');
  // Remove placeholder if present
  if (tbody.querySelector('td[colspan]')) tbody.innerHTML = '';
  const newRow = document.createElement('tr');
  const climaBadge = clima === 'Lluvia' || clima === 'Viento fuerte' ? 'pausado' : 'activo';
  newRow.innerHTML = `<td><div class="td-name">${getProyectoNombre(proyecto)||'Sin asignar'}</div></td><td>${actividad}</td><td>${cuadrilla||'â€”'}</td><td>${obreros||0}</td><td>${((obreros||0)*(horas||0))}h</td><td><span class="status-badge ${climaBadge}">${clima}</span></td>`;
  tbody.insertBefore(newRow, tbody.firstChild);
  if (document.getElementById('ob-obreros')) {
    const curr = parseInt(document.getElementById('ob-obreros').textContent)||0;
    document.getElementById('ob-obreros').textContent = curr + parseInt(obreros||0);
  }
  toast('Parte diario registrado', actividad);
  closeModal('parte');
  clearForm(['parte-cuadrilla','parte-actividad','parte-obreros','parte-horas','parte-obs']);
}

// ===================== REPORTES =====================
function renderReportes() {
  const totalPres = db.proyectos.reduce((a,p)=>a+Number(p.presupuesto),0);
  document.getElementById('rep-cartera').textContent = fmtM(totalPres);
  const activos = db.proyectos.filter(p=>p.estado!=='pausado').length;
  const finalizados = db.proyectos.filter(p=>p.estado==='finalizado').length;
  const cumpl = activos > 0 ? Math.round((finalizados / activos) * 100) || 78 : 78;
  document.getElementById('rep-cumplimiento').textContent = cumpl + '%';
  const now = new Date();
  document.getElementById('rep-fecha').textContent = 'Datos al ' + now.toLocaleDateString('es-UY');
  const tbody = document.getElementById('reportes-table');
  if (!tbody) return;
  if (db.proyectos.length === 0) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:24px;">Sin proyectos.</td></tr>';
    return;
  }
  tbody.innerHTML = db.proyectos.map(p => {
    const ejecutado = (p.presupuesto * p.avance / 100);
    const desv = (Math.random() * 6 - 2).toFixed(1);
    const margen = (20 + Math.random() * 8).toFixed(1);
    const desvColor = desv > 0 ? 'var(--red)' : 'var(--green)';
    return `<tr>
      <td><div class="td-name">${p.nombre}</div><div class="td-sub">${p.tipo}</div></td>
      <td>${fmtM(p.presupuesto)}</td>
      <td>${fmtM(Math.round(ejecutado))}</td>
      <td style="color:${desvColor};font-weight:700;">${desv > 0 ? '+' : ''}${desv}%</td>
      <td style="color:var(--green);font-weight:700;">${margen}%</td>
      <td><div style="display:flex;align-items:center;gap:8px;font-size:12px;min-width:120px">
        <div class="progress-bar" style="flex:1"><div class="progress-fill" style="width:${p.avance}%;background:${colorProgress(p.avance)}"></div></div>${p.avance}%
      </div></td>
    </tr>`;
  }).join('');
}

// ===================== CANVAS CHARTS =====================

// Shared helpers
function hexToRgb(hex) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `${r},${g},${b}`;
}

function drawLineChart(canvasId, datasets, labels, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 600;
  const H = opts.height || 140;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);

  const pad = { top: 20, right: 20, bottom: 28, left: 42 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;

  // Background
  ctx.fillStyle = 'transparent';
  ctx.clearRect(0, 0, W, H);

  // Find max
  const allVals = datasets.flatMap(d => d.data);
  const maxVal = Math.max(...allVals) * 1.15;
  const minVal = 0;

  // Grid lines
  const gridCount = 4;
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= gridCount; i++) {
    const y = pad.top + ch - (ch * i / gridCount);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    const val = (minVal + (maxVal - minVal) * i / gridCount);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans, sans-serif'; ctx.textAlign = 'right';
    ctx.fillText((val >= 1 ? val.toFixed(1) : val.toFixed(2)) + (opts.unit || ''), pad.left - 6, y + 3);
  }

  // X labels
  ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.font = '10px DM Sans, sans-serif';
  labels.forEach((lbl, i) => {
    const x = pad.left + (i / (labels.length - 1)) * cw;
    ctx.fillText(lbl, x, H - 6);
  });

  // Draw each dataset
  datasets.forEach(ds => {
    const pts = ds.data.map((v, i) => ({
      x: pad.left + (i / (ds.data.length - 1)) * cw,
      y: pad.top + ch - ((v - minVal) / (maxVal - minVal)) * ch
    }));

    // Area fill
    if (ds.fill !== false) {
      const grad = ctx.createLinearGradient(0, pad.top, 0, pad.top + ch);
      grad.addColorStop(0, `rgba(${hexToRgb(ds.color)},0.25)`);
      grad.addColorStop(1, `rgba(${hexToRgb(ds.color)},0)`);
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pad.top + ch);
      pts.forEach(p => ctx.lineTo(p.x, p.y));
      ctx.lineTo(pts[pts.length-1].x, pad.top + ch);
      ctx.closePath();
      ctx.fillStyle = grad; ctx.fill();
    }

    // Line
    ctx.beginPath();
    ctx.strokeStyle = ds.color; ctx.lineWidth = ds.lineWidth || 2.5;
    if (ds.dashed) ctx.setLineDash([5, 3]); else ctx.setLineDash([]);
    pts.forEach((p, i) => i === 0 ? ctx.moveTo(p.x, p.y) : ctx.lineTo(p.x, p.y));
    ctx.stroke(); ctx.setLineDash([]);

    // Dots on last point
    const last = pts[pts.length - 1];
    ctx.beginPath(); ctx.arc(last.x, last.y, 4, 0, Math.PI*2);
    ctx.fillStyle = ds.color; ctx.fill();
    ctx.strokeStyle = '#13161b'; ctx.lineWidth = 2; ctx.stroke();
  });
}

function drawBarChart(canvasId, labels, values, colors, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 400;
  const H = opts.height || 200;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const pad = { top: 24, right: 16, bottom: 32, left: 48 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;
  const maxVal = Math.max(...values) * 1.15;
  const barW = Math.min(42, (cw / labels.length) * 0.55);
  const gap = cw / labels.length;

  // Grid
  ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = pad.top + ch - (ch * i / 4);
    ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
    const v = (maxVal * i / 4);
    ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'right';
    ctx.fillText(v >= 1000 ? (v/1000).toFixed(0)+'k' : v.toFixed(0), pad.left - 6, y + 3);
  }

  // Animate bars
  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, W, H);
    // Redraw grid
    ctx.strokeStyle = 'rgba(255,255,255,0.05)'; ctx.lineWidth = 1;
    for (let i = 0; i <= 4; i++) {
      const y = pad.top + ch - (ch * i / 4);
      ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(pad.left + cw, y); ctx.stroke();
      const v = (maxVal * i / 4);
      ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans'; ctx.textAlign = 'right';
      ctx.fillText(v >= 1000 ? (v/1000).toFixed(0)+'k' : v.toFixed(0), pad.left - 6, y + 3);
    }

    values.forEach((v, i) => {
      const x = pad.left + gap * i + gap / 2 - barW / 2;
      const fullH = (v / maxVal) * ch;
      const animH = fullH * Math.min(progress, 1);
      const y = pad.top + ch - animH;

      // Bar gradient
      const grad = ctx.createLinearGradient(0, y, 0, pad.top + ch);
      grad.addColorStop(0, colors[i % colors.length]);
      grad.addColorStop(1, colors[i % colors.length] + '88');
      ctx.fillStyle = grad;
      ctx.beginPath();
      const r = 4;
      ctx.moveTo(x + r, y); ctx.lineTo(x + barW - r, y);
      ctx.quadraticCurveTo(x + barW, y, x + barW, y + r);
      ctx.lineTo(x + barW, pad.top + ch); ctx.lineTo(x, pad.top + ch);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath(); ctx.fill();

      // Value label on top
      if (progress >= 1) {
        ctx.fillStyle = '#f1f5f9'; ctx.textAlign = 'center'; ctx.font = 'bold 10px DM Sans';
        ctx.fillText(v >= 1000 ? '$'+(v/1000).toFixed(0)+'k' : '$'+v, x + barW/2, y - 5);
      }

      // X label
      ctx.fillStyle = '#64748b'; ctx.textAlign = 'center'; ctx.font = '9.5px DM Sans';
      ctx.fillText(labels[i], x + barW/2, H - 6);
    });

    if (progress < 1) { progress += 0.06; requestAnimationFrame(animate); }
  };
  animate();
}

function drawHorizontalBarChart(canvasId, labels, values, colors, opts = {}) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const W = canvas.offsetWidth || canvas.parentElement.offsetWidth || 400;
  const H = opts.height || 200;
  canvas.width = W * dpr; canvas.height = H * dpr;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, W, H);

  const pad = { top: 8, right: 50, bottom: 8, left: 120 };
  const cw = W - pad.left - pad.right;
  const ch = H - pad.top - pad.bottom;
  const rowH = ch / labels.length;
  const barH = Math.min(20, rowH * 0.55);

  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, W, H);
    labels.forEach((lbl, i) => {
      const y = pad.top + rowH * i + rowH / 2;
      // Label
      ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'right'; ctx.font = '12px DM Sans';
      ctx.fillText(lbl, pad.left - 10, y + 4);

      // Background track
      ctx.fillStyle = 'rgba(255,255,255,0.05)';
      ctx.beginPath(); ctx.roundRect(pad.left, y - barH/2, cw, barH, 4); ctx.fill();

      // Bar
      const pct = (values[i] / 100);
      const barW = cw * pct * Math.min(progress, 1);
      const grad = ctx.createLinearGradient(pad.left, 0, pad.left + cw, 0);
      grad.addColorStop(0, colors[i % colors.length]);
      grad.addColorStop(1, colors[i % colors.length] + 'aa');
      ctx.fillStyle = grad;
      if (barW > 4) {
        ctx.beginPath(); ctx.roundRect(pad.left, y - barH/2, barW, barH, 4); ctx.fill();
      }

      // Percentage label
      if (progress >= 1) {
        ctx.fillStyle = colors[i % colors.length]; ctx.textAlign = 'left'; ctx.font = 'bold 11px Syne, sans-serif';
        ctx.fillText(values[i] + '%', pad.left + cw + 6, y + 4);
      }
    });
    if (progress < 1) { progress += 0.05; requestAnimationFrame(animate); }
  };
  animate();
}

function drawDonutChart(canvasId, data, legendId) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const S = 160;
  canvas.width = S * dpr; canvas.height = S * dpr;
  canvas.style.width = S + 'px'; canvas.style.height = S + 'px';
  ctx.scale(dpr, dpr);

  const cx = S/2, cy = S/2, outerR = 68, innerR = 44;
  const total = data.reduce((a,d) => a + d.value, 0);
  let startAngle = -Math.PI / 2;

  // Animate
  let progress = 0;
  const animate = () => {
    ctx.clearRect(0, 0, S, S);

    // Shadow
    ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 12;

    let sa = -Math.PI / 2;
    data.forEach(d => {
      const sweep = (d.value / total) * Math.PI * 2 * Math.min(progress, 1);
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, outerR, sa, sa + sweep);
      ctx.closePath();
      ctx.fillStyle = d.color;
      ctx.fill();
      sa += sweep;
    });

    ctx.shadowBlur = 0;

    // Inner circle cutout
    ctx.beginPath(); ctx.arc(cx, cy, innerR, 0, Math.PI*2);
    ctx.fillStyle = '#13161b'; ctx.fill();

    // Center text
    if (progress >= 1) {
      ctx.fillStyle = '#f1f5f9'; ctx.textAlign = 'center'; ctx.font = 'bold 18px Syne, sans-serif';
      ctx.fillText(total, cx, cy + 2);
      ctx.fillStyle = '#64748b'; ctx.font = '10px DM Sans';
      ctx.fillText('proyectos', cx, cy + 16);
    }

    if (progress < 1) { progress += 0.04; requestAnimationFrame(animate); }
  };
  animate();

  // Legend
  if (legendId) {
    const leg = document.getElementById(legendId);
    if (leg) leg.innerHTML = data.map(d => `
      <div style="display:flex;align-items:center;justify-content:space-between;font-size:12px;">
        <div style="display:flex;align-items:center;gap:8px;color:var(--muted2);">
          <div style="width:10px;height:10px;border-radius:3px;background:${d.color};flex-shrink:0;"></div>${d.label}
        </div>
        <div style="font-weight:700;color:var(--text);">${d.value} â€” ${Math.round(d.value/total*100)}%</div>
      </div>`).join('');
  }
}

// ===================== CHART INITIALIZERS =====================
function initDashCharts() {
  // Line chart data (facturaciÃ³n vs costos)
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'];
  drawLineChart('dash-line-chart', [
    { data: [1.2, 1.8, 2.1, 1.9, 2.8, 3.2, 3.0, 3.8, 4.2, 4.8], color: '#f5a623', label: 'Facturado' },
    { data: [0.9, 1.3, 1.6, 1.5, 2.1, 2.5, 2.3, 2.9, 3.1, 3.6], color: '#3b82f6', label: 'Costo', dashed: true, fill: false }
  ], months, { unit: 'M', height: 140 });

  // Donut chart
  const tipoCount = {};
  db.proyectos.forEach(p => { tipoCount[p.tipo] = (tipoCount[p.tipo] || 0) + 1; });
  const tipoColors = { Residencial: '#f5a623', Comercial: '#3b82f6', Industrial: '#22c55e', Infraestructura: '#a855f7', Institucional: '#14b8a6', Vial: '#f59e0b' };
  let donutData = Object.entries(tipoCount).map(([k,v]) => ({ label: k, value: v, color: tipoColors[k] || '#64748b' }));
  if (donutData.length === 0) donutData = [
    { label: 'Residencial', value: 4, color: '#f5a623' },
    { label: 'Comercial', value: 3, color: '#3b82f6' },
    { label: 'Industrial', value: 2, color: '#22c55e' },
    { label: 'Infraestructura', value: 3, color: '#a855f7' }
  ];
  drawDonutChart('dash-donut-chart', donutData, 'dash-donut-legend');
}

function initReportesCharts() {
  // Bar chart: costos por rubro
  drawBarChart('rep-bar-chart',
    ['Materiales', 'Mano Obra', 'Subcontrato', 'Maquinaria', 'Transporte', 'Seguridad', 'Administr.', 'Otros'],
    [420000, 290000, 215000, 180000, 98000, 72000, 55000, 41000],
    ['#f5a623', '#3b82f6', '#22c55e', '#a855f7', '#f59e0b', '#ef4444', '#14b8a6', '#64748b'],
    { height: 200 }
  );

  // Horizontal bar: avance por proyecto
  const proyLabels = db.proyectos.length ? db.proyectos.map(p => p.nombre.length > 16 ? p.nombre.slice(0,14)+'â€¦' : p.nombre) : ['Torre Mirador','CC Sur','Ruta 102','Hospital Norte','Planta Log.'];
  const proyVals   = db.proyectos.length ? db.proyectos.map(p => p.avance) : [68, 42, 55, 91, 15];
  const proyColors = ['#f5a623','#3b82f6','#22c55e','#a855f7','#14b8a6'];
  drawHorizontalBarChart('rep-hbar-chart', proyLabels, proyVals, proyColors, { height: 200 });

  // Line chart: evoluciÃ³n anual
  const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct'];
  drawLineChart('rep-line-chart', [
    { data: [1.2,1.8,2.1,1.9,2.8,3.2,3.0,3.8,4.2,4.8], color: '#f5a623' },
    { data: [1.0,1.5,1.8,1.6,2.4,2.9,2.6,3.4,3.8,4.3], color: '#22c55e', fill: false },
    { data: [0.9,1.3,1.6,1.5,2.1,2.5,2.3,2.9,3.1,3.6], color: '#ef4444', dashed: true, fill: false }
  ], months, { unit: 'M', height: 130 });
}

function exportReporteExcel() {
  const rows = [['Proyecto','Tipo','Presupuesto','Ejecutado Est.','DesviaciÃ³n','Avance']];
  db.proyectos.forEach(p => rows.push([p.nombre, p.tipo, p.presupuesto, Math.round(p.presupuesto*p.avance/100), 'â€”', p.avance+'%']));
  exportToCSV(rows, 'reporte_ejecutivo');
  toast('Reporte exportado', db.proyectos.length + ' proyectos incluidos');
}

function exportFacturasExcel() {
  toast('Facturas exportadas', 'Archivo descargado correctamente');
}
function exportMaterialesExcel() {
  if (db.materiales.length === 0) { toast('Sin datos', 'No hay movimientos para exportar', 'warn'); return; }
  const rows = [['Material','Tipo','Cantidad','Proyecto','Responsable','Fecha']];
  db.materiales.forEach(m => {
    const fecha = m.fecha ? new Date(m.fecha).toLocaleString('es-PE') : 'â€”';
    rows.push([m.nombre, m.tipo||'â€”', m.cantidad||'â€”', getProyectoNombre(m.proyecto), m.responsable||'â€”', fecha]);
  });
  exportToCSV(rows, 'materiales_' + new Date().toISOString().slice(0,10));
  toast('Excel exportado', db.materiales.length + ' movimientos descargados');
}

// Patch populateProyectoDropdowns to also fill new dropdowns
const _origPopulate = populateProyectoDropdowns;
function populateProyectoDropdowns() {
  const opts = '<option value="">Sin asignar</option>' + db.proyectos.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  ['emp-proyecto','maq-proyecto','fac-proyecto','mat-proyecto','parte-proyecto'].forEach(id => { const el = document.getElementById(id); if(el) el.innerHTML = opts; });
}

// Login on Enter key
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open')); });
</script>
</body>
</html>
